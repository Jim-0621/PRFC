File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeLintSource.java
Patch:
@@ -17,7 +17,6 @@
 import com.google.gwt.core.client.JsArray;
 import com.google.gwt.user.client.Command;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.regex.Match;
 import org.rstudio.core.client.regex.Pattern;
 import org.rstudio.studio.client.common.filetypes.TextFileType;
@@ -27,7 +26,6 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.DocDisplay;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTarget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetSpelling;
-import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Position;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionContext;
 
 public class VisualModeLintSource implements LintSource

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPane.java
Patch:
@@ -318,6 +318,7 @@ public void showContextMenu(final int clientX, final int clientY)
    private ToolbarButton pushButton_;
    private ToolbarButton refreshButton_;
 
+   @SuppressWarnings("unused")
    private final GitServerOperations server_;
    private final Commands commands_;
    @SuppressWarnings("unused")

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceBackgroundHighlighter.java
Patch:
@@ -445,7 +445,7 @@ private static List<HighlightPattern> sweaveHighlightPatterns()
    {
       return ListUtil.create(
             new HighlightPattern(
-                  "<<(.*?)>>",
+                  "^\\s*<<.*>>=\\s*$",
                   "^\\s*@\\s*$")
       );
    }

File: src/gwt/src/org/rstudio/core/client/theme/ThemeFonts.java
Patch:
@@ -29,7 +29,7 @@ public class ThemeFonts
 
    public static String getProportionalFont()
    {
-      return fontLoader.getProportionalFont() + ", serif";
+      return fontLoader.getProportionalFont() + ", sans-serif";
    }
 
    public static String getFixedWidthFont()
@@ -85,7 +85,7 @@ static class WebThemeFontLoader implements ThemeFontLoader
       public String getProportionalFont()
       {
          String font = BrowseCap.hasUbuntuFonts() ? "Ubuntu, " : "";
-         return font + "\"Lucida Sans\", \"DejaVu Sans\", \"Lucida Grande\", \"Segoe UI\", Verdana, Helvetica, sans-serif";
+         return font + "\"Lucida Sans\", \"DejaVu Sans\", \"Noto Sans\", \"Lucida Grande\", \"Segoe UI\", Verdana, Helvetica, sans-serif";
       }
 
       public String getFixedWidthFont()
@@ -116,7 +116,7 @@ public String getFixedWidthFont()
          if (BrowseCap.isMacintosh())
             font += "Monaco, monospace";
          else if (BrowseCap.isLinux())
-            font += "\"Ubuntu Mono\", \"Droid Sans Mono\", \"DejaVu Sans Mono\", monospace";
+            font += "\"Ubuntu Mono\", \"Droid Sans Mono\", \"DejaVu Sans Mono\", \"Noto Sans Mono\", monospace";
          else
             font += "Consolas, \"Lucida Console\", monospace";
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -423,7 +423,10 @@ public void onCompleted()
             {
                fileTypeChanged = !StringUtil.equals(newFileType_.getTypeId(), fileType_.getTypeId());
             }
+            
             fileType_ = newFileType_;
+            if (fileTypeChanged)
+               copilotHelper_.onFileTypeChanged();
          }
 
          if (file_ != null)

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -771,4 +771,6 @@ public String toString()
    public final static String CHUNK_OPTIONS_APPLY = "chunk_opt_apply";
    public final static String CHUNK_OPTIONS_REVERT = "chunk_opt_revert";
    
+   // TextEntryModalDialog
+   public final static String TEXT_ENTRY = "text_entry";
 }

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -60,6 +60,7 @@ public TextEntryModalDialog(String title,
             textBox_ = new TextBox();
       }
       textBox_.setWidth("100%");
+      textBox_.getElement().setId(ElementIds.getElementId(ElementIds.TEXT_ENTRY));
       DomUtils.disableAutoBehavior(textBox_);
       captionLabel_ = new FormLabel(caption, textBox_);
 

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -31,6 +31,9 @@
 @BaseExpression("$wnd.desktop")
 public interface DesktopFrame extends JavaScriptPassthrough
 {
+   void writeStdout(String text);
+   void writeStderr(String text);
+   
    void browseUrl(String url);
    
    void getOpenFileName(String caption,

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryPage.java
Patch:
@@ -26,6 +26,7 @@
 import org.rstudio.core.client.js.JsUtil;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.DirectoryChooserTextBox;
+import org.rstudio.core.client.widget.FormCheckBox;
 import org.rstudio.core.client.widget.FormLabel;
 import org.rstudio.core.client.widget.MessageDialog;
 import org.rstudio.core.client.widget.OperationWithInput;

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerAuthWatcher.java
Patch:
@@ -19,7 +19,8 @@
 
 public class RemoteServerAuthWatcher
 {
-   public static interface CheckAuthStatus {
+   public static interface CheckAuthStatus 
+   {
       void checkAuthStatus();
    }
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerAuthWatcher.java
Patch:
@@ -19,7 +19,8 @@
 
 public class RemoteServerAuthWatcher
 {
-   public static interface CheckAuthStatus {
+   public static interface CheckAuthStatus 
+   {
       void checkAuthStatus();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3437,14 +3437,14 @@ private void fixupCodeBeforeSaving(Command ready)
 
          if (stripTrailingWhitespace)
          {
-            Pattern pattern = Pattern.create("[ \t]+$", "");
             String code = docDisplay_.getCode();
             String strippedCode = "";
             
             // If this is being performed as part of an autosave, avoid
             // mutating lines containing the cursor.
             if (isAutoSaving())
             {
+               Pattern pattern = Pattern.create("[ \t]+$", "");
                int startRow = docDisplay_.getSelectionStart().getRow();
                int endRow = docDisplay_.getSelectionEnd().getRow();
                
@@ -3461,6 +3461,7 @@ private void fixupCodeBeforeSaving(Command ready)
             }
             else
             {
+               Pattern pattern = Pattern.create("[ \t]+$", "gm");
                strippedCode = pattern.replaceAll(code, "");
             }
             

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -400,7 +400,7 @@ public String toString()
    public final static String JOB_LAUNCHER_PRO_OPTIONS = "job_launcher_pro_options";
    public final static String JOB_LAUNCHER_PRO_ENVIRONMENT = "job_launcher_pro_environment";
    public final static String SHARE_MANAGED_CREDENTIALS = "share_managed_credentials_checkbox";
-   public static String getShareManagedCredentialsk() { return getElementId(SHARE_MANAGED_CREDENTIALS); }
+   public static String getShareManagedCredentials() { return getElementId(SHARE_MANAGED_CREDENTIALS); }
 
    // OpenSharedProjectDialog (Pro)
    public final static String SHARED_PROJ_MINE = "shared_proj_mine";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/ChunkOptionsPopupPanel.java
Patch:
@@ -92,13 +92,14 @@ private void initialize(FileDialogs fileDialogs,
       rfsContext_ = rfsContext;
    }
    
-   public ChunkOptionsPopupPanel(boolean includeChunkNameUI)
+   public ChunkOptionsPopupPanel(boolean includeChunkNameUI, boolean isVisualEditor)
    {
       super(true);
       setVisible(false);
       
       RStudioGinjector.INSTANCE.injectMembers(this);
       
+      isVisualEditor_ = isVisualEditor;
       chunkOptions_ = new HashMap<>();
       originalChunkOptions_ = new HashMap<>();
       
@@ -655,6 +656,7 @@ else if (lhsGroup > rhsGroup)
    
    protected String originalLine_;
    protected String chunkPreamble_;
+   protected final boolean isVisualEditor_;
    
    protected HashMap<String, String> chunkOptions_;
    protected HashMap<String, String> originalChunkOptions_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/CustomEngineChunkOptionsPopupPanel.java
Patch:
@@ -16,9 +16,9 @@
 
 public class CustomEngineChunkOptionsPopupPanel extends DefaultChunkOptionsPopupPanel
 {
-   public CustomEngineChunkOptionsPopupPanel(String engine)
+   public CustomEngineChunkOptionsPopupPanel(String engine, boolean isVisualEditor)
    {
-      super(engine);
+      super(engine, isVisualEditor);
       
       showWarningsInOutputCb_.setVisible(false);
       showMessagesInOutputCb_.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -242,7 +242,7 @@ public void run()
                ApplicationAutomationHooks appHooks = pApplicationHooks_.get();
                appHooks.initialize();
             }
-
+            
             // load MathJax
             MathJaxLoader.ensureMathJaxLoaded();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -696,6 +696,7 @@ public final native RProjectCopilotOptions getCopilotProjectOptions() /*-{
    public final native boolean isAutomationAgent() /*-{
       return this.is_automation_agent;
    }-*/;
+   
 
    private static final ModelConstants constants_ = GWT.create(ModelConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -793,7 +793,7 @@ private Widget createCodeTransformMenuButton()
          DocPropMenuItem reformatOnSaveMenuItem = new DocPropMenuItem(
                constants_.reformatDocumentOnSave(),
                docUpdateSentinel_,
-               false,
+               userPrefs_.reformatOnSave().getValue(),
                TextEditingTarget.REFORMAT_ON_SAVE,
                DocUpdateSentinel.PROPERTY_TRUE);
          

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -195,6 +195,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.visualmode.VisualModeSpelling;
 import org.rstudio.studio.client.workbench.views.source.editors.text.yaml.YamlEditorToolsProviderQuarto;
 import org.rstudio.studio.client.workbench.views.source.model.CppCompletion;
+import org.rstudio.studio.client.workbench.views.source.model.DocUpdateSentinel;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalInfoDialog;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalList;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalPopupMenu;
@@ -354,6 +355,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(QuartoConnection quartoMessageBus);
    void injectMembers(YamlEditorToolsProviderQuarto yamlCompletionSourceQuarto);
    void injectMembers(TextEditingTargetCopilotHelper copilotHelper);
+   void injectMembers(DocUpdateSentinel sentinel);
 
 
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialog.java
Patch:
@@ -51,7 +51,7 @@ public PreferencesDialog(WorkbenchServerOperations server,
                             Session session,
                             PreferencesDialogResources res,
                             GeneralPreferencesPane general,
-                            EditingPreferencesPane source,
+                            CodePreferencesPane source,
                             ConsolePreferencesPane console,
                             RMarkdownPreferencesPane rmarkdown,
                             SweavePreferencesPane compilePdf,

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchScreen.java
Patch:
@@ -57,7 +57,7 @@
 import org.rstudio.studio.client.workbench.prefs.views.AppearancePreferencesPane;
 import org.rstudio.studio.client.workbench.prefs.views.SweavePreferencesPane;
 import org.rstudio.studio.client.workbench.prefs.views.ConsolePreferencesPane;
-import org.rstudio.studio.client.workbench.prefs.views.EditingPreferencesPane;
+import org.rstudio.studio.client.workbench.prefs.views.CodePreferencesPane;
 import org.rstudio.studio.client.workbench.prefs.views.PackagesPreferencesPane;
 import org.rstudio.studio.client.workbench.prefs.views.PublishingPreferencesPane;
 import org.rstudio.studio.client.workbench.prefs.views.PythonPreferencesPane;
@@ -409,7 +409,7 @@ void onShowOptions()
    @Handler
    void onShowCodeOptions()
    {
-      optionsLoader_.showOptions(EditingPreferencesPane.class, true);
+      optionsLoader_.showOptions(CodePreferencesPane.class, true);
    }
 
    @Handler

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -88,6 +88,8 @@
    public abstract AppCommand insertChunkR();
    public abstract AppCommand insertChunkBash();
    public abstract AppCommand insertChunkD3();
+   public abstract AppCommand insertChunkGraphViz();
+   public abstract AppCommand insertChunkMermaid();
    public abstract AppCommand insertChunkPython();
    public abstract AppCommand insertChunkRCPP();
    public abstract AppCommand insertChunkStan();

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -321,6 +321,7 @@ public enum TextBoxButtonId
       CA_BUNDLE("ca_bundle"),
       DEFAULT_WORKING_DIR("default_working_dir"),
       DEFAULT_OPEN_PROJECT_DIR("default_open_project_dir"),
+      PROJECT_USER_DATA_DIR("project_user_data_dir"),
       ZOTERO_DATA_DIRECTORY("zotero_data_directory"),
       EXISTING_PROJECT_DIR("existing_project_dir"),
       FIND_IN("find_in"),

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectServerOperations.java
Patch:
@@ -45,11 +45,13 @@ void forgetRSConnectDeployments(String sourceFile,
                                    String outputFile,
                                    ServerRequestCallback<Void> requestCallback);
    
-   void getDeploymentFiles (String target, 
+   void getDeploymentFiles(String target, 
                boolean asMultipleRmd,
                String quartoSrcFile,
                ServerRequestCallback<RSConnectDeploymentFiles> requestCallback);
    
+   void getDeploymentEnvVars(ServerRequestCallback<JsArrayString> resultCallback);
+   
    void publishContent(RSConnectPublishSource source, 
                String account, String server, String appName, String appTitle, String appId,
                RSConnectPublishSettings settings,

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishButton.java
Patch:
@@ -723,7 +723,8 @@ public void execute(String htmlFile)
                            new RSConnectPublishSettings(
                                  deployFiles, 
                                  new ArrayList<>(), 
-                                 new ArrayList<>(), 
+                                 new ArrayList<>(),
+                                 new ArrayList<>(),
                                  false, true);
                      events_.fireEvent(
                            new RSConnectDeployInitiatedEvent(source, settings,

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -114,7 +114,7 @@
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.snippets.ui.EditSnippetsDialog;
 import org.rstudio.studio.client.workbench.ui.ConsoleTabPanel;
-import org.rstudio.studio.client.workbench.ui.polyfill.FocusVisiblePolyfill;
+import org.rstudio.studio.client.workbench.ui.polyfill.FocusVisibleStyles;
 import org.rstudio.studio.client.workbench.views.connections.ui.ConnectionCodePanel;
 import org.rstudio.studio.client.workbench.views.connections.ui.ConnectionExplorer;
 import org.rstudio.studio.client.workbench.views.connections.ui.NewConnectionInstallOdbcHost;
@@ -400,7 +400,7 @@ public interface RStudioGinjector extends Ginjector
    SessionOpener getSessionOpener();
    VirtualConsoleFactory getVirtualConsoleFactory();
    JobItemFactory getJobItemFactory();
-   FocusVisiblePolyfill getFocusVisiblePolyfill();
+   FocusVisibleStyles getFocusVisibleStyles();
    AriaLiveService getAriaLiveService();
 
    // Pro-only below here

File: src/gwt/src/org/rstudio/studio/client/application/ui/GlobalToolbar.java
Patch:
@@ -17,7 +17,6 @@
 import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.widget.CanFocus;
@@ -261,7 +260,6 @@ public void setFocus()
       Scheduler.get().scheduleDeferred(() ->
       {
          newButton_.setFocus(true);
-         A11y.showFocusOutline(newButton_.getElement());
       });
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/satellite/Satellite.java
Patch:
@@ -69,8 +69,8 @@ public void initialize(String name,
       // load MathJax
       MathJaxLoader.ensureMathJaxLoaded();
 
-      // load focus-visible polyfill
-      RStudioGinjector.INSTANCE.getFocusVisiblePolyfill().load(null);
+      // load focus-visible css
+      RStudioGinjector.INSTANCE.getFocusVisibleStyles().load(null);
 
       // NOTE: Desktop doesn't seem to get onWindowClosing events in Qt 4.8
       // so we instead rely on an explicit callback from the desktop frame

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -206,7 +206,7 @@ public void onWorkbenchLoaded(WorkbenchLoadedEvent event)
       checkForInitMessages();
       checkForLicenseMessage();
 
-      RStudioGinjector.INSTANCE.getFocusVisiblePolyfill().load(null);
+      RStudioGinjector.INSTANCE.getFocusVisibleStyles().load(null);
 
       if (StringUtil.equals(session_.getSessionInfo().getVcsName(), VCSConstants.GIT_ID))
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchPane.java
Patch:
@@ -71,7 +71,6 @@ public void setFocus()
       {
          Element el = focusableElements.get(0);
          el.focus();
-         A11y.showFocusOutline(el);
       }
       else
          Debug.logWarning("Could not set focus, no focusable element on " + title_ + " pane");

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/polyfill/FocusVisibleResources.java
Patch:
@@ -22,9 +22,6 @@ public interface FocusVisibleResources extends ClientBundle
 {
    FocusVisibleResources INSTANCE = GWT.create(FocusVisibleResources.class);
 
-   @Source("js/focus-visible.min.js")
-   StaticDataResource focusVisibleJs();
-
    @Source("css/focus-visible.css")
    StaticDataResource focusVisibleCss();
 }

File: src/gwt/test/org/rstudio/studio/client/workbench/views/source/editors/text/assist/RChunkHeaderParserTests.java
Patch:
@@ -32,7 +32,7 @@ public void testRMarkdownChunkHeader()
       Map<String, String> pieces = RChunkHeaderParser.parse(header);
       assertTrue(pieces.containsKey("label"));
       assertTrue(pieces.containsKey("echo"));
-      assertTrue(pieces.get("label").contentEquals("label"));
+      assertTrue(pieces.get("label").contentEquals("\"label\""));
       assertTrue(pieces.get("echo").contentEquals("TRUE"));
    }
    

File: src/gwt/src/org/rstudio/studio/client/application/events/ApplicationEventHandlers.java
Patch:
@@ -35,6 +35,7 @@ public interface ApplicationEventHandlers extends LogoutRequestedEvent.Handler,
                                                   RestartStatusEvent.Handler,
                                                   FileUploadEvent.Handler,
                                                   AriaLiveStatusEvent.Handler,
-                                                  ClipboardActionEvent.Handler
+                                                  ClipboardActionEvent.Handler,
+                                                  RunAutomationEvent.Handler
 {
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -205,6 +205,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ClipboardAction = "clipboard_action";
    public static final String DeploymentRecordsUpdated = "deployment_records_updated";
    public static final String FormatDocumentCompleted = "format_document_completed";
+   public static final String RunAutomation = "run_automation";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -161,6 +161,9 @@ public interface FileIconResources extends ClientBundle
    @Source("iconCsharp_2x.png")
    ImageResource iconCsharp2x();
 
+   @Source("iconFortran_2x.png")
+   ImageResource iconFortran2x();
+   
    @Source("iconGitignore_2x.png")
    ImageResource iconGitignore2x();
 

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -88,6 +88,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_COFFEE = new EditorLanguage("ace/mode/coffee", false, true);
    public static final EditorLanguage LANG_CSHARP = new EditorLanguage("ace/mode/csharp", false, true);
    public static final EditorLanguage LANG_DOCKERFILE = new EditorLanguage("ace/mode/dockerfile", false, true);
+   public static final EditorLanguage LANG_FORTRAN = new EditorLanguage("ace/mode/fortran", false, true);
    public static final EditorLanguage LANG_GITIGNORE = new EditorLanguage("ace/mode/gitignore", false, false);
    public static final EditorLanguage LANG_GO = new EditorLanguage("ace/mode/golang", false, true);
    public static final EditorLanguage LANG_GROOVY = new EditorLanguage("ace/mode/groovy", false, true);

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -168,6 +168,7 @@ public static String idWithPrefix(String prefix, String id)
 
    public final static String EDIT_EDITING_PREFS = "edit_editing_prefs";
    public final static String EDIT_DISPLAY_PREFS = "edit_display_prefs";
+   public final static String EDIT_FORMATTING_PREFS = "edit_formatting_prefs";
    public final static String EDIT_SAVING_PREFS = "edit_saving_prefs";
    public final static String EDIT_COMPLETION_PREFS = "editing_completion_prefs";
    public final static String EDIT_DIAGNOSTICS_PREFS = "editing_diagnostics_prefs";
@@ -353,7 +354,8 @@ public enum TextBoxButtonId
       VCS_TERMINAL("vcs_terminal"),
       CHOOSE_IMAGE("choose_image"),
       PYTHON_PATH("python_path"),
-      PROJECT_SCRATCH_PATH("project_scratch_path");
+      PROJECT_SCRATCH_PATH("project_scratch_path"),
+      REFORMAT_ON_SAVE_COMMAND("reformat_on_save_command");
 
       TextBoxButtonId(String value)
       {

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarPopupMenuButton.java
Patch:
@@ -64,7 +64,9 @@ public void addMenuItem(final MenuItem item, final String value)
          @Override
          public void execute()
          {
-            setText(value);
+            if (value != null)
+               setText(value);
+            
             if (cmd != null)
                cmd.execute();
          }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -388,6 +388,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
             results.add(commands.commentUncomment());
             results.add(commands.reflowComment());
             results.add(commands.reformatCode());
+            results.add(commands.reformatDocument());
             results.add(commands.renameInScope());
             results.add(commands.profileCode());
             results.add(commands.profileCodeWithoutFocus());

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -204,6 +204,7 @@ class ClientEvent extends JavaScriptObject
    public static final String SuspendBlocked = "session_suspend_blocked";
    public static final String ClipboardAction = "clipboard_action";
    public static final String DeploymentRecordsUpdated = "deployment_records_updated";
+   public static final String FormatDocumentCompleted = "format_document_completed";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -29,6 +29,7 @@
 
    // Source
    public abstract AppCommand reformatCode();
+   public abstract AppCommand reformatDocument();
    public abstract AppCommand newSourceDoc();
    public abstract AppCommand newRNotebook();
    public abstract AppCommand newTextDoc();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ConsoleLanguageTracker.java
Patch:
@@ -61,7 +61,7 @@ public ConsoleLanguageTracker(Session session,
       depman_ = depman;
       server_ = server;
 
-      binder.bind(commands, this);
+      binder.bind(commands_, this);
       
       events_.addHandler(SessionInitEvent.TYPE, this);
       events_.addHandler(ConsolePromptEvent.TYPE, this);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -2397,6 +2397,7 @@ private void initDynamicCommands()
       dynamicCommands_.add(commands_.vcsBlameOnGitHub());
       dynamicCommands_.add(commands_.editRmdFormatOptions());
       dynamicCommands_.add(commands_.reformatCode());
+      dynamicCommands_.add(commands_.reformatDocument());
       dynamicCommands_.add(commands_.showDiagnosticsActiveDocument());
       dynamicCommands_.add(commands_.renameInScope());
       dynamicCommands_.add(commands_.insertRoxygenSkeleton());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -845,8 +845,9 @@ private void setCodeCommandsEnabled(boolean enabled)
          commands_.profileCode(),
          commands_.profileCodeWithoutFocus(),
          commands_.reflowComment(),
-         commands_.reformatCode(),
          commands_.reindent(),
+         commands_.reformatCode(),
+         commands_.reformatDocument(),
          commands_.renameInScope(),
          commands_.runSelectionAsBackgroundJob(),
          commands_.runSelectionAsWorkbenchJob(),

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -102,7 +102,8 @@ void exportPageRegionToFile(String targetPath,
                                int left, 
                                int top, 
                                int width, 
-                               int height);
+                               int height,
+                               CommandWithArg<Void> callback);
 
    void printText(String text);
    

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/CppFileType.java
Patch:
@@ -16,20 +16,20 @@
 
 import java.util.HashSet;
 
-import com.google.gwt.resources.client.ImageResource;
-
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.studio.client.common.reditor.EditorLanguage;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.spelling.TokenPredicate;
 
+import com.google.gwt.resources.client.ImageResource;
+
 public class CppFileType extends TextFileType
 {
    CppFileType(String id, String ext, ImageResource icon,
                boolean isCpp, boolean canSource)
    {
       super(id, "C/C++", EditorLanguage.LANG_CPP, ext, icon,
-            false, false, isCpp, false, false, false,
+            WordWrap.DEFAULT, false, isCpp, false, false, false,
             false, false, false, true, false, true, false);
 
       isCpp_ = isCpp;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/PreviewableFromRFileType.java
Patch:
@@ -33,7 +33,7 @@ public PreviewableFromRFileType(String id,
                                    boolean canShowScopeTree)
    {
       super(id, label, editorLanguage, defaultExtension, icon,
-            true, true, false, false, false, false, 
+            WordWrap.DEFAULT, true, false, false, false, false, 
             false, false, false, false, false, canShowScopeTree, true);
       
       previewFunction_ = previewFunction;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/PythonFileType.java
Patch:
@@ -14,14 +14,14 @@
  */
 package org.rstudio.studio.client.common.filetypes;
 
-import com.google.gwt.resources.client.ImageResource;
-
 import java.util.HashSet;
 
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.studio.client.common.reditor.EditorLanguage;
 import org.rstudio.studio.client.workbench.commands.Commands;
 
+import com.google.gwt.resources.client.ImageResource;
+
 public class PythonFileType extends TextFileType
 {
    PythonFileType(
@@ -36,7 +36,7 @@ public class PythonFileType extends TextFileType
             editorLanguage,
             defaultExtension,
             defaultIcon,
-            false, // word wrap
+            WordWrap.DEFAULT, // word wrap
             false, // source on save
             true,  // execute code
             true,  // execute all code

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ScriptFileType.java
Patch:
@@ -16,13 +16,13 @@
 
 import java.util.HashSet;
 
-import com.google.gwt.resources.client.ImageResource;
-
 import org.rstudio.core.client.BrowseCap;
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.studio.client.common.reditor.EditorLanguage;
 import org.rstudio.studio.client.workbench.commands.Commands;
 
+import com.google.gwt.resources.client.ImageResource;
+
 public class ScriptFileType extends TextFileType
 {
    public ScriptFileType(String id, 
@@ -35,7 +35,7 @@ public ScriptFileType(String id,
                          boolean windowsCompatible)
    {
       super(id, label, language, ext, icon,
-            false, false, canExecuteCode, false, false, false, 
+            WordWrap.DEFAULT, false, canExecuteCode, false, false, false, 
             false, false, false, false, false, false, false);
       interpreter_ = interpreter;
       windowsCompatible_ = windowsCompatible;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/WebContentFileType.java
Patch:
@@ -16,12 +16,12 @@
 
 import java.util.HashSet;
 
-import com.google.gwt.resources.client.ImageResource;
-
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.studio.client.common.reditor.EditorLanguage;
 import org.rstudio.studio.client.workbench.commands.Commands;
 
+import com.google.gwt.resources.client.ImageResource;
+
 public class WebContentFileType extends TextFileType
 {
    WebContentFileType(String id,
@@ -37,7 +37,7 @@ public class WebContentFileType extends TextFileType
             editorLanguage, 
             defaultExtension,
             icon,
-            true,    // word-wrap
+            WordWrap.DEFAULT,    // word-wrap
             canSourceOnSave, 
             isMarkdown, // allow code execution in markdown 
             false, 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1052,7 +1052,7 @@ public PrefValue<Boolean> verticallyAlignArgumentsIndent()
    }
 
    /**
-    * Whether to soft-wrap R source files, wrapping the text for display without inserting newline characters.
+    * Whether to soft-wrap source files, wrapping the text for display without inserting newline characters.
     */
    public PrefValue<Boolean> softWrapRFiles()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessorConstants.java
Patch:
@@ -596,11 +596,11 @@ public interface UserPrefsAccessorConstants extends Constants {
    String verticallyAlignArgumentsIndentDescription();
 
    /**
-    * Whether to soft-wrap R source files, wrapping the text for display without inserting newline characters.
+    * Whether to soft-wrap source files, wrapping the text for display without inserting newline characters.
     */
-   @DefaultStringValue("Soft-wrap R source files")
+   @DefaultStringValue("Soft-wrap source files")
    String softWrapRFilesTitle();
-   @DefaultStringValue("Whether to soft-wrap R source files, wrapping the text for display without inserting newline characters.")
+   @DefaultStringValue("Whether to soft-wrap source files, wrapping the text for display without inserting newline characters.")
    String softWrapRFilesDescription();
 
    /**

File: src/gwt/src/org/rstudio/core/client/files/filedialog/PathBreadcrumbWidget.java
Patch:
@@ -207,7 +207,7 @@ else if (isCloudRoot)
 
    private void browse()
    {
-      if (Desktop.isDesktop())
+      if (!Desktop.isUsingWebFileDialogs())
       {
          FileSystemContext tempContext =
                RStudioGinjector.INSTANCE.getRemoteFileSystemContext();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -419,11 +419,14 @@ void highlightDebugLocation(
    void setAnnotations(JsArray<AceAnnotation> annotations);
    void showLint(JsArray<LintItem> lint);
    void clearLint();
+   
+   JsMap<Marker> getMarkers(boolean inFront);
    void removeMarkersAtCursorPosition();
    void removeMarkersOnCursorLine();
    void removeMarkers(BiPredicate<AceAnnotation, Marker> predicate);
    void removeMarkersAtWord(String word);
 
+   
    void beginCollabSession(CollabEditStartParams params, DirtyState dirtyState);
    boolean hasActiveCollabSession();
    boolean hasFollowingCollabSession();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/EditSession.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text.ace;
 
+import org.rstudio.core.client.js.JsMap;
 import org.rstudio.studio.client.workbench.views.output.lint.model.AceAnnotation;
 
 import com.google.gwt.core.client.JavaScriptObject;
@@ -280,7 +281,7 @@ public native final JsArray<AceAnnotation> getAnnotations() /*-{
       return this.getAnnotations();
    }-*/;
    
-   public native final Markers getMarkers(boolean inFront) /*-{
+   public native final JsMap<Marker> getMarkers(boolean inFront) /*-{
       return this.getMarkers(inFront);
    }-*/;
    

File: src/gwt/src/org/rstudio/core/client/JsVectorBoolean.java
Patch:
@@ -65,7 +65,7 @@ public final void fill(boolean value)
       fill(value, 0, length());
    }
    
-   public final JsVectorBoolean filter(Predicate predicate)
+   public final JsVectorBoolean filter(Predicate<Boolean> predicate)
    {
       JsVectorBoolean result = JsVectorBoolean.createVector();
       

File: src/gwt/src/org/rstudio/core/client/JsVectorInteger.java
Patch:
@@ -65,7 +65,7 @@ public final void fill(int value)
       fill(value, 0, length());
    }
    
-   public final JsVectorInteger filter(Predicate predicate)
+   public final JsVectorInteger filter(Predicate<Integer> predicate)
    {
       JsVectorInteger result = JsVectorInteger.createVector();
       

File: src/gwt/src/org/rstudio/core/client/JsVectorNumber.java
Patch:
@@ -65,7 +65,7 @@ public final void fill(double value)
       fill(value, 0, length());
    }
    
-   public final JsVectorNumber filter(Predicate predicate)
+   public final JsVectorNumber filter(Predicate<Double> predicate)
    {
       JsVectorNumber result = JsVectorNumber.createVector();
       

File: src/gwt/src/org/rstudio/core/client/JsVectorString.java
Patch:
@@ -65,7 +65,7 @@ public final void fill(String value)
       fill(value, 0, length());
    }
    
-   public final JsVectorString filter(Predicate predicate)
+   public final JsVectorString filter(Predicate<String> predicate)
    {
       JsVectorString result = JsVectorString.createVector();
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -904,7 +904,7 @@ private boolean openBrowsePointUsingOpenTab(boolean debugging,
             {
                // Try a fuzzier search, but note that this is now an approximate position.
                int newlineIndex = currentBrowseSource_.indexOf('\n');
-               String firstLine = editorCode.substring(0, newlineIndex);
+               String firstLine = currentBrowseSource_.substring(0, newlineIndex);
                codeIndex = editorCode.indexOf(firstLine);
                if (codeIndex != -1)
                {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -282,6 +282,7 @@ public void onBrowserLineChanged(BrowserLineChangedEvent event)
          {
             if (isApproximateBrowsePosition_)
             {
+               openOrUpdateFileBrowsePoint(true, true);
                requeryContextTimer_.cancel();
                return;
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -2090,7 +2090,7 @@ public void execute(EditingTarget target)
                   position != null &&
                   (position.getLine() != -1 || position.getColumn() != -1);
 
-            if (navigateToPosition)
+            if (isDebugNavigation || navigateToPosition)
             {
                SourcePosition endPosition = null;
                if (isDebugNavigation)

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -203,6 +203,7 @@ class ClientEvent extends JavaScriptObject
    public static final String PresentationPreview = "presentation_preview";
    public static final String SuspendBlocked = "session_suspend_blocked";
    public static final String ClipboardAction = "clipboard_action";
+   public static final String DeploymentRecordsUpdated = "deployment_records_updated";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -3737,6 +3737,7 @@ private void clearDebugLineHighlight()
          getSession().removeMarker(lineDebugMarkerId_);
          lineDebugMarkerId_ = null;
       }
+      
       if (executionLine_ != null)
       {
          widget_.getEditor().getRenderer().removeGutterDecoration(

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -740,4 +740,7 @@ public String toString()
    public final static String COPILOT_DIAGNOSTICS_CLOSE_BUTTON = "copilot_diagnostics_close_button";
    public final static String COPILOT_DIAGNOSTICS_COPY_BUTTON = "copilot_diagnostics_copy_button";
    
+   // ProjectGeneralPreferencesPane
+   public final static String PROJ_DISPLAY_NAME= "proj_display_name";
+   
 }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectGeneralPreferencesPane.java
Patch:
@@ -27,6 +27,7 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.core.client.dom.DomUtils;
+import org.rstudio.core.client.ElementIds;
 
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.resources.client.ImageResource;
@@ -47,6 +48,7 @@ public ProjectGeneralPreferencesPane(Session session)
       
       String textboxWidth = "100%";
       projectName_ = new TextBox();
+      ElementIds.assignElementId(projectName_.getElement(), ElementIds.PROJ_DISPLAY_NAME);
       DomUtils.disableSpellcheck(projectName_);
       DomUtils.setPlaceholder(projectName_, sessionInfo_.getActiveProjectDir().getName());
       projectName_.setWidth(textboxWidth);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionPreInstallOdbcHost.java
Patch:
@@ -60,7 +60,7 @@ public NewConnectionPreInstallOdbcHost()
    {
       RStudioGinjector.INSTANCE.injectMembers(this);
 
-      dirChooser_ = new DirectoryChooserTextBox("", "", ElementIds.TextBoxButtonId.ODBC_PATH, null);
+      dirChooser_ = new DirectoryChooserTextBox(constants_.installationPath(), "", ElementIds.TextBoxButtonId.ODBC_PATH, null);
       mainWidget_ = GWT.<Binder>create(Binder.class).createAndBindUi(this);
  
       initWidget(createWidget());

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -740,4 +740,7 @@ public String toString()
    public final static String COPILOT_DIAGNOSTICS_CLOSE_BUTTON = "copilot_diagnostics_close_button";
    public final static String COPILOT_DIAGNOSTICS_COPY_BUTTON = "copilot_diagnostics_copy_button";
    
+   // ProjectGeneralPreferencesPane
+   public final static String PROJ_DISPLAY_NAME= "proj_display_name";
+   
 }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectGeneralPreferencesPane.java
Patch:
@@ -27,6 +27,7 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.core.client.dom.DomUtils;
+import org.rstudio.core.client.ElementIds;
 
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.resources.client.ImageResource;
@@ -47,6 +48,7 @@ public ProjectGeneralPreferencesPane(Session session)
       
       String textboxWidth = "100%";
       projectName_ = new TextBox();
+      ElementIds.assignElementId(projectName_.getElement(), ElementIds.PROJ_DISPLAY_NAME);
       DomUtils.disableSpellcheck(projectName_);
       DomUtils.setPlaceholder(projectName_, sessionInfo_.getActiveProjectDir().getName());
       projectName_.setWidth(textboxWidth);

File: src/gwt/src/org/rstudio/core/client/MessageDisplay.java
Patch:
@@ -355,7 +355,7 @@ public void showErrorMessage(String message)
 
    public void showErrorMessage(String caption, String message)
    {
-      if (message.isEmpty())
+      if (!message.isEmpty())
       {
          DialogBuilder builder = createDialog(MSG_ERROR, caption, message);
          builder.showModal();

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -606,7 +606,8 @@ else if (type == ClientEvent.UserStateChanged)
             PrefLayer data = event.getData();
             eventBus_.dispatchEvent(new UserStateChangedEvent(data));
          }
-         else if (type == ClientEvent.ContextDepthChanged) {
+         else if (type == ClientEvent.ContextDepthChanged)
+         {
             EnvironmentContextData data = event.getData();
             eventBus_.dispatchEvent(new ContextDepthChangedEvent(data, true));
          }
@@ -761,7 +762,7 @@ else if (type == ClientEvent.ViewFunction)
          {
             SearchPathFunctionDefinition data = event.getData();
             eventBus_.dispatchEvent(new CodeBrowserNavigationEvent(
-                  data, null, false, true));
+                  data, null, false, true, false));
          }
          else if (type == ClientEvent.MarkersChanged)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -734,6 +734,7 @@
    
    // Copilot
    public abstract AppCommand copilotInstallAgent();
+   public abstract AppCommand copilotDiagnostics();
    public abstract AppCommand copilotSignIn();
    public abstract AppCommand copilotSignOut();
    public abstract AppCommand copilotStatus();

File: src/gwt/src/org/rstudio/studio/client/workbench/copilot/server/CopilotServerOperations.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.workbench.copilot.server;
 
 import org.rstudio.studio.client.server.ServerRequestCallback;
+import org.rstudio.studio.client.workbench.copilot.model.CopilotResponseTypes.CopilotDiagnosticsResponse;
 import org.rstudio.studio.client.workbench.copilot.model.CopilotResponseTypes.CopilotGenerateCompletionsResponse;
 import org.rstudio.studio.client.workbench.copilot.model.CopilotResponseTypes.CopilotInstallAgentResponse;
 import org.rstudio.studio.client.workbench.copilot.model.CopilotResponseTypes.CopilotSignInResponse;
@@ -24,6 +25,8 @@
 
 public interface CopilotServerOperations
 {
+   public void copilotDiagnostics(ServerRequestCallback<CopilotDiagnosticsResponse> requestCallback);
+   
    public void copilotVerifyInstalled(ServerRequestCallback<CopilotVerifyInstalledResponse> requestCallback);
    
    public void copilotInstallAgent(ServerRequestCallback<CopilotInstallAgentResponse> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobLauncherDialog.java
Patch:
@@ -36,9 +36,10 @@ public enum JobSource
    public JobLauncherDialog(String caption,
                             JobSource source,
                             FileSystemItem scriptPath,
+                            FileSystemItem workingDir,
                             OperationWithInput<JobLaunchSpec> operation)
    {
-      this(caption, source, scriptPath, scriptPath.getParentPath(), null, operation);
+      this(caption, source, scriptPath, workingDir, null, operation);
    }
    
    public JobLauncherDialog(String caption,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobLauncherDialog.java
Patch:
@@ -36,9 +36,10 @@ public enum JobSource
    public JobLauncherDialog(String caption,
                             JobSource source,
                             FileSystemItem scriptPath,
+                            FileSystemItem workingDir,
                             OperationWithInput<JobLaunchSpec> operation)
    {
-      this(caption, source, scriptPath, scriptPath.getParentPath(), null, operation);
+      this(caption, source, scriptPath, workingDir, null, operation);
    }
    
    public JobLauncherDialog(String caption,

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/MirrorsServerOperations.java
Patch:
@@ -25,8 +25,8 @@ void getCRANMirrors(
          ServerRequestCallback<JsArray<CRANMirror>> requestCallback);
 
    void validateCranRepo(
-         ServerRequestCallback<Boolean> requestCallback,
-         String cranRepoUrl);
+         String cranRepoUrl,
+         ServerRequestCallback<RepoValidationResult> requestCallback);
 
    void getCRANActives(
          ServerRequestCallback<JsArray<CRANMirror>> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -61,7 +61,7 @@ private AboutDialogContents()
       uiBinder.createAndBindUi(this);
    }
 
-   public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo)
+   public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo, String quartoDetails)
    {
       initWidget(uiBinder.createAndBindUi(this));
       versionMajorLabel.setText(info.version_major + "." + info.version_minor + "." + info.version_patch);
@@ -72,8 +72,7 @@ public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo)
       gplLinkLabel.getElement().setId("gplLinkLabel");
       Roles.getLinkRole().setAriaDescribedbyProperty(gplLink.getElement(), Id.of(gplLinkLabel.getElement()));
 
-      userAgentLabel.setText(
-            Window.Navigator.getUserAgent());
+      userAgentLabel.setText(Window.Navigator.getUserAgent() + quartoDetails);
       buildLabel.setText(
            "\"" + info.release_name + "\" " + info.build_type + " (" + StringUtil.substring(info.commit, 0, 8) + ", " +
            info.date + constants_.buildLabelForText() + info.os);

File: src/gwt/src/org/rstudio/studio/client/common/codetools/RCompletionType.java
Patch:
@@ -71,7 +71,8 @@ public static boolean isFileType(int type)
    public static int score(int type, int context) 
    {
       // same logic as .rs.sortCompletions() on the server side
-      switch(type){
+      switch (type)
+      {
          case ARGUMENT: return 1;
          case COLUMN: return 2;
          case DATATABLE_SPECIAL_SYMBOL: return 3;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequesterResources.java
Patch:
@@ -29,6 +29,7 @@ public static interface Styles extends CssResource
       String dataframe();
       String column();
       String argument();
+      String meta();
    }
    
    @Source("CompletionRequester.css")

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearch.java
Patch:
@@ -16,13 +16,13 @@
 
 import java.util.ArrayList;
 
+import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.XRef;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.widget.SearchDisplay;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
-import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.studio.client.workbench.views.files.events.FileChangeEvent;
 import org.rstudio.studio.client.workbench.views.source.events.XRefNavigationEvent;
 
@@ -78,7 +78,6 @@ public CodeSearch(Display display,
 
       final SearchDisplay searchDisplay = display_.getSearchDisplay();
       searchDisplay.setAutoSelectEnabled(true);
-
       searchDisplay.addSelectionHandler(new SelectionHandler<Suggestion>() {
 
          @Override

File: src/gwt/src/org/rstudio/studio/client/common/dialog/WebDialogBuilderFactory.java
Patch:
@@ -67,8 +67,6 @@ private MessageDialog createDialog()
 
          if (anchor_ != null)
             messageDialog.addLink(anchor_.label, anchor_.url);
-         else
-            messageDialog.removeAnchorRegion();
 
          if (options_ != null)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -741,6 +741,9 @@
    public abstract AppCommand copilotAcceptNextWord();
    public abstract AppCommand copilotToggleAutomaticCompletions();
 
+   // Databricks
+   public abstract AppCommand layoutZoomDatabricks();
+
    // Internal
    public abstract AppCommand showDomElements();
    public abstract AppCommand showShortcutCommand();

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -741,6 +741,9 @@
    public abstract AppCommand copilotAcceptNextWord();
    public abstract AppCommand copilotToggleAutomaticCompletions();
 
+   // Databricks
+   public abstract AppCommand layoutZoomDatabricks();
+
    // Internal
    public abstract AppCommand showDomElements();
    public abstract AppCommand showShortcutCommand();

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -1174,14 +1174,16 @@ else if (!sessionInfo.getShowIdentity() || !sessionInfo.getAllowFullUI())
       if (pEdition_.get() != null)
       {
          if (!pEdition_.get().proLicense())
+         {
             commands_.rstudioSupport().remove();
+            commands_.activateDatabricks().remove();
+         }
 
          // pro-only menu items
          if (!pEdition_.get().proLicense() || !Desktop.hasDesktopFrame())
          {
             commands_.showLicenseDialog().remove();
             commands_.showSessionServerOptionsDialog().remove();
-            commands_.activateDatabricks().remove();
          }
          else if (BrowseCap.isElectron())
          {

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -1181,6 +1181,7 @@ else if (!sessionInfo.getShowIdentity() || !sessionInfo.getAllowFullUI())
          {
             commands_.showLicenseDialog().remove();
             commands_.showSessionServerOptionsDialog().remove();
+            commands_.activateDatabricks().remove();
          }
          else if (BrowseCap.isElectron())
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -376,6 +376,7 @@
    public abstract AppCommand activateDeployContent();
    public abstract AppCommand activateMarkers();
    public abstract AppCommand activateSQLResults();
+   public abstract AppCommand activateDatabricks();
 
    // History
    public abstract AppCommand historySendToSource();

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/CmdConstants.java
Patch:
@@ -1373,7 +1373,7 @@ public interface CmdConstants extends Constants {
     // copilotAcceptNextWord
     @DefaultStringValue("Copilot: Accept Next Word") // $NON-NLS-1$
     String copilotAcceptNextWordLabel();
-    @DefaultStringValue("Request Completions") // $NON-NLS-1$
+    @DefaultStringValue("Accept Next Word") // $NON-NLS-1$
     String copilotAcceptNextWordMenuLabel();
     @DefaultStringValue("Accept the next word of the current Copilot suggestion, if any.") // $NON-NLS-1$
     String copilotAcceptNextWordDesc();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/CompletionContext.java
Patch:
@@ -15,6 +15,8 @@
 
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
+import com.google.gwt.user.client.Command;
+
 public interface CompletionContext
 {
    String getId();
@@ -23,5 +25,5 @@ public interface CompletionContext
    String[] getQuartoFormats();
    String[] getQuartoProjectFormats();
    String getQuartoEngine();
-   
+   void withSavedDocument(Command command);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DocUpdateSentinel.java
Patch:
@@ -245,7 +245,7 @@ public void withSavedDocNoRetry(final Command onSaved)
 
    private void withSavedDocImpl(final boolean retryWrite,
                                  final Command onSaved,
-         final CommandWithArg<String> onError)
+                                 final CommandWithArg<String> onError)
    {
       if (changeTracker_.hasChanged())
       {

File: src/gwt/src/org/rstudio/core/client/CoreClientConstants.java
Patch:
@@ -1213,7 +1213,7 @@ public interface CoreClientConstants extends com.google.gwt.i18n.client.Messages
      *
      * @return translated "Unable to establish connection with {0} when executing ''{1}''"
      */
-    @DefaultMessage("Unable to establish connection with the session on {0}. Please click the link to try logging in again in a new tab, then return to resume your session.")
+    @DefaultMessage("Unable to establish connection with the session on {0}. Please try logging in again in a new tab, then return to resume your session.")
     @Key("rpcOverrideErrorMessageServer")
     String rpcOverrideErrorMessageServer(String platform);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/diff/DiffChunk.java
Patch:
@@ -23,9 +23,9 @@ public DiffChunk(Range[] ranges,
                     ArrayList<Line> diffLines,
                     int diffIndex)
    {
-      this.ranges_ = ranges;
-      this.lineText_ = lineText;
-      this.diffLines_ = diffLines;
+      ranges_ = ranges;
+      lineText_ = lineText;
+      diffLines_ = diffLines;
       diffIndex_ = diffIndex;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindow.java
Patch:
@@ -91,7 +91,8 @@ public SourceWindow(
 
       // set up desktop hooks (required to e.g. process commands issued by
       // the desktop frame)
-      pDesktopHooks.get();
+      if (Desktop.isDesktop())
+         pDesktopHooks.get();
 
       // export callbacks for main window
       exportFromSatellite();

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcError.java
Patch:
@@ -27,7 +27,7 @@ public static final native RpcError create(int code, String message) /*-{
       error.message = message;
       return error;
    }-*/;
-   
+
    protected RpcError()
    {
    }
@@ -69,6 +69,7 @@ protected RpcError()
      
    // transmission error (application state indeterminate)
    public final static int TRANSMISSION_ERROR = 200;
+   public final static int TRANSMISSION_ERROR_NO_RESPONSE = 201;
 
    // Unimplemented redirection request
    public final static int REDIRECTION_ERROR = 300;

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -111,6 +111,7 @@ public interface ThemeStyles extends CssResource
    String searchBox();
    String clearSearch();
 
+   String dialogAnchorPanel();
    String dialogBottomPanel();
 
    String dialogMessage();

File: src/gwt/src/org/rstudio/core/client/widget/DialogBuilder.java
Patch:
@@ -19,6 +19,7 @@ public interface DialogBuilder
    DialogBuilder addButton(String label, String elementId);
    DialogBuilder addButton(String label, String elementId, Operation operation);
    DialogBuilder addButton(String label, String elementId, ProgressOperation operation);
+   DialogBuilder addLink(String label, String url);
 
    DialogBuilder setDefaultButton(int index);
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerError.java
Patch:
@@ -117,6 +117,7 @@ private int codeFromRpcErrorCode(int code)
          return ServerError.EXECUTION;
          
       case RpcError.TRANSMISSION_ERROR:
+      case RpcError.TRANSMISSION_ERROR_NO_RESPONSE:
          return ServerError.TRANSMISSION;
          
       case RpcError.MAX_SESSIONS_REACHED:

File: src/gwt/src/org/rstudio/core/client/CoreClientConstants.java
Patch:
@@ -1213,7 +1213,7 @@ public interface CoreClientConstants extends com.google.gwt.i18n.client.Messages
      *
      * @return translated "Log in"
      */
-    @DefaultMessage("Unable to establish connection with the session on {0}. Please try to log in again.")
+    @DefaultMessage("Log in")
     @Key("rpcOverrideErrorMessageLink")
     String rpcOverrideErrorMessageLink();
 

File: src/gwt/test/org/rstudio/studio/client/workbench/views/terminal/TerminalLocalEchoTests.java
Patch:
@@ -328,12 +328,12 @@ public void testEchoPause()
       OutputCatcher output = new OutputCatcher();
       TerminalLocalEcho echo = new TerminalLocalEcho(output);
       
-      String password = "MySecretPassword!";
+      String input = "Typed text I don't want echoed";
       
       Assert.assertFalse(echo.paused());
       echo.pause(50);
       
-      echoString(echo, password);
+      echoString(echo, input);
       Assert.assertTrue(echo.paused());
       Assert.assertTrue(echo.isEmpty());
       Assert.assertTrue(output.isEmpty());

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchLists.java
Patch:
@@ -34,7 +34,7 @@ public final ArrayList<String> getList(String name)
    
   
    private native final JsArrayString getListNative(String name) /*-{
-      return this[name] || [];
+      return this[name];
    }-*/;
    
    private ArrayList<String> convertList(JsArrayString jsList)

File: src/gwt/src/org/rstudio/studio/client/projects/ProjectMRUList.java
Patch:
@@ -72,7 +72,7 @@ public ProjectMRUList(Commands commands,
                @Override
                public void execute(String file)
                {
-                  openProjectFromMru(eventBus, file);
+                  openProjectFromMru(eventBus, new ProjectMRUEntry(file).getProjectFilePath());
                }
             });
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/ViewsSourceConstants.java
Patch:
@@ -1242,11 +1242,11 @@ public interface ViewsSourceConstants extends com.google.gwt.i18n.client.Message
     String openLinkMacCommand();
 
     /**
-     * Translated "Open Link (Shift+Click)".
+     * Translated "Open Link (Ctrl+Click)".
      *
-     * @return translated "Open Link (Shift+Click)"
+     * @return translated "Open Link (Ctrl+Click)"
      */
-    @DefaultMessage("Open Link (Shift+Click)")
+    @DefaultMessage("Open Link (Ctrl+Click)")
     @Key("openLinkNotMacCommand")
     String openLinkNotMacCommand();
 

File: src/gwt/src/org/rstudio/core/client/AnsiCode.java
Patch:
@@ -306,7 +306,7 @@ public AnsiClazzes processCode(String code)
       boolean extendedRGBMarkerSeen = false;
       int extendedRGBColorsSeen = 0;
 
-      String[] tokens = code.substring(2, code.length() - 1).split(";");
+      String[] tokens = StringUtil.substring(code, 2, code.length() - 1).split(";");
       for (String token : tokens)
       {
          int codeVal = StringUtil.parseInt(token,  -1);

File: src/gwt/src/org/rstudio/core/client/ColorUtil.java
Patch:
@@ -150,11 +150,11 @@ public static RGBColor fromCss(String cssString)
          // content that could be lying around.
          int rgbIdx = cssString.indexOf("rgb");
          if (rgbIdx != -1)
-            return fromRgbCssString(cssString.substring(rgbIdx).trim());
+            return fromRgbCssString(StringUtil.substring(cssString, rgbIdx).trim());
 
          int hashIdx = cssString.indexOf('#');
          if (hashIdx != -1)
-            return fromHex(cssString.substring(hashIdx).trim());
+            return fromHex(StringUtil.substring(cssString, hashIdx).trim());
 
          Debug.logToConsole("Failed to parse CSS '" + cssString + "'");
          return new RGBColor();

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -79,7 +79,7 @@ public static boolean isInstanceOf(Element ele, String baseId)
       // does ID match disambiguation pattern?
       if (RE_NUMBERED_ELEMENT_ID.test(actualId))
       {
-         String trimmedId = actualId.substring(0, actualId.lastIndexOf('_'));
+         String trimmedId = StringUtil.substring(actualId, 0, actualId.lastIndexOf('_'));
          return trimmedId == testId;
       }
       return false;

File: src/gwt/src/org/rstudio/core/client/URIUtils.java
Patch:
@@ -29,8 +29,8 @@ public static String addQueryParam(String url, String name, String value)
       int anchorPos = base.indexOf('#');
       if (anchorPos != -1)
       {
-         anchor = base.substring(anchorPos);
-         base = base.substring(0, anchorPos);
+         anchor = StringUtil.substring(base, anchorPos);
+         base = StringUtil.substring(base, 0, anchorPos);
       }
       
       // add the query param

File: src/gwt/src/org/rstudio/core/client/WordWrap.java
Patch:
@@ -132,15 +132,15 @@ private void processLine(String line)
          String thisChunk = "";
          if (index > 0)
          {
-            thisChunk = line.substring(0, index);
+            thisChunk = StringUtil.substring(line, 0, index);
             appendRawWithIndent(thisChunk);
          }
          wrap();
          onChunkWritten(thisChunk, insertionRow, insertionPoint, origStringPos);
 
          int nextLineIndex = Math.min(line.length(), index + breakChars);
          origStringPos += nextLineIndex;
-         line = line.substring(nextLineIndex);
+         line = StringUtil.substring(line, nextLineIndex);
          trimmed = StringUtil.trimLeft(line);
          origStringPos += line.length() - trimmed.length();
          line = trimmed;

File: src/gwt/src/org/rstudio/core/client/dom/DomUtils.java
Patch:
@@ -860,7 +860,7 @@ public static void setInnerText(Element el, String plainText)
       {
          if (tail != match.getIndex())
          {
-            String line = plainText.substring(tail, match.getIndex());
+            String line = StringUtil.substring(plainText, tail, match.getIndex());
             el.appendChild(doc.createTextNode(line));
          }
          el.appendChild(doc.createBRElement());
@@ -869,7 +869,7 @@ public static void setInnerText(Element el, String plainText)
       }
 
       if (tail < plainText.length())
-         el.appendChild(doc.createTextNode(plainText.substring(tail)));
+         el.appendChild(doc.createTextNode(StringUtil.substring(plainText, tail)));
    }
 
    public static boolean isSelectionAsynchronous()

File: src/gwt/src/org/rstudio/core/client/files/PosixFileSystemContext.java
Patch:
@@ -16,6 +16,7 @@
 
 import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.CoreClientConstants;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.regex.Match;
 import org.rstudio.core.client.regex.Pattern;
 
@@ -63,7 +64,7 @@ public FileSystemItem[] parseDir(String dirPath)
       while (m != null)
       {
          results.add(FileSystemItem.createDir(
-               dirPath.substring(0, m.getIndex() + m.getValue().length())));
+               StringUtil.substring(dirPath, 0, m.getIndex() + m.getValue().length())));
 
          m = m.nextMatch();
       }

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileDialog.java
Patch:
@@ -94,10 +94,10 @@ protected boolean shouldAccept()
       int lastIndex = filename.lastIndexOf('/');
       if (lastIndex >= 0)
       {
-         String dir = filename.substring(0, lastIndex);
+         String dir = StringUtil.substring(filename, 0, lastIndex);
          if (dir.length() == 0)
             dir = "/";
-         String file = filename.substring(lastIndex + 1);
+         String file = StringUtil.substring(filename, lastIndex + 1);
 
          // Targeted fix for "611: Permission denied error when attempting to
          // browse /shared folder in open file dialog". The /shared folder

File: src/gwt/src/org/rstudio/core/client/hyperlink/FileHyperlink.java
Patch:
@@ -48,7 +48,7 @@ public FileHyperlink(String url, Map<String, String> params, String text, String
 
             String second = match.getGroup(2);
             if (second != null)
-                col = StringUtil.parseInt(match.getGroup(2).substring(1), -1);
+                col = StringUtil.parseInt(StringUtil.substring(match.getGroup(2), 1), -1);
         }
         else 
         {

File: src/gwt/src/org/rstudio/core/client/widget/AnchorableFrame.java
Patch:
@@ -15,6 +15,8 @@
 
 package org.rstudio.core.client.widget;
 
+import org.rstudio.core.client.StringUtil;
+
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.RepeatingCommand;
 
@@ -99,7 +101,7 @@ private String stripAnchor(String url)
    {
       int hashPos = url.lastIndexOf('#');
       if (hashPos != -1)
-         return url.substring(0, hashPos);
+         return StringUtil.substring(url, 0, hashPos);
       else
          return url;
    }

File: src/gwt/src/org/rstudio/core/client/widget/MultipleItemSuggestTextBox.java
Patch:
@@ -97,7 +97,7 @@ public void setText(String text)
          String previous = "";
          if (lastSepIndex != -1)
          {
-            previous = fullText.substring(0, lastSepIndex);
+            previous = StringUtil.substring(fullText, 0, lastSepIndex);
             if (!previous.endsWith(" "))
                previous = previous + " ";
          }

File: src/gwt/src/org/rstudio/core/client/widget/TextBoxWithButton.java
Patch:
@@ -219,7 +219,7 @@ public String getText()
       
       if (text.startsWith(USE_DEFAULT_PREFIX))
       {
-         text = text.substring(USE_DEFAULT_PREFIX.length()).trim();
+         text = StringUtil.substring(text, USE_DEFAULT_PREFIX.length()).trim();
       }
       
       return text;

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -857,7 +857,7 @@ public void onInvalidSession(InvalidSessionEvent event)
       String scopePath = info.getScopePath();
       int loc = baseURL.indexOf(scopePath);
       if (loc != -1)
-         baseURL = baseURL.substring(0, loc) + "/";
+         baseURL = StringUtil.substring(baseURL, 0, loc) + "/";
 
       if (info.getScopeState() == InvalidSessionInfo.ScopeMissingProject)
       {

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -169,6 +169,8 @@ void promptForText(String title,
    void setEnableAccessibility(boolean enable);
    void setDisableRendererAccessibility(boolean disable);
 
+   void setAutohideMenubar(boolean enable);
+
    void getClipboardMonitoring(CommandWithArg<Boolean> callback);
    void setClipboardMonitoring(boolean monitoring);
    

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -19,6 +19,7 @@
 import com.google.gwt.dom.client.Element;
 import com.google.gwt.user.client.ui.Anchor;
 import org.rstudio.core.client.Debug;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.widget.HyperlinkLabel;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.StudioClientApplicationConstants;
@@ -74,7 +75,7 @@ public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo)
       userAgentLabel.setText(
             Window.Navigator.getUserAgent());
       buildLabel.setText(
-           "\"" + info.release_name + "\" " + info.build_type + " (" + info.commit.substring(0, 8) + ", " +
+           "\"" + info.release_name + "\" " + info.build_type + " (" + StringUtil.substring(info.commit, 0, 8) + ", " +
            info.date + constants_.buildLabelForText() + info.os);
       productName.setText(editionInfo.editionName());
       copyrightYearLabel.setText("2009-" + info.copyright_year);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -18,6 +18,7 @@
 
 import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.FilePosition;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -689,7 +690,7 @@ private void register(String filespec, FileType fileType, ImageResource icon)
    {
       if (filespec.startsWith("*."))
       {
-         String ext = filespec.substring(1).toLowerCase();
+         String ext = StringUtil.substring(filespec, 1).toLowerCase();
          if (ext.equals("."))
          {
             ext = "";

File: src/gwt/src/org/rstudio/studio/client/common/impl/DesktopWindowOpener.java
Patch:
@@ -44,7 +44,7 @@ public void openWindow(GlobalDisplay globalDisplay,
          if (!hasProtocol(url))
          {
             if (url.startsWith("/"))
-               url = url.substring(1);
+               url = StringUtil.substring(url, 1);
             url = GWT.getHostPageBaseURL() + url;
          }
          

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -14,6 +14,8 @@
  */
 package org.rstudio.studio.client.common.reditor;
 
+import org.rstudio.core.client.StringUtil;
+
 /**
  * Models a language for CodeMirror.
  *
@@ -138,7 +140,7 @@ public String getParserName()
    public String getModeName()
    {
       int lastSlash = parserName_.lastIndexOf('/');
-      return parserName_.substring(lastSlash + 1);
+      return StringUtil.substring(parserName_, lastSlash + 1);
    }
 
    public boolean useRCompletion()

File: src/gwt/src/org/rstudio/studio/client/common/repos/SecondaryReposDialog.java
Patch:
@@ -255,7 +255,7 @@ public void onResponseReceived(SecondaryReposResult result)
                       if (mainEnd == '/' && repoEnd != '/')
                          repoUrl = repoUrl + "/";
                       else if (mainEnd != '/' && repoEnd == '/')
-                         repoUrl = repoUrl.substring(0, repoUrl.length() - 1);
+                         repoUrl = StringUtil.substring(repoUrl, 0, repoUrl.length() - 1);
                   }
                   
                   if (!StringUtil.isNullOrEmpty(repo.getName()) &&

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/DialogHtmlSanitizer.java
Patch:
@@ -59,15 +59,15 @@ private static String dialogSanitize(String text) {
             if (StringUtil.charAt(segment, 0) == '/') {
                tagStart = 1;
             }
-            tag = segment.substring(tagStart, tagEnd).toLowerCase();
+            tag = StringUtil.substring(segment, tagStart, tagEnd).toLowerCase();
             if (TAG_ALLOW_LIST.contains(tag)) {
                isValidTag = true;
             }
             else {
                // check for links
                int tagSpace = segment.indexOf(' ');
                if (tagSpace > 0) {
-                  String tagName = segment.substring(tagStart, tagSpace).toLowerCase();
+                  String tagName = StringUtil.substring(segment, tagStart, tagSpace).toLowerCase();
                   if (tagName == "a") {
                      
                      if (tag.matches("a href ?= ?\"https?://[^\"]+\"")) {
@@ -88,7 +88,7 @@ private static String dialogSanitize(String text) {
             sanitized.append(tag).append('>');
 
             sanitized.append(SafeHtmlUtils.htmlEscapeAllowEntities(
-            segment.substring(tagEnd + 1)));
+            StringUtil.substring(segment, tagEnd + 1)));
          } else {
             sanitized.append("&lt;").append(
             SafeHtmlUtils.htmlEscapeAllowEntities(segment));

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteUtils.java
Patch:
@@ -14,6 +14,8 @@
  */
 package org.rstudio.studio.client.common.satellite;
 
+import org.rstudio.core.client.StringUtil;
+
 public class SatelliteUtils
 {
    public static String getSatelliteWindowName(String mode)
@@ -23,7 +25,7 @@ public static String getSatelliteWindowName(String mode)
    
    public static String getWindowNameFromSatelliteName(String windowName)
    {
-      return windowName.substring(SATELLITE_PREFIX.length());
+      return StringUtil.substring(windowName, SATELLITE_PREFIX.length());
    }
    
    public static boolean windowNameIsSatellite(String windowName)

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellInteractionManager.java
Patch:
@@ -71,7 +71,7 @@ private String maybeSuppressOutputPrefix(String output)
       outputPrefixToSuppress_ = null;
 
       if (output.startsWith(prefix))
-         return output.substring(prefix.length());
+         return StringUtil.substring(output, prefix.length());
 
       return output;
    }
@@ -144,7 +144,7 @@ private void consolePrompt(String prompt)
          if (defaultPromptSuffix_ == null)
          {
             if (prompt.length() > 1)
-               defaultPromptSuffix_ = prompt.substring(prompt.length()-2);
+               defaultPromptSuffix_ = StringUtil.substring(prompt, prompt.length()-2);
             else if (prompt.length() > 0)
                defaultPromptSuffix_ = prompt;
 

File: src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerItemCodec.java
Patch:
@@ -160,7 +160,7 @@ protected int addBreak(TableRowElement row)
       if (!StringUtil.isNullOrEmpty(fileHeaderBasePath_))
       {
          if (path.startsWith(fileHeaderBasePath_))
-            path = path.substring(fileHeaderBasePath_.length());
+            path = StringUtil.substring(path, fileHeaderBasePath_.length());
       }
       cell.setInnerText(path);
 

File: src/gwt/src/org/rstudio/studio/client/common/vcs/StatusAndPath.java
Patch:
@@ -32,8 +32,8 @@ private String[] splitDirAndName(String path)
          if (index < 0)
             return new String[] { "", path };
          else
-            return new String[] { path.substring(0, index),
-                                  path.substring(index + 1) };
+            return new String[] { StringUtil.substring(path, 0, index),
+                                  StringUtil.substring(path, index + 1) };
       }
 
       @Override

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/Ignore.java
Patch:
@@ -269,7 +269,7 @@ private IgnoreList createIgnoreList(ArrayList<String> paths,
          if (parentPath.length() == 0)
             ignored.add(path);
          else
-            ignored.add(path.substring(thisParent.length() + 1));
+            ignored.add(StringUtil.substring(path, thisParent.length() + 1));
       }
 
       return new IgnoreList(parentPath, ignored);

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorInsertCiteDialog.java
Patch:
@@ -449,9 +449,9 @@ private static String ensureExtension(String fileName, String extension) {
       if (lastDot == -1) {
          return fileName + "." + extension;
       } else {
-         String fileNoExt = fileName.substring(0, lastDot);
-         return fileNoExt + "." + extension;   
-      }           
+         String fileNoExt = StringUtil.substring(fileName, 0, lastDot);
+         return fileNoExt + "." + extension;
+      }
 
    }
    private static final PanmirrorConstants constants_ = GWT.create(PanmirrorConstants.class);

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/model/PdfJsWindow.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.pdfviewer.model;
 
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.studio.client.common.Value;
@@ -464,7 +465,7 @@ public boolean execute()
    private static int getContainerPageNum(Element container)
    {
       return Integer.parseInt(
-            container.getId().substring("pageContainer".length()));
+            StringUtil.substring(container.getId(), "pageContainer".length()));
    }
    
    private static Element getViewerContainer(PdfJsWindow win)

File: src/gwt/src/org/rstudio/studio/client/plumber/PlumberAPI.java
Patch:
@@ -224,7 +224,7 @@ public void onInterruptStatus(InterruptStatusEvent event)
     
    private void launchPlumberAPI(final String filePath)
    {
-      String fileDir = filePath.substring(0, filePath.lastIndexOf("/"));
+      String fileDir = StringUtil.substring(filePath, 0, filePath.lastIndexOf("/"));
       if (fileDir.equals(currentAppPath()))
       {
          // The API being launched is the one already running; open and reload the API.

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -590,7 +590,7 @@ public void onError(ServerError error)
             else
             {
                String projectFile = newProject.getProjectFile();
-               String packageDirectory = projectFile.substring(0,
+               String packageDirectory = StringUtil.substring(projectFile, 0,
                      projectFile.lastIndexOf('/'));
 
                projServer_.packageSkeleton(

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/SvnPage.java
Patch:
@@ -15,6 +15,8 @@
 package org.rstudio.studio.client.projects.ui.newproject;
 
 import com.google.gwt.core.client.GWT;
+
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.common.vcs.VCSConstants;
 import org.rstudio.studio.client.projects.StudioClientProjectConstants;
@@ -49,7 +51,7 @@ protected String guessRepoDir(String url)
    {
       // Strip trailing spaces and slashes
       while (url.endsWith("/") || url.endsWith(" ") || url.endsWith("\t"))
-         url = url.substring(0, url.length() - 1);
+         url = StringUtil.substring(url, 0, url.length() - 1);
       
       // Find last component
       url = url.replaceFirst(".*[/]", ""); // greedy

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectCompilePdfPreferencesPane.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.projects.ui.prefs;
 
 import org.rstudio.core.client.ElementIds;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.prefs.PreferencesDialogBaseResources;
 import org.rstudio.core.client.prefs.RestartRequirement;
@@ -144,7 +145,7 @@ public void execute(FileSystemItem input,
                            if (input.getPath().startsWith(proj + "/"))
                            {
                               String projRelative =
-                                input.getPath().substring(proj.length() + 1);
+                                StringUtil.substring(input.getPath(), proj.length() + 1);
                               setText(projRelative);
                            }
                            else

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsPanel.java
Patch:
@@ -17,6 +17,7 @@
 
 import com.google.gwt.safehtml.shared.SafeHtmlBuilder;
 import org.rstudio.core.client.ElementIds;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.widget.FormLabel;
@@ -73,7 +74,7 @@ protected String getProjectPath(FileSystemItem projDir,
          String proj = projDir.getPath();
          if (path.getPath().startsWith(proj + "/"))
          {
-            return path.getPath().substring(proj.length() + 1);
+            return StringUtil.substring(path.getPath(), proj.length() + 1);
          }
          else
          {

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputFramePane.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.rmarkdown.ui;
 
 import org.rstudio.core.client.ScrollUtil;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.widget.Operation;
@@ -169,7 +170,7 @@ public String getAnchor()
       if (url == null)
          return "";
       int anchorPos = url.lastIndexOf("#");
-      return anchorPos > 0 ? url.substring(anchorPos + 1) : "";
+      return anchorPos > 0 ? StringUtil.substring(url, anchorPos + 1) : "";
    }
    
    private RStudioFrame frame_;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -32,6 +32,7 @@
 
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.ScrollUtil;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.IFrameElementEx;
 import org.rstudio.core.client.dom.WindowEx;
@@ -386,7 +387,7 @@ public String getAnchor()
    {
       String url = getCurrentUrl();
       int anchorPos = url.lastIndexOf("#");
-      return anchorPos > 0 ? url.substring(anchorPos + 1) : "";
+      return anchorPos > 0 ? StringUtil.substring(url, anchorPos + 1) : "";
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -727,7 +727,7 @@ public void onRSConnectDeploymentFailed(
       }
       if (pos > 0)
       {
-         failedPath = failedPath.substring(0, pos);
+         failedPath = StringUtil.substring(failedPath, 0, pos);
       }
       final String serverUrl = failedPath;
 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/DirEntryCheckBox.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.rsconnect.ui;
 
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.studio.client.RStudioGinjector;
 
@@ -31,7 +32,7 @@ public DirEntryCheckBox(String path)
       FileSystemItem fsi = null;
       if (path.endsWith("/"))
       {
-         path = path.substring(0, path.length() - 1);
+         path = StringUtil.substring(path, 0, path.length() - 1);
          fsi = FileSystemItem.createDir(path);
       }
       else

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/NewRSConnectAuthPage.java
Patch:
@@ -273,7 +273,7 @@ private void onUserAuthVerified()
             // if we don't have any username, guess one based on user's given name
             // on the server
             result_.setAccountNickname(
-                  result_.getAuthUser().getFirstName().substring(0, 1) + 
+                  StringUtil.substring(result_.getAuthUser().getFirstName(), 0, 1) + 
                   result_.getAuthUser().getLastName().toLowerCase());
          }
       }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -1750,7 +1750,7 @@ public final String resolveAliasedPath(FileSystemItem file)
    {
       String path = file.getPath();
       if (path.startsWith("~"))
-         path = userHomePath_ + path.substring(1);
+         path = userHomePath_ + StringUtil.substring(path, 1);
       return path;
    }
 

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplication.java
Patch:
@@ -293,7 +293,7 @@ private void launchShinyApplication(final String filePath,
          final String destination,
          final String extendedType)
    {
-      String fileDir = filePath.substring(0, filePath.lastIndexOf("/"));
+      String fileDir = StringUtil.substring(filePath, 0, filePath.lastIndexOf("/"));
       for (ShinyApplicationParams params: params_)
       {
          if (StringUtil.equals(fileDir, params.getPath()))

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplicationSatellite.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.shiny;
 
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.ApplicationUncaughtExceptionHandler;
 import org.rstudio.studio.client.common.satellite.Satellite;
@@ -32,7 +33,7 @@ public class ShinyApplicationSatellite extends SatelliteApplication
    
    public static final String getIdFromName(String name)
    {
-      return name.substring(NAME_PREFIX.length());
+      return StringUtil.substring(name, NAME_PREFIX.length());
    }
    
    public static final String getNameFromId(String id)

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchOracle.java
Patch:
@@ -180,7 +180,7 @@ public void requestSuggestions(final Request request,
                   if (colonIndex == -1)
                      colonIndex = query.length();
                   
-                  if (StringUtil.isSubsequence(name, query.substring(0, colonIndex), true))
+                  if (StringUtil.isSubsequence(name, StringUtil.substring(query, 0, colonIndex), true))
                      suggestions.add(sugg);
                }
             }
@@ -372,7 +372,7 @@ private void sortSuggestions(ArrayList<CodeSearchSuggestion> suggestions,
       // the query matches the start to come first
       int colonIndex = query.indexOf(":");
       final String localQuery = colonIndex > 0 ?
-            query.substring(0, colonIndex) :
+            StringUtil.substring(query, 0, colonIndex) :
             query;
       
       java.util.Collections.sort(suggestions,

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchSuggestion.java
Patch:
@@ -140,7 +140,7 @@ public CodeSearchSuggestion(SourceItem sourceItem, FileSystemItem fsContext)
          if (context.startsWith(fsContextPath) &&
              (context.length() > fsContextPath.length()))
          {
-            context = context.substring(fsContextPath.length());
+            context = StringUtil.substring(context, fsContextPath.length());
          }
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PythonPreferencesPaneBase.java
Patch:
@@ -382,7 +382,7 @@ protected RestartRequirement onApply(boolean isProjectPrefs,
       {
          FileSystemItem projDir = session_.getSessionInfo().getActiveProjectDir();
          if (projDir.exists() && newValue.startsWith(projDir.getPath()))
-            newValue = newValue.substring(projDir.getLength() + 1);
+            newValue = StringUtil.substring(newValue, projDir.getLength() + 1);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetHost.java
Patch:
@@ -441,7 +441,7 @@ private void updateCodePanel()
                value = value.replaceAll("\\$equal\\$", "=");
             }
 
-            builder.append(input.substring(inputIndex, matcher.getIndex()));
+            builder.append(StringUtil.substring(input, inputIndex, matcher.getIndex()));
             
             if (partsKeyValues_.containsKey(key)) {
                value = partsKeyValues_.get(key);
@@ -464,7 +464,7 @@ private void updateCodePanel()
          }
       }
       
-      builder.append(input.substring(inputIndex, input.length()));
+      builder.append(StringUtil.substring(input, inputIndex, input.length()));
       
       codePanel_.setCode(builder.toString(), "");
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ShellInputAnimator.java
Patch:
@@ -18,6 +18,7 @@
 
 import java.util.ArrayList;
 
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.studio.client.workbench.views.console.shell.editor.InputEditorDisplay;
 
 import com.google.gwt.core.client.Scheduler;
@@ -109,7 +110,7 @@ public boolean execute()
          if (nextChar_ == 0)
             display_.clear();
          
-         display_.insertCode(code_.substring(nextChar_, nextChar_+1));
+         display_.insertCode(StringUtil.substring(code_, nextChar_, nextChar_+1));
          
          nextChar_++;
          

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionCache.java
Patch:
@@ -52,7 +52,7 @@ public boolean satisfyRequest(String line,
       
       for (int i = 0, n = line.length(); i < n; i++)
       {
-         String substring = line.substring(0, n - i);
+         String substring = StringUtil.substring(line, 0, n - i);
          if (cache_.containsKey(substring))
          {
             Completions completions = narrow(line, substring, cache_.get(substring));
@@ -85,7 +85,7 @@ private Completions narrow(String line,
       // Construct the new completion token by taking the original
       // completion token, and adding the delta between the new line and
       // the original completion line used.
-      String token = original.getToken() + line.substring(substring.length());
+      String token = original.getToken() + StringUtil.substring(line, substring.length());
       
       // Extract the vector elements of the completion string
       JsArrayString completions      = original.getCompletions();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/PythonCompletionManager.java
Patch:
@@ -288,7 +288,7 @@ private String singleLineCompletion()
       
       String line = context.getLine();
       int position = context.getPosition();
-      return line.substring(0, position);
+      return StringUtil.substring(line, 0, position);
    }
    
    // this routine is primarily used to provide some extra context

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -896,17 +896,17 @@ else if (useCurrentBrowseSource_ &&
             int idx = functionName.indexOf('(');
             if (idx > 0)
             {
-               functionName = functionName.substring(0, idx);
+               functionName = StringUtil.substring(functionName, 0, idx);
             }
 
             // omit qualifiers
             idx = functionName.indexOf("::");
             if (idx > 0)
             {
-               functionName = functionName.substring(idx + 1);
+               functionName = StringUtil.substring(functionName, idx + 1);
                // :::, too
                if (functionName.startsWith(":"))
-                  functionName = functionName.substring(1);
+                  functionName = StringUtil.substring(functionName, 1);
             }
 
             // create the function definition

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -1072,7 +1072,7 @@ private FileSystemItem getDefaultFileName(TextFileType fileType)
       String defaultExt = fileType.getDefaultExtension();
 
       // extension has a '.' at the start, so remove that in the default name
-      String newFileDefaultName = "Untitled" + defaultExt.toUpperCase().substring(1) + defaultExt;
+      String newFileDefaultName = "Untitled" + StringUtil.substring(defaultExt.toUpperCase(), 1) + defaultExt;
       String path = currentPath_.completePath(newFileDefaultName);
       FileSystemItem newTempFile = FileSystemItem.createFile(path);
       return newTempFile;
@@ -1082,7 +1082,7 @@ private void touchFile(final TextFileType fileType)
    {
       // prepare default information about the new file
       FileSystemItem newTempFile = getDefaultFileName(fileType);
-      String formattedExt = fileType.getDefaultExtension().toUpperCase().substring(1);
+      String formattedExt = StringUtil.substring(fileType.getDefaultExtension().toUpperCase(), 1);
       
       // guard for reentrancy
       if (inputPending_)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/Help.java
Patch:
@@ -21,6 +21,7 @@
 
 import org.rstudio.core.client.CsvReader;
 import org.rstudio.core.client.CsvWriter;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.command.Handler;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -217,7 +218,7 @@ private String getApplicationRelativeHelpUrl(String helpUrl)
    {
       String appUrl = server_.getApplicationURL("");
       if (helpUrl.startsWith(appUrl) && !helpUrl.equals(appUrl))
-         return helpUrl.substring(appUrl.length());
+         return StringUtil.substring(helpUrl, appUrl.length());
       else
          return helpUrl;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -544,7 +544,7 @@ private String getDocTitle(Document doc)
       int previewLoc = docUrl.indexOf(previewPrefix);
       if (previewLoc != -1)
       {
-         String file = docUrl.substring(previewLoc + previewPrefix.length());
+         String file = StringUtil.substring(docUrl, previewLoc + previewPrefix.length());
          file = URL.decodeQueryString(file);
          FileSystemItem fsi = FileSystemItem.createFile(file);
          docTitle = fsi.getName();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -458,7 +458,7 @@ protected JsObject getValue()
                String projPath = projDir.getPath();
                if ((path + "/").startsWith(projPath + "/"))
                {
-                  object.setString("path", path.substring(projPath.length()));
+                  object.setString("path", StringUtil.substring(path, projPath.length()));
                   object.setBoolean("projectRelative", true);
                }
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/QuartoCommands.java
Patch:
@@ -228,7 +228,7 @@ private String updateLanguage(String input, String language)
             if (plotCodePos == -1 )
                plotCodePos = input.indexOf("## Slide with Plot");
             if (plotCodePos != -1)
-               input = input.substring(0, plotCodePos - 1);
+               input = StringUtil.substring(input, 0, plotCodePos - 1);
          }
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -1000,7 +1000,7 @@ private static String sourceWindowId(String input)
    {
       if (input != null && input.startsWith(SourceSatellite.NAME_PREFIX))
       {
-         return input.substring(SourceSatellite.NAME_PREFIX.length());
+         return StringUtil.substring(input, SourceSatellite.NAME_PREFIX.length());
       }
       return "";
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -323,12 +323,12 @@ public void showErrorOutput(UnhandledError err)
          // emit any messages queued prior to the error
          if (idx > 0)
          {
-            renderConsoleOutput(queuedError_.substring(0, idx), 
+            renderConsoleOutput(StringUtil.substring(queuedError_, 0, idx), 
                   classOfOutput(ChunkConsolePage.CONSOLE_ERROR));
             initializeOutput(RmdChunkOutputUnit.TYPE_ERROR);
          }
          // leave messages following the error in the queue
-         queuedError_ = queuedError_.substring(
+         queuedError_ = StringUtil.substring(queuedError_, 
                idx + err.getErrorMessage().length());
       }
       else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkPlotWidget.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.ImageElementEx;
 import org.rstudio.core.client.widget.FixedRatioWidget;
 import org.rstudio.studio.client.common.FilePathUtils;
@@ -202,7 +203,7 @@ public void updateImageUrl(String plotUrl, String pendingStyle)
       String url = plot_.getUrl();
       int idx = url.lastIndexOf('?');
       if (idx > 0)
-         url = url.substring(0, idx);
+         url = StringUtil.substring(url, 0, idx);
       
       // verify that the plot being refreshed is the same one this widget
       // contains

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ImagePreviewer.java
Patch:
@@ -128,7 +128,7 @@ public static void onPreviewLink(DocDisplay display,
                 endBraceIdx != -1 &&
                 endBraceIdx > startBraceIdx)
             {
-               attributes = line.substring(startBraceIdx + 2, endBraceIdx).trim();
+               attributes = StringUtil.substring(line, startBraceIdx + 2, endBraceIdx).trim();
             }
          }
          
@@ -409,7 +409,7 @@ private void onDocumentChangedImpl(DocumentChangedEvent event)
                         endBraceIdx != -1 &&
                         endBraceIdx > startBraceIdx)
                   {
-                     attributes = line.substring(startBraceIdx + 2, endBraceIdx).trim();
+                     attributes = StringUtil.substring(line, startBraceIdx + 2, endBraceIdx).trim();
                   }
                   
                   // if we have the same href as before, don't update

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCompilePdfHelper.java
Patch:
@@ -326,7 +326,7 @@ public static int getRnwOptionsStart(String line, int cursorPos,
       if (startPattern == null)
          return -1;
       
-      String linePart = line.substring(0, cursorPos);
+      String linePart = StringUtil.substring(line, 0, cursorPos);
       Match match = startPattern.match(linePart, 0);
       if (match == null)
          return -1;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetPresentation2Helper.java
Patch:
@@ -76,7 +76,7 @@ else if (type.startsWith("markup.heading."))
          {
             boolean foundHeading = false;
             int level = StringUtil.parseInt(
-               type.substring(type.length()-1, type.length()),
+               StringUtil.substring(type, type.length()-1, type.length()),
                0
             );
             // atx style

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetReformatHelper.java
Patch:
@@ -1172,7 +1172,7 @@ private void doAlignAssignment(int startRow,
          }
          else
          {
-            String start = line.substring(0, match.getGroup(1).length());
+            String start = StringUtil.substring(line, 0, match.getGroup(1).length());
             start = start.replaceAll("\\s*$", "");
             starts.add(start);
             
@@ -1181,7 +1181,7 @@ private void doAlignAssignment(int startRow,
             int endOfDelim = match.getGroup(1).length() +
                   match.getGroup(2).length();
             
-            String end = line.substring(endOfDelim);
+            String end = StringUtil.substring(line, endOfDelim);
             end = end.replaceAll("^\\s*", "");
             ends.add(end);
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -1382,7 +1382,7 @@ public void setFormatOptions(TextFileType fileType,
 
       int parenPos = selectedOption.indexOf('(');
       if (parenPos != -1)
-          selectedOption = selectedOption.substring(0, parenPos).trim();
+          selectedOption = StringUtil.substring(selectedOption, 0, parenPos).trim();
 
       // don't show format text (but leave the code in for now in case
       // we change our mind)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorBackgroundLinkHighlighter.java
Patch:
@@ -436,7 +436,7 @@ private void onWebLinkHighlight(String line, int row)
          {
             startIdx++;
             endIdx--;
-            url = url.substring(1, url.length() - 1);
+            url = StringUtil.substring(url, 1, url.length() - 1);
          }
 
          // trim off trailing punctuation (characters unlikely

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceInputEditorPosition.java
Patch:
@@ -147,9 +147,9 @@ private boolean isLineEmpty(Position position, boolean leftwards)
       String line = session_.getLine(position.getRow());
       int column = position.getColumn();
       if (leftwards)
-         line = line.substring(0, Math.min(line.length(), column));
+         line = StringUtil.substring(line, 0, Math.min(line.length(), column));
       else
-         line = line.substring(Math.min(line.length(), column));
+         line = StringUtil.substring(line, Math.min(line.length(), column));
 
       return StringUtil.notNull(line).trim().length() == 0;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/assist/RChunkHeaderParser.java
Patch:
@@ -201,7 +201,7 @@ private static final boolean consumeUntilRegex(TextCursor cursor,
       int endIdx = match.getIndex();
       if (consumer != null)
       {
-         String value = cursor.getData().substring(startIdx, endIdx);
+         String value = StringUtil.substring(cursor.getData(), startIdx, endIdx);
          consumer.consume(value);
       }
 
@@ -220,7 +220,7 @@ private static final boolean consumeQuotedItem(TextCursor cursor, Consumer consu
          int endIndex = cursor.getIndex() + 1;
          if (consumer != null)
          {
-            String value = cursor.getData().substring(startIndex, endIndex);
+            String value = StringUtil.substring(cursor.getData(), startIndex, endIndex);
             consumer.consume(value);
          }
          cursor.setIndex(endIndex);
@@ -257,7 +257,7 @@ private static final boolean consumeValue(TextCursor cursor,
       int endIdx = cursor.getIndex();
       if (consumer != null)
       {
-         String value = cursor.getData().substring(startIdx, endIdx);
+         String value = StringUtil.substring(cursor.getData(), startIdx, endIdx);
          consumer.consume(value);
       }
       cursor.setIndex(endIdx);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionRequest.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Invalidation;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.regex.Match;
 import org.rstudio.core.client.regex.Pattern;
 import org.rstudio.studio.client.RStudioGinjector;
@@ -72,7 +73,7 @@ public CppCompletionRequest(String docPath,
       
       // Get the current line (up to the cursor position)
       Position cursorPos = docDisplay_.getCursorPosition();
-      String line = docDisplay_.getLine(cursorPos.getRow()).substring(0, cursorPos.getColumn());
+      String line = StringUtil.substring(docDisplay_.getLine(cursorPos.getRow()), 0, cursorPos.getColumn());
       
       Position completionPos = completionPosition_.getPosition();
       server_.getCppCompletions(line,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionUtils.java
Patch:
@@ -137,7 +137,7 @@ else if ((alwaysComplete || explicit) &&                     // either always co
       {
          // calculate user text (up to two characters of additional
          // server side filter)
-         String userText = line.substring(
+         String userText = StringUtil.substring(line, 
                col + 1, Math.min(col + 3, position.getColumn()));
          
          CompletionPosition.Scope scope = isInclude

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/r/RCompletionToolTip.java
Patch:
@@ -127,15 +127,15 @@ private String truncateSignature(String signature, int length)
          ArrayList<Integer> commaIndices = StringUtil.indicesOf(signature, ',');
          if (commaIndices.size() == 0)
          {
-            truncated = signature.substring(0, length);
+            truncated = StringUtil.substring(signature, 0, length);
          }
 
          for (int i = 0; i < commaIndices.size(); i++)
          {
             int index = commaIndices.get(i);
             if (index >= length)
             {
-               truncated = signature.substring(0, index + 1);
+               truncated = StringUtil.substring(signature, 0, index + 1);
                break;
             }
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextUi.java
Patch:
@@ -73,9 +73,9 @@ public static String extractChunkLabel(String extractedChunkHeader)
       // must be all the text following the first space
       if (firstEqualsIdx == -1 && firstCommaIdx == -1)
       {
-         extractedChunkHeader = extractedChunkHeader.substring(firstSpaceIdx + 1).trim();
+         extractedChunkHeader = StringUtil.substring(extractedChunkHeader, firstSpaceIdx + 1).trim();
          if (extractedChunkHeader.endsWith("}"))
-            extractedChunkHeader = extractedChunkHeader.substring(0, extractedChunkHeader.length() -1);
+            extractedChunkHeader = StringUtil.substring(extractedChunkHeader, 0, extractedChunkHeader.length() -1);
          return extractedChunkHeader;
       }
 
@@ -92,7 +92,7 @@ public static String extractChunkLabel(String extractedChunkHeader)
          return "";
 
       // otherwise, the text from the first space to that comma gives the label
-      return extractedChunkHeader.substring(firstSpaceIdx + 1, firstCommaIdx).trim();
+      return StringUtil.substring(extractedChunkHeader, firstSpaceIdx + 1, firstCommaIdx).trim();
    }
 
    // Public methods ----------------------------------------------------------

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/NotebookQueueState.java
Patch:
@@ -586,7 +586,7 @@ private void withQueueDependencies(Command command)
          if (newlineIndex == -1)
             continue;
          
-         String header = code.substring(0, newlineIndex);
+         String header = StringUtil.substring(code, 0, newlineIndex);
          Map<String, String> chunkOptions = RChunkHeaderParser.parse(header);
          if (!chunkOptions.containsKey("engine"))
             continue;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeChunk.java
Patch:
@@ -1144,7 +1144,7 @@ private Element createSummary()
             // If this is the magic comment indicating a Quarto label, extract the label
             if (line.startsWith(quartoLabel))
             {
-               label = line.substring(quartoLabel.length()).trim();
+               label = StringUtil.substring(line, quartoLabel.length()).trim();
             }
          }
          lines++;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeMarkdownWriter.java
Patch:
@@ -205,7 +205,7 @@ else if ("none".equals(referencesPrefixPref))
                String filename = FileSystemItem.createFile(docPath).getStem();
                PanmirrorUIToolsAttr attr = new PanmirrorUITools().attr;
                // artifically add "a" and then remove it after pandocAutoIdentifier()
-               options.references.prefix = attr.pandocAutoIdentifier("a" + filename).substring(1) + "-";
+               options.references.prefix = StringUtil.substring(attr.pandocAutoIdentifier("a" + filename), 1) + "-";
             }
          }
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/CompletionOptions.java
Patch:
@@ -16,13 +16,15 @@
 
 import java.util.ArrayList;
 
+import org.rstudio.core.client.StringUtil;
+
 public class CompletionOptions
 {
    public void addOption(String optionValue,
                          int minPrefixChars)
    {
       options_.add(optionValue);
-      filterPrefixes_.add(optionValue.substring(0, minPrefixChars));
+      filterPrefixes_.add(StringUtil.substring(optionValue, 0, minPrefixChars));
    }
 
    public ArrayList<String> getCompletions(String prefix)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -251,7 +251,7 @@ private String trimCaption(String caption)
       // Enforce a sane visual limit on terminal captions
       if (caption.length() > 32)
       {
-         caption = caption.substring(0, 31) + "...";
+         caption = StringUtil.substring(caption, 0, 31) + "...";
       }
       return caption;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -404,7 +404,7 @@ private void sendUserInput()
       }
       if (inputQueue_.length() > MAXCHUNK)
       {
-         userInput = inputQueue_.substring(0, MAXCHUNK);
+         userInput = StringUtil.substring(inputQueue_, 0, MAXCHUNK);
          inputQueue_.delete(0, MAXCHUNK);
       }
       else
@@ -509,7 +509,7 @@ public void onXTermTitle(XTermTitleEvent event)
       // if there's nothing before it
       if (BrowseCap.isWindowsDesktop() && !StringUtil.isNullOrEmpty(title) && title.startsWith(":/"))
       {
-         title = title.substring(1);
+         title = StringUtil.substring(title, 1);
       }
       setTitle(title);
       eventBus_.fireEvent(new TerminalTitleEvent(this));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSessionSocket.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.user.client.Timer;
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.HandlerRegistrations;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.regex.Pattern;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.common.console.ConsoleOutputEvent;
@@ -177,11 +178,11 @@ public void connect(ConsoleProcess consoleProcess,
             url = GWT.getHostPageBaseURL();
             if (url.startsWith("https:"))
             {
-               url = "wss:" + url.substring(6) + "p/" + urlSuffix;
+               url = "wss:" + StringUtil.substring(url, 6) + "p/" + urlSuffix;
             }
             else if (url.startsWith("http:"))
             {
-               url = "ws:" + url.substring(5) + "p/" + urlSuffix;
+               url = "ws:" + StringUtil.substring(url, 5) + "p/" + urlSuffix;
             }
             else
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSocketPacket.java
Patch:
@@ -52,7 +52,7 @@ public static String getMessage(String text)
    {
       if (text.startsWith(textPrefix))
       {
-         return text.substring(1);
+         return StringUtil.substring(text, 1);
       }
       return "";
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/Pager.java
Patch:
@@ -19,6 +19,8 @@
 import com.google.gwt.user.cellview.client.SimplePager;
 import com.google.gwt.view.client.HasRows;
 import com.google.gwt.view.client.Range;
+
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.studio.client.workbench.views.vcs.ViewVcsConstants;
 
 public class Pager extends SimplePager
@@ -99,7 +101,7 @@ protected String createText()
       else
       {
          int pos = text.indexOf(" of "); // TODO - don't think I can change this? Check w/ Gary
-         return constants_.commitsPager((pos >= 0 ? text.substring(0, pos) : text));
+         return constants_.commitsPager((pos >= 0 ? StringUtil.substring(text, 0, pos) : text));
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/VCSFileOpener.java
Patch:
@@ -97,7 +97,7 @@ private JsArray<FileSystemItem> toJsArray(ArrayList<StatusAndPath> items)
             if (parts.length == 2)
             {
                String oldPath = parts[0], newPath = parts[1];
-               path = oldPath.substring(0, oldPath.lastIndexOf('/')) + "/" + newPath;
+               path = StringUtil.substring(oldPath, 0, oldPath.lastIndexOf('/')) + "/" + newPath;
             }
          }
          

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/diff/ChunkHeaderParser.java
Patch:
@@ -16,6 +16,8 @@
 
 import java.util.ArrayList;
 
+import org.rstudio.core.client.StringUtil;
+
 class ChunkHeaderParser
 {
    public ChunkHeaderParser(String s)
@@ -73,7 +75,7 @@ public ChunkHeaderInfo parse()
             return null;
       }
 
-      String extraInfo = s_.substring(p_);
+      String extraInfo = StringUtil.substring(s_, p_);
 
       return new ChunkHeaderInfo(ranges.toArray(new Range[ranges.size()]),
                                  extraInfo);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/DiffFrame.java
Patch:
@@ -23,6 +23,8 @@
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.ui.*;
+
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.widget.DecorativeImage;
@@ -94,7 +96,7 @@ public DiffFrame(ImageResource icon,
          
          viewFileHyperlink_.setClickHandler(viewFileClickHandler);
          viewFileHyperlink_.setAlwaysUnderline(false);
-         viewFileHyperlink_.setText(constants_.viewFileAtString(commitId.substring(0, 8)));
+         viewFileHyperlink_.setText(constants_.viewFileAtString(StringUtil.substring(commitId, 0, 8)));
          viewFileHyperlink_.addStyleName(RES.styles().viewFileHyperlink());
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/dialog/GitReviewPresenter.java
Patch:
@@ -734,7 +734,7 @@ private void applyPatch(ArrayList<DiffChunk> chunks,
 
       String path = view_.getChangelistTable().getSelectedPaths().get(0);
       if (path.indexOf(" -> ") >= 0)
-         path = path.substring(path.indexOf(" -> ") + " -> ".length());
+         path = StringUtil.substring(path, path.indexOf(" -> ") + " -> ".length());
       UnifiedEmitter emitter = new UnifiedEmitter(path);
       for (DiffChunk chunk : chunks)
          emitter.addContext(chunk);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/SVNDiffParser.java
Patch:
@@ -61,13 +61,13 @@ public SVNDiffParser(String data)
          sectionMatches.add(m);
 
          if (lastHeaderStart >= 0)
-            sectionData.add(data.substring(lastHeaderStart, m.getIndex()));
+            sectionData.add(StringUtil.substring(data, lastHeaderStart, m.getIndex()));
 
          lastHeaderStart = m.getIndex();
          pos = m.getIndex() + m.getValue().length();
       }
       if (lastHeaderStart >= 0)
-         sectionData.add(data.substring(lastHeaderStart));
+         sectionData.add(StringUtil.substring(data, lastHeaderStart));
 
       sections_ = new ArrayList<>();
       for (int i = 0; i < sectionData.size(); i++)
@@ -143,7 +143,7 @@ public int compare(Section a, Section b)
                int startAt = (m != null) ? m.getIndex() + m.getValue().length()
                                          : 0;
                Iterable<String> lines = StringUtil.getLineIterator(
-                     StringUtil.trimBlankLines(section.data.substring(startAt)));
+                     StringUtil.trimBlankLines(StringUtil.substring(section.data, startAt)));
                DiffChunk chunk = createInfoChunk(lines);
                if (lastSection != null && lastSection.isProperty)
                {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/quarto/QuartoConnection.java
Patch:
@@ -56,7 +56,7 @@ public void setQuartoUrl(String url, boolean website)
          // clean out viewer_pane params
          int paramsLoc = url.indexOf("?capabilities=");
          if (paramsLoc != -1)
-            url = url.substring(0, paramsLoc);
+            url = StringUtil.substring(url, 0, paramsLoc);
       }
       url_ = url;
       website_ = website;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessorConstants.java
Patch:
@@ -400,7 +400,7 @@ public interface UserPrefsAccessorConstants extends Constants {
    String codeCompletionOtherEnum_always();
    @DefaultStringValue("When triggered")
    String codeCompletionOtherEnum_triggered();
-   @DefaultStringValue("Manually (ctrl+space)")
+   @DefaultStringValue("Manually (Ctrl+Space)")
    String codeCompletionOtherEnum_manual();
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessorConstants.java
Patch:
@@ -400,7 +400,7 @@ public interface UserPrefsAccessorConstants extends Constants {
    String codeCompletionOtherEnum_always();
    @DefaultStringValue("When triggered")
    String codeCompletionOtherEnum_triggered();
-   @DefaultStringValue("Manually (ctrl+space)")
+   @DefaultStringValue("Manually (Ctrl+Space)")
    String codeCompletionOtherEnum_manual();
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -738,6 +738,7 @@
    public abstract AppCommand copilotStatus();
    public abstract AppCommand copilotRequestCompletions();
    public abstract AppCommand copilotAcceptNextWord();
+   public abstract AppCommand copilotToggleAutomaticCompletions();
 
    // Internal
    public abstract AppCommand showDomElements();

File: src/gwt/src/org/rstudio/studio/client/workbench/copilot/model/CopilotEvent.java
Patch:
@@ -27,6 +27,8 @@ public static enum CopilotEventType
       COMPLETION_RECEIVED_NONE,
       COMPLETION_CANCELLED,
       COMPLETION_ERROR,
+      COMPLETIONS_ENABLED,
+      COMPLETIONS_DISABLED,
    }
    
    public CopilotEvent(CopilotEventType type, Object data)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessorConstants.java
Patch:
@@ -386,7 +386,7 @@ public interface UserPrefsAccessorConstants extends Constants {
    String codeCompletionEnum_never();
    @DefaultStringValue("When triggered ($, ::)")
    String codeCompletionEnum_triggered();
-   @DefaultStringValue("Manually (tab)")
+   @DefaultStringValue("Manually (Tab, Ctrl + Space)")
    String codeCompletionEnum_manual();
 
    /**

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogBaseResources.java
Patch:
@@ -42,6 +42,7 @@ public interface Styles extends CssResource
       String infoLabel();
       String headerLabel();
       String spacedBefore();
+      String extraSpacedBefore();
    }
 
    @Source("PreferencesDialogBase.css")

File: src/gwt/src/org/rstudio/studio/client/common/dialog/DialogBuilderFactory.java
Patch:
@@ -14,9 +14,10 @@
  */
 package org.rstudio.studio.client.common.dialog;
 
+import org.rstudio.core.client.DialogOptions;
 import org.rstudio.core.client.widget.DialogBuilder;
 
 public interface DialogBuilderFactory
 {
-   DialogBuilder create(int type, String caption, String message);
+   DialogBuilder create(int type, String caption, String message, DialogOptions options);
 }

File: src/gwt/src/org/rstudio/core/client/yaml/Yaml.java
Patch:
@@ -14,11 +14,12 @@
  */
 package org.rstudio.core.client.yaml;
 
+import jsinterop.annotations.JsPackage;
 import jsinterop.annotations.JsType;
 
 // https://github.com/nodeca/js-yaml
 // Currently using js-yaml 4.1.0; supports the YAML 1.2 spec.
-@JsType(isNative = true, name = "jsyaml")
+@JsType(isNative = true, namespace = JsPackage.GLOBAL, name = "jsyaml")
 public class Yaml
 {
    public static native Object load(String yaml);

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RMarkdownServerOperations.java
Patch:
@@ -120,6 +120,7 @@ void rmdImportImages(JsArrayString images,
                         ServerRequestCallback<JsArrayString> requestCallback);
    
    void rmdSaveBase64Images(JsArrayString images,
+                            String documentPath,
                             String imagesDir,
                             ServerRequestCallback<JsArrayString> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -5707,11 +5707,13 @@ public void rmdImportImages(JsArrayString images, String imagesDir,
    
    @Override
    public void rmdSaveBase64Images(JsArrayString images,
+                                   String documentPath,
                                    String imagesDir,
                                    ServerRequestCallback<JsArrayString> requestCallback)
    {
       JSONArray params = new JSONArrayBuilder()
             .add(images)
+            .add(StringUtil.notNull(documentPath))
             .add(imagesDir)
             .get();
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModePanmirrorContext.java
Patch:
@@ -284,9 +284,10 @@ public void onResponseReceived(JsArrayString importedUris)
       
       uiContext.resolveBase64Images = (images) -> {
          return new Promise<JsArrayString>((ResolveCallbackFn<JsArrayString> resolve, RejectCallbackFn reject) -> {
+            String documentPath = uiContext.getDocumentPath.get();
             FileSystemItem resourceDir = FileSystemItem.createDir(uiContext.getDefaultResourceDir.get());
-            String imagesDir = resourceDir.completePath(constants_.images());
-            server_.rmdSaveBase64Images(images, imagesDir, new ServerRequestCallback<JsArrayString>()
+            String imagesDir = resourceDir.completePath("images");
+            server_.rmdSaveBase64Images(images, documentPath, imagesDir, new ServerRequestCallback<JsArrayString>()
             {
                @Override
                public void onResponseReceived(JsArrayString response)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -114,8 +114,8 @@ public native final void setCompletionOptions(boolean enabled,
         enableBasicAutocompletion: enabled,
         enableSnippets: enabled && snippets,
         enableLiveAutocompletion: enabled && live,
-        completionCharacterThreshold: characterThreshold,
-        completionDelay: delayMilliseconds
+        liveAutocompletionThreshold: characterThreshold,
+        liveAutocompletionDelay: delayMilliseconds
       });
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -179,7 +179,7 @@ public void execute()
          });
       });
 
-      if (BrowseCap.isMacintoshDesktop()) {
+      if (BrowseCap.isMacintoshDesktop() && BrowseCap.isElectron()) {
          Desktop.getFrame().detectRosetta();
       }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/copilot/model/CopilotConstants.java
Patch:
@@ -25,6 +25,7 @@ public class CopilotConstants
    public static class ErrorCodes
    {
       public static final int DOCUMENT_NOT_FOUND = -32602;
+      public static final int UNABLE_TO_GET_LOCAL_ISSUER_CERTIFICATE = -32603;
       public static final int NOT_SIGNED_IN = 1000;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -1035,7 +1035,7 @@ private void showOpenProjectDialog(
                   ProgressOperationWithInput<OpenProjectParams> onCompleted)
    {
       opener_.showOpenProjectDialog(fsContext_, projServer_,
-            "~",
+            pUserPrefs_.get().defaultProjectLocation().getValue(),
             defaultType, allowOpenInNewWindow, onCompleted);
    }
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -2196,7 +2196,7 @@ public void readProjectOptions(ServerRequestCallback<RProjectOptions> callback)
    }
 
    public void writeProjectOptions(RProjectOptions options,
-                                  ServerRequestCallback<Void> callback)
+                                   ServerRequestCallback<Void> callback)
    {
       sendRequest(RPC_SCOPE, WRITE_PROJECT_OPTIONS, options, callback);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/CopilotPreferencesPane.java
Patch:
@@ -292,7 +292,7 @@ public void onResponseReceived(CopilotStatusResponse response)
             
             if (response == null)
             {
-               if (projectOptions_ != null && projectOptions_.getConfig().getCopilotEnabled() == RProjectConfig.NO_VALUE)
+               if (projectOptions_ != null && projectOptions_.getCopilotOptions().copilot_enabled == RProjectConfig.NO_VALUE)
                {
                   lblCopilotStatus_.setText("GitHub Copilot has been disabled in this project.");
                   showButtons(btnProjectOptions_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1864,9 +1864,7 @@ public void onCopilot(CopilotEvent event)
                   }
                }
             });
-
       
-
       packageDependencyHelper_ = new TextEditingTargetPackageDependencyHelper(this, docUpdateSentinel_, docDisplay_);
 
       // create notebook and forward resize events

File: src/gwt/src/org/rstudio/core/client/widget/SelectWidget.java
Patch:
@@ -136,7 +136,7 @@ public SelectWidget(String label,
       if (values == null)
          values = options;
       
-      if (!label.endsWith(":"))
+      if ((label != null) && !label.endsWith(":"))
          label = label + ":";
 
       listBox_ = new ListBox();

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/CodeBrowserType.java
Patch:
@@ -14,12 +14,13 @@
  */
 package org.rstudio.studio.client.common.filetypes;
 
-import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.StudioClientCommonConstants;
 
+import com.google.gwt.core.client.GWT;
+
 public class CodeBrowserType extends EditableFileType
 {
    public CodeBrowserType()
@@ -33,5 +34,6 @@ public void openFile(FileSystemItem file, EventBus eventBus)
    {
       assert false : "CodeBrowserType doesn't operate on filesystem files";
    }
+   
    private static final StudioClientCommonConstants constants_ = GWT.create(StudioClientCommonConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -3550,7 +3550,7 @@ public PrefValue<Boolean> copilotAllowAutomaticCompletions()
          "copilot_allow_automatic_completions",
          _constants.copilotAllowAutomaticCompletionsTitle(), 
          _constants.copilotAllowAutomaticCompletionsDescription(), 
-         false);
+         true);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -34,6 +34,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditor.EditorBehavior;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceCommandManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceFold;
+import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceGhostText;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Anchor;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.LineWidget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Marker;
@@ -486,6 +487,7 @@ void highlightDebugLocation(
    void toggleTokenInfo();
    void setTextInputAriaLabel(String label);
    
+   AceGhostText getGhostText();
    void setGhostText(String text);
    boolean hasGhostText();
    void removeGhostText();

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectPublishSource.java
Patch:
@@ -59,7 +59,8 @@ public RSConnectPublishSource(String sourceFile, String outputFile,
       isSingleFileShiny_ = false;
       websiteDir_ = websiteDir;
       isQuarto_ = isQuarto;
-      boolean isWebsite = type == RSConnect.CONTENT_TYPE_WEBSITE || type == RSConnect.CONTENT_TYPE_QUARTO_WEBSITE;
+      boolean isWebsite = type == RSConnect.CONTENT_TYPE_WEBSITE || type == RSConnect.CONTENT_TYPE_QUARTO_WEBSITE || (
+         type == RSConnect.CONTENT_TYPE_DOCUMENT && !StringUtil.isNullOrEmpty(websiteDir));
 
       String category = null;
       if (isWebsite)

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectPublishSource.java
Patch:
@@ -59,7 +59,8 @@ public RSConnectPublishSource(String sourceFile, String outputFile,
       isSingleFileShiny_ = false;
       websiteDir_ = websiteDir;
       isQuarto_ = isQuarto;
-      boolean isWebsite = type == RSConnect.CONTENT_TYPE_WEBSITE || type == RSConnect.CONTENT_TYPE_QUARTO_WEBSITE;
+      boolean isWebsite = type == RSConnect.CONTENT_TYPE_WEBSITE || type == RSConnect.CONTENT_TYPE_QUARTO_WEBSITE || (
+         type == RSConnect.CONTENT_TYPE_DOCUMENT && !StringUtil.isNullOrEmpty(websiteDir));
 
       String category = null;
       if (isWebsite)

File: src/gwt/src/org/rstudio/studio/client/workbench/copilot/Copilot.java
Patch:
@@ -325,7 +325,7 @@ public String messageForError(CopilotError error)
    {
       Integer code = error.code;
       
-      if (code == 1000)
+      if (code == CopilotConstants.ErrorCodes.NOT_SIGNED_IN)
       {
          return "Not signed in.";
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -766,8 +766,9 @@ public boolean previewKeyPress(char c)
          // Perform an auto-popup if a set number of R identifier characters
          // have been inserted (but only if the user has allowed it in prefs)
          boolean autoPopupEnabled =
-               userPrefs_.codeCompletion().getValue() == UserPrefs.CODE_COMPLETION_ALWAYS &&
-               userPrefs_.copilotEnabled().getValue() == false;
+               userPrefs_.codeCompletion().getValue() == UserPrefs.CODE_COMPLETION_ALWAYS && (
+                     behavior_ == EditorBehavior.AceBehaviorConsole ||
+                     userPrefs_.copilotEnabled().getValue() == false);
 
          if (!autoPopupEnabled)
             return false;

File: src/gwt/src/org/rstudio/core/client/widget/SelectWidget.java
Patch:
@@ -135,6 +135,9 @@ public SelectWidget(String label,
    {
       if (values == null)
          values = options;
+      
+      if (!label.endsWith(":"))
+         label = label + ":";
 
       listBox_ = new ListBox();
       listBox_.getElement().getStyle().setProperty("minHeight", "20px");

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishFilesPage.java
Patch:
@@ -68,7 +68,7 @@ public PublishFilesPage(String title, String subTitle, ImageResource icon,
                               input.getDescription(),
                               input.getContentType());
             }
-            contents_.setPublishSource(source, input.getContentType(), 
+            contents_.setPublishSource(source, input.getContentType(),
                   asMultiple, true, serverType);
          }
          else

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishFilesPage.java
Patch:
@@ -68,7 +68,7 @@ public PublishFilesPage(String title, String subTitle, ImageResource icon,
                               input.getDescription(),
                               input.getContentType());
             }
-            contents_.setPublishSource(source, input.getContentType(), 
+            contents_.setPublishSource(source, input.getContentType(),
                   asMultiple, true, serverType);
          }
          else

File: src/gwt/src/org/rstudio/studio/client/quarto/QuartoHelper.java
Patch:
@@ -26,7 +26,8 @@ public static boolean isQuartoWebsiteConfig(QuartoConfig config)
    {
       return config.is_project &&
             (config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_WEBSITE ||
-            config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_BOOK);
+            config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_BOOK ||
+            config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_MANUSCRIPT);
    }
    
    public static boolean isQuartoBookConfig(QuartoConfig config)

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoCommandConstants.java
Patch:
@@ -30,6 +30,7 @@ public class QuartoCommandConstants
    public final static String PROJECT_DEFAULT = "default";
    public final static String PROJECT_WEBSITE = "website";
    public final static String PROJECT_BOOK = "book";
+   public final static String PROJECT_MANUSCRIPT = "manuscript";
    
    public final static String PROJECT_WEBSITE_BLOG = "website:blog";
    

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -346,6 +346,7 @@ public final native boolean getIsDistillProject() /*-{
    
    public final static String QUARTO_PROJECT_TYPE_WEBSITE = "website";
    public final static String QUARTO_PROJECT_TYPE_BOOK = "book";
+   public final static String QUARTO_PROJECT_TYPE_MANUSCRIPT = "manuscript";
 
    
    public final native QuartoConfig getQuartoConfig() /*-{

File: src/gwt/src/org/rstudio/studio/client/common/vcs/GitServerOperations.java
Patch:
@@ -85,6 +85,7 @@ void gitCheckoutRemote(String branch,
    void gitCommit(String message,
                   boolean amend,
                   boolean signOff,
+                  boolean gpgSign,
                   ServerRequestCallback<ConsoleProcess> requestCallback);
 
    void gitDiffFile(String path,

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -2857,12 +2857,14 @@ public void gitCheckoutRemote(String branch,
    public void gitCommit(String message,
                          boolean amend,
                          boolean signOff,
+                         boolean gpgSign,
                          ServerRequestCallback<ConsoleProcess> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(message));
       params.set(1, JSONBoolean.getInstance(amend));
       params.set(2, JSONBoolean.getInstance(signOff));
+      params.set(3, JSONBoolean.getInstance(gpgSign));
       sendRequest(RPC_SCOPE, GIT_COMMIT, params,
                   new ConsoleProcessCallbackAdapter(requestCallback));
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/PrefsConstants.java
Patch:
@@ -2830,7 +2830,7 @@ public interface PrefsConstants extends com.google.gwt.i18n.client.Messages {
      * @return translated "Virtual Environment"
      */
     @DefaultMessage("Virtual Environment")
-    @Key("unknownType")
+    @Key("virtualEnvironmentType")
     String virtualEnvironmentType();
 
     /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/PrefsConstants.java
Patch:
@@ -2830,7 +2830,7 @@ public interface PrefsConstants extends com.google.gwt.i18n.client.Messages {
      * @return translated "Virtual Environment"
      */
     @DefaultMessage("Virtual Environment")
-    @Key("unknownType")
+    @Key("virtualEnvironmentType")
     String virtualEnvironmentType();
 
     /**

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -22,6 +22,7 @@
 import org.rstudio.core.client.URIUtilsTests;
 import org.rstudio.core.client.VirtualConsoleTests;
 import org.rstudio.core.client.dom.DomUtilsTests;
+import org.rstudio.studio.client.application.ApplicationUtilsTests;
 import org.rstudio.studio.client.application.model.SessionScopeTests;
 import org.rstudio.studio.client.common.r.RTokenizerTests;
 import org.rstudio.studio.client.workbench.views.jobs.model.JobManagerTests;
@@ -59,6 +60,7 @@ public static Test suite()
       suite.addTestSuite(ChunkContextUiTests.class);
       suite.addTestSuite(SafeHtmlUtilTests.class);
       suite.addTestSuite(TestMocks.class);
+      suite.addTestSuite(ApplicationUtilsTests.class);
 
       return suite;
    }

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -22,6 +22,7 @@
 import org.rstudio.core.client.URIUtilsTests;
 import org.rstudio.core.client.VirtualConsoleTests;
 import org.rstudio.core.client.dom.DomUtilsTests;
+import org.rstudio.studio.client.application.ApplicationUtilsTests;
 import org.rstudio.studio.client.application.model.SessionScopeTests;
 import org.rstudio.studio.client.common.r.RTokenizerTests;
 import org.rstudio.studio.client.workbench.views.jobs.model.JobManagerTests;
@@ -59,6 +60,7 @@ public static Test suite()
       suite.addTestSuite(ChunkContextUiTests.class);
       suite.addTestSuite(SafeHtmlUtilTests.class);
       suite.addTestSuite(TestMocks.class);
+      suite.addTestSuite(ApplicationUtilsTests.class);
 
       return suite;
    }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeployDialog.java
Patch:
@@ -108,7 +108,7 @@ public void onError(ServerError error)
       {
          // we know what the previous deployment settings are, so use them
          contents_.setPublishSource(source, contentType, 
-               fromPrevious.getAsMultiple(), fromPrevious.getAsStatic());
+               fromPrevious.getAsMultiple(), fromPrevious.getAsStatic(), null);
       }
       else
       {
@@ -117,7 +117,7 @@ public void onError(ServerError error)
          // an unambiguously single, non-static asset (such as a Shiny app or
          // an R Markdown document in its own directory)
          contents_.setPublishSource(source, contentType, 
-               false, false);
+               false, false, null);
       }
   
       contents_.setOnDeployDisabled(new Command()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -77,7 +77,8 @@ public PublishingPreferencesPane(GlobalDisplay globalDisplay,
       HorizontalPanel hpanel = new HorizontalPanel();
 
       String accountListLabel = constants_.accountListLabel();
-      accountList_ = new RSConnectAccountList(server, globalDisplay, true, true, true, accountListLabel);
+      // The preferences pane does not filter connected accounts
+      accountList_ = new RSConnectAccountList(server, globalDisplay, true, true, true, true, accountListLabel);
       accountList_.setHeight("150px");
       accountList_.setWidth("300px");
       accountList_.getElement().getStyle().setMarginBottom(15, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -1298,7 +1298,6 @@ public void onError(ServerError error)
 
    public final static String SHINY_APPS_SERVICE_NAME = "ShinyApps.io";
 
-   // will need to be updated to posit.cloud
    public final static String CLOUD_SERVICE_NAME = "posit.cloud";
 
    // No/unknown content type

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishFilesPage.java
Patch:
@@ -48,7 +48,7 @@ public PublishFilesPage(String title, String subTitle, ImageResource icon,
                               input.getOriginatingEvent().getFromPreview(),
                               input.getWebsiteDir(),
                               input.isSelfContained(),
-                              asStatic,
+                              true,
                               input.isShiny(),
                               input.getDescription());
             }
@@ -60,7 +60,7 @@ public PublishFilesPage(String title, String subTitle, ImageResource icon,
                               input.getWebsiteDir(),
                               input.getWebsiteOutputDir(),
                               input.isSelfContained(),
-                              asStatic,
+                              true,
                               input.isShiny(),
                               input.isQuarto(),
                               input.getDescription(),
@@ -78,7 +78,7 @@ public PublishFilesPage(String title, String subTitle, ImageResource icon,
                      input.getSourceRmd().getPath(),
                   input.getWebsiteDir(),
                   input.isSelfContained(),
-                  asStatic,
+                  false,
                   input.isShiny(),
                   input.isQuarto(),
                   input.getDescription(),

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishMultiplePage.java
Patch:
@@ -69,11 +69,11 @@ else if (input.isStaticDocInput())
          pages.add(new PublishReportSourcePage(singleTitle, singleSubtitle,
                constants_.publishToRstudioConnect(),
                new ImageResource2x(
-                  RSConnectResources.INSTANCE.publishSingleRmd2x()), input, false));
+                  RSConnectResources.INSTANCE.publishSingleRmd2x()), input, false, true));
          pages.add(new PublishReportSourcePage(multipleTitle, multipleSubtitle,
                constants_.publishToRstudioConnect(),
                new ImageResource2x(
-                  RSConnectResources.INSTANCE.publishMultipleRmd2x()), input, true));
+                  RSConnectResources.INSTANCE.publishMultipleRmd2x()), input, true, true));
       }
       return pages;
    }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RsconnectConstants.java
Patch:
@@ -809,11 +809,11 @@ public interface RsconnectConstants extends com.google.gwt.i18n.client.Messages{
     String publishReportSourcePageSubTitle(String scheduledReportNumber, String descriptor);
 
     /**
-     * Translated "Choose this option if you want to rebuild your {0} on the server.".
+     * Translated "Choose this option if you want to create or rebuild your {0} on the server.".
      *
-     * @return translated "Choose this option if you want to rebuild your {0} on the server."
+     * @return translated "Choose this option if you want to create or rebuild your {0} on the server."
      */
-    @DefaultMessage("Choose this option if you want to rebuild your {0} on the server.")
+    @DefaultMessage("Choose this option if you want to create or rebuild your {0} on the server.")
     @Key("publishReportNoScheduledSourcePageSubtitle")
     String publishReportNoScheduledSourcePageSubtitle(String descriptor);
 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishFilesPage.java
Patch:
@@ -48,7 +48,7 @@ public PublishFilesPage(String title, String subTitle, ImageResource icon,
                               input.getOriginatingEvent().getFromPreview(),
                               input.getWebsiteDir(),
                               input.isSelfContained(),
-                              asStatic,
+                              true,
                               input.isShiny(),
                               input.getDescription());
             }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishWizard.java
Patch:
@@ -48,7 +48,7 @@ else if (input.isWebsiteRmd() || !input.isMultiRmd() &&
          // or because the doc is not self-contained, or is a website
          return new PublishReportSourcePage(constants_.publish(), constants_.publish(),
                constants_.publishToRstudioConnect(),null, input,
-               false);
+               false, true);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -171,6 +171,7 @@ private void addColumnControls(Toolbar toolbar)
          if (i == 1)
          {
             columnTextWidget_ = new DataTableColumnWidget(this::setOffsetAndMaxColumns);
+            columnTextWidget_.getElement().setId("data-viewer-column-input");
             columnTextWidget_.setVisible(false);
             toolbar.addLeftWidget(columnTextWidget_);
          }

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -171,6 +171,7 @@ private void addColumnControls(Toolbar toolbar)
          if (i == 1)
          {
             columnTextWidget_ = new DataTableColumnWidget(this::setOffsetAndMaxColumns);
+            columnTextWidget_.getElement().setId("data-viewer-column-input");
             columnTextWidget_.setVisible(false);
             toolbar.addLeftWidget(columnTextWidget_);
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -112,7 +112,7 @@ public final native double getZoomLevel() /*-{
       }-*/;
 
       public final native JavaScriptObject getWindowBounds() /*-{
-         return this && this.windowBounds || {"width":1200,"height":900,"x":0,"y":0};
+         return this && this.windowBounds || {"width":1200,"height":900,"x":0,"y":0,"maximized":false};
       }-*/;
 
       public final native boolean getAccessibility() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessorConstants.java
Patch:
@@ -1,4 +1,5 @@
-/* UserStateAccessorConstants.java
+/*
+ * UserStateAccessorConstants.java
  *
  * Copyright (C) 2022 by Posit Software, PBC
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/model/AceAnnotation.java
Patch:
@@ -31,6 +31,7 @@ public static native AceAnnotation create(int row,
          column: column,
          type: type
       };
+      
       if (html) 
          aceAnnotation.html = html;
       else

File: src/gwt/tools/prefs/UserStateAccessorConstants.java
Patch:
@@ -1,4 +1,5 @@
-/* UserStateAccessorConstants.java
+/*
+ * UserStateAccessorConstants.java
  *
  * Copyright (C) 2022 by Posit Software, PBC
  *

File: src/gwt/src/org/rstudio/core/client/widget/ShortcutInfoPanel.java
Patch:
@@ -103,6 +103,7 @@ protected Widget getShortcutContent()
             sb.appendHtmlConstant("</h2><table>");
             for (ShortcutInfo info : shortcuts) {
                if (info.getDescription() == null ||
+                       info.getShortcuts() == null ||
                        info.getShortcuts().isEmpty() ||
                        !info.getGroupName().equals(groupNames[i][j])) {
                   continue;

File: src/gwt/src/org/rstudio/core/client/widget/ShortcutInfoPanel.java
Patch:
@@ -103,6 +103,7 @@ protected Widget getShortcutContent()
             sb.appendHtmlConstant("</h2><table>");
             for (ShortcutInfo info : shortcuts) {
                if (info.getDescription() == null ||
+                       info.getShortcuts() == null ||
                        info.getShortcuts().isEmpty() ||
                        !info.getGroupName().equals(groupNames[i][j])) {
                   continue;

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcError.java
Patch:
@@ -69,6 +69,9 @@ protected RpcError()
      
    // transmission error (application state indeterminate)
    public final static int TRANSMISSION_ERROR = 200;
+
+   // Unimplemented redirection request
+   public final static int REDIRECTION_ERROR = 300;
    
    public final native int getCode() /*-{
       return this.code;

File: src/gwt/src/org/rstudio/studio/client/application/AriaLiveService.java
Patch:
@@ -51,7 +51,6 @@ public class AriaLiveService
    public static final String TAB_KEY_MODE = "tab_key_mode";
    public static final String TOOLBAR_VISIBILITY = "toolbar_visibility";
    public static final String WARNING_BAR = "warning_bar";
-   public static final String SESSION_SUSPENDED = "session_suspended";
 
    // Announcement requested by a user, not controlled by a preference since it is on-demand.
    // Do not include in the announcements_ map.
@@ -84,7 +83,6 @@ public AriaLiveService(EventBus eventBus, Provider<UserPrefs> pUserPrefs)
       announcements_.put(TAB_KEY_MODE, constants_.tabKeyFocusAnnouncement());
       announcements_.put(TOOLBAR_VISIBILITY, constants_.toolBarVisibilityAnnouncement());
       announcements_.put(WARNING_BAR, constants_.warningBarsAnnouncement());
-      announcements_.put(SESSION_SUSPENDED, constants_.sessionSuspendAnnouncement());
 
       alwaysEnabledAnnouncements_ = new HashSet<>();
       alwaysEnabledAnnouncements_.add(ON_DEMAND);

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -91,6 +91,9 @@ void prepareForNamedWindow(String name, boolean allowExternalNavigation,
    
    void copyPageRegionToClipboard(int left, int top, int width, int height,
                                   Command onCopied);
+
+   void copyImageAtXYToClipboard(int absoluteLeft, int absoluteTop,
+                                 Command completed);
    
    void exportPageRegionToFile(String targetPath, 
                                String format, 

File: src/gwt/src/org/rstudio/studio/client/application/DesktopHooks.java
Patch:
@@ -34,7 +34,7 @@
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.LauncherServerEvent;
-import org.rstudio.studio.client.application.events.MouseNavigateEvent;
+import org.rstudio.studio.client.application.events.DesktopMouseNavigateEvent;
 import org.rstudio.studio.client.application.events.SaveActionChangedEvent;
 import org.rstudio.studio.client.application.events.SuicideEvent;
 import org.rstudio.studio.client.application.model.ProductEditionInfo;
@@ -257,7 +257,7 @@ void onLauncherServerEvent(String eventType, String details)
 
    void mouseNavigateButtonClick(boolean forward, int x, int y)
    {
-      events_.fireEvent(new MouseNavigateEvent(forward, x, y));
+      events_.fireEvent(new DesktopMouseNavigateEvent(forward, x, y));
    }
    
    void onDragStart()

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -247,7 +247,7 @@ public class FileTypeRegistry
                false, false, false, false, false, false, false, false);
 
    public static final TextFileType JULIA =
-         new TextFileType("julia", "Julia", EditorLanguage.LANG_JULIA, ".julia", new ImageResource2x(ICONS.iconJulia2x()),
+         new TextFileType("julia", "Julia", EditorLanguage.LANG_JULIA, ".jl", new ImageResource2x(ICONS.iconJulia2x()),
                false, false, false, false, false,
                false, false, false, false, false, false, false, false);
 
@@ -411,6 +411,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.cpp", CPP, new ImageResource2x(icons.iconCpp2x()));
       register("*.cc", CPP, new ImageResource2x(icons.iconCpp2x()));
       register("*.h", H, new ImageResource2x(icons.iconH2x()));
+      register("*.hh", HPP, new ImageResource2x(icons.iconHpp2x()));
       register("*.hpp", HPP, new ImageResource2x(icons.iconHpp2x()));
       register("*.f", TEXT, new ImageResource2x(icons.iconText2x()));
       register("*.Rout.save", TEXT, new ImageResource2x(icons.iconText2x()));
@@ -446,6 +447,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.haxe", HAXE, new ImageResource2x(icons.iconHaxe2x()));
       register("*.java", JAVA, new ImageResource2x(icons.iconJava2x()));
       register("*.julia", JULIA, new ImageResource2x(icons.iconJulia2x()));
+      register("*.jl", JULIA, new ImageResource2x(icons.iconJulia2x()));
       register("*.lisp", LISP, new ImageResource2x(icons.iconLisp2x()));
       register(".emacs", LISP, new ImageResource2x(icons.iconLisp2x()));
       register("*.el", LISP, new ImageResource2x(icons.iconLisp2x()));

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWriterReferencesOptions.java
Patch:
@@ -23,4 +23,5 @@ public class PanmirrorWriterReferencesOptions
 {    
    public String location;
    public String prefix;
+   public Boolean links;
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorCommands.java
Patch:
@@ -120,6 +120,8 @@ public class PanmirrorCommands
    public static final String BashCodeChunk = "5FBB7283-E8AB-450C-9359-A4658CBCD136";
    public static final String D3CodeChunk = "C73CA46C-B56F-40B6-AEFA-DDBB30CA8C08";
    public static final String PythonCodeChunk = "42A7A138-421A-4DCF-8A88-FE2F8EC5B8F6";
+
+   public static final String JuliaCodeChunk = "84386434-EE31-4F0D-BBE9-55F5199FAF04";
    public static final String RcppCodeChunk = "6BD2810B-6B20-4358-8AA4-74BBFFC92AC3";
    public static final String SQLCodeChunk = "41D61FD2-B56B-48A7-99BC-2F60BC0D9F78";
    public static final String StanCodeChunk = "65D33344-CBE9-438C-B337-A538F8D7FCE5";

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarCommands.java
Patch:
@@ -83,6 +83,7 @@ public PanmirrorToolbarCommands(PanmirrorCommand[] commands)
       add(PanmirrorCommands.BashCodeChunk, "Bash");
       add(PanmirrorCommands.D3CodeChunk, "D3");
       add(PanmirrorCommands.PythonCodeChunk, "Python");
+      add(PanmirrorCommands.JuliaCodeChunk, "Julia");
       add(PanmirrorCommands.RcppCodeChunk, "Rcpp");
       add(PanmirrorCommands.SQLCodeChunk, "SQL");
       add(PanmirrorCommands.StanCodeChunk, "Stan");

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorZoteroServer.java
Patch:
@@ -59,7 +59,7 @@ public Promise<JavaScriptObject> getCollections(String file, JsArrayString colle
       return new Promise<>(
             (ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
                server_.zoteroGetCollections(file, collections, cached, useCache,
-                     new PromiseServerRequestCallback<>(resolve, reject, constants_.loadingCollectionsProgressText(), 2000));
+                     new PromiseServerRequestCallback<>(resolve, reject));
             });
    }
 
@@ -77,7 +77,7 @@ public Promise<JavaScriptObject> getActiveCollectionSpecs(String file, JsArraySt
       return new Promise<>(
             (ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
                server_.zoteroGetActiveCollectionSpecs(file, collections,
-                  new PromiseServerRequestCallback<>(resolve, reject, constants_.readingCollectionsProgressText(), 2000));
+                  new PromiseServerRequestCallback<>(resolve, reject));
             });
    }
    

File: src/gwt/src/org/rstudio/studio/client/panmirror/uitools/PanmirrorPandocFormatConfig.java
Patch:
@@ -34,6 +34,7 @@ public class PanmirrorPandocFormatConfig
    public String wrap;
    public String references_location;
    public String references_prefix;
+   public Boolean references_links;
    public boolean canonical;
    
  
@@ -61,7 +62,8 @@ public static boolean markdownWritingConfigEqual(PanmirrorPandocFormatConfig a,
    {
       return StringUtil.equals(a.wrap, b.wrap) &&
              a.references_location == b.references_location &&
-             a.references_prefix == b.references_prefix;         
+             a.references_prefix == b.references_prefix &&
+              a.references_links == b.references_links;
    }
 }
 

File: src/gwt/src/org/rstudio/studio/client/server/ServerError.java
Patch:
@@ -42,6 +42,9 @@ public interface ServerError
    
    // errors indicating the license usage limit has been reached
    public static final int LICENSE_USAGE_LIMIT = 7;
+
+   // errors indicating the license usage limit has been reached
+   public static final int REDIRECT_ERROR = 300;
  
    // error type
    int getCode();

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerError.java
Patch:
@@ -122,6 +122,8 @@ private int codeFromRpcErrorCode(int code)
       case RpcError.MAX_SESSIONS_REACHED:
       case RpcError.MAX_USERS_REACHED:
          return ServerError.LICENSE_USAGE_LIMIT;
+      case RpcError.REDIRECTION_ERROR:
+         return ServerError.REDIRECT_ERROR;
                
       default:
          return ServerError.SUCCESS;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleInterpreterVersion.java
Patch:
@@ -116,7 +116,8 @@ private HTML createLogo(TextResource resource,
       html.getElement().getStyle().setDisplay(Display.INLINE_BLOCK);
       
       Element svg = html.getElement().getFirstChildElement();
-      
+      svg.setAttribute("role", "presentation");
+
       // NOTE: GWT chokes when modifying the className
       // attribute of an SVG element so we do it "by hand" here
       addClassName(svg, RES.styles().icon());

File: src/gwt/src/org/rstudio/studio/client/application/DesktopHooks.java
Patch:
@@ -34,7 +34,7 @@
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.LauncherServerEvent;
-import org.rstudio.studio.client.application.events.MouseNavigateEvent;
+import org.rstudio.studio.client.application.events.DesktopMouseNavigateEvent;
 import org.rstudio.studio.client.application.events.SaveActionChangedEvent;
 import org.rstudio.studio.client.application.events.SuicideEvent;
 import org.rstudio.studio.client.application.model.ProductEditionInfo;
@@ -257,7 +257,7 @@ void onLauncherServerEvent(String eventType, String details)
 
    void mouseNavigateButtonClick(boolean forward, int x, int y)
    {
-      events_.fireEvent(new MouseNavigateEvent(forward, x, y));
+      events_.fireEvent(new DesktopMouseNavigateEvent(forward, x, y));
    }
    
    void onDragStart()

File: src/gwt/src/org/rstudio/studio/client/application/AriaLiveService.java
Patch:
@@ -51,7 +51,6 @@ public class AriaLiveService
    public static final String TAB_KEY_MODE = "tab_key_mode";
    public static final String TOOLBAR_VISIBILITY = "toolbar_visibility";
    public static final String WARNING_BAR = "warning_bar";
-   public static final String SESSION_SUSPENDED = "session_suspended";
 
    // Announcement requested by a user, not controlled by a preference since it is on-demand.
    // Do not include in the announcements_ map.
@@ -84,7 +83,6 @@ public AriaLiveService(EventBus eventBus, Provider<UserPrefs> pUserPrefs)
       announcements_.put(TAB_KEY_MODE, constants_.tabKeyFocusAnnouncement());
       announcements_.put(TOOLBAR_VISIBILITY, constants_.toolBarVisibilityAnnouncement());
       announcements_.put(WARNING_BAR, constants_.warningBarsAnnouncement());
-      announcements_.put(SESSION_SUSPENDED, constants_.sessionSuspendAnnouncement());
 
       alwaysEnabledAnnouncements_ = new HashSet<>();
       alwaysEnabledAnnouncements_.add(ON_DEMAND);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleInterpreterVersion.java
Patch:
@@ -116,7 +116,8 @@ private HTML createLogo(TextResource resource,
       html.getElement().getStyle().setDisplay(Display.INLINE_BLOCK);
       
       Element svg = html.getElement().getFirstChildElement();
-      
+      svg.setAttribute("role", "presentation");
+
       // NOTE: GWT chokes when modifying the className
       // attribute of an SVG element so we do it "by hand" here
       addClassName(svg, RES.styles().icon());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleInterpreterVersion.java
Patch:
@@ -116,7 +116,8 @@ private HTML createLogo(TextResource resource,
       html.getElement().getStyle().setDisplay(Display.INLINE_BLOCK);
       
       Element svg = html.getElement().getFirstChildElement();
-      
+      svg.setAttribute("role", "presentation");
+
       // NOTE: GWT chokes when modifying the className
       // attribute of an SVG element so we do it "by hand" here
       addClassName(svg, RES.styles().icon());

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -91,6 +91,9 @@ void prepareForNamedWindow(String name, boolean allowExternalNavigation,
    
    void copyPageRegionToClipboard(int left, int top, int width, int height,
                                   Command onCopied);
+
+   void copyImageAtXYToClipboard(int absoluteLeft, int absoluteTop,
+                                 Command completed);
    
    void exportPageRegionToFile(String targetPath, 
                                String format, 

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorCommands.java
Patch:
@@ -123,6 +123,8 @@ public class PanmirrorCommands
    public static final String RcppCodeChunk = "6BD2810B-6B20-4358-8AA4-74BBFFC92AC3";
    public static final String SQLCodeChunk = "41D61FD2-B56B-48A7-99BC-2F60BC0D9F78";
    public static final String StanCodeChunk = "65D33344-CBE9-438C-B337-A538F8D7FCE5";
+   public static final String MermaidCodeChunk = "FCA99491-2FCA-44BC-8349-A9AE2AE940DE";
+   public static final String GraphVizCodeChunk = "29970A38-2921-4F32-8363-F78CFE3FEBB4";
    public static final String ExpandAllChunks = "B217913B-67C9-457F-B766-7FCCB502F611";
    public static final String CollapseAllChunks = "9907A864-D707-4410-93A4-07871A8C43A6";
    public static final String ExpandChunk = "0226518C-559A-4BFC-A5BD-244BEE8175AA";

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarCommands.java
Patch:
@@ -86,6 +86,8 @@ public PanmirrorToolbarCommands(PanmirrorCommand[] commands)
       add(PanmirrorCommands.RcppCodeChunk, "Rcpp");
       add(PanmirrorCommands.SQLCodeChunk, "SQL");
       add(PanmirrorCommands.StanCodeChunk, "Stan");
+      add(PanmirrorCommands.MermaidCodeChunk, "Mermaid");
+      add(PanmirrorCommands.GraphVizCodeChunk, "GraphViz");
       add(PanmirrorCommands.ExpandChunk, constants_.expandChunkMenuText(), false);
       add(PanmirrorCommands.CollapseChunk, constants_.collapseChunkMenuText(), false);
       add(PanmirrorCommands.ExpandAllChunks, constants_.expandAllChunksMenuText(), false);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1800,7 +1800,7 @@ public PrefValue<Boolean> enableCloudPublishUi()
          "enable_cloud_publish_ui",
          _constants.enableCloudPublishUiTitle(), 
          _constants.enableCloudPublishUiDescription(), 
-         false);
+         true);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -187,8 +187,8 @@ private CompletionResult narrow(final String token,
          public int compare(QualifiedName lhs, QualifiedName rhs)
          {
             // compare completion type first
-            int lhsTypeScore = RCompletionType.score(lhs.type);
-            int rhsTypeScore = RCompletionType.score(rhs.type);
+            int lhsTypeScore = RCompletionType.score(lhs.type, lhs.context);
+            int rhsTypeScore = RCompletionType.score(rhs.type, rhs.context);
             if (lhsTypeScore < rhsTypeScore)
                return -1;
             else if (lhsTypeScore > rhsTypeScore)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/LintMarkers.java
Patch:
@@ -40,6 +40,7 @@ public AceAnnotation asAceAnnotation()
          return AceAnnotation.create(
                anchor_.getRow(),
                anchor_.getColumn(),
+               annotation_.html(),
                annotation_.text(),
                annotation_.type());
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -1038,6 +1038,7 @@ public AceAnnotation asAceAnnotation()
          return AceAnnotation.create(
                anchor_.getRow(),
                anchor_.getColumn(),
+               annotation_.html(),
                annotation_.text(),
                annotation_.type());
       }

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcError.java
Patch:
@@ -69,6 +69,9 @@ protected RpcError()
      
    // transmission error (application state indeterminate)
    public final static int TRANSMISSION_ERROR = 200;
+
+   // Unimplemented redirection request
+   public final static int REDIRECTION_ERROR = 300;
    
    public final native int getCode() /*-{
       return this.code;

File: src/gwt/src/org/rstudio/studio/client/server/ServerError.java
Patch:
@@ -42,6 +42,9 @@ public interface ServerError
    
    // errors indicating the license usage limit has been reached
    public static final int LICENSE_USAGE_LIMIT = 7;
+
+   // errors indicating the license usage limit has been reached
+   public static final int REDIRECT_ERROR = 300;
  
    // error type
    int getCode();

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerError.java
Patch:
@@ -122,6 +122,8 @@ private int codeFromRpcErrorCode(int code)
       case RpcError.MAX_SESSIONS_REACHED:
       case RpcError.MAX_USERS_REACHED:
          return ServerError.LICENSE_USAGE_LIMIT;
+      case RpcError.REDIRECTION_ERROR:
+         return ServerError.REDIRECT_ERROR;
                
       default:
          return ServerError.SUCCESS;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1800,7 +1800,7 @@ public PrefValue<Boolean> enableCloudPublishUi()
          "enable_cloud_publish_ui",
          _constants.enableCloudPublishUiTitle(), 
          _constants.enableCloudPublishUiDescription(), 
-         false);
+         true);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1800,7 +1800,7 @@ public PrefValue<Boolean> enableCloudPublishUi()
          "enable_cloud_publish_ui",
          _constants.enableCloudPublishUiTitle(), 
          _constants.enableCloudPublishUiDescription(), 
-         false);
+         true);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -1001,7 +1001,7 @@ private void doAddDisplayNameGeneric(SafeHtmlBuilder sb)
             SafeHtmlUtil.appendSpan(
                sb,
                style,
-               display.replaceFirst("[ \\n].*", ""));
+               display.split("\n")[0].replaceFirst(" .*", ""));
          }
          else 
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HelpInfoPopupPanelResources.java
Patch:
@@ -30,6 +30,7 @@ public static interface Styles extends CssResource
       String snippetText();
       String roxygenText();
       String roxygenTitle();
+      String roxygenSnippet();
    }
   
    @Source("HelpInfoPopupPanel.css")

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -1402,7 +1402,7 @@ public void suggestTopics(String prefix,
 
    public void getHelp(String topic,
                        String packageName,
-                       int options,
+                       int type,
                        ServerRequestCallback<HelpInfo> requestCallback)
    {
       JSONArray params = new JSONArray();
@@ -1411,7 +1411,7 @@ public void getHelp(String topic,
          params.set(1, new JSONString(packageName));
       else
          params.set(1, JSONNull.getInstance());
-      params.set(2, new JSONNumber(options));
+      params.set(2, new JSONNumber(type));
 
       sendRequest(RPC_SCOPE, GET_HELP, params, requestCallback);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionList.java
Patch:
@@ -105,7 +105,7 @@ public CompletionList(TItem[] items,
       scrollPanel_ = new ScrollPanel();
       scrollPanel_.getElement().getStyle().setProperty("overflowX", "hidden");
       scrollPanel_.add(grid);
-      scrollPanel_.setHeight((visibleItems * 26) + "px");
+      scrollPanel_.setHeight((visibleItems * 22) + "px");
 
       initWidget(scrollPanel_);
       grid_ = grid;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionPopupDisplay.java
Patch:
@@ -67,7 +67,6 @@ void showCompletionValues(QualifiedName[] results,
    void displayHelp(HelpInfo.ParsedInfo help);
    void displayParameterHelp(Map<String, String> map, String parameter);
    void displayPackageHelp(HelpInfo.ParsedInfo helpInfo);
-   void displayDataHelp(HelpInfo.ParsedInfo helpInfo);
    void displaySnippetHelp(String contents);
    void displayRoxygenHelp(String title, String description, boolean hasVignette);
    void displayYAMLHelp(String value, String description);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -1016,7 +1016,9 @@ private void doAddDisplayNameGeneric(SafeHtmlBuilder sb)
          // isn't a package but rather some custom DollarNames scope)
          if ((RCompletionType.isFunctionType(type) ||
              type == RCompletionType.SNIPPET ||
-             type == RCompletionType.DATASET) &&
+             type == RCompletionType.DATASET ||
+             type == RCompletionType.DATAFRAME
+             ) &&
              helpHandler == null)
          {
             SafeHtmlUtil.appendSpan(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HelpInfoPopupPanelResources.java
Patch:
@@ -26,11 +26,11 @@ public static interface Styles extends CssResource
       String helpPopup();
       String helpTitleText();
       String helpBodyText();
+      String helpGlimpseText();
       String snippetText();
       String roxygenText();
       String roxygenTitle();
    }
-
   
    @Source("HelpInfoPopupPanel.css")
    Styles styles();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/model/HelpServerOperations.java
Patch:
@@ -24,7 +24,7 @@ void suggestTopics(String prefix,
 
    void getHelp(String topic, 
                 String packageName,
-                int options,
+                int type,
                 ServerRequestCallback<HelpInfo> requestCallback);
    
    String getApplicationURL(String topicURI);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -1044,6 +1044,7 @@ public void showDataItem(DataItem data)
             @Override
             public void onResponseReceived(SourceDocument response)
             {
+               
                getActive().addTab(response, Source.OPEN_INTERACTIVE);
             }
          });

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleResources.java
Patch:
@@ -28,6 +28,7 @@ public interface ConsoleResources extends ClientBundle
    public interface ConsoleStyles extends CssResource
    {
       String console();
+      String warning();
       String input();
       String prompt();
       String output();

File: src/gwt/src/org/rstudio/studio/client/common/codetools/Completions.java
Patch:
@@ -172,5 +172,4 @@ public final native String getLanguage() /*-{
       return this.language;
    }-*/;
    
-   
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HelpStrategy.java
Patch:
@@ -78,6 +78,7 @@ public void showHelp(final QualifiedName item,
             showRoxygenHelp(item, display);
             break;
          case RCompletionType.ARGUMENT:
+         case RCompletionType.SECUNDARY_ARGUMENT:
          case RCompletionType.OPTION:
             showParameterHelp(item, display);
             break;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1942,6 +1942,7 @@ private String quoteIfNotSyntacticNameCompletion(QualifiedName name)
          if (type == RCompletionType.ROXYGEN ||
              type == RCompletionType.PACKAGE ||
              type == RCompletionType.ARGUMENT ||
+             type == RCompletionType.SECUNDARY_ARGUMENT ||
              type == RCompletionType.OPTION ||
              type == RCompletionType.CONTEXT ||
              type == RCompletionType.KEYWORD)

File: src/gwt/src/org/rstudio/studio/client/common/codetools/RCompletionType.java
Patch:
@@ -45,6 +45,7 @@ public class RCompletionType
    public static final int YAML_VALUE  = 26;
    public static final int COLUMN      = 27;
    public static final int R6_OBJECT   = 28;
+   public static final int DATATABLE_SPECIAL_SYMBOL = 29;
    
    public static final int SNIPPET     = 98;
    public static final int CONTEXT     = 99;

File: src/gwt/src/org/rstudio/studio/client/common/icons/code/CodeIcons.java
Patch:
@@ -114,4 +114,7 @@ public interface CodeIcons extends ClientBundle
 
    @Source("column_2x.png")
    ImageResource column2x();
+
+   @Source("datatable_special_symbol_2x.png")
+   ImageResource datatableSpecialSymbol2x();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1878,6 +1878,7 @@ public void onResponseReceived(CompletionResult completions)
 
          if (results.length == 1
                && canAutoAccept_
+               && completions.canAutoAccept()
                && results[0].type != RCompletionType.DIRECTORY)
          {
             onSelection(results[0]);

File: src/gwt/src/org/rstudio/studio/client/common/codetools/CodeToolsServerOperations.java
Patch:
@@ -122,5 +122,5 @@ void sqlGetCompletions(
          String connection,
          SqlCompletionParseContext context,
          ServerRequestCallback<Completions> requestCallback);
-   
+
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -6929,7 +6929,7 @@ public void recordCommandExecution(String commandId,
    private static final String STAN_RUN_DIAGNOSTICS = "stan_run_diagnostics";
 
    private static final String SQL_GET_COMPLETIONS = "sql_get_completions";
-
+   
    private static final String GET_CPP_CAPABILITIES = "get_cpp_capabilities";
    private static final String INSTALL_BUILD_TOOLS = "install_build_tools";
    private static final String START_BUILD = "start_build";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionPopupDisplay.java
Patch:
@@ -69,6 +69,7 @@ void showCompletionValues(QualifiedName[] results,
    void displayPackageHelp(HelpInfo.ParsedInfo helpInfo);
    void displayDataHelp(HelpInfo.ParsedInfo helpInfo);
    void displaySnippetHelp(String contents);
+   void displayRoxygenHelp(String title, String description, boolean hasVignette);
    void displayYAMLHelp(String value, String description);
    /**
     * Clear out the current help info

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HelpInfoPopupPanelResources.java
Patch:
@@ -27,6 +27,8 @@ public static interface Styles extends CssResource
       String helpTitleText();
       String helpBodyText();
       String snippetText();
+      String roxygenText();
+      String roxygenTitle();
    }
 
   

File: src/gwt/src/org/rstudio/studio/client/common/codetools/RCompletionType.java
Patch:
@@ -44,6 +44,8 @@ public class RCompletionType
    public static final int YAML_KEY    = 25;
    public static final int YAML_VALUE  = 26;
    public static final int COLUMN      = 27;
+   public static final int R6_OBJECT   = 28;
+   
    public static final int SNIPPET     = 98;
    public static final int CONTEXT     = 99;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -1042,6 +1042,7 @@ private ImageResource getIcon()
          case RCompletionType.S4_OBJECT:
          case RCompletionType.R5_CLASS:
          case RCompletionType.R5_OBJECT:
+         case RCompletionType.R6_OBJECT:
             return new ImageResource2x(ICONS.clazz2x());
          case RCompletionType.FILE:
             return getIconForFilename(name);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/model/LintItem.java
Patch:
@@ -36,6 +36,7 @@ public static final native LintItem create(int startRow,
          "end.row": endRow,
          "end.column": endColumn,
          "text": text,
+         "raw": text,
          "type": type
       };
                                 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -198,7 +198,7 @@ public RSConnectDeploy(RSConnectPublishSource source,
          userPrefs_.enableCloudPublishUi().getGlobalValue();
       
       // Invoke the "add account" wizard if either Shiny app or Connect enabled
-      if (contentType == RSConnect.CONTENT_TYPE_APP || rsConnectEnabled)
+      if (contentType == RSConnect.CONTENT_TYPE_APP || rsConnectEnabled || positCloudEnabled)
       {
          addAccountAnchor_.setClickHandler(() ->
          {
@@ -230,7 +230,7 @@ else if (positCloudEnabled) // also invoke if Connect disabled but Cloud enabled
                });
          });
       }
-      {
+      else {
          // if not deploying a Shiny app and RSConnect UI/ Posit Cloud UI are not enabled, then
          // there's no account we can add suitable for this content
          addAccountAnchor_.setVisible(false);
@@ -806,7 +806,7 @@ private void populateAccountList(final ProgressIndicator indicator,
       if (numAccounts == 0 && !isRetry)
       {
          connector_.showAccountWizard(accounts.length() == 0, 
-               source_.isShiny(),
+               source_.isShiny() || userPrefs_.enableCloudPublishUi().getGlobalValue(),
                new OperationWithInput<Boolean>() 
          {
             @Override

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -198,7 +198,7 @@ public RSConnectDeploy(RSConnectPublishSource source,
          userPrefs_.enableCloudPublishUi().getGlobalValue();
       
       // Invoke the "add account" wizard if either Shiny app or Connect enabled
-      if (contentType == RSConnect.CONTENT_TYPE_APP || rsConnectEnabled)
+      if (contentType == RSConnect.CONTENT_TYPE_APP || rsConnectEnabled || positCloudEnabled)
       {
          addAccountAnchor_.setClickHandler(() ->
          {
@@ -230,7 +230,7 @@ else if (positCloudEnabled) // also invoke if Connect disabled but Cloud enabled
                });
          });
       }
-      {
+      else {
          // if not deploying a Shiny app and RSConnect UI/ Posit Cloud UI are not enabled, then
          // there's no account we can add suitable for this content
          addAccountAnchor_.setVisible(false);
@@ -806,7 +806,7 @@ private void populateAccountList(final ProgressIndicator indicator,
       if (numAccounts == 0 && !isRetry)
       {
          connector_.showAccountWizard(accounts.length() == 0, 
-               source_.isShiny(),
+               source_.isShiny() || userPrefs_.enableCloudPublishUi().getGlobalValue(),
                new OperationWithInput<Boolean>() 
          {
             @Override

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSAccountConnector.java
Patch:
@@ -181,14 +181,14 @@ public void onRsconnectManageAccounts()
    @Override
    public void onEnableRStudioConnectUI(EnableRStudioConnectUIEvent event)
    {
-      pUserState_.get().enableRsconnectPublishUi().setGlobalValue(event.getConnectEnable());
+      pUserState_.get().enableRsconnectPublishUi().setGlobalValue(event.getEnable());
       pUserState_.get().writeState();
    }
 
    @Override
    public void onEnablePositCloudUI(EnableRStudioConnectUIEvent event)
    {
-      pUserState_.get().enableCloudPublishUi().setGlobalValue(event.getCloudEnable());
+      pUserState_.get().enableCloudPublishUi().setGlobalValue(event.getEnable());
       pUserState_.get().writeState();
    }
 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSAccountConnector.java
Patch:
@@ -181,14 +181,14 @@ public void onRsconnectManageAccounts()
    @Override
    public void onEnableRStudioConnectUI(EnableRStudioConnectUIEvent event)
    {
-      pUserState_.get().enableRsconnectPublishUi().setGlobalValue(event.getEnable());
+      pUserState_.get().enableRsconnectPublishUi().setGlobalValue(event.getConnectEnable());
       pUserState_.get().writeState();
    }
 
    @Override
    public void onEnablePositCloudUI(EnableRStudioConnectUIEvent event)
    {
-      pUserState_.get().enableCloudPublishUi().setGlobalValue(event.getEnable());
+      pUserState_.get().enableCloudPublishUi().setGlobalValue(event.getCloudEnable());
       pUserState_.get().writeState();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -108,7 +108,7 @@ public void showConsoleOutput(JsArray<JsArrayEx> output)
       
       // track number of newlines in output
       int newlineCount = 0;
-      int maxCount = Satellite.isCurrentWindowSatellite() ? 10000 : 2000;
+      int maxCount = Satellite.isCurrentWindowSatellite() ? 10000 : 500;
       
       for (int i = 0; i < output.length(); i++)
       {

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -360,7 +360,7 @@ public void onNewProjectFolderEvent(NewProjectFolderEvent event)
    public static String projFileFromDir(String dir)
    {
       FileSystemItem dirItem = FileSystemItem.createDir(dir);
-      String projFilename = dirItem.getRootPath() + ".Rproj";
+      String projFilename = dirItem.getName() + ".Rproj";
       String completeProjFilename = dirItem.completePath(projFilename);
       FileSystemItem projFile = FileSystemItem.createFile(completeProjFilename);
       return projFile.getPath();

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -360,7 +360,7 @@ public void onNewProjectFolderEvent(NewProjectFolderEvent event)
    public static String projFileFromDir(String dir)
    {
       FileSystemItem dirItem = FileSystemItem.createDir(dir);
-      String projFilename = dirItem.getRootPath() + ".Rproj";
+      String projFilename = dirItem.getName() + ".Rproj";
       String completeProjFilename = dirItem.completePath(projFilename);
       FileSystemItem projFile = FileSystemItem.createFile(completeProjFilename);
       return projFile.getPath();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/dialogs/VisualModeLineWrappingDialog.java
Patch:
@@ -111,7 +111,7 @@ public VisualModeLineWrappingDialog(
          
       
       chkConfigureFile_ = lineWrappingRadio( 
-         constants_.useBasedLineWrapping(detectedLineWrapping)
+         constants_.useBasedLineWrappingForDocument(detectedLineWrapping)
       );
       chkConfigureFile_.setValue(true);
       mainWidget_.add(chkConfigureFile_);
@@ -120,7 +120,7 @@ public VisualModeLineWrappingDialog(
       mainWidget_.add(numFileColumn_);
       
       chkConfigureProject_= lineWrappingRadio(
-         constants_.useBasedLineWrapping(detectedLineWrapping)
+         constants_.useBasedLineWrappingForProject(detectedLineWrapping)
       );
       numProjectColumn_ = createColumnInput(defaultColumnBreak);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -914,7 +914,9 @@ void onSetWorkingDirToFilesPane()
    @Handler
    void onShowFolder()
    {
-      eventBus_.fireEvent(new ShowFolderEvent(currentPath_));
+      String path = server_.resolveAliasedPath(currentPath_);
+      FileSystemItem resolvedCurrentDir = FileSystemItem.createDir(path);
+      eventBus_.fireEvent(new ShowFolderEvent(resolvedCurrentDir));
    }
 
    public void onFileChange(FileChangeEvent event)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/dialogs/VisualModeLineWrappingDialog.java
Patch:
@@ -111,7 +111,7 @@ public VisualModeLineWrappingDialog(
          
       
       chkConfigureFile_ = lineWrappingRadio( 
-         constants_.useBasedLineWrapping(detectedLineWrapping)
+         constants_.useBasedLineWrappingForDocument(detectedLineWrapping)
       );
       chkConfigureFile_.setValue(true);
       mainWidget_.add(chkConfigureFile_);
@@ -120,7 +120,7 @@ public VisualModeLineWrappingDialog(
       mainWidget_.add(numFileColumn_);
       
       chkConfigureProject_= lineWrappingRadio(
-         constants_.useBasedLineWrapping(detectedLineWrapping)
+         constants_.useBasedLineWrappingForProject(detectedLineWrapping)
       );
       numProjectColumn_ = createColumnInput(defaultColumnBreak);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/yaml/YamlCompletionManager.java
Patch:
@@ -140,7 +140,8 @@ public boolean getCompletions(String line, CompletionRequestContext context)
                true,
                true,
                null,
-               null);         
+               null, 
+               JsUtil.toJsArrayInteger(new ArrayList<>(values.size())));         
          response.setCacheable(cacheable);
          context.onResponseReceived(response); 
       });

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputDisplay.java
Patch:
@@ -26,6 +26,8 @@ public interface CompileOutputDisplay
    public void writeOutput(String output);
    public void writeError(String error);
    
+   public void onCompileCompleted();
+   
    public void clear();
    public void scrollToBottom();
    

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompilePanel.java
Patch:
@@ -186,6 +186,7 @@ public void scrollToBottom()
    public void compileCompleted()
    {
       stopButton_.setVisible(false);
+      outputDisplay_.onCompileCompleted();
 
       if (isErrorPanelShowing())
          errorList_.focus();

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -233,7 +233,6 @@ public void enqueEvent(ClientEvent event)
          {
             public boolean execute()
             {
-               final int MAX_EVENTS_AT_ONCE = 200;
                for (int i = 0;
                     i < MAX_EVENTS_AT_ONCE && pendingEvents_.size() > 0;
                     i++)
@@ -1144,5 +1143,6 @@ else if (type == ClientEvent.ClipboardAction)
 
    private final ArrayList<ClientEvent> pendingEvents_ = new ArrayList<>();
 
+   private static final int MAX_EVENTS_AT_ONCE = 200;
 
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1131,7 +1131,7 @@ private boolean beginSuggest(boolean flushCache,
             // when below @examples, handle <TAB> here and take into account
             // the tab size, where the code begins (i.e. after |#' | ) and 
             // where the cursor currently is
-            if (DocumentMode.isCursorInRoxygenExamples(docDisplay_)) 
+            if (DocumentMode.isCursorInRoxygenExamples(docDisplay_) && !implicit) 
             {
                if (editor != null) 
                {

File: src/gwt/src/org/rstudio/studio/client/common/codetools/RCompletionType.java
Patch:
@@ -43,6 +43,7 @@ public class RCompletionType
    public static final int DATASET     = 24;
    public static final int YAML_KEY    = 25;
    public static final int YAML_VALUE  = 26;
+   public static final int COLUMN      = 27;
    public static final int SNIPPET     = 98;
    public static final int CONTEXT     = 99;
    

File: src/gwt/src/org/rstudio/studio/client/common/icons/code/CodeIcons.java
Patch:
@@ -111,4 +111,7 @@ public interface CodeIcons extends ClientBundle
 
    @Source("roxygen_2x.png")
    ImageResource roxygen2x();
+
+   @Source("column_2x.png")
+   ImageResource column2x();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequesterResources.java
Patch:
@@ -26,6 +26,9 @@ public static interface Styles extends CssResource
       String fileIcon();
       String completion();
       String packageName();
+      String dataframe();
+      String column();
+      String argument();
    }
    
    @Source("CompletionRequester.css")

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -240,6 +240,7 @@ public void onChange(ChangeEvent event)
             },
             false);
       
+      textRendering_.setValue(userPrefs_.textRendering().getGlobalValue());
       textRendering_.getListBox().addChangeHandler(new ChangeHandler()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -6589,9 +6589,7 @@ private void runPyShinyApp()
       source_.withSaveFilesBeforeCommand(() ->
       {
          String path = getPath();
-         // Some light shell escaping.
-         // TODO: More exhaustive escaping
-         path = path.replaceAll("([ '\"\\\\$])", "\\\\$1");
+         path = StringUtil.escapeBashPath(path, false);
          events_.fireEvent(new SendToTerminalEvent("command shiny run --reload --launch-browser --port=0 " + path + "\n", true));
       }, () -> {}, "Run Shiny Application");
    }

File: src/gwt/src/org/rstudio/core/client/widget/SpanLabel.java
Patch:
@@ -18,10 +18,11 @@
 
 public class SpanLabel extends FormLabel
 {
-   public SpanLabel(String label, Widget labeledWidget, boolean wordWrap)
+   public SpanLabel(String label, String tooltip, Widget labeledWidget, boolean wordWrap)
    {
       super(true /*inline*/, label, NoForId);
       setWordWrap(wordWrap);
       setFor(labeledWidget);
+      setTitle(tooltip);
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -353,6 +353,8 @@ void onToggleTabKeyMovesFocus()
    public static final int MAX_WRAP_COLUMN = 256;
    public static final int MAX_SCREEN_READER_CONSOLE_OUTPUT = 999;
 
+   public static final int MAX_EDITOR_SCROLL_MULTIPLIER = 200;
+
    private final Session session_;
    private final PrefsServerOperations server_;
    private final SatelliteManager satelliteManager_;

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -377,6 +377,8 @@ public final native boolean focusOnNavigate() /*-{
       MIME_TYPES.put( "sql",       "text/x-sql" );
       MIME_TYPES.put( "stan",      "text/x-stan" );
       MIME_TYPES.put( "clj",       "text/x-clojure");
+      MIME_TYPES.put( "groovy",    "text/x-groovy");
+      MIME_TYPES.put( "nf",        "text/x-groovy");
 
       // other types we are likely to serve
       MIME_TYPES.put( "xml",   "text/xml" );

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -445,6 +445,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.el", LISP, new ImageResource2x(icons.iconLisp2x()));
       register("*.lua", LUA, new ImageResource2x(icons.iconLua2x()));
       register("*.m", MATLAB, new ImageResource2x(icons.iconMatlab2x()));
+      register("*.nf", GROOVY, new ImageResource2x(icons.iconGroovy2x()));
       register("*.pl", PERL, new ImageResource2x(icons.iconPerl2x()));
       register("*.rb", RUBY, new ImageResource2x(icons.iconRuby2x()));
       register("*.rs", RUST, new ImageResource2x(icons.iconRust2x()));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/ObjectExplorerPresenter.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.workbench.views.source.editors.explorer;
 
 import org.rstudio.studio.client.application.events.EventBus;
+import org.rstudio.studio.client.workbench.views.source.editors.explorer.events.CloseObjectExplorerEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.explorer.events.ObjectExplorerEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.explorer.events.OpenObjectExplorerEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.explorer.events.RefreshObjectExplorerEvent;
@@ -30,7 +31,6 @@ public class ObjectExplorerPresenter
    public ObjectExplorerPresenter(EventBus events)
    {
       events_ = events;
-      
       events_.addHandler(ObjectExplorerEvent.TYPE, this);
    }
    
@@ -69,8 +69,9 @@ private void onOpenNode(ObjectExplorerEvent.Data data)
    {
    }
    
-   private void onCloseNode(ObjectExplorerEvent.Data data)
+   private void onCloseNode(ObjectExplorerEvent.Data eventData)
    {
+      events_.fireEvent(new CloseObjectExplorerEvent(eventData.getHandle()));
    }
    
    // Private members ----

File: src/gwt/src/org/rstudio/studio/client/common/icons/code/CodeIcons.java
Patch:
@@ -108,4 +108,7 @@ public interface CodeIcons extends ClientBundle
 
    @Source("test_2x.png")
    ImageResource test2x();
+
+   @Source("roxygen_2x.png")
+   ImageResource roxygen2x();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchSuggestion.java
Patch:
@@ -102,6 +102,9 @@ private ImageResource iconForSourceItem(SourceItem sourceItem)
       case SourceItem.TEST:
          image = new ImageResource2x(CodeIcons.INSTANCE.test2x());
          break;
+      case SourceItem.ROXYGEN:
+         image = new ImageResource2x(CodeIcons.INSTANCE.roxygen2x());
+         break;
       case SourceItem.NONE:
       default:
          image = new ImageResource2x(CodeIcons.INSTANCE.keyword2x());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorBackgroundLinkHighlighter.java
Patch:
@@ -75,7 +75,7 @@ public class AceEditorBackgroundLinkHighlighter
             EditorModeChangedEvent.Handler,
             MouseMoveHandler
 {
-   private interface Highlighter
+   interface Highlighter
    {
       void highlight(String line, int row);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/model/FilesServerOperations.java
Patch:
@@ -102,6 +102,9 @@ void readConfigJSON(String relativePath,
                  boolean logErrorIfNotFound,
                  ServerRequestCallback<JavaScriptObject> requestCallback);
 
+   void getIssueUrl(String id, 
+                    ServerRequestCallback<String> requestCallback);
+
    /**
     * Use VERY sparingly; we generally don't want to expose
     * non-aliased paths to other parts of the client codebase

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewQuartoProjectPage.java
Patch:
@@ -181,7 +181,8 @@ protected void initialize(NewProjectInput input)
       
       // popuplate kernel list from caps
       quartoCaps_ = input.getContext().getQuartoCapabilities();
-      JsArray<QuartoJupyterKernel> kernels = quartoCaps_.jupyterKernels();
+      JsArray<QuartoJupyterKernel> kernels = quartoCaps_ == null ?
+              JsArray.createArray().cast() : quartoCaps_.jupyterKernels();
       
       String[] kernelNames = new String[kernels.length()];
       String[] kernelDisplayNames = new String[kernels.length()];

File: src/gwt/src/org/rstudio/studio/client/quarto/ui/NewQuartoDocumentDialog.java
Patch:
@@ -188,7 +188,8 @@ public void onChange(ChangeEvent event)
       setListBoxValue(engineSelect_, lastResult_.getEngine());
             
       Label kernelLabel = createLabel(constants_.kernelLabelCaption());
-      JsArray<QuartoJupyterKernel> kernels = caps.jupyterKernels();
+      JsArray<QuartoJupyterKernel> kernels = caps == null ?
+              JsArray.createArray().cast() : caps.jupyterKernels();
       
       String[] kernelNames = new String[kernels.length()];
       String[] kernelDisplayNames = new String[kernels.length()];
@@ -293,7 +294,7 @@ private Result getResult(boolean empty)
       {
          language = "r";
       }
-      else
+      else if (caps_ != null)
       {
          JsArray<QuartoJupyterKernel> kernels = caps_.jupyterKernels();
          for (int i=0; i<kernels.length(); i++)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1908,7 +1908,8 @@ private String quoteIfNotSyntacticNameCompletion(QualifiedName name)
              type == RCompletionType.ARGUMENT ||
              type == RCompletionType.OPTION ||
              type == RCompletionType.CONTEXT ||
-             type == RCompletionType.KEYWORD)
+             type == RCompletionType.KEYWORD ||
+             type == RCompletionType.FUNCTION)
          {
             return value;
          }

File: src/gwt/src/org/rstudio/core/client/hyperlink/Hyperlink.java
Patch:
@@ -42,6 +42,7 @@ public Hyperlink(String url, Map<String, String> params, String text, String cla
 
         anchor_.setInnerText(text);
         anchor_.setClassName(getAnchorClass());
+        
         if (clazz != null)
             anchor_.addClassName(clazz);
         

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -224,6 +224,9 @@ void removeCachedData(String cacheKey,
    
    void ensureFileExists(String path,
                          ServerRequestCallback<Boolean> requestCallback);
+
+   void createAliasedPath(String path,
+                          ServerRequestCallback<String> requestCallback);
    
    public void getFileContents(String path,
                                String encoding,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindInFilesServerOperations.java
Patch:
@@ -23,6 +23,7 @@ public interface FindInFilesServerOperations
 {
    void beginFind(String searchString,
                   boolean regex,
+                  boolean isWholeWord,
                   boolean ignoreCase,
                   FileSystemItem directory,
                   JsArrayString includeFilePatterns,
@@ -49,6 +50,7 @@ void previewReplace(String searchString,
 
    void completeReplace(String searchString,
                         boolean regex,
+                        boolean isWholeWord,
                         boolean searchIgnoreCase,
                         FileSystemItem dictionary,
                         JsArrayString includeFilePatterns,

File: src/gwt/src/org/rstudio/core/client/RegexUtil.java
Patch:
@@ -33,7 +33,7 @@ public static final boolean isSyntacticRIdentifier(String identifier)
    {
       String regex =
             "^" +
-            "(?!_*[" + WORD_CHARACTER +"])" +
+            "(?!_+[" + WORD_CHARACTER +"])" +
             "[" + WORD_CHARACTER + ".]" +
             "[" + WORD_CHARACTER +  "._]*" +
             "$";

File: src/gwt/src/org/rstudio/core/client/RegexUtil.java
Patch:
@@ -33,7 +33,7 @@ public static final boolean isSyntacticRIdentifier(String identifier)
    {
       String regex =
             "^" +
-            "(?!_*[" + WORD_CHARACTER +"])" +
+            "(?!_+[" + WORD_CHARACTER +"])" +
             "[" + WORD_CHARACTER + ".]" +
             "[" + WORD_CHARACTER +  "._]*" +
             "$";

File: src/gwt/src/org/rstudio/core/client/RegexUtil.java
Patch:
@@ -33,7 +33,7 @@ public static final boolean isSyntacticRIdentifier(String identifier)
    {
       String regex =
             "^" +
-            "(?!_*[0-9])" +
+            "(?!_*[" + WORD_CHARACTER +"])" +
             "[" + WORD_CHARACTER + ".]" +
             "[" + WORD_CHARACTER +  "._]*" +
             "$";

File: src/gwt/src/org/rstudio/core/client/RegexUtil.java
Patch:
@@ -33,7 +33,7 @@ public static final boolean isSyntacticRIdentifier(String identifier)
    {
       String regex =
             "^" +
-            "(?!_*[0-9])" +
+            "(?!_*[" + WORD_CHARACTER +"])" +
             "[" + WORD_CHARACTER + ".]" +
             "[" + WORD_CHARACTER +  "._]*" +
             "$";

File: src/gwt/src/org/rstudio/core/client/RegexUtil.java
Patch:
@@ -33,7 +33,7 @@ public static final boolean isSyntacticRIdentifier(String identifier)
    {
       String regex =
             "^" +
-            "(?![0-9])" +
+            "(?!_*[0-9])" +
             "[" + WORD_CHARACTER + ".]" +
             "[" + WORD_CHARACTER +  "._]*" +
             "$";

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/clipboard/CopyPlotToClipboardDesktopDialog.java
Patch:
@@ -93,8 +93,8 @@ public void execute()
                // NOTE: we use a one-pixel fudge factor here to avoid copying
                // bits of the border; see https://github.com/rstudio/rstudio/issues/4864
                frame.copyPageRegionToClipboard(
-                     ElementEx.clientLeft(img) + 1,
-                     ElementEx.clientTop(img) + 1,
+                     ElementEx.getClientLeft(img) + 1,
+                     ElementEx.getClientTop(img) + 1,
                      img.getClientWidth(),
                      img.getClientHeight(),
                      completed);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/PlotsPanePreviewer.java
Patch:
@@ -82,8 +82,8 @@ public Rectangle getPreviewClientRect()
       if (images.getLength() > 0)
       {
          ElementEx img = images.getItem(0).cast();
-         return new Rectangle(img.clientLeft(),
-                              img.clientTop(),
+         return new Rectangle(img.getClientLeft(),
+                              img.getClientTop(),
                               img.getClientWidth(),
                               img.getClientHeight());
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/export/DesktopExport.java
Patch:
@@ -54,12 +54,11 @@ public void execute()
          }
 
          private void performExport(double zoomLevel) {
-            
             // get the preview iframe rect
             ElementEx iframe = sizeEditor.getPreviewIFrame().<ElementEx>cast();
             final Rectangle viewerRect = new Rectangle(
-                   (int) Math.ceil(zoomLevel * ElementEx.clientLeft(iframe)),
-                   (int) Math.ceil(zoomLevel * ElementEx.clientTop(iframe)),
+                   (int) Math.ceil(zoomLevel * iframe.getClientLeft()),
+                   (int) Math.ceil(zoomLevel * iframe.getClientTop()),
                    (int) Math.ceil(zoomLevel * iframe.getClientWidth()),
                    (int) Math.ceil(zoomLevel * iframe.getClientHeight())).inflate(-1);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/clipboard/CopyPlotToClipboardDesktopDialog.java
Patch:
@@ -93,8 +93,8 @@ public void execute()
                // NOTE: we use a one-pixel fudge factor here to avoid copying
                // bits of the border; see https://github.com/rstudio/rstudio/issues/4864
                frame.copyPageRegionToClipboard(
-                     ElementEx.getClientLeft(img) + 1,
-                     ElementEx.getClientTop(img) + 1,
+                     ElementEx.clientLeft(img) + 1,
+                     ElementEx.clientTop(img) + 1,
                      img.getClientWidth(),
                      img.getClientHeight(),
                      completed);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/PlotsPanePreviewer.java
Patch:
@@ -82,8 +82,8 @@ public Rectangle getPreviewClientRect()
       if (images.getLength() > 0)
       {
          ElementEx img = images.getItem(0).cast();
-         return new Rectangle(img.getClientLeft(),
-                              img.getClientTop(),
+         return new Rectangle(img.clientLeft(),
+                              img.clientTop(),
                               img.getClientWidth(),
                               img.getClientHeight());
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/export/DesktopExport.java
Patch:
@@ -54,11 +54,12 @@ public void execute()
          }
 
          private void performExport(double zoomLevel) {
+            
             // get the preview iframe rect
             ElementEx iframe = sizeEditor.getPreviewIFrame().<ElementEx>cast();
             final Rectangle viewerRect = new Rectangle(
-                   (int) Math.ceil(zoomLevel * iframe.getClientLeft()),
-                   (int) Math.ceil(zoomLevel * iframe.getClientTop()),
+                   (int) Math.ceil(zoomLevel * ElementEx.clientLeft(iframe)),
+                   (int) Math.ceil(zoomLevel * ElementEx.clientTop(iframe)),
                    (int) Math.ceil(zoomLevel * iframe.getClientWidth()),
                    (int) Math.ceil(zoomLevel * iframe.getClientHeight())).inflate(-1);
 

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -986,7 +986,6 @@ private void initializeWorkbench()
 
       if (!sessionInfo.getAllowShell())
       {
-         commands_.showShellDialog().remove();
          removeTerminalCommands();
       }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -469,7 +469,6 @@
    public abstract AppCommand openProfileInBrowser();
 
    // Tools
-   public abstract AppCommand showShellDialog();
    public abstract AppCommand macPreferences();
    public abstract AppCommand showOptions();
    public abstract AppCommand showCodeOptions();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPane.java
Patch:
@@ -122,7 +122,7 @@ protected Toolbar createMainToolbar()
       moreMenu.addItem(commands_.vcsRevert().createMenuItem(false));
       moreMenu.addItem(commands_.vcsIgnore().createMenuItem(false));
       moreMenu.addSeparator();
-      moreMenu.addItem(commands_.showShellDialog().createMenuItem(false));
+      moreMenu.addItem(commands_.newTerminal().createMenuItem(false));
 
       ToolbarPopupMenu pullMoreMenu = new ToolbarPopupMenu();
       pullMoreMenu.addItem(commands_.vcsPullRebase().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/SVNPane.java
Patch:
@@ -85,7 +85,7 @@ protected Toolbar createMainToolbar()
       moreMenu.addSeparator();
       moreMenu.addItem(commands_.vcsShowHistory().createMenuItem(false));
       moreMenu.addSeparator();
-      moreMenu.addItem(commands_.showShellDialog().createMenuItem(false));
+      moreMenu.addItem(commands_.newTerminal().createMenuItem(false));
 
       toolbar.addLeftWidget(new ToolbarMenuButton(
           constants_.moreCapitalized(),

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorDialogs.java
Patch:
@@ -213,7 +213,7 @@ public Promise<PanmirrorAttrEditResult> editSpan(PanmirrorAttrProps attr)
    
    public Promise<PanmirrorAttrEditResult> editDiv(PanmirrorAttrProps attr, boolean removeEnabled)
    {
-      return editPanmirrorAttr(constants_.divAttributesCaption(), removeEnabled ? constants_.unwrapSpanRemoveButtonCaption() : null, null, attr);
+      return editPanmirrorAttr(constants_.divAttributesCaption(), removeEnabled ? constants_.unwrapDivTitle() : null, null, attr);
    }
    
 

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -88,7 +88,6 @@ void prepareForSatelliteWindow(String name, int x, int y, int width,
                                   int height, Command onPrepared);
    void prepareForNamedWindow(String name, boolean allowExternalNavigation,
          boolean showDesktopToolbar, Command onPrepared);
-   void closeNamedWindow(String name);
    
    void copyPageRegionToClipboard(int left, int top, int width, int height,
                                   Command onCopied);

File: src/gwt/src/org/rstudio/core/client/hyperlink/Hyperlink.java
Patch:
@@ -94,7 +94,7 @@ public static Hyperlink create(String url, String paramsTxt, String text, String
                 params.put(key, value);
             }
         }
-        if (url.startsWith("file://"))
+        if (FileHyperlink.handles(url))
         {
             return new FileHyperlink(url, params, text, clazz);
         }

File: src/gwt/src/org/rstudio/core/client/AnsiCode.java
Patch:
@@ -100,8 +100,6 @@ public class AnsiCode
    public static final int FONT_SEVEN = 17;
    public static final int FONT_EIGHT = 18;
 
-   public static final String HYPERLINK_STYLE = "xtermHyperlink";
-
    // Font-nine is used by RStudio to reduce spacing between lines
    public static final int FONT_NINE = 19;
    public static final String FONT_NINE_STYLE = "xtermFont9";

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -41,6 +41,7 @@
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.cellview.LinkColumn;
 import org.rstudio.core.client.files.filedialog.FileDialogResources;
+import org.rstudio.core.client.hyperlink.HyperlinkResources;
 import org.rstudio.core.client.layout.DelayFadeInHelper;
 import org.rstudio.core.client.prefs.PreferencesDialogBaseResources;
 import org.rstudio.core.client.resources.CoreResources;
@@ -413,6 +414,7 @@ private void ensureStylesInjected()
       CoreResources.INSTANCE.styles().ensureInjected();
       StudioResources.INSTANCE.styles().ensureInjected();
       ConsoleResources.INSTANCE.consoleStyles().ensureInjected();
+      HyperlinkResources.INSTANCE.hyperlinkStyles().ensureInjected();
       FileDialogResources.INSTANCE.styles().ensureInjected();
       ManipulatorResources.INSTANCE.manipulatorStyles().ensureInjected();
       PackagesCellTableResources.INSTANCE.cellTableStyle().ensureInjected();

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -156,7 +156,6 @@
 import org.rstudio.studio.client.workbench.views.connections.ui.ConnectionsPane;
 import org.rstudio.studio.client.workbench.views.console.ConsolePane;
 import org.rstudio.studio.client.workbench.views.console.model.ConsoleServerOperations;
-import org.rstudio.studio.client.workbench.views.console.model.VirtualConsoleServerOperations;
 import org.rstudio.studio.client.workbench.views.console.shell.Shell;
 import org.rstudio.studio.client.workbench.views.console.shell.ShellPane;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.HelpStrategy;
@@ -436,7 +435,6 @@ protected void configure()
       bind(ChooseFileServerOperations.class).to(RemoteServer.class);
       bind(CodeToolsServerOperations.class).to(RemoteServer.class);
       bind(ConsoleServerOperations.class).to(RemoteServer.class);
-      bind(VirtualConsoleServerOperations.class).to(RemoteServer.class);
       bind(SourceServerOperations.class).to(RemoteServer.class);
       bind(FilesServerOperations.class).to(RemoteServer.class);
       bind(HistoryServerOperations.class).to(RemoteServer.class);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/model/ConsoleServerOperations.java
Patch:
@@ -21,8 +21,7 @@
 import org.rstudio.studio.client.workbench.views.history.model.HistoryServerOperations;
 
 public interface ConsoleServerOperations extends CodeToolsServerOperations,
-                                                 HistoryServerOperations, 
-                                                 VirtualConsoleServerOperations
+                                                 HistoryServerOperations
 {
    // adapt to the language of code being sent to console
    void adaptToLanguage(String language,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/model/PackagesServerOperations.java
Patch:
@@ -37,6 +37,9 @@ void availablePackages(
    void isPackageLoaded(String packageName, String libName,
                         ServerRequestCallback<Boolean> requestCallback);
    
+   void isPackageHyperlinkSafe(String packageName,
+                               ServerRequestCallback<Boolean> requestCallback);
+   
    void isPackageInstalled(String packageName,
                            String version,
                            ServerRequestCallback<Boolean> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/model/PlotsServerOperations.java
Patch:
@@ -34,6 +34,8 @@ String getPlotExportUrl(String type,
                            int height, 
                            boolean attachment);
    
+   void getPlotTempdir(ServerRequestCallback<String> requestCallback);
+   
    void nextPlot(ServerRequestCallback<Void> requestCallback);
    void previousPlot(ServerRequestCallback<Void> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/common/satellite/Satellite.java
Patch:
@@ -199,6 +199,9 @@ private native void initializeNative(String name) /*-{
       $wnd.opener.registerAsRStudioSatellite(name, $wnd);
    }-*/;
 
+   public native void notifyRStudioSatelliteClosed() /*-{
+      $wnd.opener.notifyRStudioSatelliteClosed($wnd.RStudioSatelliteName);
+   }-*/;
 
    // check whether the current window is a satellite
    public static native boolean isCurrentWindowSatellite() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -674,7 +674,7 @@
    public abstract AppCommand browseAddins();
 
    // Background Jobs
-   public abstract AppCommand startBackgroundJob();
+   public abstract AppCommand startJob();
    public abstract AppCommand sourceAsJob();
    public abstract AppCommand clearBackgroundJobs();
    public abstract AppCommand activateBackgroundJobs();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/model/PlotsServerOperations.java
Patch:
@@ -34,6 +34,8 @@ String getPlotExportUrl(String type,
                            int height, 
                            boolean attachment);
    
+   void getPlotTempdir(ServerRequestCallback<String> requestCallback);
+   
    void nextPlot(ServerRequestCallback<Void> requestCallback);
    void previousPlot(ServerRequestCallback<Void> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -328,6 +328,7 @@ public FileTypeRegistry(EventBus eventBus,
       register(".gitignore", TEXT, new ImageResource2x(icons.iconText2x()));
       register(".Rbuildignore", TEXT, new ImageResource2x(icons.iconText2x()));
       register(".lintr", TEXT, new ImageResource2x(icons.iconText2x()));
+      register("renv.lock", JSON, new ImageResource2x(icons.iconDCF2x()));
       register("packrat.lock", DCF, new ImageResource2x(icons.iconDCF2x()));
       register("*.r", R, new ImageResource2x(icons.iconRdoc2x()));
       register("*.q", R, new ImageResource2x(icons.iconRdoc2x()));

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -327,6 +327,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("README", TEXT, new ImageResource2x(icons.iconText2x()));
       register(".gitignore", TEXT, new ImageResource2x(icons.iconText2x()));
       register(".Rbuildignore", TEXT, new ImageResource2x(icons.iconText2x()));
+      register(".lintr", TEXT, new ImageResource2x(icons.iconText2x()));
       register("packrat.lock", DCF, new ImageResource2x(icons.iconDCF2x()));
       register("*.r", R, new ImageResource2x(icons.iconRdoc2x()));
       register("*.q", R, new ImageResource2x(icons.iconRdoc2x()));

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -2036,7 +2036,7 @@ public PrefValue<JsArrayString> alwaysShownExtensions()
          "always_shown_extensions",
          _constants.alwaysShownExtensionsTitle(), 
          _constants.alwaysShownExtensionsDescription(), 
-         JsArrayUtil.createStringArray(".circleci", ".gitattributes", ".github", ".gitignore", ".httr-oauth", ".r", ".rbuildignore", ".rdata", ".renvignore", ".renviron", ".rhistory", ".rprofile", ".ruserdata"));
+         JsArrayUtil.createStringArray(".circleci", ".gitattributes", ".github", ".gitignore", ".httr-oauth", ".lintr", ".r", ".rbuildignore", ".rdata", ".renvignore", ".renviron", ".rhistory", ".rprofile", ".ruserdata"));
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -198,7 +198,7 @@ public static class Platform extends JavaScriptObject
       protected Platform() {} 
 
       public final native JavaScriptObject getWindows() /*-{
-         return this && this.windows || {"rBinDir":"","preferR64":true,"rstudioPath":""};
+         return this && this.windows || {"rBinDir":"","preferR64":true,"rExecutablePath":""};
       }-*/;
 
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/PrefsConstants.java
Patch:
@@ -1877,11 +1877,11 @@ public interface PrefsConstants extends com.google.gwt.i18n.client.Messages {
     String packagesInfoBarText();
     
     /**
-     * Translated "This project's repositories are managed by renv.".
+     * Translated "Repositories are being managed by a renv.lock file".
      *
-     * @return translated "This project's repositories are managed by renv."
+     * @return translated "Repositories are being managed by a renv.lock file"
      */
-    @DefaultMessage("This project's repositories are managed by renv.")
+    @DefaultMessage("Repositories are being managed by a renv.lock file")
     @Key("packagesRenvInfoBarText")
     String packagesRenvInfoBarText();
 

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -184,6 +184,7 @@ public static String idWithPrefix(String prefix, String id)
    public final static String PACKAGE_MANAGEMENT_PREFS = "package_management_prefs";
    public final static String PACKAGE_DEVELOPMENT_PREFS = "package_development_prefs";
    public final static String PACKAGE_CPP_PREFS = "package_cpp_prefs";
+   public final static String PACKAGE_INFO_BAR = "package_info_bar";
 
    public final static String TERMINAL_GENERAL_PREFS = "terminal_general_prefs";
    public final static String TERMINAL_CLOSING_PREFS = "terminal_closing_prefs";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/model/LintItem.java
Patch:
@@ -109,6 +109,7 @@ public static final native JsArray<AceAnnotation> asAceAnnotations(
             row: items[key]["start.row"],
             column: items[key]["start.column"],
             html: items[key]["text"],
+            text: items[key]["raw"],
             type: type
          });
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkRowExecState.java
Patch:
@@ -79,6 +79,8 @@ public void detach()
 
    protected abstract void setTitle(String title);
 
+   protected abstract void appendToTitle(String text);
+
    // Private methods ---------------------------------------------------------
    
    private void scheduleDismiss()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/model/LintItem.java
Patch:
@@ -109,6 +109,7 @@ public static final native JsArray<AceAnnotation> asAceAnnotations(
             row: items[key]["start.row"],
             column: items[key]["start.column"],
             html: items[key]["text"],
+            text: items[key]["raw"],
             type: type
          });
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkRowExecState.java
Patch:
@@ -79,6 +79,8 @@ public void detach()
 
    protected abstract void setTitle(String title);
 
+   protected abstract void appendToTitle(String text);
+
    // Private methods ---------------------------------------------------------
    
    private void scheduleDismiss()

File: src/gwt/src/org/rstudio/studio/client/application/ui/RVersionSelectWidget.java
Patch:
@@ -43,7 +43,7 @@ public RVersionSelectWidget(String caption,
                                boolean includeHelpButton,
                                boolean fillContainer)
    {
-      this(caption, uniqueId, rVersions, false, true, false, false);
+      this(caption, uniqueId, rVersions, includeSystemDefault, includeHelpButton, fillContainer, false);
    }
 
    public RVersionSelectWidget(String caption,

File: src/gwt/src/org/rstudio/studio/client/application/ui/RVersionSelectWidget.java
Patch:
@@ -43,7 +43,7 @@ public RVersionSelectWidget(String caption,
                                boolean includeHelpButton,
                                boolean fillContainer)
    {
-      this(caption, uniqueId, rVersions, false, true, false, false);
+      this(caption, uniqueId, rVersions, includeSystemDefault, includeHelpButton, fillContainer, false);
    }
 
    public RVersionSelectWidget(String caption,

File: src/gwt/src/org/rstudio/studio/client/application/ui/RVersionSelectWidget.java
Patch:
@@ -43,7 +43,7 @@ public RVersionSelectWidget(String caption,
                                boolean includeHelpButton,
                                boolean fillContainer)
    {
-      this(caption, uniqueId, rVersions, false, true, false, false);
+      this(caption, uniqueId, rVersions, includeSystemDefault, includeHelpButton, fillContainer, false);
    }
 
    public RVersionSelectWidget(String caption,

File: src/gwt/src/org/rstudio/studio/client/application/ui/RVersionSelectWidget.java
Patch:
@@ -43,7 +43,7 @@ public RVersionSelectWidget(String caption,
                                boolean includeHelpButton,
                                boolean fillContainer)
    {
-      this(caption, uniqueId, rVersions, false, true, false, false);
+      this(caption, uniqueId, rVersions, includeSystemDefault, includeHelpButton, fillContainer, false);
    }
 
    public RVersionSelectWidget(String caption,

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -586,6 +586,8 @@
    // Build
    public abstract AppCommand clearBuild();
    public abstract AppCommand buildAll();
+   public abstract AppCommand buildIncremental();
+   public abstract AppCommand buildFull();
    public abstract AppCommand devtoolsLoadAll();
    public abstract AppCommand serveQuartoSite();
    public abstract AppCommand cleanAll();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/ViewBuildtoolsConstants.java
Patch:
@@ -250,5 +250,4 @@ public interface ViewBuildtoolsConstants extends com.google.gwt.i18n.client.Mess
     @Key("serveLabel")
     String serveLabel();
 
-
 }

File: src/gwt/src/org/rstudio/studio/client/common/icons/StandardIcons.java
Patch:
@@ -82,6 +82,9 @@ public interface StandardIcons extends ClientBundle
    @Source("functionLetter_2x.png")
    ImageResource functionLetter2x();
 
+   @Source("test_2x.png")
+   ImageResource test2x();
+
    @Source("methodLetter_2x.png")
    ImageResource methodLetter2x();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2509,6 +2509,8 @@ else if (scope.isSection())
                      statusBar_.setScopeType(StatusBar.SCOPE_SECTION);
                   else if (scope.isTopLevel())
                      statusBar_.setScopeType(StatusBar.SCOPE_TOP_LEVEL);
+                  else if (scope.isTest())
+                     statusBar_.setScopeType(StatusBar.SCOPE_TEST);
                   else if (scope.isFunction())
                      statusBar_.setScopeType(StatusBar.SCOPE_FUNCTION);
                   else if (scope.isLambda())

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/status/StatusBar.java
Patch:
@@ -36,6 +36,7 @@ interface HideMessageHandler
    int SCOPE_LAMBDA     = 7;
    int SCOPE_ANON       = 8;
    int SCOPE_TOP_LEVEL  = 9;
+   int SCOPE_TEST       = 10;
 
    StatusBarElement getPosition();
    StatusBarElement getScope();

File: src/gwt/src/org/rstudio/studio/client/common/icons/code/CodeIcons.java
Patch:
@@ -105,4 +105,7 @@ public interface CodeIcons extends ClientBundle
 
    @Source("conda_2x.png")
    ImageResource conda2x();
+
+   @Source("test_2x.png")
+   ImageResource test2x();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/model/SourceItem.java
Patch:
@@ -39,6 +39,7 @@ protected SourceItem()
    public static final int FIGURE     =  8;
    public static final int TABLE      =  9;
    public static final int MATH       = 10;
+   public static final int TEST       = 11;
 
    public final native int getType() /*-{
       return this.type;

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoConfig.java
Patch:
@@ -27,5 +27,5 @@ public class QuartoConfig
    public String project_type;
    public String project_output_dir;
    public String[] project_formats;
-   public String project_editor;
+   public QuartoEditorConfig project_editor;
 }

File: src/gwt/src/org/rstudio/studio/client/quarto/ui/NewQuartoDocumentDialog.java
Patch:
@@ -206,7 +206,7 @@ public void onChange(ChangeEvent event)
       
       // use project default if available, otherwise use last result
       QuartoConfig config = session_.getSessionInfo().getQuartoConfig();
-      String editor = config.project_editor;
+      String editor = config.project_editor != null ? config.project_editor.mode : null;
       if (StringUtil.isNullOrEmpty(editor))
          editor = lastResult_.getEditor();
       editorCheckBox_.setValue(editor.equals(QuartoCommandConstants.EDITOR_VISUAL));

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdEditorMode.java
Patch:
@@ -42,7 +42,7 @@ public static String getEditorMode(String path, String yaml, SessionInfo session
    public static String getProjectEditorMode(String path, SessionInfo sessionInfo)
    {
       QuartoConfig config = sessionInfo.getQuartoConfig();
-      String editor = config.project_editor;
+      String editor = config.project_editor != null ? config.project_editor.mode : null;
       if (StringUtil.isNullOrEmpty(editor))
          editor = null;
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -186,7 +186,7 @@ public void onValueChange(ValueChangeEvent<String> event)
             // propagate to YAML
             String yaml = RmdEditorOptions.set(
                   YamlFrontMatter.getFrontMatter(docDisplay_),
-                  CHUNK_OUTPUT_TYPE, event.getValue());
+                  CHUNK_OUTPUT_TYPE, event.getValue(), false);
 
             if (editingTarget_.isVisualEditorActive())
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -133,9 +133,9 @@ public VisualMode(TextEditingTarget target,
       visualModeFormat_ = new VisualModePanmirrorFormat(docUpdateSentinel_, docDisplay_, target_, view_);
       visualModeChunks_ = new VisualModeChunks(docUpdateSentinel_, docDisplay_, target_, releaseOnDismiss, this);
       visualModeLocation_ = new VisualModeEditingLocation(docUpdateSentinel_, docDisplay_);
-      visualModeWriterOptions_ = new VisualModeMarkdownWriter(docUpdateSentinel_, visualModeFormat_);
+      visualModeWriterOptions_ = new VisualModeMarkdownWriter(docUpdateSentinel_, docDisplay_, visualModeFormat_);
       visualModeNavigation_ = new VisualModeNavigation(navigationContext_);
-      visualModeConfirm_ = new VisualModeConfirm(docUpdateSentinel_, docDisplay, this);
+      visualModeConfirm_ = new VisualModeConfirm(docUpdateSentinel_, docDisplay, target_, this);
       visualModeSpelling_ = new VisualModeSpelling(docUpdateSentinel_, docDisplay, this);
       visualModeContext_ = new VisualModePanmirrorContext(
          docUpdateSentinel_, 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PythonPreferencesPane.java
Patch:
@@ -40,11 +40,11 @@ public PythonPreferencesPane(PythonDialogResources res,
       super("420px", constants_.pythonPreferencesText(), false);
 
       projectPrefsPanel_ = new HorizontalPanel();
+      projectPrefsPanel_.getElement().getStyle().setMarginTop(5, Style.Unit.PX);
       overrideLabel_ = new Label();
       projectPrefsPanel_.add(overrideLabel_);
 
       SmallButton editProjectSettings = new SmallButton(constants_.editProjectPreferencesButtonLabel());
-      editProjectSettings.getElement().getStyle().setMarginTop(1, Style.Unit.PX);
       editProjectSettings.getElement().getStyle().setMarginLeft(5, Style.Unit.PX);
       editProjectSettings.addClickHandler(new ClickHandler() {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -73,7 +73,7 @@ public BuildPane(Commands commands,
                     FileTypeRegistry fileTypeRegistry,
                     BuildServerOperations server)
    {
-      super("Build", events);
+      super(constants_.buildText(), events);
       ((BuildPane.Binder) GWT.create(BuildPane.Binder.class)).bind(commands, this);
 
       commands_ = commands;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -317,7 +317,7 @@ void onDevtoolsLoadAll()
          {
             sendLoadCommandToConsole("devtools::load_all(\"" + loadAllPath + "\")");
          });
-      }, () -> {}, "Build");
+      }, () -> {}, constants_.buildText());
    }
    
    void onServeQuartoSite()
@@ -425,7 +425,7 @@ private void executeBuild(final String type, final String subType)
          {
             terminalHelper_.warnBusyTerminalBeforeCommand(() ->
                   executeBuildNoBusyCheck(type, subType),
-                  "Build", constants_.terminalTerminatedQuestion(),
+                  constants_.buildText(), constants_.terminalTerminatedQuestion(),
                   userPrefs_.busyDetection().getValue());
          }
       });
@@ -453,7 +453,7 @@ public void onError(ServerError error)
             }
 
          });
-      }, () -> {}, "Build");
+      }, () -> {}, constants_.buildText());
    }
 
    void onStopBuild()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildTab.java
Patch:
@@ -71,8 +71,8 @@ public BuildTab(final Shim shim,
                    EventBus eventBus,
                    UserPrefs uiPrefs)
    {
-      super("Build",  shim);
-      
+      super(constants_.buildText(), shim);
+
       session_ = session;
       binder.bind(commands, shim);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsTab.java
Patch:
@@ -57,7 +57,7 @@ public ConnectionsTab(final Shim shim,
                          EventBus eventBus,
                          Session session)
    {
-      super("Connections", shim);
+      super(constants_.connectionsTitle(), shim);
       binder.bind(commands, shim);
       session_ = session;
       eventBus_ = eventBus;
@@ -93,4 +93,5 @@ public void onEnableConnections(EnableConnectionsEvent event)
 
    private Session session_;
    private EventBus eventBus_;
+   private static final ConnectionsConstants constants_ = com.google.gwt.core.client.GWT.create(ConnectionsConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -89,7 +89,7 @@ public class ConnectionsPane extends WorkbenchPane
    public ConnectionsPane(Commands commands, EventBus eventBus, UserPrefs userPrefs)
    {
       // initialize
-      super("Connections", eventBus);
+      super(constants_.connectionsTitle(), eventBus);
       commands_ = commands;
       userPrefs_ = userPrefs;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/Console.java
Patch:
@@ -34,6 +34,7 @@
 import org.rstudio.studio.client.workbench.events.BusyEvent;
 import org.rstudio.studio.client.workbench.events.ZoomPaneEvent;
 import org.rstudio.studio.client.workbench.model.Session;
+import org.rstudio.studio.client.workbench.ui.PaneManager;
 import org.rstudio.studio.client.workbench.views.console.ConsolePane.ConsoleMode;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleActivateEvent;
 import org.rstudio.studio.client.workbench.views.console.events.ConsolePromptEvent;
@@ -228,7 +229,7 @@ public void run()
    public void onLayoutZoomConsole()
    {
       onActivateConsole();
-      events_.fireEvent(new ZoomPaneEvent("Console"));
+      events_.fireEvent(new ZoomPaneEvent(PaneManager.CONSOLE_PANE));
    }
 
    public Display getDisplay()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -68,7 +68,7 @@ public ConsolePane(Provider<Shell> consoleProvider,
    {
       // We pass null in place of events here to prevent ActivePaneEvent from being called.
       // ActivatePaneEvent isn't necessary and causes an exception for the Console Pane.
-      super("Console", null);
+      super(constants_.consoleLabel(), null);
 
       consoleProvider_ = consoleProvider;
       progressProvider_ = progressProvider;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -100,7 +100,7 @@ public EnvironmentPane(Commands commands,
                           UserPrefs prefs,
                           DependencyManager dependencyManager)
    {
-      super("Environment", events);
+      super(constants_.environmentCapitalized(), events);
 
       commands_ = commands;
       server_ = serverOperations;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentTab.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.workbench.views.environment;
 
+import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.command.Handler;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -68,7 +69,7 @@ public EnvironmentTab(final Shim shim,
                          Commands commands,
                          Session session)
    {
-      super("Environment", shim);
+      super(constants_.environmentCapitalized(), shim);
       binder.bind(commands, shim);
       events.addHandler(OpenDataFileEvent.TYPE, shim);
 
@@ -83,4 +84,5 @@ public EnvironmentTab(final Shim shim,
    }
 
    private final Session session_;
+   private static final ViewEnvironmentConstants constants_ = GWT.create(ViewEnvironmentConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesPane.java
Patch:
@@ -71,7 +71,7 @@ public FilesPane(GlobalDisplay globalDisplay,
                     Provider<FileCommandToolbar> pFileCommandToolbar,
                     Provider<UserPrefs> pPrefs)
    {
-      super("Files", events);
+      super(constants_.filesTitle(), events);
       globalDisplay_ = globalDisplay;
       commands_ = commands;
       fileDialogs_ = fileDialogs;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesTab.java
Patch:
@@ -50,7 +50,7 @@ public FilesTab(Shim shim,
                    EventBus events,
                    Commands commands)
    {
-      super("Files", shim);
+      super(constants_.filesTitle(), shim);
       binder.bind(commands, shim);
       events.addHandler(OpenFileInBrowserEvent.TYPE, shim);
       events.addHandler(DirectoryNavigateEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/Help.java
Patch:
@@ -32,6 +32,7 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.events.ActivatePaneEvent;
 import org.rstudio.studio.client.workbench.model.Session;
+import org.rstudio.studio.client.workbench.ui.PaneManager;
 import org.rstudio.studio.client.workbench.views.BasePresenter;
 import org.rstudio.studio.client.workbench.views.help.events.ActivateHelpEvent;
 import org.rstudio.studio.client.workbench.views.help.events.HasHelpNavigateHandlers;
@@ -195,7 +196,7 @@ public void onActivateHelp(ActivateHelpEvent event)
 
    public void bringToFront()
    {
-      events_.fireEvent(new ActivatePaneEvent("Help"));
+      events_.fireEvent(new ActivatePaneEvent(PaneManager.HELP_PANE));
    }
 
    private void home()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -93,7 +93,7 @@ public HelpPane(Provider<HelpSearch> searchProvider,
                    EventBus events,
                    UserPrefs prefs)
    {
-      super("Help", events);
+      super(constants_.helpText(), events);
 
       searchProvider_ = searchProvider;
       globalDisplay_ = globalDisplay;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpTab.java
Patch:
@@ -68,7 +68,7 @@ public HelpTab(final Shim shim,
                   EventBus events,
                   final Session session)
    {
-      super("Help", shim);
+      super(constants_.helpText(), shim);
       binder.bind(commands, shim);
       events.addHandler(ShowHelpEvent.TYPE, shim);
       events.addHandler(ActivateHelpEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/HistoryTab.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.history;
 
+import com.google.gwt.core.client.GWT;
 import com.google.inject.Inject;
 
 import org.rstudio.core.client.command.CommandBinder;
@@ -39,7 +40,8 @@ public abstract static class Shim
    @Inject
    public HistoryTab(Shim shim, Binder binder, Commands commands)
    {
-      super("History", shim);
+      super(constants_.historyTitle(), shim);
       binder.bind(commands, shim);
    }
+   private static final HistoryConstants constants_ = GWT.create(HistoryConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryPane.java
Patch:
@@ -87,7 +87,7 @@ public static void ensureStylesInjected()
    @Inject
    public HistoryPane(Commands commands, EventBus events)
    {
-      super("History", events);
+      super(constants_.historyTitle(), events);
       commands_ = commands;
       ensureWidget();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/JobsTab.java
Patch:
@@ -53,7 +53,7 @@ public JobsTab(final Shim shim,
                         Commands commands,
                         EventBus events)
    {
-      super("Jobs", shim);
+      super(constants_.jobsTitle(), shim);
       shim_ = shim;
       
       binder.bind(commands, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/LauncherJobsTab.java
Patch:
@@ -52,7 +52,7 @@ public LauncherJobsTab(final Shim shim,
                           Commands commands,
                           EventBus events)
    {
-      super("Launcher", shim);
+      super(constants_.launcherTitle(), shim);
       shim_ = shim;
       
       binder.bind(commands, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobsPane.java
Patch:
@@ -38,8 +38,8 @@ public class JobsPane extends WorkbenchPane
    public JobsPane(UserPrefs uiPrefs,
                    JobsPaneWidgets widgets)
    {
-      super("Jobs");
-      
+      super(constants_.jobsTitle());
+
       userPrefs_ = uiPrefs;
       widgets_ = widgets;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/LauncherJobsPane.java
Patch:
@@ -35,7 +35,7 @@ public class LauncherJobsPane extends WorkbenchPane
    public LauncherJobsPane(UserPrefs uiPrefs,
                            LauncherJobsPaneWidgets widgets)
    {
-      super("Launcher");
+      super(constants_.launcherTitle());
       
       uiPrefs_ = uiPrefs;
       widgets_ = widgets;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/CompilePdfOutputPresenter.java
Patch:
@@ -67,7 +67,7 @@ public CompilePdfOutputPresenter(CompileOutputPaneFactory outputFactory,
                                     Commands commands,
                                     EventBus events)
    {
-      super(outputFactory.create("Compile PDF",
+      super(outputFactory.create(constants_.compilePDFTaskName(),
                                  constants_.viewLogTitle()));
       binder.bind(commands, this);
       view_ = (CompileOutputPaneDisplay) getView();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/data/DataOutputPane.java
Patch:
@@ -33,7 +33,7 @@ public class DataOutputPane extends WorkbenchPane
    @Inject
    public DataOutputPane()
    {
-      super("Data Output");
+      super(constants_.dataOutputTitle());
       ensureWidget();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/data/DataOutputTab.java
Patch:
@@ -50,7 +50,7 @@ public DataOutputTab(Shim shim,
                         Commands commands,
                         final Session session)
    {
-      super("SQL Results", shim);
+      super(constants_.sqlResultsTitle(), shim);
       shim_ = shim;
 
       GWT.<Binder>create(Binder.class).bind(commands, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -173,7 +173,7 @@ public enum Include
 
    public FindInFilesDialog(OperationWithInput<State> operation)
    {
-      super("Find in Files", Roles.getDialogRole(), operation);
+      super(constants_.findInFilesCaption(), Roles.getDialogRole(), operation);
 
       dirChooser_ = new DirectoryChooserTextBox(constants_.searchInLabel(),
          ElementIds.TextBoxButtonId.FIND_IN,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -53,7 +53,7 @@ public class FindOutputPane extends WorkbenchPane
    public FindOutputPane(Commands commands,
                          EventBus eventBus)
    {
-      super("Find Results");
+      super(constants_.findResultsTitle());
       commands_ = commands;
       eventBus_ = eventBus;
       ensureWidget();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputTab.java
Patch:
@@ -52,7 +52,7 @@ public FindOutputTab(final Shim shim,
                         Commands commands,
                         final Session session)
    {
-      super("Find in Files", shim);
+      super(constants_.findInFilesCaption(), shim);
       shim_ = shim;
 
       events.addHandler(SessionInitEvent.TYPE, (SessionInitEvent sie) ->

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/markers/MarkersOutputPane.java
Patch:
@@ -38,7 +38,7 @@ public class MarkersOutputPane extends WorkbenchPane
    @Inject
    public MarkersOutputPane(Commands commands)
    {
-      super("Markers");
+      super(constants_.markersTitle());
       markerSetsToolbarButton_ = new MarkerSetsToolbarButton();
       markerList_ = new SourceMarkerList();
       clearButton_ = new ToolbarButton(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/markers/MarkersOutputTab.java
Patch:
@@ -50,7 +50,7 @@ public MarkersOutputTab(final Shim shim,
                            Commands commands,
                            final Session session)
    {
-      super("Markers", shim);
+      super(constants_.markersTitle(), shim);
       shim_ = shim;
 
       events.addHandler(SessionInitEvent.TYPE, (SessionInitEvent sie) ->

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/renderrmd/RenderRmdOutputTab.java
Patch:
@@ -59,7 +59,7 @@ public RenderRmdOutputTab(Shim shim,
                              Commands commands,
                              final Session session)
    {
-      super("Render", shim);
+      super(constants_.renderTitle(), shim);
       shim_ = shim;
 
       GWT.<Binder>create(Binder.class).bind(commands, shim_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/rsconnectdeploy/RSConnectDeployOutputPresenter.java
Patch:
@@ -50,7 +50,7 @@ public RSConnectDeployOutputPresenter(CompileOutputPaneFactory outputFactory,
                                    Binder binder,
                                    EventBus events)
    {
-      super(outputFactory.create("Deploy", ""));
+      super(outputFactory.create(constants_.deployTitle(), ""));
       binder.bind(commands, this);
       view_ = (CompileOutputPaneDisplay) getView();
       view_.setHasLogs(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/rsconnectdeploy/RSConnectDeployOutputTab.java
Patch:
@@ -61,7 +61,7 @@ public RSConnectDeployOutputTab(Shim shim,
                              Commands commands,
                              final Session session)
    {
-      super("Deploy", shim);
+      super(constants_.deployTitle(), shim);
       shim_ = shim;
       GWT.<Binder>create(Binder.class).bind(commands, shim);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/SourceCppOutputPane.java
Patch:
@@ -36,7 +36,7 @@ public class SourceCppOutputPane extends WorkbenchPane
    @Inject
    public SourceCppOutputPane()
    {
-      super("Source Cpp");
+      super(constants_.sourceCppTitle());
       compilePanel_ = new CompilePanel(new CompileOutputBufferWithHighlight());
       ensureWidget();
    }
@@ -90,7 +90,7 @@ public void showResults(SourceCppState state)
    @Override
    public void scrollToBottom()
    {
-      compilePanel_.scrollToBottom();   
+      compilePanel_.scrollToBottom();
    }
 
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/SourceCppOutputTab.java
Patch:
@@ -43,7 +43,7 @@ interface Binder extends CommandBinder<Commands, Shim> {}
    @Inject
    public SourceCppOutputTab(Shim shim, Commands commands, EventBus events)
    {
-      super("Source Cpp", shim);
+      super(constants_.sourceCppTitle(), shim);
       GWT.<Binder>create(Binder.class).bind(commands, shim);
 
       events.addHandler(SourceCppStartedEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/tests/TestsOutputPresenter.java
Patch:
@@ -54,7 +54,7 @@ public TestsOutputPresenter(CompileOutputPaneFactory outputFactory,
                                Commands commands,
                                EventBus events)
    {
-      super(outputFactory.create("Tests",
+      super(outputFactory.create(constants_.testsTaskName(),
                                  constants_.viewTestResultsTitle()));
       view_ = (CompileOutputPaneDisplay) getView();
       view_.setHasLogs(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/tests/TestsOutputTab.java
Patch:
@@ -54,7 +54,7 @@ public TestsOutputTab(Shim shim,
                          EventBus events,
                          final Session session)
    {
-      super("Tests", shim);
+      super(constants_.testsTaskName(), shim);
       shim_ = shim;
 
       events.addHandler(BuildStartedEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -88,13 +88,12 @@ public PackagesPane(Commands commands,
                        GlobalDisplay display,
                        EventBus events)
    {
-      super("Packages", events);
+      super(constants_.packagesTitle(), events);
       commands_ = commands;
       session_ = session;
       display_ = display;
       
-      dataGridRes_ = (PackagesDataGridResources) 
-            GWT.create(PackagesDataGridResources.class);
+      dataGridRes_ = GWT.create(PackagesDataGridResources.class);
       ensureWidget();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesTab.java
Patch:
@@ -52,7 +52,7 @@ public PackagesTab(Shim shim,
                       UserPrefs uiPrefs,
                       Session session)
    {
-      super("Packages", shim);
+      super(constants_.packagesTitle(), shim);
       binder.bind(commands, shim);
       events.addHandler(LoadedPackageUpdatesEvent.TYPE, shim);
       events.addHandler(RaisePackagePaneEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -51,7 +51,7 @@ public class PlotsPane extends WorkbenchPane implements Plots.Display,
    public PlotsPane(Commands commands, EventBus events, PlotsServerOperations server,
          DependencyManager dependencies)
    {
-      super("Plots", events);
+      super(constants_.plotsTitle(), events);
       commands_ = commands;
       server_ = server;
       dependencies_ = dependencies;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsTab.java
Patch:
@@ -98,7 +98,7 @@ public PlotsTab(PlotsShim shim,
                    Commands commands,
                    PlotsServerOperations server)
    {
-      super("Plots", shim);
+      super(constants_.plotsTitle(), shim);
       binder.bind(commands, shim);
       commands_ = commands;
       shim_ = shim;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationPane.java
Patch:
@@ -64,7 +64,7 @@ public class PresentationPane extends WorkbenchPane implements Presentation.Disp
    public PresentationPane(Commands commands, Session session,
          PresentationServerOperations server, GlobalDisplay display)
    {
-      super("Presentation");
+      super(constants_.presentationTitle());
       commands_ = commands;
       session_ = session;
       server_ = server;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation2/Presentation2Pane.java
Patch:
@@ -18,7 +18,6 @@
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.URIConstants;
 import org.rstudio.core.client.URIUtils;
-import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.RStudioFrame;
@@ -64,7 +63,7 @@ public Presentation2Pane(Commands commands, ApplicationServerOperations server)
       // This should always be title "Presentation" (rather than the name of the underlying
       // tab "Presentations". The proper name is "Presentation", we just used
       // "Presentations" so the configurations wouldn't conflict.
-      super("Presentation");
+      super(constants_.presentationTitle());
       commands_ = commands;
       server_ = server;
       ensureWidget();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation2/Presentation2Tab.java
Patch:
@@ -60,7 +60,7 @@ public Presentation2Tab(Shim shim, Binder binder, Session session, Commands comm
       // This should always be title "Presentation" (rather than the name of the underlying
       // tab "Presentations". The proper name is "Presentation", we just used
       // "Presentations" so the configurations wouldn't conflict.
-      super("Presentation", shim);
+      super(constants_.presentationTitle(), shim);
       session_ = session;
       binder.bind(commands, shim);
       eventBus.addHandler(PresentationPreviewEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -123,6 +123,7 @@
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.snippets.model.SnippetsChangedEvent;
+import org.rstudio.studio.client.workbench.ui.PaneManager;
 import org.rstudio.studio.client.workbench.ui.unsaved.UnsavedChangesDialog;
 import org.rstudio.studio.client.workbench.views.console.shell.editor.InputEditorDisplay;
 import org.rstudio.studio.client.workbench.views.console.shell.events.SuppressNextShellFocusEvent;
@@ -1417,7 +1418,7 @@ public void onLayoutZoomSource()
             public void execute()
             {
                events_.fireEvent(new ZoomPaneEvent(columnManager_.getActive().getName(),
-                  "SourceColumn"));
+                  PaneManager.SOURCE_COLUMN));
             }
          });
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -91,7 +91,7 @@ protected TerminalPane(EventBus events,
                           WorkbenchContext workbenchContext,
                           WorkbenchServerOperations server)
    {
-      super("Terminal", events);
+      super(constants_.terminalText(), events);
       globalDisplay_ = globalDisplay;
       commands_ = commands;
       uiPrefs_ = uiPrefs;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTab.java
Patch:
@@ -106,7 +106,7 @@ public TerminalTab(Shim shim,
                       Provider<ConsoleProcessFactory> pConsoleProcessFactory,
                       final Session session)
    {
-      super("Terminal", shim);
+      super(constants_.terminalText(), shim);
       shim_ = shim;
       pConsoleProcessFactory_ = pConsoleProcessFactory;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPane.java
Patch:
@@ -73,7 +73,7 @@ protected TutorialPane(GlobalDisplay globalDisplay,
                           DependencyManager dependencies,
                           TutorialServerOperations server)
    {
-      super("Tutorial", events);
+      super(constants_.tutorialTitle(), events);
 
       globalDisplay_ = globalDisplay;
       commands_      = commands;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialTab.java
Patch:
@@ -27,7 +27,7 @@ public abstract static class Shim
    @Inject
    public TutorialTab(Shim shim)
    {
-      super("Tutorial", shim);
+      super(constants_.tutorialTitle(), shim);
       shim_ = shim;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -67,7 +67,7 @@ public ViewerPane(Commands commands,
                      Provider<UserState> pUserState,
                      HtmlMessageListener htmlMessageListener)
    {
-      super("Viewer", events);
+      super(constants_.viewerTitle(), events);
       commands_ = commands;
       globalDisplay_ = globalDisplay;
       server_ = server;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerTab.java
Patch:
@@ -37,7 +37,7 @@ public abstract static class Shim
    @Inject
    public ViewerTab(Shim shim, Session session, EventBus eventBus)
    {
-      super("Viewer", shim);
+      super(constants_.viewerTitle(), shim);
       session_ = session;
 
       eventBus.addHandler(ViewerNavigateEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/common/vcs/CreateKeyDialog.java
Patch:
@@ -146,7 +146,7 @@ protected CreateKeyOptions collectInput()
          return null;
       else
          return CreateKeyOptions.create(rsaSshKeyPath_.getPath(),
-                                        "rsa",
+                                        sshKeyType_.getValue(),
                                         getPassphrase(),
                                         false);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -498,7 +498,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
    protected void initialize(UserPrefs prefs)
    {
       lineEndings_.setValue(prefs.lineEndingConversion().getValue());
-      useNativePipe_.setValue(prefs.insertNativePipeOperator().getValue());
+      useNativePipe_.setValue(prefs.insertNativePipeOperator().getGlobalValue());
       showCompletions_.setValue(prefs_.codeCompletion().getValue());
       showCompletionsOther_.setValue(prefs_.codeCompletionOther().getValue());
       editorMode_.setValue(prefs_.editorKeybindings().getValue());

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectEditingPreferencesPane.java
Patch:
@@ -24,8 +24,8 @@
 import org.rstudio.core.client.widget.FormLabel;
 import org.rstudio.core.client.widget.LayoutGrid;
 import org.rstudio.core.client.widget.NumericValueWidget;
-import org.rstudio.core.client.widget.TextBoxWithButton;
 import org.rstudio.core.client.widget.OperationWithInput;
+import org.rstudio.core.client.widget.TextBoxWithButton;
 import org.rstudio.studio.client.common.SimpleRequestCallback;
 import org.rstudio.studio.client.projects.StudioClientProjectConstants;
 import org.rstudio.studio.client.projects.model.RProjectConfig;

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectEditingPreferencesPane.java
Patch:
@@ -31,7 +31,6 @@
 import org.rstudio.studio.client.workbench.prefs.model.ProjectPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.views.LineEndingsSelectWidget;
-import org.rstudio.studio.client.workbench.prefs.views.UseNativePipeOperatorSelectWidget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.IconvListResult;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.ChooseEncodingDialog;
 import org.rstudio.studio.client.workbench.views.source.model.SourceServerOperations;

File: src/gwt/src/org/rstudio/core/client/theme/ThemeFonts.java
Patch:
@@ -34,7 +34,7 @@ public static String getProportionalFont()
 
    public static String getFixedWidthFont()
    {
-      return fontLoader.getFixedWidthFont();
+      return fontLoader.getFixedWidthFont() + ", monospace";
    }
 
    static interface ThemeFontLoader

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/PrefsConstants.java
Patch:
@@ -1698,11 +1698,11 @@ public interface PrefsConstants extends com.google.gwt.i18n.client.Messages {
     String englishLabel();
 
     /**
-     * Translated "French".
+     * Translated "French (Franais)".
      *
-     * @return translated "French"
+     * @return translated "French (Franais)"
      */
-    @DefaultMessage("French")
+    @DefaultMessage("French (Franais)")
     @Key("frenchLabel")
     String frenchLabel();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/CommitListTable.java
Patch:
@@ -20,7 +20,6 @@
 import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.i18n.client.DateTimeFormat;
-import com.google.gwt.i18n.client.DateTimeFormat.PredefinedFormat;
 import com.google.gwt.safehtml.shared.SafeHtml;
 import com.google.gwt.safehtml.shared.SafeHtmlBuilder;
 import com.google.gwt.text.shared.SafeHtmlRenderer;
@@ -217,8 +216,7 @@ public String getValue(CommitInfo object)
          @Override
          public String getValue(CommitInfo object)
          {
-            return DateTimeFormat.getFormat(
-                  PredefinedFormat.DATE_SHORT).format(object.getDate());
+            return yearMonthDayFormat.format(object.getDate());
          }
       };
       addColumn(dateCol, constants_.dateCapitalized());
@@ -326,4 +324,5 @@ public void setAutoSelectFirstRow(boolean autoSelect)
    private GraphTheme graphTheme_;
    private boolean autoSelectFirstRow_ = true;
    private static final ViewVcsConstants constants_ = GWT.create(ViewVcsConstants.class);
+   private static final DateTimeFormat yearMonthDayFormat = DateTimeFormat.getFormat("yyyy-MM-dd");
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputFrame.java
Patch:
@@ -39,6 +39,8 @@ public void run()
 
       getElement().getStyle().setProperty("pointerEvents", "none");
       getElement().getStyle().setProperty("opacity", "0.7");
+      getElement().getStyle().setProperty("border", "1px dashed rgb(128,128,128,25%)");
+      getElement().getStyle().setProperty("borderRadius", "4px");
    }
 
    void loadUrl(String url, Command onCompleted)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -324,7 +324,7 @@ public void onClick(ClickEvent event)
             useGpuDriverBugWorkarounds_.setValue(!disable);
          });
 
-         if (BrowseCap.isLinuxDesktop())
+         if (BrowseCap.isLinuxDesktop() && !BrowseCap.isElectron())
          {
             clipboardMonitoring_ = new CheckBox(constants_.clipboardMonitoringLabel());
             advanced.add(lessSpaced(clipboardMonitoring_));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindInFilesServerOperations.java
Patch:
@@ -26,6 +26,8 @@ void beginFind(String searchString,
                   boolean ignoreCase,
                   FileSystemItem directory,
                   JsArrayString includeFilePatterns,
+                  boolean useGitGrep, 
+                  boolean excludeGitIgnore,
                   JsArrayString excludeFilePatterns,
                   ServerRequestCallback<String> requestCallback);
 

File: src/gwt/src/org/rstudio/core/client/IntervalTracker.java
Patch:
@@ -28,7 +28,7 @@ public void reset()
       lastTime_ = System.currentTimeMillis();
    }
 
-   // alternate verison of reset which will prevent subsequent checks
+   // alternate version of reset which will prevent subsequent checks
    // for only the duration specified (rather than the full intervalMillis)
    public void reset(long preventMillis)
    {

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -1034,7 +1034,7 @@ private void collectShortcuts()
       {
          @Override
          public void execute() {
-            // run the final comands in order after loading has been completed
+            // run the final commands in order after loading has been completed
             queue.run();
          }
       });

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/CmdConstants.java
Patch:
@@ -939,7 +939,7 @@ public interface CmdConstants extends Constants {
     String quickAddNextButtonLabel();
     @DefaultStringValue("Find and Add Next") // $NON-NLS-1$
     String quickAddNextMenuLabel();
-    @DefaultStringValue("Find and add next occurence") // $NON-NLS-1$
+    @DefaultStringValue("Find and add next occurrence") // $NON-NLS-1$
     String quickAddNextDesc();
     
     // findAll
@@ -953,7 +953,7 @@ public interface CmdConstants extends Constants {
     String findReplaceMenuLabel();
     
     // findNext
-    @DefaultStringValue("Find Next Occurence") // $NON-NLS-1$
+    @DefaultStringValue("Find Next Occurrence") // $NON-NLS-1$
     String findNextLabel();
     @DefaultStringValue("Next") // $NON-NLS-1$
     String findNextButtonLabel();
@@ -963,7 +963,7 @@ public interface CmdConstants extends Constants {
     String findNextDesc();
     
     // findPrevious
-    @DefaultStringValue("Find Previous Occurence") // $NON-NLS-1$
+    @DefaultStringValue("Find Previous Occurrence") // $NON-NLS-1$
     String findPreviousLabel();
     @DefaultStringValue("Prev") // $NON-NLS-1$
     String findPreviousButtonLabel();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -126,7 +126,7 @@ protected Widget createMainWidget()
       panel_.setWidgetLeftRight(frame_, 0, Unit.PX, 0, Unit.PX);
 
       // Provide a widget container where adornments can be added on top of the
-      // plots panel (e.g. manipulator button). Hidden initially so it doens't
+      // plots panel (e.g. manipulator button). Hidden initially so it doesn't
       // block context menu actions such as Copy Image.
       plotsSurface_ = new PlotsSurface(panel_);
       panel_.add(plotsSurface_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputFrame.java
Patch:
@@ -39,6 +39,8 @@ public void run()
 
       getElement().getStyle().setProperty("pointerEvents", "none");
       getElement().getStyle().setProperty("opacity", "0.7");
+      getElement().getStyle().setProperty("border", "1px dashed rgb(128,128,128,25%)");
+      getElement().getStyle().setProperty("borderRadius", "4px");
    }
 
    void loadUrl(String url, Command onCompleted)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetPackageDependencyHelper.java
Patch:
@@ -112,7 +112,8 @@ public void discoverPackageDependencies()
       boolean canDiscoverDependencies =
             docDisplay_.getFileType().isR() ||
             docDisplay_.getFileType().isRmd() ||
-            docDisplay_.getFileType().isRnw();
+            docDisplay_.getFileType().isRnw() ||
+            docDisplay_.getFileType().isQuartoMarkdown();
       
       if (!canDiscoverDependencies)
          return;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetPackageDependencyHelper.java
Patch:
@@ -112,7 +112,8 @@ public void discoverPackageDependencies()
       boolean canDiscoverDependencies =
             docDisplay_.getFileType().isR() ||
             docDisplay_.getFileType().isRmd() ||
-            docDisplay_.getFileType().isRnw();
+            docDisplay_.getFileType().isRnw() ||
+            docDisplay_.getFileType().isQuartoMarkdown();
       
       if (!canDiscoverDependencies)
          return;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -620,10 +620,10 @@ private void initializeGraphicsBackendWidget()
       });
    }
 
-   private static final String ENGINE_AUTO        = constants_.engineAutoValue();
-   private static final String ENGINE_DESKTOP     = constants_.engineDesktopValue();
+   private static final String ENGINE_AUTO        = "auto";
+   private static final String ENGINE_DESKTOP     = "desktop";
    private static final String ENGINE_GLES        = "gles";
-   private static final String ENGINE_SOFTWARE    = constants_.engineSoftwareValue();
+   private static final String ENGINE_SOFTWARE    = "software";
 
    private boolean desktopMonitoring_ = false;
    private boolean desktopIgnoreGpuExclusions_ = false;

File: src/gwt/src/org/rstudio/core/client/theme/ThemeFonts.java
Patch:
@@ -34,7 +34,7 @@ public static String getProportionalFont()
 
    public static String getFixedWidthFont()
    {
-      return fontLoader.getFixedWidthFont() + ", monospace";
+      return fontLoader.getFixedWidthFont();
    }
 
    static interface ThemeFontLoader

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AceEditorPreview.java
Patch:
@@ -171,10 +171,11 @@ public void setFont(String font, boolean webFont)
          webFont_ = font;
       }
 
+      String quotedFont = font.startsWith("\"") && font.endsWith("\"") ? font : "\"" + font + "\"";
       StyleElement style = document.createStyleElement();
       style.setAttribute("type", "text/css");
       style.setInnerText(".ace_editor, .ace_text-layer {\n" +
-                         "font-family: \"" + font + "\" !important;\n" +
+                         "font-family: " + quotedFont + ", monospace !important;\n" +
                          "}");
 
       document.getBody().appendChild(style);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -167,6 +167,7 @@ public void onClick(ClickEvent event)
       displayPanel.add(checkboxPref(constants_.displayHighlightSelectedWordLabel(), prefs_.highlightSelectedWord()));
       displayPanel.add(checkboxPref(constants_.displayHighlightSelectedLineLabel(), prefs_.highlightSelectedLine()));
       displayPanel.add(checkboxPref(constants_.displayShowLineNumbersLabel(), prefs_.showLineNumbers()));
+      displayPanel.add(checkboxPref(constants_.displayRelativeLineNumbersLabel(), prefs_.relativeLineNumbers()));
       displayPanel.add(tight(showMargin_ = checkboxPref(constants_.displayShowMarginLabel(), prefs_.showMargin(), false /*defaultSpace*/)));
       displayPanel.add(indent(marginCol_ = numericPref(prefs_.marginColumn())));
       displayPanel.add(checkboxPref(constants_.displayShowInvisiblesLabel(), prefs_.showInvisibles()));

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -335,7 +335,7 @@ public void onClick(ClickEvent event)
             });
          }
 
-         fullPathInTitle_ = new CheckBox(constants_.clipboardMonitoringLabel());
+         fullPathInTitle_ = new CheckBox(constants_.fullProjectPathInWindowTitleLabel());
          advanced.add(lessSpaced(fullPathInTitle_));
       }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -186,6 +186,7 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
    void setHighlightSelectedLine(boolean on);
    void setHighlightSelectedWord(boolean on);
    void setShowLineNumbers(boolean on);
+   void setRelativeLineNumbers(boolean relative);
    void setUseSoftTabs(boolean on);
    void setUseWrapMode(boolean on);
    boolean getUseWrapMode();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/yaml/YamlEditorContext.java
Patch:
@@ -90,7 +90,8 @@ private static native YamlEditorContext create(
         line: line, 
         code: code,
         position: position,
-        explicit: explicit
+        explicit: explicit,
+        client: "rstudio"
      };
   }-*/;
    

File: src/gwt/src/org/rstudio/core/client/theme/ThemeFonts.java
Patch:
@@ -34,7 +34,7 @@ public static String getProportionalFont()
 
    public static String getFixedWidthFont()
    {
-      return fontLoader.getFixedWidthFont() + ", monospace";
+      return fontLoader.getFixedWidthFont();
    }
 
    static interface ThemeFontLoader

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AceEditorPreview.java
Patch:
@@ -171,10 +171,11 @@ public void setFont(String font, boolean webFont)
          webFont_ = font;
       }
 
+      String quotedFont = font.startsWith("\"") && font.endsWith("\"") ? font : "\"" + font + "\"";
       StyleElement style = document.createStyleElement();
       style.setAttribute("type", "text/css");
       style.setInnerText(".ace_editor, .ace_text-layer {\n" +
-                         "font-family: \"" + font + "\" !important;\n" +
+                         "font-family: " + quotedFont + ", monospace !important;\n" +
                          "}");
 
       document.getBody().appendChild(style);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -335,7 +335,7 @@ public void onClick(ClickEvent event)
             });
          }
 
-         fullPathInTitle_ = new CheckBox(constants_.clipboardMonitoringLabel());
+         fullPathInTitle_ = new CheckBox(constants_.fullProjectPathInWindowTitleLabel());
          advanced.add(lessSpaced(fullPathInTitle_));
       }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -335,7 +335,7 @@ public void onClick(ClickEvent event)
             });
          }
 
-         fullPathInTitle_ = new CheckBox(constants_.clipboardMonitoringLabel());
+         fullPathInTitle_ = new CheckBox(constants_.fullProjectPathInWindowTitleLabel());
          advanced.add(lessSpaced(fullPathInTitle_));
       }
 

File: src/gwt/src/org/rstudio/studio/client/application/model/ApplicationServerOperations.java
Patch:
@@ -111,4 +111,6 @@ void deleteSessionDir(String sessionId,
    
    void findProjectInFolder(String folder,
          ServerRequestCallback<String> requestCallback);
+
+   void getRVersion(ServerRequestCallback<RVersionSpec> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/application/model/ApplicationServerOperations.java
Patch:
@@ -112,5 +112,5 @@ void deleteSessionDir(String sessionId,
    void findProjectInFolder(String folder,
          ServerRequestCallback<String> requestCallback);
 
-   String getRVersion(ServerRequestCallback<RVersionSpec> requestCallback);
+   void getRVersion(ServerRequestCallback<RVersionSpec> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleInterpreterVersion.java
Patch:
@@ -169,7 +169,7 @@ else if (StringUtil.equals(type, ReticulateEvent.TYPE_REPL_TEARDOWN))
    }
    
    
-   private String rVersionLabel()
+   public String rVersionLabel()
    {
       String version = constants_.unknownLabel();
       

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -156,6 +156,7 @@
 import org.rstudio.studio.client.workbench.views.connections.ui.ConnectionsPane;
 import org.rstudio.studio.client.workbench.views.console.ConsolePane;
 import org.rstudio.studio.client.workbench.views.console.model.ConsoleServerOperations;
+import org.rstudio.studio.client.workbench.views.console.model.VirtualConsoleServerOperations;
 import org.rstudio.studio.client.workbench.views.console.shell.Shell;
 import org.rstudio.studio.client.workbench.views.console.shell.ShellPane;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.HelpStrategy;
@@ -435,6 +436,7 @@ protected void configure()
       bind(ChooseFileServerOperations.class).to(RemoteServer.class);
       bind(CodeToolsServerOperations.class).to(RemoteServer.class);
       bind(ConsoleServerOperations.class).to(RemoteServer.class);
+      bind(VirtualConsoleServerOperations.class).to(RemoteServer.class);
       bind(SourceServerOperations.class).to(RemoteServer.class);
       bind(FilesServerOperations.class).to(RemoteServer.class);
       bind(HistoryServerOperations.class).to(RemoteServer.class);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/model/ConsoleServerOperations.java
Patch:
@@ -21,7 +21,8 @@
 import org.rstudio.studio.client.workbench.views.history.model.HistoryServerOperations;
 
 public interface ConsoleServerOperations extends CodeToolsServerOperations,
-                                                 HistoryServerOperations
+                                                 HistoryServerOperations, 
+                                                 VirtualConsoleServerOperations
 {
    // adapt to the language of code being sent to console
    void adaptToLanguage(String language,

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -156,6 +156,7 @@
 import org.rstudio.studio.client.workbench.views.connections.ui.ConnectionsPane;
 import org.rstudio.studio.client.workbench.views.console.ConsolePane;
 import org.rstudio.studio.client.workbench.views.console.model.ConsoleServerOperations;
+import org.rstudio.studio.client.workbench.views.console.model.VirtualConsoleServerOperations;
 import org.rstudio.studio.client.workbench.views.console.shell.Shell;
 import org.rstudio.studio.client.workbench.views.console.shell.ShellPane;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.HelpStrategy;
@@ -435,6 +436,7 @@ protected void configure()
       bind(ChooseFileServerOperations.class).to(RemoteServer.class);
       bind(CodeToolsServerOperations.class).to(RemoteServer.class);
       bind(ConsoleServerOperations.class).to(RemoteServer.class);
+      bind(VirtualConsoleServerOperations.class).to(RemoteServer.class);
       bind(SourceServerOperations.class).to(RemoteServer.class);
       bind(FilesServerOperations.class).to(RemoteServer.class);
       bind(HistoryServerOperations.class).to(RemoteServer.class);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/model/ConsoleServerOperations.java
Patch:
@@ -21,7 +21,8 @@
 import org.rstudio.studio.client.workbench.views.history.model.HistoryServerOperations;
 
 public interface ConsoleServerOperations extends CodeToolsServerOperations,
-                                                 HistoryServerOperations
+                                                 HistoryServerOperations, 
+                                                 VirtualConsoleServerOperations
 {
    // adapt to the language of code being sent to console
    void adaptToLanguage(String language,

File: src/gwt/src/org/rstudio/studio/client/workbench/MRUList.java
Patch:
@@ -19,10 +19,10 @@
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.command.AppMenuItem;
 import org.rstudio.core.client.command.CommandHandler;
-import org.rstudio.core.client.command.impl.DesktopMenuCallback;
 import org.rstudio.core.client.widget.OperationWithInput;
 
-import java.util.*;
+import java.util.ArrayList;
+import java.util.List;
 
 public class MRUList
 {
@@ -129,7 +129,6 @@ private void updateCommands()
       if (hideClearOnEmpty_)
          clearCommand_.setVisible(clearCommand_.isEnabled());
       manageCommands(mruEntries_, mruCmds_);
-      DesktopMenuCallback.commitCommandShortcuts();
    }
 
    protected void manageCommands(List<String> entries, AppCommand[] commands)

File: src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerItemCodec.java
Patch:
@@ -98,6 +98,7 @@ public TableRowElement getRowForItem(SourceMarker entry)
       tdMsg.setClassName(resources_.styles().messageCell());
 
       VirtualConsole vc = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(tdMsg);
+      vc.setPreserveHTML(true);
       vc.submit(entry.getMessage());
 
       tr.appendChild(tdMsg);

File: src/gwt/src/org/rstudio/studio/client/workbench/MRUList.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.command.AppMenuItem;
 import org.rstudio.core.client.command.CommandHandler;
+import org.rstudio.core.client.command.impl.DesktopMenuCallback;
 import org.rstudio.core.client.widget.OperationWithInput;
 
 import java.util.*;
@@ -128,6 +129,7 @@ private void updateCommands()
       if (hideClearOnEmpty_)
          clearCommand_.setVisible(clearCommand_.isEnabled());
       manageCommands(mruEntries_, mruCmds_);
+      DesktopMenuCallback.commitCommandShortcuts();
    }
 
    protected void manageCommands(List<String> entries, AppCommand[] commands)

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryNavigationPage.java
Patch:
@@ -86,8 +86,7 @@ public Widget createMainWidget(ArrayList<WizardPage<NewProjectInput, NewProjectR
       if (sessionInfo.getQuartoConfig().enabled) {
          pages.add(new NewQuartoDefaultProjectPage());
          pages.add(new NewQuartoWebsiteProjectPage());
-         // blog commented out until quarto blogs are available in cll
-         // pages.add(new NewQuartoBlogProjectPage());
+         pages.add(new NewQuartoBlogProjectPage());
          pages.add(new NewQuartoBookProjectPage());
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/MRUList.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.command.AppMenuItem;
 import org.rstudio.core.client.command.CommandHandler;
+import org.rstudio.core.client.command.impl.DesktopMenuCallback;
 import org.rstudio.core.client.widget.OperationWithInput;
 
 import java.util.*;
@@ -128,6 +129,7 @@ private void updateCommands()
       if (hideClearOnEmpty_)
          clearCommand_.setVisible(clearCommand_.isEnabled());
       manageCommands(mruEntries_, mruCmds_);
+      DesktopMenuCallback.commitCommandShortcuts();
    }
 
    protected void manageCommands(List<String> entries, AppCommand[] commands)

File: src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerItemCodec.java
Patch:
@@ -98,6 +98,7 @@ public TableRowElement getRowForItem(SourceMarker entry)
       tdMsg.setClassName(resources_.styles().messageCell());
 
       VirtualConsole vc = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(tdMsg);
+      vc.setPreserveHTML(true);
       vc.submit(entry.getMessage());
 
       tr.appendChild(tdMsg);

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPreferencesDialogResources.java
Patch:
@@ -41,6 +41,7 @@ interface Styles extends CssResource
       String buildToolsRoxygenize();
       String buildToolsCheckBox();
       String buildToolsDevtools();
+      String buildToolsCleanBeforeInstall();
       String previewWebsite();
       String directorySelector();
       String websiteOutputFormat();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildCommands.java
Patch:
@@ -52,10 +52,9 @@ public static void setBuildCommandState(Commands commands,
       }
       
       // remove makefile commands if this isn't a makefile
-      if (type == SessionInfo.BUILD_TOOLS_CUSTOM ||
-          type == SessionInfo.BUILD_TOOLS_WEBSITE ||
-          type == SessionInfo.BUILD_TOOLS_QUARTO)
+      if (type != SessionInfo.BUILD_TOOLS_MAKEFILE)
       {
+         // TODO: should probably just be called "Make"
          commands.rebuildAll().remove();
       }
       

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -236,6 +236,8 @@ public static String idWithPrefix(String prefix, String id)
    public static String getNewRmdTitle() { return getElementId(NEW_RMD_TITLE); }
    public final static String NEW_RMD_AUTHOR = "new_rmd_author";
    public static String getNewRmdAuthor() { return getElementId(NEW_RMD_AUTHOR); }
+   public final static String NEW_RMD_DATE = "new_rmd_date";
+   public static String getNewRmdDate() { return getElementId(NEW_RMD_DATE); }
    public final static String NEW_RMD_TEMPLATE_LABEL = "new_rmd_template_label";
    public static String getNewRmdTemplateLabel() { return getElementId(NEW_RMD_TEMPLATE_LABEL); }
    public final static String NEW_RMD_TEMPLATE = "new_rmd_template";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/StanCompletionManager.java
Patch:
@@ -114,8 +114,8 @@ public boolean getCompletions(String line, CompletionRequestContext context)
    }
    
    @Override
-   protected void addExtraCompletions(String token,
-                                      List<QualifiedName> completions)
+   public void addExtraCompletions(String token,
+                                   List<QualifiedName> completions)
    {
       Set<String> discoveredIdentifiers = new HashSet<>();
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -253,6 +253,8 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
 
    Position getCursorPosition();
    void setCursorPosition(Position position);
+   int getCursorRow();
+   int getCursorColumn();
 
    Position getCursorPositionScreen();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -222,6 +222,8 @@ public void onPreviewReplace(PreviewReplaceEvent event)
             for (String pattern : dialogState_.getExcludeFilePatterns())
                excludeFilePatterns.push(pattern);
 
+            // this event is only ever triggered when dialogState_.isRegex() is true
+            // so we don't need to check for and handle dialogState_.isWholeWord() here
             server_.previewReplace(dialogState_.getQuery(),
                                    dialogState_.isRegex(),
                                    !dialogState_.isCaseSensitive(),

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -324,6 +324,7 @@ public enum TextBoxButtonId
       PRIMARY_CRAN("primary_cran"),
       PRO_JOB_DIR("pro_job_dir"),
       PRO_JOB_SCRIPT("pro_job_script"),
+      PRO_R_HOME("job_launcher_pro_r_home"),
       PRO_NEW_SESSION_DIR("pro_new_session_dir"),
       PROJECT_PARENT("project_parent"),
       PROJECT_REPO_DIR("project_repo_dir"),

File: src/gwt/src/org/rstudio/core/client/widget/SelectWidget.java
Patch:
@@ -121,6 +121,7 @@ public SelectWidget(String label,
          values = options;
 
       listBox_ = new ListBox();
+      listBox_.getElement().getStyle().setProperty("minHeight", "20px");
       listBox_.setMultipleSelect(isMultipleSelect);
 
       // set the element ID if one is provided, otherwise let it get auto generated

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -369,6 +369,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
       Label diagOtherLabel = headerLabel(constants_.editingOtherLabel());
       diagnosticsPanel.add(spacedBefore(diagOtherLabel));
       diagnosticsPanel.add(checkboxPref(prefs_.showDiagnosticsCpp()));
+      diagnosticsPanel.add(checkboxPref(prefs_.showDiagnosticsYaml()));
       diagnosticsPanel.add(checkboxPref(prefs_.showDiagnosticsOther()));
 
       Label diagShowLabel = headerLabel(constants_.editingDiagShowLabel());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -467,10 +467,10 @@ public void execute()
          {
             if (event.shouldExecute())
             {
-               processCommandEntry(event.getCode(), event.shouldEcho());
+               String commandText = event.shouldEcho() ? view_.processCommandEntry() : event.getCode();
+               processCommandEntry(commandText, event.shouldEcho());
 
-               if (previousInput.length() > 0)
-                  display.setText(previousInput);
+               display.setText(previousInput);
             }
 
             if (!event.shouldExecute() || event.shouldFocus())

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/LintManager.java
Patch:
@@ -312,7 +312,7 @@ public void onResponseReceived(JsArray<LintItem> lint)
                         docDisplay_.getFileType().isR();                  
                   if ((isRmd || isRmdRChunk) && userPrefs_.showDiagnosticsYaml().getValue())
                   {
-                     yamlLinter_.getLint(yamlLint -> {
+                     yamlLinter_.getLint(context.explicit, yamlLint -> {
                         JsArray<LintItem> allLint = JsArray.createArray().cast();
                         for (int i = 0; i < lint.length(); i++)
                            allLint.push(lint.get(i));
@@ -337,7 +337,7 @@ public void onError(ServerError error)
    
    private void performYamlLintRequest(final LintContext context)
    {
-      yamlLinter_.getLint(lint -> {
+      yamlLinter_.getLint(context.explicit, lint -> {
          showLint(context, lint, false);
       });
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/yaml/YamlCompletionManager.java
Patch:
@@ -88,7 +88,7 @@ public boolean getCompletions(String line, CompletionRequestContext context)
          return false;
       
       // call for completions
-      YamlEditorContext editorContext = YamlEditorContext.create(context_, docDisplay_);
+      YamlEditorContext editorContext = YamlEditorContext.create(true, context_, docDisplay_);
       provider.getCompletions(editorContext, (res) -> {
          
          // default "empty" completion response

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/yaml/YamlDocumentLinter.java
Patch:
@@ -33,7 +33,7 @@ public YamlDocumentLinter(CompletionContext context, DocDisplay docDisplay)
       docDisplay_ = docDisplay;
    }
    
-   public void getLint(CommandWithArg<JsArray<LintItem>> ready)
+   public void getLint(boolean explicit, CommandWithArg<JsArray<LintItem>> ready)
    {
       // do we have a provider that can handle this context
       YamlEditorToolsProvider provider = providers_.getActiveProvider(
@@ -46,7 +46,7 @@ public void getLint(CommandWithArg<JsArray<LintItem>> ready)
       }
       
       // request lint
-      YamlEditorContext editorContext = YamlEditorContext.create(context_, docDisplay_);
+      YamlEditorContext editorContext = YamlEditorContext.create(explicit, context_, docDisplay_);
       provider.getLint(editorContext, (res) -> {
          if (res != null)
          {

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -240,6 +240,8 @@ public static String idWithPrefix(String prefix, String id)
    public static String getNewRmdTemplateLabel() { return getElementId(NEW_RMD_TEMPLATE_LABEL); }
    public final static String NEW_RMD_TEMPLATE = "new_rmd_template";
    public static String getNewRmdTemplate() { return getElementId(NEW_RMD_TEMPLATE); }
+   public final static String NEW_RMD_AUTO_DATE = "new_rmd_auto_date";
+   public static String getNewRmdAutoDate() { return getElementId(NEW_RMD_AUTO_DATE); }
 
    // RmdTemplateChooser
    public final static String RMD_TEMPLATE_CHOOSER_NAME = "rmd_template_chooser_name";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -1172,7 +1172,7 @@ public void execute(RMarkdownContext context)
                server_,
                context,
                workbenchContext_,
-               prefs_.documentAuthor().getGlobalValue(),
+               prefs_,
                onComplete).showModal();
          }
       });

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -183,6 +183,7 @@ public static String idWithPrefix(String prefix, String id)
 
    public final static String PACKAGE_MANAGEMENT_PREFS = "package_management_prefs";
    public final static String PACKAGE_DEVELOPMENT_PREFS = "package_development_prefs";
+   public final static String PACKAGE_CPP_PREFS = "package_cpp_prefs";
 
    public final static String TERMINAL_GENERAL_PREFS = "terminal_general_prefs";
    public final static String TERMINAL_CLOSING_PREFS = "terminal_closing_prefs";

File: src/gwt/src/org/rstudio/studio/client/application/ui/RequestLogDetail.java
Patch:
@@ -14,13 +14,11 @@
  */
 package org.rstudio.studio.client.application.ui;
 
-import com.google.gwt.core.client.GWT;
 import com.google.gwt.dom.client.Style.Overflow;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.FlowPanel;
 import com.google.gwt.user.client.ui.HTML;
 import org.rstudio.core.client.jsonrpc.RequestLogEntry;
-import org.rstudio.studio.client.application.StudioClientApplicationConstants;
 
 public class RequestLogDetail extends Composite
 {
@@ -59,5 +57,4 @@ public RequestLogDetail(RequestLogEntry entry)
 
       initWidget(panel);
    }
-   private static final StudioClientApplicationConstants constants_ = GWT.create(StudioClientApplicationConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewPackagePage.java
Patch:
@@ -92,7 +92,7 @@ protected boolean getOptionsSideBySide()
    protected void onAddTopPanelWidgets(HorizontalPanel panel)
    {
       String[] labels = {constants_.packageLabel()};
-      String[] values = {constants_.packageValue()};
+      String[] values = {"package"};
       listProjectType_ = new SelectWidget(constants_.typeLabel(),
                                           labels,
                                           values,

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewQuartoProjectPage.java
Patch:
@@ -137,7 +137,7 @@ protected void onAddBottomWidgets()
       ElementIds.assignElementId(chkUseVenv_,
          ElementIds.idWithPrefix(getTitle(), ElementIds.NEW_PROJECT_VENV));
       venvPanel_.add(chkUseVenv_);
-      chkUseCondaenv_ = new CheckBox("Use condaenv with packages:");
+      chkUseCondaenv_ = new CheckBox(constants_.useCondaenv());
       ElementIds.assignElementId(chkUseCondaenv_,
             ElementIds.idWithPrefix(getTitle(), ElementIds.NEW_PROJECT_CONDAENV));
       venvPanel_.add(chkUseCondaenv_);

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectSourceControlPreferencesPane.java
Patch:
@@ -186,7 +186,7 @@ private void updateOriginLabel()
          String originUrl = vcsContext_.getGitRemoteOriginUrl();
          if (originUrl.length() == 0)
             originUrl = NO_REMOTE_ORIGIN;
-         lblOrigin_.setOrigin(constants_.lblOrigin_(), originUrl);
+         lblOrigin_.setOrigin(constants_.lblOrigin(), originUrl);
          lblOrigin_.setVisible(true);
          vcsSelect_.removeStyleName(RES.styles().vcsSelectExtraSpaced());
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -245,9 +245,9 @@ public void onClick(ClickEvent event)
                   constants_.serverHomePageNeverOption()
             },
             new String[] {
-                  constants_.serverHomePageSessions(),
-                  constants_.serverHomePageAlways(),
-                  constants_.serverHomePageNever()
+                      "sessions",
+                      "always",
+                      "never"
             },
             false,
             true,

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewPackagePage.java
Patch:
@@ -92,7 +92,7 @@ protected boolean getOptionsSideBySide()
    protected void onAddTopPanelWidgets(HorizontalPanel panel)
    {
       String[] labels = {constants_.packageLabel()};
-      String[] values = {constants_.packageValue()};
+      String[] values = {"package"};
       listProjectType_ = new SelectWidget(constants_.typeLabel(),
                                           labels,
                                           values,

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -245,9 +245,9 @@ public void onClick(ClickEvent event)
                   constants_.serverHomePageNeverOption()
             },
             new String[] {
-                  constants_.serverHomePageSessions(),
-                  constants_.serverHomePageAlways(),
-                  constants_.serverHomePageNever()
+                      "sessions",
+                      "always",
+                      "never"
             },
             false,
             true,

File: src/gwt/src/org/rstudio/studio/client/application/ui/RequestLogDetail.java
Patch:
@@ -14,13 +14,11 @@
  */
 package org.rstudio.studio.client.application.ui;
 
-import com.google.gwt.core.client.GWT;
 import com.google.gwt.dom.client.Style.Overflow;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.FlowPanel;
 import com.google.gwt.user.client.ui.HTML;
 import org.rstudio.core.client.jsonrpc.RequestLogEntry;
-import org.rstudio.studio.client.application.StudioClientApplicationConstants;
 
 public class RequestLogDetail extends Composite
 {
@@ -59,5 +57,4 @@ public RequestLogDetail(RequestLogEntry entry)
 
       initWidget(panel);
    }
-   private static final StudioClientApplicationConstants constants_ = GWT.create(StudioClientApplicationConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewQuartoProjectPage.java
Patch:
@@ -137,7 +137,7 @@ protected void onAddBottomWidgets()
       ElementIds.assignElementId(chkUseVenv_,
          ElementIds.idWithPrefix(getTitle(), ElementIds.NEW_PROJECT_VENV));
       venvPanel_.add(chkUseVenv_);
-      chkUseCondaenv_ = new CheckBox("Use condaenv with packages:");
+      chkUseCondaenv_ = new CheckBox(constants_.useCondaenv());
       ElementIds.assignElementId(chkUseCondaenv_,
             ElementIds.idWithPrefix(getTitle(), ElementIds.NEW_PROJECT_CONDAENV));
       venvPanel_.add(chkUseCondaenv_);

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectSourceControlPreferencesPane.java
Patch:
@@ -186,7 +186,7 @@ private void updateOriginLabel()
          String originUrl = vcsContext_.getGitRemoteOriginUrl();
          if (originUrl.length() == 0)
             originUrl = NO_REMOTE_ORIGIN;
-         lblOrigin_.setOrigin(constants_.lblOrigin_(), originUrl);
+         lblOrigin_.setOrigin(constants_.lblOrigin(), originUrl);
          lblOrigin_.setVisible(true);
          vcsSelect_.removeStyleName(RES.styles().vcsSelectExtraSpaced());
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/findreplace/FindReplaceBar.java
Patch:
@@ -54,6 +54,7 @@ interface Resources extends ClientBundle
    interface Styles extends CssResource
    {
       String findReplaceBar();
+      String findTextBox();
       String replaceTextBox();
       String findPanel();
       String optionsPanel();
@@ -85,6 +86,7 @@ public FindReplaceBar(boolean showFindAll,
       HorizontalPanel findReplacePanel = new HorizontalPanel();
       findReplacePanel.addStyleName(RES.styles().findPanel());
       findReplacePanel.add(txtFind_ = new FindTextBox(constants_.findCapitalized()));
+      txtFind_.addStyleName(RES.styles().findTextBox());
       txtFind_.setIconVisible(true);
 
       Commands cmds = RStudioGinjector.INSTANCE.getCommands();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/findreplace/FindReplaceBar.java
Patch:
@@ -54,6 +54,7 @@ interface Resources extends ClientBundle
    interface Styles extends CssResource
    {
       String findReplaceBar();
+      String findTextBox();
       String replaceTextBox();
       String findPanel();
       String optionsPanel();
@@ -85,6 +86,7 @@ public FindReplaceBar(boolean showFindAll,
       HorizontalPanel findReplacePanel = new HorizontalPanel();
       findReplacePanel.addStyleName(RES.styles().findPanel());
       findReplacePanel.add(txtFind_ = new FindTextBox(constants_.findCapitalized()));
+      txtFind_.addStyleName(RES.styles().findTextBox());
       txtFind_.setIconVisible(true);
 
       Commands cmds = RStudioGinjector.INSTANCE.getCommands();

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoServerOperations.java
Patch:
@@ -25,6 +25,7 @@ public interface QuartoServerOperations
 {
    void quartoCapabilities(ServerRequestCallback<QuartoCapabilities> requestCallback);
    void quartoServe(String format, boolean render, ServerRequestCallback<Void> requestCallback);
+   void quartoServeRender(String file, ServerRequestCallback<Boolean> requestCallback);
    void quartoPreview(String file, 
                       String format, 
                       PresentationEditorLocation editorState,

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PaneLayoutPreferencesPane.java
Patch:
@@ -149,7 +149,7 @@ public ArrayList<String> getValue()
          ArrayList<String> value = new ArrayList<>();
          for (CheckBox checkBox : checkBoxes_)
          {
-            if (checkBox.getValue())
+            if (checkBox.getValue() && !StringUtil.equals(checkBox.getText(), "Presentation"))
                value.add(checkBox.getText());
          }
          return value;

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorEditImageDialog.java
Patch:
@@ -190,7 +190,7 @@ public PanmirrorEditImageDialog(PanmirrorImageProps props,
       }
       
       // alignment
-      alignDefault = new RadioButton("align", constants_.defaultLabel());
+      alignDefault = new RadioButton("align", constants_.defaultAlignLabel());
       alignLeft_ = new RadioButton("align", constants_.leftLabel());
       alignCenter_ = new RadioButton("align", constants_.centerLabel());
       alignRight_ = new RadioButton("align", constants_.rightLabel());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/EditorsTextConstants.java
Patch:
@@ -2046,8 +2046,8 @@ public interface EditorsTextConstants extends com.google.gwt.i18n.client.Message
      *
      * @return translated "visual"
      */
-    @DefaultMessage("visual")
-    @Key("visual")
+    @DefaultMessage("Visual")
+    @Key("Visual")
     String visual();
 
     /**

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -201,7 +201,7 @@ public void run()
          {
             public void run()
             {
-               ariaLoadingMessage_.setText("Loading session...");
+               ariaLoadingMessage_.setText(constants_.loadingSessionsText());
             }
          };
          showStatusTimer_.schedule(3000);
@@ -326,7 +326,7 @@ public void onSuccess()
          public void onFailure(Throwable reason)
          {
             dismissProgressAnimation_.execute();
-            Window.alert("Error: " + reason.getMessage());
+            Window.alert(constants_.errorText(reason.getMessage()));
          }
       });
    }
@@ -506,4 +506,5 @@ public final static String getSatelliteView()
    private Timer showStatusTimer_;
    private LauncherSessionStatus sessionStatus_;
    private Label ariaLoadingMessage_;
+   private static final StudioClientConstants constants_ = GWT.create(StudioClientConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreviewPresenter.java
Patch:
@@ -309,7 +309,7 @@ public void execute(FileSystemItem targetFile,
                      return;
                   }
                   
-                  indicator.onProgress("Saving File...");
+                  indicator.onProgress(constants_.savingFileCaption());
       
                   server_.copyFile(sourceFile, 
                                    targetFile, 

File: src/gwt/src/org/rstudio/studio/client/notebook/CompileNotebookOptionsDialog.java
Patch:
@@ -71,7 +71,7 @@ public CompileNotebookOptionsDialog(
                                        lblType_, 
                                        HasVerticalAlignment.ALIGN_MIDDLE);
          
-         HelpButton helpButton = HelpButton.createHelpButton("notebook_types", "Help on report types");
+         HelpButton helpButton = HelpButton.createHelpButton("notebook_types", constants_.helpButtonTitle());
          typeLabelPanel_.add(helpButton);
          typeLabelPanel_.setCellVerticalAlignment(
                                        helpButton, 
@@ -87,7 +87,7 @@ public CompileNotebookOptionsDialog(
          divTypeSelector_.getStyle().setDisplay(Style.Display.NONE);
       }
       
-      setOkButtonCaption("Compile");
+      setOkButtonCaption(constants_.okButtonCaption());
 
       // read the message when dialog is shown
       setARIADescribedBy(dialogInfo_);

File: src/gwt/src/org/rstudio/studio/client/quarto/ui/NewQuartoDocumentDialog.java
Patch:
@@ -201,7 +201,7 @@ public void onChange(ChangeEvent event)
       kernelSelect_ = createListBox(kernelDisplayNames, kernelNames);
       setListBoxValue(kernelSelect_, lastResult_.getKernel());
       
-      Label editorLabel = createLabel("Editor:");
+      Label editorLabel = createLabel(constants_.editorText());
       editorCheckBox_ = new QuartoVisualEditorCheckBox();
       
       // use project default if available, otherwise use last result

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdTemplateChooser.java
Patch:
@@ -59,7 +59,7 @@ interface RmdTemplateChooserUiBinder extends
 
    public RmdTemplateChooser(RMarkdownServerOperations server)
    {
-      dirLocation_ = new DirectoryChooserTextBox("Location:", 
+      dirLocation_ = new DirectoryChooserTextBox(constants_.locationLabel(),
             ElementIds.TextBoxButtonId.RMD_TEMPLATE_DIR);
       initWidget(uiBinder.createAndBindUi(this));
       server_ = server;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -166,7 +166,7 @@ public void onRSConnectAction(final RSConnectActionEvent event)
       // see if we have the requisite R packages
       depsPending_ = true;
       dependencyManager_.withRSConnect(
-         "Publishing content",
+         constants_.publishingContentLabel(),
          event.getContentType() == CONTENT_TYPE_DOCUMENT ||
          event.getContentType() == CONTENT_TYPE_WEBSITE ||
          event.getContentType() == CONTENT_TYPE_QUARTO_WEBSITE ,
@@ -220,7 +220,7 @@ private void publishAsRPubs(RSConnectActionEvent event)
 
       String ctx = constants_.publishRpubTitle(contentTypeDesc(event.getContentType()));
       RPubsUploadDialog dlg = new RPubsUploadDialog(
-            "Publish Wizard",
+            constants_.publishWizardLabel(),
             ctx,
             event.getFromPreview() != null ?
                   event.getFromPreview().getSourceFile() : null,

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchTabPanel.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.workbench.ui;
 
+import com.google.gwt.core.client.GWT;
 import com.google.gwt.dom.client.NativeEvent;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.dom.client.ClickEvent;
@@ -188,7 +189,7 @@ public void onClick(ClickEvent event)
                final ToolbarPopupMenu menu = new ToolbarPopupMenu();
                final NativeEvent nativeEvent = contextMenuEvent.getNativeEvent();
 
-               menu.addItem(ElementIds.TAB_CLOSE, new MenuItem("Close", () ->
+               menu.addItem(ElementIds.TAB_CLOSE, new MenuItem(constants_.closeText(), () ->
                {
                   tab.confirmClose(() -> tab.ensureHidden());
                }));
@@ -357,4 +358,5 @@ public void setNeverVisible(boolean value)
    private boolean neverVisible_ = false;
    private LayoutPanel panel_;
    private HTML utilPanel_;
+   private static final UIConstants constants_ = GWT.create(UIConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -184,7 +184,7 @@ protected Toolbar createMainToolbar()
       consoleSuspendBlockedIcon_ = new ConsoleSuspendBlockedIcon(announce).getSuspendBlocked();
       consoleSuspendBlockedIcon_.setVisible(false);
       consoleSuspendedIcon_ = new ConsoleSuspendBlockedIcon(announce).getSuspended();
-      consoleSuspendedIcon_.setTitle("Session Suspended");
+      consoleSuspendedIcon_.setTitle(constants_.sessionSuspendedTitle());
       consoleSuspendedIcon_.setVisible(false);
 
       toolbar.addRightWidget(consoleSuspendedIcon_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportPresenter.java
Patch:
@@ -123,6 +123,6 @@ public void openImportDatasetFromXLS(String path)
    private EventBus eventBus_;
    private DependencyManager dependencyManager_;
    
-   final String dataImportDependecyUserAction_ = "Preparing data import";
+   final String dataImportDependecyUserAction_ = constants_.preparingDataImportText();
    private static final ViewEnvironmentConstants constants_ = GWT.create(ViewEnvironmentConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -207,7 +207,7 @@ public String getValue(FileSystemItem item)
             }
          };
       nameColumn.setSortable(true);
-      filesDataGrid_.addColumn(nameColumn, "Name");
+      filesDataGrid_.addColumn(nameColumn, constants_.nameHeaderText());
 
       sortHandler_.setComparator(nameColumn, new FilesListComparator() {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -2349,7 +2349,7 @@ public void onError(ServerError error)
          }
       };
 
-      dependencyManager_.withRMarkdown(constants_.rNotebook(), "Using R Notebooks", extractRmdCommand);
+      dependencyManager_.withRMarkdown(constants_.rNotebook(), constants_.usingRNotebooksText(), extractRmdCommand);
    }
 
    private void openNotebook(final FileSystemItem rnbFile,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerPresenter.java
Patch:
@@ -69,7 +69,7 @@ public class ProfilerPresenter implements RprofEvent.Handler
    private final FileTypeRegistry fileTypeRegistry_;
    private String currentDocId_;
    
-   final String profilerDependecyUserAction_ = "The profiler";
+   final String profilerDependecyUserAction_ = constants_.theProfilerText();
    
    private ProfileOperationResponse response_ = null;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCppHelper.java
Patch:
@@ -71,7 +71,7 @@ public void onResponseReceived(CppCapabilities capabilities)
                   
                   // do a prompted install of the build tools
                   server_.installBuildTools(
-                           "Compiling C/C++ code for R",
+                           constants_.compilingCode(),
                            new SimpleRequestCallback<Boolean>() {
                               @Override
                               public void onResponseReceived(Boolean confirmed)

File: src/gwt/src/org/rstudio/studio/client/workbench/ClientWorkbenchConstants.java
Patch:
@@ -106,11 +106,11 @@ public interface ClientWorkbenchConstants extends com.google.gwt.i18n.client.Mes
     String descTextHeader();
 
     /**
-     * Translated "Description".
+     * Translated "Found {0} addins matching {1}".
      *
-     * @return translated "Description"
+     * @return translated "Found {0} addins matching {1}"
      */
-    @DefaultMessage("Description")
+    @DefaultMessage("Found {0} addins matching {1}")
     @Key("foundAddinsMessage")
     String foundAddinsMessage(int size, String query);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalConstants.java
Patch:
@@ -17,11 +17,11 @@
 public interface TerminalConstants extends com.google.gwt.i18n.client.Messages {
 
     /**
-     * Translated "The terminal is currently busy. ".
+     * Translated "The terminal is currently busy {0}. ".
      *
-     * @return translated "The terminal is currently busy. "
+     * @return translated "The terminal is currently busy {0}. "
      */
-    @DefaultMessage("The terminal is currently busy. ")
+    @DefaultMessage("The terminal is currently busy. {0}")
     @Key("terminalBusyMessage")
     String terminalBusyMessage(String question);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialConstants.java
Patch:
@@ -76,6 +76,7 @@ public interface TutorialConstants extends com.google.gwt.i18n.client.Messages {
      *
      * @return translated "Installing learnr..."
      */
+    @DefaultMessage("Installing learnr...")
     @Key("installingLearnrCaption")
     String installingLearnrCaption();
 

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -201,7 +201,7 @@ public void run()
          {
             public void run()
             {
-               ariaLoadingMessage_.setText("Loading session...");
+               ariaLoadingMessage_.setText(constants_.loadingSessionsText());
             }
          };
          showStatusTimer_.schedule(3000);
@@ -326,7 +326,7 @@ public void onSuccess()
          public void onFailure(Throwable reason)
          {
             dismissProgressAnimation_.execute();
-            Window.alert("Error: " + reason.getMessage());
+            Window.alert(constants_.errorText(reason.getMessage()));
          }
       });
    }
@@ -506,4 +506,5 @@ public final static String getSatelliteView()
    private Timer showStatusTimer_;
    private LauncherSessionStatus sessionStatus_;
    private Label ariaLoadingMessage_;
+   private static final StudioClientConstants constants_ = GWT.create(StudioClientConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreviewPresenter.java
Patch:
@@ -309,7 +309,7 @@ public void execute(FileSystemItem targetFile,
                      return;
                   }
                   
-                  indicator.onProgress("Saving File...");
+                  indicator.onProgress(constants_.savingFileCaption());
       
                   server_.copyFile(sourceFile, 
                                    targetFile, 

File: src/gwt/src/org/rstudio/studio/client/notebook/CompileNotebookOptionsDialog.java
Patch:
@@ -71,7 +71,7 @@ public CompileNotebookOptionsDialog(
                                        lblType_, 
                                        HasVerticalAlignment.ALIGN_MIDDLE);
          
-         HelpButton helpButton = HelpButton.createHelpButton("notebook_types", "Help on report types");
+         HelpButton helpButton = HelpButton.createHelpButton("notebook_types", constants_.helpButtonTitle());
          typeLabelPanel_.add(helpButton);
          typeLabelPanel_.setCellVerticalAlignment(
                                        helpButton, 
@@ -87,7 +87,7 @@ public CompileNotebookOptionsDialog(
          divTypeSelector_.getStyle().setDisplay(Style.Display.NONE);
       }
       
-      setOkButtonCaption("Compile");
+      setOkButtonCaption(constants_.okButtonCaption());
 
       // read the message when dialog is shown
       setARIADescribedBy(dialogInfo_);

File: src/gwt/src/org/rstudio/studio/client/quarto/ui/NewQuartoDocumentDialog.java
Patch:
@@ -201,7 +201,7 @@ public void onChange(ChangeEvent event)
       kernelSelect_ = createListBox(kernelDisplayNames, kernelNames);
       setListBoxValue(kernelSelect_, lastResult_.getKernel());
       
-      Label editorLabel = createLabel("Editor:");
+      Label editorLabel = createLabel(constants_.editorText());
       editorCheckBox_ = new QuartoVisualEditorCheckBox();
       
       // use project default if available, otherwise use last result

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdTemplateChooser.java
Patch:
@@ -59,7 +59,7 @@ interface RmdTemplateChooserUiBinder extends
 
    public RmdTemplateChooser(RMarkdownServerOperations server)
    {
-      dirLocation_ = new DirectoryChooserTextBox("Location:", 
+      dirLocation_ = new DirectoryChooserTextBox(constants_.locationLabel(),
             ElementIds.TextBoxButtonId.RMD_TEMPLATE_DIR);
       initWidget(uiBinder.createAndBindUi(this));
       server_ = server;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -166,7 +166,7 @@ public void onRSConnectAction(final RSConnectActionEvent event)
       // see if we have the requisite R packages
       depsPending_ = true;
       dependencyManager_.withRSConnect(
-         "Publishing content",
+         constants_.publishingContentLabel(),
          event.getContentType() == CONTENT_TYPE_DOCUMENT ||
          event.getContentType() == CONTENT_TYPE_WEBSITE ||
          event.getContentType() == CONTENT_TYPE_QUARTO_WEBSITE ,
@@ -220,7 +220,7 @@ private void publishAsRPubs(RSConnectActionEvent event)
 
       String ctx = constants_.publishRpubTitle(contentTypeDesc(event.getContentType()));
       RPubsUploadDialog dlg = new RPubsUploadDialog(
-            "Publish Wizard",
+            constants_.publishWizardLabel(),
             ctx,
             event.getFromPreview() != null ?
                   event.getFromPreview().getSourceFile() : null,

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchTabPanel.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.workbench.ui;
 
+import com.google.gwt.core.client.GWT;
 import com.google.gwt.dom.client.NativeEvent;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.dom.client.ClickEvent;
@@ -188,7 +189,7 @@ public void onClick(ClickEvent event)
                final ToolbarPopupMenu menu = new ToolbarPopupMenu();
                final NativeEvent nativeEvent = contextMenuEvent.getNativeEvent();
 
-               menu.addItem(ElementIds.TAB_CLOSE, new MenuItem("Close", () ->
+               menu.addItem(ElementIds.TAB_CLOSE, new MenuItem(constants_.closeText(), () ->
                {
                   tab.confirmClose(() -> tab.ensureHidden());
                }));
@@ -357,4 +358,5 @@ public void setNeverVisible(boolean value)
    private boolean neverVisible_ = false;
    private LayoutPanel panel_;
    private HTML utilPanel_;
+   private static final UIConstants constants_ = GWT.create(UIConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -184,7 +184,7 @@ protected Toolbar createMainToolbar()
       consoleSuspendBlockedIcon_ = new ConsoleSuspendBlockedIcon(announce).getSuspendBlocked();
       consoleSuspendBlockedIcon_.setVisible(false);
       consoleSuspendedIcon_ = new ConsoleSuspendBlockedIcon(announce).getSuspended();
-      consoleSuspendedIcon_.setTitle("Session Suspended");
+      consoleSuspendedIcon_.setTitle(constants_.sessionSuspendedTitle());
       consoleSuspendedIcon_.setVisible(false);
 
       toolbar.addRightWidget(consoleSuspendedIcon_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportPresenter.java
Patch:
@@ -123,6 +123,6 @@ public void openImportDatasetFromXLS(String path)
    private EventBus eventBus_;
    private DependencyManager dependencyManager_;
    
-   final String dataImportDependecyUserAction_ = "Preparing data import";
+   final String dataImportDependecyUserAction_ = constants_.preparingDataImportText();
    private static final ViewEnvironmentConstants constants_ = GWT.create(ViewEnvironmentConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -207,7 +207,7 @@ public String getValue(FileSystemItem item)
             }
          };
       nameColumn.setSortable(true);
-      filesDataGrid_.addColumn(nameColumn, "Name");
+      filesDataGrid_.addColumn(nameColumn, constants_.nameHeaderText());
 
       sortHandler_.setComparator(nameColumn, new FilesListComparator() {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -2349,7 +2349,7 @@ public void onError(ServerError error)
          }
       };
 
-      dependencyManager_.withRMarkdown(constants_.rNotebook(), "Using R Notebooks", extractRmdCommand);
+      dependencyManager_.withRMarkdown(constants_.rNotebook(), constants_.usingRNotebooksText(), extractRmdCommand);
    }
 
    private void openNotebook(final FileSystemItem rnbFile,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerPresenter.java
Patch:
@@ -69,7 +69,7 @@ public class ProfilerPresenter implements RprofEvent.Handler
    private final FileTypeRegistry fileTypeRegistry_;
    private String currentDocId_;
    
-   final String profilerDependecyUserAction_ = "The profiler";
+   final String profilerDependecyUserAction_ = constants_.theProfilerText();
    
    private ProfileOperationResponse response_ = null;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCppHelper.java
Patch:
@@ -71,7 +71,7 @@ public void onResponseReceived(CppCapabilities capabilities)
                   
                   // do a prompted install of the build tools
                   server_.installBuildTools(
-                           "Compiling C/C++ code for R",
+                           constants_.compilingCode(),
                            new SimpleRequestCallback<Boolean>() {
                               @Override
                               public void onResponseReceived(Boolean confirmed)

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarCommands.java
Patch:
@@ -128,7 +128,7 @@ public PanmirrorToolbarCommands(PanmirrorCommand[] commands)
       add(PanmirrorCommands.Footnote, constants_.footnoteMenuText());
       add(PanmirrorCommands.HorizontalRule, constants_.horizontalRuleMenuText());
       add(PanmirrorCommands.ParagraphInsert, constants_.paragraphMenuText());
-      add(PanmirrorCommands.HTMLComment, constants_.paragraphMenuText(), icons.COMMENT);
+      add(PanmirrorCommands.HTMLComment, constants_.commentMenuText(), icons.COMMENT);
       add(PanmirrorCommands.YamlMetadata, constants_.yamlBlockMenuText());
       add(PanmirrorCommands.Shortcode, constants_.shortcodeMenuText());
       add(PanmirrorCommands.InsertDiv, constants_.divMenuText());

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -381,11 +381,11 @@ public final native JsArrayString getQuadrants() /*-{
       }-*/;
 
       public final native JsArrayString getTabSet1() /*-{
-         return this && this.tabSet1 || ["Environment","History","Connections","Build","VCS","Tutorial","Presentations","Presentation"];
+         return this && this.tabSet1 || ["Environment","History","Connections","Build","VCS","Tutorial","Presentation"];
       }-*/;
 
       public final native JsArrayString getTabSet2() /*-{
-         return this && this.tabSet2 || ["Files","Plots","Packages","Help","Viewer"];
+         return this && this.tabSet2 || ["Files","Plots","Packages","Help","Viewer","Presentations"];
       }-*/;
 
       public final native JsArrayString getHiddenTabSet() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -556,7 +556,7 @@ public RestartRequirement onApply(UserPrefs prefs)
    @Override
    public String getName()
    {
-      return constants_.generalTablListGraphicsOption();
+      return constants_.generalTablistLabel();
    }
 
    @SuppressWarnings("unused")

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -556,7 +556,7 @@ public RestartRequirement onApply(UserPrefs prefs)
    @Override
    public String getName()
    {
-      return constants_.generalTablListGraphicsOption();
+      return constants_.generalTablistLabel();
    }
 
    @SuppressWarnings("unused")

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/diff/UnifiedParser.java
Patch:
@@ -187,7 +187,6 @@ else if (directive != StringUtil.charAt(diffLine,i))
 
    private boolean isNewFileLine(String nextLine)
    {
-      //TODO unsure about this check with Gary. I did change some SizeWarningWidgets to use `constants_`
       return nextLine.startsWith("diff ") || nextLine.startsWith("Index: ");
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -101,7 +101,7 @@ public EnvironmentPane(Commands commands,
                           UserPrefs prefs,
                           DependencyManager dependencyManager)
    {
-      super(constants_.environmentCapitalized(), events);
+      super("Environment", events);
 
       commands_ = commands;
       server_ = serverOperations;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentTab.java
Patch:
@@ -15,7 +15,6 @@
 
 package org.rstudio.studio.client.workbench.views.environment;
 
-import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.command.Handler;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -69,7 +68,7 @@ public EnvironmentTab(final Shim shim,
                          Commands commands,
                          Session session)
    {
-      super(constants_.environmentCapitalized(), shim);
+      super("Environment", shim);
       binder.bind(commands, shim);
       events.addHandler(OpenDataFileEvent.TYPE, shim);
 
@@ -84,5 +83,4 @@ public EnvironmentTab(final Shim shim,
    }
 
    private final Session session_;
-    private static final ViewEnvironmentConstants constants_ = GWT.create(ViewEnvironmentConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/ClientWorkbenchConstants.java
Patch:
@@ -1,4 +1,3 @@
-package org.rstudio.studio.client.workbench;
 /*
  * ClientWorkbenchConstants.java
  *
@@ -13,6 +12,7 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
+package org.rstudio.studio.client.workbench;
 public interface ClientWorkbenchConstants extends com.google.gwt.i18n.client.Messages {
 
     /**

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchOracle.java
Patch:
@@ -340,7 +340,6 @@ public void onError(ServerError error)
                if (error.getCode() != ServerError.TRANSMISSION)
                {
                   RStudioGinjector.INSTANCE.getGlobalDisplay().showErrorMessage(
-
                           constants_.codeSearchError(), error.getUserMessage());
                }
                
@@ -469,7 +468,6 @@ public boolean getMoreAvailable()
       private final String query_;
       private final ArrayList<CodeSearchSuggestion> suggestions_;
       private final boolean moveAvailable_;
-
    }
    private static final CodeSearchConstants constants_ = GWT.create(CodeSearchConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/snippets/ui/EditSnippetsDialog.java
Patch:
@@ -39,7 +39,6 @@
 import org.rstudio.studio.client.common.filetypes.TextFileType;
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.server.VoidServerRequestCallback;
-import org.rstudio.studio.client.workbench.prefs.PrefsConstants;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.snippets.SnippetsConstants;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -1723,7 +1723,7 @@ private DualWindowLayoutPanel createSplitWindow(LogicalWindow top,
 
    private LogicalWindow createConsole()
    {
-      String frameName = constants_.consoleText();
+      String frameName = "Console";
       
       PrimaryWindowFrame frame = new PrimaryWindowFrame(frameName, null);
       frame.setTitleWidget(new ConsoleInterpreterVersion());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -73,7 +73,7 @@ public BuildPane(Commands commands,
                     FileTypeRegistry fileTypeRegistry,
                     BuildServerOperations server)
    {
-      super(constants_.buildText(), events);
+      super("Build", events);
       ((BuildPane.Binder) GWT.create(BuildPane.Binder.class)).bind(commands, this);
 
       commands_ = commands;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -431,7 +431,7 @@ private void executeBuild(final String type, final String subType)
          {
             terminalHelper_.warnBusyTerminalBeforeCommand(() ->
                   executeBuildNoBusyCheck(type, subType),
-                  constants_.buildText(), constants_.terminalTerminatedQuestion(),
+                  "Build", constants_.terminalTerminatedQuestion(),
                   userPrefs_.busyDetection().getValue());
          }
       });

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildTab.java
Patch:
@@ -73,7 +73,7 @@ public BuildTab(final Shim shim,
                    EventBus eventBus,
                    UserPrefs uiPrefs)
    {
-      super(constants_.buildText(),  shim);
+      super("Build",  shim);
       
       session_ = session;
       binder.bind(commands, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsTab.java
Patch:
@@ -12,7 +12,6 @@
  */
 package org.rstudio.studio.client.workbench.views.connections;
 
-import com.google.gwt.core.client.GWT;
 import com.google.inject.Inject;
 
 import org.rstudio.core.client.command.CommandBinder;
@@ -58,7 +57,7 @@ public ConnectionsTab(final Shim shim,
                          EventBus eventBus,
                          Session session)
    {
-      super(constants_.connectionsTitle(), shim);
+      super("Connections", shim);
       binder.bind(commands, shim);
       session_ = session;
       eventBus_ = eventBus;
@@ -94,5 +93,4 @@ public void onEnableConnections(EnableConnectionsEvent event)
 
    private Session session_;
    private EventBus eventBus_;
-   private static final ConnectionsConstants constants_ = GWT.create(ConnectionsConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -89,7 +89,7 @@ public class ConnectionsPane extends WorkbenchPane
    public ConnectionsPane(Commands commands, EventBus eventBus, UserPrefs userPrefs)
    {
       // initialize
-      super(constants_.connectionsTitle(), eventBus);
+      super("Connections", eventBus);
       commands_ = commands;
       userPrefs_ = userPrefs;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesPane.java
Patch:
@@ -71,7 +71,7 @@ public FilesPane(GlobalDisplay globalDisplay,
                     Provider<FileCommandToolbar> pFileCommandToolbar,
                     Provider<UserPrefs> pPrefs)
    {
-      super(constants_.filesTitle(), events);
+      super("Files", events);
       globalDisplay_ = globalDisplay;
       commands_ = commands;
       fileDialogs_ = fileDialogs;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesTab.java
Patch:
@@ -50,7 +50,7 @@ public FilesTab(Shim shim,
                    EventBus events,
                    Commands commands)
    {
-      super(constants_.filesTitle(), shim);
+      super("Files", shim);
       binder.bind(commands, shim);
       events.addHandler(OpenFileInBrowserEvent.TYPE, shim);
       events.addHandler(DirectoryNavigateEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/Help.java
Patch:
@@ -195,7 +195,7 @@ public void onActivateHelp(ActivateHelpEvent event)
 
    public void bringToFront()
    {
-      events_.fireEvent(new ActivatePaneEvent(constants_.helpText()));
+      events_.fireEvent(new ActivatePaneEvent("Help"));
    }
 
    private void home()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -91,7 +91,7 @@ public HelpPane(Provider<HelpSearch> searchProvider,
                    EventBus events,
                    UserPrefs prefs)
    {
-      super(constants_.helpText(), events);
+      super("Help", events);
 
       searchProvider_ = searchProvider;
       globalDisplay_ = globalDisplay;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpTab.java
Patch:
@@ -68,7 +68,7 @@ public HelpTab(final Shim shim,
                   EventBus events,
                   final Session session)
    {
-      super(constants_.helpText(), shim);
+      super("Help", shim);
       binder.bind(commands, shim);
       events.addHandler(ShowHelpEvent.TYPE, shim);
       events.addHandler(ActivateHelpEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/HistoryTab.java
Patch:
@@ -14,7 +14,6 @@
  */
 package org.rstudio.studio.client.workbench.views.history;
 
-import com.google.gwt.core.client.GWT;
 import com.google.inject.Inject;
 
 import org.rstudio.core.client.command.CommandBinder;
@@ -40,8 +39,7 @@ public abstract static class Shim
    @Inject
    public HistoryTab(Shim shim, Binder binder, Commands commands)
    {
-      super(constants_.historyTitle(), shim);
+      super("History", shim);
       binder.bind(commands, shim);
    }
-   private static final HistoryConstants constants_ = GWT.create(HistoryConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryPane.java
Patch:
@@ -87,7 +87,7 @@ public static void ensureStylesInjected()
    @Inject
    public HistoryPane(Commands commands, EventBus events)
    {
-      super(constants_.historyTitle(), events);
+      super("History", events);
       commands_ = commands;
       ensureWidget();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/JobsTab.java
Patch:
@@ -53,7 +53,7 @@ public JobsTab(final Shim shim,
                         Commands commands,
                         EventBus events)
    {
-      super(constants_.jobsTitle(), shim);
+      super("Jobs", shim);
       shim_ = shim;
       
       binder.bind(commands, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/LauncherJobsTab.java
Patch:
@@ -52,7 +52,7 @@ public LauncherJobsTab(final Shim shim,
                           Commands commands,
                           EventBus events)
    {
-      super(constants_.launcherTitle(), shim);
+      super("Launcher", shim);
       shim_ = shim;
       
       binder.bind(commands, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobsPane.java
Patch:
@@ -38,7 +38,7 @@ public class JobsPane extends WorkbenchPane
    public JobsPane(UserPrefs uiPrefs,
                    JobsPaneWidgets widgets)
    {
-      super(constants_.jobsTitle());
+      super("Jobs");
       
       userPrefs_ = uiPrefs;
       widgets_ = widgets;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/LauncherJobsPane.java
Patch:
@@ -35,7 +35,7 @@ public class LauncherJobsPane extends WorkbenchPane
    public LauncherJobsPane(UserPrefs uiPrefs,
                            LauncherJobsPaneWidgets widgets)
    {
-      super(constants_.launcherTitle());
+      super("Launcher");
       
       uiPrefs_ = uiPrefs;
       widgets_ = widgets;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/CompilePdfOutputPresenter.java
Patch:
@@ -67,7 +67,7 @@ public CompilePdfOutputPresenter(CompileOutputPaneFactory outputFactory,
                                     Commands commands,
                                     EventBus events)
    {
-      super(outputFactory.create(constants_.compilePDFTaskName(),
+      super(outputFactory.create("Compile PDF",
                                  constants_.viewLogTitle()));
       binder.bind(commands, this);
       view_ = (CompileOutputPaneDisplay) getView();
@@ -287,7 +287,7 @@ protected void onSuccess(Boolean wasTerminated)
             else
             {
                globalDisplay_.showErrorMessage(
-                    constants_.compilePDFCaption(),
+                    "Compile PDF",
                     constants_.unableToTerminatePDFCompilationMessage());
             }
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/data/DataOutputPane.java
Patch:
@@ -33,7 +33,7 @@ public class DataOutputPane extends WorkbenchPane
    @Inject
    public DataOutputPane()
    {
-      super(constants_.dataOutputTitle());
+      super("Data Output");
       ensureWidget();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/data/DataOutputTab.java
Patch:
@@ -50,7 +50,7 @@ public DataOutputTab(Shim shim,
                         Commands commands,
                         final Session session)
    {
-      super(constants_.sqlResultsTitle(), shim);
+      super("SQL Results", shim);
       shim_ = shim;
 
       GWT.<Binder>create(Binder.class).bind(commands, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -174,7 +174,7 @@ public enum Exclude
 
    public FindInFilesDialog(OperationWithInput<State> operation)
    {
-      super(constants_.findInFilesCaption(), Roles.getDialogRole(), operation);
+      super("Find in Files", Roles.getDialogRole(), operation);
 
       dirChooser_ = new DirectoryChooserTextBox(constants_.searchInLabel(),
          ElementIds.TextBoxButtonId.FIND_IN,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -52,7 +52,7 @@ public class FindOutputPane extends WorkbenchPane
    public FindOutputPane(Commands commands,
                          EventBus eventBus)
    {
-      super(constants_.findResultsTitle());
+      super("Find Results");
       commands_ = commands;
       eventBus_ = eventBus;
       ensureWidget();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputTab.java
Patch:
@@ -50,7 +50,7 @@ public FindOutputTab(final Shim shim,
                         Commands commands,
                         final Session session)
    {
-      super(constants_.findInFilesCaption(), shim);
+      super("Find in Files", shim);
       shim_ = shim;
 
       events.addHandler(SessionInitEvent.TYPE, (SessionInitEvent sie) ->

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/markers/MarkersOutputPane.java
Patch:
@@ -38,7 +38,7 @@ public class MarkersOutputPane extends WorkbenchPane
    @Inject
    public MarkersOutputPane(Commands commands)
    {
-      super(constants_.markersTitle());
+      super("Markers");
       markerSetsToolbarButton_ = new MarkerSetsToolbarButton();
       markerList_ = new SourceMarkerList();
       clearButton_ = new ToolbarButton(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/markers/MarkersOutputTab.java
Patch:
@@ -50,7 +50,7 @@ public MarkersOutputTab(final Shim shim,
                            Commands commands,
                            final Session session)
    {
-      super(constants_.markersTitle(), shim);
+      super("Markers", shim);
       shim_ = shim;
 
       events.addHandler(SessionInitEvent.TYPE, (SessionInitEvent sie) ->

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/renderrmd/RenderRmdOutputTab.java
Patch:
@@ -59,7 +59,7 @@ public RenderRmdOutputTab(Shim shim,
                              Commands commands,
                              final Session session)
    {
-      super(constants_.renderTitle(), shim);
+      super("Render", shim);
       shim_ = shim;
 
       GWT.<Binder>create(Binder.class).bind(commands, shim_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/rsconnectdeploy/RSConnectDeployOutputPresenter.java
Patch:
@@ -50,7 +50,7 @@ public RSConnectDeployOutputPresenter(CompileOutputPaneFactory outputFactory,
                                    Binder binder,
                                    EventBus events)
    {
-      super(outputFactory.create(constants_.deployTitle(), ""));
+      super(outputFactory.create("Deploy", ""));
       binder.bind(commands, this);
       view_ = (CompileOutputPaneDisplay) getView();
       view_.setHasLogs(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/rsconnectdeploy/RSConnectDeployOutputTab.java
Patch:
@@ -61,7 +61,7 @@ public RSConnectDeployOutputTab(Shim shim,
                              Commands commands,
                              final Session session)
    {
-      super(constants_.deployTitle(), shim);
+      super("Deploy", shim);
       shim_ = shim;
       GWT.<Binder>create(Binder.class).bind(commands, shim);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/SourceCppOutputPane.java
Patch:
@@ -36,7 +36,7 @@ public class SourceCppOutputPane extends WorkbenchPane
    @Inject
    public SourceCppOutputPane()
    {
-      super(constants_.sourceCppTitle());
+      super("Source Cpp");
       compilePanel_ = new CompilePanel(new CompileOutputBufferWithHighlight());
       ensureWidget();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/SourceCppOutputTab.java
Patch:
@@ -43,7 +43,7 @@ interface Binder extends CommandBinder<Commands, Shim> {}
    @Inject
    public SourceCppOutputTab(Shim shim, Commands commands, EventBus events)
    {
-      super(constants_.sourceCppTitle(), shim);
+      super("Source Cpp", shim);
       GWT.<Binder>create(Binder.class).bind(commands, shim);
 
       events.addHandler(SourceCppStartedEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/tests/TestsOutputPresenter.java
Patch:
@@ -54,7 +54,7 @@ public TestsOutputPresenter(CompileOutputPaneFactory outputFactory,
                                Commands commands,
                                EventBus events)
    {
-      super(outputFactory.create(constants_.testsTaskName(),
+      super(outputFactory.create("Tests",
                                  constants_.viewTestResultsTitle()));
       view_ = (CompileOutputPaneDisplay) getView();
       view_.setHasLogs(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/tests/TestsOutputTab.java
Patch:
@@ -54,7 +54,7 @@ public TestsOutputTab(Shim shim,
                          EventBus events,
                          final Session session)
    {
-      super(constants_.testsTaskName(), shim);
+      super("Tests", shim);
       shim_ = shim;
 
       events.addHandler(BuildStartedEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/Packages.java
Patch:
@@ -214,7 +214,7 @@ public void execute(final PackageInstallContext installContext)
             else
             {
                globalDisplay_.showYesNoMessage(MessageDialog.QUESTION,
-                       constants_.createPackageLibraryCaption(),
+                 constants_.createPackageLibraryCaption(),
                  constants_.createPackageLibraryMessage(installContext.getDefaultUserLibraryPath()),
                  false,
                  new Operation() // Yes operation

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -88,7 +88,7 @@ public PackagesPane(Commands commands,
                        GlobalDisplay display,
                        EventBus events)
    {
-      super(constants_.packagesTitle(), events);
+      super("Packages", events);
       commands_ = commands;
       session_ = session;
       display_ = display;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesTab.java
Patch:
@@ -52,7 +52,7 @@ public PackagesTab(Shim shim,
                       UserPrefs uiPrefs,
                       Session session)
    {
-      super(constants_.packagesTitle(), shim);
+      super("Packages", shim);
       binder.bind(commands, shim);
       events.addHandler(LoadedPackageUpdatesEvent.TYPE, shim);
       events.addHandler(RaisePackagePaneEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -51,7 +51,7 @@ public class PlotsPane extends WorkbenchPane implements Plots.Display,
    public PlotsPane(Commands commands, EventBus events, PlotsServerOperations server,
          DependencyManager dependencies)
    {
-      super(constants_.plotsTitle(), events);
+      super("Plots", events);
       commands_ = commands;
       server_ = server;
       dependencies_ = dependencies;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsTab.java
Patch:
@@ -98,7 +98,7 @@ public PlotsTab(PlotsShim shim,
                    Commands commands,
                    PlotsServerOperations server)
    {
-      super(constants_.plotsTitle(), shim);
+      super("Plots", shim);
       binder.bind(commands, shim);
       commands_ = commands;
       shim_ = shim;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationPane.java
Patch:
@@ -64,7 +64,7 @@ public class PresentationPane extends WorkbenchPane implements Presentation.Disp
    public PresentationPane(Commands commands, Session session,
          PresentationServerOperations server, GlobalDisplay display)
    {
-      super(constants_.presentationTitle());
+      super("Presentation");
       commands_ = commands;
       session_ = session;
       server_ = server;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation2/Presentation2.java
Patch:
@@ -30,7 +30,6 @@
 import org.rstudio.studio.client.workbench.views.jobs.events.JobUpdatedEvent;
 import org.rstudio.studio.client.workbench.views.jobs.model.Job;
 import org.rstudio.studio.client.workbench.views.jobs.model.JobConstants;
-import org.rstudio.studio.client.workbench.views.plots.PlotsConstants;
 import org.rstudio.studio.client.workbench.views.presentation2.events.PresentationHashChangeEvent;
 import org.rstudio.studio.client.workbench.views.presentation2.events.PresentationInitEvent;
 import org.rstudio.studio.client.workbench.views.presentation2.events.PresentationPreviewEvent;
@@ -249,5 +248,4 @@ private String asApplicationUrl(String url)
    private final GlobalDisplay globalDisplay_;
    private final EventBus eventBus_;
    private final ApplicationServerOperations server_;
-   private static final PlotsConstants Presentation2Constants = com.google.gwt.core.client.GWT.create(Presentation2Constants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation2/Presentation2Pane.java
Patch:
@@ -63,7 +63,7 @@ public Presentation2Pane(Commands commands, ApplicationServerOperations server)
       // This should always be title "Presentation" (rather than the name of the underlying
       // tab "Presentations". The proper name is "Presentation", we just used
       // "Presentations" so the configurations wouldn't conflict.
-      super(constants_.presentationTitle());
+      super("Presentation");
       commands_ = commands;
       server_ = server;
       ensureWidget();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation2/Presentation2Tab.java
Patch:
@@ -60,7 +60,7 @@ public Presentation2Tab(Shim shim, Binder binder, Session session, Commands comm
       // This should always be title "Presentation" (rather than the name of the underlying
       // tab "Presentations". The proper name is "Presentation", we just used
       // "Presentations" so the configurations wouldn't conflict.
-      super(constants_.presentationTitle(), shim);
+      super("Presentation", shim);
       session_ = session;
       binder.bind(commands, shim);
       eventBus.addHandler(PresentationPreviewEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -91,7 +91,7 @@ protected TerminalPane(EventBus events,
                           WorkbenchContext workbenchContext,
                           WorkbenchServerOperations server)
    {
-      super(constants_.terminalTitle(), events);
+      super("Terminal", events);
       globalDisplay_ = globalDisplay;
       commands_ = commands;
       uiPrefs_ = uiPrefs;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTab.java
Patch:
@@ -106,7 +106,7 @@ public TerminalTab(Shim shim,
                       Provider<ConsoleProcessFactory> pConsoleProcessFactory,
                       final Session session)
    {
-      super(constants_.terminalTitle(), shim);
+      super("Terminal", shim);
       shim_ = shim;
       pConsoleProcessFactory_ = pConsoleProcessFactory;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPane.java
Patch:
@@ -73,7 +73,7 @@ protected TutorialPane(GlobalDisplay globalDisplay,
                           DependencyManager dependencies,
                           TutorialServerOperations server)
    {
-      super(constants_.tutorialTitle(), events);
+      super("Tutorial", events);
 
       globalDisplay_ = globalDisplay;
       commands_      = commands;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialTab.java
Patch:
@@ -27,7 +27,7 @@ public abstract static class Shim
    @Inject
    public TutorialTab(Shim shim)
    {
-      super(constants_.tutorialTitle(), shim);
+      super("Tutorial", shim);
       shim_ = shim;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -67,7 +67,7 @@ public ViewerPane(Commands commands,
                      Provider<UserState> pUserState,
                      HtmlMessageListener htmlMessageListener)
    {
-      super(constants_.viewerTitle(), events);
+      super("Viewer", events);
       commands_ = commands;
       globalDisplay_ = globalDisplay;
       server_ = server;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerTab.java
Patch:
@@ -37,7 +37,7 @@ public abstract static class Shim
    @Inject
    public ViewerTab(Shim shim, Session session, EventBus eventBus)
    {
-      super(constants_.viewerTitle(), shim);
+      super("Viewer", shim);
       session_ = session;
 
       eventBus.addHandler(ViewerNavigateEvent.TYPE, shim);

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUIChunks.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.panmirror.ui;
 
+import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.dom.client.Element;
 import jsinterop.annotations.JsFunction;
 import jsinterop.annotations.JsType;
@@ -27,7 +28,8 @@ public class PanmirrorUIChunks
    @JsFunction
    public interface CreateChunkEditor
    {
-      PanmirrorUIChunkEditor create(String type, Element element, int position, PanmirrorUIChunkCallbacks callbacks);
+      PanmirrorUIChunkEditor create(String type, Element element, int position, JsArrayString classes,
+                                    PanmirrorUIChunkCallbacks callbacks);
    }
 
    @JsFunction

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeChunks.java
Patch:
@@ -70,7 +70,7 @@ public void run()
    public PanmirrorUIChunks uiChunks()
    {
       PanmirrorUIChunks chunks = new PanmirrorUIChunks();
-      chunks.createChunkEditor = (type, ele, index, callbacks) ->
+      chunks.createChunkEditor = (type, ele, index, classes, callbacks) ->
       {
          // only know how to create ace instances right now
          if (!type.equals("ace"))
@@ -88,7 +88,7 @@ public PanmirrorUIChunks uiChunks()
          }
 
          VisualModeChunk chunk = new VisualModeChunk(
-               ele, index, expanded, callbacks, sentinel_, target_, sync_);
+               ele, index, expanded, classes, callbacks, sentinel_, target_, sync_);
 
          // Add the chunk to our index, and remove it when the underlying chunk
          // is removed in Prosemirror

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RsconnectConstants.java
Patch:
@@ -1,4 +1,3 @@
-package org.rstudio.studio.client.rsconnect;
 /*
  * RsconnectConstants.java
  *
@@ -13,6 +12,9 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
+
+package org.rstudio.studio.client.rsconnect;
+
 public interface RsconnectConstants extends com.google.gwt.i18n.client.Messages{
     /**
      * Translated "Could Not Publish".

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -108,7 +108,7 @@ public class SourceColumnManager implements CommandPaletteEntrySource,
                                             DocumentCloseEvent.Handler,
                                             DebugModeChangedEvent.Handler
 {
-    private static final ViewsSourceConstants constants_ = GWT.create(ViewsSourceConstants.class);
+  private static final ViewsSourceConstants constants_ = GWT.create(ViewsSourceConstants.class);
   public interface CPSEditingTargetCommand
    {
       void execute(EditingTarget editingTarget, Command continuation);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/ViewsSourceConstants.java
Patch:
@@ -1,4 +1,3 @@
-package org.rstudio.studio.client.workbench.views.source;
 /*
  * ViewsSourceConstants.java
  *
@@ -13,6 +12,9 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
+
+package org.rstudio.studio.client.workbench.views.source;
+
 public interface ViewsSourceConstants extends com.google.gwt.i18n.client.Messages{
     /**
      * Translated "(No documents)".

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUIChunks.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.panmirror.ui;
 
+import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.dom.client.Element;
 import jsinterop.annotations.JsFunction;
 import jsinterop.annotations.JsType;
@@ -27,7 +28,8 @@ public class PanmirrorUIChunks
    @JsFunction
    public interface CreateChunkEditor
    {
-      PanmirrorUIChunkEditor create(String type, Element element, int position, PanmirrorUIChunkCallbacks callbacks);
+      PanmirrorUIChunkEditor create(String type, Element element, int position, JsArrayString classes,
+                                    PanmirrorUIChunkCallbacks callbacks);
    }
 
    @JsFunction

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeChunks.java
Patch:
@@ -70,7 +70,7 @@ public void run()
    public PanmirrorUIChunks uiChunks()
    {
       PanmirrorUIChunks chunks = new PanmirrorUIChunks();
-      chunks.createChunkEditor = (type, ele, index, callbacks) ->
+      chunks.createChunkEditor = (type, ele, index, classes, callbacks) ->
       {
          // only know how to create ace instances right now
          if (!type.equals("ace"))
@@ -88,7 +88,7 @@ public PanmirrorUIChunks uiChunks()
          }
 
          VisualModeChunk chunk = new VisualModeChunk(
-               ele, index, expanded, callbacks, sentinel_, target_, sync_);
+               ele, index, expanded, classes, callbacks, sentinel_, target_, sync_);
 
          // Add the chunk to our index, and remove it when the underlying chunk
          // is removed in Prosemirror

File: src/gwt/src/org/rstudio/studio/client/common/StudioClientCommonConstants.java
Patch:
@@ -12,7 +12,6 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
-package org.rstudio.studio.client.common;
 
 package org.rstudio.studio.client.common;
 

File: src/gwt/src/org/rstudio/core/client/widget/LeftRightToggleButton.java
Patch:
@@ -27,7 +27,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.CssResource;
-import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.Widget;

File: src/gwt/src/org/rstudio/core/client/widget/SmallButton.java
Patch:
@@ -26,9 +26,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.CssResource;
-import com.google.gwt.resources.client.ImageResource;
-import com.google.gwt.resources.client.ImageResource.ImageOptions;
-import com.google.gwt.resources.client.ImageResource.RepeatStyle;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.FocusWidget;

File: src/gwt/src/org/rstudio/core/client/widget/ThemedButton.java
Patch:
@@ -25,7 +25,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.CssResource;
-import com.google.gwt.resources.client.DataResource;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.FocusWidget;

File: src/gwt/src/org/rstudio/studio/client/application/StudioClientApplicationConstants.java
Patch:
@@ -1,4 +1,3 @@
-package org.rstudio.studio.client.application;
 /*
  * StudioClientApplicationConstants.java
  *
@@ -13,6 +12,9 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
+
+package org.rstudio.studio.client.application;
+
 public interface StudioClientApplicationConstants extends com.google.gwt.i18n.client.Messages {
 
     /**

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -45,7 +45,6 @@
 import org.rstudio.studio.client.application.model.UpdateCheckResult;
 import org.rstudio.studio.client.application.ui.ApplicationHeader;
 import org.rstudio.studio.client.application.ui.GlobalToolbar;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.debugging.ErrorManager;
 import org.rstudio.studio.client.events.EditEvent;

File: src/gwt/src/org/rstudio/studio/client/common/StudioClientCommonConstants.java
Patch:
@@ -1,4 +1,3 @@
-package org.rstudio.studio.client.common;
 /*
  * StudioClientCommonConstants.java
  *
@@ -14,6 +13,8 @@
  *
  */
 
+package org.rstudio.studio.client.common;
+
 public interface StudioClientCommonConstants extends com.google.gwt.i18n.client.Messages {
 
     /**

File: src/gwt/src/org/rstudio/studio/client/common/vcs/VCSConstants.java
Patch:
@@ -12,6 +12,7 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
+
 package org.rstudio.studio.client.common.vcs;
 
 public class VCSConstants

File: src/gwt/src/org/rstudio/studio/client/notebook/CompileNotebookOptionsDialog.java
Patch:
@@ -53,7 +53,7 @@ public CompileNotebookOptionsDialog(
          String defaultType,
          final OperationWithInput<CompileNotebookOptions> operation)
    {
-      super("Compile Report from R Script", Roles.getDialogRole(), operation);
+      super(constants_.compileNotebookOptionsDialogCaption(), Roles.getDialogRole(), operation);
       docId_ = docId;
       RStudioGinjector.INSTANCE.injectMembers(this);
 
@@ -202,4 +202,6 @@ private void setType(String type)
    private boolean showTypes_;
 
    private Widget widget_;
+
+   private static final NotebookConstants constants_ = GWT.create(NotebookConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -63,7 +63,7 @@
 import org.rstudio.studio.client.projects.model.RProjectOptions;
 import org.rstudio.studio.client.projects.ui.newproject.NewProjectWizard;
 import org.rstudio.studio.client.projects.ui.prefs.ProjectPreferencesDialog;
-import org.rstudio.studio.client.quarto.model.QuartoConstants;
+import org.rstudio.studio.client.quarto.model.QuartoCommandConstants;
 import org.rstudio.studio.client.quarto.model.QuartoServerOperations;
 import org.rstudio.studio.client.renv.model.RenvServerOperations;
 import org.rstudio.studio.client.server.ServerError;
@@ -1024,7 +1024,7 @@ private boolean initializeRenv(NewProjectResult newProject)
       return newProject.getUseRenv() &&
              (newProject.getNewQuartoProjectOptions() == null ||
              newProject.getNewQuartoProjectOptions().getEngine()
-                .equals(QuartoConstants.ENGINE_KNITR));
+                .equals(QuartoCommandConstants.ENGINE_KNITR));
    }
    
    private void showOpenProjectDialog(

File: src/gwt/src/org/rstudio/studio/client/projects/StudioClientProjectConstants.java
Patch:
@@ -1,4 +1,3 @@
-package org.rstudio.studio.client.projects;
 /*
  * StudioClientProjectConstants.java
  *
@@ -13,6 +12,9 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
+
+package org.rstudio.studio.client.projects;
+
 public interface StudioClientProjectConstants extends com.google.gwt.i18n.client.Messages {
 
     /**

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewProjectWizard.java
Patch:
@@ -62,6 +62,7 @@ public NewProjectWizard(
       {
          rVersionSelector_ = new RVersionSelectWidget(
            "",
+           ElementIds.SelectWidgetId.R_VER_NEW_PROJ_WIZ,
            rVersions.getAvailableRVersions(),
            false,
            false,

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewQuartoBookProjectPage.java
Patch:
@@ -17,13 +17,13 @@
 import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.projects.StudioClientProjectConstants;
-import org.rstudio.studio.client.quarto.model.QuartoConstants;
+import org.rstudio.studio.client.quarto.model.QuartoCommandConstants;
 
 public class NewQuartoBookProjectPage extends NewQuartoProjectPage
 {
    public NewQuartoBookProjectPage()
    {
-      super(QuartoConstants.PROJECT_BOOK,
+      super(QuartoCommandConstants.PROJECT_BOOK,
            constants_.quartoBookTitle(),
            constants_.quartoBookSubTitle(),
            constants_.quartoBookPageCaption(),

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewQuartoDefaultProjectPage.java
Patch:
@@ -17,15 +17,15 @@
 import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.projects.StudioClientProjectConstants;
-import org.rstudio.studio.client.quarto.model.QuartoConstants;
+import org.rstudio.studio.client.quarto.model.QuartoCommandConstants;
 
 public class NewQuartoDefaultProjectPage extends NewQuartoProjectPage
 {
   
    
    public NewQuartoDefaultProjectPage()
    {
-      super(QuartoConstants.PROJECT_DEFAULT,
+      super(QuartoCommandConstants.PROJECT_DEFAULT,
            constants_.quartoProjectTitle(),
            constants_.quartoProjectSubTitle(),
            constants_.quartoProjectPageCaption(),

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewQuartoWebsiteProjectPage.java
Patch:
@@ -17,13 +17,13 @@
 import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.projects.StudioClientProjectConstants;
-import org.rstudio.studio.client.quarto.model.QuartoConstants;
+import org.rstudio.studio.client.quarto.model.QuartoCommandConstants;
 
 public class NewQuartoWebsiteProjectPage extends NewQuartoProjectPage
 {
    public NewQuartoWebsiteProjectPage()
    {
-      super(QuartoConstants.PROJECT_WEBSITE,
+      super(QuartoCommandConstants.PROJECT_WEBSITE,
            constants_.quartoWebsiteTitle(),
            constants_.quartoWebsiteSubTitle(),
            constants_.quartoWebsitePageCaption(),

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoCommandConstants.java
Patch:
@@ -15,7 +15,7 @@
 
 package org.rstudio.studio.client.quarto.model;
 
-public class QuartoConstants
+public class QuartoCommandConstants
 {
    public final static String FORMAT_HTML = "html";
    public final static String FORMAT_PDF = "pdf";

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoNewProjectOptions.java
Patch:
@@ -24,8 +24,8 @@ protected QuartoNewProjectOptions()
    
    public final static QuartoNewProjectOptions createDefault()
    {
-      return create(QuartoConstants.PROJECT_DEFAULT, QuartoConstants.ENGINE_KNITR, "python3", 
-                    "", "matplotlib pandas", QuartoConstants.EDITOR_VISUAL);
+      return create(QuartoCommandConstants.PROJECT_DEFAULT, QuartoCommandConstants.ENGINE_KNITR, "python3",
+                    "", "matplotlib pandas", QuartoCommandConstants.EDITOR_VISUAL);
    }
    
    public native final static QuartoNewProjectOptions create(String type, String engine, String kernel, String venv, 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -113,6 +113,7 @@ public void onClick(ClickEvent event)
       if (versionsInfo.isMultiVersion())
       {
          rServerRVersion_ = new RVersionSelectWidget(
+                                       ElementIds.SelectWidgetId.R_VER_GEN_PREF_PANE,
                                        versionsInfo.getAvailableRVersions());
          basic.add(tight(rServerRVersion_));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -26,12 +26,10 @@
 import com.google.inject.Inject;
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.studio.client.application.events.EventBus;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.NotifyingSplitLayoutPanel;
 import org.rstudio.studio.client.workbench.model.ClientState;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.helper.JSObjectStateValue;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 
 import java.util.ArrayList;
 import java.util.Arrays;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -56,7 +56,6 @@
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.studio.client.application.events.EventBus;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.workbench.commands.Commands;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionPopupPanel.java
Patch:
@@ -43,7 +43,6 @@
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.events.SelectionCommitEvent;
 import org.rstudio.core.client.widget.ThemedPopupPanel;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.workbench.views.console.ConsoleResources;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionRequester.QualifiedName;
 import org.rstudio.studio.client.workbench.views.help.model.HelpInfo.ParsedInfo;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -39,7 +39,6 @@
 import org.rstudio.studio.client.application.events.SessionSerializationEvent;
 import org.rstudio.studio.client.application.events.SuspendAndRestartEvent;
 import org.rstudio.studio.client.application.model.SessionSerializationAction;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.ImageMenuItem;
 import org.rstudio.studio.client.common.SimpleRequestCallback;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -69,7 +69,6 @@
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.MouseNavigateEvent;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.AutoGlassPanel;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -100,7 +100,6 @@
 import org.rstudio.studio.client.events.ReplaceRangesEvent.ReplacementData;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntryProvider;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntrySource;
-import org.rstudio.studio.client.quarto.QuartoHelper;
 import org.rstudio.studio.client.events.SetSelectionRangesEvent;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/EditorsTextConstants.java
Patch:
@@ -15,8 +15,6 @@
 
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
-import com.google.gwt.i18n.client.Messages;
-
 public interface EditorsTextConstants extends com.google.gwt.i18n.client.Messages {
     /**
      * Translated "R Console".

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -101,7 +101,7 @@
 import org.rstudio.studio.client.plumber.model.PlumberAPIParams;
 import org.rstudio.studio.client.quarto.QuartoHelper;
 import org.rstudio.studio.client.quarto.model.QuartoConfig;
-import org.rstudio.studio.client.quarto.model.QuartoConstants;
+import org.rstudio.studio.client.quarto.model.QuartoCommandConstants;
 import org.rstudio.studio.client.rmarkdown.RmdOutput;
 import org.rstudio.studio.client.rmarkdown.events.ConvertToShinyDocEvent;
 import org.rstudio.studio.client.rmarkdown.events.RmdOutputFormatChangedEvent;
@@ -7065,7 +7065,7 @@ private boolean isQuartoWebsiteDefaultHtmlDoc()
          // quarto_preview will be used (e.g. for pdfs, presentations, etc.)
          String docFormat = quartoFormat();
          return (docFormat == null || Arrays.asList(config.project_formats).contains(docFormat)) &&
-                config.project_type.equals(QuartoConstants.PROJECT_WEBSITE);
+                config.project_type.equals(QuartoCommandConstants.PROJECT_WEBSITE);
                 
       }
       else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModePanmirrorFormat.java
Patch:
@@ -140,7 +140,7 @@ else if (alternateEngine != null)
                format.pandocMode = "markdown";
                if (!isQuartoDocument())
                { 
-                  format.pandocExtensions = "+autolink_bare_uris";
+                  format.pandocExtensions = "+autolink_bare_uris+tex_math_single_backslash";
                }
                if (formatComment.extensions != null)
                   format.pandocExtensions += formatComment.extensions;

File: src/gwt/src/org/rstudio/core/client/widget/LeftRightToggleButton.java
Patch:
@@ -27,7 +27,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.CssResource;
-import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.Widget;

File: src/gwt/src/org/rstudio/core/client/widget/SmallButton.java
Patch:
@@ -26,9 +26,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.CssResource;
-import com.google.gwt.resources.client.ImageResource;
-import com.google.gwt.resources.client.ImageResource.ImageOptions;
-import com.google.gwt.resources.client.ImageResource.RepeatStyle;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.FocusWidget;

File: src/gwt/src/org/rstudio/core/client/widget/ThemedButton.java
Patch:
@@ -25,7 +25,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.CssResource;
-import com.google.gwt.resources.client.DataResource;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.FocusWidget;

File: src/gwt/src/org/rstudio/studio/client/application/StudioClientApplicationConstants.java
Patch:
@@ -1,4 +1,3 @@
-package org.rstudio.studio.client.application;
 /*
  * StudioClientApplicationConstants.java
  *
@@ -13,6 +12,9 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
+
+package org.rstudio.studio.client.application;
+
 public interface StudioClientApplicationConstants extends com.google.gwt.i18n.client.Messages {
 
     /**

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -45,7 +45,6 @@
 import org.rstudio.studio.client.application.model.UpdateCheckResult;
 import org.rstudio.studio.client.application.ui.ApplicationHeader;
 import org.rstudio.studio.client.application.ui.GlobalToolbar;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.debugging.ErrorManager;
 import org.rstudio.studio.client.events.EditEvent;

File: src/gwt/src/org/rstudio/studio/client/common/StudioClientCommonConstants.java
Patch:
@@ -1,4 +1,3 @@
-package org.rstudio.studio.client.common;
 /*
  * StudioClientCommonConstants.java
  *
@@ -14,6 +13,8 @@
  *
  */
 
+package org.rstudio.studio.client.common;
+
 public interface StudioClientCommonConstants extends com.google.gwt.i18n.client.Messages {
 
     /**

File: src/gwt/src/org/rstudio/studio/client/common/vcs/VCSConstants.java
Patch:
@@ -12,6 +12,7 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
+
 package org.rstudio.studio.client.common.vcs;
 
 public class VCSConstants

File: src/gwt/src/org/rstudio/studio/client/projects/StudioClientProjectConstants.java
Patch:
@@ -1,4 +1,3 @@
-package org.rstudio.studio.client.projects;
 /*
  * StudioClientProjectConstants.java
  *
@@ -13,6 +12,9 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
+
+package org.rstudio.studio.client.projects;
+
 public interface StudioClientProjectConstants extends com.google.gwt.i18n.client.Messages {
 
     /**

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdTemplateOptionsDialog.java
Patch:
@@ -16,12 +16,10 @@
 
 import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
-import com.google.gwt.dev.shell.Icons;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.OperationWithInput;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.rmarkdown.RMarkdownConstants;
 import org.rstudio.studio.client.rmarkdown.model.RmdFrontMatter;
 import org.rstudio.studio.client.rmarkdown.model.RmdFrontMatterOutputOptions;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -26,12 +26,10 @@
 import com.google.inject.Inject;
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.studio.client.application.events.EventBus;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.NotifyingSplitLayoutPanel;
 import org.rstudio.studio.client.workbench.model.ClientState;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.helper.JSObjectStateValue;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 
 import java.util.ArrayList;
 import java.util.Arrays;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -56,7 +56,6 @@
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.studio.client.application.events.EventBus;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.workbench.commands.Commands;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionPopupPanel.java
Patch:
@@ -43,7 +43,6 @@
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.events.SelectionCommitEvent;
 import org.rstudio.core.client.widget.ThemedPopupPanel;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.workbench.views.console.ConsoleResources;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionRequester.QualifiedName;
 import org.rstudio.studio.client.workbench.views.help.model.HelpInfo.ParsedInfo;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -39,7 +39,6 @@
 import org.rstudio.studio.client.application.events.SessionSerializationEvent;
 import org.rstudio.studio.client.application.events.SuspendAndRestartEvent;
 import org.rstudio.studio.client.application.model.SessionSerializationAction;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.ImageMenuItem;
 import org.rstudio.studio.client.common.SimpleRequestCallback;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -69,7 +69,6 @@
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.MouseNavigateEvent;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.AutoGlassPanel;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -100,7 +100,6 @@
 import org.rstudio.studio.client.events.ReplaceRangesEvent.ReplacementData;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntryProvider;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntrySource;
-import org.rstudio.studio.client.quarto.QuartoHelper;
 import org.rstudio.studio.client.events.SetSelectionRangesEvent;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/EditorsTextConstants.java
Patch:
@@ -15,8 +15,6 @@
 
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
-import com.google.gwt.i18n.client.Messages;
-
 public interface EditorsTextConstants extends com.google.gwt.i18n.client.Messages {
     /**
      * Translated "R Console".

File: src/gwt/src/org/rstudio/studio/client/application/ui/RVersionSelectWidget.java
Patch:
@@ -117,7 +117,7 @@ private static RVersionSpec rVersionSpecFromString(String str)
       if (str != null)
       {
          JsArrayString values = StringUtil.split(str, SEP);
-         if (values.length() == 3)
+         if (values.length() >= 3)
          {
             String version = values.get(0);
             String rHomeDir = values.get(1);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/QuartoCommands.java
Patch:
@@ -127,7 +127,7 @@ else if (format.equals(QuartoCommandConstants.INTERACTIVE_OJS))
                      lines.add("format: " + format);
                   }
                   
-                  if (visualEditor && !QuartoConstants.EDITOR_VISUAL.equals(config.project_editor))
+                  if (visualEditor && !QuartoCommandConstants.EDITOR_VISUAL.equals(config.project_editor))
                      lines.add("editor: " + QuartoCommandConstants.EDITOR_VISUAL);
                   
                   if (result.getFormat().equals(QuartoCommandConstants.INTERACTIVE_SHINY))

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorInsertTableDialog.java
Patch:
@@ -22,6 +22,7 @@
 import org.rstudio.core.client.widget.NumericValueWidget;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.TextBoxWithCue;
+import org.rstudio.studio.client.panmirror.PanmirrorConstants;
 import org.rstudio.studio.client.panmirror.dialogs.model.PanmirrorInsertTableResult;
 import org.rstudio.studio.client.panmirror.dialogs.model.PanmirrorTableCapabilities;
 
@@ -39,7 +40,7 @@ public class PanmirrorInsertTableDialog extends ModalDialog<PanmirrorInsertTable
    public PanmirrorInsertTableDialog(PanmirrorTableCapabilities capabilities, 
                                      OperationWithInput<PanmirrorInsertTableResult> operation)
    {
-      super("Insert Table", Roles.getDialogRole(), operation, () -> {
+      super(constants_.insertTableCaption(), Roles.getDialogRole(), operation, () -> {
          // cancel returns null
          operation.execute(null);
       });
@@ -93,7 +94,7 @@ private int readNumeric(NumericValueWidget widget)
    }
    
    interface Binder extends UiBinder<Widget, PanmirrorInsertTableDialog> {}
-   
+   private static final PanmirrorConstants constants_ = GWT.create(PanmirrorConstants.class);
    private Widget mainWidget_;
 
    @UiField NumericValueWidget rows_;

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectSharingPreferencesPane.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.rstudio.core.client.prefs.RestartRequirement;
 import org.rstudio.core.client.resources.ImageResource2x;
+import org.rstudio.studio.client.projects.StudioClientProjectConstants;
 import org.rstudio.studio.client.projects.model.RProjectOptions;
 
 import com.google.gwt.resources.client.ImageResource;
@@ -31,7 +32,7 @@ public ImageResource getIcon()
    @Override
    public String getName()
    {
-      return "Sharing";
+      return constants_.sharingText();
    }
 
    @Override
@@ -45,4 +46,5 @@ public RestartRequirement onApply(RProjectOptions prefs)
    {
       return new RestartRequirement();
    }
+   private static final StudioClientProjectConstants constants_ = com.google.gwt.core.client.GWT.create(StudioClientProjectConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoNewProjectOptions.java
Patch:
@@ -25,7 +25,7 @@ protected QuartoNewProjectOptions()
    public final static QuartoNewProjectOptions createDefault()
    {
       return create(QuartoCommandConstants.PROJECT_DEFAULT, QuartoCommandConstants.ENGINE_KNITR, "python3",
-                    "", "matplotlib pandas", QuartoCommandConstants.EDITOR_SOURCE);
+                    "", "matplotlib pandas", QuartoCommandConstants.EDITOR_VISUAL);
    }
    
    public native final static QuartoNewProjectOptions create(String type, String engine, String kernel, String venv, 

File: src/gwt/src/org/rstudio/studio/client/quarto/ui/NewQuartoDocumentDialog.java
Patch:
@@ -75,7 +75,7 @@ public static final Result createDefault()
                       QuartoCommandConstants.ENGINE_KNITR,
                       "python3", 
                       "python", 
-                      QuartoCommandConstants.EDITOR_SOURCE,
+                      QuartoCommandConstants.EDITOR_VISUAL,
                       false);
       }
 
@@ -529,7 +529,7 @@ private class NewQuartoDocumentClientState extends JSObjectStateValue
       public NewQuartoDocumentClientState()
       {
          super("quarto",
-               "new-document-defaults",
+               "new-document",
                ClientState.PERSISTENT,
                session_.getSessionInfo().getClientState(),
                false);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AceEditorPreview.java
Patch:
@@ -28,12 +28,13 @@
 import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceResources;
+import org.rstudio.studio.client.workbench.prefs.PrefsConstants;
 
 public class AceEditorPreview extends DynamicIFrame
 {
    public AceEditorPreview(String code)
    {
-      super("Editor Theme Preview");
+      super(constants_.editorThemePreview());
       code_ = code;
       Style style = getStyleElement().getStyle();
       style.setBorderColor("#CCC");
@@ -212,4 +213,5 @@ public interface Resources extends ClientBundle
 
    private static Resources RES = GWT.create(Resources.class);
 
+   private static final PrefsConstants constants_ = GWT.create(PrefsConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialog.java
Patch:
@@ -37,6 +37,7 @@
 import org.rstudio.studio.client.workbench.prefs.events.UserPrefsChangedEvent;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
+import org.rstudio.studio.client.workbench.prefs.PrefsConstants;
 
 public class PreferencesDialog extends PreferencesDialogBase<UserPrefs>
 {
@@ -69,7 +70,7 @@ public PreferencesDialog(WorkbenchServerOperations server,
                             UserPrefs userPrefs,
                             UserState userState)
    {
-      super("Options",
+      super(constants_.options(),
             res.styles().panelContainer(),
             res.styles().panelContainerNoChooser(),
             true,
@@ -194,4 +195,5 @@ private static final List<PreferencesDialogPaneBase<UserPrefs>> panes(UserPrefs
    private final UserState state_;
    private final ApplicationQuit quit_;
    private final GlobalDisplay globalDisplay_;
+   private static final PrefsConstants constants_ = GWT.create(PrefsConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -42,6 +42,7 @@
 import com.google.gwt.event.shared.GwtEvent;
 import com.google.gwt.event.shared.HandlerManager;
 import com.google.gwt.event.shared.HandlerRegistration;
+import com.google.gwt.core.client.GWT;
 
 import java.util.function.BiPredicate;
 import java.util.function.Consumer;
@@ -1444,7 +1445,7 @@ class PrintIFrame extends DynamicIFrame
    {
       public PrintIFrame(String code, double fontSize)
       {
-         super("Print Frame");
+         super(constants_.printFrame());
          code_ = code;
          fontSize_ = fontSize;
 
@@ -4707,5 +4708,5 @@ private static final ExternalJavaScriptLoader getLoader(StaticDataResource relea
    private static AceEditor s_lastFocusedEditor = null;
 
    private final List<HandlerRegistration> editorEventListeners_;
-
+   private static final EditorsTextConstants constants_ = GWT.create(EditorsTextConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkConsolePage.java
Patch:
@@ -23,6 +23,7 @@
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.user.client.ui.ScrollPanel;
 import com.google.gwt.user.client.ui.Widget;
+import com.google.gwt.core.client.GWT;
 
 public class ChunkConsolePage extends ChunkOutputPage
                               implements ChunkOutputPresenter.Host
@@ -129,7 +130,7 @@ private void init(ChunkOutputStream stream)
          content_ = panel_;
       }
 
-      thumbnail_ = new ChunkOutputThumbnail("R Console", "", preview_, 
+      thumbnail_ = new ChunkOutputThumbnail(constants_.rConsole(), "", preview_,
             ChunkOutputWidget.getEditorColors());
    }
 
@@ -144,4 +145,5 @@ private void init(ChunkOutputStream stream)
    public final static int CONSOLE_ERROR  = 2;
 
    private final ChunkOutputSize chunkOutputSize_;
+   private static final EditorsTextConstants constants_ = GWT.create(EditorsTextConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkHtmlPage.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
+import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.widget.FixedRatioWidget;
 import org.rstudio.studio.client.rmarkdown.model.NotebookHtmlMetadata;
@@ -54,7 +55,7 @@ public ChunkHtmlPage(String url, NotebookHtmlMetadata metadata,
          url += "?";
       url += "viewer_pane=1&capabilities=1";
 
-      frame_ = new ChunkOutputFrame("Chunk HTML Page Output Frame");
+      frame_ = new ChunkOutputFrame(constants_.chunkHtmlPageOutputFrame());
       
       if (chunkOutputSize != ChunkOutputSize.Full) {
          content_ = new FixedRatioWidget(frame_, 
@@ -156,4 +157,5 @@ public void onEditorThemeChanged(Colors colors)
    final private Widget content_;
    private Colors themeColors_ = null;
    private Command afterRender_;
+   private static final EditorsTextConstants constants_ = GWT.create(EditorsTextConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputGallery.java
Patch:
@@ -201,7 +201,7 @@ public void showCallbackHtml(String htmlOutput, Element parentElement)
 
       if (StringUtil.isNullOrEmpty(htmlOutput))
          return;
-      final ChunkOutputFrame frame = new ChunkOutputFrame("Chunk Feedback");
+      final ChunkOutputFrame frame = new ChunkOutputFrame(constants_.chunkFeedback());
       callbackContent.add(frame);
       viewer_.add(callbackContent);
 
@@ -492,6 +492,7 @@ public void onBrowserEvent(Event evt)
    private final ArrayList<ChunkOutputPage> pages_;
    private final ChunkOutputPresenter.Host host_;
    private final ChunkOutputSize chunkOutputSize_;
+   private static final EditorsTextConstants constants_ = GWT.create(EditorsTextConstants.class);
 
    private ChunkConsolePage console_;
    private SimplePanel content_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkSatelliteWindow.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
+import com.google.gwt.core.client.GWT;
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.dom.client.Element;
 import com.google.gwt.dom.client.Style.Unit;
@@ -85,7 +86,7 @@ protected void onInitialize(LayoutPanel mainPanel, JavaScriptObject params)
    {
       chunkWindowParams_ = params.cast();
 
-      String title = "RStudio: Notebook Output";
+      String title = constants_.chunkSatelliteWindowInitTitle();
       Window.setTitle(title);
 
       ChunkOutputHost chunkOutputHost = new ChunkOutputHost()
@@ -323,6 +324,6 @@ public void onError(ServerError error)
    
    private final Provider<EventBus> pEventBus_;
    private final RMarkdownServerOperations server_;
-
+   private static final EditorsTextConstants constants_ = GWT.create(EditorsTextConstants.class);
    private String currentPlotsReplayId_ = null;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ImagePreviewer.java
Patch:
@@ -207,7 +207,7 @@ public void execute()
       // construct placeholder for image
       final SimplePanel container = new SimplePanel();
       container.addStyleName(RES.styles().container());
-      final Label noImageLabel = new Label("(No image at path " + href + ")");
+      final Label noImageLabel = new Label(constants_.noImageLabel(href));
       
       // resize command (used by various routines that need to respond
       // to width / height change events)
@@ -352,7 +352,7 @@ public void run()
                
                // set new src location (load handler will replace label as needed)
                container.setWidget(new SimplePanel());
-               noImageLabel.setText("(No image at path " + href_ + ")");
+               noImageLabel.setText(constants_.noImageLabel(href_));
                image.getElement().setAttribute("src", imgSrcPathFromHref(
                      sentinel, href_));
                
@@ -596,5 +596,5 @@ interface Resources extends ClientBundle
    
    private static final Resources RES = GWT.create(Resources.class);
    static { RES.styles().ensureInjected(); }
-   
+   private static final EditorsTextConstants constants_ = GWT.create(EditorsTextConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetFindReplace.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
+import com.google.gwt.core.client.GWT;
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.workbench.views.source.editors.text.findreplace.FindReplace;
@@ -59,7 +60,7 @@ public ToolbarButton createFindReplaceButton()
       {
          findReplaceButton_ = new ToolbarButton(
                ToolbarButton.NoText,
-               showReplace_ ? "Find/Replace" : "Find",
+               showReplace_ ? constants_.findOrReplace() : constants_.find(),
                FindReplaceBar.getFindIcon(),
                new ClickHandler() {
                   public void onClick(ClickEvent event)
@@ -195,4 +196,5 @@ public void replaceAndFind()
    private FindReplace findReplace_;
    private FindReplaceBar findReplaceBar_;
    private ToolbarButton findReplaceButton_;
+   private static final EditorsTextConstants constants_ = GWT.create(EditorsTextConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetSqlHelper.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.studio.client.sql.model.SqlServerOperations;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTarget;
 import com.google.inject.Inject;
+import com.google.gwt.core.client.GWT;
 
 public class TextEditingTargetSqlHelper
 {
@@ -73,7 +74,7 @@ public void onResponseReceived(String message)
                      if (!StringUtil.isNullOrEmpty(message))
                      {
                         display_.showErrorMessage(
-                              "Error Previewing SQL",
+                              constants_.errorPreviewingSql(),
                               message);
                      }
                   }
@@ -95,4 +96,5 @@ public void onError(ServerError error)
    
    private GlobalDisplay display_;
    private SqlServerOperations server_;
+   private static final EditorsTextConstants constants_ = GWT.create(EditorsTextConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/palette/AppCommandPaletteItem.java
Patch:
@@ -86,7 +86,7 @@ else if (!command_.isEnabled() || !command_.hasCommandHandlers())
          catch(Exception e)
          {
             display.showErrorMessage(constants_.commandExecutionFailedCaption(),
-                    constants_.commandExecutionFailedMessage(label_, StringUtil.notNull(e.getMessage()));
+                    constants_.commandExecutionFailedMessage(label_, StringUtil.notNull(e.getMessage())));
             Debug.logException(e);
          }
       }

File: src/gwt/src/org/rstudio/studio/client/palette/PaletteConstants.java
Patch:
@@ -83,11 +83,11 @@ public interface PaletteConstants extends Messages {
     String cmdPaletteClearedCaption();
 
     /**
-     * Translate ""The Command Palette's list of recently used items has been cleared.".
+     * Translate "The Command Palette's list of recently used items has been cleared.".
      *
      * @return the translated value
      */
-    @DefaultMessage("The Command Palette's list of recently used items has been cleared.")
+    @DefaultMessage("The Command Palette''s list of recently used items has been cleared.")
     @Key("cmdPaletteClearedMessage")
     String cmdPaletteClearedMessage();
 

File: src/gwt/src/org/rstudio/studio/client/quarto/QuartoNewDocument.java
Patch:
@@ -53,7 +53,7 @@ public void newDocument(boolean presentation, CommandWithArg<String> onResult)
          indicator.onProgress(
                  constants_.newQuartoItemMessage(
                          presentation ? constants_.presentationLabel() : constants_.documentLabel()
-                 );
+                 ));
    
          server_.quartoCapabilities(
             new SimpleRequestCallback<QuartoCapabilities>() {

File: src/gwt/src/org/rstudio/studio/client/quarto/ui/NewQuartoDocumentDialog.java
Patch:
@@ -409,7 +409,7 @@ else if (selectedTemplate.equals(TEMPLATE_PRESENTATION))
          templateFormatPanel_.add(createFormatOption(
             QuartoCommandConstants.FORMAT_PPTX,
             constants_.powerPointFormatText(),
-            constants_.powerPointFormatDesc());
+            constants_.powerPointFormatDesc()));
       }
       else if (selectedTemplate.equals(TEMPLATE_INTERACTIVE))
       {

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdTemplateChooser.java
Patch:
@@ -125,7 +125,7 @@ public void onError(ServerError error)
          {
             RStudioGinjector.INSTANCE.getGlobalDisplay().showErrorMessage(
                   constants_.templatesNotFoundErrorCaption(),
-                  constants_.templatesNotFoundErrorMsg(error.getMessage());
+                  constants_.templatesNotFoundErrorMsg(error.getMessage()));
             
          }
       });

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewQuartoProjectPage.java
Patch:
@@ -255,7 +255,7 @@ private class ClientStateValue extends JSObjectStateValue
       public ClientStateValue()
       {
          super("quarto",
-               "quarto-new-proj-defaults",
+               "quarto-new-proj",
                ClientState.PERSISTENT,
                session_.getSessionInfo().getClientState(),
                false);

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoNewProjectOptions.java
Patch:
@@ -25,7 +25,7 @@ protected QuartoNewProjectOptions()
    public final static QuartoNewProjectOptions createDefault()
    {
       return create(QuartoConstants.PROJECT_DEFAULT, QuartoConstants.ENGINE_KNITR, "python3", 
-                    "", "matplotlib pandas", QuartoConstants.EDITOR_SOURCE);
+                    "", "matplotlib pandas", QuartoConstants.EDITOR_VISUAL);
    }
    
    public native final static QuartoNewProjectOptions create(String type, String engine, String kernel, String venv, 

File: src/gwt/src/org/rstudio/studio/client/quarto/ui/NewQuartoDocumentDialog.java
Patch:
@@ -74,7 +74,7 @@ public static final Result createDefault()
                       QuartoConstants.ENGINE_KNITR, 
                       "python3", 
                       "python", 
-                      QuartoConstants.EDITOR_SOURCE,
+                      QuartoConstants.EDITOR_VISUAL,
                       false);
       }
 
@@ -529,7 +529,7 @@ private class NewQuartoDocumentClientState extends JSObjectStateValue
       public NewQuartoDocumentClientState()
       {
          super("quarto",
-               "new-document-defaults",
+               "new-document",
                ClientState.PERSISTENT,
                session_.getSessionInfo().getClientState(),
                false);

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorConstants.java
Patch:
@@ -1896,11 +1896,11 @@ public interface PanmirrorConstants extends com.google.gwt.i18n.client.Messages
     String readingBibliographyProgressText();
 
     /**
-     * Translated "Saving biliography...".
+     * Translated "Saving bibliography...".
      *
-     * @return translated "Saving biliography..."
+     * @return translated "Saving bibliography..."
      */
-    @DefaultMessage("Saving biliography...")
+    @DefaultMessage("Saving bibliography...")
     @Key("savingBibliographyProgressText")
     String savingBibliographyProgressText();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1628,7 +1628,7 @@ public void installTinyTeX()
       };
 
       dependencyManager_.withTinyTeX(
-            constants_.installTinyTeX(),
+            constants_.installTinytexLowercase(),
             constants_.installTinyTeX(),
             onInstall);
    }

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -682,4 +682,7 @@ public String toString()
    // VersionsPopupMenu
    public final static String VERSIONS_POPUP_MENU = "versions_popup_menu";
 
+   // R Console Toolbar
+   public final static String CONSOLE_SESSION_SUSPENDED = "r_session_suspended_console";
+   public final static String CONSOLE_SESSION_SUSPEND_BLOCKED = "r_session_suspend_blocked_console";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/ConsolePreferencesPane.java
Patch:
@@ -72,6 +72,8 @@ public ConsolePreferencesPane(UserPrefs prefs,
       spacedBefore(otherLabel);
       add(otherLabel);
       add(spaced(checkboxPref("Double-click to select words", prefs_.consoleDoubleClickSelect())));
+      add(spaced(checkboxPref("Warn when automatic session suspension is paused", prefs_.consoleSuspendBlockedNotice())));
+      add(indent(numericPref("Number of seconds to delay warning", prefs_.consoleSuspendBlockedNoticeDelay())));
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -1241,7 +1241,7 @@ private ArrayList<Dependency> getFeatureDependencies(String feature)
          if (dep == null)
          {
             Debug.logWarning("No dependency record found for package '" +
-                             packages.get(i) + constants_.requiredByFeatureLog() +
+                             packages.get(i) + "' (required by feature '" +
                              feature + "')");
             continue;
          }

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -132,7 +132,7 @@ public void openSatellite(String name,
       // if we don't need to.
       if (isCurrentWindowSatellite())
       {
-         Debug.log("Satellite windows can't launch other satellites");;
+         Debug.log("Satellite windows can't launch other satellites");
          assert false;
          return;
       }

File: src/gwt/src/org/rstudio/core/client/StringUtil.java
Patch:
@@ -133,11 +133,11 @@ public static String formatFileSize(long size)
    public static String formatElapsedTime(int seconds)
    {
       if (seconds < 60)
-         return seconds + " " + (seconds == 1 ? constants_.secondLabel()  : constants_.secondPluralLabel());
+         return (seconds == 1 ? constants_.secondLabel(seconds)  : constants_.secondPluralLabel(seconds));
       else if (seconds < 3600)
-         return (seconds / 60) + " " + ((seconds / 60) == 1 ? constants_.minuteLabel() : constants_.minutePluralLabel());
+         return (seconds / 60) == 1 ? constants_.minuteLabel(seconds / 60) : constants_.minutePluralLabel(seconds / 60);
       else
-         return (seconds / 3600) + " " + ((seconds / 3600) == 1 ? constants_.hourLabel() : constants_.hourPluralLabel());
+         return (seconds / 3600) == 1 ? constants_.hourLabel(seconds / 3600) : constants_.hourPluralLabel(seconds / 3600);
    }
 
    /**

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedWindowFrame.java
Patch:
@@ -60,7 +60,7 @@ public MinimizedWindowFrame(String title, String accessibleName, Widget extraWid
       layout_.addStyleName(themeStyles.rstheme_minimizedWindowObject());
 
       Roles.getRegionRole().set(layout_.getElement());
-      Roles.getRegionRole().setAriaLabelProperty(layout_.getElement(),  constants_.minimizedTabListRole("accessibleName_"));
+      Roles.getRegionRole().setAriaLabelProperty(layout_.getElement(),  constants_.minimizedTabListRole(accessibleName));
 
       int leftPadding = title != null ? 8 : 4;
       layout_.addWest(createDiv(themeStyles.left()), leftPadding);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeChunk.java
Patch:
@@ -854,7 +854,7 @@ public void showLint(JsArray<LintItem> lint)
             else if (StringUtil.equals(item.getType(), "info"))
                clazz += ThemeStyles.INSTANCE.gutterInfo();
             else if (StringUtil.equals(item.getType(), "warning"))
-               clazz += ThemeStyles.INSTANCE.gutterInfo();
+               clazz += ThemeStyles.INSTANCE.gutterWarning();
             List<VisualModeChunkRowState> states = setRowState(
                item.getStartRow() + 1,
                item.getStartRow() + 1,

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -146,7 +146,7 @@ else if (workbenchContext_.isServerBusy() && terminalHelper_.warnBeforeClosing(b
             globalDisplay_.showYesNoMessage(
                   MessageDialog.QUESTION,
                   caption, 
-                  msg + " " + constants_.applicationQuitMessage(),
+                  constants_.applicationQuitMessage(msg),
                   () -> handleUnfinishedWork(caption, allowCancel, forceSaveAll, quitContext),
                   true);
          }

File: src/gwt/src/org/rstudio/studio/client/application/model/ProductEditionInfo.java
Patch:
@@ -23,7 +23,7 @@ public class ProductEditionInfo
 {
    public String editionName()
    {
-      return "RStudio" + (Desktop.isDesktop() ? "" : " " + constants_.rStudioEditionName());
+      return constants_.rStudioEditionName(Desktop.isDesktop() ? "" : " " + constants_.serverLabel());
    }
    
    public boolean proLicense()

File: src/gwt/src/org/rstudio/studio/client/application/ui/RequestLogDetail.java
Patch:
@@ -45,11 +45,11 @@ public RequestLogDetail(RequestLogEntry entry)
       panel.getElement().getStyle().setOverflow(Overflow.AUTO);
 
       HTML html = new HTML();
-      html.setText(constants_.requestIdText() + entry.getRequestId() + "\n\n"
-                   + constants_.requestText()
+      html.setText("Request ID: " + entry.getRequestId() + "\n\n"
+                   + "== REQUEST ======\n"
                    + tryPrettyJson(req)
                    + "\n\n"
-                   + constants_.responseText()
+                   + "== RESPONSE ======\n"
                    + tryPrettyJson(resp)
                    + "\n");
       html.getElement().getStyle().setProperty("whiteSpace", "pre-wrap");

File: src/gwt/src/org/rstudio/core/client/widget/MiniDialogPopupPanel.java
Patch:
@@ -70,7 +70,7 @@ private void commonInit()
       toolsPanel.setStyleName(ThemeStyles.INSTANCE.miniDialogTools());
       ToolbarButton hideButton = new ToolbarButton(
             ToolbarButton.NoText,
-            constants_.closeButtonText(),
+            constants_.closeText(),
             new ImageResource2x(ThemeResources.INSTANCE.closeChevron2x()),
             new ClickHandler() { 
                public void onClick(ClickEvent event)

File: src/gwt/src/org/rstudio/core/client/widget/ShowContentDialog.java
Patch:
@@ -59,7 +59,7 @@ public ShowContentDialog(String title, String content, Size preferredSize)
 
    protected void addButtons()
    {
-      ThemedButton closeButton = new ThemedButton(constants_.closeButtonText(), clickEvent -> closeDialog());
+      ThemedButton closeButton = new ThemedButton(constants_.closeText(), clickEvent -> closeDialog());
       addOkButton(closeButton);
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/debugging/BreakpointManager.java
Patch:
@@ -451,8 +451,7 @@ public void onDebugClearBreakpoints()
       globalDisplay_.showYesNoMessage(
             MessageDialog.QUESTION,
             constants_.clearAllBreakpointsCaption(),
-            constants_.clearAllBreakpointsMessage() +
-            constants_.projectText(),
+            constants_.clearAllBreakpointsMessage(),
             new Operation() {
                @Override
                public void execute()

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleErrorFrame.java
Patch:
@@ -53,7 +53,7 @@ public ConsoleErrorFrame(int number, ErrorFrame frame)
       frame_ = frame;
 
       boolean hasSource = !frame.getFileName().isEmpty();
-      functionName.setText(frame.getFunctionName() + (hasSource ? " " + constants_.atText() : ""));
+      functionName.setText(constants_.functionNameText(frame.getFunctionName(), (hasSource ? " " + constants_.atText() : "")));
       frameNumber.setText((Integer.valueOf(number)).toString() + ".");
       if (hasSource)
       {

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -1240,7 +1240,7 @@ private ArrayList<Dependency> getFeatureDependencies(String feature)
          Dependency dep = list.getPackage(packages.get(i));
          if (dep == null)
          {
-            Debug.logWarning(constants_.noDependencyRecordFoundLog() +
+            Debug.logWarning("No dependency record found for package '" +
                              packages.get(i) + constants_.requiredByFeatureLog() +
                              feature + "')");
             continue;

File: src/gwt/src/org/rstudio/studio/client/common/fileexport/FileExport.java
Patch:
@@ -135,8 +135,7 @@ private void showFileExport(String caption,
    {
       globalDisplay_.promptForText(
             caption,
-            constants_.theText() + description + " " + constants_.downloadedLabel() +
-            constants_.specifyDownloadFileLabel(),
+            constants_.showFileExportLabel(description),
             defaultName + defaultExtension,
             -1, -1,
             constants_.downloadButtonCaption(),

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/CodeBrowserType.java
Patch:
@@ -31,7 +31,7 @@ public CodeBrowserType()
    @Override
    public void openFile(FileSystemItem file, EventBus eventBus)
    {
-      assert false : constants_.openFileCodeBrowserMessage();
+      assert false : "CodeBrowserType doesn't operate on filesystem files";
    }
    private static final StudioClientCommonConstants constants_ = GWT.create(StudioClientCommonConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/DataFrameType.java
Patch:
@@ -31,7 +31,7 @@ public DataFrameType()
    @Override
    public void openFile(FileSystemItem file, EventBus eventBus)
    {
-      assert false : constants_.openFileMessage();
+      assert false : "DataFrameType doesn't operate on filesystem files";
    }
    private static final StudioClientCommonConstants constants_ = GWT.create(StudioClientCommonConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ObjectExplorerFileType.java
Patch:
@@ -33,7 +33,7 @@ public ObjectExplorerFileType()
    protected void openFile(FileSystemItem file, EventBus eventBus)
    {
       assert false :
-         constants_.objectExplorerOpenFileMessage();
+         "Object explorer doesn't operate on filesystem files";
    }
    
    public static final String ID = "object_explorer";

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/UrlContentType.java
Patch:
@@ -31,7 +31,7 @@ public UrlContentType()
    @Override
    public void openFile(FileSystemItem file, EventBus eventBus)
    {
-      assert false : constants_.urlContentMessage();
+      assert false : "urlcontent doesn't apply to filesystem files";
    }
    private static final StudioClientCommonConstants constants_ = GWT.create(StudioClientCommonConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/common/rpubs/RPubsUploader.java
Patch:
@@ -164,8 +164,7 @@ public void onResponseReceived(Boolean response)
                   onUploadComplete(false);
                   globalDisplay_.showErrorMessage(
                          constants_.errorCaption(),
-                         constants_.unableToContinueMessage() +
-                         constants_.currentlyRunningMessage());
+                         constants_.unableToContinueMessage());
                }
             }
             

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/ui/AskSecretDialog.java
Patch:
@@ -114,9 +114,7 @@ public void onKeyDown(KeyDownEvent event)
          );
 
          Label infoLabel = new Label(
-            constants_.keyringDesc() +
-            constants_.keyringCredentialStoreMessage() +
-            constants_.keyringSecureMessage()
+                 constants_.keyringDesc()
          );
 
          HTML questionHtml = new HTML(

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellInteractionManager.java
Patch:
@@ -81,7 +81,7 @@ public void consoleWriteError(String error)
    {
       // show the error in the console then re-prompt
       display_.consoleWriteError(
-            constants_.consoleWriteError() + error + "\n");
+              constants_.consoleWriteError(error));
       if (lastPromptText_ != null)
          consolePrompt(lastPromptText_, false);
    }

File: src/gwt/src/org/rstudio/studio/client/common/spelling/RealtimeSpellChecker.java
Patch:
@@ -25,7 +25,6 @@
 
 import org.rstudio.core.client.Debug;
 import org.rstudio.studio.client.RStudioGinjector;
-import org.rstudio.studio.client.common.StudioClientCommonConstants;
 import org.rstudio.studio.client.common.spelling.model.SpellCheckerResult;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
@@ -309,5 +308,4 @@ public boolean shouldCheckWord(String word)
 
    private SpellingService spellingService_;
    private UserPrefs userPrefs_;
-   private static final StudioClientCommonConstants constants_ = GWT.create(StudioClientCommonConstants.class);
 }

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ShowPublicKeyDialog.java
Patch:
@@ -59,8 +59,7 @@ protected Widget createMainWidget()
       int mod = BrowseCap.hasMetaKey() ? KeyboardShortcut.META : 
                                          KeyboardShortcut.CTRL;
       String cmdText = new KeyCombination("c", 'C', mod).toString(true);
-      HTML label = new HTML(constants_.pressLabel() + cmdText +
-                            " " + constants_.copyKeyToClipboardLabel());
+      HTML label = new HTML(constants_.pressLabel(cmdText));
       label.addStyleName(RES.styles().viewPublicKeyLabel());
       panel.add(label);
       ElementIds.assignElementId(label, ElementIds.PUBLIC_KEY_LABEL);

File: src/gwt/src/org/rstudio/studio/client/common/viewfile/ViewFilePanel.java
Patch:
@@ -358,7 +358,7 @@ public void onUnload()
    private void saveFileAs()
    {
       fileDialogs_.saveFile(
-            constants_.saveFileCaption() + targetFile_.getName(),
+            constants_.saveFileCaption(targetFile_.getName()),
             fileContext_, 
             FileSystemItem.createFile(
                 session_.getSessionInfo().getActiveProjectDir()

File: src/gwt/src/org/rstudio/core/client/MessageDisplay.java
Patch:
@@ -332,8 +332,7 @@ public void showPopupBlockedMessage(Operation yesOperation)
    {
       showYesNoMessage(
             GlobalDisplay.MSG_POPUP_BLOCKED,
-            constants_.popupBlockCaption(), constants_.showPopupBlockMessage() +
-            Window.Location.getHostName() + ".",
+            constants_.popupBlockCaption(), constants_.showPopupBlockMessage(Window.Location.getHostName()),
             false,
             yesOperation,
             () -> {},

File: src/gwt/src/org/rstudio/core/client/StringUtil.java
Patch:
@@ -133,11 +133,11 @@ public static String formatFileSize(long size)
    public static String formatElapsedTime(int seconds)
    {
       if (seconds < 60)
-         return seconds + " " + constants_.secondLabel() + (seconds == 1 ? "" : "s");
+         return seconds + " " + (seconds == 1 ? constants_.secondLabel()  : constants_.secondPluralLabel());
       else if (seconds < 3600)
-         return (seconds / 60) + " " + constants_.minuteLabel() + ((seconds / 60) == 1 ? "" : "s");
+         return (seconds / 60) + " " + ((seconds / 60) == 1 ? constants_.minuteLabel() : constants_.minutePluralLabel());
       else
-         return (seconds / 3600) + " " + constants_.hourLabel() + ((seconds / 3600) == 1 ? "" : "s");
+         return (seconds / 3600) + " " + ((seconds / 3600) == 1 ? constants_.hourLabel() : constants_.hourPluralLabel());
    }
 
    /**

File: src/gwt/src/org/rstudio/core/client/widget/ProgressDialog.java
Patch:
@@ -172,7 +172,7 @@ protected void hideProgress()
       {
          operationStarted_ = false;
          announceCompletion(StringUtil.isNullOrEmpty(labelText_) ?
-            constants_.operationCompletedText() : labelText_ + " " + constants_.completedText());
+            constants_.operationCompletedText() : constants_.completedText(labelText_));
       }
       progressAnim_.getElement().getStyle().setDisplay(Style.Display.NONE);
    }

File: src/gwt/src/org/rstudio/core/client/widget/ProgressSpinner.java
Patch:
@@ -62,7 +62,7 @@ public ProgressSpinner(int color)
       canvas_ = Canvas.createIfSupported();
       if (canvas_ == null)
       {
-         Debug.log(constants_.progressSpinnerLog());
+         Debug.log("Can't create progress spinner (no HTML5 canvas support)");
          initWidget(new HTMLPanel(""));
          return;
       }

File: src/gwt/src/org/rstudio/core/client/widget/TextBoxWithButton.java
Patch:
@@ -126,7 +126,7 @@ public TextBoxWithButton(String label,
       FlowPanel outer = new FlowPanel();
       if (label != null)
       {
-         assert existingLabel == null : constants_.existingLabelMessage();
+         assert existingLabel == null : "Invalid usage, cannot provide both label and existingLabel";
 
          lblCaption_ = new FormLabel(label, true);
          if (helpButton != null)

File: src/gwt/src/org/rstudio/core/rebind/command/ShortcutsEmitter.java
Patch:
@@ -142,7 +142,7 @@ else if (m.equals("Meta"))
             {
                logger_.log(
                      Type.ERROR,
-                "Invalid modifier '" + m + "'; expected one of " +
+                     "Invalid modifier '" + m + "'; expected one of " +
                      "'Ctrl', 'Alt', 'Shift', 'Meta'");
                
                throw new UnableToCompleteException();
@@ -212,7 +212,7 @@ else if (keys.size() == 2)
       {
          logger_.log(
                Type.ERROR,
-          "Invalid key sequence: sequences must be of length 1 or 2");
+               "Invalid key sequence: sequences must be of length 1 or 2");
          throw new UnableToCompleteException();
       }
       

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileDialog.java
Patch:
@@ -145,7 +145,7 @@ protected boolean shouldAccept()
       {
          if (item.isDirectory())
          {
-            assert false : constants_.navigateIfDirectoryMessage();
+            assert false : "This case should be covered by navigateIfDirectory";
             return false;
          }
          else if (promptOnOverwrite_)
@@ -237,4 +237,4 @@ public void onError(String errorMessage)
    protected boolean allowNonexistentFile_;
    private boolean attemptAcceptOnNextNavigate_ = false;
    private static final CoreClientConstants constants_ = GWT.create(CoreClientConstants.class);
-}
\ No newline at end of file
+}

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedModuleTabLayoutPanel.java
Patch:
@@ -46,7 +46,7 @@ public void setTabs(String[] tabNames)
       HorizontalPanel horiz = (HorizontalPanel) getExtraWidget();
       horiz.clear();
       Roles.getTablistRole().set(horiz.getElement());
-      Roles.getTablistRole().setAriaLabelProperty(horiz.getElement(), accessibleName_ + " " + constants_.minimizedTabListRole());
+      Roles.getTablistRole().setAriaLabelProperty(horiz.getElement(), constants_.minimizedTabListRole("accessibleName_"));
 
       ThemeStyles styles = ThemeResources.INSTANCE.themeStyles();
       for (int i = 0; i < tabNames.length; i++)

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedWindowFrame.java
Patch:
@@ -60,7 +60,7 @@ public MinimizedWindowFrame(String title, String accessibleName, Widget extraWid
       layout_.addStyleName(themeStyles.rstheme_minimizedWindowObject());
 
       Roles.getRegionRole().set(layout_.getElement());
-      Roles.getRegionRole().setAriaLabelProperty(layout_.getElement(), accessibleName + " " + constants_.minimizedTabListRole());
+      Roles.getRegionRole().setAriaLabelProperty(layout_.getElement(),  constants_.minimizedTabListRole("accessibleName_"));
 
       int leftPadding = title != null ? 8 : 4;
       layout_.addWest(createDiv(themeStyles.left()), leftPadding);

File: src/gwt/src/org/rstudio/core/client/theme/ModuleTabLayoutPanel.java
Patch:
@@ -73,7 +73,7 @@ public ModuleTab(String title, ThemeStyles styles, boolean canClose, boolean min
             closeButton_ = new Image(new ImageResource2x(ThemeResources.INSTANCE.closeTab2x()));
             closeButton_.setStylePrimaryName(styles.closeTabButton());
             closeButton_.addStyleName(ThemeStyles.INSTANCE.handCursor());
-            closeButton_.setAltText(constants_.closeButtonText() + " " + title + " " + constants_.closeAltTabText());
+            closeButton_.setAltText(constants_.closeButtonText(title));
             center.add(closeButton_);
          }
          layoutPanel.add(center);

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -781,7 +781,7 @@ public void refreshFocusableElements()
       ArrayList<Element> focusable = getFocusableElements();
       if (focusable.size() == 0)
       {
-         Debug.logWarning(constants_.noFocusableControlsLog());
+         Debug.logWarning("No potentially focusable controls found in modal dialog");
          return;
       }
       focus_.setFirst(focusable.get(0));

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewQuartoProjectPage.java
Patch:
@@ -255,7 +255,7 @@ private class ClientStateValue extends JSObjectStateValue
       public ClientStateValue()
       {
          super("quarto",
-               "quarto-new-proj",
+               "quarto-new-proj-defaults",
                ClientState.PERSISTENT,
                session_.getSessionInfo().getClientState(),
                false);

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoNewProjectOptions.java
Patch:
@@ -25,7 +25,7 @@ protected QuartoNewProjectOptions()
    public final static QuartoNewProjectOptions createDefault()
    {
       return create(QuartoConstants.PROJECT_DEFAULT, QuartoConstants.ENGINE_KNITR, "python3", 
-                    "", "matplotlib pandas", QuartoConstants.EDITOR_VISUAL);
+                    "", "matplotlib pandas", QuartoConstants.EDITOR_SOURCE);
    }
    
    public native final static QuartoNewProjectOptions create(String type, String engine, String kernel, String venv, 

File: src/gwt/src/org/rstudio/studio/client/quarto/ui/NewQuartoDocumentDialog.java
Patch:
@@ -74,7 +74,7 @@ public static final Result createDefault()
                       QuartoConstants.ENGINE_KNITR, 
                       "python3", 
                       "python", 
-                      QuartoConstants.EDITOR_VISUAL,
+                      QuartoConstants.EDITOR_SOURCE,
                       false);
       }
 
@@ -529,7 +529,7 @@ private class NewQuartoDocumentClientState extends JSObjectStateValue
       public NewQuartoDocumentClientState()
       {
          super("quarto",
-               "new-document",
+               "new-document-defaults",
                ClientState.PERSISTENT,
                session_.getSessionInfo().getClientState(),
                false);

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -53,7 +53,6 @@ public interface ThemeStyles extends CssResource
    String rstheme_secondaryToolbar();
    String secondaryToolbarPanel();
    String globalToolbar();
-   String desktopGlobalToolbar();
    String webGlobalToolbar();
    String webHeaderBarCommandsProjectMenu();
    String toolbarButton();

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -198,7 +198,6 @@ public void onShowFolder(ShowFolderEvent event)
       toolbar_ = new GlobalToolbar(commands, pCodeSearch);
       ThemeStyles styles = ThemeResources.INSTANCE.themeStyles();
       toolbar_.getWrapper().addStyleName(styles.desktopGlobalToolbarWrapper());
-      toolbar_.addStyleName(styles.desktopGlobalToolbar());
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleInterpreterVersion.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.console;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.studio.client.RStudioGinjector;
@@ -82,7 +83,8 @@ public ConsoleInterpreterVersion(boolean isTabbedView)
       label_.addStyleName(isTabbedView
             ? RES.styles().labelTabbed()
             : RES.styles().labelUntabbed());
-      
+      ElementIds.assignElementId(label_, ElementIds.CONSOLE_INTERPRETER_VERSION + (isTabbedView ? "_tabbed" : ""));
+
       if (isPythonActive())
       {
          container_.add(pythonLogo_);

File: src/gwt/src/org/rstudio/studio/client/quarto/QuartoHelper.java
Patch:
@@ -25,7 +25,7 @@ public class QuartoHelper
    public static boolean isQuartoWebsiteConfig(QuartoConfig config)
    {
       return config.is_project &&
-            (config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_SITE ||
+            (config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_WEBSITE ||
             config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_BOOK);
    }
    

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoConstants.java
Patch:
@@ -28,7 +28,7 @@ public class QuartoConstants
    public final static String INTERACTIVE_OJS = "ojs";
    
    public final static String PROJECT_DEFAULT = "default";
-   public final static String PROJECT_WEBSITE = "site";
+   public final static String PROJECT_WEBSITE = "website";
    public final static String PROJECT_BOOK = "book";
    
    public final static String ENGINE_MARKDOWN = "markdown";

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -347,7 +347,7 @@ public final native boolean getIsDistillProject() /*-{
       return this.is_distill_project;
    }-*/;
    
-   public final static String QUARTO_PROJECT_TYPE_SITE = "site";
+   public final static String QUARTO_PROJECT_TYPE_WEBSITE = "website";
    public final static String QUARTO_PROJECT_TYPE_BOOK = "book";
 
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildCommands.java
Patch:
@@ -80,9 +80,9 @@ public static void setBuildCommandState(Commands commands,
             projType = "Book";
          }
          if (sessionInfo.getQuartoConfig().project_type.equals(
-               SessionInfo.QUARTO_PROJECT_TYPE_SITE)) 
+               SessionInfo.QUARTO_PROJECT_TYPE_WEBSITE)) 
          {
-            projType = "Site";
+            projType = "Website";
          }
          commands.buildAll().setMenuLabel("_Render " + projType);
          commands.buildAll().setButtonLabel("Render " + projType);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -501,9 +501,9 @@ private void syncBuildAllUI()
       else if (type == SessionInfo.BUILD_TOOLS_QUARTO)
       {
          QuartoConfig config = sessionInfo.getQuartoConfig();
-         if (config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_SITE)
+         if (config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_WEBSITE)
          {
-            buildAllButton_.setText("Render Site");
+            buildAllButton_.setText("Render Website");
          }
          else if (config.project_type == SessionInfo.QUARTO_PROJECT_TYPE_BOOK)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation2/Presentation2Pane.java
Patch:
@@ -165,7 +165,7 @@ public void activate()
    @Override
    public void setFocus()
    {
-      if (frame_ != null)
+      if (frame_ != null && frame_.getIFrame() != null)
          frame_.getIFrame().setFocus();
       else
          super.setFocus();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation2/Presentation2Pane.java
Patch:
@@ -197,7 +197,7 @@ public void navigate(String url, QuartoNavigate nav)
       int frameWidth = frame_.getOffsetWidth();
       if (frameWidth > 0)
       {
-         double ratio = (double)700 / 960;
+         double ratio = (double)700 / 1050;
          ensureHeight((int)(frameWidth * ratio) + getToolbarsHeight());
       }
       

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -1147,7 +1147,7 @@ private void configureShinyApp(String dir,
    private final native void exportNativeCallbacks() /*-{
       var thiz = this;
       $wnd.deployToRSConnect = $entry(
-         function(sourceFile, deployDir, deployFile, websiteDir, description, deployFiles, additionalFiles, ignoredFiles, isSelfContained, isShiny, asMultiple, asStatic, launch, record) {
+         function(sourceFile, deployDir, deployFile, websiteDir, description, deployFiles, additionalFiles, ignoredFiles, isSelfContained, isShiny, asMultiple, asStatic, isQuarto, launch, record) {
             thiz.@org.rstudio.studio.client.rsconnect.RSConnect::deployToRSConnect(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Lcom/google/gwt/core/client/JsArrayString;Lcom/google/gwt/core/client/JsArrayString;Lcom/google/gwt/core/client/JsArrayString;ZZZZZZLcom/google/gwt/core/client/JavaScriptObject;)(sourceFile, deployDir, deployFile, websiteDir, description, deployFiles, additionalFiles, ignoredFiles, isSelfContained, isShiny, asMultiple, asStatic, isQuarto, launch, record);
          }
       );

File: src/gwt/src/org/rstudio/core/client/command/KeySequence.java
Patch:
@@ -186,7 +186,7 @@ public boolean equals(Object object)
          return false;
 
       for (int i = 0; i < keyCombinations_.size(); i++)
-         if (keyCombinations_.get(i) != other.keyCombinations_.get(i))
+         if (!keyCombinations_.get(i).equals(other.keyCombinations_.get(i)))
             return false;
 
       return true;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/QuartoCommands.java
Patch:
@@ -132,7 +132,9 @@ else if (!interactive && result.getEngine().equals(QuartoConstants.ENGINE_JUPYTE
    
                   columnManager_.newSourceDocWithTemplate(FileTypeRegistry.QUARTO,
                      "",
-                     result.getEmpty() ? "default.qmd" : template,
+                     result.getEmpty() || result.getEngine().equals(QuartoConstants.ENGINE_MARKDOWN) 
+                        ? "default.qmd" 
+                        : template,
                      Position.create(1, 0),
                      null,
                      new TransformerCommand<String>()

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -1147,7 +1147,7 @@ private void configureShinyApp(String dir,
    private final native void exportNativeCallbacks() /*-{
       var thiz = this;
       $wnd.deployToRSConnect = $entry(
-         function(sourceFile, deployDir, deployFile, websiteDir, description, deployFiles, additionalFiles, ignoredFiles, isSelfContained, isShiny, asMultiple, asStatic, launch, record) {
+         function(sourceFile, deployDir, deployFile, websiteDir, description, deployFiles, additionalFiles, ignoredFiles, isSelfContained, isShiny, asMultiple, asStatic, isQuarto, launch, record) {
             thiz.@org.rstudio.studio.client.rsconnect.RSConnect::deployToRSConnect(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Lcom/google/gwt/core/client/JsArrayString;Lcom/google/gwt/core/client/JsArrayString;Lcom/google/gwt/core/client/JsArrayString;ZZZZZZLcom/google/gwt/core/client/JavaScriptObject;)(sourceFile, deployDir, deployFile, websiteDir, description, deployFiles, additionalFiles, ignoredFiles, isSelfContained, isShiny, asMultiple, asStatic, isQuarto, launch, record);
          }
       );

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryNavigationPage.java
Patch:
@@ -83,7 +83,9 @@ public Widget createMainWidget(ArrayList<WizardPage<NewProjectInput, NewProjectR
       pages.add(new NewPackagePage());
       pages.add(new NewShinyAppPage());
       if (sessionInfo.getQuartoConfig().installed) {
-         pages.add(new NewQuartoProjectPage());
+         pages.add(new NewQuartoDefaultProjectPage());
+         pages.add(new NewQuartoWebsiteProjectPage());
+         pages.add(new NewQuartoBookProjectPage());
       }
       
       // add user-defined project template dialogs

File: src/gwt/src/org/rstudio/studio/client/panmirror/format/PanmirrorExtendedDocType.java
Patch:
@@ -21,5 +21,6 @@ public class PanmirrorExtendedDocType
    public static String bookdown = "bookdown";
    public static String hugo = "hugo";
    public static String quarto = "quarto";
+   public static String presentation = "presentation";
 }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/YamlCompletionManager.java
Patch:
@@ -120,7 +120,8 @@ public boolean getCompletions(String line, CompletionRequestContext context)
       String code = docDisplay_.getCode();
       
       // call for completions
-      source.getCompletions(location, line, code, pos, (res) -> {
+      YamlCompletionParams params = YamlCompletionParams.create(location, line, code, pos);
+      source.getCompletions(params, (res) -> {
          
          // default "empty" completion response
          String token = "";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/YamlCompletionSource.java
Patch:
@@ -17,7 +17,6 @@
 
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.studio.client.workbench.views.source.editors.text.CompletionContext;
-import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Position;
 
 import elemental2.core.JsObject;
 
@@ -29,5 +28,5 @@ public interface YamlCompletionSource
    
    boolean isActive(CompletionContext context);
    
-   void getCompletions(String location, String line, String code, Position pos, CommandWithArg<JsObject> results);
+   void getCompletions(YamlCompletionParams params, CommandWithArg<JsObject> results);
 }

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcRequest.java
Patch:
@@ -144,7 +144,7 @@ public void onResponseReceived(Request request,
                         Debug.log("Response: " + responseText);
                      requestLogEntry_.logResponse(ResponseType.Normal,
                                                  responseText);
-                     rpcResponse = RpcResponse.parse(responseText);
+                     rpcResponse = RpcResponse.parseUnsafe(responseText);
                      
                      // response received and validated, process it!
                      requestCallback.onResponseReceived(enclosingRequest, 

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerAuth.java
Patch:
@@ -176,7 +176,7 @@ public void onSubmitComplete(SubmitCompleteEvent event)
          {
             // parse the results
             String results = event.getResults();
-            RpcResponse response = RpcResponse.parse(event.getResults());
+            RpcResponse response = RpcResponse.parseUnsafe(event.getResults());
             if (response != null)
             {
                logEntry.logResponse(ResponseType.Normal, results);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -702,7 +702,7 @@ public void execute()
          {
             if (errors.size() > 0)
             {
-               String caption = "Error Opening Files in Columns";
+               String caption = "Error Opening Files";
                String errorMsg = errors.size() + " RNotebook files were unable to be processed and opened.";
                errorMsg += "\n\nErrors:";
                for (String err : errors) 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/model/FilesServerOperations.java
Patch:
@@ -75,7 +75,6 @@ void renameFile(FileSystemItem file,
                    FileSystemItem targetFile,
                    ServerRequestCallback<Void> serverRequestCallback);
    
-   // touch file
    void touchFile(FileSystemItem newFile,
                   ServerRequestCallback<Void> requestCallback);
 

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -439,6 +439,8 @@ public String toString()
    // FileCommandToolbar
    public final static String MB_FILES_MORE = "mb_files_more";
    public static String getMbFilesMore() { return getElementId(MB_FILES_MORE); }
+   public final static String MB_FILES_TOUCH_FILE = "mb_files_touch_file";
+   public static String getMbFilesTouchFile() { return getElementId(MB_FILES_TOUCH_FILE); }
 
    // PlotsToolbar
    public final static String MB_PLOTS_EXPORT = "mb_plots_export";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -23,7 +23,6 @@
 
 import org.rstudio.core.client.HtmlMessageListener;
 import org.rstudio.core.client.CommandWithArg;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.Size;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.URIConstants;

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -55,7 +55,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_STAN = new EditorLanguage(
          "mode/stan", true);
    public static final EditorLanguage LANG_YAML = new EditorLanguage(
-         "mode/yaml", false, true);
+         "mode/yaml", false, false);
    public static final EditorLanguage LANG_PYTHON = new EditorLanguage(
          "mode/python", true);
    public static final EditorLanguage LANG_SH = new EditorLanguage(

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -1322,7 +1322,7 @@ private void resumeClientStateUpdater()
 
    private boolean fileUploadInProgress_ = false;
 
-   private final String CSRF_TOKEN_FIELD = "csrf-token";
+   private final String CSRF_TOKEN_FIELD = "rs-csrf-token";
 
    private ClientStateUpdater clientStateUpdaterInstance_;
    private RootLayoutPanel rootPanel_;

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationCsrfToken.java
Patch:
@@ -28,7 +28,7 @@ public static String getCsrfToken()
       for (int i = 0; i < metas.getLength(); i++)
       {
           Element meta = metas.getItem(i);
-          if (StringUtil.equals(meta.getAttribute("name"), "csrf-token"))
+          if (StringUtil.equals(meta.getAttribute("name"), "rs-csrf-token"))
           {
              return meta.getAttribute("content");
           }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -463,6 +463,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
          results.add(commands.sourceAsJob());
          results.add(commands.runSelectionAsJob());
          results.add(commands.runSelectionAsLauncherJob());
+         results.add(commands.runDocumentFromServerDotR());
       }
 
       results.add(commands.sendToTerminal());

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -70,6 +70,7 @@
    public abstract AppCommand previewSql();
    public abstract AppCommand sourceActiveDocument();
    public abstract AppCommand sourceActiveDocumentWithEcho();
+   public abstract AppCommand runDocumentFromServerDotR();
    public abstract AppCommand executeCode();
    public abstract AppCommand executeCodeWithoutMovingCursor();
    public abstract AppCommand executeCodeWithoutFocus();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -580,7 +580,9 @@ private boolean isQuartoSubProject(QuartoConfig config)
    
    private void quartoServe(String type)
    {
-      server_.quartoServe(type, new SimpleRequestCallback<Void>("Quarto Serve Error"));
+      source_.withSaveFilesBeforeCommand(() -> {
+         server_.quartoServe(type, new SimpleRequestCallback<Void>("Quarto Serve Error"));
+      }, () -> {}, "Quarto");
    }
 
    private String devtoolsLoadAllPath_ = null;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -746,7 +746,7 @@ public void manageCommands(boolean forceSync)
       // the active column is always managed last because any column can disable a command, but
       // only the active one can enable a command
       if (activeColumn_.isInitialized())
-         activeColumn_.manageCommands(forceSync, activeColumn_);
+         activeColumn_.manageCommands(forceSync, activeColumn_); 
 
       if (!session_.getSessionInfo().getAllowShell())
          commands_.sendToTerminal().setVisible(false);
@@ -2175,6 +2175,7 @@ private void initDynamicCommands()
       dynamicCommands_.add(commands_.previewSql());
       dynamicCommands_.add(commands_.sourceActiveDocument());
       dynamicCommands_.add(commands_.sourceActiveDocumentWithEcho());
+      dynamicCommands_.add(commands_.runDocumentFromServerDotR());
       dynamicCommands_.add(commands_.knitDocument());
       dynamicCommands_.add(commands_.quartoRenderDocument());
       dynamicCommands_.add(commands_.toggleRmdVisualMode());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -62,6 +62,7 @@ public interface EditingTarget extends IsWidget,
 
    void adaptToExtendedFileType(String extendedType);
    String getExtendedFileType();
+   boolean isShinyPrerenderedDoc();
    
    HashSet<AppCommand> getSupportedCommands();
    void manageCommands();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeChunk.java
Patch:
@@ -496,6 +496,7 @@ private void setMode(AceEditor editor, String mode)
          break;
       case "js":
       case "javascript":
+      case "ojs":
          editor.setFileType(FileTypeRegistry.JS);
          break;
       case "tex":

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModePanmirrorFormat.java
Patch:
@@ -33,7 +33,6 @@
 import org.rstudio.studio.client.panmirror.uitools.PanmirrorPandocFormatConfig;
 import org.rstudio.studio.client.panmirror.uitools.PanmirrorUIToolsFormat;
 import org.rstudio.studio.client.quarto.QuartoHelper;
-import org.rstudio.studio.client.quarto.model.QuartoConfig;
 import org.rstudio.studio.client.rmarkdown.model.YamlFrontMatter;
 import org.rstudio.studio.client.workbench.WorkbenchContext;
 import org.rstudio.studio.client.workbench.model.BlogdownConfig;

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -65,7 +65,8 @@ public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo)
       initWidget(uiBinder.createAndBindUi(this));
       versionMajorLabel.setText(info.version_major + "." + info.version_minor);
       versionBuildLabel.setText("Build " + info.version_patch +
-         (StringUtil.isNullOrEmpty(info.version_suffix) ? "" : "-" + info.version_suffix));
+         ((StringUtil.isNullOrEmpty(info.version_suffix) || StringUtil.equals(info.version_suffix, "0")) ?
+            "" : "-" + info.version_suffix));
 
       // a11y
       productInfo.getElement().setId("productinfo");

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -65,7 +65,8 @@ public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo)
       initWidget(uiBinder.createAndBindUi(this));
       versionMajorLabel.setText(info.version_major + "." + info.version_minor);
       versionBuildLabel.setText("Build " + info.version_patch +
-         (StringUtil.isNullOrEmpty(info.version_suffix) ? "" : "-" + info.version_suffix));
+         ((StringUtil.isNullOrEmpty(info.version_suffix) || StringUtil.equals(info.version_suffix, "0")) ?
+            "" : "-" + info.version_suffix));
 
       // a11y
       productInfo.getElement().setId("productinfo");

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -463,6 +463,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
          results.add(commands.sourceAsJob());
          results.add(commands.runSelectionAsJob());
          results.add(commands.runSelectionAsLauncherJob());
+         results.add(commands.runDocumentFromServerDotR());
       }
 
       results.add(commands.sendToTerminal());

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -70,6 +70,7 @@
    public abstract AppCommand previewSql();
    public abstract AppCommand sourceActiveDocument();
    public abstract AppCommand sourceActiveDocumentWithEcho();
+   public abstract AppCommand runDocumentFromServerDotR();
    public abstract AppCommand executeCode();
    public abstract AppCommand executeCodeWithoutMovingCursor();
    public abstract AppCommand executeCodeWithoutFocus();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -746,7 +746,7 @@ public void manageCommands(boolean forceSync)
       // the active column is always managed last because any column can disable a command, but
       // only the active one can enable a command
       if (activeColumn_.isInitialized())
-         activeColumn_.manageCommands(forceSync, activeColumn_);
+         activeColumn_.manageCommands(forceSync, activeColumn_); 
 
       if (!session_.getSessionInfo().getAllowShell())
          commands_.sendToTerminal().setVisible(false);
@@ -2175,6 +2175,7 @@ private void initDynamicCommands()
       dynamicCommands_.add(commands_.previewSql());
       dynamicCommands_.add(commands_.sourceActiveDocument());
       dynamicCommands_.add(commands_.sourceActiveDocumentWithEcho());
+      dynamicCommands_.add(commands_.runDocumentFromServerDotR());
       dynamicCommands_.add(commands_.knitDocument());
       dynamicCommands_.add(commands_.quartoRenderDocument());
       dynamicCommands_.add(commands_.toggleRmdVisualMode());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -62,6 +62,7 @@ public interface EditingTarget extends IsWidget,
 
    void adaptToExtendedFileType(String extendedType);
    String getExtendedFileType();
+   boolean isShinyPrerenderedDoc();
    
    HashSet<AppCommand> getSupportedCommands();
    void manageCommands();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModePanmirrorFormat.java
Patch:
@@ -33,7 +33,6 @@
 import org.rstudio.studio.client.panmirror.uitools.PanmirrorPandocFormatConfig;
 import org.rstudio.studio.client.panmirror.uitools.PanmirrorUIToolsFormat;
 import org.rstudio.studio.client.quarto.QuartoHelper;
-import org.rstudio.studio.client.quarto.model.QuartoConfig;
 import org.rstudio.studio.client.rmarkdown.model.YamlFrontMatter;
 import org.rstudio.studio.client.workbench.WorkbenchContext;
 import org.rstudio.studio.client.workbench.model.BlogdownConfig;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeMarkdownWriter.java
Patch:
@@ -134,7 +134,8 @@ public Options optionsFromConfig(PanmirrorPandocFormatConfig formatConfig)
       // bookdown documents(otherwise there will be duplicate footnotes)
       if (options.references.prefix == null && 
           (format_.isBookdownProjectDocument() || 
-           PanmirrorPandocFormatConfig.isDoctype(formatConfig, PanmirrorExtendedDocType.bookdown)
+           PanmirrorPandocFormatConfig.isDoctype(formatConfig, PanmirrorExtendedDocType.bookdown) ||
+           format_.isQuartoBookDocument()
           )
          )
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermTheme.java
Patch:
@@ -25,8 +25,7 @@
 import org.rstudio.core.client.widget.FontSizer;
 
 /**
- * Contains colors to theme the terminal with (ITheme).
- * https://github.com/xtermjs/xterm.js/blob/4.7.0/typings/xterm.d.ts
+ * xterm.js ITheme
  */
 @JsType(isNative = true, namespace = JsPackage.GLOBAL, name = "Object")
 public class XTermTheme

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermTheme.java
Patch:
@@ -25,8 +25,7 @@
 import org.rstudio.core.client.widget.FontSizer;
 
 /**
- * Contains colors to theme the terminal with (ITheme).
- * https://github.com/xtermjs/xterm.js/blob/4.7.0/typings/xterm.d.ts
+ * xterm.js ITheme
  */
 @JsType(isNative = true, namespace = JsPackage.GLOBAL, name = "Object")
 public class XTermTheme

File: src/gwt/src/org/rstudio/studio/client/application/model/ProductInfo.java
Patch:
@@ -26,6 +26,7 @@ protected ProductInfo() {}
    public String commit;
    public String build;
    public String release_name;
+   public String build_type;
    public String date;
    public String copyright_year;
    public String os;

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoServerOperations.java
Patch:
@@ -24,7 +24,7 @@ public interface QuartoServerOperations
 {
    void quartoCapabilities(ServerRequestCallback<QuartoCapabilities> requestCallback);
    void quartoServe(String render, ServerRequestCallback<Void> requestCallback);
-   void quartoPreview(String file, String format, ServerRequestCallback<Void> reqestCallback);
+   void quartoPreview(String file, String format, ServerRequestCallback<Boolean> requestCallback);
    void quartoCreateProject(String projectFile, 
                             QuartoNewProjectOptions options, 
                             ServerRequestCallback<ConsoleProcess> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -6403,7 +6403,7 @@ public void quartoCapabilities(ServerRequestCallback<QuartoCapabilities> request
    }
    
    @Override
-   public void quartoPreview(String file, String format, ServerRequestCallback<Void> requestCallback)
+   public void quartoPreview(String file, String format, ServerRequestCallback<Boolean> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(file));

File: src/gwt/src/org/rstudio/studio/client/application/model/ProductInfo.java
Patch:
@@ -26,6 +26,7 @@ protected ProductInfo() {}
    public String commit;
    public String build;
    public String release_name;
+   public String build_type;
    public String date;
    public String copyright_year;
    public String os;

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -62,7 +62,7 @@ private AboutDialogContents()
    public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo)
    {
       initWidget(uiBinder.createAndBindUi(this));
-      versionLabel.setText(info.version);
+      versionLabel.setText(info.build_type + " Version " + info.version);
 
       // a11y
       productInfo.getElement().setId("productinfo");

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorDialogsResources.java
Patch:
@@ -50,6 +50,8 @@ public interface Styles extends CssResource
       String flexTablePreviewValue();
       String disabled();
       String listBox();
+      String numericSizeInput();
+      String unitsSelectInput();
    }
 
    @Source("PanmirrorDialogsStyles.css")

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorEditImageDialog.java
Patch:
@@ -370,6 +370,7 @@ private static NumericTextBox addSizeInput(Panel panel, String id, String labelT
       input.setMin(1);
       input.setMax(10000);
       input.addStyleName(RES.styles().horizontalInput());
+      input.addStyleName(RES.styles().numericSizeInput());
       input.getElement().setId(id);
       label.setFor(input);
       panel.add(label);
@@ -383,6 +384,7 @@ private ListBox addUnitsSelect(Panel panel)
       String[] options = uiTools_.validUnits();
       ListBox units = new ListBox();
       units.addStyleName(RES.styles().horizontalInput());
+      units.addStyleName(RES.styles().unitsSelectInput());
       for (int i = 0; i < options.length; i++)
          units.addItem(options[i], options[i]);
       units.getElement().setId(ElementIds.VISUAL_MD_IMAGE_UNITS);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -627,7 +627,7 @@ public void getCanonicalChanges(String code, CommandWithArg<PanmirrorChanges> co
                // ensure that no source capsules have snuck in
                if (hasSourceCapsule(markdown))
                {
-                  view_.showWarningBar("Unable to reformat to canonical markdown (parsing error, please report this to RStudio)");
+                  view_.showWarningBar("Unable to parse markdown (please report at https://github.com/rstudio/rstudio/issues/new)");
                   completed.execute(null);  
                }
                /*

File: src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerItemCodec.java
Patch:
@@ -90,7 +90,7 @@ public TableRowElement getRowForItem(SourceMarker entry)
 
       TableCellElement tdMsg = Document.get().createTDElement();
       tdMsg.setClassName(resources_.styles().messageCell());
-      tdMsg.setInnerHTML(entry.getMessage());
+      tdMsg.setInnerHTML(entry.getMessage().trim());
       tr.appendChild(tdMsg);
       
       TableCellElement tdDiscButton = maybeCreateDisclosureButton(entry);

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -200,7 +200,6 @@ class ClientEvent extends JavaScriptObject
    public static final String CommandCallbacksChanged = "command_callbacks_changed";
    public static final String ConsoleActivate = "console_activate";
    public static final String JobsActivate = "jobs_activate";
-   public static final String OpenSourceFile = "open_source_file";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -2220,7 +2220,7 @@ public void onFileEdit(FileEditEvent event)
       {
          FileSystemItem file = event.getFile();
          file.setFocusOnNavigate(true);
-         fileTypeRegistry_.editFile(file);
+         fileTypeRegistry_.editFile(file, event.getFilePosition());
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/markers/MarkersOutputPane.java
Patch:
@@ -62,7 +62,8 @@ public void update(MarkersState markerState, int autoSelect)
          markerList_.showMarkers(null,
                                  markersSet.getBasePath(),
                                  markersSet.getMarkers(), 
-                                 autoSelect);
+                                 autoSelect,
+                                 false);
               
          markerSetsToolbarButton_.updateAvailableMarkerSets(
                JsUtil.toStringArray(markerState.getMarkersSetNames()));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -123,7 +123,7 @@ public void loadDisplay(String name,
 
       events_.addHandler(FileTypeChangedEvent.TYPE, event -> manageCommands(false));
       events_.addHandler(SourceOnSaveChangedEvent.TYPE, event -> manageSaveCommands(isActive()));
-      events_.addHandler(SynctexStatusChangedEvent.TYPE, event -> manageSaveCommands(isActive()));
+      events_.addHandler(SynctexStatusChangedEvent.TYPE, event -> manageSynctexCommands(isActive()));
 
       initialized_ = true;
    }

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/model/PdfJsWindow.java
Patch:
@@ -247,7 +247,7 @@ public final native void applyLocationHash(String hash) /*-{
       var self = this;
       var callback = function(event) {
          self.PDFView.pdfLinkService.setHash(hash);
-         self.removeEventListener(callback);
+         self.removeEventListener("documentload", callback);
       };
       
       self.addEventListener("documentload", callback);

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -200,6 +200,7 @@ class ClientEvent extends JavaScriptObject
    public static final String CommandCallbacksChanged = "command_callbacks_changed";
    public static final String ConsoleActivate = "console_activate";
    public static final String JobsActivate = "jobs_activate";
+   public static final String OpenSourceFile = "open_source_file";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -217,7 +217,7 @@ public void previewPlumber(PlumberAPIParams params)
    @Override
    public void previewQuarto(String url, QuartoNavigate quartoNav)
    {
-      navigate(url, true);
+      navigate(url, quartoNav.isWebsite());
       publishButton_.setManuallyHidden(false);
       if (quartoNav.isWebsite())
          publishButton_.setQuartoSitePreview();

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -996,7 +996,7 @@ public void execute(FileSystemItem input,
                         display_.showMessage(GlobalDisplay.MSG_INFO, 
                               "Cannot Add File", 
                               "Only files in the same folder as the " +
-                              "document (" + sourceDir + ") or one of its " +
+                              "document (" + sourceDir.getPath() + ") or one of its " +
                               "sub-folders may be added.");
                         return;
                      }

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -355,6 +355,8 @@ public final native boolean focusOnNavigate() /*-{
       MIME_TYPES.put( "jpe",   "image/jpeg" );
       MIME_TYPES.put( "png",   "image/png" );
       MIME_TYPES.put( "js",    "text/javascript" );
+      MIME_TYPES.put( "ojs",   "text/javascript" );
+      MIME_TYPES.put( "ts",    "text/x-typescript" );
       MIME_TYPES.put( "pdf",   "application/pdf" );
       MIME_TYPES.put( "svg",   "image/svg+xml" );
       MIME_TYPES.put( "swf",   "application/x-shockwave-flash" );

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -385,6 +385,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.scss", SCSS, new ImageResource2x(icons.iconScss2x()));
       register("*.js", JS, new ImageResource2x(icons.iconJavascript2x()));
       register("*.ts", JS, new ImageResource2x(icons.iconJavascript2x()));
+      register("*.ojs", JS, new ImageResource2x(icons.iconJavascript2x()));
       register("*.json", JSON, new ImageResource2x(icons.iconJavascript2x()));
       register("*.rmd", RMARKDOWN, new ImageResource2x(icons.iconRmarkdown2x()));
       register("*.qmd", QUARTO, new ImageResource2x(icons.iconQuarto2x()));

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -6813,7 +6813,7 @@ public void recordCommandExecution(String commandId,
    private static final String REGISTER_USER_TOKEN = "register_user_token";
    private static final String GET_RSCONNECT_LINT_RESULTS = "get_rsconnect_lint_results";
    private static final String GET_RMD_PUBLISH_DETAILS = "get_rmd_publish_details";
-   private static final String GET_QMD_PUBLISH_DETAILS = "get_rmd_publish_details";
+   private static final String GET_QMD_PUBLISH_DETAILS = "get_qmd_publish_details";
    private static final String HAS_ORPHANED_ACCOUNTS = "has_orphaned_accounts";
 
    private static final String RENDER_RMD = "render_rmd";

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/python/PythonInterpreterListEntryUi.java
Patch:
@@ -66,7 +66,7 @@ private final Label createUiVersion()
    
    private final Label createUiPath()
    {
-      return new Label("[" + interpreter_.getPath() + "]");
+      return new Label(interpreter_.getPath());
    }
    
    public final Image getIcon()

File: src/gwt/src/org/rstudio/studio/client/quarto/model/QuartoConfig.java
Patch:
@@ -21,6 +21,7 @@ public class QuartoConfig
 {
    public boolean installed;
    public boolean is_project;
+   public String project_dir;
    public String project_type;
    public String project_output_dir;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildTab.java
Patch:
@@ -70,7 +70,8 @@ public BuildTab(final Shim shim,
                    EventBus eventBus,
                    UserPrefs uiPrefs)
    {
-      super("Build", shim);
+      super("Build",  shim);
+      
       session_ = session;
       binder.bind(commands, shim);
 

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryPage.java
Patch:
@@ -146,6 +146,7 @@ protected void onAddWidgets()
       
       // Initialize project with renv
       chkRenvInit_ = new CheckBox("Use renv with this project");
+      chkRenvInit_.setValue(userState.newProjUseRenv().getValue());
       ElementIds.assignElementId(chkRenvInit_,
          ElementIds.idWithPrefix(getTitle(), ElementIds.NEW_PROJECT_RENV));
       chkRenvInit_.addValueChangeHandler((ValueChangeEvent<Boolean> event) -> {

File: src/gwt/src/org/rstudio/core/client/widget/TextBoxWithButton.java
Patch:
@@ -266,7 +266,7 @@ protected void onAttach()
       // prevent duplicates.
       ElementIds.assignElementId(textBox_, ElementIds.TBB_TEXT + uniqueId_);
       ElementIds.assignElementId(themedButton_, ElementIds.TBB_BUTTON + uniqueId_);
-      ElementIds.assignElementId(themedButton_, ElementIds.TBB_CLEAR_BUTTON + uniqueId_);
+      ElementIds.assignElementId(clearButton_, ElementIds.TBB_CLEAR_BUTTON + uniqueId_);
       if (helpButton_ != null)
          ElementIds.assignElementId(helpButton_, ElementIds.TBB_HELP + uniqueId_);
       if (lblCaption_ != null)

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -408,6 +408,7 @@ public final native boolean focusOnNavigate() /*-{
       MIME_TYPES.put( "rnw",   "text/x-r-sweave");
       MIME_TYPES.put( "rtex",  "text/x-r-sweave");
       MIME_TYPES.put( "rmd",   "text/x-r-markdown");
+      MIME_TYPES.put( "qmd",   "text/x-quarto-markdown");
       MIME_TYPES.put( "rhtml", "text/x-r-html");
       MIME_TYPES.put( "rpres", "text/x-r-presentation");
       MIME_TYPES.put( "rout",  "text/plain");

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -169,6 +169,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetCompilePdfHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetCppHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetPresentationHelper;
+import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetQuartoHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetRMarkdownHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceBackgroundHighlighter;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceEditorBackgroundLinkHighlighter;
@@ -237,6 +238,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(TextEditingTargetSqlHelper sqlHelper);
    void injectMembers(TextEditingTargetChunks chunks);
    void injectMembers(TextEditingTargetPackageDependencyHelper packageDependencyHelper);
+   void injectMembers(TextEditingTargetQuartoHelper quartoHelper);
    void injectMembers(EditingTargetCodeExecution codeExecution);
    void injectMembers(LocalRepositoriesWidget localRepositoriesWidget);
    void injectMembers(CppCompletionRequest request);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -93,6 +93,9 @@ public interface FileIconResources extends ClientBundle
 
    @Source("iconRmarkdown_2x.png")
    ImageResource iconRmarkdown2x();
+   
+   @Source("iconQuarto_2x.png")
+   ImageResource iconQuarto2x();
 
    @Source("iconC_2x.png")
    ImageResource iconC2x();

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -106,6 +106,8 @@ public class FileTypeRegistry
    public static final RWebContentFileType RNOTEBOOK =
          new RWebContentFileType("r_notebook", "R Notebook", EditorLanguage.LANG_RMARKDOWN,
                                  ".nb.html", new ImageResource2x(ICONS.iconRnotebook2x()), true);
+   
+   public static final QuartoFileType QUARTO = new QuartoFileType();
 
    public static final RWebContentFileType RPRESENTATION = new RPresentationFileType();
 
@@ -385,6 +387,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.ts", JS, new ImageResource2x(icons.iconJavascript2x()));
       register("*.json", JSON, new ImageResource2x(icons.iconJavascript2x()));
       register("*.rmd", RMARKDOWN, new ImageResource2x(icons.iconRmarkdown2x()));
+      register("*.qmd", QUARTO, new ImageResource2x(icons.iconQuarto2x()));
       register("*.rmarkdown", RMARKDOWN, new ImageResource2x(icons.iconRmarkdown2x()));
       register("*.nb.html", RNOTEBOOK, new ImageResource2x(icons.iconRnotebook2x()));
       register("*.rpres", RPRESENTATION, new ImageResource2x(icons.iconRpresentation2x()));

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPreferencesDialog.java
Patch:
@@ -81,12 +81,12 @@ public ProjectPreferencesDialog(ProjectsServerOperations server,
                   general,
                   editing,
                   rMarkdown, 
+                  python,
                   compilePdf,
                   spelling,
                   build,
                   source,
                   renv,
-                  python,
                   sharing));
 
       pSession_ = session;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/RmdOutput.java
Patch:
@@ -477,7 +477,8 @@ private void onViewerTypeChanged(String newViewerType)
 
          // open a new one with the same parameters
          outputFrame_ = createOutputFrame(newViewerType);
-         outputFrame_.showRmdPreview(params, true);
+         if (outputFrame_ != null)
+            outputFrame_.showRmdPreview(params, true);
       }
       else if (outputFrame_ != null &&
                outputFrame_.getWindowObject() == null &&

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdFrontMatter.java
Patch:
@@ -163,5 +163,6 @@ public final void applyCreateOptions(String author, String title,
    public final static String DEFAULT_FORMAT = "default";
    public final static String SHINY_RUNTIME = "shiny";
    public final static String SHINY_PRERENDERED_RUNTIME = "shiny_prerendered";
+   public final static String SHINY_RMD_RUNTIME = "shinyrmd";
    public final static String FRONTMATTER_SEPARATOR = "---\n";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -120,6 +120,7 @@
    public abstract AppCommand browseCheatSheets();
    public abstract AppCommand toggleRmdVisualMode();
    public abstract AppCommand enableProsemirrorDevTools();
+   public abstract AppCommand quartoRenderDocument();
    public abstract AppCommand knitDocument();
    public abstract AppCommand previewHTML();
    public abstract AppCommand publishHTML();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialog.java
Patch:
@@ -80,13 +80,13 @@ public PreferencesDialog(WorkbenchServerOperations server,
                   paneLayout,
                   packages,
                   rmarkdown,
+                  python,
                   compilePdf,
                   spelling,
                   sourceControl,
                   publishing,
                   terminal,
-                  accessibility,
-                  python));
+                  accessibility));
       
       session_ = session;
       server_ = server;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/renderrmd/RenderRmdOutputTab.java
Patch:
@@ -58,7 +58,7 @@ public RenderRmdOutputTab(Shim shim,
                              Commands commands,
                              final Session session)
    {
-      super("R Markdown", shim);
+      super("Render", shim);
       shim_ = shim;
 
       GWT.<Binder>create(Binder.class).bind(commands, shim_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -861,6 +861,7 @@ private void manageRSConnectCommands(boolean active)
                  (getNextActiveEditor().getExtendedFileType() != null &&
                     (getNextActiveEditor().getExtendedFileType().startsWith(SourceDocument.XT_SHINY_PREFIX) ||
                      getNextActiveEditor().getExtendedFileType().startsWith(SourceDocument.XT_RMARKDOWN_PREFIX) ||
+                     getNextActiveEditor().getExtendedFileType().equals(SourceDocument.XT_QUARTO_DOCUMENT) ||
                      getNextActiveEditor().getExtendedFileType() == SourceDocument.XT_PLUMBER_API));
       boolean cmdEnabled = rsCommandsAvailable && active;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -2166,6 +2166,7 @@ private void initDynamicCommands()
       dynamicCommands_.add(commands_.sourceActiveDocument());
       dynamicCommands_.add(commands_.sourceActiveDocumentWithEcho());
       dynamicCommands_.add(commands_.knitDocument());
+      dynamicCommands_.add(commands_.quartoRenderDocument());
       dynamicCommands_.add(commands_.toggleRmdVisualMode());
       dynamicCommands_.add(commands_.enableProsemirrorDevTools());
       dynamicCommands_.add(commands_.previewHTML());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
 import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.HashSet;
 import java.util.List;
 import java.util.Map;
@@ -314,7 +315,8 @@ private boolean isExecutableKnitrEngine(String engine)
       if (target_.getDocDisplay().showChunkOutputInline())
       {
          // treat all chunks as executable in notebook mode
-         return true;
+         List<String> dontRunEngines = Arrays.asList("js", "css", "observable");
+         return !dontRunEngines.contains(engine);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -551,7 +551,9 @@ public RmdSelectedTemplate getTemplateFormat(String yaml)
 
    public boolean isRuntimeShinyPrerendered(String yaml)
    {
-      return getRuntime(yaml) == RmdFrontMatter.SHINY_PRERENDERED_RUNTIME;
+      String runtime = getRuntime(yaml);
+      return runtime == RmdFrontMatter.SHINY_PRERENDERED_RUNTIME ||
+             runtime == RmdFrontMatter.SHINY_RMD_RUNTIME;
    }
 
    public boolean isRuntimeShiny(String yaml)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextPanmirrorUi.java
Patch:
@@ -41,6 +41,8 @@ public ChunkContextPanmirrorUi(TextEditingTarget outerEditor, Scope outerChunk,
       style.setTop(15, Unit.PX);
       style.setRight(0, Unit.PX);
       style.setWidth(100, Unit.PX);
+      
+      syncOptions();
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceDocument.java
Patch:
@@ -205,6 +205,7 @@ public static boolean hasCustomSource(String extendedType)
    public final static String XT_RMARKDOWN_PREFIX = "rmarkdown-";
    public final static String XT_RMARKDOWN_DOCUMENT = "rmarkdown-document";
    public final static String XT_RMARKDOWN_NOTEBOOK = "rmarkdown-notebook";
+   public final static String XT_QUARTO_DOCUMENT = "quarto-document";
    public final static String XT_SHINY_PREFIX = "shiny-";
    public final static String XT_SHINY_DIR = "shiny-dir";
    public final static String XT_SHINY_SINGLE_FILE = "shiny-single-file";

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/RmdOutput.java
Patch:
@@ -477,7 +477,8 @@ private void onViewerTypeChanged(String newViewerType)
 
          // open a new one with the same parameters
          outputFrame_ = createOutputFrame(newViewerType);
-         outputFrame_.showRmdPreview(params, true);
+         if (outputFrame_ != null)
+            outputFrame_.showRmdPreview(params, true);
       }
       else if (outputFrame_ != null &&
                outputFrame_.getWindowObject() == null &&

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3433,13 +3433,16 @@ public void adaptToExtendedFileType(String extendedType)
          return;
       }
 
+      
       view_.adaptToExtendedFileType(extendedType);
       if (extendedType.startsWith(SourceDocument.XT_RMARKDOWN_PREFIX) ||
           extendedType.equals(SourceDocument.XT_QUARTO_DOCUMENT))
       {
          updateRmdFormat();
       }
       extendedType_ = extendedType;
+      
+      quartoHelper_.manageCommands();
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -359,7 +359,7 @@ private Toolbar createToolbar(TextFileType fileType)
 
       toolbar.addLeftSeparator();
       toolbar.addLeftWidget(previewHTMLButton_ =
-         mgr.getSourceCommand(commands_.previewHTML(), column_).createToolbarButton());
+         mgr.getSourceCommand(commands_.previewHTML(), column_).createUnsyncedToolbarButton());
       toolbar.addLeftWidget(quartoRenderButton_ =
          mgr.getSourceCommand(commands_.quartoRenderDocument(), column_).createUnsyncedToolbarButton());
       knitDocumentButton_ =
@@ -892,9 +892,9 @@ public void adaptToFileType(TextFileType fileType)
 
       findReplaceButton_.setVisible(!visualRmdMode);
 
-
       knitDocumentButton_.setVisible(canKnitToHTML && !isQuarto);
-      quartoRenderButton_.setVisible(canKnitToHTML && isQuarto);
+      previewHTMLButton_.setVisible(fileType.canPreviewHTML() && !isQuarto);
+      quartoRenderButton_.setVisible(isQuarto);
 
       setRmdFormatButtonVisible(isRMarkdown2 && !isQuarto);
       rmdOptionsButton_.setVisible(isRMarkdown2);

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -169,6 +169,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetCompilePdfHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetCppHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetPresentationHelper;
+import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetQuartoHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetRMarkdownHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceBackgroundHighlighter;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceEditorBackgroundLinkHighlighter;
@@ -237,6 +238,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(TextEditingTargetSqlHelper sqlHelper);
    void injectMembers(TextEditingTargetChunks chunks);
    void injectMembers(TextEditingTargetPackageDependencyHelper packageDependencyHelper);
+   void injectMembers(TextEditingTargetQuartoHelper quartoHelper);
    void injectMembers(EditingTargetCodeExecution codeExecution);
    void injectMembers(LocalRepositoriesWidget localRepositoriesWidget);
    void injectMembers(CppCompletionRequest request);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -93,6 +93,9 @@ public interface FileIconResources extends ClientBundle
 
    @Source("iconRmarkdown_2x.png")
    ImageResource iconRmarkdown2x();
+   
+   @Source("iconQuarto_2x.png")
+   ImageResource iconQuarto2x();
 
    @Source("iconC_2x.png")
    ImageResource iconC2x();

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -106,6 +106,8 @@ public class FileTypeRegistry
    public static final RWebContentFileType RNOTEBOOK =
          new RWebContentFileType("r_notebook", "R Notebook", EditorLanguage.LANG_RMARKDOWN,
                                  ".nb.html", new ImageResource2x(ICONS.iconRnotebook2x()), true);
+   
+   public static final QuartoFileType QUARTO = new QuartoFileType();
 
    public static final RWebContentFileType RPRESENTATION = new RPresentationFileType();
 
@@ -385,6 +387,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.ts", JS, new ImageResource2x(icons.iconJavascript2x()));
       register("*.json", JSON, new ImageResource2x(icons.iconJavascript2x()));
       register("*.rmd", RMARKDOWN, new ImageResource2x(icons.iconRmarkdown2x()));
+      register("*.qmd", QUARTO, new ImageResource2x(icons.iconQuarto2x()));
       register("*.rmarkdown", RMARKDOWN, new ImageResource2x(icons.iconRmarkdown2x()));
       register("*.nb.html", RNOTEBOOK, new ImageResource2x(icons.iconRnotebook2x()));
       register("*.rpres", RPRESENTATION, new ImageResource2x(icons.iconRpresentation2x()));

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdFrontMatter.java
Patch:
@@ -163,5 +163,6 @@ public final void applyCreateOptions(String author, String title,
    public final static String DEFAULT_FORMAT = "default";
    public final static String SHINY_RUNTIME = "shiny";
    public final static String SHINY_PRERENDERED_RUNTIME = "shiny_prerendered";
+   public final static String SHINY_RMD_RUNTIME = "shinyrmd";
    public final static String FRONTMATTER_SEPARATOR = "---\n";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -120,6 +120,7 @@
    public abstract AppCommand browseCheatSheets();
    public abstract AppCommand toggleRmdVisualMode();
    public abstract AppCommand enableProsemirrorDevTools();
+   public abstract AppCommand quartoRenderDocument();
    public abstract AppCommand knitDocument();
    public abstract AppCommand previewHTML();
    public abstract AppCommand publishHTML();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/renderrmd/RenderRmdOutputTab.java
Patch:
@@ -58,7 +58,7 @@ public RenderRmdOutputTab(Shim shim,
                              Commands commands,
                              final Session session)
    {
-      super("R Markdown", shim);
+      super("Render", shim);
       shim_ = shim;
 
       GWT.<Binder>create(Binder.class).bind(commands, shim_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -861,6 +861,7 @@ private void manageRSConnectCommands(boolean active)
                  (getNextActiveEditor().getExtendedFileType() != null &&
                     (getNextActiveEditor().getExtendedFileType().startsWith(SourceDocument.XT_SHINY_PREFIX) ||
                      getNextActiveEditor().getExtendedFileType().startsWith(SourceDocument.XT_RMARKDOWN_PREFIX) ||
+                     getNextActiveEditor().getExtendedFileType().equals(SourceDocument.XT_QUARTO_DOCUMENT) ||
                      getNextActiveEditor().getExtendedFileType() == SourceDocument.XT_PLUMBER_API));
       boolean cmdEnabled = rsCommandsAvailable && active;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -2166,6 +2166,7 @@ private void initDynamicCommands()
       dynamicCommands_.add(commands_.sourceActiveDocument());
       dynamicCommands_.add(commands_.sourceActiveDocumentWithEcho());
       dynamicCommands_.add(commands_.knitDocument());
+      dynamicCommands_.add(commands_.quartoRenderDocument());
       dynamicCommands_.add(commands_.toggleRmdVisualMode());
       dynamicCommands_.add(commands_.enableProsemirrorDevTools());
       dynamicCommands_.add(commands_.previewHTML());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
 import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.HashSet;
 import java.util.List;
 import java.util.Map;
@@ -314,7 +315,8 @@ private boolean isExecutableKnitrEngine(String engine)
       if (target_.getDocDisplay().showChunkOutputInline())
       {
          // treat all chunks as executable in notebook mode
-         return true;
+         List<String> dontRunEngines = Arrays.asList("js", "css", "observable");
+         return !dontRunEngines.contains(engine);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -551,7 +551,9 @@ public RmdSelectedTemplate getTemplateFormat(String yaml)
 
    public boolean isRuntimeShinyPrerendered(String yaml)
    {
-      return getRuntime(yaml) == RmdFrontMatter.SHINY_PRERENDERED_RUNTIME;
+      String runtime = getRuntime(yaml);
+      return runtime == RmdFrontMatter.SHINY_PRERENDERED_RUNTIME ||
+             runtime == RmdFrontMatter.SHINY_RMD_RUNTIME;
    }
 
    public boolean isRuntimeShiny(String yaml)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextPanmirrorUi.java
Patch:
@@ -41,6 +41,8 @@ public ChunkContextPanmirrorUi(TextEditingTarget outerEditor, Scope outerChunk,
       style.setTop(15, Unit.PX);
       style.setRight(0, Unit.PX);
       style.setWidth(100, Unit.PX);
+      
+      syncOptions();
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceDocument.java
Patch:
@@ -205,6 +205,7 @@ public static boolean hasCustomSource(String extendedType)
    public final static String XT_RMARKDOWN_PREFIX = "rmarkdown-";
    public final static String XT_RMARKDOWN_DOCUMENT = "rmarkdown-document";
    public final static String XT_RMARKDOWN_NOTEBOOK = "rmarkdown-notebook";
+   public final static String XT_QUARTO_DOCUMENT = "quarto-document";
    public final static String XT_SHINY_PREFIX = "shiny-";
    public final static String XT_SHINY_DIR = "shiny-dir";
    public final static String XT_SHINY_SINGLE_FILE = "shiny-single-file";

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -348,7 +348,6 @@ public RestartRequirement onApply(UserPrefs prefs)
       String mirrorTextValue = cranMirrorTextBox_.getTextBox().getText();
 
       boolean cranRepoChanged = !mirrorTextValue.equals(cranMirrorStored_);
-      // TODO: Is this correct?  Custom doesn't require a leading http://, so this wont always match
       boolean cranRepoChangedToUrl = cranRepoChanged &&
                                       mirrorTextValue.startsWith("http");
 

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/CRANMirror.java
Patch:
@@ -135,7 +135,8 @@ public final boolean isCustom()
     */
    public final String getDisplay()
    {
-      if (isCustom()) {
+      if (isCustom()) 
+      {
          // Host is Custom with no standard Name/Host info.  Identify by URL
          return getURL();
       } else {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1155,7 +1155,7 @@ public PrefValue<Boolean> limitVisibleConsole()
          "limit_visible_console",
          "Limit visible console output", 
          "Whether to only show a limited window of the total console output", 
-         true);
+         false);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1155,7 +1155,7 @@ public PrefValue<Boolean> limitVisibleConsole()
          "limit_visible_console",
          "Limit visible console output", 
          "Whether to only show a limited window of the total console output", 
-         true);
+         false);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -449,9 +449,9 @@ public PrefValue<Boolean> autoDetectIndentation()
    {
       return bool(
          "auto_detect_indentation",
-         "Autodetect indentation in files", 
+         "Auto-detect indentation in files", 
          "Whether to automatically detect indentation settings from file contents.", 
-         true);
+         false);
    }
 
    /**

File: src/gwt/src/org/rstudio/core/client/ConsoleOutputWriter.java
Patch:
@@ -107,6 +107,7 @@ public boolean outputToConsole(String text,
          Roles.getDocumentRole().set(trailing); // https://github.com/rstudio/rstudio/issues/6884
          outEl.appendChild(trailing);
          virtualConsole_ = vcFactory_.create(trailing);
+         virtualConsole_.setVirtualizedDisableOverride(false);
       }
 
       // set the appendTarget to the VirtualConsole bucket if possible

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -617,6 +617,8 @@ public String toString()
    public final static String TAB_CLOSE = "tab_close";
    public final static String TAB_RENAME_FILE = "tab_rename_file";
    public final static String TAB_COPY_PATH = "tab_copy_path";
+   public final static String TAB_SET_WORKING_DIR = "tab_set_working_dir";
+   public final static String TAB_SET_FILES_PANE = "tab_set_files_pane";
    public final static String TAB_CLOSE_ALL = "tab_close_all";
    public final static String TAB_CLOSE_OTHERS = "tab_close_others";
 

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -773,9 +773,8 @@ public String debugDump()
 
    private static final Pattern CONTROL = Pattern.create("[\r\b\f\n]");
 
-   // some panels might want to never virtualize the scrolling based
-   // on how they use the VirtualConsole (e.g. Build Pane)
-   private boolean virtualizedDisableOverride_ = false;
+   // only a select few panes should be virtualized. default it to off everywhere.
+   private boolean virtualizedDisableOverride_ = true;
 
    private final StringBuilder output_ = new StringBuilder();
    private final TreeMap<Integer, ClassRange> class_ = new TreeMap<>();

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -62,7 +62,7 @@
 import org.rstudio.studio.client.common.rstudioapi.RStudioAPI;
 import org.rstudio.studio.client.common.satellite.Satellite;
 import org.rstudio.studio.client.common.satellite.SatelliteManager;
-import org.rstudio.studio.client.common.spelling.TypoSpellChecker;
+import org.rstudio.studio.client.common.spelling.RealtimeSpellChecker;
 import org.rstudio.studio.client.common.spelling.ui.SpellingCustomDictionariesWidget;
 import org.rstudio.studio.client.htmlpreview.HTMLPreviewApplication;
 import org.rstudio.studio.client.notebook.CompileNotebookOptionsDialog;
@@ -217,7 +217,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(CaptionWithHelp captionWithHelp);
    void injectMembers(RnwWeaveSelectWidget selectWidget);
    void injectMembers(TextEditingTargetCompilePdfHelper compilePdfHelper);
-   void injectMembers(TypoSpellChecker typoSpellChecker);
+   void injectMembers(RealtimeSpellChecker realtimeSpellChecker);
    void injectMembers(SpellingCustomDictionariesWidget widget);
    void injectMembers(FileExport fileExport);
    void injectMembers(RPubsUploadDialog uploadDialog);

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -38,8 +38,7 @@ public CompileOutputBufferWithHighlight()
       output_.addStyleName(styles_.paddedOutput());
       FontSizer.applyNormalFontSize(output_);
       console_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(output_.getElement());
-      console_.setVirtualizedDisableOverride(true); // disable virtualization of scroller
-    
+
       scrollPanel_ = new BottomScrollPanel();
       scrollPanel_.setSize("100%", "100%");
       scrollPanel_.addStyleName("ace_editor");

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleError.java
Patch:
@@ -64,7 +64,6 @@ public ConsoleError(UnhandledError err,
       initWidget(uiBinder.createAndBindUi(this));
       
       VirtualConsole vc = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(errorMessage.getElement());
-      vc.setVirtualizedDisableOverride(true);
       vc.submit(err.getErrorMessage().trim());
       errorMessage.addStyleName(errorClass);
 

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -187,7 +187,7 @@ private CommandWith2Args<Double, Double> getDataTableColumnCallback()
    {
       return (offset, max) ->
       {
-         columnTextWidget_.setValue(offset + " - " + (offset + max));
+         columnTextWidget_.setValue((offset + 1) + " - " + (offset + max));
          setColumnControlVisibility(isLimitedColumnFrame());
       };
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FileCommandToolbar.java
Patch:
@@ -55,6 +55,9 @@ public FileCommandToolbar(Commands commands, UserPrefs prefs)
       moreMenu.addSeparator();
       moreMenu.addItem(commands.setAsWorkingDir().createMenuItem(false));
       moreMenu.addItem(commands.goToWorkingDir().createMenuItem(false));
+      moreMenu.addItem(new UserPrefMenuItem<>(prefs.syncFilesPaneWorkingDir(), true,
+         "Synchronize Working Directory", prefs));
+      moreMenu.addSeparator();
       moreMenu.addItem(commands.openNewTerminalAtFilePaneLocation().createMenuItem(false));
       moreMenu.addSeparator();
       moreMenu.addItem(commands.showFolder().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkInlineOutput.java
Patch:
@@ -48,7 +48,6 @@ public ChunkInlineOutput(String chunkId, final AnchoredSelection selection)
       
       console_ = new PreWidget();
       vconsole_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(console_.getElement());
-      vconsole_.setVirtualizedDisableOverride(true);
       chunkId_ = chunkId;
       selection_ = selection;
       state_ = State.Queued;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -742,7 +742,6 @@ private void initConsole()
       if (vconsole_ == null)
       {
          vconsole_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(console_.getElement());
-         vconsole_.setVirtualizedDisableOverride(true);
       }
       else
          vconsole_.clear();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1813,6 +1813,9 @@ public void onFocus(FocusEvent event)
             // in a collaborative editing session so we can get delete
             // notifications
             checkForExternalEdit(500);
+
+            // relint on blur
+            lintManager_.relintAfterDelay(100);
          }
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesUpload.java
Patch:
@@ -68,11 +68,11 @@ public void execute()
             public void execute(PendingFileUpload pendingUpload)
             {
                FileUploadToken token = pendingUpload.getToken();
-               Boolean unzipFound = token.getUnzipFound();
-               Boolean isZip = token.getIsZip();
+               boolean unzipFound = token.getUnzipFound();
+               boolean isZip = token.getIsZip();
 
                // confirm unzip is installed
-               if (unzipFound == Boolean.FALSE && isZip == Boolean.TRUE)
+               if (!unzipFound && isZip)
                {
                   // Warn user unzip is not installed
                   globalDisplay_.showYesNoMessage(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/model/FileUploadToken.java
Patch:
@@ -30,15 +30,15 @@ public final native String getUploadTempFile() /*-{
       return this.uploadedTempFile;
    }-*/;
 
-   public final native String geTargetDirectory() /*-{
+   public final native String getTargetDirectory() /*-{
       return this.targetDirectory;
    }-*/;
 
-   public final native Boolean getUnzipFound() /*-{
+   public final native boolean getUnzipFound() /*-{
       return this.unzipFound;
    }-*/;
 
-   public final native Boolean getIsZip() /*-{
+   public final native boolean getIsZip() /*-{
       return this.isZip;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -187,7 +187,7 @@ private CommandWith2Args<Double, Double> getDataTableColumnCallback()
    {
       return (offset, max) ->
       {
-         columnTextWidget_.setValue(offset + " - " + (offset + max));
+         columnTextWidget_.setValue((offset + 1) + " - " + (offset + max));
          setColumnControlVisibility(isLimitedColumnFrame());
       };
    }

File: src/gwt/src/org/rstudio/core/client/ConsoleOutputWriter.java
Patch:
@@ -107,6 +107,7 @@ public boolean outputToConsole(String text,
          Roles.getDocumentRole().set(trailing); // https://github.com/rstudio/rstudio/issues/6884
          outEl.appendChild(trailing);
          virtualConsole_ = vcFactory_.create(trailing);
+         virtualConsole_.setVirtualizedDisableOverride(false);
       }
 
       // set the appendTarget to the VirtualConsole bucket if possible

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -773,9 +773,8 @@ public String debugDump()
 
    private static final Pattern CONTROL = Pattern.create("[\r\b\f\n]");
 
-   // some panels might want to never virtualize the scrolling based
-   // on how they use the VirtualConsole (e.g. Build Pane)
-   private boolean virtualizedDisableOverride_ = false;
+   // only a select few panes should be virtualized. default it to off everywhere.
+   private boolean virtualizedDisableOverride_ = true;
 
    private final StringBuilder output_ = new StringBuilder();
    private final TreeMap<Integer, ClassRange> class_ = new TreeMap<>();

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -38,8 +38,7 @@ public CompileOutputBufferWithHighlight()
       output_.addStyleName(styles_.paddedOutput());
       FontSizer.applyNormalFontSize(output_);
       console_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(output_.getElement());
-      console_.setVirtualizedDisableOverride(true); // disable virtualization of scroller
-    
+
       scrollPanel_ = new BottomScrollPanel();
       scrollPanel_.setSize("100%", "100%");
       scrollPanel_.addStyleName("ace_editor");

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleError.java
Patch:
@@ -64,7 +64,6 @@ public ConsoleError(UnhandledError err,
       initWidget(uiBinder.createAndBindUi(this));
       
       VirtualConsole vc = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(errorMessage.getElement());
-      vc.setVirtualizedDisableOverride(true);
       vc.submit(err.getErrorMessage().trim());
       errorMessage.addStyleName(errorClass);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkInlineOutput.java
Patch:
@@ -48,7 +48,6 @@ public ChunkInlineOutput(String chunkId, final AnchoredSelection selection)
       
       console_ = new PreWidget();
       vconsole_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(console_.getElement());
-      vconsole_.setVirtualizedDisableOverride(true);
       chunkId_ = chunkId;
       selection_ = selection;
       state_ = State.Queued;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -742,7 +742,6 @@ private void initConsole()
       if (vconsole_ == null)
       {
          vconsole_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(console_.getElement());
-         vconsole_.setVirtualizedDisableOverride(true);
       }
       else
          vconsole_.clear();

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -359,6 +359,7 @@ public final native boolean focusOnNavigate() /*-{
       MIME_TYPES.put( "svg",   "image/svg+xml" );
       MIME_TYPES.put( "swf",   "application/x-shockwave-flash" );
       MIME_TYPES.put( "ttf",   "application/x-font-ttf" );
+      MIME_TYPES.put( "wasm",  "application/wasm");
 
       // markdown types
       MIME_TYPES.put( "md",       "text/x-markdown" );

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -180,6 +180,7 @@ public static String idFromLabel(String label)
    public final static String TERMINAL_CLOSING_PREFS = "terminal_closing_prefs";
 
    public final static String NEW_PROJECT_DIRECTORY = "new_project_directory";
+   public final static String NEW_PROJECT_TYPE = "new_project_type";
    public final static String NEW_PROJECT_GIT_REPO = "new_project_git_repo";
    public final static String NEW_PROJECT_RENV = "new_project_renv";
    public final static String NEW_PROJECT_SOURCE_FILES = "new_project_source_files";

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewPackagePage.java
Patch:
@@ -95,6 +95,7 @@ protected void onAddTopPanelWidgets(HorizontalPanel panel)
                                           labels,
                                           values,
                                           false);
+      ElementIds.assignElementId(listProjectType_, ElementIds.NEW_PROJECT_TYPE);
       listProjectType_.addChangeHandler(new ChangeHandler() {
          @Override
          public void onChange(ChangeEvent event)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PaneLayoutPreferencesPane.java
Patch:
@@ -199,6 +199,7 @@ public PaneLayoutPreferencesPane(PreferencesDialogResources res,
 
       Toolbar columnToolbar = new Toolbar("Manage Column Display");
       columnToolbar.setStyleName(res_.styles().newSection());
+      columnToolbar.setHeight("20px");
 
       ToolbarButton addButton = new ToolbarButton(
          "Add Column",

File: src/gwt/src/org/rstudio/core/client/files/filedialog/OpenFileDialog.java
Patch:
@@ -71,7 +71,7 @@ public void onNavigated()
    @Override
    protected FileSystemItem getSelectedItem()
    {
-      FileSystemItem item = browser_.getSelectedItem();
+      FileSystemItem item = super.getSelectedItem();
       if (item == null)
          item = browser_.getCurrentDirectory();
       return item;

File: src/gwt/src/org/rstudio/core/client/files/filedialog/OpenFileDialog.java
Patch:
@@ -71,7 +71,7 @@ public void onNavigated()
    @Override
    protected FileSystemItem getSelectedItem()
    {
-      FileSystemItem item = browser_.getSelectedItem();
+      FileSystemItem item = super.getSelectedItem();
       if (item == null)
          item = browser_.getCurrentDirectory();
       return item;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/StanCompletionManager.java
Patch:
@@ -259,6 +259,7 @@ protected HandlerRegistration[] handlers()
    @Override
    public void detach()
    {
+      super.detach();
       sigTips_.detach();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/StanCompletionManager.java
Patch:
@@ -259,6 +259,7 @@ protected HandlerRegistration[] handlers()
    @Override
    public void detach()
    {
+      super.detach();
       sigTips_.detach();
    }
    

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -187,7 +187,7 @@ private CommandWith2Args<Double, Double> getDataTableColumnCallback()
    {
       return (offset, max) ->
       {
-         columnTextWidget_.setValue(offset + " - " + max);
+         columnTextWidget_.setValue(offset + " - " + (offset + max));
          setColumnControlVisibility(isLimitedColumnFrame());
       };
    }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/CppFileType.java
Patch:
@@ -67,11 +67,11 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       HashSet<AppCommand> result = super.getSupportedCommands(commands);
       if (isCpp())
       {
-         result.add(commands.commentUncomment());
-         result.add(commands.reflowComment());
          result.add(commands.sourceActiveDocument());
          result.add(commands.sourceActiveDocumentWithEcho());
       }
+      result.add(commands.commentUncomment());
+      result.add(commands.reflowComment());
       result.add(commands.goToDefinition());
       result.add(commands.codeCompletion());
       result.add(commands.findUsages());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -219,6 +219,9 @@ private void initSecondaryToolbar()
             (ImageResource) null,
             languageMenu_);
 
+      // nudge language selector up to baseline align with environment selector
+      languageButton_.getElement().getStyle().setMarginTop(-4, Unit.PX);
+
       toolbar.addLeftWidget(languageButton_);
       toolbar.addLeftSeparator();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -1480,7 +1480,7 @@ public void closeAllTabs(SourceColumn column,
       {
          final CPSEditingTargetCommand command = (EditingTarget target, Command continuation) ->
          {
-            if (!StringUtil.isNullOrEmpty(excludeDocId) && target == activeColumn_.getDoc(excludeDocId))
+            if (!StringUtil.isNullOrEmpty(excludeDocId) && target == column.getDoc(excludeDocId))
             {
                continuation.execute();
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -1480,7 +1480,8 @@ public void closeAllTabs(SourceColumn column,
       {
          final CPSEditingTargetCommand command = (EditingTarget target, Command continuation) ->
          {
-            if (!StringUtil.isNullOrEmpty(excludeDocId) && target == activeColumn_.getDoc(excludeDocId))
+            if (!StringUtil.isNullOrEmpty(excludeDocId) &&
+               (target == activeColumn_.getDoc(excludeDocId) || target == column.getDoc(excludeDocId)))
             {
                continuation.execute();
             }

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -45,7 +45,7 @@
 import org.rstudio.studio.client.common.filetypes.events.CopySourcePathEvent;
 import org.rstudio.studio.client.common.filetypes.events.RenameSourceFileEvent;
 import org.rstudio.studio.client.common.satellite.Satellite;
-import org.rstudio.studio.client.server.model.RequestDocumentCloseEvent;
+import org.rstudio.studio.client.server.model.DocumentCloseEvent;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.SourceWindowManager;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTarget;
@@ -233,7 +233,7 @@ public void onTabClose()
 
             menu.addItem(ElementIds.TAB_CLOSE, new MenuItem("Close", () ->
             {
-               events_.fireEvent(new RequestDocumentCloseEvent(docId));
+               events_.fireEvent(new DocumentCloseEvent(docId));
             }));
 
             menu.addItem(ElementIds.TAB_CLOSE_ALL, new MenuItem("Close All", () ->

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -2727,7 +2727,7 @@ public void onRequestDocumentClose(RequestDocumentCloseEvent event)
          columnManager_.closeTabs(ids);
 
          // Let the server know we've completed the task
-         if (SourceWindowManager.isMainSourceWindow() && event.getNotifyComplete())
+         if (SourceWindowManager.isMainSourceWindow())
          {
             server_.requestDocumentCloseCompleted(true,
                   new VoidServerRequestCallback());
@@ -2747,7 +2747,7 @@ public void onRequestDocumentClose(RequestDocumentCloseEvent event)
             else
             {
                // We didn't save (or the user cancelled), so let the server know
-               if (SourceWindowManager.isMainSourceWindow() && event.getNotifyComplete())
+               if (SourceWindowManager.isMainSourceWindow())
                {
                   server_.requestDocumentCloseCompleted(false,
                         new VoidServerRequestCallback());

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -45,7 +45,7 @@
 import org.rstudio.studio.client.common.filetypes.events.CopySourcePathEvent;
 import org.rstudio.studio.client.common.filetypes.events.RenameSourceFileEvent;
 import org.rstudio.studio.client.common.satellite.Satellite;
-import org.rstudio.studio.client.server.model.RequestDocumentCloseEvent;
+import org.rstudio.studio.client.server.model.DocumentCloseEvent;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.SourceWindowManager;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTarget;
@@ -233,7 +233,7 @@ public void onTabClose()
 
             menu.addItem(ElementIds.TAB_CLOSE, new MenuItem("Close", () ->
             {
-               events_.fireEvent(new RequestDocumentCloseEvent(docId));
+               events_.fireEvent(new DocumentCloseEvent(docId));
             }));
 
             menu.addItem(ElementIds.TAB_CLOSE_ALL, new MenuItem("Close All", () ->

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -2727,7 +2727,7 @@ public void onRequestDocumentClose(RequestDocumentCloseEvent event)
          columnManager_.closeTabs(ids);
 
          // Let the server know we've completed the task
-         if (SourceWindowManager.isMainSourceWindow() && event.getNotifyComplete())
+         if (SourceWindowManager.isMainSourceWindow())
          {
             server_.requestDocumentCloseCompleted(true,
                   new VoidServerRequestCallback());
@@ -2747,7 +2747,7 @@ public void onRequestDocumentClose(RequestDocumentCloseEvent event)
             else
             {
                // We didn't save (or the user cancelled), so let the server know
-               if (SourceWindowManager.isMainSourceWindow() && event.getNotifyComplete())
+               if (SourceWindowManager.isMainSourceWindow())
                {
                   server_.requestDocumentCloseCompleted(false,
                         new VoidServerRequestCallback());

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -566,7 +566,7 @@ public void syncPrefs(String layer, JsObject source)
    }
    public List<PrefValue<?>> allPrefs()
    {
-      ArrayList<PrefValue<?>> prefs = new ArrayList<>();
+      ArrayList<PrefValue<?>> prefs = new ArrayList<PrefValue<?>>();
       prefs.add(contextId());
       prefs.add(autoCreatedProfile());
       prefs.add(theme());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/MemUsageWidget.java
Patch:
@@ -108,7 +108,7 @@ public void setMemoryUsage(MemoryUsage usage)
          }
 
          menu_.setTitle(StringUtil.prettyFormatNumber(usage.getProcess().getKb()) +
-            " KiB used by R session (source: " + usage.getProcess().getProviderName());
+            " KiB used by R session (source: " + usage.getProcess().getProviderName() + ")");
          menu_.setText(formatBigMemory(usage.getProcess().getKb()));
 
          MiniPieWidget pie = new MiniPieWidget(

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -628,7 +628,7 @@ public SelectInputClickHandler(boolean scrollOnClick)
       public void onClick(ClickEvent event)
       {
          // If clicking on the input panel already, stop propagation.
-         if (!scrollOnClick_ || event.getSource() == input_)
+         if (event.getSource() == input_)
          {
             event.stopPropagation();
             return;
@@ -720,7 +720,7 @@ public void run()
             // https://github.com/rstudio/rstudio/issues/6231
             boolean wasScrolledToBottom = scrollPanel_.isScrolledToBottom();
             input_.setFocus(true);
-            if (wasScrolledToBottom)
+            if (scrollOnClick_ && wasScrolledToBottom)
                scrollPanel_.scrollToBottom();
          }
       };

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -628,7 +628,7 @@ public SelectInputClickHandler(boolean scrollOnClick)
       public void onClick(ClickEvent event)
       {
          // If clicking on the input panel already, stop propagation.
-         if (!scrollOnClick_ || event.getSource() == input_)
+         if (event.getSource() == input_)
          {
             event.stopPropagation();
             return;
@@ -720,7 +720,7 @@ public void run()
             // https://github.com/rstudio/rstudio/issues/6231
             boolean wasScrolledToBottom = scrollPanel_.isScrolledToBottom();
             input_.setFocus(true);
-            if (wasScrolledToBottom)
+            if (scrollOnClick_ && wasScrolledToBottom)
                scrollPanel_.scrollToBottom();
          }
       };

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPane.java
Patch:
@@ -285,7 +285,7 @@ public void showContextMenu(final int clientX, final int clientY)
       menu.addSeparator();
       menu.addItem(commands_.vcsOpen().createMenuItem(false));
 
-      menu.showRelativeTo(clientX, clientY);
+      menu.showRelativeTo(clientX, clientY, ElementIds.GIT_TAB_CONTEXT);
    }
 
    private ToolbarButton historyButton_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/SVNPane.java
Patch:
@@ -17,6 +17,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
@@ -131,7 +132,7 @@ public void showContextMenu(final int clientX, final int clientY)
       menu.addSeparator();
       menu.addItem(commands_.vcsOpen().createMenuItem(false));
 
-      menu.showRelativeTo(clientX, clientY);
+      menu.showRelativeTo(clientX, clientY, ElementIds.SVN_TAB_CONTEXT);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/events/ReticulateEvent.java
Patch:
@@ -76,7 +76,7 @@ protected void dispatch(Handler handler)
    public static final Type<Handler> TYPE = new Type<>();
 
    // synchronize with SessionReticulate.R
-   public static final String TYPE_PYTHON_INITIALIZED = "pythAon_initialized";
+   public static final String TYPE_PYTHON_INITIALIZED = "python_initialized";
    public static final String TYPE_REPL_INITIALIZED   = "repl_initialized";
    public static final String TYPE_REPL_ITERATION     = "repl_iteration";
    public static final String TYPE_REPL_BUSY          = "repl_busy";

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/python/PythonInterpreterSelectionDialog.java
Patch:
@@ -37,7 +37,7 @@ public PythonInterpreterSelectionDialog(final JsArray<PythonInterpreter> interpr
       widgets_.setAriaLabel("Python Interpreters");
       
       for (PythonInterpreter interpreter : JsUtil.asIterable(interpreters))
-         if (interpreter.getVersion() != null)
+         if (interpreter.isValid())
             widgets_.addItem(new PythonInterpreterListEntryUi(interpreter));
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -628,7 +628,7 @@ public SelectInputClickHandler(boolean scrollOnClick)
       public void onClick(ClickEvent event)
       {
          // If clicking on the input panel already, stop propagation.
-         if (!scrollOnClick_ || event.getSource() == input_)
+         if (event.getSource() == input_)
          {
             event.stopPropagation();
             return;
@@ -720,7 +720,7 @@ public void run()
             // https://github.com/rstudio/rstudio/issues/6231
             boolean wasScrolledToBottom = scrollPanel_.isScrolledToBottom();
             input_.setFocus(true);
-            if (wasScrolledToBottom)
+            if (scrollOnClick_ && wasScrolledToBottom)
                scrollPanel_.scrollToBottom();
          }
       };

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -337,6 +337,9 @@ public Source(Commands commands,
          @Override
          public void onSourcePathChanged(final SourcePathChangedEvent event)
          {
+            // Satellites also need to know about this happening, for example if a file
+            // is renamed via the tab context menu or externally
+            events_.fireEventToAllSatellites(event);
 
             columnManager_.inEditorForPath(event.getFrom(),
                             new OperationWithInput<EditingTarget>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -704,6 +704,9 @@ public void onSourceFileSaved(SourceFileSavedEvent event)
       // our internal doc mappings so we can route navigations to the right
       // window for that path
       updateDocPath(event.getDocId(), event.getPath());
+
+      // satellites also need to know if a file was renamed
+      events_.fireEventToAllSatellites(event);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -337,6 +337,9 @@ public Source(Commands commands,
          @Override
          public void onSourcePathChanged(final SourcePathChangedEvent event)
          {
+            // Satellites also need to know about this happening, for example if a file
+            // is renamed via the tab context menu or externally
+            events_.fireEventToAllSatellites(event);
 
             columnManager_.inEditorForPath(event.getFrom(),
                             new OperationWithInput<EditingTarget>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -704,6 +704,9 @@ public void onSourceFileSaved(SourceFileSavedEvent event)
       // our internal doc mappings so we can route navigations to the right
       // window for that path
       updateDocPath(event.getDocId(), event.getPath());
+
+      // satellites also need to know if a file was renamed
+      events_.fireEventToAllSatellites(event);
    }
 
    @Override

File: src/gwt/src/com/google/gwt/widgetideas/client/ResizableWidgetCollection.java
Patch:
@@ -135,7 +135,7 @@ public void run() {
   /**
    * A hash map of the resizable widgets this collection is checking.
    */
-  private Map<ResizableWidget, ResizableWidgetInfo> widgets = new HashMap<ResizableWidget, ResizableWidgetInfo>();
+  private Map<ResizableWidget, ResizableWidgetInfo> widgets = new HashMap<>();
 
   /**
    * The current window height.

File: src/gwt/src/com/google/gwt/widgetideas/client/SliderBar.java
Patch:
@@ -195,7 +195,7 @@ public static interface SliderBarImages extends ImageBundle {
   /**
    * The elements used to display labels above the ticks.
    */
-  private List<Element> labelElements = new ArrayList<Element>();
+  private List<Element> labelElements = new ArrayList<>();
 
   /**
    * The formatter used to generate label text.
@@ -263,7 +263,7 @@ public static interface SliderBarImages extends ImageBundle {
    * The elements used to display tick marks, which are the vertical lines along
    * the slider bar.
    */
-  private List<Element> tickElements = new ArrayList<Element>();
+  private List<Element> tickElements = new ArrayList<>();
 
   /**
    * Create a slider bar.

File: src/gwt/src/com/sksamuel/gwt/websockets/Websocket.java
Patch:
@@ -33,7 +33,7 @@ public static boolean isSupported() {
         return _isWebsocket();
     }
 
-    private final Set<WebsocketListener> listeners = new HashSet<WebsocketListener>();
+    private final Set<WebsocketListener> listeners = new HashSet<>();
 
     private final String varName;
     private final String url;
@@ -119,4 +119,4 @@ public void send(byte[] bytes) {
         String base64 = Base64Utils.toBase64(bytes);
         send(base64);
     }
-}
+}

File: src/gwt/src/org/rstudio/core/client/CsvReader.java
Patch:
@@ -37,7 +37,7 @@ public boolean hasNext()
 
          public String[] next()
          {
-            ArrayList<String> list = new ArrayList<String>();
+            ArrayList<String> list = new ArrayList<>();
             StringBuilder chunk = new StringBuilder();
 
             final int START = 0;

File: src/gwt/src/org/rstudio/core/client/ExternalJavaScriptLoader.java
Patch:
@@ -39,8 +39,7 @@ private enum State
 
    public static void loadSequentially(String[] urls, final Callback callback)
    {
-      final LinkedList<ExternalJavaScriptLoader> loaders =
-            new LinkedList<ExternalJavaScriptLoader>();
+      final LinkedList<ExternalJavaScriptLoader> loaders = new LinkedList<>();
 
       for (String url : urls)
          loaders.add(new ExternalJavaScriptLoader(url));
@@ -131,7 +130,7 @@ public boolean execute()
       });
    }
 
-   private LinkedList<Callback> callbacks_ = new LinkedList<Callback>();
+   private LinkedList<Callback> callbacks_ = new LinkedList<>();
    private State state_ = State.Start;
    private final String url_;
    private final Document document_;

File: src/gwt/src/org/rstudio/core/client/ExternalStyleSheetLoader.java
Patch:
@@ -105,7 +105,7 @@ public boolean execute()
       });
    }
 
-   private LinkedList<Callback> callbacks_ = new LinkedList<Callback>();
+   private LinkedList<Callback> callbacks_ = new LinkedList<>();
    private State state_ = State.Start;
    private final String url_;
    private final Document document_;

File: src/gwt/src/org/rstudio/core/client/HtmlMessageListener.java
Patch:
@@ -44,7 +44,7 @@ public HtmlMessageListener(FileTypeRegistry fileTypeRegistry,
       htmlMessageListener_ = this;
       fileTypeRegistry_ = fileTypeRegistry;
       pUserPrefs_ = pUIPrefs;
-      themeSources_ = new ArrayList<JavaScriptObject>();
+      themeSources_ = new ArrayList<>();
       
       initializeMessageListeners();
 

File: src/gwt/src/org/rstudio/core/client/JsArrayUtil.java
Patch:
@@ -58,7 +58,7 @@ public static <T extends JavaScriptObject> void fillList(JsArray<T> jsArray,
    public static <T extends JavaScriptObject> ArrayList<T> toArrayList(
          JsArray<T> jsArray)
    {
-      ArrayList<T> list = new ArrayList<T>();
+      ArrayList<T> list = new ArrayList<>();
       fillList(jsArray, list);
       return list;
    }
@@ -86,7 +86,7 @@ public static JsArrayString toJsArrayString(List<String> in)
    
    public static ArrayList<String> fromJsArrayString(JsArrayString in)
    {
-      ArrayList<String> out = new ArrayList<String>();
+      ArrayList<String> out = new ArrayList<>();
       for (int i = 0; i < in.length(); i++)
       {
          out.add(in.get(i));

File: src/gwt/src/org/rstudio/core/client/PreemptiveTaskQueue.java
Patch:
@@ -141,7 +141,7 @@ private void log(String label)
    }
    
    
-   private Queue<Task> taskQueue_ = new LinkedList<Task>();
+   private Queue<Task> taskQueue_ = new LinkedList<>();
    private boolean processing_ = false;
    private final boolean log_;
    private final boolean safe_;

File: src/gwt/src/org/rstudio/core/client/Rendezvous.java
Patch:
@@ -41,7 +41,7 @@ public class Rendezvous
    public Rendezvous(int count)
    {
       this.remainingArrivals = count;
-      this.joined = new ArrayList<Command>();
+      this.joined = new ArrayList<>();
    }
 
    /**

File: src/gwt/src/org/rstudio/core/client/SafeHtmlUtil.java
Patch:
@@ -198,7 +198,7 @@ public SearchMatch(int indexIn, int lengthIn)
       
       // Store matches in a tree set ordered by the index at which the match was
       // found.
-      Set<SearchMatch> matches = new TreeSet<SearchMatch>(
+      Set<SearchMatch> matches = new TreeSet<>(
             (SearchMatch o1, SearchMatch o2) -> {
                   return o1.index.compareTo(o2.index);
             });

File: src/gwt/src/org/rstudio/core/client/cellview/TriStateCheckboxCell.java
Patch:
@@ -51,7 +51,7 @@ interface Resources extends ClientBundle
    public TriStateCheckboxCell(SelectionModel<TKey> selectionModel)
    {
       selectionModel_ = selectionModel;
-      consumedEvents_ = new HashSet<String>();
+      consumedEvents_ = new HashSet<>();
       consumedEvents_.add("click");
       consumedEvents_.add("keydown");
       consumedEvents_.add("mouseover");

File: src/gwt/src/org/rstudio/core/client/command/ApplicationCommandManager.java
Patch:
@@ -42,7 +42,7 @@ public ApplicationCommandManager()
    {
       RStudioGinjector.INSTANCE.injectMembers(this);
 
-      bindings_ = new ConfigFileBacked<EditorKeyBindings>(
+      bindings_ = new ConfigFileBacked<>(
             server_,
             KEYBINDINGS_PATH,
             false,
@@ -145,15 +145,15 @@ private void loadBindings(EditorKeyBindings bindings,
                              final CommandWithArg<EditorKeyBindings> afterLoad)
    {
       List<Pair<List<KeySequence>, AppCommand>> resolvedBindings;
-      resolvedBindings = new ArrayList<Pair<List<KeySequence>, AppCommand>>();
+      resolvedBindings = new ArrayList<>();
 
       for (String id : bindings.iterableKeys())
       {
          AppCommand command = commands_.getCommandById(id);
          if (command == null)
             continue;
          List<KeySequence> keys = bindings.get(id).getKeyBindings();
-         resolvedBindings.add(new Pair<List<KeySequence>, AppCommand>(keys, command));
+         resolvedBindings.add(new Pair<>(keys, command));
       }
 
       KeyMap map = ShortcutManager.INSTANCE.getKeyMap(KeyMapType.APPLICATION);

File: src/gwt/src/org/rstudio/core/client/command/CommandBundle.java
Patch:
@@ -39,6 +39,5 @@ public HashMap<String, AppCommand> getCommands()
       return commandsById_;
    }
 
-   private final HashMap<String, AppCommand> commandsById_ =
-         new HashMap<String, AppCommand>();
+   private final HashMap<String, AppCommand> commandsById_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/core/client/command/CommandEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class CommandEvent extends GwtEvent<CommandHandler>
 {
-   public static final Type<CommandHandler> TYPE = new Type<CommandHandler>();
+   public static final Type<CommandHandler> TYPE = new Type<>();
 
    public CommandEvent(AppCommand command)
    {

File: src/gwt/src/org/rstudio/core/client/command/EnabledChangedEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class EnabledChangedEvent extends GwtEvent<EnabledChangedHandler>
 {
-   public static final Type<EnabledChangedHandler> TYPE = new Type<EnabledChangedHandler>();
+   public static final Type<EnabledChangedHandler> TYPE = new Type<>();
 
    public EnabledChangedEvent(AppCommand command)
    {

File: src/gwt/src/org/rstudio/core/client/command/KeySequence.java
Patch:
@@ -25,12 +25,12 @@ public class KeySequence
 {
    public KeySequence()
    {
-      keyCombinations_ = new ArrayList<KeyCombination>();
+      keyCombinations_ = new ArrayList<>();
    }
 
    public KeySequence(List<KeyCombination> keyList)
    {
-      keyCombinations_ = new ArrayList<KeyCombination>(keyList);
+      keyCombinations_ = new ArrayList<>(keyList);
    }
 
    public static KeySequence fromShortcutString(String shortcut)

File: src/gwt/src/org/rstudio/core/client/command/ShortcutInfo.java
Patch:
@@ -22,7 +22,7 @@ public class ShortcutInfo
 {
    public ShortcutInfo (KeyboardShortcut shortcut, AppCommand command)
    {
-      shortcuts_ = new ArrayList<String>();
+      shortcuts_ = new ArrayList<>();
       description_ = shortcut.getTitle().length() > 0 ?
                         shortcut.getTitle() :
                         command != null ?

File: src/gwt/src/org/rstudio/core/client/command/SubMenuVisibleChangedEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class SubMenuVisibleChangedEvent extends GwtEvent<SubMenuVisibleChangedHandler>
 {
-   public static final Type<SubMenuVisibleChangedHandler> TYPE = new Type<SubMenuVisibleChangedHandler>();
+   public static final Type<SubMenuVisibleChangedHandler> TYPE = new Type<>();
    @Override
    public Type<SubMenuVisibleChangedHandler> getAssociatedType()
    {

File: src/gwt/src/org/rstudio/core/client/command/UserCommandManager.java
Patch:
@@ -35,7 +35,7 @@ public UserCommand(String name, Command command)
    public UserCommandManager()
    {
       RStudioGinjector.INSTANCE.injectMembers(this);
-      commandMap_ = new HashMap<KeyboardShortcut, UserCommand>();
+      commandMap_ = new HashMap<>();
 
       events_.addHandler(
             RegisterUserCommandEvent.TYPE,

File: src/gwt/src/org/rstudio/core/client/command/VisibleChangedEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class VisibleChangedEvent extends GwtEvent<VisibleChangedHandler>
 {
-   public static final Type<VisibleChangedHandler> TYPE = new Type<VisibleChangedHandler>();
+   public static final Type<VisibleChangedHandler> TYPE = new Type<>();
 
    public VisibleChangedEvent(AppCommand command)
    {

File: src/gwt/src/org/rstudio/core/client/command/impl/WebMenuCallback.java
Patch:
@@ -104,6 +104,6 @@ private AppMenuBar head()
       return menuStack_.peek();
    }
 
-   private final Stack<AppMenuBar> menuStack_ = new Stack<AppMenuBar>();
+   private final Stack<AppMenuBar> menuStack_ = new Stack<>();
    private AppMenuBar result_;
 }

File: src/gwt/src/org/rstudio/core/client/container/SafeMap.java
Patch:
@@ -25,7 +25,7 @@ public class SafeMap<K, V>
 {
    public SafeMap()
    {
-      data_ = new HashMap<K, V>();
+      data_ = new HashMap<>();
    }
 
    public V get(K key)

File: src/gwt/src/org/rstudio/core/client/dom/DomUtils.java
Patch:
@@ -697,7 +697,7 @@ public static List<Node> findNodes(Node start,
                                       boolean siblings,
                                       NodePredicate filter)
    {
-      List<Node> results = new ArrayList<Node>();
+      List<Node> results = new ArrayList<>();
       int remaining = 0;
 
       if (start == null)

File: src/gwt/src/org/rstudio/core/client/events/SelectionCommitEvent.java
Patch:
@@ -25,7 +25,7 @@ public static <I> void fire(HasSelectionCommitHandlers<I> source, I selectedItem
    {
      if (TYPE != null)
      {
-       SelectionCommitEvent<I> event = new SelectionCommitEvent<I>(selectedItem);
+       SelectionCommitEvent<I> event = new SelectionCommitEvent<>(selectedItem);
        source.fireEvent(event);
      }
    }

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -343,8 +343,7 @@ public final native boolean focusOnNavigate() /*-{
    }-*/;
 
    // NOTE: should be synced with mime type database in FilePath.cpp
-   private final static HashMap<String,String> MIME_TYPES =
-                                             new HashMap<String,String>();
+   private final static HashMap<String,String> MIME_TYPES = new HashMap<>();
    static
    {
       MIME_TYPES.put( "htm",   "text/html" );

File: src/gwt/src/org/rstudio/core/client/files/PosixFileSystemContext.java
Patch:
@@ -51,7 +51,7 @@ public String combine(String root, String name)
 
    public FileSystemItem[] parseDir(String dirPath)
    {
-      ArrayList<FileSystemItem> results = new ArrayList<FileSystemItem>();
+      ArrayList<FileSystemItem> results = new ArrayList<>();
 
       if (dirPath.startsWith("/"))
          results.add(FileSystemItem.createDir("/"));

File: src/gwt/src/org/rstudio/core/client/files/filedialog/ChooseFolderDialog2.java
Patch:
@@ -53,7 +53,7 @@ public Widget createMainWidget()
    public FileSystemItem[] ls()
    {
       FileSystemItem[] items = super.ls();
-      ArrayList<FileSystemItem> dirs = new ArrayList<FileSystemItem>();
+      ArrayList<FileSystemItem> dirs = new ArrayList<>();
       for (FileSystemItem item : items)
          if (item.isDirectory())
             dirs.add(item);

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileSystemDialog.java
Patch:
@@ -325,7 +325,7 @@ private static FileSystemItem[] listFilesWithExtensions(
       if (items == null)
          return new FileSystemItem[0];
 
-      ArrayList<FileSystemItem> filtered = new ArrayList<FileSystemItem>();
+      ArrayList<FileSystemItem> filtered = new ArrayList<>();
       for (int i = 0; i < items.length; i++)
       {
          if (items[i].isDirectory())

File: src/gwt/src/org/rstudio/core/client/html/HTMLAttributesParser.java
Patch:
@@ -63,9 +63,9 @@ private static class Parser
       public Parser(String attributes)
       {
          attributes_ = StringUtil.notNull(attributes).trim();
-         map_ = new HashMap<String, String>();
+         map_ = new HashMap<>();
          identifier_ = "";
-         classes_ = new ArrayList<String>();
+         classes_ = new ArrayList<>();
          
          index_ = 0;
          n_ = attributes.length();

File: src/gwt/src/org/rstudio/core/client/js/JsUtil.java
Patch:
@@ -230,7 +230,7 @@ public native static String getObjectType(JavaScriptObject obj) /*-{
    
    public static List<String> toList(JsArrayString array)
    {
-      List<String> list = new ArrayList<String>();
+      List<String> list = new ArrayList<>();
       for (int i = 0, n = array.length(); i < n; i++)
          list.add(array.get(i));
       return list;

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RequestLog.java
Patch:
@@ -45,8 +45,7 @@ public static RequestLogEntry[] getEntries()
       return entries;
    }
 
-   private static final ArrayList<RequestLogEntry> entries_ =
-         new ArrayList<RequestLogEntry>();
+   private static final ArrayList<RequestLogEntry> entries_ = new ArrayList<>();
 
    private static final int MAX_ENTRIES = 50;
 }

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcObjectList.java
Patch:
@@ -42,7 +42,7 @@ public final native T get(int index) /*-{
 
    public final ArrayList<T> toArrayList()
    {
-      ArrayList<T> result = new ArrayList<T>(length());
+      ArrayList<T> result = new ArrayList<>(length());
       for (int i = 0; i < length(); i++)
          result.add(get(i));
       return result;

File: src/gwt/src/org/rstudio/core/client/layout/FadeOutAnimation.java
Patch:
@@ -26,7 +26,7 @@ public class FadeOutAnimation extends Animation
 {
    public FadeOutAnimation(Widget widget, Command callback)
    {
-      List<Widget> widgets = new ArrayList<Widget>();
+      List<Widget> widgets = new ArrayList<>();
       widgets.add(widget);
       widgets_ = widgets;
       callback_ = callback;

File: src/gwt/src/org/rstudio/core/client/patch/SubstringDiff.java
Patch:
@@ -47,7 +47,7 @@ public SubstringDiff(String origVal, String newVal)
    
    public TextChange[] asTextChanges() 
    {
-      ArrayList<TextChange> changes = new ArrayList<TextChange>();
+      ArrayList<TextChange> changes = new ArrayList<>();
       if (valid_)
       {
          if (offset_ > 0)

File: src/gwt/src/org/rstudio/core/client/tex/TexMagicComment.java
Patch:
@@ -24,7 +24,7 @@ public class TexMagicComment
 {
    public static ArrayList<TexMagicComment> parseComments(String code)
    {
-      ArrayList<TexMagicComment> comments = new ArrayList<TexMagicComment>();
+      ArrayList<TexMagicComment> comments = new ArrayList<>();
       
       Iterable<String> lines = StringUtil.getLineIterator(code);
       

File: src/gwt/src/org/rstudio/core/client/widget/AutocompleteSuggestionDisplay.java
Patch:
@@ -35,7 +35,7 @@ public interface ShowSuggestionsHandler
    
    public AutocompleteSuggestionDisplay()
    {
-      showHandlers_ = new ArrayList<ShowSuggestionsHandler>();
+      showHandlers_ = new ArrayList<>();
       PopupPanel panel = getPopupPanel();
       if (panel != null)
       {

File: src/gwt/src/org/rstudio/core/client/widget/DocPropMenuItem.java
Patch:
@@ -72,7 +72,7 @@ public boolean isChecked()
    @Override
    public void onInvoked()
    {
-      HashMap<String, String> props = new HashMap<String, String>();
+      HashMap<String, String> props = new HashMap<>();
       String target = targetValue_;
       
       // toggle behavior for boolean values: if our target was true but the

File: src/gwt/src/org/rstudio/core/client/widget/LocalRepositoriesWidget.java
Patch:
@@ -80,7 +80,7 @@ public void addItem(String item)
    }
    
    public ArrayList<String> getItems() {
-      ArrayList<String> items = new ArrayList<String>();
+      ArrayList<String> items = new ArrayList<>();
       int numItems = listBox_.getItemCount();
       for (int i = 0; i < numItems; ++i) {
          items.add(listBox_.getItemText(i));

File: src/gwt/src/org/rstudio/core/client/widget/MultipleItemSuggestTextBox.java
Patch:
@@ -36,7 +36,7 @@ public MultipleItemSuggestTextBox()
    
    public List<String> getItems()
    {
-      ArrayList<String> items = new ArrayList<String>();
+      ArrayList<String> items = new ArrayList<>();
       String text = super.getText();
       if (!StringUtil.isNullOrEmpty(text))
       {

File: src/gwt/src/org/rstudio/core/client/widget/WidgetListBox.java
Patch:
@@ -328,8 +328,8 @@ else if (emptyTextBox_.getParent() != this && items_.size() == 0)
    private VerticalPanel panel_;
    private VerticalPanel emptyTextBox_;
    private Label emptyTextLabel_;
-   private List<HTMLPanel> options_ = new ArrayList<HTMLPanel>();
-   private List<T> items_ = new ArrayList<T>();
+   private List<HTMLPanel> options_ = new ArrayList<>();
+   private List<T> items_ = new ArrayList<>();
 
    private Resources resources_;
    private ListStyle style_;

File: src/gwt/src/org/rstudio/core/client/widget/Wizard.java
Patch:
@@ -497,7 +497,7 @@ protected String getMainWidgetStyle()
     
    protected ArrayList<String> getWizardBodyStyles()
    {
-      ArrayList<String> classes = new ArrayList<String>();
+      ArrayList<String> classes = new ArrayList<>();
       classes.add(WizardResources.INSTANCE.styles().wizardBodyPanel());
       return classes;
    }

File: src/gwt/src/org/rstudio/core/client/widget/WizardIntermediatePage.java
Patch:
@@ -53,7 +53,7 @@ public ArrayList<WizardPage<I, T>> getSubPages()
    {
       // we have a single subpage, which is the next page we were initialized
       // with
-      ArrayList<WizardPage<I, T>> subPage = new ArrayList<WizardPage<I, T>>();
+      ArrayList<WizardPage<I, T>> subPage = new ArrayList<>();
       subPage.add(nextPage_);
       return subPage;
    }

File: src/gwt/src/org/rstudio/core/client/widget/WizardNavigationPage.java
Patch:
@@ -40,7 +40,7 @@ public WizardNavigationPage(String title,
            image,
            largeImage,
            pages,
-           pages1 -> new WizardPageSelector<I, T>(pages1));
+           pages1 -> new WizardPageSelector<>(pages1));
    }
 
    public WizardNavigationPage(String title,

File: src/gwt/src/org/rstudio/core/rebind/JavaScriptSerializerGenerator.java
Patch:
@@ -40,7 +40,7 @@ public String generate (TreeLogger logger, GeneratorContext context,
                             String typeName) throws UnableToCompleteException
     {
        TypeOracle oracle = context.getTypeOracle();
-       List<JClassType> classes = new ArrayList<JClassType>();
+       List<JClassType> classes = new ArrayList<>();
        
        // locate all the types annotated with JavaScriptSerializable
        for (JClassType classType : oracle.getTypes())

File: src/gwt/src/org/rstudio/core/rebind/command/ShortcutsEmitter.java
Patch:
@@ -92,7 +92,7 @@ public void generate(SourceWriter writer) throws UnableToCompleteException
    
    private static List<String> preprocessShortcutValue(String shortcutValue)
    {
-      List<String> shortcuts = new ArrayList<String>();
+      List<String> shortcuts = new ArrayList<>();
       
       for (String keySequence : shortcutValue.split("\\|"))
       {
@@ -118,7 +118,7 @@ private void printShortcut(SourceWriter writer,
                               String title,
                               String disableModes) throws UnableToCompleteException
    {
-      List<ShortcutKeyCombination> keys = new ArrayList<ShortcutKeyCombination>();
+      List<ShortcutKeyCombination> keys = new ArrayList<>();
       
       for (String keyCombination : shortcut.split("\\s+"))
       {

File: src/gwt/src/org/rstudio/studio/client/JavaScriptEventHistory.java
Patch:
@@ -62,7 +62,7 @@ public interface Predicate
    
    public JavaScriptEventHistory()
    {
-      queue_ = new LinkedList<EventData>();
+      queue_ = new LinkedList<>();
       registerEventListeners();
    }
    

File: src/gwt/src/org/rstudio/studio/client/ResizableHeader.java
Patch:
@@ -86,15 +86,15 @@ public void render(Context context,
    
    public ResizableHeader(AbstractCellTable<?> table, String text)
    {
-      super(new ResizableHeaderCell<String>(table));
+      super(new ResizableHeaderCell<>(table));
       
       table_ = table;
       text_ = text;
       index_ = table.getColumnCount();
       
       MouseDragHandler.addHandler(table_, new MouseDragHandler()
       {
-         List<Integer> columnWidths_ = new ArrayList<Integer>();
+         List<Integer> columnWidths_ = new ArrayList<>();
          
          @Override
          public boolean beginDrag(MouseDownEvent event)

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -304,8 +304,7 @@ public void execute()
       // multiple save targets
       else
       {
-         ArrayList<UnsavedChangesTarget> unsaved = 
-                                      new ArrayList<UnsavedChangesTarget>();
+         ArrayList<UnsavedChangesTarget> unsaved = new ArrayList<>();
          if (saveAction == SaveAction.SAVEASK && globalEnvTarget != null)
             unsaved.add(globalEnvTarget);
          unsaved.addAll(unsavedSourceDocs);

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationUtils.java
Patch:
@@ -85,7 +85,7 @@ public static String getRemainingQueryString(List<String> removeKeys)
    
    public static void removeQueryParam(String param)
    {
-      ArrayList<String> params = new ArrayList<String>();
+      ArrayList<String> params = new ArrayList<>();
       params.add(param);
       removeQueryParams(params);
    }

File: src/gwt/src/org/rstudio/studio/client/application/ui/RVersionSelectWidget.java
Patch:
@@ -68,7 +68,7 @@ private static String[] rVersionChoices(JsArray<RVersionSpec> rVersions,
       boolean disambiguate = RVersionSpec.hasDuplicates(rVersions);
 
       // build list of choices
-      ArrayList<String> choices = new ArrayList<String>();
+      ArrayList<String> choices = new ArrayList<>();
 
       // include "default" label if requested
       if (includeSystemDefault)
@@ -91,7 +91,7 @@ private static String[] rVersionChoices(JsArray<RVersionSpec> rVersions,
    private static String[] rVersionValues(JsArray<RVersionSpec> rVersions,
                                           boolean includeSystemDefault)
    {
-      ArrayList<String> values = new ArrayList<String>();
+      ArrayList<String> values = new ArrayList<>();
 
       if (includeSystemDefault)
          values.add(rVersionSpecToString(RVersionSpec.createEmpty()));

File: src/gwt/src/org/rstudio/studio/client/application/ui/RequestLogVisualization.java
Patch:
@@ -306,7 +306,7 @@ else if (keyCode == 'I')
                      public void execute(String input)
                      {
                         CsvReader reader = new CsvReader(input);
-                        ArrayList<RequestLogEntry> entries = new ArrayList<RequestLogEntry>();
+                        ArrayList<RequestLogEntry> entries = new ArrayList<>();
                         Iterator<String[]> it = reader.iterator();
                         String now = it.next()[0];
                         while (it.hasNext())

File: src/gwt/src/org/rstudio/studio/client/application/ui/addins/AddinsToolbarButton.java
Patch:
@@ -241,7 +241,7 @@ public void execute()
    
    private Map<String, List<RAddin>> organizeAddins()
    {
-      Map<String, List<RAddin>> organized = new HashMap<String, List<RAddin>>();
+      Map<String, List<RAddin>> organized = new HashMap<>();
       
       String query = searchWidget_.getValue().toLowerCase().trim();
       
@@ -260,7 +260,7 @@ private Map<String, List<RAddin>> organizeAddins()
          String pkg = splat[0];
          
          if (!organized.containsKey(pkg))
-            organized.put(pkg, new ArrayList<RAddin>());
+            organized.put(pkg, new ArrayList<>());
          
          List<RAddin> addinList = organized.get(pkg);
          addinList.add(addin);

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -88,7 +88,7 @@ private int getPositionAtOffset(int offset)
       return Math.max(0, Math.min(pos, history_.size()));
    }
 
-   private final ArrayList<String> history_ = new ArrayList<String>();
+   private final ArrayList<String> history_ = new ArrayList<>();
    private int historyPos_;
    // If you start typing a command, then go up in history, then go down,
    // then what you had previously typed should still be there. This is

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ErrorManager.java
Patch:
@@ -171,7 +171,7 @@ private void setErrorManagementType(
 
    private void setErrorManagementType(String type)
    {
-      setErrorManagementType(type, new QuietServerRequestCallback<Void>());
+      setErrorManagementType(type, new QuietServerRequestCallback<>());
    }
 
    private void syncHandlerCommandsCheckedState()

File: src/gwt/src/org/rstudio/studio/client/common/fileexport/FileExport.java
Patch:
@@ -43,7 +43,7 @@ void initialize(GlobalDisplay globalDisplay,
    
    public void export(String caption, String description, FileSystemItem file)
    {
-      ArrayList<FileSystemItem> files = new ArrayList<FileSystemItem>();
+      ArrayList<FileSystemItem> files = new ArrayList<>();
       files.add(file);
       export(caption, description, null, files);
    }
@@ -111,7 +111,7 @@ public void execute(String archiveName, ProgressIndicator progress)
                   archiveName += ZIP;
                
                // build list of filenames
-               ArrayList<String> filenames = new ArrayList<String>();
+               ArrayList<String> filenames = new ArrayList<>();
                for (FileSystemItem file : files)
                   filenames.add(file.getName());
                

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/NewFileMenu.java
Patch:
@@ -42,7 +42,6 @@ void initialize(FileTypeCommands fileTypeCommands)
    protected abstract ArrayList<FileTypeCommands.CommandWithId> 
       getFileTypeCommands(FileTypeCommands fileTypeCommands);
    
-   private ArrayList<FileTypeCommands.CommandWithId> fileTypeCommands_ =
-         new ArrayList<FileTypeCommands.CommandWithId>();
+   private ArrayList<FileTypeCommands.CommandWithId> fileTypeCommands_ = new ArrayList<>();
 
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ProfilerType.java
Patch:
@@ -51,7 +51,7 @@ public void openFile(FileSystemItem file, EventBus eventBus)
 
    public HashSet<AppCommand> getSupportedCommands(Commands commands)
    {
-      HashSet<AppCommand> results = new HashSet<AppCommand>();
+      HashSet<AppCommand> results = new HashSet<>();
       results.add(commands.saveSourceDoc());
       results.add(commands.saveSourceDocAs());
       results.add(commands.saveProfileAs());

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -299,7 +299,7 @@ public String getScriptInterpreter()
 
    public HashSet<AppCommand> getSupportedCommands(Commands commands)
    {
-      HashSet<AppCommand> results = new HashSet<AppCommand>();
+      HashSet<AppCommand> results = new HashSet<>();
       results.add(commands.saveSourceDoc());
       results.add(commands.reopenSourceDocWithEncoding());
       results.add(commands.saveSourceDocAs());

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenDataFileEvent.java
Patch:
@@ -19,8 +19,7 @@
 
 public class OpenDataFileEvent extends GwtEvent<OpenDataFileHandler>
 {
-   public static final GwtEvent.Type<OpenDataFileHandler> TYPE =
-      new GwtEvent.Type<OpenDataFileHandler>();
+   public static final GwtEvent.Type<OpenDataFileHandler> TYPE = new GwtEvent.Type<>();
    
    public OpenDataFileEvent(FileSystemItem file)
    {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenFileInBrowserEvent.java
Patch:
@@ -19,7 +19,7 @@
 
 public class OpenFileInBrowserEvent extends GwtEvent<OpenFileInBrowserHandler>
 {
-   public static Type<OpenFileInBrowserHandler> TYPE = new Type<OpenFileInBrowserHandler>();
+   public static Type<OpenFileInBrowserHandler> TYPE = new Type<>();
 
    public OpenFileInBrowserEvent(FileSystemItem file)
    {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenPresentationSourceFileEvent.java
Patch:
@@ -22,8 +22,7 @@
 
 public class OpenPresentationSourceFileEvent extends GwtEvent<OpenPresentationSourceFileHandler>
 {
-   public static final GwtEvent.Type<OpenPresentationSourceFileHandler> TYPE =
-      new GwtEvent.Type<OpenPresentationSourceFileHandler>();
+   public static final GwtEvent.Type<OpenPresentationSourceFileHandler> TYPE = new GwtEvent.Type<>();
 
    public OpenPresentationSourceFileEvent(FileSystemItem file, 
                                           TextFileType fileType,

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenSourceFileEvent.java
Patch:
@@ -27,8 +27,7 @@
 @JavaScriptSerializable
 public class OpenSourceFileEvent extends CrossWindowEvent<OpenSourceFileHandler>
 {
-   public static final GwtEvent.Type<OpenSourceFileHandler> TYPE =
-      new GwtEvent.Type<OpenSourceFileHandler>();
+   public static final GwtEvent.Type<OpenSourceFileHandler> TYPE = new GwtEvent.Type<>();
 
    public OpenSourceFileEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/common/impl/WebTextInput.java
Patch:
@@ -69,7 +69,7 @@ public void promptForTextWithOption(
       // This variable introduces a level of pointer indirection that lets us
       // get around passing TextEntryModalDialog a reference to itself in its
       // own constructor.
-      final Value<TextEntryModalDialog> pDialog = new Value<TextEntryModalDialog>(null);
+      final Value<TextEntryModalDialog> pDialog = new Value<>(null);
 
       final TextEntryModalDialog dialog = new TextEntryModalDialog(
             title,

File: src/gwt/src/org/rstudio/studio/client/common/latex/LatexProgramRegistry.java
Patch:
@@ -73,7 +73,7 @@ public ArrayList<String> getTypes()
          JsArrayString types = 
                 pSession_.get().getSessionInfo().getLatexProgramTypes();
        
-         latexProgramTypes_ = new ArrayList<String>();
+         latexProgramTypes_ = new ArrayList<>();
          for (int i=0; i<types.length(); i++)
             latexProgramTypes_.add(types.get(i));
       }

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJax.java
Patch:
@@ -77,9 +77,9 @@ public MathJax(DocDisplay docDisplay, DocUpdateSentinel sentinel,
       prefs_ = prefs;
       popup_ = new MathJaxPopupPanel(this);
       renderQueue_ = new MathJaxRenderQueue(this);
-      handlers_ = new ArrayList<HandlerRegistration>();
-      cowToPlwMap_ = new SafeMap<ChunkOutputWidget, PinnedLineWidget>();
-      lwToPlwMap_ = new SafeMap<LineWidget, ChunkOutputWidget>();
+      handlers_ = new ArrayList<>();
+      cowToPlwMap_ = new SafeMap<>();
+      lwToPlwMap_ = new SafeMap<>();
 
       handlers_.add(popup_.addAttachHandler(new AttachEvent.Handler()
       {

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxLoader.java
Patch:
@@ -137,7 +137,7 @@ private static ScriptElement createMathJaxScriptElement()
       return el;
    }
    
-   private static List<Callback> MATHJAX_CALLBACKS = new ArrayList<Callback>();
+   private static List<Callback> MATHJAX_CALLBACKS = new ArrayList<>();
    private static boolean MATHJAX_LOADED = false;
    private static int RETRY_COUNT = 0;
    

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxRenderQueue.java
Patch:
@@ -26,7 +26,7 @@ public MathJaxRenderQueue(MathJax mathjax)
    {
       mathjax_ = mathjax;
       
-      ranges_ = new LinkedList<Range>();
+      ranges_ = new LinkedList<>();
       callback_ = new MathJaxTypeset.Callback()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxUtil.java
Patch:
@@ -107,7 +107,7 @@ public static boolean isSelectionWithinLatexChunk(DocDisplay docDisplay)
    public static List<Range> findLatexChunks(DocDisplay docDisplay)
    {
       docDisplay.tokenizeDocument();
-      List<Range> ranges = new ArrayList<Range>();
+      List<Range> ranges = new ArrayList<>();
       
       Position startPos = null;
       for (int i = 0, n = docDisplay.getRowCount(); i < n; i++)

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/ChooseMirrorDialog.java
Patch:
@@ -186,7 +186,7 @@ protected Widget createMainWidget()
          public void onResponseReceived(JsArray<CRANMirror> mirrors)
          {   
             // keep internal list of mirrors 
-            mirrors_ = new ArrayList<CRANMirror>(mirrors.length());
+            mirrors_ = new ArrayList<>(mirrors.length());
             
             // create list box and select default item
             listBox_ = new ListBox();

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/CRANMirror.java
Patch:
@@ -70,7 +70,7 @@ private final void setSecondaryRepos(String cran, ArrayList<CRANMirror> repos)
    {
       setURL(cran);
 
-      ArrayList<String> entries = new ArrayList<String>();
+      ArrayList<String> entries = new ArrayList<>();
       for (CRANMirror repo : repos)
       {
          if (!repo.getName().toLowerCase().equals("cran"))
@@ -89,7 +89,7 @@ public final void setSecondaryRepos(ArrayList<CRANMirror> repos)
 
    public final ArrayList<CRANMirror> getSecondaryRepos()
    {
-      ArrayList<CRANMirror> repos = new ArrayList<CRANMirror>();
+      ArrayList<CRANMirror> repos = new ArrayList<>();
 
       String secondary = getSecondary();
       if (StringUtil.isNullOrEmpty(secondary))

File: src/gwt/src/org/rstudio/studio/client/common/r/RTokenizer.java
Patch:
@@ -30,7 +30,7 @@ public RTokenizer(String data)
    
    public static ArrayList<RToken> asTokens(String code)
    {
-      ArrayList<RToken> results = new ArrayList<RToken>();
+      ArrayList<RToken> results = new ArrayList<>();
       RTokenizer rt = new RTokenizer(code);
       RToken t;
       while (null != (t = rt.nextToken()))

File: src/gwt/src/org/rstudio/studio/client/common/r/roxygen/RoxygenHelper.java
Patch:
@@ -796,7 +796,7 @@ protected SetRefClassCall() {}
          Pattern.create("^\\s*#+'\\s*@[^@]", "");
    
    private static final ArrayList<String> ROXYGEN_ANNOTATABLE_CALLS =
-      new ArrayList<String>(
+      new ArrayList<>(
             Arrays.asList(new String[] {
             "setClass",
             "setRefClass",

File: src/gwt/src/org/rstudio/studio/client/common/rnw/RnwWeaveRegistry.java
Patch:
@@ -68,7 +68,7 @@ public ArrayList<RnwWeave> getTypes()
          JsArray<RnwWeave> types = 
                            pSession_.get().getSessionInfo().getRnwWeaveTypes();
        
-         weaveTypes_ = new ArrayList<RnwWeave>();
+         weaveTypes_ = new ArrayList<>();
          for (int i=0; i<types.length(); i++)
             weaveTypes_.add(types.get(i));
       }

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/DialogHtmlSanitizer.java
Patch:
@@ -26,7 +26,7 @@
 import com.google.gwt.safehtml.shared.SafeHtmlUtils;
 
 public final class DialogHtmlSanitizer implements HtmlSanitizer {
-   private static final Set<String> TAG_WHITELIST = new HashSet<String>(
+   private static final Set<String> TAG_WHITELIST = new HashSet<>(
       Arrays.asList(
          "p", "em", "strong", "b", "i", "a"
       )

File: src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerList.java
Patch:
@@ -51,7 +51,7 @@ public SourceMarkerList()
    {
       codec_ = new SourceMarkerItemCodec(res_, false);
 
-      errorTable_ = new FastSelectTable<SourceMarker, CodeNavigationTarget, CodeNavigationTarget>(
+      errorTable_ = new FastSelectTable<>(
             codec_,
             res_.styles().selectedRow(),
             true,
@@ -121,7 +121,7 @@ public void showMarkers(String targetFile,
                            int autoSelect)
    {
       boolean showFileHeaders = false;
-      ArrayList<SourceMarker> errorList = new ArrayList<SourceMarker>();
+      ArrayList<SourceMarker> errorList = new ArrayList<>();
       int firstErrorIndex = -1;
       for (int i=0; i<errors.length(); i++)
       {

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java
Patch:
@@ -66,8 +66,8 @@ public void send()
       {
          String path = GWT.getHostPageBaseURL() + "dictionaries/" + language_ + "/" + language_;
 
-         final Mutable<String> aff = new Mutable<String>();
-         final Mutable<String> dic = new Mutable<String>();
+         final Mutable<String> aff = new Mutable<>();
+         final Mutable<String> dic = new Mutable<>();
          final Command onReady = () -> {
 
             if (cancelled_ || aff.get() == null || dic.get() == null)

File: src/gwt/src/org/rstudio/studio/client/common/vcs/StatusAndPath.java
Patch:
@@ -54,7 +54,7 @@ public static ArrayList<StatusAndPath> fromInfos(
       if (infos == null)
          return null;
 
-      ArrayList<StatusAndPath> result = new ArrayList<StatusAndPath>();
+      ArrayList<StatusAndPath> result = new ArrayList<>();
       for (int i = 0; i < infos.length(); i++)
       {
          result.add(new StatusAndPath(infos.get(i)));

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/Ignore.java
Patch:
@@ -230,15 +230,15 @@ private IgnoreList createIgnoreList(ArrayList<String> paths,
       // special case for empty path list -- make the project root the 
       // parent path and return an empty list
       if (paths.size() == 0)
-         return new IgnoreList("", new ArrayList<String>());
+         return new IgnoreList("", new ArrayList<>());
        
       // get the parent path of the first element
       FileSystemItem firstPath = FileSystemItem.createFile(paths.get(0));
       String parentPath = firstPath.getParentPathString();
       
       // confirm that all of the elements start with that path and take the
       // remainder of their paths for our list
-      ArrayList<String> ignored = new ArrayList<String>();
+      ArrayList<String> ignored = new ArrayList<>();
       for (String path : paths)
       {
          String thisParent = 
@@ -278,7 +278,7 @@ private IgnoreList createIgnoreList(ArrayList<String> paths,
    private String getIgnored(IgnoreList ignoreList, String existingIgnored)
    {
       // split existing ignored into list
-      ArrayList<String> ignored = new ArrayList<String>();
+      ArrayList<String> ignored = new ArrayList<>();
       Iterable<String> existing = StringUtil.getLineIterator(existingIgnored);
       for (String item : existing)
       {

File: src/gwt/src/org/rstudio/studio/client/common/viewfile/ViewFilePanel.java
Patch:
@@ -418,6 +418,5 @@ public int getHeight()
    
    private SaveFileAsHandler saveFileAsHandler_ = null;
    
-   private final ArrayList<HandlerRegistration> releaseOnDismiss_ =
-         new ArrayList<HandlerRegistration>();
+   private final ArrayList<HandlerRegistration> releaseOnDismiss_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -83,7 +83,7 @@ public void requestSuggestions(Request request, Callback callback)
             // no suggestions
             callback.onSuggestionsReady(
                   request,
-                  new Response(new ArrayList<Suggestion>()));
+                  new Response(new ArrayList<>()));
          }
       });
       searchWidget_.addValueChangeHandler(new ValueChangeHandler<String>() {

File: src/gwt/src/org/rstudio/studio/client/events/RStudioApiRequestEvent.java
Patch:
@@ -96,7 +96,7 @@ protected void dispatch(Handler handler)
       handler.onRStudioApiRequest(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
    
    
    // Event Data ----

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreviewPresenter.java
Patch:
@@ -327,8 +327,7 @@ public void onRefreshHtmlPreview()
    {
       if (lastSuccessfulPreview_.getEnableReexecute())
       {
-         server_.previewHTML(lastPreviewParams_, 
-                             new SimpleRequestCallback<Boolean>());
+         server_.previewHTML(lastPreviewParams_, new SimpleRequestCallback<>());
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/events/ShowHTMLPreviewEvent.java
Patch:
@@ -20,8 +20,7 @@
 
 public class ShowHTMLPreviewEvent extends GwtEvent<ShowHTMLPreviewHandler>
 { 
-   public static final GwtEvent.Type<ShowHTMLPreviewHandler> TYPE =
-      new GwtEvent.Type<ShowHTMLPreviewHandler>();
+   public static final GwtEvent.Type<ShowHTMLPreviewHandler> TYPE = new GwtEvent.Type<>();
    
    public ShowHTMLPreviewEvent(HTMLPreviewParams params)
    {

File: src/gwt/src/org/rstudio/studio/client/packrat/ui/PackratResolveConflictDialog.java
Patch:
@@ -72,7 +72,7 @@ public PackratResolveConflictDialog(
       mainWidget_.add(label);
             
       // table
-      table_ = new RStudioDataGrid<PackratConflictActions>(conflictActions.size(),
+      table_ = new RStudioDataGrid<>(conflictActions.size(),
             (PackagesDataGridCommon)GWT.create(PackagesDataGridCommon.class));
       StyleUtils.forceMacScrollbars(table_);
       table_.addStyleName(RESOURCES.styles().conflictsTable());

File: src/gwt/src/org/rstudio/studio/client/palette/AppCommandPaletteSource.java
Patch:
@@ -42,9 +42,9 @@ public AppCommandPaletteSource(ShortcutManager shortcuts, Commands commands)
    @Override
    public List<CommandPaletteItem> getCommandPaletteItems()
    {
-      List<CommandPaletteItem> items = new ArrayList<CommandPaletteItem>();
-      List<String> sorted = new ArrayList<String>();
-      Set<String> unsorted = new HashSet<String>();
+      List<CommandPaletteItem> items = new ArrayList<>();
+      List<String> sorted = new ArrayList<>();
+      Set<String> unsorted = new HashSet<>();
       unsorted.addAll(commands_.getCommands().keySet());
 
       // Front-load the first page of results with some useful commands; we don't attempt to sort

File: src/gwt/src/org/rstudio/studio/client/palette/CommandPaletteLauncher.java
Patch:
@@ -81,7 +81,7 @@ public CommandPaletteLauncher(Commands commands,
          // to use the Command Palette as a quick "run last command again" tool
          if (mru_ == null)
          {
-            mru_ = new ArrayList<CommandPaletteMruEntry>();
+            mru_ = new ArrayList<>();
          }
          mru_.removeIf(entry -> entry.equals(evt.getMruEntry()));
          mru_.add(0, evt.getMruEntry());
@@ -124,7 +124,7 @@ public void onClearCommandPaletteMru()
    private void createPanel()
    {
       // Extra sources (currently only the source tab)
-      List<CommandPaletteEntryProvider> providers = new ArrayList<CommandPaletteEntryProvider>();
+      List<CommandPaletteEntryProvider> providers = new ArrayList<>();
       
       // Create sources
       providers.add(new AppCommandPaletteSource(ShortcutManager.INSTANCE, commands_));
@@ -144,7 +144,7 @@ private void createPanel()
             ArrayList<String> mru = evt.getList();
 
             // After the first time the palette is shown, the MRU is updated by this event handler.
-            mru_ = new ArrayList<CommandPaletteMruEntry>();
+            mru_ = new ArrayList<>();
             for (String entry: mru)
             {
                CommandPaletteMruEntry mruEntry = CommandPaletteMruEntry.fromString(entry);

File: src/gwt/src/org/rstudio/studio/client/palette/RAddinPaletteSource.java
Patch:
@@ -26,7 +26,6 @@
 import org.rstudio.core.client.command.ShortcutManager;
 import org.rstudio.core.client.js.JsUtil;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntryProvider;
-import org.rstudio.studio.client.palette.model.CommandPaletteEntrySource;
 import org.rstudio.studio.client.palette.model.CommandPaletteItem;
 import org.rstudio.studio.client.palette.ui.CommandPalette;
 import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;
@@ -49,7 +48,7 @@ public RAddinPaletteSource(RAddins addins, ShortcutManager shortcuts)
    @Override
    public List<CommandPaletteItem> getCommandPaletteItems()
    {
-      List<CommandPaletteItem> items = new ArrayList<CommandPaletteItem>();
+      List<CommandPaletteItem> items = new ArrayList<>();
       for (String id: JsUtil.asIterable(addins_.keys()))
       {
          RAddin addin = addins_.get(id);

File: src/gwt/src/org/rstudio/studio/client/palette/UserPrefPaletteSource.java
Patch:
@@ -40,7 +40,7 @@ public UserPrefPaletteSource(UserPrefs prefs)
    @Override
    public List<CommandPaletteItem> getCommandPaletteItems()
    {
-      List<CommandPaletteItem> items = new ArrayList<CommandPaletteItem>();
+      List<CommandPaletteItem> items = new ArrayList<>();
       for (PrefValue<?> val: prefs_.allPrefs())
       {
          if (StringUtil.isNullOrEmpty(val.getTitle()))

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorCommandIcons.java
Patch:
@@ -88,6 +88,6 @@ private String dm(String icon)
    
    public static PanmirrorCommandIcons INSTANCE = new PanmirrorCommandIcons();
    
-   private HashMap<String,ImageResource> icons_ = new HashMap<String,ImageResource>();
+   private HashMap<String,ImageResource> icons_ = new HashMap<>();
    
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorCommandPaletteEntry.java
Patch:
@@ -59,7 +59,7 @@ public boolean enabled()
 
    private static List<KeySequence> keySequence(PanmirrorCommandUI command)
    {
-      List<KeySequence> keys = new ArrayList<KeySequence>();
+      List<KeySequence> keys = new ArrayList<>();
       KeySequence keySequence = command.getKeySequence();
       if (keySequence != null)
          keys.add(keySequence);

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbar.java
Patch:
@@ -230,5 +230,5 @@ private HorizontalPanel addWidgetGroup(Widget...widgets)
    
    private PanmirrorToolbarCommands commands_ = null;
    private PanmirrorMenus menus_ = null;
-   private ArrayList<PanmirrorCommandUIObject> commandObjects_ = new ArrayList<PanmirrorCommandUIObject>();
+   private ArrayList<PanmirrorCommandUIObject> commandObjects_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarCommands.java
Patch:
@@ -22,7 +22,6 @@
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntryProvider;
-import org.rstudio.studio.client.palette.model.CommandPaletteEntrySource;
 import org.rstudio.studio.client.palette.model.CommandPaletteItem;
 
 import com.google.gwt.aria.client.MenuitemRole;
@@ -170,7 +169,7 @@ public boolean exec(String id)
    @Override
    public List<CommandPaletteItem> getCommandPaletteItems()
    {
-      List<CommandPaletteItem> items = new ArrayList<CommandPaletteItem>();
+      List<CommandPaletteItem> items = new ArrayList<>();
       for (PanmirrorCommandUI cmd: commandsUI_.values())
       {
          if (cmd != null && cmd.isVisible())
@@ -245,5 +244,5 @@ private void add(String id, String menuText, String pluralMenuText, MenuitemRole
    }
    
    private PanmirrorCommand[] commands_ = null;
-   private final HashMap<String,PanmirrorCommandUI> commandsUI_ = new HashMap<String,PanmirrorCommandUI>();
+   private final HashMap<String,PanmirrorCommandUI> commandsUI_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarRadioMenu.java
Patch:
@@ -83,6 +83,6 @@ public void sync(boolean images)
    private final String defaultText_;
    private int minWidth_ = 0;
    private final PanmirrorToolbarMenu menu_;
-   private final ArrayList<String> commandIds_ = new ArrayList<String>();
+   private final ArrayList<String> commandIds_ = new ArrayList<>();
    private final PanmirrorToolbarCommands commands_;
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorEditListDialog.java
Patch:
@@ -70,7 +70,7 @@ public PanmirrorEditListDialog(PanmirrorListProps props,
       numberStyle_.setVisible(capabilities.fancy);
       numberDelimiter_.setVisible(capabilities.fancy);
       
-      List<String> numberStyleChoices = new ArrayList<String>();
+      List<String> numberStyleChoices = new ArrayList<>();
       numberStyleChoices.add("DefaultStyle");
       numberStyleChoices.add("Decimal");
       numberStyleChoices.add("LowerRoman");

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorLangSuggestBox.java
Patch:
@@ -59,7 +59,7 @@ public void requestSuggestions(Request request, Callback callback)
          {
             String query = request.getQuery();
             
-            ArrayList<Suggestion> suggestions = new ArrayList<Suggestion>();
+            ArrayList<Suggestion> suggestions = new ArrayList<>();
             for (int i=0; i<languages.length; i++)
             {
                String language = languages[i];

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorRawFormatSelect.java
Patch:
@@ -37,7 +37,7 @@ public void setFormats(String[] formats, String value)
    
    private static String[] getFormatList(String firstItem, String[] formats, String value)
    {
-      ArrayList<String> options = new ArrayList<String>();
+      ArrayList<String> options = new ArrayList<>();
       options.add(firstItem);
       options.addAll(Arrays.asList(formats));
       if (!options.contains(value))

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorBlurEvent.java
Patch:
@@ -44,7 +44,7 @@ public static void fire(HasPanmirrorBlurHandlers source) {
 
   public static Type<PanmirrorBlurEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorBlurEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorFindReplaceVisibleEvent.java
Patch:
@@ -78,7 +78,7 @@ public static void fire(HasPanmirrorFindReplaceVisibleHandlers source, boolean v
    */
   public static Type<PanmirrorFindReplaceVisibleEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorFindReplaceVisibleEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorFocusEvent.java
Patch:
@@ -44,7 +44,7 @@ public static void fire(HasPanmirrorFocusHandlers source) {
 
   public static Type<PanmirrorFocusEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorFocusEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorNavigationEvent.java
Patch:
@@ -80,7 +80,7 @@ public static void fire(HasPanmirrorNavigationHandlers source, PanmirrorNavigati
    */
   public static Type<PanmirrorNavigationEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorNavigationEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorOutlineNavigationEvent.java
Patch:
@@ -78,7 +78,7 @@ public static void fire(HasPanmirrorOutlineNavigationHandlers source, String id)
    */
   public static Type<PanmirrorOutlineNavigationEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorOutlineNavigationEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorOutlineVisibleEvent.java
Patch:
@@ -78,7 +78,7 @@ public static void fire(HasPanmirrorOutlineVisibleHandlers source, boolean visib
    */
   public static Type<PanmirrorOutlineVisibleEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorOutlineVisibleEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorOutlineWidthEvent.java
Patch:
@@ -78,7 +78,7 @@ public static void fire(HasPanmirrorOutlineWidthHandlers source, double width) {
    */
   public static Type<PanmirrorOutlineWidthEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorOutlineWidthEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorStateChangeEvent.java
Patch:
@@ -44,7 +44,7 @@ public static void fire(HasPanmirrorStateChangeHandlers source) {
 
   public static Type<PanmirrorStateChangeEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorStateChangeEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorUpdatedEvent.java
Patch:
@@ -44,7 +44,7 @@ public static void fire(HasPanmirrorUpdatedHandlers source) {
 
   public static Type<PanmirrorUpdatedEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorUpdatedEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/outline/PanmirrorOutlineWidget.java
Patch:
@@ -195,7 +195,7 @@ private void addToTree(PanmirrorOutlineItem item)
    
    private ArrayList<PanmirrorOutlineItem> flattenOutline(PanmirrorOutlineItem[] items)
    {
-      ArrayList<PanmirrorOutlineItem> flattenedItems = new ArrayList<PanmirrorOutlineItem>();
+      ArrayList<PanmirrorOutlineItem> flattenedItems = new ArrayList<>();
       String chunkPref = pPrefs_.get().docOutlineShow().getValue();
       doFlattenOutline(items, flattenedItems, chunkPref);
       return flattenedItems;

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorCrossrefServer.java
Patch:
@@ -42,10 +42,10 @@ void initialize(PanmirrorCrossrefServerOperations server)
    
    public Promise<JavaScriptObject> works(String query)
    {
-      return new Promise<JavaScriptObject>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
          server_.crossrefWorks(
             query,
-            new PromiseServerRequestCallback<JavaScriptObject>(resolve, reject)
+            new PromiseServerRequestCallback<>(resolve, reject)
          );
       });
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorDOIServer.java
Patch:
@@ -43,10 +43,10 @@ void initialize(PanmirrorDOIServerOperations server)
    
    public Promise<JavaScriptObject> fetchCSL(String doi, int delayMs)
    {
-      return new Promise<JavaScriptObject>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
          server_.doiFetchCSL(
         		doi,
-            new PromiseServerRequestCallback<JavaScriptObject>(resolve, reject, "Looking up DOI...", delayMs)
+            new PromiseServerRequestCallback<>(resolve, reject, "Looking up DOI...", delayMs)
          );
       });
    }   

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorDataCiteServer.java
Patch:
@@ -42,10 +42,10 @@ void initialize(PanmirrorDataCiteServerOperations server)
    
    public Promise<JavaScriptObject> search(String query)
    {
-      return new Promise<JavaScriptObject>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
          server_.dataciteSearch(
             query,
-            new PromiseServerRequestCallback<JavaScriptObject>(resolve, reject)
+            new PromiseServerRequestCallback<>(resolve, reject)
          );
       });
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorPubMedServer.java
Patch:
@@ -42,10 +42,10 @@ void initialize(PanmirrorPubMedServerOperations server)
    
    public Promise<JavaScriptObject> search(String query)
    {
-      return new Promise<JavaScriptObject>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
          server_.pubmedSearch(
             query,
-            new PromiseServerRequestCallback<JavaScriptObject>(resolve, reject)
+            new PromiseServerRequestCallback<>(resolve, reject)
          );
       });
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUIMath.java
Patch:
@@ -31,7 +31,7 @@ public class PanmirrorUIMath {
    
    public Promise<Boolean> typeset(Element el, String text, boolean priority)
    {
-      return new Promise<Boolean>((ResolveCallbackFn<Boolean> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<Boolean> resolve, RejectCallbackFn reject) -> {
          MathJaxLoader.withMathJaxLoaded((alreadyLoaded) -> {
             MathJaxTypeset.typeset(el, text, priority, (error) -> {
                resolve.onInvoke(error);

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/model/PdfJsWindow.java
Patch:
@@ -374,7 +374,7 @@ public static void navigateTo(final PdfJsWindow win,
       final double w = pdfLocation.getWidth() * factor;
       final double h = pdfLocation.getHeight() * factor;
       
-      final Value<Integer> retries = new Value<Integer>(0);
+      final Value<Integer> retries = new Value<>(0);
 
       // Sometimes pageContainer is null during load, so retry every 100ms
       // until it's not, or we've tried 40 times.

File: src/gwt/src/org/rstudio/studio/client/plumber/events/LaunchPlumberAPIEvent.java
Patch:
@@ -30,7 +30,7 @@ public interface Handler extends EventHandler
    }
 
    public static final GwtEvent.Type<LaunchPlumberAPIEvent.Handler> TYPE =
-      new GwtEvent.Type<LaunchPlumberAPIEvent.Handler>();
+      new GwtEvent.Type<>();
    
    public LaunchPlumberAPIEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/plumber/events/PlumberAPIStatusEvent.java
Patch:
@@ -30,8 +30,7 @@ public interface Handler extends EventHandler
       void onPlumberAPIStatus(PlumberAPIStatusEvent event);
    }
 
-   public static final GwtEvent.Type<PlumberAPIStatusEvent.Handler> TYPE =
-      new GwtEvent.Type<PlumberAPIStatusEvent.Handler>();
+   public static final GwtEvent.Type<PlumberAPIStatusEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public PlumberAPIStatusEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -560,7 +560,7 @@ public void onError(ServerError error)
                   // not be currently installed; in those cases, verify that the package is
                   // installed and if not attempt installation from CRAN first
                   String pkg = newProject.getProjectTemplateOptions().getDescription().getPackage();
-                  ArrayList<Dependency> deps = new ArrayList<Dependency>();
+                  ArrayList<Dependency> deps = new ArrayList<>();
                   deps.add(Dependency.cranPackage(pkg));
                   RStudioGinjector.INSTANCE.getDependencyManager().withDependencies(
                         "Creating project",

File: src/gwt/src/org/rstudio/studio/client/projects/events/OpenProjectErrorEvent.java
Patch:
@@ -20,8 +20,7 @@
 
 public class OpenProjectErrorEvent extends GwtEvent<OpenProjectErrorHandler>
 {
-   public static final GwtEvent.Type<OpenProjectErrorHandler> TYPE =
-      new GwtEvent.Type<OpenProjectErrorHandler>();
+   public static final GwtEvent.Type<OpenProjectErrorHandler> TYPE = new GwtEvent.Type<>();
    
    public OpenProjectErrorEvent(OpenProjectError error)
    {

File: src/gwt/src/org/rstudio/studio/client/projects/events/OpenProjectFileEvent.java
Patch:
@@ -19,8 +19,7 @@
 
 public class OpenProjectFileEvent extends GwtEvent<OpenProjectFileHandler>
 {
-   public static final GwtEvent.Type<OpenProjectFileHandler> TYPE =
-      new GwtEvent.Type<OpenProjectFileHandler>();
+   public static final GwtEvent.Type<OpenProjectFileHandler> TYPE = new GwtEvent.Type<>();
    
    public OpenProjectFileEvent(FileSystemItem file)
    {

File: src/gwt/src/org/rstudio/studio/client/projects/events/OpenProjectNewWindowEvent.java
Patch:
@@ -20,8 +20,7 @@
 
 public class OpenProjectNewWindowEvent extends GwtEvent<OpenProjectNewWindowHandler>
 {
-   public static final GwtEvent.Type<OpenProjectNewWindowHandler> TYPE =
-      new GwtEvent.Type<OpenProjectNewWindowHandler>();
+   public static final GwtEvent.Type<OpenProjectNewWindowHandler> TYPE = new GwtEvent.Type<>();
    
    public OpenProjectNewWindowEvent(String project, RVersionSpec rVersion)
    {

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectTemplateRegistryProvider.java
Patch:
@@ -40,7 +40,7 @@ public ProjectTemplateRegistryProvider()
    {
       RStudioGinjector.INSTANCE.injectMembers(this);
       
-      pendingCallbacks_ = new ArrayList<Callback>();
+      pendingCallbacks_ = new ArrayList<>();
       
       events_.addHandler(ProjectTemplateRegistryUpdatedEvent.TYPE, this);
       

File: src/gwt/src/org/rstudio/studio/client/projects/model/RProjectConfig.java
Patch:
@@ -264,7 +264,7 @@ public final void setPackageRoxygenize(boolean rd,
                                           boolean namespace,
                                           boolean vignette)
    {
-      ArrayList<String> roclets = new ArrayList<String>();
+      ArrayList<String> roclets = new ArrayList<>();
       if (rd)
          roclets.add(ROXYGENIZE_RD);
       if (collate)

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/CodeFilesList.java
Patch:
@@ -81,7 +81,7 @@ void initialize(FileDialogs fileDialogs,
    
    public ArrayList<String> getCodeFiles()
    {
-      ArrayList<String> codeFiles = new ArrayList<String>();
+      ArrayList<String> codeFiles = new ArrayList<>();
       for (int i=0; i<listBox_.getItemCount(); i++)
          codeFiles.add(listBox_.getItemText(i));
       return codeFiles;

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryNavigationPage.java
Patch:
@@ -75,8 +75,8 @@ public Widget createMainWidget(ArrayList<WizardPage<NewProjectInput, NewProjectR
    private static ArrayList<WizardPage<NewProjectInput, NewProjectResult>>
                                          createPages(SessionInfo sessionInfo)
    {
-      ArrayList<WizardPage<NewProjectInput, NewProjectResult>> pages = 
-            new ArrayList<WizardPage<NewProjectInput, NewProjectResult>>();
+      ArrayList<WizardPage<NewProjectInput, NewProjectResult>> pages =
+            new ArrayList<>();
       
       // add default RStudio dialogs
       pages.add(new NewDirectoryPage());

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPackratPreferencesPane.java
Patch:
@@ -211,7 +211,7 @@ private ArrayList<String> getTextAreaValue(TextArea textArea)
       List<String> values = Arrays.asList(value.split("\\s*,\\s*"));
 
       // remove entries that are only whitespace
-      ArrayList<String> result = new ArrayList<String>();
+      ArrayList<String> result = new ArrayList<>();
       for (String s : values)
       {
          if (!StringUtil.isNullOrEmpty(s))

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsWebsitePanel.java
Patch:
@@ -74,8 +74,8 @@ void load(RProjectOptions options)
          
          // get all available output formats
          JsArrayString formatsJson = buildContext.getWebsiteOutputFormats();
-         ArrayList<String> formatNames = new ArrayList<String>();
-         ArrayList<String> formats = new ArrayList<String>();
+         ArrayList<String> formatNames = new ArrayList<>();
+         ArrayList<String> formats = new ArrayList<>();
         
          // always include "All Formats"
          formatNames.add("(All Formats)");

File: src/gwt/src/org/rstudio/studio/client/renv/ui/RenvActionDialogContents.java
Patch:
@@ -43,10 +43,10 @@ interface RenvRestoreDialogContentsUiBinder
    public RenvActionDialogContents(String action, JsArray<RenvAction> actions)
    {
       action_ = action;
-      actions_ = new ArrayList<RenvAction>();
+      actions_ = new ArrayList<>();
       JsArrayUtil.fillList(actions, actions_);
       
-      table_ = new RStudioDataGrid<RenvAction>(actions.length(), RES);
+      table_ = new RStudioDataGrid<>(actions.length(), RES);
       
       table_.setHeight("500px");
       table_.setWidth("600px");

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/NotebookQueueUnit.java
Patch:
@@ -130,7 +130,7 @@ public final boolean hasPendingRange(NotebookExecRange range)
    private final List<Integer> linesFromRanges(
          JsArray<NotebookExecRange> ranges)
    {
-      List<Integer> lines = new ArrayList<Integer>();
+      List<Integer> lines = new ArrayList<>();
       final String code = getCode();
       int line = 0, last = -1;
       for (int i = 0; i < code.length(); i++)

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/YamlTree.java
Patch:
@@ -121,7 +121,7 @@ public void setValue(String value)
       public String key;
       public int indentLevel = 0;
       public YamlTreeNode parent = null;
-      public List<YamlTreeNode> children = new ArrayList<YamlTreeNode>();
+      public List<YamlTreeNode> children = new ArrayList<>();
       
       private String getKey(String line)
       {
@@ -142,7 +142,7 @@ private int getIndentLevel()
    public YamlTree(String yaml)
    {
       root_ = createYamlTree(yaml);
-      keyMap_ = new HashMap<String, YamlTreeNode>();
+      keyMap_ = new HashMap<>();
       createKeyMap(root_, keyMap_);
    }
    
@@ -182,7 +182,7 @@ public List<String> getChildKeys(String parentKey)
          if (!keyMap_.containsKey(parentKey))
             return null;
          YamlTreeNode parent = keyMap_.get(parentKey);
-         ArrayList<String> result = new ArrayList<String>();
+         ArrayList<String> result = new ArrayList<>();
          for (YamlTreeNode child: parent.children)
          {
             result.add(child.key);

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -1017,8 +1017,7 @@ private void configureShinyApp(final String dir,
 
       // If we know the most recent deployment of the directory, act on that
       // deployment by default
-      final ArrayList<RSConnectDeploymentRecord> recordList =
-            new ArrayList<RSConnectDeploymentRecord>();
+      final ArrayList<RSConnectDeploymentRecord> recordList = new ArrayList<>();
       RSConnectDeploymentRecord lastRecord = dirState_.getLastDeployment(dir);
       if (lastRecord != null)
       {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/EnableRStudioConnectUIEvent.java
Patch:
@@ -37,8 +37,7 @@ public interface Handler extends EventHandler
       void onEnableRStudioConnectUI(EnableRStudioConnectUIEvent event);
    }
 
-   public static final GwtEvent.Type<EnableRStudioConnectUIEvent.Handler> TYPE =
-      new GwtEvent.Type<EnableRStudioConnectUIEvent.Handler>();
+   public static final GwtEvent.Type<EnableRStudioConnectUIEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public EnableRStudioConnectUIEvent(Data enable)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectActionEvent.java
Patch:
@@ -28,8 +28,7 @@ public interface Handler extends EventHandler
       void onRSConnectAction(RSConnectActionEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectActionEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectActionEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectActionEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public static RSConnectActionEvent ConfigureAppEvent(String path)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeployInitiatedEvent.java
Patch:
@@ -28,8 +28,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeployInitiated(RSConnectDeployInitiatedEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeployInitiatedEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeployInitiatedEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeployInitiatedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeployInitiatedEvent(RSConnectPublishSource source,
                                         RSConnectPublishSettings settings,

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentCancelledEvent.java
Patch:
@@ -24,8 +24,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeploymentCancelled(RSConnectDeploymentCancelledEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentCancelledEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentCancelledEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentCancelledEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentCancelledEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentCompletedEvent.java
Patch:
@@ -24,8 +24,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeploymentCompleted(RSConnectDeploymentCompletedEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentCompletedEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentCompletedEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentCompletedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentCompletedEvent(String url)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentFailedEvent.java
Patch:
@@ -40,8 +40,7 @@ public final native String getHttpStatus() /*-{
       }-*/;
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentFailedEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentFailedEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentFailedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentFailedEvent(Data data)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentOutputEvent.java
Patch:
@@ -26,8 +26,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeploymentOutput(RSConnectDeploymentOutputEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentOutputEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentOutputEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentOutputEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentOutputEvent(CompileOutput output)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentStartedEvent.java
Patch:
@@ -24,8 +24,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeploymentStarted(RSConnectDeploymentStartedEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentStartedEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentStartedEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentStartedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentStartedEvent(String path, String title)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/PlotPublishMRUList.java
Patch:
@@ -109,5 +109,5 @@ public void addPlotMruEntry(String account, String server, String name,
    }
 
    private final WorkbenchList plotMru_;
-   private ArrayList<String> plotMruList_ = new ArrayList<String>();
+   private ArrayList<String> plotMruList_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectPublishResult.java
Patch:
@@ -20,7 +20,7 @@ public class RSConnectPublishResult
 {
    public RSConnectPublishResult(RSConnectPublishSource source)
    {
-      ArrayList<String> deployFiles = new ArrayList<String>();
+      ArrayList<String> deployFiles = new ArrayList<>();
       deployFiles.add(source.getDeployFile());
       publishType_ = PUBLISH_RPUBS;
       appName_     = ""; 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/NewRSConnectAuthPage.java
Patch:
@@ -372,7 +372,7 @@ public void onError(ServerError error)
    private RSConnectServerOperations server_;
    private GlobalDisplay display_;
    private RSConnectAuthWait contents_;
-   private Value<Boolean> waitingForAuth_ = new Value<Boolean>(false);
+   private Value<Boolean> waitingForAuth_ = new Value<>(false);
    private boolean runningAuthCompleteCheck_ = false;
    private ProgressIndicator wizardIndicator_;
 }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishDocServicePage.java
Patch:
@@ -38,9 +38,7 @@ public PublishDocServicePage(String title, String subTitle,
            createPages(RSConnectPublishInput input)
    {
       ArrayList<WizardPage<RSConnectPublishInput, 
-                           RSConnectPublishResult>> pages =
-                           new ArrayList<WizardPage<RSConnectPublishInput, 
-                                                    RSConnectPublishResult>>();
+                           RSConnectPublishResult>> pages = new ArrayList<>();
       String rscTitle = RSConnectAccountWizard.SERVICE_NAME;
       String rscDesc = RSConnectAccountWizard.SERVICE_DESCRIPTION;
            

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishMultiplePage.java
Patch:
@@ -39,9 +39,7 @@ public PublishMultiplePage(String title, String subTitle, ImageResource icon,
            createPages(RSConnectPublishInput input)
    {
       ArrayList<WizardPage<RSConnectPublishInput, 
-                           RSConnectPublishResult>> pages =
-                           new ArrayList<WizardPage<RSConnectPublishInput, 
-                                                    RSConnectPublishResult>>();
+                           RSConnectPublishResult>> pages = new ArrayList<>();
       String singleTitle = "Publish just this document";
       String singleSubtitle = "Only the document " + 
                               input.getSourceRmd().getName() + 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishReportSourcePage.java
Patch:
@@ -44,9 +44,7 @@ public PublishReportSourcePage(
            createPages(RSConnectPublishInput input, boolean asMultiple)
    {
       ArrayList<WizardPage<RSConnectPublishInput, 
-                           RSConnectPublishResult>> pages =
-                           new ArrayList<WizardPage<RSConnectPublishInput, 
-                                                    RSConnectPublishResult>>();
+                           RSConnectPublishResult>> pages = new ArrayList<>();
       
       String descriptor = "document";
       if (asMultiple)

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeployDialog.java
Patch:
@@ -178,6 +178,5 @@ private void processDeploymentRecords(
    private RSConnectAccount defaultAccount_;
    
    // Map of app URL to the deployment made to that URL
-   private Map<String, RSConnectDeploymentRecord> deployments_ = 
-         new HashMap<String, RSConnectDeploymentRecord>();
+   private Map<String, RSConnectDeploymentRecord> deployments_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishButton.java
Patch:
@@ -666,13 +666,13 @@ public void execute(String htmlFile)
                      RSConnectPublishSource source = 
                            new RSConnectPublishSource(htmlFile, null, 
                                  true, true, false, "Plot", contentType_);
-                     ArrayList<String> deployFiles = new ArrayList<String>();
+                     ArrayList<String> deployFiles = new ArrayList<>();
                      deployFiles.add(FilePathUtils.friendlyFileName(htmlFile));
                      RSConnectPublishSettings settings = 
                            new RSConnectPublishSettings(
                                  deployFiles, 
-                                 new ArrayList<String>(), 
-                                 new ArrayList<String>(), 
+                                 new ArrayList<>(), 
+                                 new ArrayList<>(), 
                                  false, true);
                      events_.fireEvent(
                            new RSConnectDeployInitiatedEvent(source, settings,

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -1083,7 +1083,7 @@ else if (type == ClientEvent.DocumentCloseAllNoSave)
 
    private final EventBus eventBus_;
 
-   private final ArrayList<ClientEvent> pendingEvents_ = new ArrayList<ClientEvent>();
+   private final ArrayList<ClientEvent> pendingEvents_ = new ArrayList<>();
 
 
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerAuth.java
Patch:
@@ -127,8 +127,7 @@ public void onError(ServerError serverError)
 
    // save previous form as a precaution against forms which are not
    // cleaned up due to the submit handler not being called
-   private static ArrayList<FormPanel> previousUpdateCredentialsForms_ =
-                                            new ArrayList<FormPanel>();
+   private static ArrayList<FormPanel> previousUpdateCredentialsForms_ = new ArrayList<>();
 
    private void safeCleanupPreviousUpdateCredentials()
    {

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplication.java
Patch:
@@ -90,7 +90,7 @@ public ShinyApplication(EventBus eventBus,
       currentViewType_ = UserPrefs.SHINY_VIEWER_TYPE_NONE;
       dependencyManager_ = dependencyManager;
       interrupt_ = interrupt;
-      params_ = new ArrayList<ShinyApplicationParams>();
+      params_ = new ArrayList<>();
       
       eventBus_.addHandler(ShinyApplicationStatusEvent.TYPE, this);
       eventBus_.addHandler(LaunchShinyApplicationEvent.TYPE, this);

File: src/gwt/src/org/rstudio/studio/client/shiny/events/LaunchShinyApplicationEvent.java
Patch:
@@ -30,7 +30,7 @@ public interface Handler extends EventHandler
    }
 
    public static final GwtEvent.Type<LaunchShinyApplicationEvent.Handler> TYPE =
-      new GwtEvent.Type<LaunchShinyApplicationEvent.Handler>();
+      new GwtEvent.Type<>();
    
    public LaunchShinyApplicationEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/shiny/events/ShinyApplicationStatusEvent.java
Patch:
@@ -30,8 +30,7 @@ public interface Handler extends EventHandler
       void onShinyApplicationStatus(ShinyApplicationStatusEvent event);
    }
 
-   public static final GwtEvent.Type<ShinyApplicationStatusEvent.Handler> TYPE =
-      new GwtEvent.Type<ShinyApplicationStatusEvent.Handler>();
+   public static final GwtEvent.Type<ShinyApplicationStatusEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public ShinyApplicationStatusEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyViewerTypePopupMenu.java
Patch:
@@ -41,9 +41,9 @@ public ShinyViewerTypePopupMenu(Commands commands,
       addSeparator();
       addItem(commands.shinyRunInBrowser().createMenuItem(false));
       addSeparator();
-      addItem(new UserPrefMenuItem<Boolean>(prefs.shinyBackgroundJobs(), 
+      addItem(new UserPrefMenuItem<>(prefs.shinyBackgroundJobs(), 
             false, "In R Console", prefs));
-      addItem(new UserPrefMenuItem<Boolean>(prefs.shinyBackgroundJobs(), 
+      addItem(new UserPrefMenuItem<>(prefs.shinyBackgroundJobs(), 
             true, "In Background Job", prefs));
       addSeparator();
       addItem(commands.shinyRecordTest().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/workbench/BrowseAddinsDialog.java
Patch:
@@ -102,11 +102,11 @@ public Object getKey(RAddin addin)
          }
       };
       
-      table_ = new RStudioDataGrid<RAddin>(1000, RES, keyProvider_);
+      table_ = new RStudioDataGrid<>(1000, RES, keyProvider_);
       table_.setWidth("500px");
       table_.setHeight("400px");
       
-      selectionModel_ = new SingleSelectionModel<RAddin>();
+      selectionModel_ = new SingleSelectionModel<>();
       selectionModel_.addSelectionChangeHandler(new SelectionChangeEvent.Handler()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/MRUList.java
Patch:
@@ -133,7 +133,7 @@ private void updateCommands()
    protected void manageCommands(List<String> entries, AppCommand[] commands)
    {
       // optionally transform paths
-      ArrayList<String> transformed = new ArrayList<String>();
+      ArrayList<String> transformed = new ArrayList<>();
       for (String entry : entries)
          transformed.add(transformMruEntryPath(entry));
 
@@ -169,7 +169,7 @@ protected AppCommand[] getMruCommands()
       return mruCmds_;
    }
 
-   private final ArrayList<String> mruEntries_ = new ArrayList<String>();
+   private final ArrayList<String> mruEntries_ = new ArrayList<>();
    private final AppCommand[] mruCmds_;
    private final AppCommand clearCommand_;
    private final WorkbenchList mruList_;

File: src/gwt/src/org/rstudio/studio/client/workbench/addins/Addins.java
Patch:
@@ -179,7 +179,7 @@ public void onError(ServerError error)
          {
             server_.executeRAddinNonInteractively(
                   addin.getId(),
-                  new SimpleRequestCallback<Void>("Error Executing Addin", true));
+                  new SimpleRequestCallback<>("Error Executing Addin", true));
          }
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearch.java
Patch:
@@ -227,6 +227,5 @@ public void detachEventBusHandlers()
    private final EventBus events_;
    
    private Observer observer_ = null;
-   private ArrayList<HandlerRegistration> eventBusHandlers_ = 
-                                 new ArrayList<HandlerRegistration>();
+   private ArrayList<HandlerRegistration> eventBusHandlers_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/events/ListChangedEvent.java
Patch:
@@ -42,7 +42,7 @@ public ListChangedEvent(JsObject eventData)
       name_ = eventData.getString("name");
 
       JsArrayString list = eventData.getObject("list");
-      list_ = new ArrayList<String>();
+      list_ = new ArrayList<>();
       for (int i=0; i<list.length(); i++)
          list_.add(list.get(i));
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/model/EventBasedChangeTracker.java
Patch:
@@ -44,7 +44,7 @@ public void reset()
 
    public ChangeTracker fork()
    {
-      EventBasedChangeTracker<T> ebct = new EventBasedChangeTracker<T>(source_);
+      EventBasedChangeTracker<T> ebct = new EventBasedChangeTracker<>(source_);
       ebct.changed_ = changed_;
       return ebct;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/model/RemoteFileSystemContext.java
Patch:
@@ -79,7 +79,7 @@ public void cd(String relativeOrAbsolutePath, final String fallbackPath)
 
       final FileSystemItem newPathEntry = FileSystemItem.createDir(newPath);
       
-      final ArrayList<FileSystemItem> fsi = new ArrayList<FileSystemItem>();
+      final ArrayList<FileSystemItem> fsi = new ArrayList<>();
 
       server_.listFiles(
             newPathEntry,

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchLists.java
Patch:
@@ -39,7 +39,7 @@ private native final JsArrayString getListNative(String name) /*-{
    
    private ArrayList<String> convertList(JsArrayString jsList)
    {
-      ArrayList<String> list = new ArrayList<String>();
+      ArrayList<String> list = new ArrayList<>();
       for (int i=0; i<jsList.length(); i++)
          list.add(jsList.get(i));
       return list;

File: src/gwt/src/org/rstudio/studio/client/workbench/model/helper/ClientStateValue.java
Patch:
@@ -67,7 +67,7 @@ protected void finishInit(ClientInitState state)
    {
       JsObject grp = state.peek(group_);
       T obj = doGet(grp, name_);
-      valueTracker_ = new ValueChangeTracker<T>(obj);
+      valueTracker_ = new ValueChangeTracker<>(obj);
       onInit(obj);
 
       EventBus evt = RStudioGinjector.INSTANCE.getEventBus();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/events/UserPrefsChangedEvent.java
Patch:
@@ -22,7 +22,7 @@
 @JavaScriptSerializable
 public class UserPrefsChangedEvent extends CrossWindowEvent<UserPrefsChangedHandler>
 {
-   public static final Type<UserPrefsChangedHandler> TYPE = new Type<UserPrefsChangedHandler>();
+   public static final Type<UserPrefsChangedHandler> TYPE = new Type<>();
    
    public UserPrefsChangedEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/events/UserStateChangedEvent.java
Patch:
@@ -24,7 +24,7 @@
 @JavaScriptSerializable
 public class UserStateChangedEvent extends CrossWindowEvent<UserStateChangedEvent.Handler>
 {
-   public static final Type<UserStateChangedEvent.Handler> TYPE = new Type<UserStateChangedEvent.Handler>();
+   public static final Type<UserStateChangedEvent.Handler> TYPE = new Type<>();
    
    public UserStateChangedEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/Prefs.java
Patch:
@@ -512,7 +512,7 @@ protected <T extends JavaScriptObject> PrefValue<T> object(String name,
       PrefValue<T> val = (PrefValue<T>) values_.get(name);
       if (val == null)
       {
-         val = new ObjectValue<T>(name, title, description, defaultValue);
+         val = new ObjectValue<>(name, title, description, defaultValue);
          values_.put(name, val);
       }
       return val;
@@ -525,6 +525,5 @@ protected void updatePrefs(JsArray<PrefLayer> layers)
    }
    
    private JsArray<PrefLayer> layers_;
-   private final HashMap<String, PrefValue<?>> values_ =
-         new HashMap<String, PrefValue<?>>();
+   private final HashMap<String, PrefValue<?>> values_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -3512,7 +3512,7 @@ public void syncPrefs(String layer, JsObject source)
    }
    public List<PrefValue<?>> allPrefs()
    {
-      ArrayList<PrefValue<?>> prefs = new ArrayList<PrefValue<?>>();
+      ArrayList<PrefValue<?>> prefs = new ArrayList<>();
       prefs.add(runRprofileOnResume());
       prefs.add(saveWorkspace());
       prefs.add(loadWorkspace());

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -566,7 +566,7 @@ public void syncPrefs(String layer, JsObject source)
    }
    public List<PrefValue<?>> allPrefs()
    {
-      ArrayList<PrefValue<?>> prefs = new ArrayList<PrefValue<?>>();
+      ArrayList<PrefValue<?>> prefs = new ArrayList<>();
       prefs.add(contextId());
       prefs.add(autoCreatedProfile());
       prefs.add(theme());

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -571,7 +571,7 @@ private boolean getRestoreProjectRVersion()
 
    private void initializeGraphicsBackendWidget()
    {
-      Map<String, String> valuesToLabelsMap = new HashMap<String, String>();
+      Map<String, String> valuesToLabelsMap = new HashMap<>();
       valuesToLabelsMap.put(UserPrefs.GRAPHICS_BACKEND_DEFAULT, " (Default)");
       valuesToLabelsMap.put(UserPrefs.GRAPHICS_BACKEND_QUARTZ,    "Quartz");
       valuesToLabelsMap.put(UserPrefs.GRAPHICS_BACKEND_WINDOWS,   "Windows");

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/LineEndingsSelectWidget.java
Patch:
@@ -39,7 +39,7 @@ public LineEndingsSelectWidget(boolean includeDefault)
 
    private static String[] getLineEndingsCaptions(boolean includeDefault)
    {
-      ArrayList<String> captions = new ArrayList<String>();
+      ArrayList<String> captions = new ArrayList<>();
       if (includeDefault)
          captions.add("(Use Default)");
       captions.add("None");
@@ -52,7 +52,7 @@ private static String[] getLineEndingsCaptions(boolean includeDefault)
    
    private static String[] getLineEndingsValues(boolean includeDefault)
    {
-      ArrayList<String> values = new ArrayList<String>();
+      ArrayList<String> values = new ArrayList<>();
       if (includeDefault)
          values.add(UserPrefs.LINE_ENDING_CONVERSION_DEFAULT);
       values.add(UserPrefs.LINE_ENDING_CONVERSION_PASSTHROUGH);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/SpellingPreferencesPane.java
Patch:
@@ -106,7 +106,7 @@ private void addUserDictionariesEditor(WorkbenchListManager workbenchListManager
          userDictLabel.setText(kUserDictionary + StringUtil.formatGeneralNumber(entries) + " words");
       };
       
-      final ArrayList<String> userDictWords = new ArrayList<String>();
+      final ArrayList<String> userDictWords = new ArrayList<>();
       WorkbenchList userDict = workbenchListManager.getUserDictionaryList();
       userDict.addListChangedHandler((e) -> {
          userDictWords.clear();
@@ -133,7 +133,7 @@ private void addUserDictionariesEditor(WorkbenchListManager workbenchListManager
                if (dictionary != null)
                {
                   List<String> dictSplitItems = Arrays.asList(dictionary.split("\n"));
-                  ArrayList<String> dictWords = new ArrayList<String>();
+                  ArrayList<String> dictWords = new ArrayList<>();
                   for (String item : dictSplitItems)
                   {
                      item = item.trim();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/python/PythonInterpreterSelectionDialog.java
Patch:
@@ -32,7 +32,7 @@ public PythonInterpreterSelectionDialog(final JsArray<PythonInterpreter> interpr
       super("Python Interpreters", Roles.getDialogRole(), operation);
       setOkButtonCaption("Select");
       
-      widgets_ = new WidgetListBox<PythonInterpreterListEntryUi>();
+      widgets_ = new WidgetListBox<>();
       widgets_.setHeight("420px");
       widgets_.setAriaLabel("Python Interpreters");
       

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/zotero/ZoteroConnectionWidget.java
Patch:
@@ -36,13 +36,13 @@ public ZoteroConnectionWidget(PreferencesDialogResources res, boolean includeHel
    
       HorizontalPanel panel = new HorizontalPanel();
       
-      ArrayList<String> options = new ArrayList<String>();
+      ArrayList<String> options = new ArrayList<>();
       options.add("(None)");
       if (!webOnly())
          options.add("Local");
       options.add("Web");
       
-      ArrayList<String> values = new ArrayList<String>();
+      ArrayList<String> values = new ArrayList<>();
       values.add(UserStateAccessor.ZOTERO_CONNECTION_TYPE_NONE);
       if (!webOnly())
          values.add(UserStateAccessor.ZOTERO_CONNECTION_TYPE_LOCAL);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/zotero/ZoteroLibrariesWidget.java
Patch:
@@ -47,7 +47,7 @@ public ZoteroLibrariesWidget(PanmirrorZoteroServerOperations server, boolean inc
       VerticalPanel panel = new VerticalPanel();
       panel.addStyleName(RES.styles().librariesWidget());
       
-      ArrayList<String> options = new ArrayList<String>();
+      ArrayList<String> options = new ArrayList<>();
       
       if (includeUseDefault)
          options.add(USE_DEFAULT);

File: src/gwt/src/org/rstudio/studio/client/workbench/snippets/ui/EditSnippetsDialog.java
Patch:
@@ -113,7 +113,7 @@ protected Widget createMainWidget()
       panel_.setHeight(size.height + "px");
       
       // snippet types
-      snippetTypes_ = new WidgetListBox<EditableSnippets>();
+      snippetTypes_ = new WidgetListBox<>();
       snippetTypes_.addChangeHandler(new ChangeHandler() {
          @Override
          public void onChange(ChangeEvent event)
@@ -306,8 +306,7 @@ private void recordEditorState()
    private boolean editorDirty_ = false;
    private EditableSnippets activeSnippets_ = null;
    
-   private final ArrayList<HandlerRegistration> releaseOnDismiss_ =
-         new ArrayList<HandlerRegistration>();
+   private final ArrayList<HandlerRegistration> releaseOnDismiss_ = new ArrayList<>();
    
    private EventBus events_;
    private GlobalDisplay globalDisplay_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsPresenter.java
Patch:
@@ -614,8 +614,8 @@ public boolean test(Connection connection)
    private Connection exploredConnection_;
    private Connection lastExploredConnection_;
    
-   private ArrayList<Connection> allConnections_ = new ArrayList<Connection>();
-   private ArrayList<ConnectionId> activeConnections_ = new ArrayList<ConnectionId>();
+   private ArrayList<Connection> allConnections_ = new ArrayList<>();
+   private ArrayList<ConnectionId> activeConnections_ = new ArrayList<>();
    
    private static boolean installersUpdated_ = false;
    private static String installersWarning_ = null;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionObjectSpecifier.java
Patch:
@@ -24,7 +24,7 @@ public class ConnectionObjectSpecifier
 {
    public ConnectionObjectSpecifier()
    {
-      containers_ = new ArrayList<ConnectionPathEntry>();
+      containers_ = new ArrayList<>();
    }
    
    public ConnectionObjectSpecifier(String name, String type)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/NewConnectionContext.java
Patch:
@@ -36,7 +36,7 @@ public final native NewConnectionInfo getConnectionsItem(int index) /*-{
 
    public final ArrayList<NewConnectionInfo> getConnectionsList()
    {
-      ArrayList<NewConnectionInfo> result = new ArrayList<NewConnectionInfo>(getConnectionsLength());
+      ArrayList<NewConnectionInfo> result = new ArrayList<>(getConnectionsLength());
       for (int i = 0; i < getConnectionsLength(); i++)
          result.add(getConnectionsItem(i));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetDialog.java
Patch:
@@ -144,5 +144,5 @@ public static void ensureStylesInjected()
    
    private NewConnectionInfo newConnectionInfo_;
    private ArrayList<NewConnectionSnippetParts> initialConfig_;
-   HashMap<String, String> partsKeyValues_ = new HashMap<String, String>();
+   HashMap<String, String> partsKeyValues_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ObjectBrowser.java
Patch:
@@ -124,8 +124,7 @@ public void onAttach()
          
          // if we got here, the user has clicked Show More, so scroll to the
          // bottom when they're done
-         final Value<HandlerRegistration> registration = 
-               new Value<HandlerRegistration>(null);
+         final Value<HandlerRegistration> registration = new Value<>(null);
          registration.setValue(scrollPanel_.addScrollHandler(e -> 
          {
             scrollPanel_.scrollToBottom();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ShellInputAnimator.java
Patch:
@@ -124,7 +124,6 @@ public boolean execute()
    
    private InputEditorDisplay display_;
    
-   private ArrayList<InputAnimator> pendingAnimatedInput_ =
-      new ArrayList<InputAnimator>();
+   private ArrayList<InputAnimator> pendingAnimatedInput_ = new ArrayList<>();
 
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionCache.java
Patch:
@@ -41,7 +41,7 @@ public class CompletionCache
 {
    public CompletionCache()
    {
-      cache_ = new SafeMap<String, Completions>();
+      cache_ = new SafeMap<>();
    }
    
    public boolean satisfyRequest(String line,
@@ -115,7 +115,7 @@ private Completions narrow(String line,
       }
       
       // Finally, sort these based on score
-      List<Integer> indices = new ArrayList<Integer>();
+      List<Integer> indices = new ArrayList<>();
       for (int i = 0, n = completionsNarrow.size(); i < n; i++)
          indices.add(i);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionListPopupPanel.java
Patch:
@@ -26,7 +26,7 @@ public class CompletionListPopupPanel<TItem> extends ThemedPopupPanel
    public CompletionListPopupPanel(TItem[] entries)
    {
       super(true);
-      list_ = new CompletionList<TItem>(entries, 10, true, true);
+      list_ = new CompletionList<>(entries, 10, true, true);
       setWidget(list_);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManagerBase.java
Patch:
@@ -82,7 +82,7 @@ public CompletionManagerBase(CompletionPopupDisplay popup,
       completionCache_ = new CompletionCache();
       suggestTimer_ = new SuggestionTimer();
       helpTimer_ = new HelpTimer();
-      handlers_ = new ArrayList<HandlerRegistration>();
+      handlers_ = new ArrayList<>();
       snippets_ = new SnippetHelper((AceEditor) docDisplay, context.getId());
       
       // deferred so that handlers are toggled after subclasses have finished
@@ -137,7 +137,7 @@ public void onCompletionResponseReceived(CompletionRequestContext.Data data,
          completionCache_.store(line, completions);
       
       int n = completions.getCompletions().length();
-      List<QualifiedName> names = new ArrayList<QualifiedName>();
+      List<QualifiedName> names = new ArrayList<>();
       for (int i = 0; i < n; i++)
       {
          names.add(new QualifiedName(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/DelegatingCompletionManager.java
Patch:
@@ -35,7 +35,7 @@ public abstract class DelegatingCompletionManager implements CompletionManager
    public DelegatingCompletionManager(DocDisplay docDisplay, CompletionContext context)
    {
       docDisplay_ = docDisplay;
-      completionManagerMap_ = new HashMap<Mode, CompletionManager>();
+      completionManagerMap_ = new HashMap<>();
       nullManager_ = new NullCompletionManager();
       
       if (docDisplay_ instanceof AceEditor)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HelpStrategy.java
Patch:
@@ -38,7 +38,7 @@ public class HelpStrategy
    public HelpStrategy(CodeToolsServerOperations server)
    {
       server_ = server;
-      cache_ = new HashMap<QualifiedName, ParsedInfo>();
+      cache_ = new HashMap<>();
    }
    
    public void showHelpTopic(final QualifiedName selectedItem)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HistoryCompletionManager.java
Patch:
@@ -262,8 +262,7 @@ public void onResponseReceived(RpcObjectList<HistoryEntry> resp)
 
          if (resp.length() == 0)
          {
-            popup_ = new CompletionListPopupPanel<HistoryMatch>(
-                  new HistoryMatch[0]);
+            popup_ = new CompletionListPopupPanel<>(new HistoryMatch[0]);
             popup_.setText("(No matching commands)");
             mode_ = PopupMode.PopupNoResults;
          }
@@ -272,7 +271,7 @@ public void onResponseReceived(RpcObjectList<HistoryEntry> resp)
             HistoryMatch[] entries = new HistoryMatch[resp.length()];
             for (int i = 0; i < entries.length; i++)
                entries[i] = new HistoryMatch(resp.get(entries.length - i - 1).getCommand(), text_, i);
-            popup_ = new CompletionListPopupPanel<HistoryMatch>(entries);
+            popup_ = new CompletionListPopupPanel<>(entries);
             mode_ = desiredMode_;
          }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/StanCompletionManager.java
Patch:
@@ -102,7 +102,7 @@ public boolean getCompletions(String line, CompletionRequestContext context)
    protected void addExtraCompletions(String token,
                                       List<QualifiedName> completions)
    {
-      Set<String> discoveredIdentifiers = new HashSet<String>();
+      Set<String> discoveredIdentifiers = new HashSet<>();
       
       Token cursorToken = docDisplay_.getTokenAt(docDisplay_.getCursorPosition());
       TokenIterator it = docDisplay_.createTokenIterator();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/events/SuppressNextShellFocusEvent.java
Patch:
@@ -70,6 +70,6 @@ protected void dispatch(Handler handler)
       handler.onSuppressNextShellFocus(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -496,7 +496,7 @@ private void cleanPreviewResources()
       {
          server_.previewDataImportClean(
                getOptions(),
-               new ErrorLoggingServerRequestCallback<Void>());
+               new ErrorLoggingServerRequestCallback<>());
       }
       
       localFiles_ = null;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportColumnTypesMenu.java
Patch:
@@ -82,9 +82,9 @@ public DataImportColumnTypesMenu()
       super(true);
       setWidget(uiBinder.createAndBindUi(this));
       
-      menuItemsMap_ = new HashMap<String, MenuItem>();
+      menuItemsMap_ = new HashMap<>();
       
-      menuItems_ = new ArrayList<MenuItem>();
+      menuItems_ = new ArrayList<>();
       menuItems_.add(new MenuItem("include", (Widget)include_));
       menuItems_.add(new MenuItem("skip", (Widget)skip_));
       menuItems_.add(new MenuItem("only", (Widget)only_));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/DebugSourceCompletedEvent.java
Patch:
@@ -28,8 +28,7 @@ public interface Handler extends EventHandler
       void onDebugSourceCompleted(DebugSourceCompletedEvent event);
    }
 
-   public static final GwtEvent.Type<DebugSourceCompletedEvent.Handler> TYPE =
-      new GwtEvent.Type<DebugSourceCompletedEvent.Handler>();
+   public static final GwtEvent.Type<DebugSourceCompletedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public DebugSourceCompletedEvent(DebugSourceResult result)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/EnvironmentObjectAssignedEvent.java
Patch:
@@ -28,8 +28,7 @@ public interface Handler extends EventHandler
       void onEnvironmentObjectAssigned(EnvironmentObjectAssignedEvent event);
    }
 
-   public static final GwtEvent.Type<EnvironmentObjectAssignedEvent.Handler> TYPE =
-      new GwtEvent.Type<EnvironmentObjectAssignedEvent.Handler>();
+   public static final GwtEvent.Type<EnvironmentObjectAssignedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public EnvironmentObjectAssignedEvent(RObject objectInfo)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/EnvironmentObjectRemovedEvent.java
Patch:
@@ -25,8 +25,7 @@ public interface Handler extends EventHandler
       void onEnvironmentObjectRemoved(EnvironmentObjectRemovedEvent event);
    }
 
-   public static final GwtEvent.Type<EnvironmentObjectRemovedEvent.Handler> TYPE =
-      new GwtEvent.Type<EnvironmentObjectRemovedEvent.Handler>();
+   public static final GwtEvent.Type<EnvironmentObjectRemovedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public EnvironmentObjectRemovedEvent(String objectName)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -124,7 +124,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
                                                          14, Style.Unit.PX);
       
       observer_ = observer;
-      callFrameItems_ = new ArrayList<CallFrameItem>();
+      callFrameItems_ = new ArrayList<>();
    }
 
    public void setCallFrames(JsArray<CallFrame> frameList, int contextDepth)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -86,7 +86,7 @@ public EnvironmentObjects(EnvironmentObjectsObserver observer)
       environmentName_ = EnvironmentPane.GLOBAL_ENVIRONMENT_NAME;
 
       objectDisplayType_ = OBJECT_LIST_VIEW;
-      objectDataProvider_ = new ListDataProvider<RObjectEntry>();
+      objectDataProvider_ = new ListDataProvider<>();
       objectSort_ = new RObjectEntrySort();
 
       // timer used to scroll table element into view
@@ -214,7 +214,7 @@ public void addObjects(JsArray<RObject> objects)
    {
       // create an entry for each object and sort the array
       int numObjects = objects.length();
-      ArrayList<RObjectEntry> objectEntryList = new ArrayList<RObjectEntry>();
+      ArrayList<RObjectEntry> objectEntryList = new ArrayList<>();
       for (int i = 0; i < numObjects; i++)
       {
          RObjectEntry entry = entryFromRObject(objects.get(i));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/RObjectEntry.java
Patch:
@@ -126,8 +126,8 @@ private boolean rObjectHasDataClass()
 
    public static final String NO_VALUE = "NO_VALUE";
    
-   private static final Set<String> DATA_CLASSES = new HashSet<String>();
-   private static final Set<String> HIERARCHICAL_CLASSES = new HashSet<String>();
+   private static final Set<String> DATA_CLASSES = new HashSet<>();
+   private static final Set<String> HIERARCHICAL_CLASSES = new HashSet<>();
    
    static {
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -39,7 +39,6 @@
 import org.rstudio.studio.client.common.filetypes.events.OpenFileInBrowserEvent;
 import org.rstudio.studio.client.common.filetypes.events.OpenFileInBrowserHandler;
 import org.rstudio.studio.client.common.filetypes.events.RenameSourceFileEvent;
-import org.rstudio.studio.client.common.rstudioapi.model.RStudioAPIServerOperations;
 import org.rstudio.studio.client.events.RStudioApiRequestEvent;
 import org.rstudio.studio.client.server.*;
 import org.rstudio.studio.client.workbench.WorkbenchContext;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesCopy.java
Patch:
@@ -40,8 +40,7 @@ public void execute(ArrayList<FileSystemItem> files,
                        Command completedCommand)
    {
       // copy list so we don't modify passed list
-      ArrayList<FileSystemItem> filesQueue = new ArrayList<FileSystemItem>(
-                                                               files);
+      ArrayList<FileSystemItem> filesQueue = new ArrayList<>(files);
       
       // begin copy sequence (this method keeps calling itself until
       // the queue of files is empty)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/events/DirectoryNavigateEvent.java
Patch:
@@ -36,8 +36,7 @@ public final native boolean getActivate() /*-{
       }-*/;      
    }
    
-   public static final GwtEvent.Type<DirectoryNavigateHandler> TYPE =
-      new GwtEvent.Type<DirectoryNavigateHandler>();
+   public static final GwtEvent.Type<DirectoryNavigateHandler> TYPE = new GwtEvent.Type<>();
    
    public DirectoryNavigateEvent(Data data)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/events/FileChangeEvent.java
Patch:
@@ -19,8 +19,7 @@
 
 public class FileChangeEvent extends GwtEvent<FileChangeHandler>
 {
-   public static final GwtEvent.Type<FileChangeHandler> TYPE =
-      new GwtEvent.Type<FileChangeHandler>();
+   public static final GwtEvent.Type<FileChangeHandler> TYPE = new GwtEvent.Type<>();
    
    public FileChangeEvent(FileChange fileChange)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/events/ShowFolderEvent.java
Patch:
@@ -19,8 +19,7 @@
 
 public class ShowFolderEvent extends GwtEvent<ShowFolderHandler>
 {
-   public static final Type<ShowFolderHandler> TYPE =
-         new Type<ShowFolderHandler>();
+   public static final Type<ShowFolderHandler> TYPE = new Type<>();
 
    public ShowFolderEvent(FileSystemItem path)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/ToolbarLinkMenu.java
Patch:
@@ -112,7 +112,7 @@ public void clearLinks()
    
    public ArrayList<Link> getLinks()
    {
-      return new ArrayList<Link>(links_);
+      return new ArrayList<>(links_);
    }
 
    public HandlerRegistration addSelectionHandler(
@@ -173,7 +173,7 @@ public void fireEvent(GwtEvent<?> event)
    private final ToolbarPopupMenu menu_;
    private final MenuItem[] pre_;
    private final MenuItem[] post_;
-   private final ArrayList<Link> links_ = new ArrayList<Link>();
+   private final ArrayList<Link> links_ = new ArrayList<>();
    private final int maxLinks_;
    private boolean top_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/model/VirtualHistory.java
Patch:
@@ -103,6 +103,6 @@ private void saveScrollPosition()
    }
    
    private final Frame frame_;
-   private List<Data> stack_ = new ArrayList<Data>();
+   private List<Data> stack_ = new ArrayList<>();
    private int pos_ = -1;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/search/HelpSearchOracle.java
Patch:
@@ -48,8 +48,7 @@ public void onResponseReceived(JsArrayString suggestions)
          {
             int maxCount = Math.min(suggestions.length(), request.getLimit());
 
-            ArrayList<SearchSuggestion> results =
-               new ArrayList<SearchSuggestion>();
+            ArrayList<SearchSuggestion> results = new ArrayList<>();
             for (int i = 0; i< maxCount; i++)
                results.add(new SearchSuggestion(suggestions.get(i)));
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/events/FetchCommandsEvent.java
Patch:
@@ -18,8 +18,7 @@
 
 public class FetchCommandsEvent extends GwtEvent<FetchCommandsHandler>
 {
-   public static final Type<FetchCommandsHandler> TYPE =
-         new Type<FetchCommandsHandler>();
+   public static final Type<FetchCommandsHandler> TYPE = new Type<>();
    
    @Override
    public Type<FetchCommandsHandler> getAssociatedType()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/events/HistoryEntriesAddedEvent.java
Patch:
@@ -20,8 +20,7 @@
 
 public class HistoryEntriesAddedEvent extends GwtEvent<HistoryEntriesAddedHandler>
 {
-   public static final GwtEvent.Type<HistoryEntriesAddedHandler> TYPE =
-      new GwtEvent.Type<HistoryEntriesAddedHandler>();
+   public static final GwtEvent.Type<HistoryEntriesAddedHandler> TYPE = new GwtEvent.Type<>();
    
    public HistoryEntriesAddedEvent(RpcObjectList<HistoryEntry> entries)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryPane.java
Patch:
@@ -575,7 +575,7 @@ public void requestSuggestions(Request request,
          {
             callback.onSuggestionsReady(
                   request,
-                  new Response(new ArrayList<Suggestion>()));
+                  new Response(new ArrayList<>()));
          }
       });
       searchWidget_.addKeyDownHandler(new KeyDownHandler()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/JobManager.java
Patch:
@@ -386,7 +386,7 @@ private void showJobLauncherDialog(FileSystemItem path, FileSystemItem workingDi
             code,
             spec ->
             {
-               server_.startJob(spec, new ErrorLoggingServerRequestCallback<String>());
+               server_.startJob(spec, new ErrorLoggingServerRequestCallback<>());
             }
       );
       
@@ -409,7 +409,7 @@ private void showJobLauncherDialog(FileSystemItem path)
                }
 
                // tell the server to start running this script
-               server_.startJob(spec, new ErrorLoggingServerRequestCallback<String>());
+               server_.startJob(spec, new ErrorLoggingServerRequestCallback<>());
             });
       
       dialog.showModal();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -14,7 +14,6 @@
  */
 package org.rstudio.studio.client.workbench.views.output.find;
 
-import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.dom.client.NativeEvent;
 import com.google.gwt.dom.client.TableRowElement;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/LintMarkers.java
Patch:
@@ -52,7 +52,7 @@ public LintMarkers(Document document,
                       JsArray<AceAnnotation> annotations)
    {
       document_ = document;
-      annotations_ = new ArrayList<AnchoredAceAnnotation>();
+      annotations_ = new ArrayList<>();
       annotations_.ensureCapacity(annotations.length());
       for (int i = 0; i < annotations.length(); i++)
          annotations_.set(i, new AnchoredAceAnnotation(annotations.get(i)));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/events/PackageStateChangedEvent.java
Patch:
@@ -21,8 +21,7 @@
 public class PackageStateChangedEvent extends
                               GwtEvent<PackageStateChangedHandler>
 {
-   public static final GwtEvent.Type<PackageStateChangedHandler> TYPE =
-      new GwtEvent.Type<PackageStateChangedHandler>();
+   public static final GwtEvent.Type<PackageStateChangedHandler> TYPE = new GwtEvent.Type<>();
    
    public PackageStateChangedEvent(PackageState newState)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/events/PackageStatusChangedEvent.java
Patch:
@@ -20,8 +20,7 @@
 public class PackageStatusChangedEvent 
                      extends GwtEvent<PackageStatusChangedHandler>
 {
-   public static final GwtEvent.Type<PackageStatusChangedHandler> TYPE =
-      new GwtEvent.Type<PackageStatusChangedHandler>();
+   public static final GwtEvent.Type<PackageStatusChangedHandler> TYPE = new GwtEvent.Type<>();
    
    public PackageStatusChangedEvent(PackageStatus packageStatus)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/CheckForUpdatesDialog.java
Patch:
@@ -98,8 +98,8 @@ public String getValue(PendingAction action)
       table.addColumn(availableColumn, "Available");
       table.setColumnWidth(availableColumn, 28, Unit.PCT);
 
-      ImageButtonColumn<PendingAction> newsColumn = 
-            new ImageButtonColumn<PendingAction>(
+      ImageButtonColumn<PendingAction> newsColumn =
+            new ImageButtonColumn<>(
                   new ImageResource2x(ThemeResources.INSTANCE.newsButton2x()),
                   new OperationWithInput<PendingAction>() {
                      

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/PackageActionConfirmationDialog.java
Patch:
@@ -77,7 +77,7 @@ public PackageActionConfirmationDialog(
    @Override
    protected ArrayList<T> collectInput()
    {
-      ArrayList<T> actions = new ArrayList<T>();
+      ArrayList<T> actions = new ArrayList<>();
       for (PendingAction action : actionsDataProvider_.getList())
       {
          if (action.getPerformAction().getBool())
@@ -219,7 +219,7 @@ public LabeledBoolean getPerformAction()
    private void setGlobalPerformAction(String label, Boolean performAction)
    {
       List<PendingAction> actions = actionsDataProvider_.getList();
-      ArrayList<PendingAction> newActions = new ArrayList<PendingAction>();
+      ArrayList<PendingAction> newActions = new ArrayList<>();
       for(PendingAction action : actions)
          newActions.add(new PendingAction(action.getActionInfo(), new LabeledBoolean(label, performAction)));
       actionsDataProvider_.setList(newActions);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/LocatorPanel.java
Patch:
@@ -180,7 +180,7 @@ private void showFeedbackAt(Point p)
          public void run()
          {
             feedbackTimer_ = null;
-            ArrayList<Widget> widgets = new ArrayList<Widget>();
+            ArrayList<Widget> widgets = new ArrayList<>();
             widgets.add(feedbackImage_);
             feedbackAnimation_ = new FadeOutAnimation(widgets,
                                                       new Command() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/Plots.java
Patch:
@@ -133,7 +133,7 @@ public void onSelection(SelectionEvent<Point> e)
 
             }
 
-            server.locatorCompleted(p, new SimpleRequestCallback<Void>());
+            server.locatorCompleted(p, new SimpleRequestCallback<>());
          }
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsPdfDialog.java
Patch:
@@ -529,7 +529,7 @@ else if (size > kMaximumSize)
       private ListBox paperSizeListBox_;
       private final TextBox widthTextBox_;
       private final TextBox heightTextBox_;
-      private final List<PaperSize> paperSizes_ = new ArrayList<PaperSize>(); 
+      private final List<PaperSize> paperSizes_ = new ArrayList<>(); 
       private final NumberFormat sizeFormat_ = NumberFormat.getFormat("##0.00");
       
       private final double kMimimumSize = 3.0;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -55,7 +55,6 @@
 import org.rstudio.studio.client.events.GetEditorContextEvent;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntryProvider;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntrySource;
-import org.rstudio.studio.client.palette.model.CommandPaletteItem;
 import org.rstudio.studio.client.rmarkdown.model.RmdChosenTemplate;
 import org.rstudio.studio.client.rmarkdown.model.RmdFrontMatter;
 import org.rstudio.studio.client.rmarkdown.model.RmdOutputFormat;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindow.java
Patch:
@@ -267,7 +267,7 @@ private void saveUnsavedDocuments(JsArrayString idArray, Command onCompleted)
       Set<String> ids = null;
       if (idArray != null)
       {
-         ids = new HashSet<String>();
+         ids = new HashSet<>();
          for (String id : JsUtil.asIterable(idArray))
             ids.add(id);
       }
@@ -279,8 +279,7 @@ private void handleUnsavedChangesBeforeExit(JavaScriptObject jsoItems,
          Command onCompleted)
    {
       JsArray<UnsavedChangesItem> items = jsoItems.cast();
-      ArrayList<UnsavedChangesTarget> targets = 
-            new ArrayList<UnsavedChangesTarget>();
+      ArrayList<UnsavedChangesTarget> targets = new ArrayList<>();
       for (int i = 0; i < items.length(); i++)
       {
          targets.add(items.get(i));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTargetInlineChunkExecution.java
Patch:
@@ -62,7 +62,7 @@ public EditingTargetInlineChunkExecution(DocDisplay display, String docId)
       
       display_ = display;
       docId_ = docId;
-      outputs_ = new HashMap<String, ChunkInlineOutput>();
+      outputs_ = new HashMap<>();
    }
    
    public void execute(Range range)
@@ -105,8 +105,7 @@ public void execute(Range range)
             display_.createAnchoredSelection(range.getStart(), range.getEnd()));
       
       // auto dismiss the panel when the cursor leaves the inline chunk
-      final Mutable<HandlerRegistration> cursorHandler =
-            new Mutable<HandlerRegistration>();
+      final Mutable<HandlerRegistration> cursorHandler = new Mutable<>();
       cursorHandler.set(display_.addCursorChangedHandler(
             new CursorChangedHandler()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTargetWidget.java
Patch:
@@ -53,7 +53,6 @@
 import org.rstudio.studio.client.common.filetypes.TextFileType;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.workbench.codesearch.model.SearchPathFunctionDefinition;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionManager;
@@ -176,7 +175,7 @@ public void goToHelp()
         
             server.getHelpAtCursor(
                linePos.getLine(), linePos.getPosition(),
-               new SimpleRequestCallback<Void>("Help")); 
+               new SimpleRequestCallback<>("Help")); 
          }
          
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTarget.java
Patch:
@@ -214,7 +214,7 @@ public void updateData(final DataItem data)
       
       final String oldCacheKey = getCacheKey();
 
-      HashMap<String, String> props = new HashMap<String, String>();
+      HashMap<String, String> props = new HashMap<>();
       data.fillProperties(props);
       server_.modifyDocumentProperties(
             doc_.getId(),
@@ -226,7 +226,7 @@ public void onResponseReceived(Void response)
                {
                   server_.removeCachedData(
                         oldCacheKey,
-                        new ErrorLoggingServerRequestCallback<Void>());
+                        new ErrorLoggingServerRequestCallback<>());
 
                   data.fillProperties(doc_.getProperties());
                   reloadDisplay();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1644,7 +1644,7 @@ public SpellingDoc getSpellingDoc()
    {
       // detach anchors on dispose
       ArrayList<org.rstudio.studio.client.workbench.views.source.editors.text.ace.Anchor> 
-        anchors = new ArrayList<org.rstudio.studio.client.workbench.views.source.editors.text.ace.Anchor>();
+        anchors = new ArrayList<>();
       
       return new SpellingDoc() {
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceKeyboardPreviewer.java
Patch:
@@ -115,5 +115,5 @@ private boolean onTextInput(JavaScriptObject data, String text)
       return false;
    }
    
-   private ArrayList<Handler> handlers_ = new ArrayList<Handler>();
+   private ArrayList<Handler> handlers_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputGallery.java
Patch:
@@ -73,7 +73,7 @@ public ChunkOutputGallery(
       ChunkOutputPresenter.Host host,
       ChunkOutputSize chunkOutputSize)
    {
-      pages_ = new ArrayList<ChunkOutputPage>();
+      pages_ = new ArrayList<>();
       host_ = host;
       chunkOutputSize_ = chunkOutputSize;
       initWidget(uiBinder.createAndBindUi(this));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -66,7 +66,7 @@ public ChunkOutputStream(ChunkOutputPresenter.Host host, ChunkOutputSize chunkOu
    {
       host_ = host;
       chunkOutputSize_ = chunkOutputSize;
-      metadata_ = new HashMap<Integer, JavaScriptObject>();
+      metadata_ = new HashMap<>();
 
       if (chunkOutputSize_ == ChunkOutputSize.Full) {
          getElement().getStyle().setWidth(100, Unit.PCT);
@@ -571,8 +571,8 @@ public List<ChunkOutputPage> extractPages()
       // flush any errors so they are properly accounted for
       flushQueuedErrors();
       
-      List<ChunkOutputPage> pages = new ArrayList<ChunkOutputPage>();
-      List<Widget> removed = new ArrayList<Widget>();
+      List<ChunkOutputPage> pages = new ArrayList<>();
+      List<Widget> removed = new ArrayList<>();
       for (Widget w: this)
       {
          // extract ordinal and metadata

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -114,7 +114,7 @@ public ChunkOutputWidget(String documentId, String chunkId,
       options_ = options;
       chunkOutputSize_ = chunkOutputSize;
       initWidget(uiBinder.createAndBindUi(this));
-      expansionState_ = new Value<Integer>(expansionState);
+      expansionState_ = new Value<>(expansionState);
       applyCachedEditorStyle();
       if (expansionState_.getValue() == COLLAPSED)
          setCollapsedStyles();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkSatelliteWindow.java
Patch:
@@ -43,7 +43,6 @@
 import org.rstudio.studio.client.server.QuietServerRequestCallback;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.workbench.ui.FontSizeManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.ChunkSatelliteCacheEditorStyleEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.ChunkSatelliteCodeExecutingEvent;
@@ -144,7 +143,7 @@ public void onWindowClosing(ClosingEvent arg0)
             server_.cleanReplayNotebookChunkPlots(
                chunkWindowParams_.getDocId(), 
                chunkWindowParams_.getChunkId(),
-               new QuietServerRequestCallback<Void>());
+               new QuietServerRequestCallback<>());
          }
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkWindowManager.java
Patch:
@@ -54,7 +54,7 @@ public ChunkWindowManager(
       pSatelliteManager_ = pSatelliteManager;
       events_ = events;
 
-      satelliteChunks_ = new ArrayList<Pair<String, String>>();
+      satelliteChunks_ = new ArrayList<>();
       
       if (!Satellite.isCurrentWindowSatellite())
       {
@@ -87,7 +87,7 @@ public void onChunkSatelliteOpenWindow(ChunkSatelliteOpenWindowEvent event)
    @Override
    public void onChunkSatelliteCloseAllWindow(ChunkSatelliteCloseAllWindowEvent event)
    {
-      ArrayList<Pair<String,String>> newSatelliteChunks = new ArrayList<Pair<String,String>>();
+      ArrayList<Pair<String,String>> newSatelliteChunks = new ArrayList<>();
 
       for (Pair<String, String> chunkPair : satelliteChunks_)
       {
@@ -117,7 +117,7 @@ public void onChunkSatelliteWindowOpened(ChunkSatelliteWindowOpenedEvent event)
       String docId = event.getDocId();
       String chunkId = event.getChunkId();
 
-      satelliteChunks_.add(new Pair<String, String>(docId, chunkId));
+      satelliteChunks_.add(new Pair<>(docId, chunkId));
       events_.fireEventToAllSatellites(event);
 
       ChunkSatelliteWindowRegisteredEvent registeredEvent = new ChunkSatelliteWindowRegisteredEvent(docId, chunkId);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/Fold.java
Patch:
@@ -60,7 +60,7 @@ public static String encode(ArrayList<Fold> folds)
 
    public static ArrayList<Fold> decode(String foldData)
    {
-      ArrayList<Fold> results = new ArrayList<Fold>();
+      ArrayList<Fold> results = new ArrayList<>();
       String[] chunks = foldData.split("\n");
       for (String chunk : chunks)
       {
@@ -95,7 +95,7 @@ public static JsArray<JsArrayMixed> toJs(ArrayList<Fold> folds)
 
    public static ArrayList<Fold> fromJs(JsArray<JsArrayMixed> folds)
    {
-      ArrayList<Fold> results = new ArrayList<Fold>();
+      ArrayList<Fold> results = new ArrayList<>();
       for (int i = 0; i < folds.length(); i++)
       {
          JsArrayMixed foldData = folds.get(i);
@@ -115,7 +115,7 @@ public static ArrayList<Fold> fromJs(JsArray<JsArrayMixed> folds)
     */
    public static ArrayList<Fold> flatten(JsArray<AceFold> folds)
    {
-      ArrayList<Fold> results = new ArrayList<Fold>();
+      ArrayList<Fold> results = new ArrayList<>();
       for (int i = 0; i < folds.length(); i++)
          collect(folds.get(i), results, Position.create(0, 0));
       return results;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ScopeList.java
Patch:
@@ -155,5 +155,5 @@ private void addScopes(JsArray<Scope> scopes)
       }
    }
 
-   private final ArrayList<Scope> scopes_ = new ArrayList<Scope>();
+   private final ArrayList<Scope> scopes_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -47,8 +47,8 @@ public class TextEditingTargetChunks
    public TextEditingTargetChunks(TextEditingTarget target)
    {
       target_ = target;
-      toolbars_ = new ArrayList<ChunkContextCodeUi>();
-      modifiedRanges_ = new ArrayList<Range>();
+      toolbars_ = new ArrayList<>();
+      modifiedRanges_ = new ArrayList<>();
       renderPass_ = 0;
       
       target.getDocDisplay().addScopeTreeReadyHandler(this);
@@ -210,7 +210,7 @@ private void syncAllWidgets()
    
    private void syncModifiedWidgets()
    {
-      Set<Scope> modifiedScopes = new HashSet<Scope>();
+      Set<Scope> modifiedScopes = new HashSet<>();
       
       for (Range range : modifiedRanges_)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCompilePdfHelper.java
Patch:
@@ -460,6 +460,5 @@ private String detectRootDirective(ArrayList<TexMagicComment> magicComments)
    private static final Pattern concordancePattern_ = Pattern.create(
                      "\\\\[\\s]*SweaveOpts[\\s]*{.*concordance[\\s]*=.*}");
    
-   private static HashMap<String, RnwChunkOptions> chunkOptionsCache_ = 
-                                    new HashMap<String, RnwChunkOptions>();
+   private static HashMap<String, RnwChunkOptions> chunkOptionsCache_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCppHelper.java
Patch:
@@ -19,7 +19,6 @@
 import org.rstudio.studio.client.common.filetypes.TextFileType;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTarget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionContext;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionOperation;
@@ -115,7 +114,7 @@ public void execute(String docPath, int line, int column)
                   docPath, 
                   line, 
                   column, 
-                  new CppCompletionServerRequestCallback<Void>(
+                  new CppCompletionServerRequestCallback<>(
                                           "Finding usages..."));
          }
          

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetIdleMonitor.java
Patch:
@@ -63,7 +63,7 @@ public TextEditingTargetIdleMonitor(final TextEditingTarget editingTarget,
       
       display_ = editingTarget.getDocDisplay();
       sentinel_ = sentinel;
-      monitors_ = new ArrayList<HandlerRegistration>();
+      monitors_ = new ArrayList<>();
       commands_ = target.commands;
       timer_ = new Timer()
       {
@@ -231,7 +231,7 @@ public IdleTarget(TextEditingTarget t, DocUpdateSentinel s)
       {
          target = t;
          sentinel = s;
-         commands = new HashMap<HandlerRegistration, IdleCommand>();
+         commands = new HashMap<>();
       }
       public final TextEditingTarget target;
       public final DocUpdateSentinel sentinel;
@@ -279,7 +279,7 @@ public void onPreviewNativeEvent(NativePreviewEvent preview)
          }
       });
 
-       TARGET_MAP = new SafeMap<DocDisplay, IdleTarget>();
+       TARGET_MAP = new SafeMap<>();
    }
    
    private static final int DELAY_MS = 700;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -1091,7 +1091,7 @@ public void showRequiredPackagesMissingWarning(List<String> packages)
 
       Command onInstall = () -> {
          // Form a list of all the dependencies to install
-         ArrayList<Dependency> deps = new ArrayList<Dependency>();
+         ArrayList<Dependency> deps = new ArrayList<>();
          for (String pkg: packages)
             deps.add(Dependency.cranPackage(pkg));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditorContainer.java
Patch:
@@ -176,5 +176,5 @@ private void addWidget(IsHideableWidget widget, boolean visible)
    }
   
    private final Editor editor_;
-   private ArrayList<IsHideableWidget> widgets_ = new ArrayList<IsHideableWidget>();
+   private ArrayList<IsHideableWidget> widgets_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceBackgroundHighlighter.java
Patch:
@@ -161,7 +161,7 @@ public AceBackgroundHighlighter(AceEditor editor)
       editor_ = editor;
       session_ = editor.getSession();
       
-      highlightPatterns_ = new ArrayList<HighlightPattern>();
+      highlightPatterns_ = new ArrayList<>();
       editor.addEditorModeChangedHandler(this);
       
       int n = editor.getRowCount();
@@ -455,7 +455,7 @@ private static final List<HighlightPattern> rMarkdownHighlightPatterns()
    // Static Members ----
    
    static {
-      HIGHLIGHT_PATTERN_REGISTRY = new HashMap<String, List<HighlightPattern>>();
+      HIGHLIGHT_PATTERN_REGISTRY = new HashMap<>();
       HIGHLIGHT_PATTERN_REGISTRY.put("mode/rmarkdown", rMarkdownHighlightPatterns());
       HIGHLIGHT_PATTERN_REGISTRY.put("mode/c_cpp", cStyleHighlightPatterns());
       HIGHLIGHT_PATTERN_REGISTRY.put("mode/sweave", sweaveHighlightPatterns());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -184,7 +184,7 @@ public native final <T> void onGutterMouseDown(CommandWithArg<T> command) /*-{
 
    public final HandlerRegistration delegateEventsTo(HasHandlers handlers)
    {
-      final LinkedList<JavaScriptObject> handles = new LinkedList<JavaScriptObject>();
+      final LinkedList<JavaScriptObject> handles = new LinkedList<>();
       handles.add(addDomListener(getTextInputElement(), "keydown", handlers));
       handles.add(addDomListener(getTextInputElement(), "keypress", handlers));
       handles.add(addDomListener(getTextInputElement(), "changeScrollTop", handlers));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/Tokenizer.java
Patch:
@@ -157,6 +157,6 @@ private final native Token[] doTokenize(String line) /*-{
    
    public final List<Token> tokenize(String line)
    {
-      return new ArrayList<Token>(Arrays.asList(doTokenize(line)));
+      return new ArrayList<>(Arrays.asList(doTokenize(line)));
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/assist/RChunkHeaderParser.java
Patch:
@@ -28,18 +28,18 @@ public class RChunkHeaderParser
 {
    public static Map<String, String> parse(String line)
    {
-      Map<String, String> options = new HashMap<String, String>();
+      Map<String, String> options = new HashMap<>();
       parse(line, options);
       return options;
    }
    
    public static final void parse(String line, Map<String, String> options)
    {
       // set up state
-      Mutable<String> key = new Mutable<String>();
+      Mutable<String> key = new Mutable<>();
       Consumer keyConsumer = new MutableConsumer(key);
       
-      Mutable<String> val = new Mutable<String>();
+      Mutable<String> val = new Mutable<>();
       Consumer valConsumer = new MutableConsumer(val);
       
       // determine an appropriate pattern for extracting options from

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/CursorChangedEvent.java
Patch:
@@ -19,7 +19,7 @@
 
 public class CursorChangedEvent extends GwtEvent<CursorChangedHandler>
 {
-   public static final Type<CursorChangedHandler> TYPE = new Type<CursorChangedHandler>();
+   public static final Type<CursorChangedHandler> TYPE = new Type<>();
 
    public CursorChangedEvent(Position position)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/EditorLoadedEvent.java
Patch:
@@ -32,7 +32,7 @@ public AceEditorNative getEditor()
    
    private final AceEditorNative editor_;
    
-   public static final Type<EditorLoadedHandler> TYPE = new Type<EditorLoadedHandler>();
+   public static final Type<EditorLoadedHandler> TYPE = new Type<>();
 
    @Override
    public Type<EditorLoadedHandler> getAssociatedType()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/FileTypeChangedEvent.java
Patch:
@@ -18,8 +18,7 @@
 
 public class FileTypeChangedEvent extends GwtEvent<FileTypeChangedHandler>
 {
-   public static final Type<FileTypeChangedHandler> TYPE =
-         new Type<FileTypeChangedHandler>();
+   public static final Type<FileTypeChangedHandler> TYPE = new Type<>();
 
    public FileTypeChangedEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/SourceOnSaveChangedEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class SourceOnSaveChangedEvent extends GwtEvent<SourceOnSaveChangedHandler>
 {
-   public static final Type<SourceOnSaveChangedHandler> TYPE = new Type<SourceOnSaveChangedHandler>();
+   public static final Type<SourceOnSaveChangedHandler> TYPE = new Type<>();
 
    @Override
    public Type<SourceOnSaveChangedHandler> getAssociatedType()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/UndoRedoEvent.java
Patch:
@@ -40,6 +40,6 @@ protected void dispatch(UndoRedoHandler handler)
       handler.onUndoRedo(this);
    }
 
-   public static Type<UndoRedoHandler> TYPE = new Type<UndoRedoHandler>();
+   public static Type<UndoRedoHandler> TYPE = new Type<>();
    private final boolean redo_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/NotebookQueueState.java
Patch:
@@ -186,7 +186,7 @@ else if (chunk.getRange() != null)
       }
       else
       {
-         List<ChunkExecUnit> chunks = new ArrayList<ChunkExecUnit>();
+         List<ChunkExecUnit> chunks = new ArrayList<>();
          chunks.add(chunk);
          executeChunks("Run Chunk", chunks);
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/SetupChunkOptionsPopupPanel.java
Patch:
@@ -229,7 +229,7 @@ public void onResponseReceived(JsObject object)
    protected void synchronize()
    {
       syncSelection();
-      Map<String, String> options = new LinkedHashMap<String, String>();
+      Map<String, String> options = new LinkedHashMap<>();
       
       Set<String> keys = chunkOptions_.keySet();
       for (String key : keys)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/spelling/CheckSpelling.java
Patch:
@@ -172,8 +172,8 @@ private void findNextMisspelling()
                currentPos_,
                wrapped_ ? initialCursorPos_.getPosition() : -1);
 
-         final ArrayList<String> words = new ArrayList<String>();
-         final ArrayList<SpellingDoc.WordRange> checkWords = new ArrayList<SpellingDoc.WordRange>();
+         final ArrayList<String> words = new ArrayList<>();
+         final ArrayList<SpellingDoc.WordRange> checkWords = new ArrayList<>();
 
          SpellingDoc.WordRange lastWord = null;
          for (SpellingDoc.WordRange w : wordSource)

File: src/gwt/src/com/google/gwt/widgetideas/client/ResizableWidgetCollection.java
Patch:
@@ -135,7 +135,7 @@ public void run() {
   /**
    * A hash map of the resizable widgets this collection is checking.
    */
-  private Map<ResizableWidget, ResizableWidgetInfo> widgets = new HashMap<ResizableWidget, ResizableWidgetInfo>();
+  private Map<ResizableWidget, ResizableWidgetInfo> widgets = new HashMap<>();
 
   /**
    * The current window height.

File: src/gwt/src/com/google/gwt/widgetideas/client/SliderBar.java
Patch:
@@ -195,7 +195,7 @@ public static interface SliderBarImages extends ImageBundle {
   /**
    * The elements used to display labels above the ticks.
    */
-  private List<Element> labelElements = new ArrayList<Element>();
+  private List<Element> labelElements = new ArrayList<>();
 
   /**
    * The formatter used to generate label text.
@@ -263,7 +263,7 @@ public static interface SliderBarImages extends ImageBundle {
    * The elements used to display tick marks, which are the vertical lines along
    * the slider bar.
    */
-  private List<Element> tickElements = new ArrayList<Element>();
+  private List<Element> tickElements = new ArrayList<>();
 
   /**
    * Create a slider bar.

File: src/gwt/src/com/sksamuel/gwt/websockets/Websocket.java
Patch:
@@ -33,7 +33,7 @@ public static boolean isSupported() {
         return _isWebsocket();
     }
 
-    private final Set<WebsocketListener> listeners = new HashSet<WebsocketListener>();
+    private final Set<WebsocketListener> listeners = new HashSet<>();
 
     private final String varName;
     private final String url;
@@ -119,4 +119,4 @@ public void send(byte[] bytes) {
         String base64 = Base64Utils.toBase64(bytes);
         send(base64);
     }
-}
+}

File: src/gwt/src/org/rstudio/core/client/CsvReader.java
Patch:
@@ -37,7 +37,7 @@ public boolean hasNext()
 
          public String[] next()
          {
-            ArrayList<String> list = new ArrayList<String>();
+            ArrayList<String> list = new ArrayList<>();
             StringBuilder chunk = new StringBuilder();
 
             final int START = 0;

File: src/gwt/src/org/rstudio/core/client/ExternalJavaScriptLoader.java
Patch:
@@ -39,8 +39,7 @@ private enum State
 
    public static void loadSequentially(String[] urls, final Callback callback)
    {
-      final LinkedList<ExternalJavaScriptLoader> loaders =
-            new LinkedList<ExternalJavaScriptLoader>();
+      final LinkedList<ExternalJavaScriptLoader> loaders = new LinkedList<>();
 
       for (String url : urls)
          loaders.add(new ExternalJavaScriptLoader(url));
@@ -131,7 +130,7 @@ public boolean execute()
       });
    }
 
-   private LinkedList<Callback> callbacks_ = new LinkedList<Callback>();
+   private LinkedList<Callback> callbacks_ = new LinkedList<>();
    private State state_ = State.Start;
    private final String url_;
    private final Document document_;

File: src/gwt/src/org/rstudio/core/client/ExternalStyleSheetLoader.java
Patch:
@@ -105,7 +105,7 @@ public boolean execute()
       });
    }
 
-   private LinkedList<Callback> callbacks_ = new LinkedList<Callback>();
+   private LinkedList<Callback> callbacks_ = new LinkedList<>();
    private State state_ = State.Start;
    private final String url_;
    private final Document document_;

File: src/gwt/src/org/rstudio/core/client/HtmlMessageListener.java
Patch:
@@ -44,7 +44,7 @@ public HtmlMessageListener(FileTypeRegistry fileTypeRegistry,
       htmlMessageListener_ = this;
       fileTypeRegistry_ = fileTypeRegistry;
       pUserPrefs_ = pUIPrefs;
-      themeSources_ = new ArrayList<JavaScriptObject>();
+      themeSources_ = new ArrayList<>();
       
       initializeMessageListeners();
 

File: src/gwt/src/org/rstudio/core/client/JsArrayUtil.java
Patch:
@@ -58,7 +58,7 @@ public static <T extends JavaScriptObject> void fillList(JsArray<T> jsArray,
    public static <T extends JavaScriptObject> ArrayList<T> toArrayList(
          JsArray<T> jsArray)
    {
-      ArrayList<T> list = new ArrayList<T>();
+      ArrayList<T> list = new ArrayList<>();
       fillList(jsArray, list);
       return list;
    }
@@ -86,7 +86,7 @@ public static JsArrayString toJsArrayString(List<String> in)
    
    public static ArrayList<String> fromJsArrayString(JsArrayString in)
    {
-      ArrayList<String> out = new ArrayList<String>();
+      ArrayList<String> out = new ArrayList<>();
       for (int i = 0; i < in.length(); i++)
       {
          out.add(in.get(i));

File: src/gwt/src/org/rstudio/core/client/PreemptiveTaskQueue.java
Patch:
@@ -141,7 +141,7 @@ private void log(String label)
    }
    
    
-   private Queue<Task> taskQueue_ = new LinkedList<Task>();
+   private Queue<Task> taskQueue_ = new LinkedList<>();
    private boolean processing_ = false;
    private final boolean log_;
    private final boolean safe_;

File: src/gwt/src/org/rstudio/core/client/Rendezvous.java
Patch:
@@ -41,7 +41,7 @@ public class Rendezvous
    public Rendezvous(int count)
    {
       this.remainingArrivals = count;
-      this.joined = new ArrayList<Command>();
+      this.joined = new ArrayList<>();
    }
 
    /**

File: src/gwt/src/org/rstudio/core/client/SafeHtmlUtil.java
Patch:
@@ -198,7 +198,7 @@ public SearchMatch(int indexIn, int lengthIn)
       
       // Store matches in a tree set ordered by the index at which the match was
       // found.
-      Set<SearchMatch> matches = new TreeSet<SearchMatch>(
+      Set<SearchMatch> matches = new TreeSet<>(
             (SearchMatch o1, SearchMatch o2) -> {
                   return o1.index.compareTo(o2.index);
             });

File: src/gwt/src/org/rstudio/core/client/cellview/TriStateCheckboxCell.java
Patch:
@@ -51,7 +51,7 @@ interface Resources extends ClientBundle
    public TriStateCheckboxCell(SelectionModel<TKey> selectionModel)
    {
       selectionModel_ = selectionModel;
-      consumedEvents_ = new HashSet<String>();
+      consumedEvents_ = new HashSet<>();
       consumedEvents_.add("click");
       consumedEvents_.add("keydown");
       consumedEvents_.add("mouseover");

File: src/gwt/src/org/rstudio/core/client/command/ApplicationCommandManager.java
Patch:
@@ -42,7 +42,7 @@ public ApplicationCommandManager()
    {
       RStudioGinjector.INSTANCE.injectMembers(this);
 
-      bindings_ = new ConfigFileBacked<EditorKeyBindings>(
+      bindings_ = new ConfigFileBacked<>(
             server_,
             KEYBINDINGS_PATH,
             false,
@@ -145,15 +145,15 @@ private void loadBindings(EditorKeyBindings bindings,
                              final CommandWithArg<EditorKeyBindings> afterLoad)
    {
       List<Pair<List<KeySequence>, AppCommand>> resolvedBindings;
-      resolvedBindings = new ArrayList<Pair<List<KeySequence>, AppCommand>>();
+      resolvedBindings = new ArrayList<>();
 
       for (String id : bindings.iterableKeys())
       {
          AppCommand command = commands_.getCommandById(id);
          if (command == null)
             continue;
          List<KeySequence> keys = bindings.get(id).getKeyBindings();
-         resolvedBindings.add(new Pair<List<KeySequence>, AppCommand>(keys, command));
+         resolvedBindings.add(new Pair<>(keys, command));
       }
 
       KeyMap map = ShortcutManager.INSTANCE.getKeyMap(KeyMapType.APPLICATION);

File: src/gwt/src/org/rstudio/core/client/command/CommandBundle.java
Patch:
@@ -39,6 +39,5 @@ public HashMap<String, AppCommand> getCommands()
       return commandsById_;
    }
 
-   private final HashMap<String, AppCommand> commandsById_ =
-         new HashMap<String, AppCommand>();
+   private final HashMap<String, AppCommand> commandsById_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/core/client/command/CommandEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class CommandEvent extends GwtEvent<CommandHandler>
 {
-   public static final Type<CommandHandler> TYPE = new Type<CommandHandler>();
+   public static final Type<CommandHandler> TYPE = new Type<>();
 
    public CommandEvent(AppCommand command)
    {

File: src/gwt/src/org/rstudio/core/client/command/EnabledChangedEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class EnabledChangedEvent extends GwtEvent<EnabledChangedHandler>
 {
-   public static final Type<EnabledChangedHandler> TYPE = new Type<EnabledChangedHandler>();
+   public static final Type<EnabledChangedHandler> TYPE = new Type<>();
 
    public EnabledChangedEvent(AppCommand command)
    {

File: src/gwt/src/org/rstudio/core/client/command/KeySequence.java
Patch:
@@ -25,12 +25,12 @@ public class KeySequence
 {
    public KeySequence()
    {
-      keyCombinations_ = new ArrayList<KeyCombination>();
+      keyCombinations_ = new ArrayList<>();
    }
 
    public KeySequence(List<KeyCombination> keyList)
    {
-      keyCombinations_ = new ArrayList<KeyCombination>(keyList);
+      keyCombinations_ = new ArrayList<>(keyList);
    }
 
    public static KeySequence fromShortcutString(String shortcut)

File: src/gwt/src/org/rstudio/core/client/command/ShortcutInfo.java
Patch:
@@ -22,7 +22,7 @@ public class ShortcutInfo
 {
    public ShortcutInfo (KeyboardShortcut shortcut, AppCommand command)
    {
-      shortcuts_ = new ArrayList<String>();
+      shortcuts_ = new ArrayList<>();
       description_ = shortcut.getTitle().length() > 0 ?
                         shortcut.getTitle() :
                         command != null ?

File: src/gwt/src/org/rstudio/core/client/command/SubMenuVisibleChangedEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class SubMenuVisibleChangedEvent extends GwtEvent<SubMenuVisibleChangedHandler>
 {
-   public static final Type<SubMenuVisibleChangedHandler> TYPE = new Type<SubMenuVisibleChangedHandler>();
+   public static final Type<SubMenuVisibleChangedHandler> TYPE = new Type<>();
    @Override
    public Type<SubMenuVisibleChangedHandler> getAssociatedType()
    {

File: src/gwt/src/org/rstudio/core/client/command/UserCommandManager.java
Patch:
@@ -35,7 +35,7 @@ public UserCommand(String name, Command command)
    public UserCommandManager()
    {
       RStudioGinjector.INSTANCE.injectMembers(this);
-      commandMap_ = new HashMap<KeyboardShortcut, UserCommand>();
+      commandMap_ = new HashMap<>();
 
       events_.addHandler(
             RegisterUserCommandEvent.TYPE,

File: src/gwt/src/org/rstudio/core/client/command/VisibleChangedEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class VisibleChangedEvent extends GwtEvent<VisibleChangedHandler>
 {
-   public static final Type<VisibleChangedHandler> TYPE = new Type<VisibleChangedHandler>();
+   public static final Type<VisibleChangedHandler> TYPE = new Type<>();
 
    public VisibleChangedEvent(AppCommand command)
    {

File: src/gwt/src/org/rstudio/core/client/command/impl/WebMenuCallback.java
Patch:
@@ -104,6 +104,6 @@ private AppMenuBar head()
       return menuStack_.peek();
    }
 
-   private final Stack<AppMenuBar> menuStack_ = new Stack<AppMenuBar>();
+   private final Stack<AppMenuBar> menuStack_ = new Stack<>();
    private AppMenuBar result_;
 }

File: src/gwt/src/org/rstudio/core/client/container/SafeMap.java
Patch:
@@ -25,7 +25,7 @@ public class SafeMap<K, V>
 {
    public SafeMap()
    {
-      data_ = new HashMap<K, V>();
+      data_ = new HashMap<>();
    }
 
    public V get(K key)

File: src/gwt/src/org/rstudio/core/client/dom/DomUtils.java
Patch:
@@ -697,7 +697,7 @@ public static List<Node> findNodes(Node start,
                                       boolean siblings,
                                       NodePredicate filter)
    {
-      List<Node> results = new ArrayList<Node>();
+      List<Node> results = new ArrayList<>();
       int remaining = 0;
 
       if (start == null)

File: src/gwt/src/org/rstudio/core/client/events/SelectionCommitEvent.java
Patch:
@@ -25,7 +25,7 @@ public static <I> void fire(HasSelectionCommitHandlers<I> source, I selectedItem
    {
      if (TYPE != null)
      {
-       SelectionCommitEvent<I> event = new SelectionCommitEvent<I>(selectedItem);
+       SelectionCommitEvent<I> event = new SelectionCommitEvent<>(selectedItem);
        source.fireEvent(event);
      }
    }

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -343,8 +343,7 @@ public final native boolean focusOnNavigate() /*-{
    }-*/;
 
    // NOTE: should be synced with mime type database in FilePath.cpp
-   private final static HashMap<String,String> MIME_TYPES =
-                                             new HashMap<String,String>();
+   private final static HashMap<String,String> MIME_TYPES = new HashMap<>();
    static
    {
       MIME_TYPES.put( "htm",   "text/html" );

File: src/gwt/src/org/rstudio/core/client/files/PosixFileSystemContext.java
Patch:
@@ -51,7 +51,7 @@ public String combine(String root, String name)
 
    public FileSystemItem[] parseDir(String dirPath)
    {
-      ArrayList<FileSystemItem> results = new ArrayList<FileSystemItem>();
+      ArrayList<FileSystemItem> results = new ArrayList<>();
 
       if (dirPath.startsWith("/"))
          results.add(FileSystemItem.createDir("/"));

File: src/gwt/src/org/rstudio/core/client/files/filedialog/ChooseFolderDialog2.java
Patch:
@@ -53,7 +53,7 @@ public Widget createMainWidget()
    public FileSystemItem[] ls()
    {
       FileSystemItem[] items = super.ls();
-      ArrayList<FileSystemItem> dirs = new ArrayList<FileSystemItem>();
+      ArrayList<FileSystemItem> dirs = new ArrayList<>();
       for (FileSystemItem item : items)
          if (item.isDirectory())
             dirs.add(item);

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileSystemDialog.java
Patch:
@@ -325,7 +325,7 @@ private static FileSystemItem[] listFilesWithExtensions(
       if (items == null)
          return new FileSystemItem[0];
 
-      ArrayList<FileSystemItem> filtered = new ArrayList<FileSystemItem>();
+      ArrayList<FileSystemItem> filtered = new ArrayList<>();
       for (int i = 0; i < items.length; i++)
       {
          if (items[i].isDirectory())

File: src/gwt/src/org/rstudio/core/client/html/HTMLAttributesParser.java
Patch:
@@ -63,9 +63,9 @@ private static class Parser
       public Parser(String attributes)
       {
          attributes_ = StringUtil.notNull(attributes).trim();
-         map_ = new HashMap<String, String>();
+         map_ = new HashMap<>();
          identifier_ = "";
-         classes_ = new ArrayList<String>();
+         classes_ = new ArrayList<>();
          
          index_ = 0;
          n_ = attributes.length();

File: src/gwt/src/org/rstudio/core/client/js/JsUtil.java
Patch:
@@ -230,7 +230,7 @@ public native static String getObjectType(JavaScriptObject obj) /*-{
    
    public static List<String> toList(JsArrayString array)
    {
-      List<String> list = new ArrayList<String>();
+      List<String> list = new ArrayList<>();
       for (int i = 0, n = array.length(); i < n; i++)
          list.add(array.get(i));
       return list;

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RequestLog.java
Patch:
@@ -45,8 +45,7 @@ public static RequestLogEntry[] getEntries()
       return entries;
    }
 
-   private static final ArrayList<RequestLogEntry> entries_ =
-         new ArrayList<RequestLogEntry>();
+   private static final ArrayList<RequestLogEntry> entries_ = new ArrayList<>();
 
    private static final int MAX_ENTRIES = 50;
 }

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcObjectList.java
Patch:
@@ -42,7 +42,7 @@ public final native T get(int index) /*-{
 
    public final ArrayList<T> toArrayList()
    {
-      ArrayList<T> result = new ArrayList<T>(length());
+      ArrayList<T> result = new ArrayList<>(length());
       for (int i = 0; i < length(); i++)
          result.add(get(i));
       return result;

File: src/gwt/src/org/rstudio/core/client/layout/FadeOutAnimation.java
Patch:
@@ -26,7 +26,7 @@ public class FadeOutAnimation extends Animation
 {
    public FadeOutAnimation(Widget widget, Command callback)
    {
-      List<Widget> widgets = new ArrayList<Widget>();
+      List<Widget> widgets = new ArrayList<>();
       widgets.add(widget);
       widgets_ = widgets;
       callback_ = callback;

File: src/gwt/src/org/rstudio/core/client/patch/SubstringDiff.java
Patch:
@@ -47,7 +47,7 @@ public SubstringDiff(String origVal, String newVal)
    
    public TextChange[] asTextChanges() 
    {
-      ArrayList<TextChange> changes = new ArrayList<TextChange>();
+      ArrayList<TextChange> changes = new ArrayList<>();
       if (valid_)
       {
          if (offset_ > 0)

File: src/gwt/src/org/rstudio/core/client/tex/TexMagicComment.java
Patch:
@@ -24,7 +24,7 @@ public class TexMagicComment
 {
    public static ArrayList<TexMagicComment> parseComments(String code)
    {
-      ArrayList<TexMagicComment> comments = new ArrayList<TexMagicComment>();
+      ArrayList<TexMagicComment> comments = new ArrayList<>();
       
       Iterable<String> lines = StringUtil.getLineIterator(code);
       

File: src/gwt/src/org/rstudio/core/client/widget/AutocompleteSuggestionDisplay.java
Patch:
@@ -35,7 +35,7 @@ public interface ShowSuggestionsHandler
    
    public AutocompleteSuggestionDisplay()
    {
-      showHandlers_ = new ArrayList<ShowSuggestionsHandler>();
+      showHandlers_ = new ArrayList<>();
       PopupPanel panel = getPopupPanel();
       if (panel != null)
       {

File: src/gwt/src/org/rstudio/core/client/widget/DocPropMenuItem.java
Patch:
@@ -72,7 +72,7 @@ public boolean isChecked()
    @Override
    public void onInvoked()
    {
-      HashMap<String, String> props = new HashMap<String, String>();
+      HashMap<String, String> props = new HashMap<>();
       String target = targetValue_;
       
       // toggle behavior for boolean values: if our target was true but the

File: src/gwt/src/org/rstudio/core/client/widget/LocalRepositoriesWidget.java
Patch:
@@ -80,7 +80,7 @@ public void addItem(String item)
    }
    
    public ArrayList<String> getItems() {
-      ArrayList<String> items = new ArrayList<String>();
+      ArrayList<String> items = new ArrayList<>();
       int numItems = listBox_.getItemCount();
       for (int i = 0; i < numItems; ++i) {
          items.add(listBox_.getItemText(i));

File: src/gwt/src/org/rstudio/core/client/widget/MultipleItemSuggestTextBox.java
Patch:
@@ -36,7 +36,7 @@ public MultipleItemSuggestTextBox()
    
    public List<String> getItems()
    {
-      ArrayList<String> items = new ArrayList<String>();
+      ArrayList<String> items = new ArrayList<>();
       String text = super.getText();
       if (!StringUtil.isNullOrEmpty(text))
       {

File: src/gwt/src/org/rstudio/core/client/widget/WidgetListBox.java
Patch:
@@ -328,8 +328,8 @@ else if (emptyTextBox_.getParent() != this && items_.size() == 0)
    private VerticalPanel panel_;
    private VerticalPanel emptyTextBox_;
    private Label emptyTextLabel_;
-   private List<HTMLPanel> options_ = new ArrayList<HTMLPanel>();
-   private List<T> items_ = new ArrayList<T>();
+   private List<HTMLPanel> options_ = new ArrayList<>();
+   private List<T> items_ = new ArrayList<>();
 
    private Resources resources_;
    private ListStyle style_;

File: src/gwt/src/org/rstudio/core/client/widget/Wizard.java
Patch:
@@ -497,7 +497,7 @@ protected String getMainWidgetStyle()
     
    protected ArrayList<String> getWizardBodyStyles()
    {
-      ArrayList<String> classes = new ArrayList<String>();
+      ArrayList<String> classes = new ArrayList<>();
       classes.add(WizardResources.INSTANCE.styles().wizardBodyPanel());
       return classes;
    }

File: src/gwt/src/org/rstudio/core/client/widget/WizardIntermediatePage.java
Patch:
@@ -53,7 +53,7 @@ public ArrayList<WizardPage<I, T>> getSubPages()
    {
       // we have a single subpage, which is the next page we were initialized
       // with
-      ArrayList<WizardPage<I, T>> subPage = new ArrayList<WizardPage<I, T>>();
+      ArrayList<WizardPage<I, T>> subPage = new ArrayList<>();
       subPage.add(nextPage_);
       return subPage;
    }

File: src/gwt/src/org/rstudio/core/client/widget/WizardNavigationPage.java
Patch:
@@ -40,7 +40,7 @@ public WizardNavigationPage(String title,
            image,
            largeImage,
            pages,
-           pages1 -> new WizardPageSelector<I, T>(pages1));
+           pages1 -> new WizardPageSelector<>(pages1));
    }
 
    public WizardNavigationPage(String title,

File: src/gwt/src/org/rstudio/core/rebind/JavaScriptSerializerGenerator.java
Patch:
@@ -40,7 +40,7 @@ public String generate (TreeLogger logger, GeneratorContext context,
                             String typeName) throws UnableToCompleteException
     {
        TypeOracle oracle = context.getTypeOracle();
-       List<JClassType> classes = new ArrayList<JClassType>();
+       List<JClassType> classes = new ArrayList<>();
        
        // locate all the types annotated with JavaScriptSerializable
        for (JClassType classType : oracle.getTypes())

File: src/gwt/src/org/rstudio/core/rebind/command/ShortcutsEmitter.java
Patch:
@@ -92,7 +92,7 @@ public void generate(SourceWriter writer) throws UnableToCompleteException
    
    private static List<String> preprocessShortcutValue(String shortcutValue)
    {
-      List<String> shortcuts = new ArrayList<String>();
+      List<String> shortcuts = new ArrayList<>();
       
       for (String keySequence : shortcutValue.split("\\|"))
       {
@@ -118,7 +118,7 @@ private void printShortcut(SourceWriter writer,
                               String title,
                               String disableModes) throws UnableToCompleteException
    {
-      List<ShortcutKeyCombination> keys = new ArrayList<ShortcutKeyCombination>();
+      List<ShortcutKeyCombination> keys = new ArrayList<>();
       
       for (String keyCombination : shortcut.split("\\s+"))
       {

File: src/gwt/src/org/rstudio/studio/client/JavaScriptEventHistory.java
Patch:
@@ -62,7 +62,7 @@ public interface Predicate
    
    public JavaScriptEventHistory()
    {
-      queue_ = new LinkedList<EventData>();
+      queue_ = new LinkedList<>();
       registerEventListeners();
    }
    

File: src/gwt/src/org/rstudio/studio/client/ResizableHeader.java
Patch:
@@ -86,15 +86,15 @@ public void render(Context context,
    
    public ResizableHeader(AbstractCellTable<?> table, String text)
    {
-      super(new ResizableHeaderCell<String>(table));
+      super(new ResizableHeaderCell<>(table));
       
       table_ = table;
       text_ = text;
       index_ = table.getColumnCount();
       
       MouseDragHandler.addHandler(table_, new MouseDragHandler()
       {
-         List<Integer> columnWidths_ = new ArrayList<Integer>();
+         List<Integer> columnWidths_ = new ArrayList<>();
          
          @Override
          public boolean beginDrag(MouseDownEvent event)

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -304,8 +304,7 @@ public void execute()
       // multiple save targets
       else
       {
-         ArrayList<UnsavedChangesTarget> unsaved = 
-                                      new ArrayList<UnsavedChangesTarget>();
+         ArrayList<UnsavedChangesTarget> unsaved = new ArrayList<>();
          if (saveAction == SaveAction.SAVEASK && globalEnvTarget != null)
             unsaved.add(globalEnvTarget);
          unsaved.addAll(unsavedSourceDocs);

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationUtils.java
Patch:
@@ -85,7 +85,7 @@ public static String getRemainingQueryString(List<String> removeKeys)
    
    public static void removeQueryParam(String param)
    {
-      ArrayList<String> params = new ArrayList<String>();
+      ArrayList<String> params = new ArrayList<>();
       params.add(param);
       removeQueryParams(params);
    }

File: src/gwt/src/org/rstudio/studio/client/application/ui/RVersionSelectWidget.java
Patch:
@@ -68,7 +68,7 @@ private static String[] rVersionChoices(JsArray<RVersionSpec> rVersions,
       boolean disambiguate = RVersionSpec.hasDuplicates(rVersions);
 
       // build list of choices
-      ArrayList<String> choices = new ArrayList<String>();
+      ArrayList<String> choices = new ArrayList<>();
 
       // include "default" label if requested
       if (includeSystemDefault)
@@ -91,7 +91,7 @@ private static String[] rVersionChoices(JsArray<RVersionSpec> rVersions,
    private static String[] rVersionValues(JsArray<RVersionSpec> rVersions,
                                           boolean includeSystemDefault)
    {
-      ArrayList<String> values = new ArrayList<String>();
+      ArrayList<String> values = new ArrayList<>();
 
       if (includeSystemDefault)
          values.add(rVersionSpecToString(RVersionSpec.createEmpty()));

File: src/gwt/src/org/rstudio/studio/client/application/ui/RequestLogVisualization.java
Patch:
@@ -306,7 +306,7 @@ else if (keyCode == 'I')
                      public void execute(String input)
                      {
                         CsvReader reader = new CsvReader(input);
-                        ArrayList<RequestLogEntry> entries = new ArrayList<RequestLogEntry>();
+                        ArrayList<RequestLogEntry> entries = new ArrayList<>();
                         Iterator<String[]> it = reader.iterator();
                         String now = it.next()[0];
                         while (it.hasNext())

File: src/gwt/src/org/rstudio/studio/client/application/ui/addins/AddinsToolbarButton.java
Patch:
@@ -241,7 +241,7 @@ public void execute()
    
    private Map<String, List<RAddin>> organizeAddins()
    {
-      Map<String, List<RAddin>> organized = new HashMap<String, List<RAddin>>();
+      Map<String, List<RAddin>> organized = new HashMap<>();
       
       String query = searchWidget_.getValue().toLowerCase().trim();
       
@@ -260,7 +260,7 @@ private Map<String, List<RAddin>> organizeAddins()
          String pkg = splat[0];
          
          if (!organized.containsKey(pkg))
-            organized.put(pkg, new ArrayList<RAddin>());
+            organized.put(pkg, new ArrayList<>());
          
          List<RAddin> addinList = organized.get(pkg);
          addinList.add(addin);

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -88,7 +88,7 @@ private int getPositionAtOffset(int offset)
       return Math.max(0, Math.min(pos, history_.size()));
    }
 
-   private final ArrayList<String> history_ = new ArrayList<String>();
+   private final ArrayList<String> history_ = new ArrayList<>();
    private int historyPos_;
    // If you start typing a command, then go up in history, then go down,
    // then what you had previously typed should still be there. This is

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ErrorManager.java
Patch:
@@ -171,7 +171,7 @@ private void setErrorManagementType(
 
    private void setErrorManagementType(String type)
    {
-      setErrorManagementType(type, new QuietServerRequestCallback<Void>());
+      setErrorManagementType(type, new QuietServerRequestCallback<>());
    }
 
    private void syncHandlerCommandsCheckedState()

File: src/gwt/src/org/rstudio/studio/client/common/fileexport/FileExport.java
Patch:
@@ -43,7 +43,7 @@ void initialize(GlobalDisplay globalDisplay,
    
    public void export(String caption, String description, FileSystemItem file)
    {
-      ArrayList<FileSystemItem> files = new ArrayList<FileSystemItem>();
+      ArrayList<FileSystemItem> files = new ArrayList<>();
       files.add(file);
       export(caption, description, null, files);
    }
@@ -111,7 +111,7 @@ public void execute(String archiveName, ProgressIndicator progress)
                   archiveName += ZIP;
                
                // build list of filenames
-               ArrayList<String> filenames = new ArrayList<String>();
+               ArrayList<String> filenames = new ArrayList<>();
                for (FileSystemItem file : files)
                   filenames.add(file.getName());
                

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/NewFileMenu.java
Patch:
@@ -42,7 +42,6 @@ void initialize(FileTypeCommands fileTypeCommands)
    protected abstract ArrayList<FileTypeCommands.CommandWithId> 
       getFileTypeCommands(FileTypeCommands fileTypeCommands);
    
-   private ArrayList<FileTypeCommands.CommandWithId> fileTypeCommands_ =
-         new ArrayList<FileTypeCommands.CommandWithId>();
+   private ArrayList<FileTypeCommands.CommandWithId> fileTypeCommands_ = new ArrayList<>();
 
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ProfilerType.java
Patch:
@@ -51,7 +51,7 @@ public void openFile(FileSystemItem file, EventBus eventBus)
 
    public HashSet<AppCommand> getSupportedCommands(Commands commands)
    {
-      HashSet<AppCommand> results = new HashSet<AppCommand>();
+      HashSet<AppCommand> results = new HashSet<>();
       results.add(commands.saveSourceDoc());
       results.add(commands.saveSourceDocAs());
       results.add(commands.saveProfileAs());

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -299,7 +299,7 @@ public String getScriptInterpreter()
 
    public HashSet<AppCommand> getSupportedCommands(Commands commands)
    {
-      HashSet<AppCommand> results = new HashSet<AppCommand>();
+      HashSet<AppCommand> results = new HashSet<>();
       results.add(commands.saveSourceDoc());
       results.add(commands.reopenSourceDocWithEncoding());
       results.add(commands.saveSourceDocAs());

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenDataFileEvent.java
Patch:
@@ -19,8 +19,7 @@
 
 public class OpenDataFileEvent extends GwtEvent<OpenDataFileHandler>
 {
-   public static final GwtEvent.Type<OpenDataFileHandler> TYPE =
-      new GwtEvent.Type<OpenDataFileHandler>();
+   public static final GwtEvent.Type<OpenDataFileHandler> TYPE = new GwtEvent.Type<>();
    
    public OpenDataFileEvent(FileSystemItem file)
    {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenFileInBrowserEvent.java
Patch:
@@ -19,7 +19,7 @@
 
 public class OpenFileInBrowserEvent extends GwtEvent<OpenFileInBrowserHandler>
 {
-   public static Type<OpenFileInBrowserHandler> TYPE = new Type<OpenFileInBrowserHandler>();
+   public static Type<OpenFileInBrowserHandler> TYPE = new Type<>();
 
    public OpenFileInBrowserEvent(FileSystemItem file)
    {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenPresentationSourceFileEvent.java
Patch:
@@ -22,8 +22,7 @@
 
 public class OpenPresentationSourceFileEvent extends GwtEvent<OpenPresentationSourceFileHandler>
 {
-   public static final GwtEvent.Type<OpenPresentationSourceFileHandler> TYPE =
-      new GwtEvent.Type<OpenPresentationSourceFileHandler>();
+   public static final GwtEvent.Type<OpenPresentationSourceFileHandler> TYPE = new GwtEvent.Type<>();
 
    public OpenPresentationSourceFileEvent(FileSystemItem file, 
                                           TextFileType fileType,

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenSourceFileEvent.java
Patch:
@@ -27,8 +27,7 @@
 @JavaScriptSerializable
 public class OpenSourceFileEvent extends CrossWindowEvent<OpenSourceFileHandler>
 {
-   public static final GwtEvent.Type<OpenSourceFileHandler> TYPE =
-      new GwtEvent.Type<OpenSourceFileHandler>();
+   public static final GwtEvent.Type<OpenSourceFileHandler> TYPE = new GwtEvent.Type<>();
 
    public OpenSourceFileEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/common/impl/WebTextInput.java
Patch:
@@ -69,7 +69,7 @@ public void promptForTextWithOption(
       // This variable introduces a level of pointer indirection that lets us
       // get around passing TextEntryModalDialog a reference to itself in its
       // own constructor.
-      final Value<TextEntryModalDialog> pDialog = new Value<TextEntryModalDialog>(null);
+      final Value<TextEntryModalDialog> pDialog = new Value<>(null);
 
       final TextEntryModalDialog dialog = new TextEntryModalDialog(
             title,

File: src/gwt/src/org/rstudio/studio/client/common/latex/LatexProgramRegistry.java
Patch:
@@ -73,7 +73,7 @@ public ArrayList<String> getTypes()
          JsArrayString types = 
                 pSession_.get().getSessionInfo().getLatexProgramTypes();
        
-         latexProgramTypes_ = new ArrayList<String>();
+         latexProgramTypes_ = new ArrayList<>();
          for (int i=0; i<types.length(); i++)
             latexProgramTypes_.add(types.get(i));
       }

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJax.java
Patch:
@@ -77,9 +77,9 @@ public MathJax(DocDisplay docDisplay, DocUpdateSentinel sentinel,
       prefs_ = prefs;
       popup_ = new MathJaxPopupPanel(this);
       renderQueue_ = new MathJaxRenderQueue(this);
-      handlers_ = new ArrayList<HandlerRegistration>();
-      cowToPlwMap_ = new SafeMap<ChunkOutputWidget, PinnedLineWidget>();
-      lwToPlwMap_ = new SafeMap<LineWidget, ChunkOutputWidget>();
+      handlers_ = new ArrayList<>();
+      cowToPlwMap_ = new SafeMap<>();
+      lwToPlwMap_ = new SafeMap<>();
 
       handlers_.add(popup_.addAttachHandler(new AttachEvent.Handler()
       {

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxLoader.java
Patch:
@@ -137,7 +137,7 @@ private static ScriptElement createMathJaxScriptElement()
       return el;
    }
    
-   private static List<Callback> MATHJAX_CALLBACKS = new ArrayList<Callback>();
+   private static List<Callback> MATHJAX_CALLBACKS = new ArrayList<>();
    private static boolean MATHJAX_LOADED = false;
    private static int RETRY_COUNT = 0;
    

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxRenderQueue.java
Patch:
@@ -26,7 +26,7 @@ public MathJaxRenderQueue(MathJax mathjax)
    {
       mathjax_ = mathjax;
       
-      ranges_ = new LinkedList<Range>();
+      ranges_ = new LinkedList<>();
       callback_ = new MathJaxTypeset.Callback()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxUtil.java
Patch:
@@ -107,7 +107,7 @@ public static boolean isSelectionWithinLatexChunk(DocDisplay docDisplay)
    public static List<Range> findLatexChunks(DocDisplay docDisplay)
    {
       docDisplay.tokenizeDocument();
-      List<Range> ranges = new ArrayList<Range>();
+      List<Range> ranges = new ArrayList<>();
       
       Position startPos = null;
       for (int i = 0, n = docDisplay.getRowCount(); i < n; i++)

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/ChooseMirrorDialog.java
Patch:
@@ -186,7 +186,7 @@ protected Widget createMainWidget()
          public void onResponseReceived(JsArray<CRANMirror> mirrors)
          {   
             // keep internal list of mirrors 
-            mirrors_ = new ArrayList<CRANMirror>(mirrors.length());
+            mirrors_ = new ArrayList<>(mirrors.length());
             
             // create list box and select default item
             listBox_ = new ListBox();

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/CRANMirror.java
Patch:
@@ -70,7 +70,7 @@ private final void setSecondaryRepos(String cran, ArrayList<CRANMirror> repos)
    {
       setURL(cran);
 
-      ArrayList<String> entries = new ArrayList<String>();
+      ArrayList<String> entries = new ArrayList<>();
       for (CRANMirror repo : repos)
       {
          if (!repo.getName().toLowerCase().equals("cran"))
@@ -89,7 +89,7 @@ public final void setSecondaryRepos(ArrayList<CRANMirror> repos)
 
    public final ArrayList<CRANMirror> getSecondaryRepos()
    {
-      ArrayList<CRANMirror> repos = new ArrayList<CRANMirror>();
+      ArrayList<CRANMirror> repos = new ArrayList<>();
 
       String secondary = getSecondary();
       if (StringUtil.isNullOrEmpty(secondary))

File: src/gwt/src/org/rstudio/studio/client/common/r/RTokenizer.java
Patch:
@@ -30,7 +30,7 @@ public RTokenizer(String data)
    
    public static ArrayList<RToken> asTokens(String code)
    {
-      ArrayList<RToken> results = new ArrayList<RToken>();
+      ArrayList<RToken> results = new ArrayList<>();
       RTokenizer rt = new RTokenizer(code);
       RToken t;
       while (null != (t = rt.nextToken()))

File: src/gwt/src/org/rstudio/studio/client/common/r/roxygen/RoxygenHelper.java
Patch:
@@ -796,7 +796,7 @@ protected SetRefClassCall() {}
          Pattern.create("^\\s*#+'\\s*@[^@]", "");
    
    private static final ArrayList<String> ROXYGEN_ANNOTATABLE_CALLS =
-      new ArrayList<String>(
+      new ArrayList<>(
             Arrays.asList(new String[] {
             "setClass",
             "setRefClass",

File: src/gwt/src/org/rstudio/studio/client/common/rnw/RnwWeaveRegistry.java
Patch:
@@ -68,7 +68,7 @@ public ArrayList<RnwWeave> getTypes()
          JsArray<RnwWeave> types = 
                            pSession_.get().getSessionInfo().getRnwWeaveTypes();
        
-         weaveTypes_ = new ArrayList<RnwWeave>();
+         weaveTypes_ = new ArrayList<>();
          for (int i=0; i<types.length(); i++)
             weaveTypes_.add(types.get(i));
       }

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/DialogHtmlSanitizer.java
Patch:
@@ -26,7 +26,7 @@
 import com.google.gwt.safehtml.shared.SafeHtmlUtils;
 
 public final class DialogHtmlSanitizer implements HtmlSanitizer {
-   private static final Set<String> TAG_WHITELIST = new HashSet<String>(
+   private static final Set<String> TAG_WHITELIST = new HashSet<>(
       Arrays.asList(
          "p", "em", "strong", "b", "i", "a"
       )

File: src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerList.java
Patch:
@@ -51,7 +51,7 @@ public SourceMarkerList()
    {
       codec_ = new SourceMarkerItemCodec(res_, false);
 
-      errorTable_ = new FastSelectTable<SourceMarker, CodeNavigationTarget, CodeNavigationTarget>(
+      errorTable_ = new FastSelectTable<>(
             codec_,
             res_.styles().selectedRow(),
             true,
@@ -121,7 +121,7 @@ public void showMarkers(String targetFile,
                            int autoSelect)
    {
       boolean showFileHeaders = false;
-      ArrayList<SourceMarker> errorList = new ArrayList<SourceMarker>();
+      ArrayList<SourceMarker> errorList = new ArrayList<>();
       int firstErrorIndex = -1;
       for (int i=0; i<errors.length(); i++)
       {

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java
Patch:
@@ -66,8 +66,8 @@ public void send()
       {
          String path = GWT.getHostPageBaseURL() + "dictionaries/" + language_ + "/" + language_;
 
-         final Mutable<String> aff = new Mutable<String>();
-         final Mutable<String> dic = new Mutable<String>();
+         final Mutable<String> aff = new Mutable<>();
+         final Mutable<String> dic = new Mutable<>();
          final Command onReady = () -> {
 
             if (cancelled_ || aff.get() == null || dic.get() == null)

File: src/gwt/src/org/rstudio/studio/client/common/vcs/StatusAndPath.java
Patch:
@@ -54,7 +54,7 @@ public static ArrayList<StatusAndPath> fromInfos(
       if (infos == null)
          return null;
 
-      ArrayList<StatusAndPath> result = new ArrayList<StatusAndPath>();
+      ArrayList<StatusAndPath> result = new ArrayList<>();
       for (int i = 0; i < infos.length(); i++)
       {
          result.add(new StatusAndPath(infos.get(i)));

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/Ignore.java
Patch:
@@ -230,15 +230,15 @@ private IgnoreList createIgnoreList(ArrayList<String> paths,
       // special case for empty path list -- make the project root the 
       // parent path and return an empty list
       if (paths.size() == 0)
-         return new IgnoreList("", new ArrayList<String>());
+         return new IgnoreList("", new ArrayList<>());
        
       // get the parent path of the first element
       FileSystemItem firstPath = FileSystemItem.createFile(paths.get(0));
       String parentPath = firstPath.getParentPathString();
       
       // confirm that all of the elements start with that path and take the
       // remainder of their paths for our list
-      ArrayList<String> ignored = new ArrayList<String>();
+      ArrayList<String> ignored = new ArrayList<>();
       for (String path : paths)
       {
          String thisParent = 
@@ -278,7 +278,7 @@ private IgnoreList createIgnoreList(ArrayList<String> paths,
    private String getIgnored(IgnoreList ignoreList, String existingIgnored)
    {
       // split existing ignored into list
-      ArrayList<String> ignored = new ArrayList<String>();
+      ArrayList<String> ignored = new ArrayList<>();
       Iterable<String> existing = StringUtil.getLineIterator(existingIgnored);
       for (String item : existing)
       {

File: src/gwt/src/org/rstudio/studio/client/common/viewfile/ViewFilePanel.java
Patch:
@@ -418,6 +418,5 @@ public int getHeight()
    
    private SaveFileAsHandler saveFileAsHandler_ = null;
    
-   private final ArrayList<HandlerRegistration> releaseOnDismiss_ =
-         new ArrayList<HandlerRegistration>();
+   private final ArrayList<HandlerRegistration> releaseOnDismiss_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -83,7 +83,7 @@ public void requestSuggestions(Request request, Callback callback)
             // no suggestions
             callback.onSuggestionsReady(
                   request,
-                  new Response(new ArrayList<Suggestion>()));
+                  new Response(new ArrayList<>()));
          }
       });
       searchWidget_.addValueChangeHandler(new ValueChangeHandler<String>() {

File: src/gwt/src/org/rstudio/studio/client/events/RStudioApiRequestEvent.java
Patch:
@@ -96,7 +96,7 @@ protected void dispatch(Handler handler)
       handler.onRStudioApiRequest(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
    
    
    // Event Data ----

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreviewPresenter.java
Patch:
@@ -327,8 +327,7 @@ public void onRefreshHtmlPreview()
    {
       if (lastSuccessfulPreview_.getEnableReexecute())
       {
-         server_.previewHTML(lastPreviewParams_, 
-                             new SimpleRequestCallback<Boolean>());
+         server_.previewHTML(lastPreviewParams_, new SimpleRequestCallback<>());
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/events/ShowHTMLPreviewEvent.java
Patch:
@@ -20,8 +20,7 @@
 
 public class ShowHTMLPreviewEvent extends GwtEvent<ShowHTMLPreviewHandler>
 { 
-   public static final GwtEvent.Type<ShowHTMLPreviewHandler> TYPE =
-      new GwtEvent.Type<ShowHTMLPreviewHandler>();
+   public static final GwtEvent.Type<ShowHTMLPreviewHandler> TYPE = new GwtEvent.Type<>();
    
    public ShowHTMLPreviewEvent(HTMLPreviewParams params)
    {

File: src/gwt/src/org/rstudio/studio/client/packrat/ui/PackratResolveConflictDialog.java
Patch:
@@ -72,7 +72,7 @@ public PackratResolveConflictDialog(
       mainWidget_.add(label);
             
       // table
-      table_ = new RStudioDataGrid<PackratConflictActions>(conflictActions.size(),
+      table_ = new RStudioDataGrid<>(conflictActions.size(),
             (PackagesDataGridCommon)GWT.create(PackagesDataGridCommon.class));
       StyleUtils.forceMacScrollbars(table_);
       table_.addStyleName(RESOURCES.styles().conflictsTable());

File: src/gwt/src/org/rstudio/studio/client/palette/AppCommandPaletteSource.java
Patch:
@@ -42,9 +42,9 @@ public AppCommandPaletteSource(ShortcutManager shortcuts, Commands commands)
    @Override
    public List<CommandPaletteItem> getCommandPaletteItems()
    {
-      List<CommandPaletteItem> items = new ArrayList<CommandPaletteItem>();
-      List<String> sorted = new ArrayList<String>();
-      Set<String> unsorted = new HashSet<String>();
+      List<CommandPaletteItem> items = new ArrayList<>();
+      List<String> sorted = new ArrayList<>();
+      Set<String> unsorted = new HashSet<>();
       unsorted.addAll(commands_.getCommands().keySet());
 
       // Front-load the first page of results with some useful commands; we don't attempt to sort

File: src/gwt/src/org/rstudio/studio/client/palette/CommandPaletteLauncher.java
Patch:
@@ -81,7 +81,7 @@ public CommandPaletteLauncher(Commands commands,
          // to use the Command Palette as a quick "run last command again" tool
          if (mru_ == null)
          {
-            mru_ = new ArrayList<CommandPaletteMruEntry>();
+            mru_ = new ArrayList<>();
          }
          mru_.removeIf(entry -> entry.equals(evt.getMruEntry()));
          mru_.add(0, evt.getMruEntry());
@@ -124,7 +124,7 @@ public void onClearCommandPaletteMru()
    private void createPanel()
    {
       // Extra sources (currently only the source tab)
-      List<CommandPaletteEntryProvider> providers = new ArrayList<CommandPaletteEntryProvider>();
+      List<CommandPaletteEntryProvider> providers = new ArrayList<>();
       
       // Create sources
       providers.add(new AppCommandPaletteSource(ShortcutManager.INSTANCE, commands_));
@@ -144,7 +144,7 @@ private void createPanel()
             ArrayList<String> mru = evt.getList();
 
             // After the first time the palette is shown, the MRU is updated by this event handler.
-            mru_ = new ArrayList<CommandPaletteMruEntry>();
+            mru_ = new ArrayList<>();
             for (String entry: mru)
             {
                CommandPaletteMruEntry mruEntry = CommandPaletteMruEntry.fromString(entry);

File: src/gwt/src/org/rstudio/studio/client/palette/RAddinPaletteSource.java
Patch:
@@ -26,7 +26,6 @@
 import org.rstudio.core.client.command.ShortcutManager;
 import org.rstudio.core.client.js.JsUtil;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntryProvider;
-import org.rstudio.studio.client.palette.model.CommandPaletteEntrySource;
 import org.rstudio.studio.client.palette.model.CommandPaletteItem;
 import org.rstudio.studio.client.palette.ui.CommandPalette;
 import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;
@@ -49,7 +48,7 @@ public RAddinPaletteSource(RAddins addins, ShortcutManager shortcuts)
    @Override
    public List<CommandPaletteItem> getCommandPaletteItems()
    {
-      List<CommandPaletteItem> items = new ArrayList<CommandPaletteItem>();
+      List<CommandPaletteItem> items = new ArrayList<>();
       for (String id: JsUtil.asIterable(addins_.keys()))
       {
          RAddin addin = addins_.get(id);

File: src/gwt/src/org/rstudio/studio/client/palette/UserPrefPaletteSource.java
Patch:
@@ -40,7 +40,7 @@ public UserPrefPaletteSource(UserPrefs prefs)
    @Override
    public List<CommandPaletteItem> getCommandPaletteItems()
    {
-      List<CommandPaletteItem> items = new ArrayList<CommandPaletteItem>();
+      List<CommandPaletteItem> items = new ArrayList<>();
       for (PrefValue<?> val: prefs_.allPrefs())
       {
          if (StringUtil.isNullOrEmpty(val.getTitle()))

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorCommandIcons.java
Patch:
@@ -88,6 +88,6 @@ private String dm(String icon)
    
    public static PanmirrorCommandIcons INSTANCE = new PanmirrorCommandIcons();
    
-   private HashMap<String,ImageResource> icons_ = new HashMap<String,ImageResource>();
+   private HashMap<String,ImageResource> icons_ = new HashMap<>();
    
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorCommandPaletteEntry.java
Patch:
@@ -59,7 +59,7 @@ public boolean enabled()
 
    private static List<KeySequence> keySequence(PanmirrorCommandUI command)
    {
-      List<KeySequence> keys = new ArrayList<KeySequence>();
+      List<KeySequence> keys = new ArrayList<>();
       KeySequence keySequence = command.getKeySequence();
       if (keySequence != null)
          keys.add(keySequence);

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbar.java
Patch:
@@ -230,5 +230,5 @@ private HorizontalPanel addWidgetGroup(Widget...widgets)
    
    private PanmirrorToolbarCommands commands_ = null;
    private PanmirrorMenus menus_ = null;
-   private ArrayList<PanmirrorCommandUIObject> commandObjects_ = new ArrayList<PanmirrorCommandUIObject>();
+   private ArrayList<PanmirrorCommandUIObject> commandObjects_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarCommands.java
Patch:
@@ -22,7 +22,6 @@
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntryProvider;
-import org.rstudio.studio.client.palette.model.CommandPaletteEntrySource;
 import org.rstudio.studio.client.palette.model.CommandPaletteItem;
 
 import com.google.gwt.aria.client.MenuitemRole;
@@ -170,7 +169,7 @@ public boolean exec(String id)
    @Override
    public List<CommandPaletteItem> getCommandPaletteItems()
    {
-      List<CommandPaletteItem> items = new ArrayList<CommandPaletteItem>();
+      List<CommandPaletteItem> items = new ArrayList<>();
       for (PanmirrorCommandUI cmd: commandsUI_.values())
       {
          if (cmd != null && cmd.isVisible())
@@ -245,5 +244,5 @@ private void add(String id, String menuText, String pluralMenuText, MenuitemRole
    }
    
    private PanmirrorCommand[] commands_ = null;
-   private final HashMap<String,PanmirrorCommandUI> commandsUI_ = new HashMap<String,PanmirrorCommandUI>();
+   private final HashMap<String,PanmirrorCommandUI> commandsUI_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarRadioMenu.java
Patch:
@@ -83,6 +83,6 @@ public void sync(boolean images)
    private final String defaultText_;
    private int minWidth_ = 0;
    private final PanmirrorToolbarMenu menu_;
-   private final ArrayList<String> commandIds_ = new ArrayList<String>();
+   private final ArrayList<String> commandIds_ = new ArrayList<>();
    private final PanmirrorToolbarCommands commands_;
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorEditListDialog.java
Patch:
@@ -70,7 +70,7 @@ public PanmirrorEditListDialog(PanmirrorListProps props,
       numberStyle_.setVisible(capabilities.fancy);
       numberDelimiter_.setVisible(capabilities.fancy);
       
-      List<String> numberStyleChoices = new ArrayList<String>();
+      List<String> numberStyleChoices = new ArrayList<>();
       numberStyleChoices.add("DefaultStyle");
       numberStyleChoices.add("Decimal");
       numberStyleChoices.add("LowerRoman");

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorLangSuggestBox.java
Patch:
@@ -59,7 +59,7 @@ public void requestSuggestions(Request request, Callback callback)
          {
             String query = request.getQuery();
             
-            ArrayList<Suggestion> suggestions = new ArrayList<Suggestion>();
+            ArrayList<Suggestion> suggestions = new ArrayList<>();
             for (int i=0; i<languages.length; i++)
             {
                String language = languages[i];

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorRawFormatSelect.java
Patch:
@@ -37,7 +37,7 @@ public void setFormats(String[] formats, String value)
    
    private static String[] getFormatList(String firstItem, String[] formats, String value)
    {
-      ArrayList<String> options = new ArrayList<String>();
+      ArrayList<String> options = new ArrayList<>();
       options.add(firstItem);
       options.addAll(Arrays.asList(formats));
       if (!options.contains(value))

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorBlurEvent.java
Patch:
@@ -44,7 +44,7 @@ public static void fire(HasPanmirrorBlurHandlers source) {
 
   public static Type<PanmirrorBlurEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorBlurEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorFindReplaceVisibleEvent.java
Patch:
@@ -78,7 +78,7 @@ public static void fire(HasPanmirrorFindReplaceVisibleHandlers source, boolean v
    */
   public static Type<PanmirrorFindReplaceVisibleEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorFindReplaceVisibleEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorFocusEvent.java
Patch:
@@ -44,7 +44,7 @@ public static void fire(HasPanmirrorFocusHandlers source) {
 
   public static Type<PanmirrorFocusEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorFocusEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorNavigationEvent.java
Patch:
@@ -80,7 +80,7 @@ public static void fire(HasPanmirrorNavigationHandlers source, PanmirrorNavigati
    */
   public static Type<PanmirrorNavigationEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorNavigationEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorOutlineNavigationEvent.java
Patch:
@@ -78,7 +78,7 @@ public static void fire(HasPanmirrorOutlineNavigationHandlers source, String id)
    */
   public static Type<PanmirrorOutlineNavigationEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorOutlineNavigationEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorOutlineVisibleEvent.java
Patch:
@@ -78,7 +78,7 @@ public static void fire(HasPanmirrorOutlineVisibleHandlers source, boolean visib
    */
   public static Type<PanmirrorOutlineVisibleEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorOutlineVisibleEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorOutlineWidthEvent.java
Patch:
@@ -78,7 +78,7 @@ public static void fire(HasPanmirrorOutlineWidthHandlers source, double width) {
    */
   public static Type<PanmirrorOutlineWidthEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorOutlineWidthEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorStateChangeEvent.java
Patch:
@@ -44,7 +44,7 @@ public static void fire(HasPanmirrorStateChangeHandlers source) {
 
   public static Type<PanmirrorStateChangeEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorStateChangeEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/events/PanmirrorUpdatedEvent.java
Patch:
@@ -44,7 +44,7 @@ public static void fire(HasPanmirrorUpdatedHandlers source) {
 
   public static Type<PanmirrorUpdatedEvent.Handler> getType() {
     if (TYPE == null) {
-      TYPE = new Type<PanmirrorUpdatedEvent.Handler>();
+      TYPE = new Type<>();
     }
     return TYPE;
   }

File: src/gwt/src/org/rstudio/studio/client/panmirror/outline/PanmirrorOutlineWidget.java
Patch:
@@ -195,7 +195,7 @@ private void addToTree(PanmirrorOutlineItem item)
    
    private ArrayList<PanmirrorOutlineItem> flattenOutline(PanmirrorOutlineItem[] items)
    {
-      ArrayList<PanmirrorOutlineItem> flattenedItems = new ArrayList<PanmirrorOutlineItem>();
+      ArrayList<PanmirrorOutlineItem> flattenedItems = new ArrayList<>();
       String chunkPref = pPrefs_.get().docOutlineShow().getValue();
       doFlattenOutline(items, flattenedItems, chunkPref);
       return flattenedItems;

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorCrossrefServer.java
Patch:
@@ -42,10 +42,10 @@ void initialize(PanmirrorCrossrefServerOperations server)
    
    public Promise<JavaScriptObject> works(String query)
    {
-      return new Promise<JavaScriptObject>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
          server_.crossrefWorks(
             query,
-            new PromiseServerRequestCallback<JavaScriptObject>(resolve, reject)
+            new PromiseServerRequestCallback<>(resolve, reject)
          );
       });
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorDOIServer.java
Patch:
@@ -43,10 +43,10 @@ void initialize(PanmirrorDOIServerOperations server)
    
    public Promise<JavaScriptObject> fetchCSL(String doi, int delayMs)
    {
-      return new Promise<JavaScriptObject>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
          server_.doiFetchCSL(
         		doi,
-            new PromiseServerRequestCallback<JavaScriptObject>(resolve, reject, "Looking up DOI...", delayMs)
+            new PromiseServerRequestCallback<>(resolve, reject, "Looking up DOI...", delayMs)
          );
       });
    }   

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorDataCiteServer.java
Patch:
@@ -42,10 +42,10 @@ void initialize(PanmirrorDataCiteServerOperations server)
    
    public Promise<JavaScriptObject> search(String query)
    {
-      return new Promise<JavaScriptObject>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
          server_.dataciteSearch(
             query,
-            new PromiseServerRequestCallback<JavaScriptObject>(resolve, reject)
+            new PromiseServerRequestCallback<>(resolve, reject)
          );
       });
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorPubMedServer.java
Patch:
@@ -42,10 +42,10 @@ void initialize(PanmirrorPubMedServerOperations server)
    
    public Promise<JavaScriptObject> search(String query)
    {
-      return new Promise<JavaScriptObject>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<JavaScriptObject> resolve, RejectCallbackFn reject) -> {
          server_.pubmedSearch(
             query,
-            new PromiseServerRequestCallback<JavaScriptObject>(resolve, reject)
+            new PromiseServerRequestCallback<>(resolve, reject)
          );
       });
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUIMath.java
Patch:
@@ -31,7 +31,7 @@ public class PanmirrorUIMath {
    
    public Promise<Boolean> typeset(Element el, String text, boolean priority)
    {
-      return new Promise<Boolean>((ResolveCallbackFn<Boolean> resolve, RejectCallbackFn reject) -> {
+      return new Promise<>((ResolveCallbackFn<Boolean> resolve, RejectCallbackFn reject) -> {
          MathJaxLoader.withMathJaxLoaded((alreadyLoaded) -> {
             MathJaxTypeset.typeset(el, text, priority, (error) -> {
                resolve.onInvoke(error);

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/model/PdfJsWindow.java
Patch:
@@ -374,7 +374,7 @@ public static void navigateTo(final PdfJsWindow win,
       final double w = pdfLocation.getWidth() * factor;
       final double h = pdfLocation.getHeight() * factor;
       
-      final Value<Integer> retries = new Value<Integer>(0);
+      final Value<Integer> retries = new Value<>(0);
 
       // Sometimes pageContainer is null during load, so retry every 100ms
       // until it's not, or we've tried 40 times.

File: src/gwt/src/org/rstudio/studio/client/plumber/events/LaunchPlumberAPIEvent.java
Patch:
@@ -30,7 +30,7 @@ public interface Handler extends EventHandler
    }
 
    public static final GwtEvent.Type<LaunchPlumberAPIEvent.Handler> TYPE =
-      new GwtEvent.Type<LaunchPlumberAPIEvent.Handler>();
+      new GwtEvent.Type<>();
    
    public LaunchPlumberAPIEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/plumber/events/PlumberAPIStatusEvent.java
Patch:
@@ -30,8 +30,7 @@ public interface Handler extends EventHandler
       void onPlumberAPIStatus(PlumberAPIStatusEvent event);
    }
 
-   public static final GwtEvent.Type<PlumberAPIStatusEvent.Handler> TYPE =
-      new GwtEvent.Type<PlumberAPIStatusEvent.Handler>();
+   public static final GwtEvent.Type<PlumberAPIStatusEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public PlumberAPIStatusEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -560,7 +560,7 @@ public void onError(ServerError error)
                   // not be currently installed; in those cases, verify that the package is
                   // installed and if not attempt installation from CRAN first
                   String pkg = newProject.getProjectTemplateOptions().getDescription().getPackage();
-                  ArrayList<Dependency> deps = new ArrayList<Dependency>();
+                  ArrayList<Dependency> deps = new ArrayList<>();
                   deps.add(Dependency.cranPackage(pkg));
                   RStudioGinjector.INSTANCE.getDependencyManager().withDependencies(
                         "Creating project",

File: src/gwt/src/org/rstudio/studio/client/projects/events/OpenProjectErrorEvent.java
Patch:
@@ -20,8 +20,7 @@
 
 public class OpenProjectErrorEvent extends GwtEvent<OpenProjectErrorHandler>
 {
-   public static final GwtEvent.Type<OpenProjectErrorHandler> TYPE =
-      new GwtEvent.Type<OpenProjectErrorHandler>();
+   public static final GwtEvent.Type<OpenProjectErrorHandler> TYPE = new GwtEvent.Type<>();
    
    public OpenProjectErrorEvent(OpenProjectError error)
    {

File: src/gwt/src/org/rstudio/studio/client/projects/events/OpenProjectFileEvent.java
Patch:
@@ -19,8 +19,7 @@
 
 public class OpenProjectFileEvent extends GwtEvent<OpenProjectFileHandler>
 {
-   public static final GwtEvent.Type<OpenProjectFileHandler> TYPE =
-      new GwtEvent.Type<OpenProjectFileHandler>();
+   public static final GwtEvent.Type<OpenProjectFileHandler> TYPE = new GwtEvent.Type<>();
    
    public OpenProjectFileEvent(FileSystemItem file)
    {

File: src/gwt/src/org/rstudio/studio/client/projects/events/OpenProjectNewWindowEvent.java
Patch:
@@ -20,8 +20,7 @@
 
 public class OpenProjectNewWindowEvent extends GwtEvent<OpenProjectNewWindowHandler>
 {
-   public static final GwtEvent.Type<OpenProjectNewWindowHandler> TYPE =
-      new GwtEvent.Type<OpenProjectNewWindowHandler>();
+   public static final GwtEvent.Type<OpenProjectNewWindowHandler> TYPE = new GwtEvent.Type<>();
    
    public OpenProjectNewWindowEvent(String project, RVersionSpec rVersion)
    {

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectTemplateRegistryProvider.java
Patch:
@@ -40,7 +40,7 @@ public ProjectTemplateRegistryProvider()
    {
       RStudioGinjector.INSTANCE.injectMembers(this);
       
-      pendingCallbacks_ = new ArrayList<Callback>();
+      pendingCallbacks_ = new ArrayList<>();
       
       events_.addHandler(ProjectTemplateRegistryUpdatedEvent.TYPE, this);
       

File: src/gwt/src/org/rstudio/studio/client/projects/model/RProjectConfig.java
Patch:
@@ -264,7 +264,7 @@ public final void setPackageRoxygenize(boolean rd,
                                           boolean namespace,
                                           boolean vignette)
    {
-      ArrayList<String> roclets = new ArrayList<String>();
+      ArrayList<String> roclets = new ArrayList<>();
       if (rd)
          roclets.add(ROXYGENIZE_RD);
       if (collate)

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/CodeFilesList.java
Patch:
@@ -81,7 +81,7 @@ void initialize(FileDialogs fileDialogs,
    
    public ArrayList<String> getCodeFiles()
    {
-      ArrayList<String> codeFiles = new ArrayList<String>();
+      ArrayList<String> codeFiles = new ArrayList<>();
       for (int i=0; i<listBox_.getItemCount(); i++)
          codeFiles.add(listBox_.getItemText(i));
       return codeFiles;

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryNavigationPage.java
Patch:
@@ -75,8 +75,8 @@ public Widget createMainWidget(ArrayList<WizardPage<NewProjectInput, NewProjectR
    private static ArrayList<WizardPage<NewProjectInput, NewProjectResult>>
                                          createPages(SessionInfo sessionInfo)
    {
-      ArrayList<WizardPage<NewProjectInput, NewProjectResult>> pages = 
-            new ArrayList<WizardPage<NewProjectInput, NewProjectResult>>();
+      ArrayList<WizardPage<NewProjectInput, NewProjectResult>> pages =
+            new ArrayList<>();
       
       // add default RStudio dialogs
       pages.add(new NewDirectoryPage());

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPackratPreferencesPane.java
Patch:
@@ -211,7 +211,7 @@ private ArrayList<String> getTextAreaValue(TextArea textArea)
       List<String> values = Arrays.asList(value.split("\\s*,\\s*"));
 
       // remove entries that are only whitespace
-      ArrayList<String> result = new ArrayList<String>();
+      ArrayList<String> result = new ArrayList<>();
       for (String s : values)
       {
          if (!StringUtil.isNullOrEmpty(s))

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsWebsitePanel.java
Patch:
@@ -74,8 +74,8 @@ void load(RProjectOptions options)
          
          // get all available output formats
          JsArrayString formatsJson = buildContext.getWebsiteOutputFormats();
-         ArrayList<String> formatNames = new ArrayList<String>();
-         ArrayList<String> formats = new ArrayList<String>();
+         ArrayList<String> formatNames = new ArrayList<>();
+         ArrayList<String> formats = new ArrayList<>();
         
          // always include "All Formats"
          formatNames.add("(All Formats)");

File: src/gwt/src/org/rstudio/studio/client/renv/ui/RenvActionDialogContents.java
Patch:
@@ -43,10 +43,10 @@ interface RenvRestoreDialogContentsUiBinder
    public RenvActionDialogContents(String action, JsArray<RenvAction> actions)
    {
       action_ = action;
-      actions_ = new ArrayList<RenvAction>();
+      actions_ = new ArrayList<>();
       JsArrayUtil.fillList(actions, actions_);
       
-      table_ = new RStudioDataGrid<RenvAction>(actions.length(), RES);
+      table_ = new RStudioDataGrid<>(actions.length(), RES);
       
       table_.setHeight("500px");
       table_.setWidth("600px");

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/NotebookQueueUnit.java
Patch:
@@ -130,7 +130,7 @@ public final boolean hasPendingRange(NotebookExecRange range)
    private final List<Integer> linesFromRanges(
          JsArray<NotebookExecRange> ranges)
    {
-      List<Integer> lines = new ArrayList<Integer>();
+      List<Integer> lines = new ArrayList<>();
       final String code = getCode();
       int line = 0, last = -1;
       for (int i = 0; i < code.length(); i++)

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/YamlTree.java
Patch:
@@ -121,7 +121,7 @@ public void setValue(String value)
       public String key;
       public int indentLevel = 0;
       public YamlTreeNode parent = null;
-      public List<YamlTreeNode> children = new ArrayList<YamlTreeNode>();
+      public List<YamlTreeNode> children = new ArrayList<>();
       
       private String getKey(String line)
       {
@@ -142,7 +142,7 @@ private int getIndentLevel()
    public YamlTree(String yaml)
    {
       root_ = createYamlTree(yaml);
-      keyMap_ = new HashMap<String, YamlTreeNode>();
+      keyMap_ = new HashMap<>();
       createKeyMap(root_, keyMap_);
    }
    
@@ -182,7 +182,7 @@ public List<String> getChildKeys(String parentKey)
          if (!keyMap_.containsKey(parentKey))
             return null;
          YamlTreeNode parent = keyMap_.get(parentKey);
-         ArrayList<String> result = new ArrayList<String>();
+         ArrayList<String> result = new ArrayList<>();
          for (YamlTreeNode child: parent.children)
          {
             result.add(child.key);

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -1017,8 +1017,7 @@ private void configureShinyApp(final String dir,
 
       // If we know the most recent deployment of the directory, act on that
       // deployment by default
-      final ArrayList<RSConnectDeploymentRecord> recordList =
-            new ArrayList<RSConnectDeploymentRecord>();
+      final ArrayList<RSConnectDeploymentRecord> recordList = new ArrayList<>();
       RSConnectDeploymentRecord lastRecord = dirState_.getLastDeployment(dir);
       if (lastRecord != null)
       {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/EnableRStudioConnectUIEvent.java
Patch:
@@ -37,8 +37,7 @@ public interface Handler extends EventHandler
       void onEnableRStudioConnectUI(EnableRStudioConnectUIEvent event);
    }
 
-   public static final GwtEvent.Type<EnableRStudioConnectUIEvent.Handler> TYPE =
-      new GwtEvent.Type<EnableRStudioConnectUIEvent.Handler>();
+   public static final GwtEvent.Type<EnableRStudioConnectUIEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public EnableRStudioConnectUIEvent(Data enable)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectActionEvent.java
Patch:
@@ -28,8 +28,7 @@ public interface Handler extends EventHandler
       void onRSConnectAction(RSConnectActionEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectActionEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectActionEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectActionEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public static RSConnectActionEvent ConfigureAppEvent(String path)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeployInitiatedEvent.java
Patch:
@@ -28,8 +28,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeployInitiated(RSConnectDeployInitiatedEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeployInitiatedEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeployInitiatedEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeployInitiatedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeployInitiatedEvent(RSConnectPublishSource source,
                                         RSConnectPublishSettings settings,

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentCancelledEvent.java
Patch:
@@ -24,8 +24,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeploymentCancelled(RSConnectDeploymentCancelledEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentCancelledEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentCancelledEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentCancelledEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentCancelledEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentCompletedEvent.java
Patch:
@@ -24,8 +24,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeploymentCompleted(RSConnectDeploymentCompletedEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentCompletedEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentCompletedEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentCompletedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentCompletedEvent(String url)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentFailedEvent.java
Patch:
@@ -40,8 +40,7 @@ public final native String getHttpStatus() /*-{
       }-*/;
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentFailedEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentFailedEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentFailedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentFailedEvent(Data data)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentOutputEvent.java
Patch:
@@ -26,8 +26,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeploymentOutput(RSConnectDeploymentOutputEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentOutputEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentOutputEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentOutputEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentOutputEvent(CompileOutput output)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentStartedEvent.java
Patch:
@@ -24,8 +24,7 @@ public interface Handler extends EventHandler
       void onRSConnectDeploymentStarted(RSConnectDeploymentStartedEvent event);
    }
 
-   public static final GwtEvent.Type<RSConnectDeploymentStartedEvent.Handler> TYPE =
-      new GwtEvent.Type<RSConnectDeploymentStartedEvent.Handler>();
+   public static final GwtEvent.Type<RSConnectDeploymentStartedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public RSConnectDeploymentStartedEvent(String path, String title)
    {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/PlotPublishMRUList.java
Patch:
@@ -109,5 +109,5 @@ public void addPlotMruEntry(String account, String server, String name,
    }
 
    private final WorkbenchList plotMru_;
-   private ArrayList<String> plotMruList_ = new ArrayList<String>();
+   private ArrayList<String> plotMruList_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectPublishResult.java
Patch:
@@ -20,7 +20,7 @@ public class RSConnectPublishResult
 {
    public RSConnectPublishResult(RSConnectPublishSource source)
    {
-      ArrayList<String> deployFiles = new ArrayList<String>();
+      ArrayList<String> deployFiles = new ArrayList<>();
       deployFiles.add(source.getDeployFile());
       publishType_ = PUBLISH_RPUBS;
       appName_     = ""; 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/NewRSConnectAuthPage.java
Patch:
@@ -372,7 +372,7 @@ public void onError(ServerError error)
    private RSConnectServerOperations server_;
    private GlobalDisplay display_;
    private RSConnectAuthWait contents_;
-   private Value<Boolean> waitingForAuth_ = new Value<Boolean>(false);
+   private Value<Boolean> waitingForAuth_ = new Value<>(false);
    private boolean runningAuthCompleteCheck_ = false;
    private ProgressIndicator wizardIndicator_;
 }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishDocServicePage.java
Patch:
@@ -38,9 +38,7 @@ public PublishDocServicePage(String title, String subTitle,
            createPages(RSConnectPublishInput input)
    {
       ArrayList<WizardPage<RSConnectPublishInput, 
-                           RSConnectPublishResult>> pages =
-                           new ArrayList<WizardPage<RSConnectPublishInput, 
-                                                    RSConnectPublishResult>>();
+                           RSConnectPublishResult>> pages = new ArrayList<>();
       String rscTitle = RSConnectAccountWizard.SERVICE_NAME;
       String rscDesc = RSConnectAccountWizard.SERVICE_DESCRIPTION;
            

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishMultiplePage.java
Patch:
@@ -39,9 +39,7 @@ public PublishMultiplePage(String title, String subTitle, ImageResource icon,
            createPages(RSConnectPublishInput input)
    {
       ArrayList<WizardPage<RSConnectPublishInput, 
-                           RSConnectPublishResult>> pages =
-                           new ArrayList<WizardPage<RSConnectPublishInput, 
-                                                    RSConnectPublishResult>>();
+                           RSConnectPublishResult>> pages = new ArrayList<>();
       String singleTitle = "Publish just this document";
       String singleSubtitle = "Only the document " + 
                               input.getSourceRmd().getName() + 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishReportSourcePage.java
Patch:
@@ -44,9 +44,7 @@ public PublishReportSourcePage(
            createPages(RSConnectPublishInput input, boolean asMultiple)
    {
       ArrayList<WizardPage<RSConnectPublishInput, 
-                           RSConnectPublishResult>> pages =
-                           new ArrayList<WizardPage<RSConnectPublishInput, 
-                                                    RSConnectPublishResult>>();
+                           RSConnectPublishResult>> pages = new ArrayList<>();
       
       String descriptor = "document";
       if (asMultiple)

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeployDialog.java
Patch:
@@ -178,6 +178,5 @@ private void processDeploymentRecords(
    private RSConnectAccount defaultAccount_;
    
    // Map of app URL to the deployment made to that URL
-   private Map<String, RSConnectDeploymentRecord> deployments_ = 
-         new HashMap<String, RSConnectDeploymentRecord>();
+   private Map<String, RSConnectDeploymentRecord> deployments_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishButton.java
Patch:
@@ -666,13 +666,13 @@ public void execute(String htmlFile)
                      RSConnectPublishSource source = 
                            new RSConnectPublishSource(htmlFile, null, 
                                  true, true, false, "Plot", contentType_);
-                     ArrayList<String> deployFiles = new ArrayList<String>();
+                     ArrayList<String> deployFiles = new ArrayList<>();
                      deployFiles.add(FilePathUtils.friendlyFileName(htmlFile));
                      RSConnectPublishSettings settings = 
                            new RSConnectPublishSettings(
                                  deployFiles, 
-                                 new ArrayList<String>(), 
-                                 new ArrayList<String>(), 
+                                 new ArrayList<>(), 
+                                 new ArrayList<>(), 
                                  false, true);
                      events_.fireEvent(
                            new RSConnectDeployInitiatedEvent(source, settings,

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -1083,7 +1083,7 @@ else if (type == ClientEvent.DocumentCloseAllNoSave)
 
    private final EventBus eventBus_;
 
-   private final ArrayList<ClientEvent> pendingEvents_ = new ArrayList<ClientEvent>();
+   private final ArrayList<ClientEvent> pendingEvents_ = new ArrayList<>();
 
 
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerAuth.java
Patch:
@@ -127,8 +127,7 @@ public void onError(ServerError serverError)
 
    // save previous form as a precaution against forms which are not
    // cleaned up due to the submit handler not being called
-   private static ArrayList<FormPanel> previousUpdateCredentialsForms_ =
-                                            new ArrayList<FormPanel>();
+   private static ArrayList<FormPanel> previousUpdateCredentialsForms_ = new ArrayList<>();
 
    private void safeCleanupPreviousUpdateCredentials()
    {

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplication.java
Patch:
@@ -90,7 +90,7 @@ public ShinyApplication(EventBus eventBus,
       currentViewType_ = UserPrefs.SHINY_VIEWER_TYPE_NONE;
       dependencyManager_ = dependencyManager;
       interrupt_ = interrupt;
-      params_ = new ArrayList<ShinyApplicationParams>();
+      params_ = new ArrayList<>();
       
       eventBus_.addHandler(ShinyApplicationStatusEvent.TYPE, this);
       eventBus_.addHandler(LaunchShinyApplicationEvent.TYPE, this);

File: src/gwt/src/org/rstudio/studio/client/shiny/events/LaunchShinyApplicationEvent.java
Patch:
@@ -30,7 +30,7 @@ public interface Handler extends EventHandler
    }
 
    public static final GwtEvent.Type<LaunchShinyApplicationEvent.Handler> TYPE =
-      new GwtEvent.Type<LaunchShinyApplicationEvent.Handler>();
+      new GwtEvent.Type<>();
    
    public LaunchShinyApplicationEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/shiny/events/ShinyApplicationStatusEvent.java
Patch:
@@ -30,8 +30,7 @@ public interface Handler extends EventHandler
       void onShinyApplicationStatus(ShinyApplicationStatusEvent event);
    }
 
-   public static final GwtEvent.Type<ShinyApplicationStatusEvent.Handler> TYPE =
-      new GwtEvent.Type<ShinyApplicationStatusEvent.Handler>();
+   public static final GwtEvent.Type<ShinyApplicationStatusEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public ShinyApplicationStatusEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyViewerTypePopupMenu.java
Patch:
@@ -41,9 +41,9 @@ public ShinyViewerTypePopupMenu(Commands commands,
       addSeparator();
       addItem(commands.shinyRunInBrowser().createMenuItem(false));
       addSeparator();
-      addItem(new UserPrefMenuItem<Boolean>(prefs.shinyBackgroundJobs(), 
+      addItem(new UserPrefMenuItem<>(prefs.shinyBackgroundJobs(), 
             false, "In R Console", prefs));
-      addItem(new UserPrefMenuItem<Boolean>(prefs.shinyBackgroundJobs(), 
+      addItem(new UserPrefMenuItem<>(prefs.shinyBackgroundJobs(), 
             true, "In Background Job", prefs));
       addSeparator();
       addItem(commands.shinyRecordTest().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/workbench/BrowseAddinsDialog.java
Patch:
@@ -102,11 +102,11 @@ public Object getKey(RAddin addin)
          }
       };
       
-      table_ = new RStudioDataGrid<RAddin>(1000, RES, keyProvider_);
+      table_ = new RStudioDataGrid<>(1000, RES, keyProvider_);
       table_.setWidth("500px");
       table_.setHeight("400px");
       
-      selectionModel_ = new SingleSelectionModel<RAddin>();
+      selectionModel_ = new SingleSelectionModel<>();
       selectionModel_.addSelectionChangeHandler(new SelectionChangeEvent.Handler()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/MRUList.java
Patch:
@@ -133,7 +133,7 @@ private void updateCommands()
    protected void manageCommands(List<String> entries, AppCommand[] commands)
    {
       // optionally transform paths
-      ArrayList<String> transformed = new ArrayList<String>();
+      ArrayList<String> transformed = new ArrayList<>();
       for (String entry : entries)
          transformed.add(transformMruEntryPath(entry));
 
@@ -169,7 +169,7 @@ protected AppCommand[] getMruCommands()
       return mruCmds_;
    }
 
-   private final ArrayList<String> mruEntries_ = new ArrayList<String>();
+   private final ArrayList<String> mruEntries_ = new ArrayList<>();
    private final AppCommand[] mruCmds_;
    private final AppCommand clearCommand_;
    private final WorkbenchList mruList_;

File: src/gwt/src/org/rstudio/studio/client/workbench/addins/Addins.java
Patch:
@@ -179,7 +179,7 @@ public void onError(ServerError error)
          {
             server_.executeRAddinNonInteractively(
                   addin.getId(),
-                  new SimpleRequestCallback<Void>("Error Executing Addin", true));
+                  new SimpleRequestCallback<>("Error Executing Addin", true));
          }
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearch.java
Patch:
@@ -227,6 +227,5 @@ public void detachEventBusHandlers()
    private final EventBus events_;
    
    private Observer observer_ = null;
-   private ArrayList<HandlerRegistration> eventBusHandlers_ = 
-                                 new ArrayList<HandlerRegistration>();
+   private ArrayList<HandlerRegistration> eventBusHandlers_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/events/ListChangedEvent.java
Patch:
@@ -42,7 +42,7 @@ public ListChangedEvent(JsObject eventData)
       name_ = eventData.getString("name");
 
       JsArrayString list = eventData.getObject("list");
-      list_ = new ArrayList<String>();
+      list_ = new ArrayList<>();
       for (int i=0; i<list.length(); i++)
          list_.add(list.get(i));
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/model/EventBasedChangeTracker.java
Patch:
@@ -44,7 +44,7 @@ public void reset()
 
    public ChangeTracker fork()
    {
-      EventBasedChangeTracker<T> ebct = new EventBasedChangeTracker<T>(source_);
+      EventBasedChangeTracker<T> ebct = new EventBasedChangeTracker<>(source_);
       ebct.changed_ = changed_;
       return ebct;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/model/RemoteFileSystemContext.java
Patch:
@@ -79,7 +79,7 @@ public void cd(String relativeOrAbsolutePath, final String fallbackPath)
 
       final FileSystemItem newPathEntry = FileSystemItem.createDir(newPath);
       
-      final ArrayList<FileSystemItem> fsi = new ArrayList<FileSystemItem>();
+      final ArrayList<FileSystemItem> fsi = new ArrayList<>();
 
       server_.listFiles(
             newPathEntry,

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchLists.java
Patch:
@@ -39,7 +39,7 @@ private native final JsArrayString getListNative(String name) /*-{
    
    private ArrayList<String> convertList(JsArrayString jsList)
    {
-      ArrayList<String> list = new ArrayList<String>();
+      ArrayList<String> list = new ArrayList<>();
       for (int i=0; i<jsList.length(); i++)
          list.add(jsList.get(i));
       return list;

File: src/gwt/src/org/rstudio/studio/client/workbench/model/helper/ClientStateValue.java
Patch:
@@ -67,7 +67,7 @@ protected void finishInit(ClientInitState state)
    {
       JsObject grp = state.peek(group_);
       T obj = doGet(grp, name_);
-      valueTracker_ = new ValueChangeTracker<T>(obj);
+      valueTracker_ = new ValueChangeTracker<>(obj);
       onInit(obj);
 
       EventBus evt = RStudioGinjector.INSTANCE.getEventBus();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/events/UserPrefsChangedEvent.java
Patch:
@@ -22,7 +22,7 @@
 @JavaScriptSerializable
 public class UserPrefsChangedEvent extends CrossWindowEvent<UserPrefsChangedHandler>
 {
-   public static final Type<UserPrefsChangedHandler> TYPE = new Type<UserPrefsChangedHandler>();
+   public static final Type<UserPrefsChangedHandler> TYPE = new Type<>();
    
    public UserPrefsChangedEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/events/UserStateChangedEvent.java
Patch:
@@ -24,7 +24,7 @@
 @JavaScriptSerializable
 public class UserStateChangedEvent extends CrossWindowEvent<UserStateChangedEvent.Handler>
 {
-   public static final Type<UserStateChangedEvent.Handler> TYPE = new Type<UserStateChangedEvent.Handler>();
+   public static final Type<UserStateChangedEvent.Handler> TYPE = new Type<>();
    
    public UserStateChangedEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/Prefs.java
Patch:
@@ -512,7 +512,7 @@ protected <T extends JavaScriptObject> PrefValue<T> object(String name,
       PrefValue<T> val = (PrefValue<T>) values_.get(name);
       if (val == null)
       {
-         val = new ObjectValue<T>(name, title, description, defaultValue);
+         val = new ObjectValue<>(name, title, description, defaultValue);
          values_.put(name, val);
       }
       return val;
@@ -525,6 +525,5 @@ protected void updatePrefs(JsArray<PrefLayer> layers)
    }
    
    private JsArray<PrefLayer> layers_;
-   private final HashMap<String, PrefValue<?>> values_ =
-         new HashMap<String, PrefValue<?>>();
+   private final HashMap<String, PrefValue<?>> values_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -3512,7 +3512,7 @@ public void syncPrefs(String layer, JsObject source)
    }
    public List<PrefValue<?>> allPrefs()
    {
-      ArrayList<PrefValue<?>> prefs = new ArrayList<PrefValue<?>>();
+      ArrayList<PrefValue<?>> prefs = new ArrayList<>();
       prefs.add(runRprofileOnResume());
       prefs.add(saveWorkspace());
       prefs.add(loadWorkspace());

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -566,7 +566,7 @@ public void syncPrefs(String layer, JsObject source)
    }
    public List<PrefValue<?>> allPrefs()
    {
-      ArrayList<PrefValue<?>> prefs = new ArrayList<PrefValue<?>>();
+      ArrayList<PrefValue<?>> prefs = new ArrayList<>();
       prefs.add(contextId());
       prefs.add(autoCreatedProfile());
       prefs.add(theme());

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -571,7 +571,7 @@ private boolean getRestoreProjectRVersion()
 
    private void initializeGraphicsBackendWidget()
    {
-      Map<String, String> valuesToLabelsMap = new HashMap<String, String>();
+      Map<String, String> valuesToLabelsMap = new HashMap<>();
       valuesToLabelsMap.put(UserPrefs.GRAPHICS_BACKEND_DEFAULT, " (Default)");
       valuesToLabelsMap.put(UserPrefs.GRAPHICS_BACKEND_QUARTZ,    "Quartz");
       valuesToLabelsMap.put(UserPrefs.GRAPHICS_BACKEND_WINDOWS,   "Windows");

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/LineEndingsSelectWidget.java
Patch:
@@ -39,7 +39,7 @@ public LineEndingsSelectWidget(boolean includeDefault)
 
    private static String[] getLineEndingsCaptions(boolean includeDefault)
    {
-      ArrayList<String> captions = new ArrayList<String>();
+      ArrayList<String> captions = new ArrayList<>();
       if (includeDefault)
          captions.add("(Use Default)");
       captions.add("None");
@@ -52,7 +52,7 @@ private static String[] getLineEndingsCaptions(boolean includeDefault)
    
    private static String[] getLineEndingsValues(boolean includeDefault)
    {
-      ArrayList<String> values = new ArrayList<String>();
+      ArrayList<String> values = new ArrayList<>();
       if (includeDefault)
          values.add(UserPrefs.LINE_ENDING_CONVERSION_DEFAULT);
       values.add(UserPrefs.LINE_ENDING_CONVERSION_PASSTHROUGH);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/SpellingPreferencesPane.java
Patch:
@@ -106,7 +106,7 @@ private void addUserDictionariesEditor(WorkbenchListManager workbenchListManager
          userDictLabel.setText(kUserDictionary + StringUtil.formatGeneralNumber(entries) + " words");
       };
       
-      final ArrayList<String> userDictWords = new ArrayList<String>();
+      final ArrayList<String> userDictWords = new ArrayList<>();
       WorkbenchList userDict = workbenchListManager.getUserDictionaryList();
       userDict.addListChangedHandler((e) -> {
          userDictWords.clear();
@@ -133,7 +133,7 @@ private void addUserDictionariesEditor(WorkbenchListManager workbenchListManager
                if (dictionary != null)
                {
                   List<String> dictSplitItems = Arrays.asList(dictionary.split("\n"));
-                  ArrayList<String> dictWords = new ArrayList<String>();
+                  ArrayList<String> dictWords = new ArrayList<>();
                   for (String item : dictSplitItems)
                   {
                      item = item.trim();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/python/PythonInterpreterSelectionDialog.java
Patch:
@@ -32,7 +32,7 @@ public PythonInterpreterSelectionDialog(final JsArray<PythonInterpreter> interpr
       super("Python Interpreters", Roles.getDialogRole(), operation);
       setOkButtonCaption("Select");
       
-      widgets_ = new WidgetListBox<PythonInterpreterListEntryUi>();
+      widgets_ = new WidgetListBox<>();
       widgets_.setHeight("420px");
       widgets_.setAriaLabel("Python Interpreters");
       

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/zotero/ZoteroConnectionWidget.java
Patch:
@@ -36,13 +36,13 @@ public ZoteroConnectionWidget(PreferencesDialogResources res, boolean includeHel
    
       HorizontalPanel panel = new HorizontalPanel();
       
-      ArrayList<String> options = new ArrayList<String>();
+      ArrayList<String> options = new ArrayList<>();
       options.add("(None)");
       if (!webOnly())
          options.add("Local");
       options.add("Web");
       
-      ArrayList<String> values = new ArrayList<String>();
+      ArrayList<String> values = new ArrayList<>();
       values.add(UserStateAccessor.ZOTERO_CONNECTION_TYPE_NONE);
       if (!webOnly())
          values.add(UserStateAccessor.ZOTERO_CONNECTION_TYPE_LOCAL);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/zotero/ZoteroLibrariesWidget.java
Patch:
@@ -47,7 +47,7 @@ public ZoteroLibrariesWidget(PanmirrorZoteroServerOperations server, boolean inc
       VerticalPanel panel = new VerticalPanel();
       panel.addStyleName(RES.styles().librariesWidget());
       
-      ArrayList<String> options = new ArrayList<String>();
+      ArrayList<String> options = new ArrayList<>();
       
       if (includeUseDefault)
          options.add(USE_DEFAULT);

File: src/gwt/src/org/rstudio/studio/client/workbench/snippets/ui/EditSnippetsDialog.java
Patch:
@@ -113,7 +113,7 @@ protected Widget createMainWidget()
       panel_.setHeight(size.height + "px");
       
       // snippet types
-      snippetTypes_ = new WidgetListBox<EditableSnippets>();
+      snippetTypes_ = new WidgetListBox<>();
       snippetTypes_.addChangeHandler(new ChangeHandler() {
          @Override
          public void onChange(ChangeEvent event)
@@ -306,8 +306,7 @@ private void recordEditorState()
    private boolean editorDirty_ = false;
    private EditableSnippets activeSnippets_ = null;
    
-   private final ArrayList<HandlerRegistration> releaseOnDismiss_ =
-         new ArrayList<HandlerRegistration>();
+   private final ArrayList<HandlerRegistration> releaseOnDismiss_ = new ArrayList<>();
    
    private EventBus events_;
    private GlobalDisplay globalDisplay_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsPresenter.java
Patch:
@@ -614,8 +614,8 @@ public boolean test(Connection connection)
    private Connection exploredConnection_;
    private Connection lastExploredConnection_;
    
-   private ArrayList<Connection> allConnections_ = new ArrayList<Connection>();
-   private ArrayList<ConnectionId> activeConnections_ = new ArrayList<ConnectionId>();
+   private ArrayList<Connection> allConnections_ = new ArrayList<>();
+   private ArrayList<ConnectionId> activeConnections_ = new ArrayList<>();
    
    private static boolean installersUpdated_ = false;
    private static String installersWarning_ = null;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionObjectSpecifier.java
Patch:
@@ -24,7 +24,7 @@ public class ConnectionObjectSpecifier
 {
    public ConnectionObjectSpecifier()
    {
-      containers_ = new ArrayList<ConnectionPathEntry>();
+      containers_ = new ArrayList<>();
    }
    
    public ConnectionObjectSpecifier(String name, String type)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/NewConnectionContext.java
Patch:
@@ -36,7 +36,7 @@ public final native NewConnectionInfo getConnectionsItem(int index) /*-{
 
    public final ArrayList<NewConnectionInfo> getConnectionsList()
    {
-      ArrayList<NewConnectionInfo> result = new ArrayList<NewConnectionInfo>(getConnectionsLength());
+      ArrayList<NewConnectionInfo> result = new ArrayList<>(getConnectionsLength());
       for (int i = 0; i < getConnectionsLength(); i++)
          result.add(getConnectionsItem(i));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetDialog.java
Patch:
@@ -144,5 +144,5 @@ public static void ensureStylesInjected()
    
    private NewConnectionInfo newConnectionInfo_;
    private ArrayList<NewConnectionSnippetParts> initialConfig_;
-   HashMap<String, String> partsKeyValues_ = new HashMap<String, String>();
+   HashMap<String, String> partsKeyValues_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ObjectBrowser.java
Patch:
@@ -124,8 +124,7 @@ public void onAttach()
          
          // if we got here, the user has clicked Show More, so scroll to the
          // bottom when they're done
-         final Value<HandlerRegistration> registration = 
-               new Value<HandlerRegistration>(null);
+         final Value<HandlerRegistration> registration = new Value<>(null);
          registration.setValue(scrollPanel_.addScrollHandler(e -> 
          {
             scrollPanel_.scrollToBottom();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ShellInputAnimator.java
Patch:
@@ -124,7 +124,6 @@ public boolean execute()
    
    private InputEditorDisplay display_;
    
-   private ArrayList<InputAnimator> pendingAnimatedInput_ =
-      new ArrayList<InputAnimator>();
+   private ArrayList<InputAnimator> pendingAnimatedInput_ = new ArrayList<>();
 
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionCache.java
Patch:
@@ -41,7 +41,7 @@ public class CompletionCache
 {
    public CompletionCache()
    {
-      cache_ = new SafeMap<String, Completions>();
+      cache_ = new SafeMap<>();
    }
    
    public boolean satisfyRequest(String line,
@@ -115,7 +115,7 @@ private Completions narrow(String line,
       }
       
       // Finally, sort these based on score
-      List<Integer> indices = new ArrayList<Integer>();
+      List<Integer> indices = new ArrayList<>();
       for (int i = 0, n = completionsNarrow.size(); i < n; i++)
          indices.add(i);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionListPopupPanel.java
Patch:
@@ -26,7 +26,7 @@ public class CompletionListPopupPanel<TItem> extends ThemedPopupPanel
    public CompletionListPopupPanel(TItem[] entries)
    {
       super(true);
-      list_ = new CompletionList<TItem>(entries, 10, true, true);
+      list_ = new CompletionList<>(entries, 10, true, true);
       setWidget(list_);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManagerBase.java
Patch:
@@ -82,7 +82,7 @@ public CompletionManagerBase(CompletionPopupDisplay popup,
       completionCache_ = new CompletionCache();
       suggestTimer_ = new SuggestionTimer();
       helpTimer_ = new HelpTimer();
-      handlers_ = new ArrayList<HandlerRegistration>();
+      handlers_ = new ArrayList<>();
       snippets_ = new SnippetHelper((AceEditor) docDisplay, context.getId());
       
       // deferred so that handlers are toggled after subclasses have finished
@@ -137,7 +137,7 @@ public void onCompletionResponseReceived(CompletionRequestContext.Data data,
          completionCache_.store(line, completions);
       
       int n = completions.getCompletions().length();
-      List<QualifiedName> names = new ArrayList<QualifiedName>();
+      List<QualifiedName> names = new ArrayList<>();
       for (int i = 0; i < n; i++)
       {
          names.add(new QualifiedName(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/DelegatingCompletionManager.java
Patch:
@@ -35,7 +35,7 @@ public abstract class DelegatingCompletionManager implements CompletionManager
    public DelegatingCompletionManager(DocDisplay docDisplay, CompletionContext context)
    {
       docDisplay_ = docDisplay;
-      completionManagerMap_ = new HashMap<Mode, CompletionManager>();
+      completionManagerMap_ = new HashMap<>();
       nullManager_ = new NullCompletionManager();
       
       if (docDisplay_ instanceof AceEditor)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HelpStrategy.java
Patch:
@@ -38,7 +38,7 @@ public class HelpStrategy
    public HelpStrategy(CodeToolsServerOperations server)
    {
       server_ = server;
-      cache_ = new HashMap<QualifiedName, ParsedInfo>();
+      cache_ = new HashMap<>();
    }
    
    public void showHelpTopic(final QualifiedName selectedItem)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HistoryCompletionManager.java
Patch:
@@ -262,8 +262,7 @@ public void onResponseReceived(RpcObjectList<HistoryEntry> resp)
 
          if (resp.length() == 0)
          {
-            popup_ = new CompletionListPopupPanel<HistoryMatch>(
-                  new HistoryMatch[0]);
+            popup_ = new CompletionListPopupPanel<>(new HistoryMatch[0]);
             popup_.setText("(No matching commands)");
             mode_ = PopupMode.PopupNoResults;
          }
@@ -272,7 +271,7 @@ public void onResponseReceived(RpcObjectList<HistoryEntry> resp)
             HistoryMatch[] entries = new HistoryMatch[resp.length()];
             for (int i = 0; i < entries.length; i++)
                entries[i] = new HistoryMatch(resp.get(entries.length - i - 1).getCommand(), text_, i);
-            popup_ = new CompletionListPopupPanel<HistoryMatch>(entries);
+            popup_ = new CompletionListPopupPanel<>(entries);
             mode_ = desiredMode_;
          }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/StanCompletionManager.java
Patch:
@@ -102,7 +102,7 @@ public boolean getCompletions(String line, CompletionRequestContext context)
    protected void addExtraCompletions(String token,
                                       List<QualifiedName> completions)
    {
-      Set<String> discoveredIdentifiers = new HashSet<String>();
+      Set<String> discoveredIdentifiers = new HashSet<>();
       
       Token cursorToken = docDisplay_.getTokenAt(docDisplay_.getCursorPosition());
       TokenIterator it = docDisplay_.createTokenIterator();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/events/SuppressNextShellFocusEvent.java
Patch:
@@ -70,6 +70,6 @@ protected void dispatch(Handler handler)
       handler.onSuppressNextShellFocus(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -496,7 +496,7 @@ private void cleanPreviewResources()
       {
          server_.previewDataImportClean(
                getOptions(),
-               new ErrorLoggingServerRequestCallback<Void>());
+               new ErrorLoggingServerRequestCallback<>());
       }
       
       localFiles_ = null;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportColumnTypesMenu.java
Patch:
@@ -82,9 +82,9 @@ public DataImportColumnTypesMenu()
       super(true);
       setWidget(uiBinder.createAndBindUi(this));
       
-      menuItemsMap_ = new HashMap<String, MenuItem>();
+      menuItemsMap_ = new HashMap<>();
       
-      menuItems_ = new ArrayList<MenuItem>();
+      menuItems_ = new ArrayList<>();
       menuItems_.add(new MenuItem("include", (Widget)include_));
       menuItems_.add(new MenuItem("skip", (Widget)skip_));
       menuItems_.add(new MenuItem("only", (Widget)only_));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/DebugSourceCompletedEvent.java
Patch:
@@ -28,8 +28,7 @@ public interface Handler extends EventHandler
       void onDebugSourceCompleted(DebugSourceCompletedEvent event);
    }
 
-   public static final GwtEvent.Type<DebugSourceCompletedEvent.Handler> TYPE =
-      new GwtEvent.Type<DebugSourceCompletedEvent.Handler>();
+   public static final GwtEvent.Type<DebugSourceCompletedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public DebugSourceCompletedEvent(DebugSourceResult result)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/EnvironmentObjectAssignedEvent.java
Patch:
@@ -28,8 +28,7 @@ public interface Handler extends EventHandler
       void onEnvironmentObjectAssigned(EnvironmentObjectAssignedEvent event);
    }
 
-   public static final GwtEvent.Type<EnvironmentObjectAssignedEvent.Handler> TYPE =
-      new GwtEvent.Type<EnvironmentObjectAssignedEvent.Handler>();
+   public static final GwtEvent.Type<EnvironmentObjectAssignedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public EnvironmentObjectAssignedEvent(RObject objectInfo)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/EnvironmentObjectRemovedEvent.java
Patch:
@@ -25,8 +25,7 @@ public interface Handler extends EventHandler
       void onEnvironmentObjectRemoved(EnvironmentObjectRemovedEvent event);
    }
 
-   public static final GwtEvent.Type<EnvironmentObjectRemovedEvent.Handler> TYPE =
-      new GwtEvent.Type<EnvironmentObjectRemovedEvent.Handler>();
+   public static final GwtEvent.Type<EnvironmentObjectRemovedEvent.Handler> TYPE = new GwtEvent.Type<>();
    
    public EnvironmentObjectRemovedEvent(String objectName)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -124,7 +124,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
                                                          14, Style.Unit.PX);
       
       observer_ = observer;
-      callFrameItems_ = new ArrayList<CallFrameItem>();
+      callFrameItems_ = new ArrayList<>();
    }
 
    public void setCallFrames(JsArray<CallFrame> frameList, int contextDepth)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -86,7 +86,7 @@ public EnvironmentObjects(EnvironmentObjectsObserver observer)
       environmentName_ = EnvironmentPane.GLOBAL_ENVIRONMENT_NAME;
 
       objectDisplayType_ = OBJECT_LIST_VIEW;
-      objectDataProvider_ = new ListDataProvider<RObjectEntry>();
+      objectDataProvider_ = new ListDataProvider<>();
       objectSort_ = new RObjectEntrySort();
 
       // timer used to scroll table element into view
@@ -214,7 +214,7 @@ public void addObjects(JsArray<RObject> objects)
    {
       // create an entry for each object and sort the array
       int numObjects = objects.length();
-      ArrayList<RObjectEntry> objectEntryList = new ArrayList<RObjectEntry>();
+      ArrayList<RObjectEntry> objectEntryList = new ArrayList<>();
       for (int i = 0; i < numObjects; i++)
       {
          RObjectEntry entry = entryFromRObject(objects.get(i));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/RObjectEntry.java
Patch:
@@ -126,8 +126,8 @@ private boolean rObjectHasDataClass()
 
    public static final String NO_VALUE = "NO_VALUE";
    
-   private static final Set<String> DATA_CLASSES = new HashSet<String>();
-   private static final Set<String> HIERARCHICAL_CLASSES = new HashSet<String>();
+   private static final Set<String> DATA_CLASSES = new HashSet<>();
+   private static final Set<String> HIERARCHICAL_CLASSES = new HashSet<>();
    
    static {
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -39,7 +39,6 @@
 import org.rstudio.studio.client.common.filetypes.events.OpenFileInBrowserEvent;
 import org.rstudio.studio.client.common.filetypes.events.OpenFileInBrowserHandler;
 import org.rstudio.studio.client.common.filetypes.events.RenameSourceFileEvent;
-import org.rstudio.studio.client.common.rstudioapi.model.RStudioAPIServerOperations;
 import org.rstudio.studio.client.events.RStudioApiRequestEvent;
 import org.rstudio.studio.client.server.*;
 import org.rstudio.studio.client.workbench.WorkbenchContext;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesCopy.java
Patch:
@@ -40,8 +40,7 @@ public void execute(ArrayList<FileSystemItem> files,
                        Command completedCommand)
    {
       // copy list so we don't modify passed list
-      ArrayList<FileSystemItem> filesQueue = new ArrayList<FileSystemItem>(
-                                                               files);
+      ArrayList<FileSystemItem> filesQueue = new ArrayList<>(files);
       
       // begin copy sequence (this method keeps calling itself until
       // the queue of files is empty)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/events/DirectoryNavigateEvent.java
Patch:
@@ -36,8 +36,7 @@ public final native boolean getActivate() /*-{
       }-*/;      
    }
    
-   public static final GwtEvent.Type<DirectoryNavigateHandler> TYPE =
-      new GwtEvent.Type<DirectoryNavigateHandler>();
+   public static final GwtEvent.Type<DirectoryNavigateHandler> TYPE = new GwtEvent.Type<>();
    
    public DirectoryNavigateEvent(Data data)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/events/FileChangeEvent.java
Patch:
@@ -19,8 +19,7 @@
 
 public class FileChangeEvent extends GwtEvent<FileChangeHandler>
 {
-   public static final GwtEvent.Type<FileChangeHandler> TYPE =
-      new GwtEvent.Type<FileChangeHandler>();
+   public static final GwtEvent.Type<FileChangeHandler> TYPE = new GwtEvent.Type<>();
    
    public FileChangeEvent(FileChange fileChange)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/events/ShowFolderEvent.java
Patch:
@@ -19,8 +19,7 @@
 
 public class ShowFolderEvent extends GwtEvent<ShowFolderHandler>
 {
-   public static final Type<ShowFolderHandler> TYPE =
-         new Type<ShowFolderHandler>();
+   public static final Type<ShowFolderHandler> TYPE = new Type<>();
 
    public ShowFolderEvent(FileSystemItem path)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/ToolbarLinkMenu.java
Patch:
@@ -112,7 +112,7 @@ public void clearLinks()
    
    public ArrayList<Link> getLinks()
    {
-      return new ArrayList<Link>(links_);
+      return new ArrayList<>(links_);
    }
 
    public HandlerRegistration addSelectionHandler(
@@ -173,7 +173,7 @@ public void fireEvent(GwtEvent<?> event)
    private final ToolbarPopupMenu menu_;
    private final MenuItem[] pre_;
    private final MenuItem[] post_;
-   private final ArrayList<Link> links_ = new ArrayList<Link>();
+   private final ArrayList<Link> links_ = new ArrayList<>();
    private final int maxLinks_;
    private boolean top_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/model/VirtualHistory.java
Patch:
@@ -103,6 +103,6 @@ private void saveScrollPosition()
    }
    
    private final Frame frame_;
-   private List<Data> stack_ = new ArrayList<Data>();
+   private List<Data> stack_ = new ArrayList<>();
    private int pos_ = -1;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/search/HelpSearchOracle.java
Patch:
@@ -48,8 +48,7 @@ public void onResponseReceived(JsArrayString suggestions)
          {
             int maxCount = Math.min(suggestions.length(), request.getLimit());
 
-            ArrayList<SearchSuggestion> results =
-               new ArrayList<SearchSuggestion>();
+            ArrayList<SearchSuggestion> results = new ArrayList<>();
             for (int i = 0; i< maxCount; i++)
                results.add(new SearchSuggestion(suggestions.get(i)));
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/events/FetchCommandsEvent.java
Patch:
@@ -18,8 +18,7 @@
 
 public class FetchCommandsEvent extends GwtEvent<FetchCommandsHandler>
 {
-   public static final Type<FetchCommandsHandler> TYPE =
-         new Type<FetchCommandsHandler>();
+   public static final Type<FetchCommandsHandler> TYPE = new Type<>();
    
    @Override
    public Type<FetchCommandsHandler> getAssociatedType()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/events/HistoryEntriesAddedEvent.java
Patch:
@@ -20,8 +20,7 @@
 
 public class HistoryEntriesAddedEvent extends GwtEvent<HistoryEntriesAddedHandler>
 {
-   public static final GwtEvent.Type<HistoryEntriesAddedHandler> TYPE =
-      new GwtEvent.Type<HistoryEntriesAddedHandler>();
+   public static final GwtEvent.Type<HistoryEntriesAddedHandler> TYPE = new GwtEvent.Type<>();
    
    public HistoryEntriesAddedEvent(RpcObjectList<HistoryEntry> entries)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryPane.java
Patch:
@@ -575,7 +575,7 @@ public void requestSuggestions(Request request,
          {
             callback.onSuggestionsReady(
                   request,
-                  new Response(new ArrayList<Suggestion>()));
+                  new Response(new ArrayList<>()));
          }
       });
       searchWidget_.addKeyDownHandler(new KeyDownHandler()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/JobManager.java
Patch:
@@ -386,7 +386,7 @@ private void showJobLauncherDialog(FileSystemItem path, FileSystemItem workingDi
             code,
             spec ->
             {
-               server_.startJob(spec, new ErrorLoggingServerRequestCallback<String>());
+               server_.startJob(spec, new ErrorLoggingServerRequestCallback<>());
             }
       );
       
@@ -409,7 +409,7 @@ private void showJobLauncherDialog(FileSystemItem path)
                }
 
                // tell the server to start running this script
-               server_.startJob(spec, new ErrorLoggingServerRequestCallback<String>());
+               server_.startJob(spec, new ErrorLoggingServerRequestCallback<>());
             });
       
       dialog.showModal();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -14,7 +14,6 @@
  */
 package org.rstudio.studio.client.workbench.views.output.find;
 
-import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.dom.client.NativeEvent;
 import com.google.gwt.dom.client.TableRowElement;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/LintMarkers.java
Patch:
@@ -52,7 +52,7 @@ public LintMarkers(Document document,
                       JsArray<AceAnnotation> annotations)
    {
       document_ = document;
-      annotations_ = new ArrayList<AnchoredAceAnnotation>();
+      annotations_ = new ArrayList<>();
       annotations_.ensureCapacity(annotations.length());
       for (int i = 0; i < annotations.length(); i++)
          annotations_.set(i, new AnchoredAceAnnotation(annotations.get(i)));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/events/PackageStateChangedEvent.java
Patch:
@@ -21,8 +21,7 @@
 public class PackageStateChangedEvent extends
                               GwtEvent<PackageStateChangedHandler>
 {
-   public static final GwtEvent.Type<PackageStateChangedHandler> TYPE =
-      new GwtEvent.Type<PackageStateChangedHandler>();
+   public static final GwtEvent.Type<PackageStateChangedHandler> TYPE = new GwtEvent.Type<>();
    
    public PackageStateChangedEvent(PackageState newState)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/events/PackageStatusChangedEvent.java
Patch:
@@ -20,8 +20,7 @@
 public class PackageStatusChangedEvent 
                      extends GwtEvent<PackageStatusChangedHandler>
 {
-   public static final GwtEvent.Type<PackageStatusChangedHandler> TYPE =
-      new GwtEvent.Type<PackageStatusChangedHandler>();
+   public static final GwtEvent.Type<PackageStatusChangedHandler> TYPE = new GwtEvent.Type<>();
    
    public PackageStatusChangedEvent(PackageStatus packageStatus)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/CheckForUpdatesDialog.java
Patch:
@@ -98,8 +98,8 @@ public String getValue(PendingAction action)
       table.addColumn(availableColumn, "Available");
       table.setColumnWidth(availableColumn, 28, Unit.PCT);
 
-      ImageButtonColumn<PendingAction> newsColumn = 
-            new ImageButtonColumn<PendingAction>(
+      ImageButtonColumn<PendingAction> newsColumn =
+            new ImageButtonColumn<>(
                   new ImageResource2x(ThemeResources.INSTANCE.newsButton2x()),
                   new OperationWithInput<PendingAction>() {
                      

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/PackageActionConfirmationDialog.java
Patch:
@@ -77,7 +77,7 @@ public PackageActionConfirmationDialog(
    @Override
    protected ArrayList<T> collectInput()
    {
-      ArrayList<T> actions = new ArrayList<T>();
+      ArrayList<T> actions = new ArrayList<>();
       for (PendingAction action : actionsDataProvider_.getList())
       {
          if (action.getPerformAction().getBool())
@@ -219,7 +219,7 @@ public LabeledBoolean getPerformAction()
    private void setGlobalPerformAction(String label, Boolean performAction)
    {
       List<PendingAction> actions = actionsDataProvider_.getList();
-      ArrayList<PendingAction> newActions = new ArrayList<PendingAction>();
+      ArrayList<PendingAction> newActions = new ArrayList<>();
       for(PendingAction action : actions)
          newActions.add(new PendingAction(action.getActionInfo(), new LabeledBoolean(label, performAction)));
       actionsDataProvider_.setList(newActions);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/LocatorPanel.java
Patch:
@@ -180,7 +180,7 @@ private void showFeedbackAt(Point p)
          public void run()
          {
             feedbackTimer_ = null;
-            ArrayList<Widget> widgets = new ArrayList<Widget>();
+            ArrayList<Widget> widgets = new ArrayList<>();
             widgets.add(feedbackImage_);
             feedbackAnimation_ = new FadeOutAnimation(widgets,
                                                       new Command() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/Plots.java
Patch:
@@ -133,7 +133,7 @@ public void onSelection(SelectionEvent<Point> e)
 
             }
 
-            server.locatorCompleted(p, new SimpleRequestCallback<Void>());
+            server.locatorCompleted(p, new SimpleRequestCallback<>());
          }
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsPdfDialog.java
Patch:
@@ -529,7 +529,7 @@ else if (size > kMaximumSize)
       private ListBox paperSizeListBox_;
       private final TextBox widthTextBox_;
       private final TextBox heightTextBox_;
-      private final List<PaperSize> paperSizes_ = new ArrayList<PaperSize>(); 
+      private final List<PaperSize> paperSizes_ = new ArrayList<>(); 
       private final NumberFormat sizeFormat_ = NumberFormat.getFormat("##0.00");
       
       private final double kMimimumSize = 3.0;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -55,7 +55,6 @@
 import org.rstudio.studio.client.events.GetEditorContextEvent;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntryProvider;
 import org.rstudio.studio.client.palette.model.CommandPaletteEntrySource;
-import org.rstudio.studio.client.palette.model.CommandPaletteItem;
 import org.rstudio.studio.client.rmarkdown.model.RmdChosenTemplate;
 import org.rstudio.studio.client.rmarkdown.model.RmdFrontMatter;
 import org.rstudio.studio.client.rmarkdown.model.RmdOutputFormat;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindow.java
Patch:
@@ -267,7 +267,7 @@ private void saveUnsavedDocuments(JsArrayString idArray, Command onCompleted)
       Set<String> ids = null;
       if (idArray != null)
       {
-         ids = new HashSet<String>();
+         ids = new HashSet<>();
          for (String id : JsUtil.asIterable(idArray))
             ids.add(id);
       }
@@ -279,8 +279,7 @@ private void handleUnsavedChangesBeforeExit(JavaScriptObject jsoItems,
          Command onCompleted)
    {
       JsArray<UnsavedChangesItem> items = jsoItems.cast();
-      ArrayList<UnsavedChangesTarget> targets = 
-            new ArrayList<UnsavedChangesTarget>();
+      ArrayList<UnsavedChangesTarget> targets = new ArrayList<>();
       for (int i = 0; i < items.length(); i++)
       {
          targets.add(items.get(i));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTargetInlineChunkExecution.java
Patch:
@@ -62,7 +62,7 @@ public EditingTargetInlineChunkExecution(DocDisplay display, String docId)
       
       display_ = display;
       docId_ = docId;
-      outputs_ = new HashMap<String, ChunkInlineOutput>();
+      outputs_ = new HashMap<>();
    }
    
    public void execute(Range range)
@@ -105,8 +105,7 @@ public void execute(Range range)
             display_.createAnchoredSelection(range.getStart(), range.getEnd()));
       
       // auto dismiss the panel when the cursor leaves the inline chunk
-      final Mutable<HandlerRegistration> cursorHandler =
-            new Mutable<HandlerRegistration>();
+      final Mutable<HandlerRegistration> cursorHandler = new Mutable<>();
       cursorHandler.set(display_.addCursorChangedHandler(
             new CursorChangedHandler()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTargetWidget.java
Patch:
@@ -53,7 +53,6 @@
 import org.rstudio.studio.client.common.filetypes.TextFileType;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.workbench.codesearch.model.SearchPathFunctionDefinition;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionManager;
@@ -176,7 +175,7 @@ public void goToHelp()
         
             server.getHelpAtCursor(
                linePos.getLine(), linePos.getPosition(),
-               new SimpleRequestCallback<Void>("Help")); 
+               new SimpleRequestCallback<>("Help")); 
          }
          
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTarget.java
Patch:
@@ -214,7 +214,7 @@ public void updateData(final DataItem data)
       
       final String oldCacheKey = getCacheKey();
 
-      HashMap<String, String> props = new HashMap<String, String>();
+      HashMap<String, String> props = new HashMap<>();
       data.fillProperties(props);
       server_.modifyDocumentProperties(
             doc_.getId(),
@@ -226,7 +226,7 @@ public void onResponseReceived(Void response)
                {
                   server_.removeCachedData(
                         oldCacheKey,
-                        new ErrorLoggingServerRequestCallback<Void>());
+                        new ErrorLoggingServerRequestCallback<>());
 
                   data.fillProperties(doc_.getProperties());
                   reloadDisplay();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1644,7 +1644,7 @@ public SpellingDoc getSpellingDoc()
    {
       // detach anchors on dispose
       ArrayList<org.rstudio.studio.client.workbench.views.source.editors.text.ace.Anchor> 
-        anchors = new ArrayList<org.rstudio.studio.client.workbench.views.source.editors.text.ace.Anchor>();
+        anchors = new ArrayList<>();
       
       return new SpellingDoc() {
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceKeyboardPreviewer.java
Patch:
@@ -115,5 +115,5 @@ private boolean onTextInput(JavaScriptObject data, String text)
       return false;
    }
    
-   private ArrayList<Handler> handlers_ = new ArrayList<Handler>();
+   private ArrayList<Handler> handlers_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputGallery.java
Patch:
@@ -73,7 +73,7 @@ public ChunkOutputGallery(
       ChunkOutputPresenter.Host host,
       ChunkOutputSize chunkOutputSize)
    {
-      pages_ = new ArrayList<ChunkOutputPage>();
+      pages_ = new ArrayList<>();
       host_ = host;
       chunkOutputSize_ = chunkOutputSize;
       initWidget(uiBinder.createAndBindUi(this));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -66,7 +66,7 @@ public ChunkOutputStream(ChunkOutputPresenter.Host host, ChunkOutputSize chunkOu
    {
       host_ = host;
       chunkOutputSize_ = chunkOutputSize;
-      metadata_ = new HashMap<Integer, JavaScriptObject>();
+      metadata_ = new HashMap<>();
 
       if (chunkOutputSize_ == ChunkOutputSize.Full) {
          getElement().getStyle().setWidth(100, Unit.PCT);
@@ -571,8 +571,8 @@ public List<ChunkOutputPage> extractPages()
       // flush any errors so they are properly accounted for
       flushQueuedErrors();
       
-      List<ChunkOutputPage> pages = new ArrayList<ChunkOutputPage>();
-      List<Widget> removed = new ArrayList<Widget>();
+      List<ChunkOutputPage> pages = new ArrayList<>();
+      List<Widget> removed = new ArrayList<>();
       for (Widget w: this)
       {
          // extract ordinal and metadata

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -114,7 +114,7 @@ public ChunkOutputWidget(String documentId, String chunkId,
       options_ = options;
       chunkOutputSize_ = chunkOutputSize;
       initWidget(uiBinder.createAndBindUi(this));
-      expansionState_ = new Value<Integer>(expansionState);
+      expansionState_ = new Value<>(expansionState);
       applyCachedEditorStyle();
       if (expansionState_.getValue() == COLLAPSED)
          setCollapsedStyles();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkSatelliteWindow.java
Patch:
@@ -43,7 +43,6 @@
 import org.rstudio.studio.client.server.QuietServerRequestCallback;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.workbench.ui.FontSizeManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.ChunkSatelliteCacheEditorStyleEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.ChunkSatelliteCodeExecutingEvent;
@@ -144,7 +143,7 @@ public void onWindowClosing(ClosingEvent arg0)
             server_.cleanReplayNotebookChunkPlots(
                chunkWindowParams_.getDocId(), 
                chunkWindowParams_.getChunkId(),
-               new QuietServerRequestCallback<Void>());
+               new QuietServerRequestCallback<>());
          }
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkWindowManager.java
Patch:
@@ -54,7 +54,7 @@ public ChunkWindowManager(
       pSatelliteManager_ = pSatelliteManager;
       events_ = events;
 
-      satelliteChunks_ = new ArrayList<Pair<String, String>>();
+      satelliteChunks_ = new ArrayList<>();
       
       if (!Satellite.isCurrentWindowSatellite())
       {
@@ -87,7 +87,7 @@ public void onChunkSatelliteOpenWindow(ChunkSatelliteOpenWindowEvent event)
    @Override
    public void onChunkSatelliteCloseAllWindow(ChunkSatelliteCloseAllWindowEvent event)
    {
-      ArrayList<Pair<String,String>> newSatelliteChunks = new ArrayList<Pair<String,String>>();
+      ArrayList<Pair<String,String>> newSatelliteChunks = new ArrayList<>();
 
       for (Pair<String, String> chunkPair : satelliteChunks_)
       {
@@ -117,7 +117,7 @@ public void onChunkSatelliteWindowOpened(ChunkSatelliteWindowOpenedEvent event)
       String docId = event.getDocId();
       String chunkId = event.getChunkId();
 
-      satelliteChunks_.add(new Pair<String, String>(docId, chunkId));
+      satelliteChunks_.add(new Pair<>(docId, chunkId));
       events_.fireEventToAllSatellites(event);
 
       ChunkSatelliteWindowRegisteredEvent registeredEvent = new ChunkSatelliteWindowRegisteredEvent(docId, chunkId);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/Fold.java
Patch:
@@ -60,7 +60,7 @@ public static String encode(ArrayList<Fold> folds)
 
    public static ArrayList<Fold> decode(String foldData)
    {
-      ArrayList<Fold> results = new ArrayList<Fold>();
+      ArrayList<Fold> results = new ArrayList<>();
       String[] chunks = foldData.split("\n");
       for (String chunk : chunks)
       {
@@ -95,7 +95,7 @@ public static JsArray<JsArrayMixed> toJs(ArrayList<Fold> folds)
 
    public static ArrayList<Fold> fromJs(JsArray<JsArrayMixed> folds)
    {
-      ArrayList<Fold> results = new ArrayList<Fold>();
+      ArrayList<Fold> results = new ArrayList<>();
       for (int i = 0; i < folds.length(); i++)
       {
          JsArrayMixed foldData = folds.get(i);
@@ -115,7 +115,7 @@ public static ArrayList<Fold> fromJs(JsArray<JsArrayMixed> folds)
     */
    public static ArrayList<Fold> flatten(JsArray<AceFold> folds)
    {
-      ArrayList<Fold> results = new ArrayList<Fold>();
+      ArrayList<Fold> results = new ArrayList<>();
       for (int i = 0; i < folds.length(); i++)
          collect(folds.get(i), results, Position.create(0, 0));
       return results;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ScopeList.java
Patch:
@@ -155,5 +155,5 @@ private void addScopes(JsArray<Scope> scopes)
       }
    }
 
-   private final ArrayList<Scope> scopes_ = new ArrayList<Scope>();
+   private final ArrayList<Scope> scopes_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -47,8 +47,8 @@ public class TextEditingTargetChunks
    public TextEditingTargetChunks(TextEditingTarget target)
    {
       target_ = target;
-      toolbars_ = new ArrayList<ChunkContextCodeUi>();
-      modifiedRanges_ = new ArrayList<Range>();
+      toolbars_ = new ArrayList<>();
+      modifiedRanges_ = new ArrayList<>();
       renderPass_ = 0;
       
       target.getDocDisplay().addScopeTreeReadyHandler(this);
@@ -210,7 +210,7 @@ private void syncAllWidgets()
    
    private void syncModifiedWidgets()
    {
-      Set<Scope> modifiedScopes = new HashSet<Scope>();
+      Set<Scope> modifiedScopes = new HashSet<>();
       
       for (Range range : modifiedRanges_)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCompilePdfHelper.java
Patch:
@@ -460,6 +460,5 @@ private String detectRootDirective(ArrayList<TexMagicComment> magicComments)
    private static final Pattern concordancePattern_ = Pattern.create(
                      "\\\\[\\s]*SweaveOpts[\\s]*{.*concordance[\\s]*=.*}");
    
-   private static HashMap<String, RnwChunkOptions> chunkOptionsCache_ = 
-                                    new HashMap<String, RnwChunkOptions>();
+   private static HashMap<String, RnwChunkOptions> chunkOptionsCache_ = new HashMap<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCppHelper.java
Patch:
@@ -19,7 +19,6 @@
 import org.rstudio.studio.client.common.filetypes.TextFileType;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTarget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionContext;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionOperation;
@@ -115,7 +114,7 @@ public void execute(String docPath, int line, int column)
                   docPath, 
                   line, 
                   column, 
-                  new CppCompletionServerRequestCallback<Void>(
+                  new CppCompletionServerRequestCallback<>(
                                           "Finding usages..."));
          }
          

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetIdleMonitor.java
Patch:
@@ -63,7 +63,7 @@ public TextEditingTargetIdleMonitor(final TextEditingTarget editingTarget,
       
       display_ = editingTarget.getDocDisplay();
       sentinel_ = sentinel;
-      monitors_ = new ArrayList<HandlerRegistration>();
+      monitors_ = new ArrayList<>();
       commands_ = target.commands;
       timer_ = new Timer()
       {
@@ -231,7 +231,7 @@ public IdleTarget(TextEditingTarget t, DocUpdateSentinel s)
       {
          target = t;
          sentinel = s;
-         commands = new HashMap<HandlerRegistration, IdleCommand>();
+         commands = new HashMap<>();
       }
       public final TextEditingTarget target;
       public final DocUpdateSentinel sentinel;
@@ -279,7 +279,7 @@ public void onPreviewNativeEvent(NativePreviewEvent preview)
          }
       });
 
-       TARGET_MAP = new SafeMap<DocDisplay, IdleTarget>();
+       TARGET_MAP = new SafeMap<>();
    }
    
    private static final int DELAY_MS = 700;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -1091,7 +1091,7 @@ public void showRequiredPackagesMissingWarning(List<String> packages)
 
       Command onInstall = () -> {
          // Form a list of all the dependencies to install
-         ArrayList<Dependency> deps = new ArrayList<Dependency>();
+         ArrayList<Dependency> deps = new ArrayList<>();
          for (String pkg: packages)
             deps.add(Dependency.cranPackage(pkg));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditorContainer.java
Patch:
@@ -176,5 +176,5 @@ private void addWidget(IsHideableWidget widget, boolean visible)
    }
   
    private final Editor editor_;
-   private ArrayList<IsHideableWidget> widgets_ = new ArrayList<IsHideableWidget>();
+   private ArrayList<IsHideableWidget> widgets_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceBackgroundHighlighter.java
Patch:
@@ -161,7 +161,7 @@ public AceBackgroundHighlighter(AceEditor editor)
       editor_ = editor;
       session_ = editor.getSession();
       
-      highlightPatterns_ = new ArrayList<HighlightPattern>();
+      highlightPatterns_ = new ArrayList<>();
       editor.addEditorModeChangedHandler(this);
       
       int n = editor.getRowCount();
@@ -455,7 +455,7 @@ private static final List<HighlightPattern> rMarkdownHighlightPatterns()
    // Static Members ----
    
    static {
-      HIGHLIGHT_PATTERN_REGISTRY = new HashMap<String, List<HighlightPattern>>();
+      HIGHLIGHT_PATTERN_REGISTRY = new HashMap<>();
       HIGHLIGHT_PATTERN_REGISTRY.put("mode/rmarkdown", rMarkdownHighlightPatterns());
       HIGHLIGHT_PATTERN_REGISTRY.put("mode/c_cpp", cStyleHighlightPatterns());
       HIGHLIGHT_PATTERN_REGISTRY.put("mode/sweave", sweaveHighlightPatterns());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -184,7 +184,7 @@ public native final <T> void onGutterMouseDown(CommandWithArg<T> command) /*-{
 
    public final HandlerRegistration delegateEventsTo(HasHandlers handlers)
    {
-      final LinkedList<JavaScriptObject> handles = new LinkedList<JavaScriptObject>();
+      final LinkedList<JavaScriptObject> handles = new LinkedList<>();
       handles.add(addDomListener(getTextInputElement(), "keydown", handlers));
       handles.add(addDomListener(getTextInputElement(), "keypress", handlers));
       handles.add(addDomListener(getTextInputElement(), "changeScrollTop", handlers));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/Tokenizer.java
Patch:
@@ -157,6 +157,6 @@ private final native Token[] doTokenize(String line) /*-{
    
    public final List<Token> tokenize(String line)
    {
-      return new ArrayList<Token>(Arrays.asList(doTokenize(line)));
+      return new ArrayList<>(Arrays.asList(doTokenize(line)));
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/assist/RChunkHeaderParser.java
Patch:
@@ -28,18 +28,18 @@ public class RChunkHeaderParser
 {
    public static Map<String, String> parse(String line)
    {
-      Map<String, String> options = new HashMap<String, String>();
+      Map<String, String> options = new HashMap<>();
       parse(line, options);
       return options;
    }
    
    public static final void parse(String line, Map<String, String> options)
    {
       // set up state
-      Mutable<String> key = new Mutable<String>();
+      Mutable<String> key = new Mutable<>();
       Consumer keyConsumer = new MutableConsumer(key);
       
-      Mutable<String> val = new Mutable<String>();
+      Mutable<String> val = new Mutable<>();
       Consumer valConsumer = new MutableConsumer(val);
       
       // determine an appropriate pattern for extracting options from

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/CursorChangedEvent.java
Patch:
@@ -19,7 +19,7 @@
 
 public class CursorChangedEvent extends GwtEvent<CursorChangedHandler>
 {
-   public static final Type<CursorChangedHandler> TYPE = new Type<CursorChangedHandler>();
+   public static final Type<CursorChangedHandler> TYPE = new Type<>();
 
    public CursorChangedEvent(Position position)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/EditorLoadedEvent.java
Patch:
@@ -32,7 +32,7 @@ public AceEditorNative getEditor()
    
    private final AceEditorNative editor_;
    
-   public static final Type<EditorLoadedHandler> TYPE = new Type<EditorLoadedHandler>();
+   public static final Type<EditorLoadedHandler> TYPE = new Type<>();
 
    @Override
    public Type<EditorLoadedHandler> getAssociatedType()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/FileTypeChangedEvent.java
Patch:
@@ -18,8 +18,7 @@
 
 public class FileTypeChangedEvent extends GwtEvent<FileTypeChangedHandler>
 {
-   public static final Type<FileTypeChangedHandler> TYPE =
-         new Type<FileTypeChangedHandler>();
+   public static final Type<FileTypeChangedHandler> TYPE = new Type<>();
 
    public FileTypeChangedEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/SourceOnSaveChangedEvent.java
Patch:
@@ -18,7 +18,7 @@
 
 public class SourceOnSaveChangedEvent extends GwtEvent<SourceOnSaveChangedHandler>
 {
-   public static final Type<SourceOnSaveChangedHandler> TYPE = new Type<SourceOnSaveChangedHandler>();
+   public static final Type<SourceOnSaveChangedHandler> TYPE = new Type<>();
 
    @Override
    public Type<SourceOnSaveChangedHandler> getAssociatedType()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/UndoRedoEvent.java
Patch:
@@ -40,6 +40,6 @@ protected void dispatch(UndoRedoHandler handler)
       handler.onUndoRedo(this);
    }
 
-   public static Type<UndoRedoHandler> TYPE = new Type<UndoRedoHandler>();
+   public static Type<UndoRedoHandler> TYPE = new Type<>();
    private final boolean redo_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/NotebookQueueState.java
Patch:
@@ -186,7 +186,7 @@ else if (chunk.getRange() != null)
       }
       else
       {
-         List<ChunkExecUnit> chunks = new ArrayList<ChunkExecUnit>();
+         List<ChunkExecUnit> chunks = new ArrayList<>();
          chunks.add(chunk);
          executeChunks("Run Chunk", chunks);
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/SetupChunkOptionsPopupPanel.java
Patch:
@@ -229,7 +229,7 @@ public void onResponseReceived(JsObject object)
    protected void synchronize()
    {
       syncSelection();
-      Map<String, String> options = new LinkedHashMap<String, String>();
+      Map<String, String> options = new LinkedHashMap<>();
       
       Set<String> keys = chunkOptions_.keySet();
       for (String key : keys)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/spelling/CheckSpelling.java
Patch:
@@ -172,8 +172,8 @@ private void findNextMisspelling()
                currentPos_,
                wrapped_ ? initialCursorPos_.getPosition() : -1);
 
-         final ArrayList<String> words = new ArrayList<String>();
-         final ArrayList<SpellingDoc.WordRange> checkWords = new ArrayList<SpellingDoc.WordRange>();
+         final ArrayList<String> words = new ArrayList<>();
+         final ArrayList<SpellingDoc.WordRange> checkWords = new ArrayList<>();
 
          SpellingDoc.WordRange lastWord = null;
          for (SpellingDoc.WordRange w : wordSource)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeChunk.java
Patch:
@@ -112,8 +112,9 @@ public VisualModeChunk(int index,
       final AceEditorNative chunkEditor = editor_.getWidget().getEditor();
       chunk.editor = Js.uncheckedCast(chunkEditor);
 
-      // Forward the R completion context from the parent editing session
+      // Forward the R and C++ completion contexts from the parent editing session
       editor_.setRCompletionContext(target_.getRCompletionContext());
+      editor_.setCppCompletionContext(target_.getCppCompletionContext());
       
       // Forward the Rnw completion context with a wrapper to adjust for the
       // position in our display; this is what allows the completion engine to

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -1341,6 +1341,8 @@ public void setChunkState(Scope chunk, int state)
    
    public static boolean isSetupChunkScope(Scope scope)
    {
+      if (scope == null)
+         return false;
       if (!scope.isChunk())
          return false;
       if (scope.getChunkLabel() == null)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -1341,6 +1341,8 @@ public void setChunkState(Scope chunk, int state)
    
    public static boolean isSetupChunkScope(Scope scope)
    {
+      if (scope == null)
+         return false;
       if (!scope.isChunk())
          return false;
       if (scope.getChunkLabel() == null)

File: src/gwt/src/org/rstudio/studio/client/common/crypto/RSAEncrypt.java
Patch:
@@ -35,9 +35,9 @@ public static void encrypt_ServerOnly(
          final String input,
          final ResponseCallback callback)
    {
-      if (Desktop.hasDesktopFrame())
+      if (Desktop.isDesktop())
       {
-         // Don't encrypt for desktop, Windows can't decrypt it.
+         // Don't encrypt for desktop sessions, Windows can't decrypt it.
          callback.onSuccess(input);
          return;
       }

File: src/gwt/src/org/rstudio/studio/client/common/crypto/RSAEncrypt.java
Patch:
@@ -35,9 +35,9 @@ public static void encrypt_ServerOnly(
          final String input,
          final ResponseCallback callback)
    {
-      if (Desktop.hasDesktopFrame())
+      if (Desktop.isDesktop())
       {
-         // Don't encrypt for desktop, Windows can't decrypt it.
+         // Don't encrypt for desktop sessions, Windows can't decrypt it.
          callback.onSuccess(input);
          return;
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1155,7 +1155,7 @@ public PrefValue<Boolean> limitVisibleConsole()
          "limit_visible_console",
          "Limit visible console output", 
          "Whether to only show a limited window of the total console output", 
-         false);
+         true);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1155,7 +1155,7 @@ public PrefValue<Boolean> limitVisibleConsole()
          "limit_visible_console",
          "Limit visible console output", 
          "Whether to only show a limited window of the total console output", 
-         true);
+         false);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeChunk.java
Patch:
@@ -231,6 +231,9 @@ public FileSystemItem getActiveFile()
       // Prevent tab from advancing into editor
       chunkEditor.getTextInputElement().setTabIndex(-1);
 
+      // Force the use of browser APIs to set focus to the input element
+      chunkEditor.useBrowserInputFocus();
+
       // Allow the editor's size to be determined by its content (these
       // settings trigger an auto-growing behavior), up to a max of 1000
       // lines.

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJax.java
Patch:
@@ -218,6 +218,9 @@ public void renderLatex(final Range range,
                            final boolean background,
                            final MathJaxTypeset.Callback callback)
    {
+      // always clean up any ongoing renders before starting a new one
+      endRender();
+
       MathJaxLoader.withMathJaxLoaded(new MathJaxLoader.Callback()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkInlineOutput.java
Patch:
@@ -48,6 +48,7 @@ public ChunkInlineOutput(String chunkId, final AnchoredSelection selection)
       
       console_ = new PreWidget();
       vconsole_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(console_.getElement());
+      vconsole_.setVirtualizedDisableOverride(true);
       chunkId_ = chunkId;
       selection_ = selection;
       state_ = State.Queued;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -1102,7 +1102,7 @@ public void onSourceExtendedTypeDetected(SourceExtendedTypeDetectedEvent e)
    @Override
    public void onDocumentCloseAllNoSave(DocumentCloseAllNoSaveEvent event)
    {
-      revertUnsavedTargets(() -> closeAllTabs(false, false, null));
+      revertUnsavedTargets(() -> closeAllTabs(null, false, null));
    }
 
    public void nextTabWithWrap()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1155,7 +1155,7 @@ public PrefValue<Boolean> limitVisibleConsole()
          "limit_visible_console",
          "Limit visible console output", 
          "Whether to only show a limited window of the total console output", 
-         false);
+         true);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -1102,7 +1102,7 @@ public void onSourceExtendedTypeDetected(SourceExtendedTypeDetectedEvent e)
    @Override
    public void onDocumentCloseAllNoSave(DocumentCloseAllNoSaveEvent event)
    {
-      revertUnsavedTargets(() -> commands_.closeAllSourceDocs().execute());
+      revertUnsavedTargets(() -> closeAllTabs(false, false, null));
    }
 
    public void nextTabWithWrap()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1748,8 +1748,7 @@ public void onSuccess(EditingTarget arg)
 
                   SourcePosition position = event.getCursorPosition();
                   if (position != null &&
-                      position.getRow() > 0 ||
-                      position.getColumn() > 0)
+                      (position.getRow() > 0 || position.getColumn() > 0))
                   {
                      editingTarget.navigateToPosition(position, false);
                   }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -192,6 +192,7 @@ class ClientEvent extends JavaScriptObject
    public static final String TutorialLaunch = "tutorial_launch";
    public static final String ReticulateEvent = "reticulate_event";
    public static final String RStudioApiRequest = "rstudioapi_request";
+   public static final String DocumentCloseAllNoSave = "document_close_all_no_save";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceVimCommands.java
Patch:
@@ -101,9 +101,9 @@ public native final void closeAllTabs(SourceColumnManager source, Command onComp
       
          var interactive = true;
          if (params.argString && params.argString === "!")
-            interactive = false;
+            interactive = false; // close unsaved files without saving them (or prompting)
          
-         source.@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::closeAllTabs(ZZLcom/google/gwt/user/client/Command;)(interactive, false, onCompleted);
+         source.@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::closeAllTabs(ZLcom/google/gwt/user/client/Command;)(interactive, onCompleted);
       });
        
       $wnd.require("ace/keyboard/vim").CodeMirror.Vim.defineEx("qall", "qa", callback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceVimCommands.java
Patch:
@@ -101,9 +101,9 @@ public native final void closeAllTabs(SourceColumnManager source, Command onComp
       
          var interactive = true;
          if (params.argString && params.argString === "!")
-            interactive = false;
+            interactive = false; // close unsaved files without saving them (or prompting)
          
-         source.@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::closeAllTabs(ZZLcom/google/gwt/user/client/Command;)(interactive, false, onCompleted);
+         source.@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::closeAllTabs(ZLcom/google/gwt/user/client/Command;)(interactive, onCompleted);
       });
        
       $wnd.require("ace/keyboard/vim").CodeMirror.Vim.defineEx("qall", "qa", callback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -703,7 +703,7 @@ public void onResponseReceived(RnwChunkOptions options)
                   JsUtil.toJsArrayInteger(new ArrayList<>(result.completions.length())),
                   JsUtil.toJsArrayString(new ArrayList<>(result.completions.length())),
                   "",
-                  false,
+                  true,
                   false,
                   true,
                   null,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/History.java
Patch:
@@ -219,8 +219,6 @@ public History(final Display view,
          @Override
          public void onConsoleResetHistory(ConsoleResetHistoryEvent event)
          {
-            view_.bringToFront();
-
             // convert to HistoryEntry
             ArrayList<HistoryEntry> commands = toRecentCommandsList(
                                                          event.getHistory());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1554,7 +1554,7 @@ public void closeAllSourceDocs(final String caption,
       if (SourceWindowManager.isMainSourceWindow() && !excludeActive)
       {
          // if this is the main window, close docs in the satellites first
-         pWindowManager_.get().closeAllSatelliteDocs(caption, new Command()
+         pWindowManager_.get().closeAllSatelliteDocs(caption, excludeDocId, new Command()
          {
             @Override
             public void execute()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PaneLayoutPreferencesPane.java
Patch:
@@ -192,7 +192,9 @@ public PaneLayoutPreferencesPane(PreferencesDialogResources res,
       additionalColumnCount_ = paneConfig.getAdditionalSourceColumns();
 
       add(new Label("Choose the layout of the panels in RStudio by selecting from the controls in" +
-         " each panel. Add up to three additional Source Columns to the left side of the layout.",
+         " each panel. Add up to three additional Source Columns to the left side of the layout. " +
+         "When a column is removed, all saved files within the column are closed and any unsaved " +
+         "files are moved to the main Source Pane.",
          true));
 
       Toolbar columnToolbar = new Toolbar("Manage Column Display");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -1602,6 +1602,7 @@ public ArrayList<String> consolidateColumns(int num)
                      public void onResponseReceived(final SourceDocument doc)
                      {
                         mainColumn.addTab(doc, Source.OPEN_INTERACTIVE);
+                        mainColumn.ensureVisible(true);
                      }
 
                      @Override

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -163,7 +163,7 @@ else if (workbenchContext_.isServerBusy() && terminalHelper_.warnBeforeClosing(b
          {
             pSource_.get().closeAllSourceDocs(caption,
                   () -> handleUnfinishedWork(caption, allowCancel, forceSaveAll, quitContext),
-                  false);
+                  false, null);
          }
          else
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceVimCommands.java
Patch:
@@ -103,7 +103,7 @@ public native final void closeAllTabs(SourceColumnManager source, Command onComp
          if (params.argString && params.argString === "!")
             interactive = false;
          
-         source.@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::closeAllTabs(ZZLcom/google/gwt/user/client/Command;)(interactive, false, onCompleted);
+         source.@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::closeAllTabs(ZLjava/lang/String;ZLcom/google/gwt/user/client/Command;)(interactive, null, false, onCompleted);
       });
        
       $wnd.require("ace/keyboard/vim").CodeMirror.Vim.defineEx("qall", "qa", callback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindow.java
Patch:
@@ -291,7 +291,7 @@ private void handleUnsavedChangesBeforeExit(JavaScriptObject jsoItems,
    private void closeAllDocs(String caption, Command onCompleted)
    {
       if (source_ != null)
-         source_.closeAllSourceDocs(caption, onCompleted, false);
+         source_.closeAllSourceDocs(caption, onCompleted, false, null);
    }
    
    private JsArray<UnsavedChangesItem> getUnsavedChanges()

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -389,6 +389,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.nb.html", RNOTEBOOK, new ImageResource2x(icons.iconRnotebook2x()));
       register("*.rpres", RPRESENTATION, new ImageResource2x(icons.iconRpresentation2x()));
       register("*.md", MARKDOWN, new ImageResource2x(icons.iconMarkdown2x()));
+      register("*.jmd", MARKDOWN, new ImageResource2x(icons.iconMarkdown2x()));
       register("*.mdtxt", MARKDOWN, new ImageResource2x(icons.iconMarkdown2x()));
       register("*.markdown*", MARKDOWN, new ImageResource2x(icons.iconMarkdown2x()));
       register("*.bib", TEXT, new ImageResource2x(icons.iconText2x()));

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorEditor.java
Patch:
@@ -72,6 +72,8 @@ public native static Promise<PanmirrorEditor> create(Element parent,
    public native PanmirrorMenus getMenus();
    
    public native PanmirrorOutlineItem[] getOutline();
+
+   public native PanmirrorEditingOutlineLocation getEditingOutlineLocation();
    
    public native PanmirrorFindReplace getFindReplace();
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -43,7 +43,6 @@
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.events.HasContextMenuHandlers;
 import org.rstudio.core.client.widget.CanSetControlId;
 import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.studio.client.RStudioGinjector;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -20,7 +20,6 @@
 
 import java.util.List;
 
-import org.rstudio.core.client.events.HasContextMenuHandlers;
 import org.rstudio.core.client.js.JsMap;
 import org.rstudio.core.client.patch.TextChange;
 import org.rstudio.studio.client.common.debugging.model.Breakpoint;
@@ -72,6 +71,7 @@
 import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.event.dom.client.BlurHandler;
 import com.google.gwt.event.dom.client.FocusHandler;
+import com.google.gwt.event.dom.client.HasContextMenuHandlers;
 import com.google.gwt.event.dom.client.HasFocusHandlers;
 import com.google.gwt.event.dom.client.HasKeyDownHandlers;
 import com.google.gwt.event.logical.shared.AttachEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -28,7 +28,6 @@
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.command.CommandBinder;
-import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.events.*;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.js.JsObject;
@@ -311,7 +310,10 @@ private void onActivate(EditingTarget target)
        // set and active editor
        activeEditor_ = target;
        if (activeEditor_ != null)
+       {
           activeEditor_.onActivate();
+          display_.selectTab(activeEditor_.asWidget());
+       }
    }
 
    void setActiveEditor()

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -15,6 +15,8 @@
 package org.rstudio.studio.client.common;
 
 import com.google.gwt.user.client.ui.HasText;
+
+import org.rstudio.core.client.MathUtil;
 import org.rstudio.core.client.StringUtil;
 
 import java.util.ArrayList;
@@ -70,7 +72,7 @@ public void navigateHistory(int offset)
 
    public String getHistoryEntry(int offset)
    {
-      int pos = getPositionAtOffset(offset);
+      int pos = MathUtil.clamp(getPositionAtOffset(offset), 0, history_.size() - 1);
       return history_.get(pos);
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeCommands.java
Patch:
@@ -96,6 +96,7 @@ public TextFileType[] statusBarFileTypes()
       types.add(FileTypeRegistry.SASS);
       types.add(FileTypeRegistry.SCSS);
       types.add(FileTypeRegistry.JS);
+      types.add(FileTypeRegistry.JSON);
       types.add(FileTypeRegistry.CPP);
       types.add(FileTypeRegistry.PYTHON);
       types.add(FileTypeRegistry.SQL);

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -15,6 +15,8 @@
 package org.rstudio.studio.client.common;
 
 import com.google.gwt.user.client.ui.HasText;
+
+import org.rstudio.core.client.MathUtil;
 import org.rstudio.core.client.StringUtil;
 
 import java.util.ArrayList;
@@ -70,7 +72,7 @@ public void navigateHistory(int offset)
 
    public String getHistoryEntry(int offset)
    {
-      int pos = getPositionAtOffset(offset);
+      int pos = MathUtil.clamp(getPositionAtOffset(offset), 0, history_.size() - 1);
       return history_.get(pos);
    }
 

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectEditingPreferencesPane.java
Patch:
@@ -135,7 +135,7 @@ protected void initialize(RProjectOptions options)
       numSpacesForTab_.setValue(initialConfig_.getNumSpacesForTab() + "");
       chkAutoAppendNewline_.setValue(initialConfig_.getAutoAppendNewline());
       chkStripTrailingWhitespace_.setValue(initialConfig_.getStripTrailingWhitespace());
-      lineEndings_.setIntValue(initialConfig_.getLineEndings());
+      lineEndings_.setValue(ProjectPrefs.prefFromLineEndings(initialConfig_.getLineEndings()));
       setEncoding(initialConfig_.getEncoding());
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefUtils.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * UserPrefsUtils.java
+ * UserPrefUtils.java
  *
  * Copyright (C) 2020 by RStudio, PBC
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1350,7 +1350,7 @@ public void execute(EditingTarget arg)
    @Handler
    public void onActivateSource()
    {
-      onActivateSource(SourceColumnManager.MAIN_SOURCE_NAME, null);
+      onActivateSource(columnManager_.getActive().getName(), null);
    }
 
    public void onActivateSource(String columnName, final Command afterActivation)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/status/StatusBar.java
Patch:
@@ -40,6 +40,7 @@ interface HideMessageHandler
    StatusBarElement getPosition();
    StatusBarElement getScope();
    StatusBarElement getLanguage();
+   void setPositionVisible(boolean visible);
    void setScopeVisible(boolean visible);
    void setScopeType(int type);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/status/StatusBar.java
Patch:
@@ -40,6 +40,7 @@ interface HideMessageHandler
    StatusBarElement getPosition();
    StatusBarElement getScope();
    StatusBarElement getLanguage();
+   void setPositionVisible(boolean visible);
    void setScopeVisible(boolean visible);
    void setScopeType(int type);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -96,7 +96,7 @@ public PrefValue<String> initialWorkingDirectory()
          "initial_working_directory",
          "Initial working directory", 
          "The initial working directory for new R sessions.", 
-         "~");
+         "");
    }
 
    /**
@@ -1287,7 +1287,7 @@ public PrefValue<String> defaultProjectLocation()
          "default_project_location",
          "Default new project location", 
          "The directory path under which to place new projects by default.", 
-         "~");
+         "");
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -416,7 +416,7 @@ protected void initialize(UserPrefs prefs)
       
       String workingDir = prefs.initialWorkingDirectory().getValue();
       if (StringUtil.isNullOrEmpty(workingDir))
-         workingDir = "~";
+         workingDir = session_.getSessionInfo().getInitialWorkingDir();
       
       dirChooser_.setText(workingDir);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -96,7 +96,7 @@ public PrefValue<String> initialWorkingDirectory()
          "initial_working_directory",
          "Initial working directory", 
          "The initial working directory for new R sessions.", 
-         "");
+         "~");
    }
 
    /**
@@ -1287,7 +1287,7 @@ public PrefValue<String> defaultProjectLocation()
          "default_project_location",
          "Default new project location", 
          "The directory path under which to place new projects by default.", 
-         "");
+         "~");
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefUtils.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * UserPrefsUtils.java
+ * UserPrefUtils.java
  *
  * Copyright (C) 2020 by RStudio, PBC
  *

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorSetMarkdownResult.java
Patch:
@@ -18,6 +18,7 @@
 
 import elemental2.core.JsObject;
 import jsinterop.annotations.JsType;
+import org.rstudio.studio.client.panmirror.location.PanmirrorEditingOutlineLocation;
 
 @JsType
 public class PanmirrorSetMarkdownResult
@@ -26,6 +27,7 @@ public class PanmirrorSetMarkdownResult
    public String line_wrapping;
    public String[] unrecognized;
    public JsObject unparsed_meta;
+   public PanmirrorEditingOutlineLocation location;
    
    public static final String kLineWrappingNone = "none";
    public static final String kLineWrappingColumn= "column";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3215,8 +3215,10 @@ else if (canonical && visualMode_.canWriteCanonical())
                      docDisplay_.applyChanges(changes.changes, true);
                   else if (changes.code != null)
                      docDisplay_.setCode(changes.code, true);
-                  onComplete.execute();
                }
+               // need to continue in order to not permanetly break save
+               // (user has seen an error message so will still likely report)
+               onComplete.execute();
             });
          }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1459,7 +1459,7 @@ public void onError(ServerError error)
       }
       if (e.getOldWindowId().equals(SourceWindowManager.getSourceWindowId()))
       {
-         columnManager_.disownDocOnDrag(e.getDocId(), oldDisplay);
+         columnManager_.disownDoc(e.getDocId(), oldDisplay, true);
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputPresenter.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
+import com.google.gwt.dom.client.Element;
 import org.rstudio.core.client.js.JsArrayEx;
 import org.rstudio.studio.client.common.debugging.model.UnhandledError;
 import org.rstudio.studio.client.rmarkdown.model.NotebookFrameMetadata;
@@ -52,7 +53,7 @@ void showDataOutput(JavaScriptObject data, NotebookFrameMetadata metadata,
    void updatePlot(String plotUrl, String pendingStyle);
 
    // Handles html that can be appended to end of the chunk.
-   void showCallbackHtml(String htmlOutput);
+   void showCallbackHtml(String htmlOutput, Element parentElement);
 
    // clear output or indicate that interactive output (or playback) is complete
    void clearOutput();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -263,11 +263,11 @@ public HandlerRegistration addExpansionStateChangeHandler(
       return expansionState_.addValueChangeHandler(handler);
    }
 
-   public void renderHtml(String htmlOutput)
+   public void renderHtml(String htmlOutput, Element parentElement)
    {
       if (StringUtil.isNullOrEmpty(htmlOutput))
          return;
-      presenter_.showCallbackHtml(htmlOutput);
+      presenter_.showCallbackHtml(htmlOutput, parentElement);
    }
 
    public void showChunkOutput(RmdChunkOutput output, int mode, int scope,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -19,6 +19,7 @@
 import java.util.HashMap;
 import java.util.List;
 
+import com.google.gwt.dom.client.Element;
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.JsArrayUtil;
@@ -811,7 +812,8 @@ else if (data.getType() == RmdChunkOutputFinishedEvent.TYPE_INTERACTIVE &&
       if (chunkHasOutput(data.getChunkId()) &&
           !StringUtil.isNullOrEmpty(data.getHtmlCallback()))
       {
-         outputs().get(data.getChunkId()).getOutputWidget().renderHtml(data.getHtmlCallback());
+         outputs().get(data.getChunkId()).getOutputWidget().renderHtml(data.getHtmlCallback(),
+            docDisplay_.asWidget().getElement());
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -514,7 +514,7 @@ public void onSuspendAndRestart(final SuspendAndRestartEvent event)
       if (suspendingAndRestarting_) return;
       
       // set restart pending for desktop
-      setPendinqQuit(DesktopFrame.PENDING_QUIT_AND_RESTART);
+      setPendingQuit(DesktopFrame.PENDING_QUIT_AND_RESTART);
       
       final TimedProgressIndicator progress = new TimedProgressIndicator(
             globalDisplay_.getProgressIndicator("Error"));
@@ -536,11 +536,11 @@ public void onSuspendAndRestart(final SuspendAndRestartEvent event)
             onRestartComplete.execute();
          }, () -> { // failure
             onRestartComplete.execute();
-            setPendinqQuit(DesktopFrame.PENDING_QUIT_NONE);
+            setPendingQuit(DesktopFrame.PENDING_QUIT_NONE);
          });
    }
    
-   private void setPendinqQuit(int pendingQuit)
+   private void setPendingQuit(int pendingQuit)
    {
       if (Desktop.hasDesktopFrame())
          Desktop.getFrame().setPendingQuit(pendingQuit);

File: src/gwt/src/org/rstudio/core/client/RegexUtil.java
Patch:
@@ -33,6 +33,7 @@ public static final boolean isSyntacticRIdentifier(String identifier)
    {
       String regex =
             "^" +
+            "(?![0-9])" +
             "[" + WORD_CHARACTER + ".]" +
             "[" + WORD_CHARACTER +  "._]*" +
             "$";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -693,7 +693,7 @@ public void onResponseReceived(RnwChunkOptions options)
                   rnwContext_ == null ? null : rnwContext_.getActiveRnwWeave());
 
             String[] pkgNames = new String[result.completions.length()];
-            Arrays.fill(pkgNames, "`chunk-option`");
+            Arrays.fill(pkgNames, "<chunk-option>");
 
             Completions response = Completions.createCompletions(
                   result.token,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -926,6 +926,7 @@ public void onClosing()
          syncOnIdle_.suspend();
       if (saveLocationOnIdle_ != null)
          saveLocationOnIdle_.suspend();
+      panmirror_.destroy();
    }
    
    public VisualModeChunk getChunkAtRow(int row)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.core.client.Size;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
+import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.core.client.widget.ProgressSpinner;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -594,11 +595,13 @@ public void setEmbeddedStyle(boolean embedded)
       if (embedded)
       {
          addStyleName(style.embedded());
+         addStyleName(FontSizer.getNormalFontSizeClass());
          chunkOutputSize_ = ChunkOutputSize.Natural;
       }
       else
       {
          removeStyleName(style.embedded());
+         removeStyleName(FontSizer.getNormalFontSizeClass());
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -689,6 +689,7 @@ public void manageCommands()
    public void unmanageCommands()
    {
       restoreDisabledForVisualMode();
+      setCodeCommandsEnabled(true);
    }
    
    public void insertChunk(String chunkPlaceholder, int rowOffset, int colOffset)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.core.client.Size;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
+import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.core.client.widget.ProgressSpinner;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -594,11 +595,13 @@ public void setEmbeddedStyle(boolean embedded)
       if (embedded)
       {
          addStyleName(style.embedded());
+         addStyleName(FontSizer.getNormalFontSizeClass());
          chunkOutputSize_ = ChunkOutputSize.Natural;
       }
       else
       {
          removeStyleName(style.embedded());
+         removeStyleName(FontSizer.getNormalFontSizeClass());
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -208,4 +208,7 @@ public interface FileIconResources extends ClientBundle
    
    @Source("iconObjectExplorer_2x.png")
    ImageResource iconObjectExplorer2x();
+   
+   @Source("iconDockerfile_2x.png")
+   ImageResource iconDockerfile2x();
 }

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -83,6 +83,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_CLOJURE = new EditorLanguage("ace/mode/clojure", false, true);
    public static final EditorLanguage LANG_COFFEE = new EditorLanguage("ace/mode/coffee", false, true);
    public static final EditorLanguage LANG_CSHARP = new EditorLanguage("ace/mode/csharp", false, true);
+   public static final EditorLanguage LANG_DOCKERFILE = new EditorLanguage("ace/mode/dockerfile", false, true);
    public static final EditorLanguage LANG_GITIGNORE = new EditorLanguage("ace/mode/gitignore", false, false);
    public static final EditorLanguage LANG_GO = new EditorLanguage("ace/mode/golang", false, true);
    public static final EditorLanguage LANG_GROOVY = new EditorLanguage("ace/mode/groovy", false, true);

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -333,7 +333,7 @@ public void run()
                   toolbar_.sync(true);
                   syncEditorTheme(event.getTheme());
                }
-            }.schedule(150);
+            }.schedule(500);
       }));
       
       registrations_.add(events_.addHandler(ChangeFontSizeEvent.TYPE, (event) -> {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -689,6 +689,7 @@ public void manageCommands()
    public void unmanageCommands()
    {
       restoreDisabledForVisualMode();
+      setCodeCommandsEnabled(true);
    }
    
    public void insertChunk(String chunkPlaceholder, int rowOffset, int colOffset)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -689,6 +689,7 @@ public void manageCommands()
    public void unmanageCommands()
    {
       restoreDisabledForVisualMode();
+      setCodeCommandsEnabled(true);
    }
    
    public void insertChunk(String chunkPlaceholder, int rowOffset, int colOffset)

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -208,4 +208,7 @@ public interface FileIconResources extends ClientBundle
    
    @Source("iconObjectExplorer_2x.png")
    ImageResource iconObjectExplorer2x();
+   
+   @Source("iconDockerfile_2x.png")
+   ImageResource iconDockerfile2x();
 }

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -83,6 +83,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_CLOJURE = new EditorLanguage("ace/mode/clojure", false, true);
    public static final EditorLanguage LANG_COFFEE = new EditorLanguage("ace/mode/coffee", false, true);
    public static final EditorLanguage LANG_CSHARP = new EditorLanguage("ace/mode/csharp", false, true);
+   public static final EditorLanguage LANG_DOCKERFILE = new EditorLanguage("ace/mode/dockerfile", false, true);
    public static final EditorLanguage LANG_GITIGNORE = new EditorLanguage("ace/mode/gitignore", false, false);
    public static final EditorLanguage LANG_GO = new EditorLanguage("ace/mode/golang", false, true);
    public static final EditorLanguage LANG_GROOVY = new EditorLanguage("ace/mode/groovy", false, true);

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -333,7 +333,7 @@ public void run()
                   toolbar_.sync(true);
                   syncEditorTheme(event.getTheme());
                }
-            }.schedule(150);
+            }.schedule(500);
       }));
       
       registrations_.add(events_.addHandler(ChangeFontSizeEvent.TYPE, (event) -> {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -208,4 +208,7 @@ public interface FileIconResources extends ClientBundle
    
    @Source("iconObjectExplorer_2x.png")
    ImageResource iconObjectExplorer2x();
+   
+   @Source("iconDockerfile_2x.png")
+   ImageResource iconDockerfile2x();
 }

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -83,6 +83,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_CLOJURE = new EditorLanguage("ace/mode/clojure", false, true);
    public static final EditorLanguage LANG_COFFEE = new EditorLanguage("ace/mode/coffee", false, true);
    public static final EditorLanguage LANG_CSHARP = new EditorLanguage("ace/mode/csharp", false, true);
+   public static final EditorLanguage LANG_DOCKERFILE = new EditorLanguage("ace/mode/dockerfile", false, true);
    public static final EditorLanguage LANG_GITIGNORE = new EditorLanguage("ace/mode/gitignore", false, false);
    public static final EditorLanguage LANG_GO = new EditorLanguage("ace/mode/golang", false, true);
    public static final EditorLanguage LANG_GROOVY = new EditorLanguage("ace/mode/groovy", false, true);

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -333,7 +333,7 @@ public void run()
                   toolbar_.sync(true);
                   syncEditorTheme(event.getTheme());
                }
-            }.schedule(150);
+            }.schedule(500);
       }));
       
       registrations_.add(events_.addHandler(ChangeFontSizeEvent.TYPE, (event) -> {

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -333,7 +333,7 @@ public void run()
                   toolbar_.sync(true);
                   syncEditorTheme(event.getTheme());
                }
-            }.schedule(150);
+            }.schedule(500);
       }));
       
       registrations_.add(events_.addHandler(ChangeFontSizeEvent.TYPE, (event) -> {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -208,4 +208,7 @@ public interface FileIconResources extends ClientBundle
    
    @Source("iconObjectExplorer_2x.png")
    ImageResource iconObjectExplorer2x();
+   
+   @Source("iconDockerfile_2x.png")
+   ImageResource iconDockerfile2x();
 }

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -83,6 +83,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_CLOJURE = new EditorLanguage("ace/mode/clojure", false, true);
    public static final EditorLanguage LANG_COFFEE = new EditorLanguage("ace/mode/coffee", false, true);
    public static final EditorLanguage LANG_CSHARP = new EditorLanguage("ace/mode/csharp", false, true);
+   public static final EditorLanguage LANG_DOCKERFILE = new EditorLanguage("ace/mode/dockerfile", false, true);
    public static final EditorLanguage LANG_GITIGNORE = new EditorLanguage("ace/mode/gitignore", false, false);
    public static final EditorLanguage LANG_GO = new EditorLanguage("ace/mode/golang", false, true);
    public static final EditorLanguage LANG_GROOVY = new EditorLanguage("ace/mode/groovy", false, true);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/dialog/SVNReviewPanel.java
Patch:
@@ -98,6 +98,7 @@ interface Styles extends SharedStyles
       String contextLabel();
       String diffToolbar();
       String diffViewOptions();
+      String diffContextLines();
    }
 
    @SuppressWarnings("unused")
@@ -266,6 +267,7 @@ public void onClick(ClickEvent event)
       discardAllButton_ = diffToolbar_.addLeftWidget(new ToolbarButton(
             "Discard All", ToolbarButton.NoTitle,  new ImageResource2x(RES.discard2x())));
 
+      contextLines_.addStyleName(RES.styles().diffContextLines());
       lblContext_.setFor(contextLines_);
       listBoxAdapter_ = new ListBoxAdapter(contextLines_);
 

File: src/gwt/src/org/rstudio/studio/client/application/model/ApplicationServerOperations.java
Patch:
@@ -34,7 +34,7 @@ void clientInit(String baseURL,
    void getJobConnectionStatus(ServerRequestCallback<String> requestCallback);
 
    // interrupt the current session
-   void interrupt(ServerRequestCallback<Void> requestCallback);
+   void interrupt(ServerRequestCallback<Boolean> requestCallback);
    
    // abort the current session
    void abort(String nextSessionProject,

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -825,7 +825,7 @@ public void processNotifyVisible(String handle,
       sendRequest(RPC_SCOPE, PROCESS_NOTIFY_VISIBLE, params, requestCallback);
    }
 
-   public void interrupt(ServerRequestCallback<Void> requestCallback)
+   public void interrupt(ServerRequestCallback<Boolean> requestCallback)
    {
       sendRequest(RPC_SCOPE, INTERRUPT, requestCallback);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/model/ConsoleServerOperations.java
Patch:
@@ -28,7 +28,7 @@ void adaptToLanguage(String language,
                         ServerRequestCallback<Void> requestCallback);
    
    // interrupt the current session
-   void interrupt(ServerRequestCallback<Void> requestCallback);
+   void interrupt(ServerRequestCallback<Boolean> requestCallback);
 
    // send console input
    void consoleInput(String consoleInput, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/model/DataImportServerOperations.java
Patch:
@@ -34,7 +34,7 @@ void previewDataImportAsync(DataImportOptions dataImportOptions,
                                int maxFactors,
                                ServerRequestCallback<DataImportPreviewResponse> requestCallback);
    
-   void interrupt(ServerRequestCallback<Void> requestCallback);
+   void interrupt(ServerRequestCallback<Boolean> requestCallback);
    
    void previewDataImportAsyncAbort(ServerRequestCallback<Void> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/ConsoleProgressDialog.java
Patch:
@@ -280,7 +280,8 @@ public void onClick(ClickEvent event)
    {
       if (running_)
       {
-         consoleProcess_.interrupt(new SimpleRequestCallback<Void>() {
+         consoleProcess_.interrupt(new SimpleRequestCallback<Void>()
+         {
             @Override
             public void onResponseReceived(Void response)
             {
@@ -294,6 +295,7 @@ public void onError(ServerError error)
                super.onError(error);
             }
          });
+         
          stopButton().setEnabled(false);
       }
       else

File: src/gwt/src/org/rstudio/core/client/widget/HasFindReplace.java
Patch:
@@ -21,6 +21,7 @@ public interface HasFindReplace
    boolean isFindReplaceShowing();
    void showFindReplace(boolean defaultForward);
    void hideFindReplace();
+   void findFromSelection(String text);
    void findNext();
    void findPrevious();
    void replaceAndFind();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -800,6 +800,7 @@ public HasFindReplace getFindReplace()
             public boolean isFindReplaceShowing() { return false; }
             public void showFindReplace(boolean defaultForward) {}
             public void hideFindReplace() {}
+            public void findFromSelection(String text) {}
             public void findNext() {}
             public void findPrevious() {}
             public void replaceAndFind() {}

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorEvent.java
Patch:
@@ -23,6 +23,7 @@ public class PanmirrorEvent
    public static String Resize = "panmirrorResize";
    public static String Layout = "panmirrorLayout";
    public static String Scroll = "panmirrorScroll";
+   public static String Blur = "panmirrorBlur";
    public static String Focus = "panmirrorFocus";
    public static String Navigate = "panmirrorNavigate";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -791,7 +791,7 @@ public PrefValue<Boolean> showDiagnosticsOther()
          "show_diagnostics_other",
          "Show diagnostics in other languages", 
          "Whether to show diagnostic messages for other types of code (not R or C++).", 
-         true);
+         false);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -791,7 +791,7 @@ public PrefValue<Boolean> showDiagnosticsOther()
          "show_diagnostics_other",
          "Show diagnostics in other languages", 
          "Whether to show diagnostic messages for other types of code (not R or C++).", 
-         true);
+         false);
    }
 
    /**

File: src/gwt/src/org/rstudio/core/client/ClassIds.java
Patch:
@@ -67,11 +67,11 @@ public static void removeClassId(Widget widget, String classId)
    public final static String SOURCE_PANEL = "source_panel";
    public final static String DOC_OUTLINE_CONTAINER = "doc_outline_container";
 
-   // WindowFrameButton (combined with unique suffix for each quadrant)
+   // WindowFrameButton (combined with unique suffix for each panel)
    public final static String PANEL_MIN_BTN = "panel_min_btn";
    public final static String PANEL_MAX_BTN = "panel_max_btn";
 
-   // Chunk Context (combined with unique suffix for each quadrant)
+   // Chunk Context (combined with unique suffix for each panel)
    public final static String CHUNK = "chunk";
    public final static String CHUNK_OUTPUT = "chunk_output";
    public final static String MODIFY_CHUNK = "modify_chunk";

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -23,9 +23,7 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 
 import com.google.gwt.core.client.JavaScriptObject;
-import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.core.client.JsArray;
-import org.rstudio.core.client.JsArrayUtil;
 
 import java.util.ArrayList;
 import java.util.List;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -23,7 +23,9 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 
 import com.google.gwt.core.client.JavaScriptObject;
+import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.core.client.JsArray;
+import org.rstudio.core.client.JsArrayUtil;
 
 import java.util.ArrayList;
 import java.util.List;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -128,6 +128,7 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
+import org.rstudio.studio.client.workbench.prefs.model.UserPrefsAccessor;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
 import org.rstudio.studio.client.workbench.ui.FontSizeManager;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
@@ -4794,8 +4795,7 @@ private void reflowComments(DocDisplay display,
       final WordWrapCursorTracker wwct = new WordWrapCursorTracker(
                                                 cursorRowIndex, cursorColIndex);
 
-      int maxLineLength =
-                        prefs_.marginColumn().getValue() - prefix.length();
+      int maxLineLength = prefs_.marginColumn().getValue() - prefix.length();
 
       WordWrap wordWrap = new WordWrap(maxLineLength, false)
       {

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -67,7 +67,7 @@ public void navigateHistory(int offset)
             "");
       historyPos_ = newPos;
    }
-   
+
    public String getHistoryEntry(int offset)
    {
       int pos = getPositionAtOffset(offset);
@@ -79,11 +79,11 @@ public void resetPosition()
       historyPos_ = history_.size();
       historyTail_ = "";
    }
-   
+
    private int getPositionAtOffset(int offset)
    {
       int pos = historyPos_ + offset;
-      return Math.max(0, Math.min(pos, history_.size()) - 1);
+      return Math.max(0, Math.min(pos, history_.size()));
    }
 
    private final ArrayList<String> history_ = new ArrayList<String>();

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -67,7 +67,7 @@ public void navigateHistory(int offset)
             "");
       historyPos_ = newPos;
    }
-   
+
    public String getHistoryEntry(int offset)
    {
       int pos = getPositionAtOffset(offset);
@@ -79,11 +79,11 @@ public void resetPosition()
       historyPos_ = history_.size();
       historyTail_ = "";
    }
-   
+
    private int getPositionAtOffset(int offset)
    {
       int pos = historyPos_ + offset;
-      return Math.max(0, Math.min(pos, history_.size()) - 1);
+      return Math.max(0, Math.min(pos, history_.size()));
    }
 
    private final ArrayList<String> history_ = new ArrayList<String>();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputGallery.java
Patch:
@@ -212,15 +212,15 @@ public void showCallbackHtml(String htmlOutput)
          public void execute()
          {
             DomUtils.fillIFrame(frame.getIFrame(), htmlOutput);
-            int contentHeight = frame.getWindow().getDocument().getBody().getOffsetHeight();
+            int contentHeight = frame.getWindow().getDocument().getDocumentElement().getOffsetHeight();
             callbackContent.setHeight(contentHeight + "px");
             callbackContent.setWidth("100%");
             frame.getElement().getStyle().setWidth(100, Unit.PCT);
             frame.getElement().getStyle().setHeight(contentHeight, Unit.PX);
             host_.notifyHeightChanged();
             
             Command heightHandler = () -> {
-               int newHeight = frame.getWindow().getDocument().getBody().getOffsetHeight();
+               int newHeight = frame.getWindow().getDocument().getDocumentElement().getOffsetHeight();
                callbackContent.setHeight(newHeight + "px");
                frame.getElement().getStyle().setHeight(newHeight, Unit.PX);
                host_.notifyHeightChanged();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -447,13 +447,13 @@ public void showCallbackHtml(String htmlOutput)
          public void execute()
          {
             DomUtils.fillIFrame(frame.getIFrame(), htmlOutput);
-            int contentHeight = frame.getWindow().getDocument().getBody().getOffsetHeight();
+            int contentHeight = frame.getWindow().getDocument().getDocumentElement().getOffsetHeight();
             frame.getElement().getStyle().setHeight(contentHeight, Unit.PX);
             frame.getElement().getStyle().setWidth(100, Unit.PCT);
             onHeightChanged();
 
             Command handler = () -> {
-               int newHeight = frame.getWindow().getDocument().getBody().getOffsetHeight();
+               int newHeight = frame.getWindow().getDocument().getDocumentElement().getOffsetHeight();
                frame.getElement().getStyle().setHeight(newHeight, Unit.PX);
                onHeightChanged();
             };

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -488,7 +488,7 @@ public void submit(String data, String clazz)
    public void submit(String data, String clazz, boolean forceNewRange, boolean ariaLiveAnnounce)
    {
       // Only capture new elements when dealing with error output, which
-      // is only place that sets forceNewRange to true. This is just an
+      // is the only place that sets forceNewRange to true. This is just an
       // optimization to avoid unnecessary overhead for large (non-error)
       // output.
       captureNewElements_ = forceNewRange;
@@ -686,9 +686,7 @@ public ClassRange(int pos, String className, String text)
          element.setInnerText(text);
 
          if (captureNewElements_)
-         {
             newElements_.add(element);
-         }
       }
 
       public void trimLeft(int delta)

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -83,7 +83,7 @@ public void resetPosition()
    private int getPositionAtOffset(int offset)
    {
       int pos = historyPos_ + offset;
-      return Math.max(0, Math.min(pos, history_.size()));
+      return Math.max(0, Math.min(pos, history_.size()) - 1);
    }
 
    private final ArrayList<String> history_ = new ArrayList<String>();

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleError.java
Patch:
@@ -58,6 +58,7 @@ public ConsoleError(UnhandledError err,
       initWidget(uiBinder.createAndBindUi(this));
       
       VirtualConsole vc = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(errorMessage.getElement());
+      vc.setVirtualizedDisableOverride(true);
       vc.submit(err.getErrorMessage().trim());
       errorMessage.addStyleName(errorClass);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -93,7 +93,7 @@ public static boolean equals(State a, State b)
          if (a.hasSplitterPos() ^ b.hasSplitterPos())
             return false;
          if (a.hasSplitterPos() &&
-             Arrays.equals(a.getSplitterPos(), b.getSplitterPos()))
+             !Arrays.equals(a.getSplitterPos(), b.getSplitterPos()))
             return false;
 
          if (a.hasPanelWidth() ^ b.hasPanelWidth())

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -319,7 +319,7 @@ public void clearProgress()
 
       public void onCompleted()
       {
-         isSaving _ = false;
+         isSaving_ = false;
 		 
          // don't need to check again soon because we just saved
          // (without this and when file monitoring is active we'd

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -425,7 +425,7 @@ protected void onInit(JsObject value)
          @Override
          protected JsObject getValue()
          {
-            if (dialogState_ != null)
+            if (dialogState_ == null)
                return dialogState_.cast();
 
             JsObject object = dialogState_.<JsObject>cast().clone();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -425,7 +425,7 @@ protected void onInit(JsObject value)
          @Override
          protected JsObject getValue()
          {
-            if (dialogState_ != null)
+            if (dialogState_ == null)
                return dialogState_.cast();
 
             JsObject object = dialogState_.<JsObject>cast().clone();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/LintManager.java
Patch:
@@ -197,7 +197,7 @@ private void lintActiveDocument(final LintContext context)
 
       if (context.showMarkers)
       {
-         target_.saveThenExecute(null, new Command()
+         target_.saveThenExecute(null, false, new Command()
          {
             @Override
             public void execute()
@@ -208,7 +208,7 @@ public void execute()
       }
       else
       {
-         target_.withSavedDoc(new Command()
+         target_.withSavedDocNoRetry(new Command()
          {
             @Override
             public void execute()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -101,6 +101,7 @@ void saveDocument(String id,
                      String foldSpec,
                      JsArray<ChunkDefinition> chunkOutput,
                      String contents,
+                     boolean retryWrite,
                      ServerRequestCallback<String> requestCallback);
 
    /**
@@ -126,6 +127,7 @@ void saveDocumentDiff(String id,
                          int length,
                          boolean valid,
                          String hash,
+                         boolean retryWrite,
                          ServerRequestCallback<String> requestCallback);
 
    void checkForExternalEdit(

File: src/gwt/src/org/rstudio/core/client/theme/PrimaryWindowFrame.java
Patch:
@@ -45,7 +45,7 @@ public HandlerRegistration addMouseDownHandler(MouseDownHandler handler)
    public PrimaryWindowFrame(String title,
                              Widget mainWidget)
    {
-      super(title);
+      super(title, title);
       ThemeStyles styles = ThemeResources.INSTANCE.themeStyles();
 
       panel_ = new ClickFlowPanel();

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -38,6 +38,7 @@ public CompileOutputBufferWithHighlight()
       output_.addStyleName(styles_.paddedOutput());
       FontSizer.applyNormalFontSize(output_);
       console_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(output_.getElement());
+      console_.setVirtualizedDisableOverride(true); // disable virtualization of scroller
     
       scrollPanel_ = new BottomScrollPanel();
       scrollPanel_.setSize("100%", "100%");

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java
Patch:
@@ -517,7 +517,7 @@ public boolean shouldCheckWord(String word)
       severe issues with. This is being tracked to be fixed in issue #6041 as
       soon as possible so this can then be removed.
     */
-   private static String[] realtimeDictBlacklist = {"cs_CZ", "de_DE_neu", "lt_LT", "lt_LT_new", "pt_BR", "it_IT"};
+   private final static String[] realtimeDictBlacklist = {"lt_LT", "lt_LT_new", "pt_BR", "it_IT"};
    public static boolean canRealtimeSpellcheckDict(String dict)
    {
       boolean exists = false;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -535,6 +535,7 @@
    public abstract AppCommand loadServerHome();
 
    // Build
+   public abstract AppCommand clearBuild();
    public abstract AppCommand buildAll();
    public abstract AppCommand devtoolsLoadAll();
    public abstract AppCommand rebuildAll();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AccessibilityPreferencesPane.java
Patch:
@@ -68,7 +68,8 @@ public AccessibilityPreferencesPane(UserPrefs prefs,
       chkTabMovesFocus_ = new CheckBox("Tab key always moves focus");
       generalPanel.add(lessSpaced(chkTabMovesFocus_));
       chkShowFocusRectangles_ = new CheckBox("Always show focus outlines (requires restart)");
-      generalPanel.add(chkShowFocusRectangles_);
+      generalPanel.add(lessSpaced(chkShowFocusRectangles_));
+      generalPanel.add(checkboxPref("Highlight focused panel", prefs.showPanelFocusRectangle()));
 
       HelpLink helpLink = new HelpLink("RStudio accessibility help", "rstudio_a11y", false);
       nudgeRight(helpLink);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildCommands.java
Patch:
@@ -72,6 +72,7 @@ public static void setBuildCommandState(Commands commands,
          commands.stopBuild().remove();
          commands.activateBuild().remove();
          commands.layoutZoomBuild().remove();
+         commands.clearBuild().remove();
       }
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceVimCommands.java
Patch:
@@ -120,7 +120,7 @@ public native final void createNewDocument(SourceColumnManager source) /*-{
          // Handle other editing targets
          else if (params.args) {
             if (params.args.length === 1) {
-               source.getColumnManager()().@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::editFile(Ljava/lang/String;)(params.args[0]);
+               source.getColumnManager()().@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::vimEditFile(Ljava/lang/String;)(params.args[0]);
             }
             // TODO: on error?
          } else {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DocTabDragParams.java
Patch:
@@ -51,7 +51,7 @@ public final native static DocTabDragParams create(String docId,
         tab_width      : 0,
         cursor_offset  : 0,
         source_position: position,
-        display_name   : display_name
+        display_name   : displayName
      }
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalDeckPanel.java
Patch:
@@ -37,10 +37,11 @@ public void addNewTerminalPanel(
          ConsoleProcessInfo procInfo,
          XTermOptions options,
          boolean tabMovesFocus,
+         boolean showWebLinks,
          boolean createdByApi,
          CommandWithArg<TerminalSession> callback)
    {
-      TerminalSession session = new TerminalSession(procInfo, options, tabMovesFocus, createdByApi);
+      TerminalSession session = new TerminalSession(procInfo, options, tabMovesFocus, showWebLinks, createdByApi);
       add(session);
       showWidget(session);
       Scheduler.get().scheduleDeferred(() ->  callback.execute(session));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -334,6 +334,7 @@ public void createTerminal(String postCreateText, String initialDirectory)
             initialDirectory == null ? "" : initialDirectory);
       terminalSessionsPanel_.addNewTerminalPanel(info, defaultTerminalOptions(),
                                                  uiPrefs_.tabKeyMoveFocus().getValue(),
+                                                 uiPrefs_.terminalWeblinks().getValue(),
                                                  false /*createdByApi*/, session ->
       {
          terminals_.startTerminal(session, new ResultCallback<Boolean, String>()
@@ -875,6 +876,7 @@ public void onFailure(String msg)
 
       terminalSessionsPanel_.addNewTerminalPanel(existing, defaultTerminalOptions(),
                                                  uiPrefs_.tabKeyMoveFocus().getValue(),
+                                                 uiPrefs_.terminalWeblinks().getValue(),
                                                  event.createdByApi(), session ->
       {
          terminals_.startTerminal(session, new ResultCallback<Boolean, String>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -73,14 +73,16 @@ public class TerminalSession extends XTermWidget
     * @param info terminal metadata
     * @param options terminal emulator options
     * @param tabMovesFocus does pressing tab key move focus out of terminal
+    * @param showWebLinks links detected and made clickable
     * @param createdByApi was this terminal just created by the rstudioapi
     */
    public TerminalSession(ConsoleProcessInfo info,
                           XTermOptions options,
                           boolean tabMovesFocus,
+                          boolean showWebLinks,
                           boolean createdByApi)
    {
-      super(options, tabMovesFocus);
+      super(options, tabMovesFocus, showWebLinks);
 
       RStudioGinjector.INSTANCE.injectMembers(this);
       procInfo_ = info;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermResources.java
Patch:
@@ -27,4 +27,7 @@ public interface XTermResources extends ClientBundle
 
    @Source("fit.js")
    StaticDataResource xtermfitjs();
+
+   @Source("web-links.js")
+   StaticDataResource xtermweblinksjs();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermTheme.java
Patch:
@@ -152,8 +152,8 @@ else if (doubleEqualish(size, 36.0))
       double lineHeight = FontSizer.getNormalLineHeight();
 
       // due to units oddity, have to scale down before passing to xterm.js
-      // (pixels vs. pts)
-      return lineHeight > 1.0 ? lineHeight * 0.75 : 1.0;
+      // (pixels vs. pts); don't go below 1.0 as lines will begin to overlap
+      return Math.max(lineHeight > 1.0 ? lineHeight * 0.75 : 1.0, 1.0);
    }
 
    @JsOverlay public static XTermTheme create(

File: src/gwt/src/org/rstudio/core/client/command/impl/WebMenuCallback.java
Patch:
@@ -32,7 +32,9 @@ public class WebMenuCallback implements MenuCallback
 {
    public void beginMainMenu()
    {
-      menuStack_.push(new AppMenuBar(false));
+      AppMenuBar mainMenu = new AppMenuBar(false);
+      mainMenu.setEscClosesAll(false);
+      menuStack_.push(mainMenu);
    }
 
    public void beginMenu(String label)

File: src/gwt/src/org/rstudio/core/client/command/impl/WebMenuCallback.java
Patch:
@@ -32,7 +32,9 @@ public class WebMenuCallback implements MenuCallback
 {
    public void beginMainMenu()
    {
-      menuStack_.push(new AppMenuBar(false));
+      AppMenuBar mainMenu = new AppMenuBar(false);
+      mainMenu.setEscClosesAll(false);
+      menuStack_.push(mainMenu);
    }
 
    public void beginMenu(String label)

File: src/gwt/src/org/rstudio/core/client/command/impl/WebMenuCallback.java
Patch:
@@ -38,6 +38,7 @@ public void beginMainMenu()
    public void beginMenu(String label)
    {
       AppMenuBar newMenu = new AppMenuBar(true);
+      newMenu.setEscClosesAll(false);
 
       // Adjust the z-index of the displayed sub-menu, so that it (and any
       // adorning contents) are rendered in front of their parents.

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -38,6 +38,7 @@ public CompileOutputBufferWithHighlight()
       output_.addStyleName(styles_.paddedOutput());
       FontSizer.applyNormalFontSize(output_);
       console_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(output_.getElement());
+      console_.setVirtualizedDisableOverride(true); // disable virtualization of scroller
     
       scrollPanel_ = new BottomScrollPanel();
       scrollPanel_.setSize("100%", "100%");

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java
Patch:
@@ -517,7 +517,7 @@ public boolean shouldCheckWord(String word)
       severe issues with. This is being tracked to be fixed in issue #6041 as
       soon as possible so this can then be removed.
     */
-   private static String[] realtimeDictBlacklist = {"cs_CZ", "de_DE_neu", "lt_LT", "lt_LT_new", "pt_BR", "it_IT"};
+   private final static String[] realtimeDictBlacklist = {"lt_LT", "lt_LT_new", "pt_BR", "it_IT"};
    public static boolean canRealtimeSpellcheckDict(String dict)
    {
       boolean exists = false;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -535,6 +535,7 @@
    public abstract AppCommand loadServerHome();
 
    // Build
+   public abstract AppCommand clearBuild();
    public abstract AppCommand buildAll();
    public abstract AppCommand devtoolsLoadAll();
    public abstract AppCommand rebuildAll();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AccessibilityPreferencesPane.java
Patch:
@@ -68,7 +68,8 @@ public AccessibilityPreferencesPane(UserPrefs prefs,
       chkTabMovesFocus_ = new CheckBox("Tab key always moves focus");
       generalPanel.add(lessSpaced(chkTabMovesFocus_));
       chkShowFocusRectangles_ = new CheckBox("Always show focus outlines (requires restart)");
-      generalPanel.add(chkShowFocusRectangles_);
+      generalPanel.add(lessSpaced(chkShowFocusRectangles_));
+      generalPanel.add(checkboxPref("Highlight focused panel", prefs.showPanelFocusRectangle()));
 
       HelpLink helpLink = new HelpLink("RStudio accessibility help", "rstudio_a11y", false);
       nudgeRight(helpLink);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildCommands.java
Patch:
@@ -72,6 +72,7 @@ public static void setBuildCommandState(Commands commands,
          commands.stopBuild().remove();
          commands.activateBuild().remove();
          commands.layoutZoomBuild().remove();
+         commands.clearBuild().remove();
       }
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceVimCommands.java
Patch:
@@ -120,7 +120,7 @@ public native final void createNewDocument(SourceColumnManager source) /*-{
          // Handle other editing targets
          else if (params.args) {
             if (params.args.length === 1) {
-               source.getColumnManager()().@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::editFile(Ljava/lang/String;)(params.args[0]);
+               source.getColumnManager()().@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::vimEditFile(Ljava/lang/String;)(params.args[0]);
             }
             // TODO: on error?
          } else {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DocTabDragParams.java
Patch:
@@ -51,7 +51,7 @@ public final native static DocTabDragParams create(String docId,
         tab_width      : 0,
         cursor_offset  : 0,
         source_position: position,
-        display_name   : display_name
+        display_name   : displayName
      }
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalDeckPanel.java
Patch:
@@ -37,10 +37,11 @@ public void addNewTerminalPanel(
          ConsoleProcessInfo procInfo,
          XTermOptions options,
          boolean tabMovesFocus,
+         boolean showWebLinks,
          boolean createdByApi,
          CommandWithArg<TerminalSession> callback)
    {
-      TerminalSession session = new TerminalSession(procInfo, options, tabMovesFocus, createdByApi);
+      TerminalSession session = new TerminalSession(procInfo, options, tabMovesFocus, showWebLinks, createdByApi);
       add(session);
       showWidget(session);
       Scheduler.get().scheduleDeferred(() ->  callback.execute(session));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -334,6 +334,7 @@ public void createTerminal(String postCreateText, String initialDirectory)
             initialDirectory == null ? "" : initialDirectory);
       terminalSessionsPanel_.addNewTerminalPanel(info, defaultTerminalOptions(),
                                                  uiPrefs_.tabKeyMoveFocus().getValue(),
+                                                 uiPrefs_.terminalWeblinks().getValue(),
                                                  false /*createdByApi*/, session ->
       {
          terminals_.startTerminal(session, new ResultCallback<Boolean, String>()
@@ -875,6 +876,7 @@ public void onFailure(String msg)
 
       terminalSessionsPanel_.addNewTerminalPanel(existing, defaultTerminalOptions(),
                                                  uiPrefs_.tabKeyMoveFocus().getValue(),
+                                                 uiPrefs_.terminalWeblinks().getValue(),
                                                  event.createdByApi(), session ->
       {
          terminals_.startTerminal(session, new ResultCallback<Boolean, String>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -73,14 +73,16 @@ public class TerminalSession extends XTermWidget
     * @param info terminal metadata
     * @param options terminal emulator options
     * @param tabMovesFocus does pressing tab key move focus out of terminal
+    * @param showWebLinks links detected and made clickable
     * @param createdByApi was this terminal just created by the rstudioapi
     */
    public TerminalSession(ConsoleProcessInfo info,
                           XTermOptions options,
                           boolean tabMovesFocus,
+                          boolean showWebLinks,
                           boolean createdByApi)
    {
-      super(options, tabMovesFocus);
+      super(options, tabMovesFocus, showWebLinks);
 
       RStudioGinjector.INSTANCE.injectMembers(this);
       procInfo_ = info;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermResources.java
Patch:
@@ -27,4 +27,7 @@ public interface XTermResources extends ClientBundle
 
    @Source("fit.js")
    StaticDataResource xtermfitjs();
+
+   @Source("web-links.js")
+   StaticDataResource xtermweblinksjs();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermTheme.java
Patch:
@@ -152,8 +152,8 @@ else if (doubleEqualish(size, 36.0))
       double lineHeight = FontSizer.getNormalLineHeight();
 
       // due to units oddity, have to scale down before passing to xterm.js
-      // (pixels vs. pts)
-      return lineHeight > 1.0 ? lineHeight * 0.75 : 1.0;
+      // (pixels vs. pts); don't go below 1.0 as lines will begin to overlap
+      return Math.max(lineHeight > 1.0 ? lineHeight * 0.75 : 1.0, 1.0);
    }
 
    @JsOverlay public static XTermTheme create(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1737,7 +1737,7 @@ public void onSuccess(EditingTarget arg)
 
                   SourcePosition position = event.getCursorPosition();
                   if (position != null &&
-                      position.getRow() > 0 &&
+                      position.getRow() > 0 ||
                       position.getColumn() > 0)
                   {
                      editingTarget.navigateToPosition(position, false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceVimCommands.java
Patch:
@@ -120,7 +120,7 @@ public native final void createNewDocument(SourceColumnManager source) /*-{
          // Handle other editing targets
          else if (params.args) {
             if (params.args.length === 1) {
-               source.getColumnManager()().@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::editFile(Ljava/lang/String;)(params.args[0]);
+               source.getColumnManager()().@org.rstudio.studio.client.workbench.views.source.SourceColumnManager::vimEditFile(Ljava/lang/String;)(params.args[0]);
             }
             // TODO: on error?
          } else {

File: src/gwt/src/org/rstudio/studio/client/common/satellite/Satellite.java
Patch:
@@ -69,6 +69,9 @@ public void initialize(String name,
       // load MathJax
       MathJaxLoader.ensureMathJaxLoaded();
 
+      // load focus-visible polyfill
+      RStudioGinjector.INSTANCE.getFocusVisiblePolyfill().load(null);
+
       // NOTE: Desktop doesn't seem to get onWindowClosing events in Qt 4.8
       // so we instead rely on an explicit callback from the desktop frame
       // to notifyRStudioSatelliteClosing

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AccessibilityPreferencesPane.java
Patch:
@@ -68,7 +68,8 @@ public AccessibilityPreferencesPane(UserPrefs prefs,
       chkTabMovesFocus_ = new CheckBox("Tab key always moves focus");
       generalPanel.add(lessSpaced(chkTabMovesFocus_));
       chkShowFocusRectangles_ = new CheckBox("Always show focus outlines (requires restart)");
-      generalPanel.add(chkShowFocusRectangles_);
+      generalPanel.add(lessSpaced(chkShowFocusRectangles_));
+      generalPanel.add(checkboxPref("Highlight focused panel", prefs.showPanelFocusRectangle()));
 
       HelpLink helpLink = new HelpLink("RStudio accessibility help", "rstudio_a11y", false);
       nudgeRight(helpLink);

File: src/gwt/src/org/rstudio/studio/client/common/satellite/Satellite.java
Patch:
@@ -69,6 +69,9 @@ public void initialize(String name,
       // load MathJax
       MathJaxLoader.ensureMathJaxLoaded();
 
+      // load focus-visible polyfill
+      RStudioGinjector.INSTANCE.getFocusVisiblePolyfill().load(null);
+
       // NOTE: Desktop doesn't seem to get onWindowClosing events in Qt 4.8
       // so we instead rely on an explicit callback from the desktop frame
       // to notifyRStudioSatelliteClosing

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AccessibilityPreferencesPane.java
Patch:
@@ -68,7 +68,8 @@ public AccessibilityPreferencesPane(UserPrefs prefs,
       chkTabMovesFocus_ = new CheckBox("Tab key always moves focus");
       generalPanel.add(lessSpaced(chkTabMovesFocus_));
       chkShowFocusRectangles_ = new CheckBox("Always show focus outlines (requires restart)");
-      generalPanel.add(chkShowFocusRectangles_);
+      generalPanel.add(lessSpaced(chkShowFocusRectangles_));
+      generalPanel.add(checkboxPref("Highlight focused panel", prefs.showPanelFocusRectangle()));
 
       HelpLink helpLink = new HelpLink("RStudio accessibility help", "rstudio_a11y", false);
       nudgeRight(helpLink);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalDeckPanel.java
Patch:
@@ -37,10 +37,11 @@ public void addNewTerminalPanel(
          ConsoleProcessInfo procInfo,
          XTermOptions options,
          boolean tabMovesFocus,
+         boolean showWebLinks,
          boolean createdByApi,
          CommandWithArg<TerminalSession> callback)
    {
-      TerminalSession session = new TerminalSession(procInfo, options, tabMovesFocus, createdByApi);
+      TerminalSession session = new TerminalSession(procInfo, options, tabMovesFocus, showWebLinks, createdByApi);
       add(session);
       showWidget(session);
       Scheduler.get().scheduleDeferred(() ->  callback.execute(session));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -334,6 +334,7 @@ public void createTerminal(String postCreateText, String initialDirectory)
             initialDirectory == null ? "" : initialDirectory);
       terminalSessionsPanel_.addNewTerminalPanel(info, defaultTerminalOptions(),
                                                  uiPrefs_.tabKeyMoveFocus().getValue(),
+                                                 uiPrefs_.terminalWeblinks().getValue(),
                                                  false /*createdByApi*/, session ->
       {
          terminals_.startTerminal(session, new ResultCallback<Boolean, String>()
@@ -875,6 +876,7 @@ public void onFailure(String msg)
 
       terminalSessionsPanel_.addNewTerminalPanel(existing, defaultTerminalOptions(),
                                                  uiPrefs_.tabKeyMoveFocus().getValue(),
+                                                 uiPrefs_.terminalWeblinks().getValue(),
                                                  event.createdByApi(), session ->
       {
          terminals_.startTerminal(session, new ResultCallback<Boolean, String>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -73,14 +73,16 @@ public class TerminalSession extends XTermWidget
     * @param info terminal metadata
     * @param options terminal emulator options
     * @param tabMovesFocus does pressing tab key move focus out of terminal
+    * @param showWebLinks links detected and made clickable
     * @param createdByApi was this terminal just created by the rstudioapi
     */
    public TerminalSession(ConsoleProcessInfo info,
                           XTermOptions options,
                           boolean tabMovesFocus,
+                          boolean showWebLinks,
                           boolean createdByApi)
    {
-      super(options, tabMovesFocus);
+      super(options, tabMovesFocus, showWebLinks);
 
       RStudioGinjector.INSTANCE.injectMembers(this);
       procInfo_ = info;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermResources.java
Patch:
@@ -27,4 +27,7 @@ public interface XTermResources extends ClientBundle
 
    @Source("fit.js")
    StaticDataResource xtermfitjs();
+
+   @Source("web-links.js")
+   StaticDataResource xtermweblinksjs();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DocTabDragParams.java
Patch:
@@ -51,7 +51,7 @@ public final native static DocTabDragParams create(String docId,
         tab_width      : 0,
         cursor_offset  : 0,
         source_position: position,
-        display_name   : display_name
+        display_name   : displayName
      }
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DocTabDragParams.java
Patch:
@@ -51,7 +51,7 @@ public final native static DocTabDragParams create(String docId,
         tab_width      : 0,
         cursor_offset  : 0,
         source_position: position,
-        display_name   : display_name
+        display_name   : displayName
      }
    }-*/;
    

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -201,6 +201,7 @@ public interface ThemeStyles extends CssResource
 
    String progressPanel();
 
+   String clearBuildButton();
    String consoleClearButton();
    String terminalClearButton();
    String refreshToolbarButton();

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -38,6 +38,7 @@ public CompileOutputBufferWithHighlight()
       output_.addStyleName(styles_.paddedOutput());
       FontSizer.applyNormalFontSize(output_);
       console_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(output_.getElement());
+      console_.setVirtualizedDisableOverride(true); // disable virtualization of scroller
     
       scrollPanel_ = new BottomScrollPanel();
       scrollPanel_.setSize("100%", "100%");

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -535,6 +535,7 @@
    public abstract AppCommand loadServerHome();
 
    // Build
+   public abstract AppCommand clearBuild();
    public abstract AppCommand buildAll();
    public abstract AppCommand devtoolsLoadAll();
    public abstract AppCommand rebuildAll();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildCommands.java
Patch:
@@ -72,6 +72,7 @@ public static void setBuildCommandState(Commands commands,
          commands.stopBuild().remove();
          commands.activateBuild().remove();
          commands.layoutZoomBuild().remove();
+         commands.clearBuild().remove();
       }
    }
 }

File: src/gwt/src/org/rstudio/core/client/command/impl/WebMenuCallback.java
Patch:
@@ -38,6 +38,7 @@ public void beginMainMenu()
    public void beginMenu(String label)
    {
       AppMenuBar newMenu = new AppMenuBar(true);
+      newMenu.setEscClosesAll(false);
 
       // Adjust the z-index of the displayed sub-menu, so that it (and any
       // adorning contents) are rendered in front of their parents.

File: src/gwt/src/org/rstudio/core/client/command/impl/WebMenuCallback.java
Patch:
@@ -38,6 +38,7 @@ public void beginMainMenu()
    public void beginMenu(String label)
    {
       AppMenuBar newMenu = new AppMenuBar(true);
+      newMenu.setEscClosesAll(false);
 
       // Adjust the z-index of the displayed sub-menu, so that it (and any
       // adorning contents) are rendered in front of their parents.

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -1536,8 +1536,6 @@ private void createSourceColumn()
 
       Widget panel = createSourceColumnWindow(name.getName(), name.getAccessibleName());
       panel_.addLeftWidget(panel);
-      leftList_.add(panel);
-      sourceColumnManager_.beforeShow(name.getName());
    }
 
    private Widget createSourceColumnWindow(String name, String accessibleName)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/lint/LintManager.java
Patch:
@@ -197,7 +197,7 @@ private void lintActiveDocument(final LintContext context)
 
       if (context.showMarkers)
       {
-         target_.saveThenExecute(null, new Command()
+         target_.saveThenExecute(null, false, new Command()
          {
             @Override
             public void execute()
@@ -208,7 +208,7 @@ public void execute()
       }
       else
       {
-         target_.withSavedDoc(new Command()
+         target_.withSavedDocNoRetry(new Command()
          {
             @Override
             public void execute()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -101,6 +101,7 @@ void saveDocument(String id,
                      String foldSpec,
                      JsArray<ChunkDefinition> chunkOutput,
                      String contents,
+                     boolean retryWrite,
                      ServerRequestCallback<String> requestCallback);
 
    /**
@@ -126,6 +127,7 @@ void saveDocumentDiff(String id,
                          int length,
                          boolean valid,
                          String hash,
+                         boolean retryWrite,
                          ServerRequestCallback<String> requestCallback);
 
    void checkForExternalEdit(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermTheme.java
Patch:
@@ -152,8 +152,8 @@ else if (doubleEqualish(size, 36.0))
       double lineHeight = FontSizer.getNormalLineHeight();
 
       // due to units oddity, have to scale down before passing to xterm.js
-      // (pixels vs. pts)
-      return lineHeight > 1.0 ? lineHeight * 0.75 : 1.0;
+      // (pixels vs. pts); don't go below 1.0 as lines will begin to overlap
+      return Math.max(lineHeight > 1.0 ? lineHeight * 0.75 : 1.0, 1.0);
    }
 
    @JsOverlay public static XTermTheme create(

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -38,6 +38,7 @@ public CompileOutputBufferWithHighlight()
       output_.addStyleName(styles_.paddedOutput());
       FontSizer.applyNormalFontSize(output_);
       console_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(output_.getElement());
+      console_.setVirtualizedDisableOverride(true); // disable virtualization of scroller
     
       scrollPanel_ = new BottomScrollPanel();
       scrollPanel_.setSize("100%", "100%");

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -535,6 +535,7 @@
    public abstract AppCommand loadServerHome();
 
    // Build
+   public abstract AppCommand buildClear();
    public abstract AppCommand buildAll();
    public abstract AppCommand devtoolsLoadAll();
    public abstract AppCommand rebuildAll();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermTheme.java
Patch:
@@ -152,8 +152,8 @@ else if (doubleEqualish(size, 36.0))
       double lineHeight = FontSizer.getNormalLineHeight();
 
       // due to units oddity, have to scale down before passing to xterm.js
-      // (pixels vs. pts)
-      return lineHeight > 1.0 ? lineHeight * 0.75 : 1.0;
+      // (pixels vs. pts); don't go below 1.0 as lines will begin to overlap
+      return Math.max(lineHeight > 1.0 ? lineHeight * 0.75 : 1.0, 1.0);
    }
 
    @JsOverlay public static XTermTheme create(

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java
Patch:
@@ -517,7 +517,7 @@ public boolean shouldCheckWord(String word)
       severe issues with. This is being tracked to be fixed in issue #6041 as
       soon as possible so this can then be removed.
     */
-   private static String[] realtimeDictBlacklist = {"cs_CZ", "de_DE_neu", "lt_LT", "lt_LT_new", "pt_BR", "it_IT"};
+   private final static String[] realtimeDictBlacklist = {"lt_LT", "lt_LT_new", "pt_BR", "it_IT"};
    public static boolean canRealtimeSpellcheckDict(String dict)
    {
       boolean exists = false;

File: src/gwt/src/org/rstudio/core/client/theme/PrimaryWindowFrame.java
Patch:
@@ -45,7 +45,7 @@ public HandlerRegistration addMouseDownHandler(MouseDownHandler handler)
    public PrimaryWindowFrame(String title,
                              Widget mainWidget)
    {
-      super(title);
+      super(title, title);
       ThemeStyles styles = ThemeResources.INSTANCE.themeStyles();
 
       panel_ = new ClickFlowPanel();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdChunkOutputUnit.java
Patch:
@@ -46,7 +46,7 @@ public final native int getOrdinal() /*-{
       return this.output_ordinal;
    }-*/;
 
-   public final native JavaScriptObject getOuputObject() /*-{
+   public final native JavaScriptObject getOutputObject() /*-{
       return this.output_val;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkOutputUi.java
Patch:
@@ -175,7 +175,7 @@ public String getDocId()
 
    public final static int MIN_CHUNK_HEIGHT = 25;
    public final static int CHUNK_COLLAPSED_HEIGHT = 15;
-   public final static int MAX_CHUNK_HEIGHT = 650;
+   public final static int MAX_CHUNK_HEIGHT = 1000;
    
    public final static int MIN_PLOT_WIDTH = 400;
    public final static int MAX_PLOT_WIDTH = 700;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdChunkOutputUnit.java
Patch:
@@ -46,7 +46,7 @@ public final native int getOrdinal() /*-{
       return this.output_ordinal;
    }-*/;
 
-   public final native JavaScriptObject getOuputObject() /*-{
+   public final native JavaScriptObject getOutputObject() /*-{
       return this.output_val;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkOutputUi.java
Patch:
@@ -175,7 +175,7 @@ public String getDocId()
 
    public final static int MIN_CHUNK_HEIGHT = 25;
    public final static int CHUNK_COLLAPSED_HEIGHT = 15;
-   public final static int MAX_CHUNK_HEIGHT = 650;
+   public final static int MAX_CHUNK_HEIGHT = 1000;
    
    public final static int MIN_PLOT_WIDTH = 400;
    public final static int MAX_PLOT_WIDTH = 700;

File: src/gwt/src/org/rstudio/core/client/theme/PrimaryWindowFrame.java
Patch:
@@ -45,7 +45,7 @@ public HandlerRegistration addMouseDownHandler(MouseDownHandler handler)
    public PrimaryWindowFrame(String title,
                              Widget mainWidget)
    {
-      super(title);
+      super(title, title);
       ThemeStyles styles = ThemeResources.INSTANCE.themeStyles();
 
       panel_ = new ClickFlowPanel();
@@ -88,12 +88,12 @@ public void setSubtitle(String subtitle)
    {
       subtitle_.setText(subtitle);
    }
-   
+
    public void addLeftWidget(Widget widget)
    {
       panel_.add(widget);
    }
-   
+
    private final DoubleClickState doubleClickState_ = new DoubleClickState();
    private final Label subtitle_;
    private final ClickFlowPanel panel_;

File: src/gwt/src/org/rstudio/core/client/StringUtil.java
Patch:
@@ -125,7 +125,7 @@ else if (DateTimeFormat.getFormat("yyyy").format(date) ==
 
    public static String formatFileSize(long size)
    {
-      return formatFileSize(new Long(size).intValue());
+      return formatFileSize(Long.valueOf(size).intValue());
    }
 
    // return a friendly (not precise) elapsed time

File: src/gwt/src/org/rstudio/core/client/resources/ImageResource2x.java
Patch:
@@ -101,9 +101,9 @@ public SafeHtml getSafeHtml(String altText)
          sb.appendHtmlConstant("<img src=\"");
          sb.appendHtmlConstant(getSafeUri().asString());
          sb.appendHtmlConstant("\" width=\"");
-         sb.appendHtmlConstant(new Integer(getWidth()).toString());
+         sb.appendHtmlConstant(Integer.valueOf(getWidth()).toString());
          sb.appendHtmlConstant("\" height=\"");
-         sb.appendHtmlConstant(new Integer(getHeight()).toString());
+         sb.appendHtmlConstant(Integer.valueOf(getHeight()).toString());
          if (StringUtil.isNullOrEmpty(altText))
          {
             sb.appendHtmlConstant("\" alt");

File: src/gwt/src/org/rstudio/core/client/resources/ImageResourceUrl.java
Patch:
@@ -84,9 +84,9 @@ public SafeHtml getSafeHtml()
       sb.appendHtmlConstant("<img src=\"");
       sb.appendHtmlConstant(getSafeUri().asString());
       sb.appendHtmlConstant("\" width=\"");
-      sb.appendHtmlConstant(new Integer(getWidth()).toString());
+      sb.appendHtmlConstant(Integer.valueOf(getWidth()).toString());
       sb.appendHtmlConstant("\" height=\"");
-      sb.appendHtmlConstant(new Integer(getHeight()).toString());
+      sb.appendHtmlConstant(Integer.valueOf(getHeight()).toString());
       sb.appendHtmlConstant("\">");
 
       return sb.toSafeHtml();

File: src/gwt/src/org/rstudio/core/client/widget/SelectWidget.java
Patch:
@@ -245,7 +245,7 @@ public int getIntValue()
 
    public void setIntValue(int value)
    {
-      setValue(new Integer(value).toString());
+      setValue(Integer.valueOf(value).toString());
    }
 
    public void addWidget(Widget widget)

File: src/gwt/src/org/rstudio/studio/client/application/model/HttpLogEntry.java
Patch:
@@ -61,7 +61,7 @@ public native final String getRequestId() /*-{
 
    public final Date getTimestamp()
    {
-      Double timestamp = new Double(getTimestampNative());
+      Double timestamp = getTimestampNative();
       return new Date(timestamp.longValue());
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleErrorFrame.java
Patch:
@@ -53,7 +53,7 @@ public ConsoleErrorFrame(int number, ErrorFrame frame)
 
       boolean hasSource = !frame.getFileName().isEmpty();
       functionName.setText(frame.getFunctionName() + (hasSource ? " at" : ""));
-      frameNumber.setText((new Integer(number)).toString() + ".");
+      frameNumber.setText((Integer.valueOf(number)).toString() + ".");
       if (hasSource)
       {
          sourceLink.setText(

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewProgressDialog.java
Patch:
@@ -43,7 +43,7 @@ public HTMLPreviewProgressDialog(String caption)
 
    public HTMLPreviewProgressDialog(String caption, int maxHeight)
    {
-      super(caption, Roles.getDialogRole(), new Integer(maxHeight));
+      super(caption, Roles.getDialogRole(), maxHeight);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/model/QuotaStatus.java
Patch:
@@ -68,7 +68,7 @@ private final boolean isNear(double threshold)
 
    private final long getLongValue(String value)
    {
-      return new Double(getValueNative(value)).longValue();
+      return Double.valueOf(getValueNative(value)).longValue();
    }
 
    private final native double getValueNative(String value) /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectGrid.java
Patch:
@@ -311,7 +311,7 @@ private void setColumnWidths()
       {
          setColumnWidth(
                start + i,
-               new Integer(columns_.get(i).getWidth()).toString() + "%");
+               Integer.valueOf(columns_.get(i).getWidth()).toString() + "%");
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -326,7 +326,7 @@ public int getObjectDisplay()
    // of an apparent timing bug triggered by superdevmode (see case 3745).
    public void setObjectDisplay(int type)
    {
-      deferredObjectDisplayType_ = new Integer(type);
+      deferredObjectDisplayType_ = type;
       Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          @Override
@@ -777,7 +777,7 @@ private void redrawRowSafely(int idx)
    private int deferredScrollPosition_ = 0;
    private JsArrayString deferredExpandedObjects_;
    private boolean pendingCallFramePanelSize_ = false;
-   private Integer deferredObjectDisplayType_ = new Integer(OBJECT_LIST_VIEW);
+   private Integer deferredObjectDisplayType_ = OBJECT_LIST_VIEW;
    private int gridRenderRetryCount_ = 0;
 
    public final static int MAX_ENVIRONMENT_OBJECTS = 1024;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -249,8 +249,8 @@ public String getValue(FileSystemItem file)
          @Override
          public int doItemCompare(FileSystemItem arg0, FileSystemItem arg1)
          {
-            return new Long(arg0.getLength()).compareTo(
-                                             new Long(arg1.getLength()));
+            return Long.valueOf(arg0.getLength()).compareTo(
+                                             Long.valueOf(arg1.getLength()));
          }
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/History.java
Patch:
@@ -236,7 +236,7 @@ public void onConsoleResetHistory(ConsoleResetHistoryEvent event)
                preservedScrollPos = view_.getRecentCommandsScrollPosition();
 
                if (historyPosition_ < commands.size())
-                  startIndex = new Long(historyPosition_).intValue();
+                  startIndex = Long.valueOf(historyPosition_).intValue();
             }
 
             // set recent commands

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/model/HistoryEntry.java
Patch:
@@ -34,12 +34,12 @@ public static final native HistoryEntry create(int index, String command) /*-{
 
    public final long getIndex()
    {
-      return new Double(getIndexNative()).longValue();
+      return Double.valueOf(getIndexNative()).longValue();
    }
 
    public final Date getTimestamp()
    {
-      Double lastModified = new Double(getTimestampNative());
+      Double lastModified = getTimestampNative();
       return new Date(lastModified.longValue());
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/Plots.java
Patch:
@@ -157,8 +157,8 @@ public void onManipulatorChanged(JSONObject values)
             @Override
             public void onClick(ClickEvent event)
             {
-               int x = new Double(event.getX()).intValue();
-               int y = new Double(event.getY()).intValue();
+               int x = Double.valueOf(event.getX()).intValue();
+               int y = Double.valueOf(event.getY()).intValue();
 
                // Re-scale for OSX Quartz
                if (BrowseCap.isMacintoshDesktop())

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -1138,7 +1138,7 @@ public void onTabReorder(TabReorderEvent event)
 
       // remove the tab from its old position
       int idx = tabOrder_.get(event.getOldPos());
-      tabOrder_.remove(new Integer(idx));  // force type box
+      tabOrder_.remove(Integer.valueOf(idx));  // force type box
 
       // add it to its new position
       tabOrder_.add(event.getNewPos(), idx);
@@ -1191,7 +1191,7 @@ private void closeTabIndex(int idx, boolean closeDocument)
    {
       EditingTarget target = editors_.remove(idx);
 
-      tabOrder_.remove(new Integer(idx));
+      tabOrder_.remove(Integer.valueOf(idx));
       for (int i = 0; i < tabOrder_.size(); i++)
       {
          if (tabOrder_.get(i) > idx)

File: src/gwt/src/org/rstudio/studio/client/panmirror/server/PanmirrorServerOperations.java
Patch:
@@ -22,6 +22,8 @@
 
 public interface PanmirrorServerOperations extends PanmirrorPandocServerOperations,
                                                    PanmirrorCrossrefServerOperations,
+                                                   PanmirrorDataCiteServerOperations,
+                                                   PanmirrorPubMedServerOperations,
                                                    PanmirrorZoteroServerOperations,
                                                    PanmirrorXRefServerOperations,
                                                    PanmirrorDOIServerOperations

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -435,7 +435,7 @@ public PrefValue<String> bibliographyDefaultType()
             BIBLIOGRAPHY_DEFAULT_TYPE_YAML,
             BIBLIOGRAPHY_DEFAULT_TYPE_JSON
          },
-         "yaml");
+         "bib");
    }
 
    public final static String BIBLIOGRAPHY_DEFAULT_TYPE_BIB = "bib";

File: src/gwt/src/org/rstudio/core/client/resources/ImageResource2x.java
Patch:
@@ -42,7 +42,7 @@ private ImageResource getResource()
    {
       return getUse2xResolution() ? ref2x_ : ref_;
    }
-   
+
    @Override
    public String getName()
    {
@@ -101,9 +101,9 @@ public SafeHtml getSafeHtml(String altText)
          sb.appendHtmlConstant("<img src=\"");
          sb.appendHtmlConstant(getSafeUri().asString());
          sb.appendHtmlConstant("\" width=\"");
-         sb.appendHtmlConstant(new Integer(getWidth()).toString());
+         sb.appendHtmlConstant(Integer.valueOf(getWidth()).toString());
          sb.appendHtmlConstant("\" height=\"");
-         sb.appendHtmlConstant(new Integer(getHeight()).toString());
+         sb.appendHtmlConstant(Integer.valueOf(getHeight()).toString());
          if (StringUtil.isNullOrEmpty(altText))
          {
             sb.appendHtmlConstant("\" alt");

File: src/gwt/src/org/rstudio/core/client/resources/ImageResourceUrl.java
Patch:
@@ -27,7 +27,7 @@ public ImageResourceUrl(SafeUri url, int width, int height)
       width_ = width;
       height_ = height;
    }
-   
+
    @Override
    public String getName()
    {
@@ -84,9 +84,9 @@ public SafeHtml getSafeHtml()
       sb.appendHtmlConstant("<img src=\"");
       sb.appendHtmlConstant(getSafeUri().asString());
       sb.appendHtmlConstant("\" width=\"");
-      sb.appendHtmlConstant(new Integer(getWidth()).toString());
+      sb.appendHtmlConstant(Integer.valueOf(getWidth()).toString());
       sb.appendHtmlConstant("\" height=\"");
-      sb.appendHtmlConstant(new Integer(getHeight()).toString());
+      sb.appendHtmlConstant(Integer.valueOf(getHeight()).toString());
       sb.appendHtmlConstant("\">");
 
       return sb.toSafeHtml();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/History.java
Patch:
@@ -236,7 +236,7 @@ public void onConsoleResetHistory(ConsoleResetHistoryEvent event)
                preservedScrollPos = view_.getRecentCommandsScrollPosition();
 
                if (historyPosition_ < commands.size())
-                  startIndex = new Long(historyPosition_).intValue();
+                  startIndex = Long.valueOf(historyPosition_).intValue();
             }
 
             // set recent commands

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/Plots.java
Patch:
@@ -157,8 +157,8 @@ public void onManipulatorChanged(JSONObject values)
             @Override
             public void onClick(ClickEvent event)
             {
-               int x = new Double(event.getX()).intValue();
-               int y = new Double(event.getY()).intValue();
+               int x = Double.valueOf(event.getX()).intValue();
+               int y = Double.valueOf(event.getY()).intValue();
 
                // Re-scale for OSX Quartz
                if (BrowseCap.isMacintoshDesktop())

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUIChunkEditor.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * PanmirrorUIRmdChunkEditor.java
+ * PanmirrorUIChunkEditor.java
  *
  * Copyright (C) 2020 by RStudio, PBC
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeChunks.java
Patch:
@@ -48,7 +48,7 @@ public VisualModeChunks(DocUpdateSentinel sentinel,
    public PanmirrorUIChunks uiChunks()
    {
       PanmirrorUIChunks chunks = new PanmirrorUIChunks();
-      chunks.createChunkEditor = (type, index, getPos) ->
+      chunks.createChunkEditor = (type, index, callbacks) ->
       {
          // only know how to create ace instances right now
          if (!type.equals("ace"))
@@ -58,7 +58,7 @@ public PanmirrorUIChunks uiChunks()
          }
          
          VisualModeChunk chunk = new VisualModeChunk(
-               index, getPos, sentinel_, target_, sync_);
+               index, callbacks, sentinel_, target_, sync_);
 
          // Add the chunk to our index, and remove it when the underlying chunk
          // is removed in Prosemirror

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -435,7 +435,7 @@ public PrefValue<String> bibliographyDefaultType()
             BIBLIOGRAPHY_DEFAULT_TYPE_YAML,
             BIBLIOGRAPHY_DEFAULT_TYPE_JSON
          },
-         "yaml");
+         "bib");
    }
 
    public final static String BIBLIOGRAPHY_DEFAULT_TYPE_BIB = "bib";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -800,7 +800,6 @@ else if (data.getType() == RmdChunkOutputFinishedEvent.TYPE_INTERACTIVE &&
          ArrayList<String> callbacks = data.getHtmlCallback();
          for (String callback : callbacks)
             outputs_.get(data.getChunkId()).getOutputWidget().renderHtml(callback);
-         setDirtyState();
       }
    }
 

File: src/gwt/src/org/rstudio/core/rebind/command/MenuEmitter.java
Patch:
@@ -78,7 +78,7 @@ public void processCommand(String commandId) throws UnableToCompleteException
             return;
          }
 
-         char accessKey = menuText.charAt(index + 1);
+         char accessKey = Character.toLowerCase(menuText.charAt(index + 1));
          availableKeys_.remove(accessKey);
       }
 
@@ -98,6 +98,7 @@ public void report() throws UnableToCompleteException
          }
          message.append("]");
          logger_.log(TreeLogger.Type.ERROR, message.toString());
+         throw new UnableToCompleteException();
       }
 
       private final List<String> missingKeys_ = new ArrayList<>();

File: src/gwt/src/org/rstudio/core/client/RegexUtil.java
Patch:
@@ -67,6 +67,9 @@ private static final native String makeWordCharacter()
    public static final Pattern RE_SWEAVE_CHUNK_END =
          Pattern.create("^\\s*@\\s*$", "");
    
+   public static final Pattern RE_EMBEDDED_R_CHUNK_BEGIN =
+         Pattern.create("^\\s*\\{(.*?)\\}\\s*$", "");
+   
    static { initialize(); }
    
 }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -182,7 +182,6 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;
 import org.rstudio.studio.client.workbench.views.source.editors.text.visualmode.VisualMode;
 import org.rstudio.studio.client.workbench.views.source.editors.text.visualmode.VisualModePanmirrorContext;
-import org.rstudio.studio.client.workbench.views.source.editors.text.visualmode.VisualModeChunkExec;
 import org.rstudio.studio.client.workbench.views.source.editors.text.visualmode.VisualModeConfirm;
 import org.rstudio.studio.client.workbench.views.source.editors.text.visualmode.VisualModePanmirrorFormat;
 import org.rstudio.studio.client.workbench.views.source.editors.text.visualmode.VisualModeSpelling;
@@ -324,7 +323,6 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(PanmirrorUIPrefs panmirrorUIPrefs);
    void injectMembers(VisualMode visualMode);
    void injectMembers(VisualModeNavigation visualModeNavigation);
-   void injectMembers(VisualModeChunkExec visualModeChunkExec);
    void injectMembers(VisualModePanmirrorContext visualModePanmirrorContext);
    void injectMembers(VisualModePanmirrorFormat visualModePanmirrorFormat);
    void injectMembers(VisualModeMarkdownWriter visualModeMarkdownWriter);

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorCode.java
Patch:
@@ -29,5 +29,6 @@ public PanmirrorCode(String code)
    }
    
    public String code;
+   public boolean selection_only;
    public PanmirrorEditingOutlineLocation location;
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorContext.java
Patch:
@@ -20,7 +20,6 @@
 import org.rstudio.studio.client.panmirror.ui.PanmirrorUIChunks;
 import org.rstudio.studio.client.panmirror.ui.PanmirrorUIContext;
 import org.rstudio.studio.client.panmirror.ui.PanmirrorUIDisplay;
-import org.rstudio.studio.client.panmirror.ui.PanmirrorUIExecute;
 import org.rstudio.studio.client.panmirror.ui.PanmirrorUISpelling;
 
 import elemental2.core.JsObject;
@@ -32,10 +31,9 @@ public class PanmirrorContext
    public PanmirrorContext(PanmirrorUIContext uiContext, 
                            PanmirrorUIDisplay uiDisplay,
                            PanmirrorUIChunks uiChunks,
-                           PanmirrorUIExecute uiExecute,
                            PanmirrorUISpelling uiSpelling)
    {
-      this.ui = new PanmirrorUI(uiContext, uiDisplay, uiExecute, uiChunks, uiSpelling); 
+      this.ui = new PanmirrorUI(uiContext, uiDisplay, uiChunks, uiSpelling); 
    }
    
    public PanmirrorUI ui;

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorCommands.java
Patch:
@@ -118,8 +118,6 @@ public class PanmirrorCommands
    public static final String RcppCodeChunk = "6BD2810B-6B20-4358-8AA4-74BBFFC92AC3";
    public static final String SQLCodeChunk = "41D61FD2-B56B-48A7-99BC-2F60BC0D9F78";
    public static final String StanCodeChunk = "65D33344-CBE9-438C-B337-A538F8D7FCE5";
-   public static final String ExecuteCurrentRmdChunk = "31C799F3-EF18-4F3A-92E6-51F7A3193A1B";
-   public static final String ExecutePreviousRmdChunks = "D3FDE96-0264-4364-ADFF-E87A75405B0B";
    
    // outline
    public static final String GoToNextSection = "AE827BDA-96F8-4E84-8030-298D98386765";

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarCommands.java
Patch:
@@ -80,8 +80,6 @@ public PanmirrorToolbarCommands(PanmirrorCommand[] commands)
       add(PanmirrorCommands.RcppCodeChunk, "Rcpp");
       add(PanmirrorCommands.SQLCodeChunk, "SQL");
       add(PanmirrorCommands.StanCodeChunk, "Stan");
-      add(PanmirrorCommands.ExecuteCurrentRmdChunk, "Run Current Chunk");
-      add(PanmirrorCommands.ExecutePreviousRmdChunks, "Run All Chunks Above");
 
       // lists
       add(PanmirrorCommands.BulletList, "Bullet List", Roles.getMenuitemcheckboxRole(), icons.BULLET_LIST);

File: src/gwt/src/org/rstudio/studio/client/panmirror/location/PanmirrorEditingOutlineLocationItem.java
Patch:
@@ -24,4 +24,5 @@ public class PanmirrorEditingOutlineLocationItem
    public int level;
    public String title; 
    public boolean active;
+   public int position;
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUI.java
Patch:
@@ -26,13 +26,11 @@ public class PanmirrorUI
 {    
    public PanmirrorUI(PanmirrorUIContext context, 
                       PanmirrorUIDisplay display,
-                      PanmirrorUIExecute execute,
                       PanmirrorUIChunks chunks,
                       PanmirrorUISpelling spelling)
    {
       this.context = context;
       this.display = display;
-      this.execute = execute;
       this.math = new PanmirrorUIMath();
       this.prefs = new PanmirrorUIPrefs();
       this.dialogs = new PanmirrorDialogs(this.context);
@@ -42,7 +40,6 @@ public PanmirrorUI(PanmirrorUIContext context,
    
    public PanmirrorDialogs dialogs;
    public PanmirrorUIDisplay display;
-   public PanmirrorUIExecute execute;
    public PanmirrorUIMath math;
    public PanmirrorUIPrefs prefs;
    public PanmirrorUIContext context;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeEditingLocation.java
Patch:
@@ -78,7 +78,7 @@ public PanmirrorEditingLocation savedEditingLocation()
       
    }
    
-   public PanmirrorEditingOutlineLocation getSourceOutlneLocation()
+   public PanmirrorEditingOutlineLocation getSourceOutlineLocation()
    {
       // if we are at the very top of the file then this is a not a good 'hint'
       // for where to navigate to, in that case return null
@@ -120,7 +120,7 @@ public PanmirrorEditingOutlineLocation getSourceOutlneLocation()
    
    public void setSourceOutlineLocation(PanmirrorEditingOutlineLocation location)
    {
-   // if we don't have an outline then bail
+      // if we don't have an outline then bail
       if (docDisplay_.getScopeTree().length() == 0)
          return;
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeEditorSync.java
Patch:
@@ -22,8 +22,8 @@
 
 public interface VisualModeEditorSync
 {
-   void syncToEditor(boolean activatingEditor);
-   void syncToEditor(boolean activatingEditor, Command ready);
+   void syncToEditor(VisualMode.SyncType syncType);
+   void syncToEditor(VisualMode.SyncType syncType, Command ready);
    
    void syncFromEditorIfActivated();
    void syncFromEditor(CommandWithArg<Boolean> done, boolean focus);

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUIPrefs.java
Patch:
@@ -61,7 +61,7 @@ public Boolean tabKeyMoveFocus()
    
    public Boolean zoteroUseBetterBibtex()
    {
-      return pUIPrefs_.get().zoteroUseBetterBibtex().getValue();
+      return pUserState_.get().zoteroUseBetterBibtex().getValue();
    }
    
    public String bibliographyDefaultType()

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectRMarkdownPreferencesPane.java
Patch:
@@ -137,6 +137,7 @@ protected void initialize(RProjectOptions options)
       canonical_.setSelectedIndex(config.getMarkdownCanonical());
       
       zoteroLibs_.setLibraries(config.getZoteroLibraries());
+      zoteroLibs_.addAvailableLibraries();
    }
 
   

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -876,7 +876,8 @@ public void showOverflowPopout()
 
    public void showDataItem(DataItem data)
    {
-      columnList_.forEach((column) -> {
+      for (SourceColumn column : columnList_)
+      {
          for (EditingTarget target : column.getEditors())
          {
             String path = target.getPath();
@@ -889,7 +890,7 @@ public void showDataItem(DataItem data)
                return;
             }
          }
-      });
+      }
 
       ensureVisible(true);
       server_.newDocument(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkOutputCodeUi.java
Patch:
@@ -195,6 +195,9 @@ public void reattach()
    @Override
    public void detach()
    {
+      if (!wrapped_)
+         return;
+
       wrapper_.clear();
       wrapped_ = false;
    }

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -314,7 +314,7 @@ else if (start <= l && end <= r && end > l)
                      haveInsertedRange = false;
                   }
 
-                  moves.put(l, start);
+                  moves.put(l, overlap.start);
                }
             }
             else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -386,7 +386,7 @@ private void setActive(EditingTarget target)
       activeColumn_.setActiveEditor(target);
    }
 
-   private void setActive(SourceColumn column)
+   public void setActive(SourceColumn column)
    {
       SourceColumn prevColumn = activeColumn_;
       activeColumn_ = column;
@@ -1566,7 +1566,7 @@ public void closeColumn(SourceColumn column, boolean force)
       }
 
       if (column == activeColumn_)
-         setActive("");
+         setActive(MAIN_SOURCE_NAME);
       columnList_.remove(column);
       columnState_ = State.createState(JsUtil.toJsArrayString(getNames(false)),
                                        getActive().getName());

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -61,7 +61,6 @@
 public abstract class ModalDialogBase extends DialogBox
                                       implements AriaLiveStatusReporter
 {
-   protected static final String allowEnterKeyClass = "__rstudio_modal_allow_enter_key";
 
    public interface ReturnFocusHandler
    {
@@ -618,8 +617,7 @@ public void onPreviewNativeEvent(Event.NativePreviewEvent event)
             if (e.hasTagName("TEXTAREA") ||
                   e.hasTagName("A") ||
                   e.hasTagName("BUTTON") ||
-                  e.hasTagName("INPUT") ||
-                  e.hasClassName(allowEnterKeyClass) ||
+                  e.hasClassName(ALLOW_ENTER_KEY_CLASS) ||
                   (e.hasAttribute("role") && StringUtil.equals(e.getAttribute("role"), "link")))
                return;
 
@@ -868,4 +866,6 @@ public void reportStatus(String status, int delayMs, Severity severity)
    private final AriaLiveStatusWidget ariaLiveStatusWidget_;
    private final FocusHelper focus_;
    private static final List<ReturnFocusHandler> FOCUS_HANDLERS = new ArrayList<>();
+   
+   public static final String ALLOW_ENTER_KEY_CLASS = "__rstudio_modal_allow_enter_key";
 }

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -314,7 +314,7 @@ else if (start <= l && end <= r && end > l)
                      haveInsertedRange = false;
                   }
 
-                  moves.put(l, start);
+                  moves.put(l, overlap.start);
                }
             }
             else

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -260,7 +260,7 @@ public enum TextBoxButtonId
       VCS_IGNORE("vcs_ignore"),
       VCS_TERMINAL("vcs_terminal"),
       CHOOSE_IMAGE("choose_image"),
-      PYTHON_DEFAULT_INTERPRETER("python_default_interpreter");
+      PYTHON_PATH("python_path");
 
       TextBoxButtonId(String value)
       {

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -615,8 +615,10 @@ public void onPreviewNativeEvent(Event.NativePreviewEvent event)
 
             // allow Enter on textareas, buttons, or anchors (including custom links)
             Element e = DomUtils.getActiveElement();
-            if (e.hasTagName("TEXTAREA") || e.hasTagName("A") ||
+            if (e.hasTagName("TEXTAREA") ||
+                  e.hasTagName("A") ||
                   e.hasTagName("BUTTON") ||
+                  e.hasTagName("INPUT") ||
                   e.hasClassName(allowEnterKeyClass) ||
                   (e.hasAttribute("role") && StringUtil.equals(e.getAttribute("role"), "link")))
                return;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -108,6 +108,7 @@
 import org.rstudio.studio.client.workbench.model.SessionOpener;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
+import org.rstudio.studio.client.workbench.prefs.views.PythonPreferencesPaneBase;
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.snippets.ui.EditSnippetsDialog;
 import org.rstudio.studio.client.workbench.ui.ConsoleTabPanel;
@@ -332,6 +333,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(OpenProjectDialog dialog);
    void injectMembers(SourceColumn column);
    void injectMembers(SourceColumnManager columnManager);
+   void injectMembers(PythonPreferencesPaneBase<?> pane);
 
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PythonServerOperations.java
Patch:
@@ -22,6 +22,6 @@ public interface PythonServerOperations
    
    void pythonFindInterpreters(ServerRequestCallback<PythonInterpreters> requestCallback);
    
-   void pythonDescribeInterpreter(String interpreterPath,
-                                  ServerRequestCallback<PythonInterpreter> requestCallback);
+   void pythonInterpreterInfo(String interpreterPath,
+                              ServerRequestCallback<PythonInterpreter> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/dialogs/VisualModeConfirmDialog.java
Patch:
@@ -34,8 +34,7 @@
 
 public class VisualModeConfirmDialog extends ModalDialog<Boolean>
 {
-   public VisualModeConfirmDialog(boolean initialValue,
-                                  OperationWithInput<Boolean> onConfirm,
+   public VisualModeConfirmDialog(OperationWithInput<Boolean> onConfirm,
                                   Operation onCancel)
    {
       super("Switch to Visual Mode", 
@@ -48,7 +47,7 @@ public VisualModeConfirmDialog(boolean initialValue,
       setOkButtonCaption("Use Visual Mode");
       
       chkDontShowAgain_ = new CheckBox("Don't show this message again");
-      chkDontShowAgain_.setValue(initialValue);
+      chkDontShowAgain_.setValue(true);
       addLeftWidget(chkDontShowAgain_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -376,6 +376,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.sass", SASS, new ImageResource2x(icons.iconScss2x()));
       register("*.scss", SCSS, new ImageResource2x(icons.iconScss2x()));
       register("*.js", JS, new ImageResource2x(icons.iconJavascript2x()));
+      register("*.ts", JS, new ImageResource2x(icons.iconJavascript2x()));
       register("*.json", JSON, new ImageResource2x(icons.iconJavascript2x()));
       register("*.rmd", RMARKDOWN, new ImageResource2x(icons.iconRmarkdown2x()));
       register("*.rmarkdown", RMARKDOWN, new ImageResource2x(icons.iconRmarkdown2x()));

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorInsertCiteDialog.java
Patch:
@@ -114,6 +114,7 @@ public void onChange(ChangeEvent arg0)
             String currentFileName = createBibliographyFileName_.getValue();
             createBibliographyFileName_.setValue(ensureExtension(currentFileName, extension)); 
             userState_.bibliographyDefaultType().setGlobalValue(extension);
+            userState_.writeState();
          }});
 
       setBibliographies(citeProps.bibliographyFiles);

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -338,9 +338,9 @@ public PaneManager(Provider<MainSplitPanel> pSplitPanel,
                StringUtil.equals(column.getName(), SourceColumnManager.MAIN_SOURCE_NAME)) ?
                true : false;
 
-               LogicalWindow columnWindow = mainSourceWindow ?
-                                            sourceLogicalWindows_.get(0) :
-                                            getParentLogicalWindow(column.asWidget().getElement());
+            LogicalWindow columnWindow = mainSourceWindow ?
+                                         sourceLogicalWindows_.get(0) :
+                                         getParentLogicalWindow(column.asWidget().getElement());
 
             if (StringUtil.equals(docWindowId, windowId) &&
                 (columnWindow == null && mainSourceWindow ||

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenSourceFileEvent.java
Patch:
@@ -51,7 +51,7 @@ public OpenSourceFileEvent(FileSystemItem file,
                               TextFileType fileType,
                               int navMethod)
    {
-      this(file, position, fileType, false, NavigationMethods.DEFAULT);
+      this(file, position, fileType, true, NavigationMethods.DEFAULT);
    }
 
    public OpenSourceFileEvent(FileSystemItem file,

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenSourceFileEvent.java
Patch:
@@ -51,7 +51,7 @@ public OpenSourceFileEvent(FileSystemItem file,
                               TextFileType fileType,
                               int navMethod)
    {
-      this(file, position, fileType, false, NavigationMethods.DEFAULT);
+      this(file, position, fileType, true, NavigationMethods.DEFAULT);
    }
 
    public OpenSourceFileEvent(FileSystemItem file,

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -797,6 +797,9 @@ public ArrayList<Element> getFocusableElements()
     */
    public void refreshFocusableElements()
    {
+      if (!DomUtils.isEffectivelyVisible(getElement()))
+         return;
+
       ArrayList<Element> focusable = getFocusableElements();
       if (focusable.size() == 0)
       {

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -797,6 +797,9 @@ public ArrayList<Element> getFocusableElements()
     */
    public void refreshFocusableElements()
    {
+      if (!DomUtils.isEffectivelyVisible(getElement()))
+         return;
+
       ArrayList<Element> focusable = getFocusableElements();
       if (focusable.size() == 0)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -710,7 +710,7 @@ private void restoreDocuments(final Session session)
          }
       }
       columnManager_.setDocsRestored();
-      columnManager_.beforeShow();
+      columnManager_.beforeShow(true);
    }
 
    private void openEditPublishedDocs()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -3065,7 +3065,7 @@ public void recordCurrentNavigationPosition()
    public void navigateToPosition(SourcePosition position,
                                   boolean recordCurrent)
    {
-      navigateToPosition(position, recordCurrent, false, true);
+      navigateToPosition(position, recordCurrent, false, false);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -3065,7 +3065,7 @@ public void recordCurrentNavigationPosition()
    public void navigateToPosition(SourcePosition position,
                                   boolean recordCurrent)
    {
-      navigateToPosition(position, recordCurrent, false, true);
+      navigateToPosition(position, recordCurrent, false, false);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -423,7 +423,7 @@ public PrefValue<String> bibliographyDefaultType()
             BIBLIOGRAPHY_DEFAULT_TYPE_YAML,
             BIBLIOGRAPHY_DEFAULT_TYPE_JSON
          },
-         "bib");
+         "yaml");
    }
 
    public final static String BIBLIOGRAPHY_DEFAULT_TYPE_BIB = "bib";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -1897,12 +1897,12 @@ public void onError(ServerError error)
 
    public void beforeShow(boolean excludeMain)
    {
-      columnList_.forEach((column) ->
+      for (SourceColumn column : columnList_)
       {
          if (!excludeMain ||
              !StringUtil.equals(column.getName(), MAIN_SOURCE_NAME))
             column.onBeforeShow();
-      });
+      }
    }
 
    public void beforeShow(String name)

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -331,7 +331,7 @@ public PaneManager(Provider<MainSplitPanel> pSplitPanel,
             String docWindowId = docs.get(i).getSourceWindowId();
 
             // Check the SourceColumn of the SourceDocument. If for some reason we cannot find
-            // it's column, default to the main source window.
+            // its column, default to the main source window.
             SourceColumn column =
                sourceColumnManager_.getByName(docs.get(i).getSourceDisplayName());
             LogicalWindow columnWindow = column == null ? sourceLogicalWindows_.get(0) :

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -1142,7 +1142,8 @@ private XTermOptions defaultTerminalOptions()
             BrowseCap.isWindowsDesktop(),
             XTermTheme.terminalThemeFromEditorTheme(),
             XTermTheme.getFontFamily(),
-            XTermTheme.adjustFontSize(pFontSizeManager_.get().getSize()));
+            XTermTheme.adjustFontSize(pFontSizeManager_.get().getSize()),
+            XTermTheme.computeLineHeight());
    }
 
    private TerminalDeckPanel terminalSessionsPanel_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -186,6 +186,7 @@ public void onResponseReceived(ConsoleProcess consoleProcess)
             addHandlerRegistration(uiPrefs_.fontSizePoints().bind(arg ->
             {
                updateOption("fontSize", XTermTheme.adjustFontSize(arg));
+               updateOption("lineHeight", XTermTheme.computeLineHeight());
                onResize();
             }));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermOptions.java
Patch:
@@ -257,7 +257,8 @@ public class XTermOptions
          boolean windowsMode,
          XTermTheme theme,
          String fontFamily,
-         double fontSize)
+         double fontSize,
+         double lineHeight)
    {
       XTermOptions options = new XTermOptions();
       options.bellStyle = bellStyle;
@@ -268,6 +269,7 @@ public class XTermOptions
       options.theme = theme;
       options.fontFamily = fontFamily;
       options.fontSize = fontSize;
+      options.lineHeight = lineHeight;
       return options;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -1142,7 +1142,8 @@ private XTermOptions defaultTerminalOptions()
             BrowseCap.isWindowsDesktop(),
             XTermTheme.terminalThemeFromEditorTheme(),
             XTermTheme.getFontFamily(),
-            XTermTheme.adjustFontSize(pFontSizeManager_.get().getSize()));
+            XTermTheme.adjustFontSize(pFontSizeManager_.get().getSize()),
+            XTermTheme.computeLineHeight());
    }
 
    private TerminalDeckPanel terminalSessionsPanel_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -186,6 +186,7 @@ public void onResponseReceived(ConsoleProcess consoleProcess)
             addHandlerRegistration(uiPrefs_.fontSizePoints().bind(arg ->
             {
                updateOption("fontSize", XTermTheme.adjustFontSize(arg));
+               updateOption("lineHeight", XTermTheme.computeLineHeight());
                onResize();
             }));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermOptions.java
Patch:
@@ -257,7 +257,8 @@ public class XTermOptions
          boolean windowsMode,
          XTermTheme theme,
          String fontFamily,
-         double fontSize)
+         double fontSize,
+         double lineHeight)
    {
       XTermOptions options = new XTermOptions();
       options.bellStyle = bellStyle;
@@ -268,6 +269,7 @@ public class XTermOptions
       options.theme = theme;
       options.fontFamily = fontFamily;
       options.fontSize = fontSize;
+      options.lineHeight = lineHeight;
       return options;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/status/StatusBarPopupMenu.java
Patch:
@@ -23,6 +23,7 @@ public class StatusBarPopupMenu extends ScrollableToolbarPopupMenu
    public StatusBarPopupMenu()
    {
       super();
+      setReceivesFocus(ReceivesFocus.NO);
       addStyleName(ThemeStyles.INSTANCE.statusBarMenu());
    }
 

File: src/gwt/src/org/rstudio/core/client/theme/WindowFrameButton.java
Patch:
@@ -170,9 +170,6 @@ private String stateString(WindowState state)
    private boolean maximized_;
    private boolean exclusive_;
 
-   // class name displayed by Help / Diagnostics / Show DOM Elements command
-   private String helpClassId_;
-
    private Command clickHandler_;
    private final HandlerRegistrations releaseOnUnload_ = new HandlerRegistrations();
    private final DoubleClickState doubleClickState_ = new DoubleClickState();

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarButton.java
Patch:
@@ -255,7 +255,7 @@ public void setLeftImage(ImageResource imageResource)
 
    public void setClassId(String name)
    {
-      if (StringUtil.isNullOrEmpty(displayClassId_))
+      if (!StringUtil.isNullOrEmpty(displayClassId_))
          ClassIds.removeClassId(getElement(), displayClassId_);
 
       displayClassId_ = ClassIds.TOOLBAR_BTN + "_" + ClassIds.idSafeString(getTitle());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -314,7 +314,7 @@ private void createTestToolbarButtons(Toolbar toolbar)
 
    private Toolbar createToolbar(TextFileType fileType)
    {
-      Toolbar toolbar = new EditingTargetToolbar(target_.getId(), commands_, true, column_);
+      Toolbar toolbar = new EditingTargetToolbar(commands_, true, column_, target_.getId());
 
       // Buttons are unique to a source column so require SourceAppCommands
       SourceColumnManager mgr = RStudioGinjector.INSTANCE.getSourceColumnManager();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/status/StatusBarPopupMenu.java
Patch:
@@ -23,6 +23,7 @@ public class StatusBarPopupMenu extends ScrollableToolbarPopupMenu
    public StatusBarPopupMenu()
    {
       super();
+      setReceivesFocus(ReceivesFocus.NO);
       addStyleName(ThemeStyles.INSTANCE.statusBarMenu());
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleResources.java
Patch:
@@ -31,6 +31,7 @@ public interface ConsoleStyles extends CssResource
       String input();
       String prompt();
       String output();
+      String outputChunk();
       String command();
       String completionPopup();
       String completionGrid();
@@ -49,6 +50,6 @@ public interface ConsoleStyles extends CssResource
       String packageDescription();
       String truncatedLabel();
    }
-   
+
    public static final String KEYWORD_CLASS_NAME = " ace_keyword";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleResources.java
Patch:
@@ -31,6 +31,7 @@ public interface ConsoleStyles extends CssResource
       String input();
       String prompt();
       String output();
+      String outputChunk();
       String command();
       String completionPopup();
       String completionGrid();
@@ -49,6 +50,6 @@ public interface ConsoleStyles extends CssResource
       String packageDescription();
       String truncatedLabel();
    }
-   
+
    public static final String KEYWORD_CLASS_NAME = " ace_keyword";
 }

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -258,7 +258,8 @@ public enum TextBoxButtonId
       UPLOAD_TARGET("upload_target"),
       VCS_IGNORE("vcs_ignore"),
       VCS_TERMINAL("vcs_terminal"),
-      CHOOSE_IMAGE("choose_image");
+      CHOOSE_IMAGE("choose_image"),
+      PYTHON_DEFAULT_INTERPRETER("python_default_interpreter");
 
       TextBoxButtonId(String value)
       {

File: src/gwt/src/org/rstudio/core/client/widget/UserPrefMenuItem.java
Patch:
@@ -15,7 +15,6 @@
 
 package org.rstudio.core.client.widget;
 
-import org.rstudio.core.client.widget.CheckableMenuItem;
 import org.rstudio.studio.client.workbench.prefs.model.Prefs.PrefValue;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -136,6 +136,7 @@
 import org.rstudio.studio.client.workbench.model.WorkbenchListsServerOperations;
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.prefs.model.PrefsServerOperations;
+import org.rstudio.studio.client.workbench.prefs.views.PythonServerOperations;
 import org.rstudio.studio.client.workbench.snippets.SnippetServerOperations;
 import org.rstudio.studio.client.workbench.ui.PaneManager;
 import org.rstudio.studio.client.workbench.ui.WorkbenchScreen;
@@ -482,6 +483,7 @@ protected void configure()
       bind(SecondaryReposServerOperations.class).to(RemoteServer.class);
       bind(ThemeServerOperations.class).to(RemoteServer.class);
       bind(TutorialServerOperations.class).to(RemoteServer.class);
+      bind(PythonServerOperations.class).to(RemoteServer.class);
 
       bind(WorkbenchMainView.class).to(WorkbenchScreen.class);
 

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/ProjectBuildToolsPreferencesPane.java
Patch:
@@ -112,7 +112,7 @@ public RestartRequirement onApply(RProjectOptions options)
       String initialBuildType = initialConfig_.getBuildType();
       String selectedBuildType = buildTypeSelect_.getValue();
 
-      return new RestartRequirement(initialBuildType != selectedBuildType, false);
+      return new RestartRequirement(initialBuildType != selectedBuildType, false, false);
    }
 
 

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -38,6 +38,7 @@
 import org.rstudio.studio.client.workbench.addins.AddinsServerOperations;
 import org.rstudio.studio.client.workbench.codesearch.model.CodeSearchServerOperations;
 import org.rstudio.studio.client.workbench.prefs.model.PrefsServerOperations;
+import org.rstudio.studio.client.workbench.prefs.views.PythonServerOperations;
 import org.rstudio.studio.client.workbench.snippets.SnippetServerOperations;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildServerOperations;
 import org.rstudio.studio.client.workbench.views.choosefile.model.ChooseFileServerOperations;
@@ -110,7 +111,8 @@ public interface WorkbenchServerOperations extends ConsoleServerOperations,
                                                    JobsServerOperations,
                                                    SecondaryReposServerOperations,
                                                    ThemeServerOperations,
-                                                   TutorialServerOperations
+                                                   TutorialServerOperations,
+                                                   PythonServerOperations
 {   
    void initializeForMainWorkbench();
    void disconnect();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PaneLayoutPreferencesPane.java
Patch:
@@ -601,7 +601,7 @@ private ArrayList<String> toArrayList(JsArrayString strings)
    private VerticalPanel rightTopPanel_;
    private VerticalPanel rightBottomPanel_;
 
-   private int additionalColumnCount_;
+   private int additionalColumnCount_ = 0;
    private int displayColumnCount_ = 0;
    private FlexTable grid_;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionInstallOdbcPage.java
Patch:
@@ -23,8 +23,6 @@
 import org.rstudio.studio.client.workbench.views.connections.model.ConnectionOptions;
 import org.rstudio.studio.client.workbench.views.connections.model.NewConnectionContext;
 import org.rstudio.studio.client.workbench.views.connections.model.NewConnectionInfo;
-import org.rstudio.studio.client.workbench.views.connections.ui.NewConnectionSnippetPage;
-
 import com.google.gwt.safehtml.shared.SafeUri;
 import com.google.gwt.user.client.ui.Widget;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/model/PackagesServerOperations.java
Patch:
@@ -22,7 +22,6 @@
 import org.rstudio.studio.client.packrat.model.PackratServerOperations;
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.workbench.views.packages.model.PackageInstallContext;
 
 public interface PackagesServerOperations extends PackratServerOperations
 {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -587,7 +587,7 @@ public void onFocusSourceColumnSeparator()
           window.getNormal() == null ||
           !window.getNormal().getName().contains(SourceColumnManager.COLUMN_PREFIX))
       {
-         Debug.log("Attempted focusSourceColumnSeparator when source column not active.");
+         Debug.logWarning("Attempted focusSourceColumnSeparator when source column not active.");
          return;
       }
       panel_.focusSplitter(window.getNormal());

File: src/gwt/src/org/rstudio/studio/client/panmirror/pandoc/PanmirrorPandocServer.java
Patch:
@@ -91,14 +91,15 @@ public Promise<JavaScriptObject> getBibliography(String file, JsArrayString bibl
       });
    }
    
-   public Promise<Boolean> addToBibliography(String bibliography, boolean project, String id, String sourceAsJson)
+   public Promise<Boolean> addToBibliography(String bibliography, boolean project, String id, String sourceAsJson, String sourceAsBibLaTeX)
    {
       return new Promise<Boolean>((ResolveCallbackFn<Boolean> resolve, RejectCallbackFn reject) -> {       
          server_.pandocAddToBibliography(
            bibliography,
            project,
            id,
            sourceAsJson,
+           sourceAsBibLaTeX,
            new PromiseServerRequestCallback<Boolean>(resolve, reject)
         );
      }); 

File: src/gwt/src/org/rstudio/studio/client/panmirror/pandoc/PanmirrorPandocServerOperations.java
Patch:
@@ -27,7 +27,7 @@ public interface PanmirrorPandocServerOperations
    void pandocAstToMarkdown(JavaScriptObject ast, String format, JsArrayString options, ServerRequestCallback<String> callback);
    void pandocListExtensions(String format, ServerRequestCallback<String> callback);
    void pandocGetBibliography(String file, JsArrayString bibliographies, String refBlock, String etag, ServerRequestCallback<JavaScriptObject> callback);
-   void pandocAddToBibliography(String bibliography, boolean project, String id, String sourceAsJson, ServerRequestCallback<Boolean> callback);
+   void pandocAddToBibliography(String bibliography, boolean project, String id, String sourceAsJson, String sourceAsBibLaTeX, ServerRequestCallback<Boolean> callback);
    void pandocCitationHTML(String file, String sourceAsJson, String csl, ServerRequestCallback<String> callback);
 }
       

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -6177,14 +6177,15 @@ public void pandocGetBibliography(String file, JsArrayString bibliographies, Str
    }
    
    @Override
-   public void pandocAddToBibliography(String bibliography, boolean project, String id, String sourceAsJson,
+   public void pandocAddToBibliography(String bibliography, boolean project, String id, String sourceAsJson, String sourceAsBibLaTeX,
                                        ServerRequestCallback<Boolean> callback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(StringUtil.notNull(bibliography)));
       params.set(1, JSONBoolean.getInstance(project));
       params.set(2, new JSONString(id));
       params.set(3, new JSONString(sourceAsJson));
+      params.set(4, new JSONString(sourceAsBibLaTeX));
       sendRequest(RPC_SCOPE, PANDOC_ADD_TO_BIBLIOGRAPHY, params, callback);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearch.java
Patch:
@@ -113,6 +113,7 @@ public void onSelection(SelectionEvent<Suggestion> event)
                }
                else
                {
+                  srcItem.setFocusOnNavigate(true);
                   fileTypeRegistry.editFile(srcItem, pos);
                }
             });

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/ui/CodeSearchDialog.java
Patch:
@@ -82,6 +82,7 @@ protected void onUnload()
    @Override
    public void onCompleted()
    {
+      setRestoreFocusOnClose(false);
       closeDialog();  
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -196,7 +196,7 @@ protected JsObject getValue()
             int[] splitterArray = new int[leftList_.size() + 1];
             splitterArray[0] = right_.getOffsetWidth();
             for (int i = 0; i < leftList_.size(); i++)
-               splitterArray[i + 1] = leftList_.get(i).getOffsetWidth();
+               splitterArray[i + 1] = splitterArray[i] + leftList_.get(i).getOffsetWidth();
             state.setSplitterPos(splitterArray);
             return state.cast();
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -235,7 +235,9 @@ public void showUnsavedChangesDialog(
 
    public void initialSelect(int index)
    {
-      if (index >= 0 && display_.getTabCount() > index)
+      if (index < 0)
+         return;
+      if (display_.getTabCount() > index)
       {
          display_.selectTab(index);
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -483,8 +483,9 @@ public String getPreviousColumnName()
    public SourceColumn getActive()
    {
       if (activeColumn_ != null &&
+         (!columnList_.get(0).asWidget().isAttached() ||
           activeColumn_.asWidget().isAttached() &&
-          activeColumn_.asWidget().getOffsetWidth() > 0)
+          activeColumn_.asWidget().getOffsetWidth() > 0))
          return activeColumn_;
       setActive(MAIN_SOURCE_NAME);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -580,7 +580,7 @@ public void onError(ServerError error)
          dialog.setState(dialogState_);
       }
 
-      dialog.showModal(event.getRestoreFocus());
+      dialog.showModal();
    }
 
    public void onDismiss()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -580,7 +580,7 @@ public void onError(ServerError error)
          dialog.setState(dialogState_);
       }
 
-      dialog.showModal();
+      dialog.showModal(event.getRestoreFocus());
    }
 
    public void onDismiss()

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarCommands.java
Patch:
@@ -130,8 +130,8 @@ public PanmirrorToolbarCommands(PanmirrorCommand[] commands)
       add(PanmirrorCommands.DefinitionDescription, "Description");
       add(PanmirrorCommands.Citation, "Citation...");   
       add(PanmirrorCommands.CrossReference, "Cross Reference");
-      add(PanmirrorCommands.InsertSymbol, "Insert:::Unicode Symbol...");
-      add(PanmirrorCommands.InsertEmoji, "Insert:::Emoji...");
+      add(PanmirrorCommands.InsertEmoji, "Insert Emoji...");
+      add(PanmirrorCommands.InsertSymbol, "Insert Unicode...");
       add(PanmirrorCommands.EmDash, "Insert:::Em Dash ()");
       add(PanmirrorCommands.EnDash, "Insert:::En Dash ()");
       add(PanmirrorCommands.NonBreakingSpace, "Insert:::Non-Breaking Space");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/events/SaveFailedEvent.java
Patch:
@@ -28,7 +28,8 @@ public interface Handler extends EventHandler
    public static final GwtEvent.Type<SaveFailedEvent.Handler> TYPE =
       new GwtEvent.Type<SaveFailedEvent.Handler>();
    
-   public SaveFailedEvent(String path, String id)
+   public SaveFailedEvent(String path,
+                          String id)
    {
       path_ = path;
       id_ = id;

File: src/gwt/src/org/rstudio/core/client/events/WindowEnsureVisibleEvent.java
Patch:
@@ -50,5 +50,5 @@ protected void dispatch(Handler handler)
       handler.onWindowEnsureVisible(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/core/client/files/filedialog/events/OpenFileDialogEvent.java
Patch:
@@ -72,5 +72,5 @@ protected void dispatch(Handler handler)
       handler.onOpenFileDialog(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/events/CompilePdfErrorsEvent.java
Patch:
@@ -31,7 +31,7 @@ public CompilePdfErrorsEvent(JsArray<SourceMarker> errors)
    {
       errors_ = errors;
    }
-   
+
    public JsArray<SourceMarker> getErrors()
    {
       return errors_;
@@ -48,8 +48,8 @@ protected void dispatch(Handler handler)
    {
       handler.onCompilePdfErrors(this);
    }
-   
+
    private JsArray<SourceMarker> errors_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/events/CompilePdfOutputEvent.java
Patch:
@@ -30,7 +30,7 @@ public CompilePdfOutputEvent(CompileOutput output)
    {
       output_ = output;
    }
-   
+
    public CompileOutput getOutput()
    {
       return output_;
@@ -47,8 +47,8 @@ protected void dispatch(Handler handler)
    {
       handler.onCompilePdfOutput(this);
    }
-   
+
    private CompileOutput output_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleOutputEvent.java
Patch:
@@ -55,5 +55,5 @@ protected void dispatch(Handler handler)
 
    private final String output_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsolePromptEvent.java
Patch:
@@ -55,5 +55,5 @@ protected void dispatch(Handler handler)
 
    private final String prompt_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/common/console/ProcessExitEvent.java
Patch:
@@ -55,5 +55,5 @@ protected void dispatch(Handler handler)
 
    private final int exitCode_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/common/console/ServerConsoleOutputEvent.java
Patch:
@@ -68,5 +68,5 @@ protected void dispatch(Handler handler)
    private final String procHandle_;
    private final String output_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/common/console/ServerConsolePromptEvent.java
Patch:
@@ -67,5 +67,5 @@ protected void dispatch(Handler handler)
    private final String procHandle_;
    private final String prompt_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/common/console/ServerProcessExitEvent.java
Patch:
@@ -65,5 +65,5 @@ protected void dispatch(Handler handler)
    private final String procHandle_;
    private final int exitCode_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/common/debugging/events/UnhandledErrorEvent.java
Patch:
@@ -31,12 +31,12 @@ public UnhandledErrorEvent(UnhandledError err)
    {
       err_ = err;
    }
-   
+
    public UnhandledError getError()
    {
       return err_;
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -49,7 +49,7 @@ protected void dispatch(Handler handler)
       handler.onUnhandledError(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 
    private UnhandledError err_;
 }

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/events/AskSecretEvent.java
Patch:
@@ -36,7 +36,7 @@ public native final String getTitle() /*-{
       public native final String getPrompt() /*-{
          return this.prompt;
       }-*/;
-      
+
       public native final String getWindow() /*-{
          return this.window;
       }-*/;
@@ -68,7 +68,7 @@ public String getPrompt()
    {
       return prompt_;
    }
-   
+
    public String getWindow()
    {
       return window_;
@@ -102,5 +102,5 @@ protected void dispatch(Handler handler)
    private final boolean canRemember_;
    private final boolean hasSecret_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/events/HTMLPreviewOutputEvent.java
Patch:
@@ -28,7 +28,7 @@ public HTMLPreviewOutputEvent(String output)
    {
       output_ = output;
    }
-   
+
    public String getOutput()
    {
       return output_;
@@ -45,8 +45,8 @@ protected void dispatch(Handler handler)
    {
       handler.onHTMLPreviewOutput(this);
    }
-   
+
    private String output_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/events/LookupSynctexSourceEvent.java
Patch:
@@ -25,7 +25,7 @@ public interface Handler extends EventHandler
       void onLookupSynctexSource(LookupSynctexSourceEvent event);
    }
 
-   public LookupSynctexSourceEvent(SyncTexCoordinates coordinates, 
+   public LookupSynctexSourceEvent(SyncTexCoordinates coordinates,
                          boolean fromClick)
    {
       coordinates_ = coordinates;
@@ -36,7 +36,7 @@ public SyncTexCoordinates getCoordinates()
    {
       return coordinates_;
    }
-   
+
    public boolean fromClick()
    {
       return fromClick_;
@@ -57,5 +57,5 @@ protected void dispatch(Handler handler)
    private final SyncTexCoordinates coordinates_;
    private final boolean fromClick_;
 
-   public static Type<Handler> TYPE = new Type<Handler>();
+   public static Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/pdfjs/events/PDFLoadEvent.java
Patch:
@@ -36,5 +36,5 @@ protected void dispatch(Handler handler)
       handler.onPDFLoad(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/pdfjs/events/PdfJsLoadEvent.java
Patch:
@@ -36,5 +36,5 @@ protected void dispatch(Handler handler)
       handler.onPdfJsLoad(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/pdfjs/events/PdfJsWindowClosedEvent.java
Patch:
@@ -40,5 +40,5 @@ protected void dispatch(Handler handler)
       handler.onPdfJsWindowClosed(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/projects/events/NewProjectFolderEvent.java
Patch:
@@ -51,7 +51,7 @@ public boolean getCreateRepo()
    {
       return createRepo_;
    }
-   
+
    /**
     * @return info about api call that triggered this event, or null if not triggered by api
     */
@@ -72,7 +72,7 @@ protected void dispatch(Handler handler)
       handler.onNewProjectFolderEvent(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 
    private final String dirName_;
    private final String destDir_;

File: src/gwt/src/org/rstudio/studio/client/projects/events/NewProjectFromVcsEvent.java
Patch:
@@ -65,12 +65,12 @@ public String getUsername()
    {
       return username_;
    }
-   
+
    public TutorialApiCallContext getCallContext()
    {
       return callContext_;
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -83,7 +83,7 @@ protected void dispatch(Handler handler)
       handler.onNewProjectFromVcsEvent(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 
    private final String vcsId_;
    private final String repoUrl_;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/events/ConvertToShinyDocEvent.java
Patch:
@@ -19,7 +19,7 @@
 import com.google.gwt.event.shared.GwtEvent;
 
 public class ConvertToShinyDocEvent extends GwtEvent<ConvertToShinyDocEvent.Handler>
-{  
+{
    public interface Handler extends EventHandler
    {
       void onConvertToShinyDoc(ConvertToShinyDocEvent event);
@@ -46,8 +46,8 @@ protected void dispatch(Handler handler)
    {
       handler.onConvertToShinyDoc(this);
    }
-   
+
    private final String path_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/events/WebsiteFileSavedEvent.java
Patch:
@@ -30,7 +30,7 @@ public WebsiteFileSavedEvent(FileSystemItem fsi)
    {
      fsi_ = fsi;
    }
-   
+
    public FileSystemItem getFileSystemItem()
    {
       return fsi_;
@@ -47,8 +47,8 @@ protected void dispatch(Handler handler)
    {
       handler.onWebsiteFileSaved(this);
    }
-   
+
    private FileSystemItem fsi_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/events/ConsoleRestartRCompletedEvent.java
Patch:
@@ -40,5 +40,5 @@ protected void dispatch(Handler handler)
       handler.onRestartRCompleted(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/DebugModeChangedEvent.java
Patch:
@@ -24,7 +24,7 @@ public interface Handler extends EventHandler
    {
       void onDebugModeChanged(DebugModeChangedEvent event);
    }
-   
+
    public DebugModeChangedEvent(boolean debugging)
    {
       debugging_ = debugging;
@@ -47,6 +47,6 @@ protected void dispatch(Handler handler)
       handler.onDebugModeChanged(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
    private final boolean debugging_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/EnvironmentChangedEvent.java
Patch:
@@ -32,7 +32,7 @@ protected Data()
 
       public final native JsArray<RObject> getChangedObjects() /*-{ return this["changed"]; }-*/;
       public final native JsArrayString getRemovedObjects()    /*-{ return this["removed"]; }-*/;
-      
+
    }
 
    public EnvironmentChangedEvent(Data data)
@@ -66,6 +66,6 @@ protected void dispatch(Handler handler)
       handler.onEnvironmentChanged(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/EnvironmentRefreshEvent.java
Patch:
@@ -40,5 +40,5 @@ protected void dispatch(Handler handler)
       handler.onEnvironmentRefresh(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/JumpToFunctionEvent.java
Patch:
@@ -54,12 +54,12 @@ public int getLineNumber()
    {
       return data_.getLineNumber();
    }
-   
+
    public int getColumnNumber()
    {
       return data_.getColumnNumber();
    }
-   
+
    public String getFileName()
    {
       return data_.getFileName();
@@ -77,6 +77,6 @@ protected void dispatch(Handler handler)
       handler.onJumpToFunction(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
    private final Data data_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/events/JobElapsedTickEvent.java
Patch:
@@ -23,7 +23,7 @@ public interface Handler extends EventHandler
    {
       void onJobElapsedTick(JobElapsedTickEvent event);
    }
-   
+
    public JobElapsedTickEvent(int timestamp)
    {
       timestamp_ = timestamp;
@@ -33,7 +33,7 @@ public int timestamp()
    {
       return timestamp_;
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -48,5 +48,5 @@ protected void dispatch(Handler handler)
 
    private final int timestamp_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/events/JobInitEvent.java
Patch:
@@ -25,7 +25,7 @@ public interface Handler extends EventHandler
    {
       void onJobInit(JobInitEvent event);
    }
-   
+
    public JobInitEvent(JobState state)
    {
       state.recordReceived();
@@ -36,7 +36,7 @@ public JobState state()
    {
       return state_;
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -51,5 +51,5 @@ protected void dispatch(Handler handler)
 
    private final JobState state_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/events/JobRefreshEvent.java
Patch:
@@ -25,7 +25,7 @@ public interface Handler extends EventHandler
    {
       void onJobRefresh(JobRefreshEvent event);
    }
-   
+
    public JobRefreshEvent(JobState data)
    {
       data_ = data;
@@ -50,5 +50,5 @@ protected void dispatch(Handler handler)
 
    private final JobState data_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/events/JobRunScriptEvent.java
Patch:
@@ -31,7 +31,7 @@ public JobRunScriptEvent()
    {
       path_ = "";
    }
-   
+
    public JobRunScriptEvent(String path)
    {
       path_ = path;
@@ -41,7 +41,7 @@ public String path()
    {
       return path_;
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -56,5 +56,5 @@ protected void dispatch(Handler handler)
 
    private final String path_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/events/JobUpdatedEvent.java
Patch:
@@ -26,7 +26,7 @@ public interface Handler extends EventHandler
    {
       void onJobUpdated(JobUpdatedEvent event);
    }
-   
+
    public JobUpdatedEvent(JobUpdate data)
    {
       JobState.recordReceived(data.job);
@@ -52,5 +52,5 @@ protected void dispatch(Handler handler)
 
    private final JobUpdate data_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/events/LauncherJobRunScriptEvent.java
Patch:
@@ -31,7 +31,7 @@ public LauncherJobRunScriptEvent()
    {
       path_ = "";
    }
-   
+
    public LauncherJobRunScriptEvent(String path)
    {
       path_ = path;
@@ -41,7 +41,7 @@ public String path()
    {
       return path_;
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -56,5 +56,5 @@ protected void dispatch(Handler handler)
 
    private final String path_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/data/events/DataOutputCompletedEvent.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.gwt.event.shared.GwtEvent;
 
 public class DataOutputCompletedEvent extends GwtEvent<DataOutputCompletedEvent.Handler>
-{  
+{
    public interface Handler extends EventHandler
    {
       void onDataOutputCompleted(DataOutputCompletedEvent event);
@@ -41,7 +41,7 @@ public String getTitle()
    {
       return data_.getTitle();
    }
-  
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -56,5 +56,5 @@ protected void dispatch(Handler handler)
 
    private final DataOutputResult data_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/events/FindInFilesEvent.java
Patch:
@@ -60,5 +60,5 @@ protected void dispatch(Handler handler)
    private String replacePattern_;
    private boolean replace_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/events/FindOperationEndedEvent.java
Patch:
@@ -48,5 +48,5 @@ protected void dispatch(Handler handler)
 
    private final String handle_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/events/FindResultEvent.java
Patch:
@@ -75,5 +75,5 @@ protected void dispatch(Handler handler)
    private final String handle_;
    private final ArrayList<FindResult> results_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/events/PreviewReplaceEvent.java
Patch:
@@ -48,5 +48,5 @@ protected void dispatch(Handler handler)
 
    private final String searchPattern_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/events/ReplaceOperationEndedEvent.java
Patch:
@@ -48,5 +48,5 @@ protected void dispatch(Handler handler)
 
    private final String handle_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/events/ReplaceProgressEvent.java
Patch:
@@ -68,7 +68,7 @@ protected void dispatch(Handler handler)
       handler.onReplaceProgress(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
    private int totalReplaceCount_;
    private int replacedCount_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/events/ReplaceResultEvent.java
Patch:
@@ -74,5 +74,5 @@ protected void dispatch(Handler handler)
    private final String handle_;
    private final ArrayList<FindResult> results_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/events/LoadedPackageUpdatesEvent.java
Patch:
@@ -48,5 +48,5 @@ protected void dispatch(Handler handler)
 
    private final String installCmd_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/events/RaisePackagePaneEvent.java
Patch:
@@ -36,5 +36,5 @@ protected void dispatch(Handler handler)
       handler.onRaisePackagePane(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/events/PlotsZoomSizeChangedEvent.java
Patch:
@@ -55,7 +55,7 @@ public int getHeight()
    {
       return data_.getHeight();
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -70,5 +70,5 @@ protected void dispatch(Handler handler)
 
    private final Data data_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/events/PresentationPaneRequestCompletedEvent.java
Patch:
@@ -41,5 +41,5 @@ protected void dispatch(Handler handler)
    }
 
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/events/ShowPresentationPaneEvent.java
Patch:
@@ -50,5 +50,5 @@ protected void dispatch(Handler handler)
 
    private final PresentationState presentationState_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceClickEvent.java
Patch:
@@ -64,5 +64,5 @@ protected void dispatch(Handler handler)
 
    private final AceMouseEventNative event_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceMouseMoveEvent.java
Patch:
@@ -64,5 +64,5 @@ protected void dispatch(Handler handler)
 
    private final AceMouseEventNative event_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/AceSelectionChangedEvent.java
Patch:
@@ -27,7 +27,7 @@ public interface Handler extends EventHandler
    public AceSelectionChangedEvent()
    {
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -40,5 +40,5 @@ protected void dispatch(Handler handler)
       handler.onSelectionChanged(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/BreakpointMoveEvent.java
Patch:
@@ -29,12 +29,12 @@ public BreakpointMoveEvent(int breakpointId)
    {
       breakpointId_ = breakpointId;
    }
-   
+
    public int getBreakpointId()
    {
       return breakpointId_;
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -47,7 +47,7 @@ protected void dispatch(Handler handler)
       handler.onBreakpointMove(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 
    private int breakpointId_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/ChunkSatelliteWindowRegisteredEvent.java
Patch:
@@ -19,7 +19,7 @@
 import com.google.gwt.event.shared.GwtEvent;
 
 public class ChunkSatelliteWindowRegisteredEvent extends GwtEvent<ChunkSatelliteWindowRegisteredEvent.Handler>
-{  
+{
    public interface Handler extends EventHandler
    {
       void onChunkSatelliteWindowRegistered(ChunkSatelliteWindowRegisteredEvent event);
@@ -28,7 +28,7 @@ public interface Handler extends EventHandler
    public ChunkSatelliteWindowRegisteredEvent()
    {
    }
-   
+
    public ChunkSatelliteWindowRegisteredEvent(
       String docId,
       String chunkId)
@@ -62,5 +62,5 @@ protected void dispatch(Handler handler)
    private String docId_;
    private String chunkId_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/FoldChangeEvent.java
Patch:
@@ -40,5 +40,5 @@ protected void dispatch(Handler handler)
       handler.onFoldChange(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/LineWidgetsChangedEvent.java
Patch:
@@ -40,5 +40,5 @@ protected void dispatch(Handler handler)
       handler.onLineWidgetsChanged(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/PasteEvent.java
Patch:
@@ -20,7 +20,7 @@
 
 public class PasteEvent extends GwtEvent<Handler>
 {
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 
    public interface Handler extends EventHandler
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/events/RenderFinishedEvent.java
Patch:
@@ -27,7 +27,7 @@ public interface Handler extends EventHandler
    public RenderFinishedEvent()
    {
    }
-   
+
    @Override
    public Type<Handler> getAssociatedType()
    {
@@ -40,5 +40,5 @@ protected void dispatch(Handler handler)
       handler.onRenderFinished(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/events/TutorialNavigateEvent.java
Patch:
@@ -19,7 +19,7 @@
 
 public class TutorialNavigateEvent extends GwtEvent<TutorialNavigateEvent.Handler>
 {
-   
+
 
    // Boilerplate ----
 
@@ -40,6 +40,6 @@ protected void dispatch(Handler handler)
       handler.onTutorialNavigate(this);
    }
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/events/AskPassEvent.java
Patch:
@@ -36,7 +36,7 @@ public native final String getPrompt() /*-{
       public native final String getRememberPrompt() /*-{
          return this.remember_prompt;
       }-*/;
-      
+
       public native final String getWindow() /*-{
          return this.window;
       }-*/;
@@ -58,7 +58,7 @@ public String getRememberPasswordPrompt()
    {
       return rememberPrompt_;
    }
-   
+
    public String getWindow()
    {
       return window_;
@@ -80,5 +80,5 @@ protected void dispatch(Handler handler)
    private final String rememberPrompt_;
    private final String window_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/events/SwitchViewEvent.java
Patch:
@@ -40,5 +40,5 @@ protected void dispatch(Handler handler)
       handler.onSwitchView(this);
    }
 
-   private static final Type<Handler> TYPE = new Type<Handler>();
+   private static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -617,8 +617,8 @@ private void manageSourceNavigationCommands()
    {
       commands_.sourceNavigateBack().setEnabled(
          sourceNavigationHistory_.isBackEnabled());
-      commands_.sourceNavigateBack().setEnabled(
-         sourceNavigationHistory_.isBackEnabled());
+      commands_.sourceNavigateForward().setEnabled(
+         sourceNavigationHistory_.isForwardEnabled());
    }
 
    public EditingTarget addTab(SourceDocument doc, int mode, SourceColumn column)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -241,9 +241,10 @@ protected void onInit(JsObject value)
 
             if (value == null)
             {
+               // default to main column name here because we haven't loaded any columns yet
                columnState_ =
                   State.createState(JsUtil.toJsArrayString(getNames(false)),
-                                    getActive().getName());
+                                    MAIN_SOURCE_NAME);
                return;
             }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -616,8 +616,8 @@ private void manageSourceNavigationCommands()
    {
       commands_.sourceNavigateBack().setEnabled(
          sourceNavigationHistory_.isBackEnabled());
-      commands_.sourceNavigateBack().setEnabled(
-         sourceNavigationHistory_.isBackEnabled());
+      commands_.sourceNavigateForward().setEnabled(
+         sourceNavigationHistory_.isForwardEnabled());
    }
 
    public EditingTarget addTab(SourceDocument doc, int mode, SourceColumn column)

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -586,10 +586,10 @@ public void onFocusCenterSeparator()
     public void onNewSourceColumn()
     {
        if (!userPrefs_.allowSourceColumns().getValue())
-          pGlobalDisplay_.get().showErrorMessage("Cannot Add Column",
+          pGlobalDisplay_.get().showMessage(GlobalDisplay.MSG_INFO, "Cannot Add Column",
              "Allow Source Columns preference is disabled.");
        else if (additionalSourceCount_ == MAX_COLUMN_COUNT)
-          pGlobalDisplay_.get().showErrorMessage("Cannot Add Column",
+          pGlobalDisplay_.get().showMessage(GlobalDisplay.MSG_INFO, "Cannot Add Column",
              "You can't add more than " + MAX_COLUMN_COUNT + " columns.");
        else
           addSourceWindow();

File: src/gwt/src/org/rstudio/studio/client/panmirror/uitools/PanmirrorUIToolsAttr.java
Patch:
@@ -26,5 +26,6 @@ public class PanmirrorUIToolsAttr
 {
    public native PanmirrorAttrEditInput propsToInput(PanmirrorAttrProps attr);
    public native PanmirrorAttrProps inputToProps(PanmirrorAttrEditInput input);
+   public native String pandocAutoIdentifier(String text);
 }
 

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWriterOptions.java
Patch:
@@ -23,6 +23,6 @@ public class PanmirrorWriterOptions
 {    
    public boolean atxHeaders;
    public int wrapColumn;
-   public String references;
+   public PanmirrorWriterReferencesOptions references;
    public int dpi;
 }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -309,8 +309,8 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(JobsDisplayImpl jobDisplayBaseImpl);
    void injectMembers(PanmirrorPandocServer panmirrorPandocServer);
    void injectMembers(PanmirrorCrossrefServer panmirrorCrossrefServer);
-   void injectMembers(PanmirrorXRefServer panmirrorXrefServer);
    void injectMembers(PanmirrorDOIServer panmirrorDOIServer);
+   void injectMembers(PanmirrorXRefServer panmirrorXRefServer);
    void injectMembers(PanmirrorZoteroServer panmirrorZoteroServer);
    void injectMembers(PanmirrorDialogs panmirrorEditorUI);
    void injectMembers(PanmirrorWidget panmirrorWidget);

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUIDisplay.java
Patch:
@@ -16,6 +16,8 @@
 
 package org.rstudio.studio.client.panmirror.ui;
 
+import org.rstudio.core.client.XRef;
+import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.panmirror.command.PanmirrorMenuItem;
@@ -50,7 +52,7 @@ public void openURL(String url)
    @JsFunction
    public interface NavigateToXRef
    {
-      void navigate(String file, String xref);
+      void navigate(XRef xref, FileSystemItem sourceFile);
    }
 
    public ShowContextMenu showContextMenu;   

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1814,8 +1814,8 @@ public void onXRefNavigation(XRefNavigationEvent event)
             @Override
             public void execute(final EditingTarget editor)
             {
-               TextEditingTarget target = (TextEditingTarget) editor;
-               target.navigateToXRef(event.getXRef());
+               TextEditingTarget target = (TextEditingTarget)editor;
+               target.navigateToXRef(event.getXRef(), event.getForceVisualMode());
             }
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -401,6 +401,9 @@ public final native boolean getConsoleRightOnTop() /*-{
       }-*/;
 
       public final native int getAdditionalSourceColumns() /*-{
+         if (!this.additional_source_columns)
+           return 0;
+
          return this.additional_source_columns;
       }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -77,7 +77,6 @@ public EditingPreferencesPane(UserPrefs prefs,
             "When enabled, the indentation for documents not part of an RStudio project " +
             "will be automatically detected."));
       editingPanel.add(checkboxPref("Insert matching parens/quotes", prefs_.insertMatching()));
-      editingPanel.add(checkboxPref("Rainbow parentheses", prefs_.rainbowParentheses()));
       editingPanel.add(checkboxPref("Auto-indent code after paste", prefs_.reindentOnPaste()));
       editingPanel.add(checkboxPref("Vertically align arguments in auto-indent", prefs_.verticallyAlignArgumentsIndent()));
       editingPanel.add(checkboxPref("Soft-wrap R source files", prefs_.softWrapRFiles()));
@@ -204,8 +203,9 @@ public void onClick(ClickEvent event)
       displayPanel.add(checkboxPref("Blinking cursor", prefs_.blinkingCursor()));
       displayPanel.add(checkboxPref("Allow scroll past end of document", prefs_.scrollPastEndOfDocument()));
       displayPanel.add(checkboxPref("Allow drag and drop of text", prefs_.enableTextDrag()));
-      displayPanel.add(extraSpaced(checkboxPref("Highlight R function calls",
-         prefs_.highlightRFunctionCalls(), false /*defaultSpace*/)));
+      displayPanel.add(checkboxPref("Highlight R function calls", prefs_.highlightRFunctionCalls()));
+      displayPanel.add(extraSpaced(
+         checkboxPref("Rainbow parentheses", prefs_.rainbowParentheses(), false /* defaultSpace */)));
 
       foldMode_ = new SelectWidget(
             "Fold Style:",

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -401,6 +401,9 @@ public final native boolean getConsoleRightOnTop() /*-{
       }-*/;
 
       public final native int getAdditionalSourceColumns() /*-{
+         if (!this.additional_source_columns)
+           return 0;
+
          return this.additional_source_columns;
       }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -77,7 +77,6 @@ public EditingPreferencesPane(UserPrefs prefs,
             "When enabled, the indentation for documents not part of an RStudio project " +
             "will be automatically detected."));
       editingPanel.add(checkboxPref("Insert matching parens/quotes", prefs_.insertMatching()));
-      editingPanel.add(checkboxPref("Rainbow parentheses", prefs_.rainbowParentheses()));
       editingPanel.add(checkboxPref("Auto-indent code after paste", prefs_.reindentOnPaste()));
       editingPanel.add(checkboxPref("Vertically align arguments in auto-indent", prefs_.verticallyAlignArgumentsIndent()));
       editingPanel.add(checkboxPref("Soft-wrap R source files", prefs_.softWrapRFiles()));
@@ -204,8 +203,9 @@ public void onClick(ClickEvent event)
       displayPanel.add(checkboxPref("Blinking cursor", prefs_.blinkingCursor()));
       displayPanel.add(checkboxPref("Allow scroll past end of document", prefs_.scrollPastEndOfDocument()));
       displayPanel.add(checkboxPref("Allow drag and drop of text", prefs_.enableTextDrag()));
-      displayPanel.add(extraSpaced(checkboxPref("Highlight R function calls",
-         prefs_.highlightRFunctionCalls(), false /*defaultSpace*/)));
+      displayPanel.add(checkboxPref("Highlight R function calls", prefs_.highlightRFunctionCalls()));
+      displayPanel.add(extraSpaced(
+         checkboxPref("Rainbow parentheses", prefs_.rainbowParentheses(), false /* defaultSpace */)));
 
       foldMode_ = new SelectWidget(
             "Fold Style:",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -103,7 +103,7 @@ public VisualMode(TextEditingTarget target,
       // create peer helpers
       visualModeFormat_ = new VisualModePanmirrorFormat(docUpdateSentinel_, docDisplay_, target_, view_);
       visualModeExec_ = new VisualModeChunkExec(docUpdateSentinel_, rmarkdownHelper, this);
-      visualModeChunks_ = new VisualModeChunks(docUpdateSentinel_, target.getRCompletionContext());
+      visualModeChunks_ = new VisualModeChunks(docUpdateSentinel_, target_);
       visualModeContext_ = new VisualModePanmirrorContext(
             docUpdateSentinel_, target_, visualModeExec_, visualModeChunks_, visualModeFormat_);
       visualModeLocation_ = new VisualModeEditingLocation(docUpdateSentinel_, docDisplay_);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -2557,7 +2557,7 @@ public PrefValue<Boolean> showFocusRectangles()
    {
       return bool(
          "show_focus_rectangles",
-         "Show focus rectangles", 
+         "Always show focus outlines", 
          "Control with keyboard focus displays a visual focus indicator.", 
          true);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AccessibilityPreferencesPane.java
Patch:
@@ -67,7 +67,7 @@ public AccessibilityPreferencesPane(UserPrefs prefs,
       generalPanel.add(checkboxPref("Reduce user interface animations", prefs.reducedMotion()));
       chkTabMovesFocus_ = new CheckBox("Tab key always moves focus");
       generalPanel.add(lessSpaced(chkTabMovesFocus_));
-      chkShowFocusRectangles_ = new CheckBox("Show focus rectangles (requires restart)");
+      chkShowFocusRectangles_ = new CheckBox("Always show focus outlines (requires restart)");
       generalPanel.add(chkShowFocusRectangles_);
 
       HelpLink helpLink = new HelpLink("RStudio accessibility help", "rstudio_a11y", false);

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -110,6 +110,7 @@
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.snippets.ui.EditSnippetsDialog;
 import org.rstudio.studio.client.workbench.ui.ConsoleTabPanel;
+import org.rstudio.studio.client.workbench.ui.polyfill.FocusVisiblePolyfill;
 import org.rstudio.studio.client.workbench.views.connections.ui.ConnectionCodePanel;
 import org.rstudio.studio.client.workbench.views.connections.ui.ConnectionExplorer;
 import org.rstudio.studio.client.workbench.views.connections.ui.NewConnectionInstallOdbcHost;
@@ -370,6 +371,7 @@ public interface RStudioGinjector extends Ginjector
    SessionOpener getSessionOpener();
    VirtualConsoleFactory getVirtualConsoleFactory();
    JobItemFactory getJobItemFactory();
+   FocusVisiblePolyfill getFocusVisiblePolyfill();
    AriaLiveService getAriaLiveService();
 
    // Pro-only below here

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -34,6 +34,7 @@
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.ProgressOperationWithInput;
+import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.ApplicationVisibility;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.DeferredInitCompletedEvent;
@@ -206,6 +207,8 @@ public void onWorkbenchLoaded(WorkbenchLoadedEvent event)
       checkForInitMessages();
       checkForLicenseMessage();
 
+      RStudioGinjector.INSTANCE.getFocusVisiblePolyfill().load(null);
+
       if (Desktop.isDesktop() &&
           StringUtil.equals(session_.getSessionInfo().getVcsName(), VCSConstants.GIT_ID))
       {

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorContext.java
Patch:
@@ -17,7 +17,7 @@
 
 import org.rstudio.studio.client.panmirror.server.PanmirrorServer;
 import org.rstudio.studio.client.panmirror.ui.PanmirrorUI;
-import org.rstudio.studio.client.panmirror.ui.PanmirrorUIChunkFactory;
+import org.rstudio.studio.client.panmirror.ui.PanmirrorUIChunks;
 import org.rstudio.studio.client.panmirror.ui.PanmirrorUIContext;
 import org.rstudio.studio.client.panmirror.ui.PanmirrorUIDisplay;
 import org.rstudio.studio.client.panmirror.ui.PanmirrorUIExecute;
@@ -30,7 +30,7 @@ public class PanmirrorContext
 {  
    public PanmirrorContext(PanmirrorUIContext uiContext, 
                            PanmirrorUIDisplay uiDisplay,
-                           PanmirrorUIChunkFactory uiChunks,
+                           PanmirrorUIChunks uiChunks,
                            PanmirrorUIExecute uiExecute)
    {
       this.ui = new PanmirrorUI(uiContext, uiDisplay, uiExecute, uiChunks); 

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUI.java
Patch:
@@ -27,7 +27,7 @@ public class PanmirrorUI
    public PanmirrorUI(PanmirrorUIContext context, 
                       PanmirrorUIDisplay display,
                       PanmirrorUIExecute execute,
-                      PanmirrorUIChunkFactory chunks)
+                      PanmirrorUIChunks chunks)
    {
       this.context = context;
       this.display = display;
@@ -44,6 +44,6 @@ public PanmirrorUI(PanmirrorUIContext context,
    public PanmirrorUIMath math;
    public PanmirrorUIPrefs prefs;
    public PanmirrorUIContext context;
-   public PanmirrorUIChunkFactory chunks;
+   public PanmirrorUIChunks chunks;
    public JsObject images;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModePanmirrorContext.java
Patch:
@@ -87,7 +87,7 @@ public PanmirrorContext createContext(PanmirrorUIDisplay.ShowContextMenu showCon
       return new PanmirrorContext(
          uiContext(), 
          uiDisplay(showContextMenu), 
-         chunks_.uiChunkFactory(),
+         chunks_.uiChunks(),
          exec_.uiExecute()
       );
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -509,7 +509,7 @@ public PrefValue<Boolean> showIndentGuides()
    {
       return bool(
          "show_indent_guides",
-         "Show invisible characters in editor", 
+         "Show indentation guides", 
          "Whether to show indentation guides in the RStudio code editor.", 
          false);
    }
@@ -2734,7 +2734,7 @@ public PrefValue<String> visualMarkdownCodeEditor()
             VISUAL_MARKDOWN_CODE_EDITOR_ACE,
             VISUAL_MARKDOWN_CODE_EDITOR_CODEMIRROR
          },
-         "codemirror");
+         "ace");
    }
 
    public final static String VISUAL_MARKDOWN_CODE_EDITOR_ACE = "ace";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -849,7 +849,6 @@ private void manageRSConnectCommands(boolean active)
 
    private void manageRMarkdownCommands(boolean active)
    {
-      // !!! reconsider this before PR
       boolean rmdCommandsAvailable = active &&
               manager_.getSession().getSessionInfo().getRMarkdownPackageAvailable() &&
                       activeEditor_ != null &&

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/events/PopoutDocEvent.java
Patch:
@@ -14,7 +14,6 @@
  */
 package org.rstudio.studio.client.workbench.views.source.events;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.js.JavaScriptSerializable;
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.workbench.views.source.SourceColumn;
@@ -45,7 +44,6 @@ public PopoutDocEvent(PopoutDocInitiatedEvent originator,
       originator_ = originator;
       sourcePosition_ = sourcePosition;
       column_ = column;
-      Debug.logToConsole("new PopoutDocEvent for: " + originator_.getDocId());
    }
    
    public PopoutDocInitiatedEvent getOriginator()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -373,7 +373,7 @@ public void fireDocTabsChanged()
             ? activeEditor_.getId()
             : null;
 
-      events_.fireEvent(new DocTabsChangedEvent(activeId, ids, icons, names, paths));
+      display_.resetDocTabs(activeId, ids, icons, names, paths);
 
       manageChevronVisibility();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -849,7 +849,6 @@ private void manageRSConnectCommands(boolean active)
 
    private void manageRMarkdownCommands(boolean active)
    {
-      // !!! reconsider this before PR
       boolean rmdCommandsAvailable = active &&
               manager_.getSession().getSessionInfo().getRMarkdownPackageAvailable() &&
                       activeEditor_ != null &&

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/events/PopoutDocEvent.java
Patch:
@@ -45,7 +45,6 @@ public PopoutDocEvent(PopoutDocInitiatedEvent originator,
       originator_ = originator;
       sourcePosition_ = sourcePosition;
       column_ = column;
-      Debug.logToConsole("new PopoutDocEvent for: " + originator_.getDocId());
    }
    
    public PopoutDocInitiatedEvent getOriginator()

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUIMath.java
Patch:
@@ -29,11 +29,11 @@
 @JsType
 public class PanmirrorUIMath {
    
-   public Promise<Boolean> typeset(Element el, String text)
+   public Promise<Boolean> typeset(Element el, String text, boolean priority)
    {
       return new Promise<Boolean>((ResolveCallbackFn<Boolean> resolve, RejectCallbackFn reject) -> {
          MathJaxLoader.withMathJaxLoaded((alreadyLoaded) -> {
-            MathJaxTypeset.typeset(el, text, (error) -> {
+            MathJaxTypeset.typeset(el, text, priority, (error) -> {
                resolve.onInvoke(error);
             });
          });

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermBuffer.java
Patch:
@@ -25,9 +25,6 @@
 @JsType(isNative = true, namespace = JsPackage.GLOBAL, name = "Object")
 public class XTermBuffer
 {
-   public static final String NORMAL_BUFFER = "normal";
-   public static final String ALT_BUFFER = "alternate";
-
    /**
     * The type of the buffer.
     * 'normal' or 'alternate'

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1417,7 +1417,6 @@ public void execute(EditingTarget editor)
    @Override
    public void onPopoutDocInitiated(final PopoutDocInitiatedEvent event)
    {
-      Debug.logToConsole("onPopoutDocInitiated");
       columnManager_.inEditorForId(event.getDocId(), new OperationWithInput<EditingTarget>()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2407,7 +2407,6 @@ public void onActivate()
          commandHandlerReg_.removeHandler();
          commandHandlerReg_ = null;
       }
-      Debug.logToConsole("bind commandHandlerReg_");
       commandHandlerReg_ = commandBinder.bind(commands_, this);
 
       // show outline if not yet rendered (deferred so that widget itself can
@@ -2453,7 +2452,6 @@ public void onDeactivate()
 
       externalEditCheckInvalidation_.invalidate();
 
-      Debug.logToConsole("remove commandHandlerReg_");
       commandHandlerReg_.removeHandler();
       commandHandlerReg_ = null;
 
@@ -3672,7 +3670,6 @@ public void syncLocalSourceDb()
    @Handler
    void onPopoutDoc()
    {
-      Debug.logToConsole("onPopoutDoc in TextEditingTarget");
       if (docUpdateSentinel_ != null)
       {
          // ensure doc is synchronized with source database before popping it

File: src/gwt/src/org/rstudio/core/client/command/EnabledChangedHandler.java
Patch:
@@ -18,5 +18,5 @@
 
 public interface EnabledChangedHandler extends EventHandler
 {
-   void onEnabledChanged(AppCommand command);
+   void onEnabledChanged(EnabledChangedEvent event);
 }

File: src/gwt/src/org/rstudio/core/client/command/VisibleChangedHandler.java
Patch:
@@ -18,5 +18,5 @@
 
 public interface VisibleChangedHandler extends EventHandler
 {
-   void onVisibleChanged(AppCommand command);
+   void onVisibleChanged(VisibleChangedEvent event);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -47,6 +47,7 @@
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.cellview.ImageButtonColumn;
 import org.rstudio.core.client.command.AppCommand;
+import org.rstudio.core.client.command.VisibleChangedEvent;
 import org.rstudio.core.client.command.VisibleChangedHandler;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.RStudioDataGridResources;
@@ -402,7 +403,7 @@ public void requestSuggestions(Request request, Callback callback)
       commands_.disconnectConnection().addVisibleChangedHandler(
                                        new VisibleChangedHandler() {
          @Override
-         public void onVisibleChanged(AppCommand command)
+         public void onVisibleChanged(VisibleChangedEvent event)
          {
             connectMenuButton_.setVisible(
                   !commands_.disconnectConnection().isVisible());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTargetWidget.java
Patch:
@@ -430,7 +430,7 @@ private Toolbar createToolbar(SourceColumn column)
    {
       Toolbar toolbar = new EditingTargetToolbar(commands_, true, column);
 
-      toolbar.addLeftWidget(commands_.printSourceDoc().createToolbarButton()); 
+      toolbar.addLeftWidget(commands_.printSourceDoc().createToolbarButton(column_));
       toolbar.addLeftSeparator();
       toolbar.addLeftWidget(findReplace_.createFindReplaceButton());
      
@@ -442,9 +442,9 @@ private Toolbar createToolbar(SourceColumn column)
       ToolbarMenuButton codeTools = new ToolbarMenuButton(ToolbarButton.NoText, "Code Tools", icon, menu);
       toolbar.addLeftWidget(codeTools);
       
-      toolbar.addRightWidget(commands_.executeCode().createToolbarButton());
+      toolbar.addRightWidget(commands_.executeCode().createToolbarButton(column_));
       toolbar.addRightSeparator();
-      toolbar.addRightWidget(commands_.executeLastCode().createToolbarButton());
+      toolbar.addRightWidget(commands_.executeLastCode().createToolbarButton(column_));
       
       return toolbar;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -158,10 +158,10 @@ private Toolbar createToolbar(Commands commands,
    {
       Toolbar toolbar = new EditingTargetToolbar(commands, true, column_);
       
-      toolbar.addLeftWidget(commands.gotoProfileSource().createToolbarButton());
-      toolbar.addLeftWidget(commands.saveProfileAs().createToolbarButton());
+      toolbar.addLeftWidget(commands.gotoProfileSource().createToolbarButton(column_));
+      toolbar.addLeftWidget(commands.saveProfileAs().createToolbarButton(column_));
       toolbar.addLeftSeparator();
-      toolbar.addLeftWidget(commands.openProfileInBrowser().createToolbarButton());
+      toolbar.addLeftWidget(commands.openProfileInBrowser().createToolbarButton(column_));
       
       toolbar.addRightWidget(
             publishButton_ = new RSConnectPublishButton(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualMode.java
Patch:
@@ -591,7 +591,7 @@ public boolean isAtRow(SourcePosition position)
    {
       if (visualModeNavigation_.isVisualModePosition(position))
       {
-         return Math.abs(position.getRow() - getSourcePosition().getRow()) < 80;
+         return position.getRow() == getSourcePosition().getRow();
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/visualmode/VisualModeNavigation.java
Patch:
@@ -99,7 +99,7 @@ private SourceNavigation createSourceNavigation(SourcePosition pos)
    private SourcePosition createSourcePosition(int pos)
    {
       // create 'virtual' rows based on 50 character chunks (this is used for 
-      // detecting duplicates in the navigation history, and 100 characters is
+      // detecting duplicates in the navigation history, and 50 characters is
       // hardly worth a navigation (source mode uses actual editor rows for this)
       int row = pos / kRowLength;
       int col = pos % kRowLength;
@@ -113,6 +113,6 @@ private SourcePosition createSourcePosition(int pos)
    private EventBus events_;
    
    private final static String kPanmirrorContext = "panmirror";
-   private final static int kRowLength = 100;
+   private final static int kRowLength = 50;
    
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTargetWidget.java
Patch:
@@ -87,7 +87,7 @@ public DataEditingTargetWidget(String title,
       // when loaded, hook up event handlers
       frame_.addLoadHandler((event) ->
       {
-         CommandWith2Args<Integer, Integer> view = (row, col) ->
+         CommandWith2Args<Double, Double> view = (row, col) ->
          {
             String lho = dataItem.getExpression();
             String object = dataItem.getObject();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -2626,7 +2626,7 @@ public void onGetEditorContext(GetEditorContextEvent event)
 
       if (type == GetEditorContextEvent.TYPE_ACTIVE_EDITOR)
       {
-         if (consoleEditorHadFocusLast() || columnManager_.hasActiveEditor())
+         if (consoleEditorHadFocusLast() || !columnManager_.hasActiveEditor())
             type = GetEditorContextEvent.TYPE_CONSOLE_EDITOR;
          else
             type = GetEditorContextEvent.TYPE_SOURCE_EDITOR;

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/model/PanmirrorInsertCiteProps.java
Patch:
@@ -3,7 +3,8 @@
 import jsinterop.annotations.JsType;
 
 @JsType
-public class PanmirrorInsertBibEntryProps {
+public class PanmirrorInsertCiteProps {
 	public String suggestedId;
 	public String[] bibliographyFiles;
+	public PanMirrorInsertCitePreviewPair[] previewPairs;
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/model/PanmirrorInsertCiteResult.java
Patch:
@@ -3,7 +3,7 @@
 import jsinterop.annotations.JsType;
 
 @JsType
-public class PanmirrorInsertBibEntryResult {
+public class PanmirrorInsertCiteResult {
 	public String id;
 	public String bibliographyFile;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -150,7 +150,6 @@
 import org.rstudio.studio.client.workbench.views.source.events.CollabEditStartedEvent;
 import org.rstudio.studio.client.workbench.views.source.events.DocTabDragInitiatedEvent;
 import org.rstudio.studio.client.workbench.views.source.events.DocTabDragStartedEvent;
-import org.rstudio.studio.client.workbench.views.source.events.DocTabsChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.events.DocWindowChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.events.EditPresentationSourceEvent;
 import org.rstudio.studio.client.workbench.views.source.events.EnsureVisibleSourceWindowEvent;
@@ -1476,6 +1475,7 @@ public void execute(EditingTarget editor)
    @Override
    public void onPopoutDocInitiated(final PopoutDocInitiatedEvent event)
    {
+      Debug.logToConsole("onPopoutDocInitiated");
       columnManager_.inEditorForId(event.getDocId(), new OperationWithInput<EditingTarget>()
       {
          @Override
@@ -2638,7 +2638,7 @@ public void onGetEditorContext(GetEditorContextEvent event)
          InputEditorDisplay editor = consoleEditorProvider_.getConsoleEditor();
          if (editor != null && editor instanceof DocDisplay)
          {
-            columnManager_.getEditorContext("#console", "", (DocDisplay) editor, server_);
+            SourceColumnManager.getEditorContext("#console", "", (DocDisplay) editor, server_);
             return;
          }
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -337,7 +337,7 @@ private void setActiveDocId(String docId)
             return;
          }
       }
-      Debug.logWarning("Attempted to set unknown doc to active " + docId);
+      // if we didn't find the target editor then it was likely activated for pop out
    }
 
    public void setDocsRestored()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3659,6 +3659,7 @@ public void syncLocalSourceDb()
    @Handler
    void onPopoutDoc()
    {
+      Debug.logToConsole("onPopoutDoc in TextEditingTarget");
       if (docUpdateSentinel_ != null)
       {
          // ensure doc is synchronized with source database before popping it

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -808,9 +808,12 @@ private ArrayList<LogicalWindow> createPanes(PaneConfig config)
    {
       ArrayList<LogicalWindow> results = new ArrayList<>();
 
+      // Do not include hiddenTabSet in panes since it should never be displayed
       JsArrayString panes = config.getQuadrants();
       for (int i = 0; i < panes.length(); i++)
       {
+         if (StringUtil.equals(panes.get(i), "HiddenTabSet"))
+            continue;
          results.add(panesByName_.get(panes.get(i)));
       }
       return results;

File: src/gwt/src/org/rstudio/core/client/command/KeyboardHelper.java
Patch:
@@ -173,6 +173,7 @@ private static final native JavaScriptObject makeKeyCodeToKeyNameMap()
       
       map[144] = "NumLock";
       map[145] = "ScrollLock";
+      map[173] = "-";
       map[186] = ";";
       map[187] = "=";
       map[188] = ",";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -78,6 +78,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.NewRMarkdownDialog;
 import org.rstudio.studio.client.workbench.views.source.events.FileEditEvent;
 import org.rstudio.studio.client.workbench.views.source.model.DocUpdateSentinel;
+import org.rstudio.studio.client.workbench.views.source.model.SourceDocument;
 
 public class TextEditingTargetRMarkdownHelper
 {
@@ -135,7 +136,7 @@ public String detectExtendedType(String contents,
           fileType.isMarkdown() &&
           useRMarkdownV2(contents))
       {
-         return "rmarkdown";
+         return SourceDocument.XT_RMARKDOWN_DOCUMENT;
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -671,7 +671,8 @@ public void adaptToFileType(TextFileType fileType)
       boolean isPlainMarkdown = fileType.isPlainMarkdown();
       boolean isCpp = fileType.isCpp();
       boolean isScript = fileType.isScript();
-      boolean isRMarkdown2 = extendedType_ == "rmarkdown";
+      boolean isRMarkdown2 = extendedType_ != null && 
+                             extendedType_.startsWith(SourceDocument.XT_RMARKDOWN_PREFIX);
       boolean canPreviewFromR = fileType.canPreviewFromR();
       boolean terminalAllowed = session_.getSessionInfo().getAllowShell();
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -78,6 +78,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.NewRMarkdownDialog;
 import org.rstudio.studio.client.workbench.views.source.events.FileEditEvent;
 import org.rstudio.studio.client.workbench.views.source.model.DocUpdateSentinel;
+import org.rstudio.studio.client.workbench.views.source.model.SourceDocument;
 
 public class TextEditingTargetRMarkdownHelper
 {
@@ -135,7 +136,7 @@ public String detectExtendedType(String contents,
           fileType.isMarkdown() &&
           useRMarkdownV2(contents))
       {
-         return "rmarkdown";
+         return SourceDocument.XT_RMARKDOWN_DOCUMENT;
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -751,7 +751,8 @@ public void adaptToFileType(TextFileType fileType)
       boolean isPlainMarkdown = fileType.isPlainMarkdown();
       boolean isCpp = fileType.isCpp();
       boolean isScript = fileType.isScript();
-      boolean isRMarkdown2 = extendedType_ == "rmarkdown";
+      boolean isRMarkdown2 = extendedType_ != null && 
+                             extendedType_.startsWith(SourceDocument.XT_RMARKDOWN_PREFIX);
       boolean canPreviewFromR = fileType.canPreviewFromR();
       boolean terminalAllowed = session_.getSessionInfo().getAllowShell();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -974,6 +974,7 @@ public void newDoc(EditableFileType fileType,
                       final String contents,
                       final ResultCallback<EditingTarget, ServerError> resultCallback)
    {
+      ensureVisible(false);
       boolean isActive = activeEditor_ != null;
       server_.newDocument(
             fileType.getTypeId(),

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -974,6 +974,7 @@ public void newDoc(EditableFileType fileType,
                       final String contents,
                       final ResultCallback<EditingTarget, ServerError> resultCallback)
    {
+      ensureVisible(false);
       boolean isActive = activeEditor_ != null;
       server_.newDocument(
             fileType.getTypeId(),

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogPaneBase.java
Patch:
@@ -177,7 +177,7 @@ void setDialog(PreferencesDialogBase<T> dialog)
       dialog_ = dialog;
    }
 
-   void setPaneVisible(boolean visible)
+   protected void setPaneVisible(boolean visible)
    {
       getElement().getStyle().setDisplay(visible
                                               ? Display.BLOCK

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -78,6 +78,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.NewRMarkdownDialog;
 import org.rstudio.studio.client.workbench.views.source.events.FileEditEvent;
 import org.rstudio.studio.client.workbench.views.source.model.DocUpdateSentinel;
+import org.rstudio.studio.client.workbench.views.source.model.SourceDocument;
 
 public class TextEditingTargetRMarkdownHelper
 {
@@ -135,7 +136,7 @@ public String detectExtendedType(String contents,
           fileType.isMarkdown() &&
           useRMarkdownV2(contents))
       {
-         return "rmarkdown";
+         return SourceDocument.XT_RMARKDOWN_DOCUMENT;
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -751,7 +751,8 @@ public void adaptToFileType(TextFileType fileType)
       boolean isPlainMarkdown = fileType.isPlainMarkdown();
       boolean isCpp = fileType.isCpp();
       boolean isScript = fileType.isScript();
-      boolean isRMarkdown2 = extendedType_ == "rmarkdown";
+      boolean isRMarkdown2 = extendedType_ != null && 
+                             extendedType_.startsWith(SourceDocument.XT_RMARKDOWN_PREFIX);
       boolean canPreviewFromR = fileType.canPreviewFromR();
       boolean terminalAllowed = session_.getSessionInfo().getAllowShell();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -200,7 +200,8 @@
    public abstract AppCommand openNextFileOnFilesystem();
    public abstract AppCommand openPreviousFileOnFilesystem();
    public abstract AppCommand toggleSoftWrapMode();
- 
+   public abstract AppCommand toggleRainbowParens();
+
    // Projects
    public abstract AppCommand newProject();
    public abstract AppCommand newProjectFromTemplate();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -77,6 +77,7 @@ public EditingPreferencesPane(UserPrefs prefs,
             "When enabled, the indentation for documents not part of an RStudio project " +
             "will be automatically detected."));
       editingPanel.add(checkboxPref("Insert matching parens/quotes", prefs_.insertMatching()));
+      editingPanel.add(checkboxPref("Rainbow parentheses", prefs_.rainbowParentheses()));
       editingPanel.add(checkboxPref("Auto-indent code after paste", prefs_.reindentOnPaste()));
       editingPanel.add(checkboxPref("Vertically align arguments in auto-indent", prefs_.verticallyAlignArgumentsIndent()));
       editingPanel.add(checkboxPref("Soft-wrap R source files", prefs_.softWrapRFiles()));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -194,7 +194,9 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
    void setBlinkingCursor(boolean blinking);
    void setScrollPastEndOfDocument(boolean enable);
    void setHighlightRFunctionCalls(boolean highlight);
-   
+   void setRainbowParentheses(boolean rainbow);
+   boolean getRainbowParentheses();
+
    void setScrollLeft(int x);
    void setScrollTop(int y);
    void scrollTo(int x, int y);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/EditSession.java
Patch:
@@ -79,7 +79,7 @@ public native final void setUseWrapMode(boolean useWrapMode) /*-{
    public native final boolean getUseWrapMode() /*-{
       return this.getUseWrapMode();
    }-*/;
-   
+
    public native final void setWrapLimitRange(int min, int max) /*-{
       this.setWrapLimitRange(min, max);
    }-*/;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -3970,8 +3970,8 @@ private void manageRSConnectCommands()
             SessionUtils.showPublishUi(session_, userState_) &&
             (activeEditor_ != null) &&
             (activeEditor_.getPath() != null) &&
-            ((activeEditor_.getExtendedFileType() != null &&
-              (activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_SHINY_PREFIX)) ||
+            (activeEditor_.getExtendedFileType() != null &&
+              (activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_SHINY_PREFIX) ||
                activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_RMARKDOWN_PREFIX) ||
                activeEditor_.getExtendedFileType() == SourceDocument.XT_PLUMBER_API));
       commands_.rsconnectDeploy().setVisible(rsCommandsAvailable);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -940,9 +940,9 @@ private void manageCommands()
    public void newDoc(EditableFileType fileType,
                       ResultCallback<EditingTarget, ServerError> callback)
    {
+      ensureVisible(true);
       if (fileType instanceof TextFileType)
       {
-         ensureVisible(true);
          // This is a text file, so see if the user has defined a template for it.
          TextFileType textType = (TextFileType)fileType;
          server_.getSourceTemplate("",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -280,7 +280,6 @@ public void setActive(String name)
    {
       if (StringUtil.isNullOrEmpty(name))
       {
-         Debug.logWarning("Active column should be set to the main source window instead of null.");
          if (activeColumn_ != null)
          {
             activeColumn_.setActiveEditor("");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -3971,8 +3971,8 @@ private void manageRSConnectCommands()
             (activeEditor_ != null) &&
             (activeEditor_.getPath() != null) &&
             ((activeEditor_.getExtendedFileType() != null &&
-              activeEditor_.getExtendedFileType() .startsWith(SourceDocument.XT_SHINY_PREFIX)) ||
-              activeEditor_.getExtendedFileType() == SourceDocument.XT_RMARKDOWN ||
+              activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_SHINY_PREFIX)) ||
+              activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_RMARKDOWN_PREFIX) ||
               activeEditor_.getExtendedFileType() == SourceDocument.XT_PLUMBER_API);
       commands_.rsconnectDeploy().setVisible(rsCommandsAvailable);
       if (activeEditor_ != null)
@@ -4002,7 +4002,7 @@ private void manageRMarkdownCommands()
       boolean rmdCommandsAvailable = 
             session_.getSessionInfo().getRMarkdownPackageAvailable() &&
             (activeEditor_ != null) &&
-            activeEditor_.getExtendedFileType() == SourceDocument.XT_RMARKDOWN;
+            activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_RMARKDOWN_PREFIX);
       commands_.editRmdFormatOptions().setVisible(rmdCommandsAvailable);
       commands_.editRmdFormatOptions().setEnabled(rmdCommandsAvailable);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -1248,7 +1248,7 @@ else if (type == SourceDocument.XT_SHINY_SINGLE_FILE)
             publishButton_.setContentPath(publishPath, "");
             publishButton_.setContentType(RSConnect.CONTENT_TYPE_APP_SINGLE);
          }
-         else if (type == SourceDocument.XT_RMARKDOWN)
+         else if (type.startsWith(SourceDocument.XT_RMARKDOWN_PREFIX))
          {
             // don't publish markdown docs as static
             publishButton_.setRmd(publishPath, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceDocument.java
Patch:
@@ -184,7 +184,9 @@ public static boolean hasCustomSource(String extendedType)
       return extendedType != null && extendedType == SourceDocument.XT_R_CUSTOM_SOURCE;
    }
    
-   public final static String XT_RMARKDOWN = "rmarkdown";
+   public final static String XT_RMARKDOWN_PREFIX = "rmarkdown-";
+   public final static String XT_RMARKDOWN_DOCUMENT = "rmarkdown-document";
+   public final static String XT_RMARKDOWN_NOTEBOOK = "rmarkdown-notebook";
    public final static String XT_SHINY_PREFIX = "shiny-";
    public final static String XT_SHINY_DIR = "shiny-dir";
    public final static String XT_SHINY_SINGLE_FILE = "shiny-single-file";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -848,8 +848,8 @@ private void manageRSConnectCommands()
                       (activeEditor_ != null) &&
                       (activeEditor_.getPath() != null) &&
                       ((activeEditor_.getExtendedFileType() != null &&
-                              activeEditor_.getExtendedFileType() .startsWith(SourceDocument.XT_SHINY_PREFIX)) ||
-                              activeEditor_.getExtendedFileType() == SourceDocument.XT_RMARKDOWN ||
+                              activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_SHINY_PREFIX)) ||
+                              activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_RMARKDOWN_PREFIX) ||
                               activeEditor_.getExtendedFileType() == SourceDocument.XT_PLUMBER_API);
       commands_.rsconnectDeploy().setVisible(rsCommandsAvailable);
       if (activeEditor_ != null)
@@ -879,7 +879,7 @@ private void manageRMarkdownCommands()
       boolean rmdCommandsAvailable =
               manager_.getSession().getSessionInfo().getRMarkdownPackageAvailable() &&
                       (activeEditor_ != null) &&
-                      activeEditor_.getExtendedFileType() == SourceDocument.XT_RMARKDOWN;
+                      activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_RMARKDOWN_PREFIX);
       commands_.editRmdFormatOptions().setVisible(rmdCommandsAvailable);
       commands_.editRmdFormatOptions().setEnabled(rmdCommandsAvailable);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -1376,7 +1376,7 @@ else if (type == SourceDocument.XT_SHINY_SINGLE_FILE)
             publishButton_.setContentPath(publishPath, "");
             publishButton_.setContentType(RSConnect.CONTENT_TYPE_APP_SINGLE);
          }
-         else if (type == SourceDocument.XT_RMARKDOWN)
+         else if (type.startsWith(SourceDocument.XT_RMARKDOWN_PREFIX))
          {
             // don't publish markdown docs as static
             publishButton_.setRmd(publishPath,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceDocument.java
Patch:
@@ -202,7 +202,9 @@ public static boolean hasCustomSource(String extendedType)
       return extendedType != null && extendedType == SourceDocument.XT_R_CUSTOM_SOURCE;
    }
    
-   public final static String XT_RMARKDOWN = "rmarkdown";
+   public final static String XT_RMARKDOWN_PREFIX = "rmarkdown-";
+   public final static String XT_RMARKDOWN_DOCUMENT = "rmarkdown-document";
+   public final static String XT_RMARKDOWN_NOTEBOOK = "rmarkdown-notebook";
    public final static String XT_SHINY_PREFIX = "shiny-";
    public final static String XT_SHINY_DIR = "shiny-dir";
    public final static String XT_SHINY_SINGLE_FILE = "shiny-single-file";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -848,8 +848,8 @@ private void manageRSConnectCommands()
                       (activeEditor_ != null) &&
                       (activeEditor_.getPath() != null) &&
                       ((activeEditor_.getExtendedFileType() != null &&
-                              activeEditor_.getExtendedFileType() .startsWith(SourceDocument.XT_SHINY_PREFIX)) ||
-                              activeEditor_.getExtendedFileType() == SourceDocument.XT_RMARKDOWN ||
+                              activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_SHINY_PREFIX)) ||
+                              activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_RMARKDOWN_PREFIX) ||
                               activeEditor_.getExtendedFileType() == SourceDocument.XT_PLUMBER_API);
       commands_.rsconnectDeploy().setVisible(rsCommandsAvailable);
       if (activeEditor_ != null)
@@ -879,7 +879,7 @@ private void manageRMarkdownCommands()
       boolean rmdCommandsAvailable =
               manager_.getSession().getSessionInfo().getRMarkdownPackageAvailable() &&
                       (activeEditor_ != null) &&
-                      activeEditor_.getExtendedFileType() == SourceDocument.XT_RMARKDOWN;
+                      activeEditor_.getExtendedFileType().startsWith(SourceDocument.XT_RMARKDOWN_PREFIX);
       commands_.editRmdFormatOptions().setVisible(rmdCommandsAvailable);
       commands_.editRmdFormatOptions().setEnabled(rmdCommandsAvailable);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -1376,7 +1376,7 @@ else if (type == SourceDocument.XT_SHINY_SINGLE_FILE)
             publishButton_.setContentPath(publishPath, "");
             publishButton_.setContentType(RSConnect.CONTENT_TYPE_APP_SINGLE);
          }
-         else if (type == SourceDocument.XT_RMARKDOWN)
+         else if (type.startsWith(SourceDocument.XT_RMARKDOWN_PREFIX))
          {
             // don't publish markdown docs as static
             publishButton_.setRmd(publishPath,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceDocument.java
Patch:
@@ -202,7 +202,9 @@ public static boolean hasCustomSource(String extendedType)
       return extendedType != null && extendedType == SourceDocument.XT_R_CUSTOM_SOURCE;
    }
    
-   public final static String XT_RMARKDOWN = "rmarkdown";
+   public final static String XT_RMARKDOWN_PREFIX = "rmarkdown-";
+   public final static String XT_RMARKDOWN_DOCUMENT = "rmarkdown-document";
+   public final static String XT_RMARKDOWN_NOTEBOOK = "rmarkdown-notebook";
    public final static String XT_SHINY_PREFIX = "shiny-";
    public final static String XT_SHINY_DIR = "shiny-dir";
    public final static String XT_SHINY_SINGLE_FILE = "shiny-single-file";

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -1220,7 +1220,7 @@ public void closeSourceWindow(String name)
                new WindowStateChangeEvent(WindowState.HIDE));
       else
       {
-         SourceColumn column = sourceColumnManager_.findByName(name);
+         SourceColumn column = sourceColumnManager_.getByName(name);
 
          if (column.getTabCount() == 0)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -687,7 +687,7 @@ private void restoreDocuments(final Session session)
                {
                   String name = doc.getSourceDisplayName();
                   sourceEditor = columnManager_.addTab(doc, true, OPEN_REPLAY,
-                                                       columnManager_.findByName(name));
+                                                       columnManager_.getByName(name));
                }
                else
                   sourceEditor = columnManager_.addTab(doc, true, OPEN_REPLAY, null);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -1339,7 +1339,6 @@ public ArrayList<Widget> consolidateColumns(int num)
    public void closeAllColumns()
    {
       columnList_.forEach((column) -> closeColumn(column.getName()));
-      Debug.logToConsole("closed all columns, new size: " + getSize());
       assert getSize() == 0;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourcePane.java
Patch:
@@ -112,7 +112,7 @@ public void addTab(Widget widget,
    {
       tabPanel_.add(widget, icon, docId, name, tooltip, position);
       if (switchToTab)
-         tabPanel_.selectTab(widget);
+         tabPanel_.selectTab(widget, true /* focus newly added tab */);
    }
 
    public void closeTab(Widget child, boolean interactive)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -67,7 +67,8 @@ public TerminalInfoDialog(String globalInfo, final TerminalSession session)
          diagnostics.append("Handle:      '").append(cpi.getHandle()).append("'\n");
          diagnostics.append("Sequence:    '").append(cpi.getTerminalSequence()).append("'\n");
          diagnostics.append("Restarted:   '").append(cpi.getRestarted()).append("\n");
-         diagnostics.append("Busy:        '").append(cpi.getHasChildProcs()).append("'\n");
+         if (!BrowseCap.isWindowsDesktop())
+            diagnostics.append("Busy:        '").append(cpi.getHasChildProcs()).append("'\n");
          diagnostics.append("Exit Code:   '").append(cpi.getExitCode()).append("'\n");
          diagnostics.append("Full screen: 'client=").append(session.xtermAltBufferActive()).append("/server=").append(cpi.getAltBufferActive()).append("'\n");
          diagnostics.append("Zombie:      '").append(cpi.getZombie()).append("'\n");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -85,7 +85,7 @@ public TerminalSession(ConsoleProcessInfo info,
       RStudioGinjector.INSTANCE.injectMembers(this);
       procInfo_ = info;
       createdByApi_ = createdByApi;
-      hasChildProcs_ = new Value<>(info.getHasChildProcs());
+      hasChildProcs_ = new Value<>(!BrowseCap.isWindowsDesktop() && info.getHasChildProcs());
 
       setTitle(info.getTitle());
       socket_ = new TerminalSessionSocket(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -67,7 +67,8 @@ public TerminalInfoDialog(String globalInfo, final TerminalSession session)
          diagnostics.append("Handle:      '").append(cpi.getHandle()).append("'\n");
          diagnostics.append("Sequence:    '").append(cpi.getTerminalSequence()).append("'\n");
          diagnostics.append("Restarted:   '").append(cpi.getRestarted()).append("\n");
-         diagnostics.append("Busy:        '").append(cpi.getHasChildProcs()).append("'\n");
+         if (!BrowseCap.isWindowsDesktop())
+            diagnostics.append("Busy:        '").append(cpi.getHasChildProcs()).append("'\n");
          diagnostics.append("Exit Code:   '").append(cpi.getExitCode()).append("'\n");
          diagnostics.append("Full screen: 'client=").append(session.xtermAltBufferActive()).append("/server=").append(cpi.getAltBufferActive()).append("'\n");
          diagnostics.append("Zombie:      '").append(cpi.getZombie()).append("'\n");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -86,7 +86,7 @@ public TerminalSession(ConsoleProcessInfo info,
       RStudioGinjector.INSTANCE.injectMembers(this);
       procInfo_ = info;
       createdByApi_ = createdByApi;
-      hasChildProcs_ = new Value<>(info.getHasChildProcs());
+      hasChildProcs_ = new Value<>(!BrowseCap.isWindowsDesktop() && info.getHasChildProcs());
 
       setTitle(info.getTitle());
       socket_ = new TerminalSessionSocket(

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorEditRawDialog.java
Patch:
@@ -59,11 +59,9 @@ public PanmirrorEditRawDialog(
    
       rawFormatSelect_.setFormats(outputFormats, raw.format);
       rawFormatSelect_.setValue(StringUtil.notNull(raw.format));
-      rawFormatSelect_.getListBox().getElement().setId(ElementIds.VISUAL_MD_RAW_FORMAT_SELECT);
       
       rawContent_.setValue(raw.content);
       PanmirrorDialogsUtil.setFullWidthStyles(rawContent_);
-      rawContent_.getElement().setId(ElementIds.VISUAL_MD_RAW_FORMAT_CONTENT);
       
       if (!inline_)
       {
@@ -108,7 +106,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void focusFirstControl()
+   protected void focusInitialControl()
    {
       if (rawFormatSelect_.getValue().length() > 0)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/model/BlogdownConfig.java
Patch:
@@ -27,4 +27,5 @@ public class BlogdownConfig
    public String[] static_dirs;
    public String markdown_engine;
    public String markdown_extensions;
+   public String rmd_extensions;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -43,7 +43,7 @@ private static class State extends JavaScriptObject
       protected State() {}
 
       public native final boolean hasSplitterPos() /*-{
-         return this.splitterpos == 0;
+         return this.splitterpos && this.splitterpos.length;
       }-*/;
 
       public native final int[] getSplitterPos() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1540,15 +1540,15 @@ public void closeAllSourceDocs(final String caption,
             @Override
             public void execute()
             {
-               columnManager_.closeAllLocalSourceDocs(caption, onCompleted, excludeActive);
+               columnManager_.closeAllLocalSourceDocs(caption, null, onCompleted, excludeActive);
             }
          });
       }
       else
       {
          // this is a satellite (or we don't need to query satellites)--just
          // close our own tabs
-         columnManager_.closeAllLocalSourceDocs(caption, onCompleted, excludeActive);
+         columnManager_.closeAllLocalSourceDocs(caption, null, onCompleted, excludeActive);
       }
    }
 

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -15,7 +15,6 @@
  */
 package org.rstudio.core.client.theme;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.BrowseCap;
 import org.rstudio.core.client.ClassIds;
 import org.rstudio.core.client.Point;
@@ -1010,7 +1009,6 @@ public void endDrag(final Event evt, int action)
                      events_.fireEvent(new PopoutDocInitiatedEvent(
                            initDragParams_.getDocId(), Point.create(
                                  evt.getScreenX(), evt.getScreenY())));
-                     Debug.logToConsole("initiating event from DocTabLayoutPanel for: " + initDragParams_.getDocId());
                   }
                }
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumn.java
Patch:
@@ -774,7 +774,7 @@ private void manageSynctexCommands()
 
    private void manageVcsCommands()
    {
-      // manage availablity of vcs commands
+      // manage availability of vcs commands
       boolean vcsCommandsEnabled =
               manager_.getSession().getSessionInfo().isVcsEnabled() &&
                       (activeEditor_ != null) &&

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -367,7 +367,7 @@ public boolean isActiveEditor(EditingTarget editingTarget)
       return hasActiveEditor() && activeColumn_.getActiveEditor() == editingTarget;
    }
 
-   // see if there are additional command pallette items made available
+   // see if there are additional command palette items made available
    // by the active editor
    public List<CommandPaletteItem> getCommandPaletteItems()
    {
@@ -2083,8 +2083,7 @@ else if (editingTargets.size() == 1)
       {
          // convert to UnsavedChangesTarget collection
          ArrayList<UnsavedChangesTarget> unsavedTargets =
-            new ArrayList<UnsavedChangesTarget>();
-         unsavedTargets.addAll(editingTargets);
+            new ArrayList<>(editingTargets);
 
          // show dialog
          showUnsavedChangesDialog(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetVisualMode.java
Patch:
@@ -47,7 +47,6 @@
 import org.rstudio.studio.client.panmirror.PanmirrorWidget;
 import org.rstudio.studio.client.panmirror.PanmirrorWidget.FormatSource;
 import org.rstudio.studio.client.panmirror.PanmirrorWriterOptions;
-import org.rstudio.studio.client.panmirror.command.PanmirrorCommandUI;
 import org.rstudio.studio.client.panmirror.command.PanmirrorCommands;
 import org.rstudio.studio.client.panmirror.events.PanmirrorFocusEvent;
 import org.rstudio.studio.client.panmirror.events.PanmirrorStateChangeEvent;

File: src/gwt/src/org/rstudio/core/client/widget/NumericValueWidget.java
Patch:
@@ -160,7 +160,8 @@ public HandlerRegistration addEnsureVisibleHandler(EnsureVisibleHandler handler)
    @Override
    public void setElementId(String id)
    {
-      textBox_.getElement().setId(id);      
+      textBox_.getElement().setId(id);
+      textBoxLabel_.setFor(id);
    }
 
    private final SpanLabel textBoxLabel_;

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorInsertTableDialog.java
Patch:
@@ -54,9 +54,6 @@ public PanmirrorInsertTableDialog(PanmirrorTableCapabilities capabilities,
       captionLabel_.setVisible(capabilities.captions);
       caption_.setVisible(capabilities.captions);
       
-      rows_.setElementId(ElementIds.VISUAL_MD_INSERT_TABLE_ROWS);
-      columns_.setElementId(ElementIds.VISUAL_MD_INSERT_TABLE_COLUMNS);
-      caption_.setElementId(ElementIds.VISUAL_MD_INSERT_TABLE_CAPTION);
       header_.getElement().setId(ElementIds.VISUAL_MD_INSERT_TABLE_HEADER);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialog.java
Patch:
@@ -43,6 +43,7 @@ public PreferencesDialog(WorkbenchServerOperations server,
                             PreferencesDialogResources res,
                             Provider<GeneralPreferencesPane> pR,
                             EditingPreferencesPane source,
+                            ConsolePreferencesPane console,
                             RMarkdownPreferencesPane rmarkdown,
                             CompilePdfPreferencesPane compilePdf,
                             AppearancePreferencesPane appearance,
@@ -63,6 +64,7 @@ public PreferencesDialog(WorkbenchServerOperations server,
             true,
             new PreferencesPane[] {pR.get(),
                                    source, 
+                                   console,
                                    appearance, 
                                    paneLayout,
                                    packages,

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialogResources.java
Patch:
@@ -20,7 +20,7 @@
 
 public interface PreferencesDialogResources extends ClientBundle
 {
-   public interface Styles extends CssResource
+   interface Styles extends CssResource
    {
       String panelContainer();
       String paneLayoutTable();
@@ -56,4 +56,6 @@ public interface Styles extends CssResource
 
    @Source("iconAddSourcePane_2x.png")
    ImageResource iconAddSourcePane2x();
+   @Source("iconConsole_2x.png")
+   ImageResource iconConsole2x();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PaneLayoutPreferencesPane.java
Patch:
@@ -183,7 +183,6 @@ public PaneLayoutPreferencesPane(PreferencesDialogResources res,
       if (userPrefs.enableAdditionalColumns().getGlobalValue())
       {
          additionalColumnCount_ = userPrefs.panes().getGlobalValue().getAdditionalSourceColumns();
-         // !!! temporary debugging call
          paneManager_.syncAdditionalColumnCount(additionalColumnCount_);
          addSource_ = new ImageButton("Add source", res_.iconAddSourcePane2x());
          addSource_.setVisible(true);

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -145,7 +145,6 @@ protected void onInit(JsObject value)
                                / state.getPanelWidth();
 
                   addEast(right_, pct * offsetWidth);
-                  for (Widget w : leftList_)
                   for (int i = 0; i < leftList_.size(); i++)
                   {
                      pct = (double)state.getSplitterPos()[i]

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -1299,7 +1299,6 @@ private LogicalWindow createSource(String frameName, Widget display)
    {
       WindowFrame sourceFrame = new WindowFrame(frameName);
       sourceFrame.setFillWidget(display);
-      //source_.forceLoad();
       LogicalWindow sourceWindow = new LogicalWindow(
             sourceFrame,
             new MinimizedWindowFrame(frameName, frameName));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTarget.java
Patch:
@@ -191,7 +191,6 @@ protected String getContentUrl()
    @Override
    public void popoutDoc()
    {
-      Debug.logToConsole("initiating popout from dataEditingTarget for: " + getId());
       events_.fireEvent(new PopoutDocEvent(getId(), null, null));
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/ObjectExplorerEditingTarget.java
Patch:
@@ -18,7 +18,6 @@
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.widget.SimplePanelWithProgress;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -132,7 +131,6 @@ protected String getContentUrl()
    @Override
    public void popoutDoc()
    {
-      Debug.logToConsole("new popoutDoc event from objectExporerEditingTarget: " + getId());
       events_.fireEvent(new PopoutDocEvent(getId(), null, null));
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -833,7 +833,6 @@ public static void onGlobalMessage(final String message,
    @Handler
    void onPopoutDoc()
    {
-      Debug.logToConsole("initiating event from  profilerEditingTarget: " + getId());
       events_.fireEvent(new PopoutDocEvent(getId(), currentPosition(), null));
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -18,7 +18,6 @@
 import java.util.Comparator;
 import java.util.List;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.ColorUtil;
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Size;
@@ -782,7 +781,6 @@ private void completeInterrupt()
 
    private void popoutChunk()
    {
-      Debug.logToConsole("popoutChunk documentId_: " + documentId_ + " chunkId_: " + chunkId_);
       chunkWindowManager_.openChunkWindow(
          documentId_,
          chunkId_,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTarget.java
Patch:
@@ -221,7 +221,6 @@ void onPopoutDoc()
 
    public void popoutDoc()
    {
-      Debug.logToConsole("popoutDoc in URL");
       globalDisplay_.openWindow(getContentUrl());
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -107,7 +107,6 @@ public void setChunkState(int preambleRow, int state)
    @Inject
    private void initialize(UserPrefs prefs, UserState state)
    {
-      initialized_ = true;
       prefs_ = prefs;
       state_ = state;
       dark_ = state.theme().getValue().getIsDark();
@@ -193,6 +192,7 @@ private void syncWidgets()
                toolbars_.remove(toolbar);
             }
          }
+         initialized_ = true;
       }
 
       if (currentScope != null)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -107,7 +107,6 @@ public void setChunkState(int preambleRow, int state)
    @Inject
    private void initialize(UserPrefs prefs, UserState state)
    {
-      initialized_ = true;
       prefs_ = prefs;
       state_ = state;
       dark_ = state.theme().getValue().getIsDark();
@@ -193,6 +192,7 @@ private void syncWidgets()
                toolbars_.remove(toolbar);
             }
          }
+         initialized_ = true;
       }
 
       if (currentScope != null)

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPreferencesDialog.java
Patch:
@@ -63,6 +63,7 @@ public ProjectPreferencesDialog(ProjectsServerOperations server,
    {
       super("Project Options",
             RES.styles().panelContainer(),
+            RES.styles().panelContainerNoChooser(),
             false,
             new ProjectPreferencesPane[] {general, editing, compilePdf, build,
                                           source, renv, sharing});

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPreferencesDialogResources.java
Patch:
@@ -24,6 +24,7 @@ public interface ProjectPreferencesDialogResources extends ClientBundle
    interface Styles extends CssResource
    {
       String panelContainer();
+      String panelContainerNoChooser();
       String buildToolsPanel();
       String workspaceGrid();
       String enableCodeIndexing();

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSAccountConnector.java
Patch:
@@ -170,7 +170,7 @@ public void onRsconnectManageAccounts()
       }
       else
       {
-         optionsLoader_.showOptions(PublishingPreferencesPane.class);
+         optionsLoader_.showOptions(PublishingPreferencesPane.class, true);
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialog.java
Patch:
@@ -61,6 +61,7 @@ public PreferencesDialog(WorkbenchServerOperations server,
    {
       super("Options",
             res.styles().panelContainer(),
+            res.styles().panelContainerNoChooser(),
             true,
             new PreferencesPane[] {pR.get(),
                                    source,

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialogResources.java
Patch:
@@ -23,6 +23,7 @@ public interface PreferencesDialogResources extends ClientBundle
    interface Styles extends CssResource
    {
       String panelContainer();
+      String panelContainerNoChooser();
       String paneLayoutTable();
       String themeChooser();
       String sshKeyWidget();

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -558,7 +558,7 @@ private void swapConsolePane(PaneConfig paneConfig, int consoleTargetIndex)
    @Handler
    public void onPaneLayout()
    {
-      optionsLoader_.showOptions(PaneLayoutPreferencesPane.class);
+      optionsLoader_.showOptions(PaneLayoutPreferencesPane.class, true);
    }
 
    private <T> boolean equals(T lhs, T rhs)

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchScreen.java
Patch:
@@ -395,13 +395,13 @@ void onShowOptions()
    @Handler
    void onShowAccessibilityOptions()
    {
-      optionsLoader_.showOptions(AccessibilityPreferencesPane.class);
+      optionsLoader_.showOptions(AccessibilityPreferencesPane.class, false);
    }
 
    @Handler
    void onShowTerminalOptions()
    {
-      optionsLoader_.showOptions(TerminalPreferencesPane.class);
+      optionsLoader_.showOptions(TerminalPreferencesPane.class, true);
    }
 
    @Handler

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialog.java
Patch:
@@ -43,6 +43,7 @@ public PreferencesDialog(WorkbenchServerOperations server,
                             PreferencesDialogResources res,
                             Provider<GeneralPreferencesPane> pR,
                             EditingPreferencesPane source,
+                            ConsolePreferencesPane console,
                             RMarkdownPreferencesPane rmarkdown,
                             CompilePdfPreferencesPane compilePdf,
                             AppearancePreferencesPane appearance,
@@ -63,6 +64,7 @@ public PreferencesDialog(WorkbenchServerOperations server,
             true,
             new PreferencesPane[] {pR.get(),
                                    source, 
+                                   console,
                                    appearance, 
                                    paneLayout,
                                    packages,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceColumnManager.java
Patch:
@@ -1142,7 +1142,7 @@ public void disownDocOnDrag(String docId, SourceColumn column)
             Debug.logWarning("Warning: No column was provided to remove the doc from.");
          column = getActive();
       }
-
+      column.closeDoc(docId);
       column.cancelTabDrag();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PaneLayoutPreferencesPane.java
Patch:
@@ -183,6 +183,8 @@ public PaneLayoutPreferencesPane(PreferencesDialogResources res,
       if (userPrefs.enableAdditionalColumns().getGlobalValue())
       {
          additionalColumnCount_ = userPrefs.panes().getGlobalValue().getAdditionalSourceColumns();
+         // !!! temporary debugging call
+         paneManager_.syncAdditionalColumnCount(additionalColumnCount_);
          addSource_ = new ImageButton("Add source", res_.iconAddSourcePane2x());
          addSource_.setVisible(true);
          add(addSource_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1341,7 +1341,9 @@ public void onDocWindowChanged(final DocWindowChangedEvent e)
          // If we can not determine the new column and the window has more than one column,
          // log a warning but continue to prevent the tab from being lost.
          final SourceColumn newDisplay = columnManager_.findByPosition(e.getXPos());
-         if (newDisplay == null && columnManager_.getSize() > 1)
+         if (newDisplay == null &&
+             e.getNewWindowId().equals(e.getOldWindowId()) &&
+             columnManager_.getSize() > 1)
             Debug.logWarning("Couldn't determine new window column for dragged document.");
 
          // the event doesn't contain the display info, so we add it now

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3689,9 +3689,9 @@ void onReturnDocToMain()
             public void execute()
             {
                events_.fireEventToMainWindow(new DocWindowChangedEvent(
-                     getId(), SourceWindowManager.getSourceWindowId(), "",
-                     DocTabDragParams.create(getId(), currentPosition(), null),
-                     docUpdateSentinel_.getDoc().getCollabParams(), 0, -1));
+                  getId(), SourceWindowManager.getSourceWindowId(), "",
+                  DocTabDragParams.create(getId(), currentPosition()),
+                  docUpdateSentinel_.getDoc().getCollabParams(), 0, -1));
             }
          });
       }

File: src/gwt/src/org/rstudio/studio/client/palette/CommandPaletteLauncher.java
Patch:
@@ -88,10 +88,10 @@ private void createPanel()
    {
       // Extra sources (currently only the source tab)
       List<CommandPaletteEntrySource> sources = new ArrayList<CommandPaletteEntrySource>();
-      sources.add(pSource_.get());
       
       // Create sources
       sources.add(new AppCommandPaletteSource(ShortcutManager.INSTANCE, commands_));
+      sources.add(pSource_.get());
       sources.add(new RAddinPaletteSource(addins_.getRAddins(), ShortcutManager.INSTANCE));
       sources.add(new UserPrefPaletteSource(pPrefs_.get()));
 

File: src/gwt/src/org/rstudio/studio/client/palette/RAddinPaletteItem.java
Patch:
@@ -75,7 +75,6 @@ public void setSelected(boolean selected)
       widget_.setSelected(selected);
    }
    
-   private RAddinCommandPaletteEntry widget_;
    private String label_;
    
    private final RAddin addin_;

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarCommands.java
Patch:
@@ -123,7 +123,7 @@ public PanmirrorToolbarCommands(PanmirrorCommand[] commands)
       add(PanmirrorCommands.DefinitionDescription, "Description");
       add(PanmirrorCommands.Citation, "Citation...");   
       add(PanmirrorCommands.CrossReference, "Cross Reference");
-      add(PanmirrorCommands.InsertSymbol, "Insert:::Symbol...");
+      add(PanmirrorCommands.Symbol, "Insert:::Symbol...");
    }
    
    public PanmirrorCommandUI get(String id)

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -149,7 +149,7 @@ protected void onInit(JsObject value)
                else
                {
                   addEast(right_, state.getSplitterPos()[0]);
-                  for (int i = 1; i < leftList_.size() + 1; i++)
+                  for (int i = 0; i < leftList_.size(); i++)
                   {
                      addWest(leftList_.get(i), state.getSplitterPos()[i]);
                   }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -214,6 +214,7 @@ public PaneManager(Provider<MainSplitPanel> pSplitPanel,
                       UserPrefs userPrefs,
                       @Named("Console") final Widget consolePane,
                       Source source,
+                      SourceColumnManager sourceColumnManager,
                       @Named("History") final WorkbenchTab historyTab,
                       @Named("Files") final WorkbenchTab filesTab,
                       @Named("Plots") final WorkbenchTab plotsTab,
@@ -245,7 +246,7 @@ public PaneManager(Provider<MainSplitPanel> pSplitPanel,
       userPrefs_ = userPrefs;
       consolePane_ = (ConsolePane)consolePane;
       source_ = source;
-      sourceColumnManager_ = source.getColumnManager();
+      sourceColumnManager_ = sourceColumnManager;
       historyTab_ = historyTab;
       filesTab_ = filesTab;
       plotsTab_ = plotsTab;

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorCommandUI.java
Patch:
@@ -69,7 +69,7 @@ public String getFullMenuText()
    
    public String getDesc()
    {
-      return menuText_;
+      return getFullMenuText();
    }
    
    public String getTooltip()

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxRenderQueue.java
Patch:
@@ -18,7 +18,6 @@
 import java.util.List;
 import java.util.Queue;
 
-import org.rstudio.studio.client.common.mathjax.MathJax.MathJaxTypesetCallback;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Range;
 
 public class MathJaxRenderQueue
@@ -28,7 +27,7 @@ public MathJaxRenderQueue(MathJax mathjax)
       mathjax_ = mathjax;
       
       ranges_ = new LinkedList<Range>();
-      callback_ = new MathJaxTypesetCallback()
+      callback_ = new MathJaxTypeset.Callback()
       {
          @Override
          public void onMathJaxTypesetComplete(boolean error)
@@ -74,7 +73,7 @@ private boolean renderNext()
    private final MathJax mathjax_;
    
    private final Queue<Range> ranges_;
-   private final MathJaxTypesetCallback callback_;
+   private final MathJaxTypeset.Callback callback_;
    private boolean isRunning_;
 
 }

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteApplication.java
Patch:
@@ -170,6 +170,7 @@ protected void flushPendingEvents()
    private SatelliteApplicationView view_;
    private Satellite satellite_;
    private Provider<AceThemes> pAceThemes_;
+   @SuppressWarnings("unused")
    private Provider<UserPrefs> pUserPrefs_;
    private ApplicationUncaughtExceptionHandler uncaughtExHandler_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -852,6 +852,7 @@ public String getMonitoredEnvironment()
    private final UserPrefs prefs_;
    private final DependencyManager dependencyManager_;
    private final Value<Boolean> environmentMonitoring_;
+   @SuppressWarnings("unused")
    private final Timer refreshTimer_;
 
    private SecondaryToolbar secondaryToolbar_;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -512,7 +512,8 @@
    public abstract AppCommand showSessionServerOptionsDialog();
    public abstract AppCommand showWarningBar();
    public abstract AppCommand signOut();
- 
+   public abstract AppCommand loadServerHome();
+
    // Build
    public abstract AppCommand buildAll();
    public abstract AppCommand devtoolsLoadAll();

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModuleOverlay.java
Patch:
@@ -20,7 +20,5 @@ public class RStudioGinModuleOverlay extends RStudioGinModule
    protected void configure()
    {
       super.configure();
-
-      
    }
 }

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -58,9 +58,7 @@ public static Test suite()
       suite.addTestSuite(ElementIdsTests.class);
       suite.addTestSuite(ChunkContextUiTests.class);
       suite.addTestSuite(SafeHtmlUtilTests.class);
-      
-      // Pro-only tests
-      
+
       return suite;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModuleOverlay.java
Patch:
@@ -20,7 +20,5 @@ public class RStudioGinModuleOverlay extends RStudioGinModule
    protected void configure()
    {
       super.configure();
-
-      
    }
 }

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -58,9 +58,7 @@ public static Test suite()
       suite.addTestSuite(ElementIdsTests.class);
       suite.addTestSuite(ChunkContextUiTests.class);
       suite.addTestSuite(SafeHtmlUtilTests.class);
-      
-      // Pro-only tests
-      
+
       return suite;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/application/AriaLiveService.java
Patch:
@@ -57,6 +57,9 @@ public class AriaLiveService
    // Milliseconds to wait before making an announcement at session load
    public static final int STARTUP_ANNOUNCEMENT_DELAY = 3000;
 
+   // Milliseconds to wait before making an announcement after significant UI change
+   public static final int UI_ANNOUNCEMENT_DELAY = 1000;
+
    @Inject
    public AriaLiveService(EventBus eventBus, Provider<UserPrefs> pUserPrefs)
    {

File: src/gwt/src/org/rstudio/studio/client/application/ui/WarningBar.java
Patch:
@@ -88,7 +88,7 @@ public WarningBar(EventBus events, AriaLiveService ariaLive)
       moreButton_.setText("Manage License...");
       moreButton_.addClickHandler(event -> Desktop.getFrame().showLicenseDialog());
       A11y.setARIAHidden(label_);
-      if (ariaLive.isDisabled(AriaLiveService.WARNING_BAR))
+      if (!ariaLive.isDisabled(AriaLiveService.WARNING_BAR))
          Roles.getAlertRole().set(live_);
    }
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/WarningBar.java
Patch:
@@ -88,7 +88,7 @@ public WarningBar(EventBus events, AriaLiveService ariaLive)
       moreButton_.setText("Manage License...");
       moreButton_.addClickHandler(event -> Desktop.getFrame().showLicenseDialog());
       A11y.setARIAHidden(label_);
-      if (ariaLive.isDisabled(AriaLiveService.WARNING_BAR))
+      if (!ariaLive.isDisabled(AriaLiveService.WARNING_BAR))
          Roles.getAlertRole().set(live_);
    }
 

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -131,6 +131,7 @@
 import org.rstudio.studio.client.workbench.views.source.DocumentOutlineWidget;
 import org.rstudio.studio.client.workbench.views.source.NewPlumberAPI;
 import org.rstudio.studio.client.workbench.views.source.NewShinyWebApplication;
+import org.rstudio.studio.client.workbench.views.source.SourceColumn;
 import org.rstudio.studio.client.workbench.views.source.SourceSatellite;
 import org.rstudio.studio.client.workbench.views.source.SourceWindow;
 import org.rstudio.studio.client.workbench.views.source.SourceWindowManager;
@@ -301,7 +302,8 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(PanmirrorUIDisplay panmirrorUIDisplay);
    void injectMembers(TextEditingTargetVisualMode textEditingTargetVisualMode);
    void injectMembers(OpenProjectDialog dialog);
-   
+   void injectMembers(SourceColumn column);
+
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 
    Application getApplication();

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -289,8 +289,7 @@ public PaneManager(Provider<MainSplitPanel> pSplitPanel,
       //get the widgets for the extra source columns to be displayed
       ArrayList<Widget> sourceColumns;
       if (sourceColumnManager_.getSize() > 1 && additionalSourceCount_ > 0)
-         sourceColumns = new ArrayList<Widget>(
-               sourceColumnManager_.getWidgets().subList(1, additionalSourceCount_ + 1));
+         sourceColumns = new ArrayList<Widget>(sourceColumnManager_.getWidgets(true));
       else
          sourceColumns =  new ArrayList<Widget>();
       panel_.initialize(sourceColumns, left_, right_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -672,7 +672,8 @@ public void onSourceDocAdded(SourceDocAddedEvent e)
    {
       // if the window that fired the event is not already the owner of the
       // document, make it the owner
-      if (e.getDoc().getSourceWindowId() != e.getWindowId())
+      if (e.getDoc().getSourceWindowId() != e.getWindowId() ||
+          e.getDoc().getSourceDisplayName() != e.getDisplayName())
       {
          // assign on the doc itself
          e.getDoc().assignSourceWindowId(e.getWindowId());

File: src/gwt/src/org/rstudio/core/client/ConsoleOutputWriter.java
Patch:
@@ -95,6 +95,7 @@ public boolean outputToConsole(String text,
       {
          SpanElement trailing = Document.get().createSpanElement();
          trailing.setTabIndex(-1);
+         Roles.getDocumentRole().set(trailing); // https://github.com/rstudio/rstudio/issues/6884
          outEl.appendChild(trailing);
          virtualConsole_ = vcFactory_.create(trailing);
       }

File: src/gwt/src/org/rstudio/core/client/ConsoleOutputWriter.java
Patch:
@@ -95,6 +95,7 @@ public boolean outputToConsole(String text,
       {
          SpanElement trailing = Document.get().createSpanElement();
          trailing.setTabIndex(-1);
+         Roles.getDocumentRole().set(trailing); // https://github.com/rstudio/rstudio/issues/6884
          outEl.appendChild(trailing);
          virtualConsole_ = vcFactory_.create(trailing);
       }

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -558,9 +558,10 @@ public void onPreviewNativeEvent(Event.NativePreviewEvent event)
             if (enterDisabled_)
                break;
 
-            // allow Enter on textareas or anchors (including custom links)
+            // allow Enter on textareas, buttons, or anchors (including custom links)
             Element e = DomUtils.getActiveElement();
             if (e.hasTagName("TEXTAREA") || e.hasTagName("A") ||
+                  e.hasTagName("BUTTON") ||
                   e.hasClassName(allowEnterKeyClass) ||
                   (e.hasAttribute("role") && StringUtil.equals(e.getAttribute("role"), "link")))
                return;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -260,6 +260,7 @@ private void announceScreenReaderState()
                   Timing.IMMEDIATE, Severity.ALERT);
          });
       }
+      setScreenReaderMenuState(enableScreenReader().getValue());
    }
 
    public void setScreenReaderEnabled(boolean enabled)

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -73,7 +73,7 @@ public String consoleAnsiMode()
       @Override
       public boolean screenReaderEnabled()
       {
-         return getUserPrefs().getScreenReaderEnabled();
+         return getUserPrefs().enableScreenReader().getValue();
       }
    }
 

File: src/gwt/src/org/rstudio/core/client/command/ShortcutViewer.java
Patch:
@@ -76,7 +76,7 @@ public void onHelpKeyboardShortcuts()
             openApplicationURL("docs/keyboard.htm");
       };
 
-      if (pPrefs_.get().getScreenReaderEnabled())
+      if (pPrefs_.get().enableScreenReader().getValue())
          showAllShortcutsPage.execute();
       else
          showShortcutInfoPanel(new ShortcutInfoPanel(showAllShortcutsPage));
@@ -89,7 +89,7 @@ public void showVimKeyboardShortcuts()
       {
          return;
       }
-      if (pPrefs_.get().getScreenReaderEnabled())
+      if (pPrefs_.get().enableScreenReader().getValue())
       {
          pAriaLive_.get().announce(AriaLiveService.INACCESSIBLE_FEATURE,
                "Vim keyboard shortcut help not screen reader accessible. Press any key to close.",

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AccessibilityPreferencesPane.java
Patch:
@@ -110,7 +110,7 @@ public String getName()
    @Override
    protected void initialize(UserPrefs prefs)
    {
-      initialScreenReaderEnabled_ = prefs.getScreenReaderEnabled();
+      initialScreenReaderEnabled_ = prefs.enableScreenReader().getValue();
       chkScreenReaderEnabled_.setValue(initialScreenReaderEnabled_);
       chkTabMovesFocus_.setValue(prefs.tabKeyMoveFocus().getValue());
       populateAnnouncementList();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -1131,7 +1131,7 @@ private XTermOptions defaultTerminalOptions()
       return XTermOptions.create(
             UserPrefsAccessor.TERMINAL_BELL_STYLE_NONE,
             uiPrefs_.blinkingCursor().getValue(),
-            uiPrefs_.getScreenReaderEnabled(),
+            uiPrefs_.enableScreenReader().getValue(),
             uiPrefs_.terminalRenderer().getValue(),
             BrowseCap.isWindowsDesktop(),
             XTermTheme.terminalThemeFromEditorTheme(),

File: src/gwt/src/org/rstudio/studio/client/panmirror/format/PanmirrorExtendedDocType.java
Patch:
@@ -19,8 +19,6 @@
 public class PanmirrorExtendedDocType
 {    
    public static String bookdown = "bookdown";
-   public static String blogdown = "blogdown";
-   public static String hugodown = "hugodown";
    public static String hugo = "hugo";
 }
 

File: src/gwt/src/org/rstudio/core/client/AriaUtil.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AriaUtil.java
  *
- * Copyright (C) 2009-2020 by RStudio, Inc.
+ * Copyright (C) 2009-2020 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/core/client/jsinterop/JsVoidFunction.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * JsVoidFunction.java
  *
- * Copyright (C) 2009-20 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/core/client/promise/PromiseServerRequestCallback.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PromiseServerRequestCallback.java
  *
- * Copyright (C) 2009-20 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/core/client/promise/PromiseWithProgress.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PromiseWithProgress.java
  *
- * Copyright (C) 2009-20 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/core/client/widget/DockPanelSidebarDragHandler.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DockPanelSidebarDragHandler.java
  *
- * Copyright (C) 2009-20 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/core/client/widget/IsHideableWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * IsHideableWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-12 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -90,6 +90,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ContextDepthChanged = "context_depth_changed";
    public static final String EnvironmentAssigned = "environment_assigned";
    public static final String EnvironmentRemoved = "environment_removed";
+   public static final String EnvironmentChanged = "environment_changed";
    public static final String BrowserLineChanged = "browser_line_changed";
    public static final String PackageLoaded = "package_loaded";
    public static final String PackageUnloaded = "package_unloaded";
@@ -191,6 +192,7 @@ class ClientEvent extends JavaScriptObject
    public static final String HighlightUi = "highlight_ui";
    public static final String TutorialCommand = "tutorial_command";
    public static final String TutorialLaunch = "tutorial_launch";
+   public static final String ReticulateEvent = "reticulate_event";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/view/ObjectExplorerEditingTargetStatusBar.java
Patch:
@@ -66,7 +66,7 @@ public void onSelectionChanged(SelectionChangedEvent event)
                return;
             }
             
-            String accessor = ObjectExplorerDataGrid.generateExtractingRCode(
+            String accessor = ObjectExplorerDataGrid.generateExtractingCode(
                   data,
                   widget_.getHandle().getTitle());
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditorContainer.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TextEditorContainer.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -265,7 +265,6 @@ void showUnsavedChangesDialog(
       void onNewSourceDoc();
       HandlerRegistration addBeforeShowHandler(BeforeShowHandler handler);
 
-
       // !!! maybe moved
       void setPendingDebugSelection();
    }
@@ -290,7 +289,7 @@ public void setActive(Display display)
       public void setActive(EditingTarget target)
       {
          activeDisplay_ = getDisplayByDocument(target.getId());
-            // !!! Debug code to be removed
+         // !!! Debug code to be removed
          if (activeDisplay_ != null)
             activeDisplay_.setActiveEditor(target);
          else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -323,8 +323,6 @@ void onFindFromSelection()
    @Handler
    void onPopoutDoc()
    {
-      // !!! the display cannot be null here
-      Debug.logToConsole("Initiating PopoutDocEvent from CodeBrowserEditingTarget: " + getId());
       events_.fireEvent(new PopoutDocEvent(getId(), currentPosition(), null));
    }
 

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorEditor.java
Patch:
@@ -50,7 +50,7 @@ public native static Promise<PanmirrorEditor> create(Element parent,
    
    public native Promise<JsObject> setMarkdown(String code, PanmirrorWriterOptions options, boolean emitUpdate);
    
-   public native Promise<PanmirrorCode> getMarkdown(PanmirrorWriterOptions options);
+   public native Promise<JsObject> getMarkdown(PanmirrorWriterOptions options);
    
    public native Promise<String> getCanonical(String code, PanmirrorWriterOptions options);
    

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -367,8 +367,8 @@ public void setMarkdown(String code,
       );
    }
    
-   public void getMarkdown(PanmirrorWriterOptions options, CommandWithArg<PanmirrorCode> completed) {
-      new PromiseWithProgress<PanmirrorCode>(
+   public void getMarkdown(PanmirrorWriterOptions options, CommandWithArg<JsObject> completed) {
+      new PromiseWithProgress<JsObject>(
          editor_.getMarkdown(options),
          null,
          kSerializationProgressDelayMs,

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -357,9 +357,9 @@ public String getTitle()
    public void setMarkdown(String code, 
                            PanmirrorWriterOptions options, 
                            boolean emitUpdate, 
-                           CommandWithArg<PanmirrorEditor.SetMarkdownResult> completed) 
+                           CommandWithArg<JsObject> completed) 
    {
-      new PromiseWithProgress<PanmirrorEditor.SetMarkdownResult>(
+      new PromiseWithProgress<JsObject>(
          editor_.setMarkdown(code, options, emitUpdate),
          null,
          kSerializationProgressDelayMs,

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -41,7 +41,7 @@
 import com.google.gwt.user.client.ui.VerticalPanel;
 import com.google.gwt.user.client.ui.Widget;
 
-import elemental.client.Browser;
+import elemental2.dom.DomGlobal;
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.Point;
@@ -231,7 +231,7 @@ protected void positionAndShowDialog(Command onCompleted)
       Element child = e.getFirstChildElement();
       if (child != null)
       {
-         int windowInnerHeight = Browser.getWindow().getInnerHeight();
+         int windowInnerHeight = DomGlobal.window.innerHeight;
          if (windowInnerHeight <= 10) return; // degenerate property case
 
          // snap the top of the modal to the top bounds of the window

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -288,10 +288,11 @@ public void setActive(Display display)
       public void setActive(EditingTarget target)
       {
          activeDisplay_ = getDisplayByDocument(target.getId());
+            // !!! Debug code to be removed
          if (activeDisplay_ != null)
             activeDisplay_.setActiveEditor(target);
          else
-            Debug.logToConsole("ERROR: WE HAVE AN EDITOR WITHOUT A DISPLAY");
+            Debug.logToConsole("Error: We have an editor without a display");
       }
 
       public Display getActiveDisplay()
@@ -306,7 +307,7 @@ public Display getActiveDisplay()
             if (activeDisplay_ != null)
                return activeDisplay_;
             else
-               Debug.logToConsole("ERROR: WE HAVE AN EDITOR WITHOUT A DISPLAY");
+               Debug.logToConsole("Error: We have an editor without a display.");
          }
          else
             activeDisplay_ = this.get(0);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -627,7 +627,6 @@ else if (type == EditorCommandEvent.TYPE_SET_SELECTION_RANGES)
    @Override
    public void onPopoutDoc(final PopoutDocEvent evt)
    {
-      Debug.logToConsole("onPopoutDoc for ID: " + evt.getDocId());
       // assign a new window ID to the source document 
       final String windowId = createSourceWindowId();
       assignSourceDocWindowId(evt.getDocId(), windowId, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryTable.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HistoryTable.java
  *
- * Copyright (C) 2009-12 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -57,6 +57,7 @@ public HistoryTable(String commandClassName,
 
       final Resources res = GWT.create(Resources.class);
       setStyleName(res.styles().historyTable());
+      addStyleName("rstudio-fixed-width-font");
       FontSizer.applyNormalFontSize(this);
 
       if (searchResult_)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/diff/LineTableView.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * LineTableView.java
  *
- * Copyright (C) 2009-12 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -248,6 +248,7 @@ public LineTableView(int filesCompared,
       super(1, res);
 
       FontSizer.applyNormalFontSize(this);
+      addStyleName("rstudio-fixed-width-font");
 
       for (int i = 0; i < filesCompared; i++)
       {

File: src/gwt/src/org/rstudio/core/client/widget/BannerWidget.java
Patch:
@@ -14,18 +14,18 @@
  */
 package org.rstudio.core.client.widget;
 
-import com.google.gwt.aria.client.Roles;
+import com.google.gwt.user.client.DOM;
 import com.google.gwt.user.client.ui.SimplePanel;
 import com.google.gwt.user.client.ui.Widget;
 
 /**
- * A widget with role=banner wrapping another widget
+ * A widget with html5 header (aka role="banner") element wrapping another widget
  */
 public class BannerWidget extends SimplePanel
 {
    public BannerWidget(Widget child)
    {
+      super(DOM.createElement("header"));
       setWidget(child);
-      Roles.getBannerRole().set(getElement());
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -285,9 +285,9 @@ public PaneManager(Provider<MainSplitPanel> pSplitPanel,
 
       //get the widgets for the extra source columns to be displayed
       ArrayList<Widget> sourceColumns;
-      if (source_.getViews().size() > 1 && sourceColumnCount_ > 1)
+      if (source_.getViews().size() > 1 && sourceColumnCount_ > 0)
          sourceColumns = new ArrayList<Widget>(
-               source_.getViewsAsWidgets().subList(1, sourceColumnCount_ -1));
+               source_.getViewsAsWidgets().subList(1, sourceColumnCount_ + 1));
       else
          sourceColumns =  new ArrayList<Widget>();
       panel_.initialize(sourceColumns, left_, right_);

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -15,6 +15,7 @@
  */
 package org.rstudio.core.client.theme;
 
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.BrowseCap;
 import org.rstudio.core.client.ClassIds;
 import org.rstudio.core.client.Point;
@@ -1003,6 +1004,7 @@ public void endDrag(final Event evt, int action)
                      events_.fireEvent(new PopoutDocInitiatedEvent(
                            initDragParams_.getDocId(), Point.create(
                                  evt.getScreenX(), evt.getScreenY())));
+                     Debug.logToConsole("initiating event from DocTabLayoutPanel for: " + initDragParams_.getDocId());
                   }
                }
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -285,7 +285,7 @@ public PaneManager(Provider<MainSplitPanel> pSplitPanel,
 
       //get the widgets for the extra source columns to be displayed
       ArrayList<Widget> sourceColumns;
-      if (source_.getViews().size() > 1)
+      if (source_.getViews().size() > 1 && sourceColumnCount_ > 1)
          sourceColumns = new ArrayList<Widget>(
                source_.getViewsAsWidgets().subList(1, sourceColumnCount_ -1));
       else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourcePane.java
Patch:
@@ -229,6 +229,7 @@ public int getActiveTabIndex()
    @Override
    public boolean hasDoc(String docId)
    {
+      Debug.logToConsole("hasDoc: " + docId);
       for (EditingTarget target : editors_)
       {
          if (StringUtil.equals(docId, target.getId()))
@@ -296,6 +297,7 @@ public void closeTabByDocId(String docId, boolean interactive)
       {
          if (editors_.get(i).getId() == docId)
          {
+            Debug.logToConsole("DocId: " + docId + " succesfully closed");
             closeTab(i, interactive, null);
             break;
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -627,6 +627,7 @@ else if (type == EditorCommandEvent.TYPE_SET_SELECTION_RANGES)
    @Override
    public void onPopoutDoc(final PopoutDocEvent evt)
    {
+      Debug.logToConsole("onPopoutDoc for ID: " + evt.getDocId());
       // assign a new window ID to the source document 
       final String windowId = createSourceWindowId();
       assignSourceDocWindowId(evt.getDocId(), windowId, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -324,6 +324,7 @@ void onFindFromSelection()
    void onPopoutDoc()
    {
       // !!! the display cannot be null here
+      Debug.logToConsole("Initiating PopoutDocEvent from CodeBrowserEditingTarget: " + getId());
       events_.fireEvent(new PopoutDocEvent(getId(), currentPosition(), null));
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTarget.java
Patch:
@@ -191,6 +191,7 @@ protected String getContentUrl()
    @Override
    public void popoutDoc()
    {
+      Debug.logToConsole("initiating popout from dataEditingTarget for: " + getId());
       events_.fireEvent(new PopoutDocEvent(getId(), null, null));
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/ObjectExplorerEditingTarget.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
 
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.widget.SimplePanelWithProgress;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -131,6 +132,7 @@ protected String getContentUrl()
    @Override
    public void popoutDoc()
    {
+      Debug.logToConsole("new popoutDoc event from objectExporerEditingTarget: " + getId());
       events_.fireEvent(new PopoutDocEvent(getId(), null, null));
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -825,6 +825,7 @@ public static void onGlobalMessage(final String message,
    @Handler
    void onPopoutDoc()
    {
+      Debug.logToConsole("initiating event from  profilerEditingTarget: " + getId());
       events_.fireEvent(new PopoutDocEvent(getId(), currentPosition(), null));
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -18,6 +18,7 @@
 import java.util.Comparator;
 import java.util.List;
 
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.ColorUtil;
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Size;
@@ -781,6 +782,7 @@ private void completeInterrupt()
 
    private void popoutChunk()
    {
+      Debug.logToConsole("popoutChunk documentId_: " + documentId_ + " chunkId_: " + chunkId_);
       chunkWindowManager_.openChunkWindow(
          documentId_,
          chunkId_,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3591,10 +3591,12 @@ public void syncLocalSourceDb()
    @Handler
    void onPopoutDoc()
    {
+      Debug.logToConsole("popping out doc: " + getId());
       if (docUpdateSentinel_ != null)
       {
          // ensure doc is synchronized with source database before popping it
          // out
+         Debug.logToConsole("popping out doc: " + getId());
          docUpdateSentinel_.withSavedDoc(new Command()
          {
             @Override
@@ -3603,6 +3605,7 @@ public void execute()
                // push the new doc state into the local source database
                syncLocalSourceDb();
 
+               Debug.logToConsole("popping out doc: " + getId());
                // !!! Display cannot be null here
                // fire popout event (this triggers a close in the current window
                // and the creation of a new window with the doc)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTarget.java
Patch:
@@ -219,6 +219,7 @@ void onPopoutDoc()
 
    public void popoutDoc()
    {
+      Debug.logToConsole("popoutDoc in URL");
       globalDisplay_.openWindow(getContentUrl());
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/events/PopoutDocEvent.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.source.events;
 
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.js.JavaScriptSerializable;
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.workbench.views.source.Source;
@@ -44,6 +45,7 @@ public PopoutDocEvent(PopoutDocInitiatedEvent originator,
       originator_ = originator;
       sourcePosition_ = sourcePosition;
       display_ = display;
+      Debug.logToConsole("new PopoutDocEvent for: " + originator_.getDocId());
    }
    
    public PopoutDocInitiatedEvent getOriginator()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetVisualMode.java
Patch:
@@ -754,7 +754,9 @@ private TextEditorContainer.Editor getSourceEditor()
   
    private boolean getOutlineVisible()
    {
-      return target_.getPreferredOutlineWidgetVisibility();
+      return target_.getPreferredOutlineWidgetVisibility(
+         prefs_.visualMarkdownEditingShowDocOutline().getValue()
+      );
    }
    
    private void setOutlineVisible(boolean visible)

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -2,7 +2,7 @@
  * 
  * DocTabLayoutPanel.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -16,6 +16,7 @@
 package org.rstudio.core.client.theme;
 
 import org.rstudio.core.client.BrowseCap;
+import org.rstudio.core.client.ClassIds;
 import org.rstudio.core.client.Point;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
@@ -112,6 +113,7 @@ public DocTabLayoutPanel(boolean closeableTabs,
       styles_ = ThemeResources.INSTANCE.themeStyles();
       addStyleName(styles_.docTabPanel());
       addStyleName(styles_.moduleTabPanel());
+      ClassIds.assignClassId(this, ClassIds.SOURCE_PANEL);
       dragManager_ = new DragManager();
       
       // listen for global drag events (these are broadcast from other windows

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedWindowFrame.java
Patch:
@@ -20,7 +20,7 @@
 import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.user.client.ui.*;
-import org.rstudio.core.client.ElementIds;
+import org.rstudio.core.client.ClassIds;
 import org.rstudio.core.client.events.HasWindowStateChangeHandlers;
 import org.rstudio.core.client.events.WindowStateChangeEvent;
 import org.rstudio.core.client.events.WindowStateChangeHandler;
@@ -93,7 +93,7 @@ public MinimizedWindowFrame(String title, String accessibleName, Widget extraWid
       }
 
       WindowFrameButton minimize = new WindowFrameButton(accessibleName, WindowState.NORMAL);
-      minimize.setElementId(ElementIds.MIN_FRAME_MIN_BTN + "_" + ElementIds.idSafeString(accessibleName));
+      minimize.setClassId(ClassIds.PANEL_MIN_BTN, accessibleName);
       minimize.setStylePrimaryName(themeStyles.minimize());
       minimize.setClickHandler(() ->
       {
@@ -102,7 +102,7 @@ public MinimizedWindowFrame(String title, String accessibleName, Widget extraWid
       inner.add(minimize);
 
       WindowFrameButton maximize = new WindowFrameButton(accessibleName, WindowState.MAXIMIZE);
-      maximize.setElementId(ElementIds.MIN_FRAME_MAX_BTN + "_" + ElementIds.idSafeString(accessibleName));
+      maximize.setClassId(ClassIds.PANEL_MAX_BTN, accessibleName);
       maximize.setStylePrimaryName(themeStyles.maximize());
       maximize.setClickHandler(() ->
       {

File: src/gwt/src/org/rstudio/core/client/theme/WindowFrame.java
Patch:
@@ -24,7 +24,7 @@
 
 import java.util.HashMap;
 
-import org.rstudio.core.client.ElementIds;
+import org.rstudio.core.client.ClassIds;
 import org.rstudio.core.client.events.*;
 import org.rstudio.core.client.layout.RequiresVisibilityChanged;
 import org.rstudio.core.client.layout.WindowState;
@@ -61,12 +61,12 @@ public WindowFrame(String name)
       borderPositioner_.add(border_);
 
       maximizeButton_ = new WindowFrameButton(name, WindowState.MAXIMIZE);
-      maximizeButton_.setElementId(ElementIds.FRAME_MAX_BTN + "_" + ElementIds.idSafeString(name));
+      maximizeButton_.setClassId(ClassIds.PANEL_MAX_BTN, name);
       maximizeButton_.setStylePrimaryName(styles.maximize());
       maximizeButton_.setClickHandler(() -> maximize());
 
       minimizeButton_ = new WindowFrameButton(name, WindowState.MINIMIZE);
-      minimizeButton_.setElementId(ElementIds.FRAME_MIN_BTN + "_" + ElementIds.idSafeString(name));
+      minimizeButton_.setClassId(ClassIds.PANEL_MIN_BTN, name);
       minimizeButton_.setStylePrimaryName(styles.minimize());
       minimizeButton_.setClickHandler(() -> minimize());
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/DocumentOutlineWidget.java
Patch:
@@ -16,6 +16,7 @@
 
 import com.google.gwt.aria.client.OrientationValue;
 import com.google.gwt.aria.client.Roles;
+import org.rstudio.core.client.ClassIds;
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Counter;
 import org.rstudio.core.client.HandlerRegistrations;
@@ -221,6 +222,7 @@ public DocumentOutlineWidget(TextEditingTarget target)
       
       container_ = new DockLayoutPanel(Unit.PX);
       container_.addStyleName(RES.styles().container());
+      ClassIds.assignClassId(container_, ClassIds.DOC_OUTLINE_CONTAINER);
       target_ = target;
       
       separator_ = new VerticalSeparator();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextUi.java
Patch:
@@ -127,7 +127,7 @@ public void syncToChunk()
          engine_ = engine;
          toolbar_.setEngine(engine);
       }
-      toolbar_.setId(getLabel(row));
+      toolbar_.setLabelClass(getLabel(row));
    }
 
    public void setRenderPass(int pass)
@@ -241,7 +241,7 @@ private void createToolbar(int row)
    {
       toolbar_ = new ChunkContextToolbar(this, dark_, !isSetup_, engine_);
       toolbar_.setHeight("0px"); 
-      toolbar_.setId(getLabel(row));
+      toolbar_.setLabelClass(getLabel(row));
       lineWidget_ = new PinnedLineWidget(
             ChunkContextToolbar.LINE_WIDGET_TYPE, target_.getDocDisplay(), 
             toolbar_, row, null, host_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkOutputUi.java
Patch:
@@ -121,7 +121,7 @@ public void setChunkLabel(String label)
       {
          label_ = label;
          if (outputWidget_ != null)
-            outputWidget_.setId("output_" + label_);
+            outputWidget_.setLabelClass(label);
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -107,6 +107,7 @@ public void setChunkState(int preambleRow, int state)
    @Inject
    private void initialize(UserPrefs prefs, UserState state)
    {
+      initialized_ = true;
       prefs_ = prefs;
       state_ = state;
       dark_ = state.theme().getValue().getIsDark();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextUi.java
Patch:
@@ -92,6 +92,7 @@ public void syncToChunk()
          engine_ = engine;
          toolbar_.setEngine(engine);
       }
+      toolbar_.setId(chunk_.getLabel());
    }
    
    public void setRenderPass(int pass)
@@ -205,6 +206,7 @@ private void createToolbar(int row)
    {
       toolbar_ = new ChunkContextToolbar(this, dark_, !isSetup_, engine_);
       toolbar_.setHeight("0px"); 
+      toolbar_.setId(chunk_.getLabel());
       lineWidget_ = new PinnedLineWidget(
             ChunkContextToolbar.LINE_WIDGET_TYPE, target_.getDocDisplay(), 
             toolbar_, row, null, host_);

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -137,6 +137,7 @@ public interface ThemeStyles extends CssResource
    
    String showFile();
    String showFileFixed();
+   String showFilePreFixed();
    
    String fileUploadPanel();
    String fileUploadField();

File: src/gwt/src/org/rstudio/core/client/widget/ShowContentDialog.java
Patch:
@@ -44,7 +44,8 @@ public ShowContentDialog(String title, String content, Size preferredSize)
       }
       else
       {
-         content_ = "<pre>" + content + "</pre>";
+         content_ = "<pre class=\"" + ThemeResources.INSTANCE.themeStyles().showFilePreFixed() +
+            "\">" + content + "</pre>";
          styleName_ = ThemeResources.INSTANCE.themeStyles().showFileFixed();
          isFixedFont_ = true;
       }

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -137,6 +137,7 @@ public interface ThemeStyles extends CssResource
    
    String showFile();
    String showFileFixed();
+   String showFilePreFixed();
    
    String fileUploadPanel();
    String fileUploadField();

File: src/gwt/src/org/rstudio/core/client/widget/ShowContentDialog.java
Patch:
@@ -44,7 +44,8 @@ public ShowContentDialog(String title, String content, Size preferredSize)
       }
       else
       {
-         content_ = "<pre>" + content + "</pre>";
+         content_ = "<pre class=\"" + ThemeResources.INSTANCE.themeStyles().showFilePreFixed() +
+            "\">" + content + "</pre>";
          styleName_ = ThemeResources.INSTANCE.themeStyles().showFileFixed();
          isFixedFont_ = true;
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -100,6 +100,7 @@ public void writeUserPrefs()
 
    public void writeUserPrefs(CommandWithArg<Boolean> onCompleted)
    {
+      UpdatePrefs(session_.getSessionInfo().getPrefs());
       server_.setUserPrefs(
          session_.getSessionInfo().getUserPrefs(),
          new ServerRequestCallback<Void>() 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -23,7 +23,9 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 
 import com.google.gwt.core.client.JavaScriptObject;
+import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.core.client.JsArray;
+import org.rstudio.core.client.JsArrayUtil;
 
 
 /**

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java
Patch:
@@ -462,7 +462,7 @@ public boolean shouldCheckSpelling(DocDisplay dd, Range r)
       severe issues with. This is being tracked to be fixed in issue #6041 as
       soon as possible so this can then be removed.
     */
-   private static String[] realtimeDictBlacklist = {"cs_CZ", "de_DE_neu", "lt_LT", "pt_BR", "it_IT"};
+   private static String[] realtimeDictBlacklist = {"cs_CZ", "de_DE_neu", "lt_LT", "lt_LT_new", "pt_BR", "it_IT"};
    public static boolean canRealtimeSpellcheckDict(String dict)
    {
       boolean exists = false;

File: src/gwt/src/org/rstudio/core/client/BrowseCap.java
Patch:
@@ -176,7 +176,7 @@ else if (BrowseCap.isFirefox())
          return "Firefox";
       else if (BrowseCap.isSafari())
          return "Safari";
-      else if (BrowseCap.INSTANCE.isInternetExplorer())
+      else if (BrowseCap.isInternetExplorer())
          return "IE";
       else
          return "Unknown";

File: src/gwt/src/org/rstudio/core/client/dom/IFrameElementEx.java
Patch:
@@ -30,7 +30,7 @@ public final native WindowEx getContentWindow() /*-{
    
    public final void setFocus()
    {
-      if (BrowseCap.INSTANCE.isInternetExplorer())
+      if (BrowseCap.isInternetExplorer())
          getContentWindow().focus();
       else
          focus();

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -1298,7 +1298,7 @@ private String getDataTransferFormat()
    {
       // IE only supports textual data; for other browsers, though, use our own
       // format so it doesn't activate text drag targets in other apps
-      if (BrowseCap.INSTANCE.isInternetExplorer()) 
+      if (BrowseCap.isInternetExplorer()) 
          return "text";
       else
          return "application/rstudio-tab";

File: src/gwt/src/org/rstudio/studio/client/common/presentation/SlideNavigationToolbarMenu.java
Patch:
@@ -146,7 +146,7 @@ public SlidesPopupMenu()
       @Override
       protected int getMaxHeight()
       {
-         if (BrowseCap.INSTANCE.isInternetExplorer())
+         if (BrowseCap.isInternetExplorer())
          {
             return 300;
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -23,9 +23,7 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 
 import com.google.gwt.core.client.JavaScriptObject;
-import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.core.client.JsArray;
-import org.rstudio.core.client.JsArrayUtil;
 
 
 /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -1181,7 +1181,7 @@ public void execute()
    
    private static boolean canActivateSourceWindows()
    {
-      return Desktop.hasDesktopFrame() || BrowseCap.INSTANCE.isInternetExplorer();
+      return Desktop.hasDesktopFrame() || BrowseCap.isInternetExplorer();
    }
    
    private void focusSourceWindow(String windowId)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -6716,10 +6716,8 @@ public void onError(ServerError error)
    private void revertEdits()
    {
       docUpdateSentinel_.revert(() -> {
-         if (visualMode_.isActivated())
-            visualMode_.syncFromEditor(null, false);
+         visualMode_.syncFromEditorIfActivated();
       }, false);
-      
    }
    
    private SourcePosition toSourcePosition(Scope func)

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorContext.java
Patch:
@@ -23,13 +23,11 @@
 @JsType
 public class PanmirrorContext
 {  
-   public PanmirrorContext(String format, PanmirrorUIContext uiContext)
+   public PanmirrorContext(PanmirrorUIContext uiContext)
    {
-      this.format = format;
       ui = new PanmirrorUI(uiContext);
    }
    
-   public String format;
    public PanmirrorUI ui;
    public PanmirrorPandocEngine pandoc = new PanmirrorPandocEngine();
    public PanmirrorHooks hooks = new PanmirrorHooks();

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorEditor.java
Patch:
@@ -20,6 +20,7 @@
 import org.rstudio.core.client.jsinterop.JsVoidFunction;
 import org.rstudio.studio.client.panmirror.command.PanmirrorCommand;
 import org.rstudio.studio.client.panmirror.findreplace.PanmirrorFindReplace;
+import org.rstudio.studio.client.panmirror.format.PanmirrorFormat;
 import org.rstudio.studio.client.panmirror.outline.PanmirrorOutlineItem;
 import org.rstudio.studio.client.panmirror.pandoc.PanmirrorPandocFormat;
 import org.rstudio.studio.client.panmirror.theme.PanmirrorTheme;
@@ -35,8 +36,8 @@ public class PanmirrorEditor
 {
    public native static Promise<PanmirrorEditor> create(Element parent, 
                                                         PanmirrorContext context, 
-                                                        PanmirrorOptions options, 
-                                                        String code);
+                                                        PanmirrorFormat format,
+                                                        PanmirrorOptions options);
    
    public native void destroy();
    

File: src/gwt/src/org/rstudio/studio/client/panmirror/uitools/PanmirrorUITools.java
Patch:
@@ -23,5 +23,6 @@ public class PanmirrorUITools
 {
    public PanmirrorUIToolsAttr attr;
    public PanmirrorUIToolsImage image;
+   public PanmirrorUIToolsFormat format;
 }
 

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorUI.java
Patch:
@@ -18,6 +18,7 @@
 
 import org.rstudio.studio.client.panmirror.dialogs.PanmirrorDialogs;
 
+import elemental2.core.JsObject;
 import jsinterop.annotations.JsType;
 
 @JsType
@@ -31,4 +32,5 @@ public PanmirrorUI(PanmirrorUIContext context)
    public PanmirrorDialogs dialogs = new PanmirrorDialogs();
    public PanmirrorUIDisplay display = new PanmirrorUIDisplay();
    public PanmirrorUIContext context;
+   public JsObject images;
 }

File: src/gwt/src/org/rstudio/core/client/BrowseCap.java
Patch:
@@ -68,7 +68,7 @@ public boolean canCopyToClipboard()
       return (Desktop.hasDesktopFrame()) || !isSafari();
    }
    
-   public boolean isInternetExplorer()
+   public static boolean isInternetExplorer()
    {
       return isUserAgent("trident");
    }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -29,7 +29,6 @@
 import org.rstudio.core.client.command.ShortcutViewer;
 import org.rstudio.core.client.command.UserCommandManager;
 import org.rstudio.core.client.dom.BrowserEventWorkarounds;
-import org.rstudio.core.client.polyfill.FastestSmallestTextEncoderDecoder;
 import org.rstudio.core.client.HtmlMessageListener;
 import org.rstudio.studio.client.application.ApplicationInterrupt;
 import org.rstudio.studio.client.application.ApplicationQuit;
@@ -326,7 +325,6 @@ protected void configure()
       bind(JobManager.class).asEagerSingleton();
       bind(HtmlMessageListener.class).asEagerSingleton();
       bind(BrowserEventWorkarounds.class).asEagerSingleton();
-      bind(FastestSmallestTextEncoderDecoder.class).asEagerSingleton();
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;

File: src/gwt/src/org/rstudio/core/client/BrowseCap.java
Patch:
@@ -63,7 +63,7 @@ public boolean canCopyToClipboard()
       return (Desktop.hasDesktopFrame()) || !isSafari();
    }
    
-   public boolean isInternetExplorer()
+   public static boolean isInternetExplorer()
    {
       return isUserAgent("trident");
    }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -29,7 +29,6 @@
 import org.rstudio.core.client.command.ShortcutViewer;
 import org.rstudio.core.client.command.UserCommandManager;
 import org.rstudio.core.client.dom.BrowserEventWorkarounds;
-import org.rstudio.core.client.polyfill.FastestSmallestTextEncoderDecoder;
 import org.rstudio.core.client.HtmlMessageListener;
 import org.rstudio.studio.client.application.ApplicationInterrupt;
 import org.rstudio.studio.client.application.ApplicationQuit;
@@ -327,7 +326,6 @@ protected void configure()
       bind(JobManager.class).asEagerSingleton();
       bind(HtmlMessageListener.class).asEagerSingleton();
       bind(BrowserEventWorkarounds.class).asEagerSingleton();
-      bind(FastestSmallestTextEncoderDecoder.class).asEagerSingleton();
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class);

File: src/gwt/src/org/rstudio/core/client/BrowseCap.java
Patch:
@@ -63,7 +63,7 @@ public boolean canCopyToClipboard()
       return (Desktop.hasDesktopFrame()) || !isSafari();
    }
    
-   public boolean isInternetExplorer()
+   public static boolean isInternetExplorer()
    {
       return isUserAgent("trident");
    }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -29,7 +29,6 @@
 import org.rstudio.core.client.command.ShortcutViewer;
 import org.rstudio.core.client.command.UserCommandManager;
 import org.rstudio.core.client.dom.BrowserEventWorkarounds;
-import org.rstudio.core.client.polyfill.FastestSmallestTextEncoderDecoder;
 import org.rstudio.core.client.HtmlMessageListener;
 import org.rstudio.studio.client.application.ApplicationInterrupt;
 import org.rstudio.studio.client.application.ApplicationQuit;
@@ -327,7 +326,6 @@ protected void configure()
       bind(JobManager.class).asEagerSingleton();
       bind(HtmlMessageListener.class).asEagerSingleton();
       bind(BrowserEventWorkarounds.class).asEagerSingleton();
-      bind(FastestSmallestTextEncoderDecoder.class).asEagerSingleton();
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class);

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -255,6 +255,7 @@
    public abstract AppCommand layoutZoomFiles();
    public abstract AppCommand goToWorkingDir();
    public abstract AppCommand setAsWorkingDir();
+   public abstract AppCommand copyFilesPaneCurrentDirectory();
    public abstract AppCommand setWorkingDirToFilesPane();
    public abstract AppCommand showFolder();
  

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesTab.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FilesTab.java
  *
- * Copyright (C) 2009-12 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -41,6 +41,8 @@ public abstract static class Shim
       public abstract void onSetWorkingDirToFilesPane();
       @Handler
       public abstract void onGoToWorkingDir();
+      @Handler
+      public abstract void onCopyFilesPaneCurrentDirectory();
    }
 
    @Inject

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FileCommandToolbar.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FileCommandToolbar.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -49,6 +49,7 @@ public FileCommandToolbar(Commands commands, UserPrefs prefs)
       moreMenu.addItem(commands.copyFile().createMenuItem(false));
       moreMenu.addItem(commands.copyFileTo().createMenuItem(false));
       moreMenu.addItem(commands.moveFiles().createMenuItem(false));
+      moreMenu.addItem(commands.copyFilesPaneCurrentDirectory().createMenuItem(false));
       moreMenu.addSeparator();
       moreMenu.addItem(commands.exportFiles().createMenuItem(false));
       moreMenu.addSeparator();
@@ -58,8 +59,7 @@ public FileCommandToolbar(Commands commands, UserPrefs prefs)
       moreMenu.addSeparator();
       moreMenu.addItem(commands.showFolder().createMenuItem(false));
       moreMenu.addSeparator();
-      moreMenu.addItem(new UserPrefMenuItem<Boolean>(
-            prefs.showHiddenFiles(), true, "Show Hidden Files", prefs));
+      moreMenu.addItem(new UserPrefMenuItem<>(prefs.showHiddenFiles(), true, "Show Hidden Files", prefs));
 
       ToolbarMenuButton moreButton = new ToolbarMenuButton(
             "More",

File: src/gwt/src/org/rstudio/core/client/cellview/LinkColumn.java
Patch:
@@ -91,7 +91,7 @@ public void onBrowserEvent(Context context, Element parent,
                     onClicked.execute(dataProvider.getList().get(idx));
               }
            }
-         }            
+         }
       });
    }
    
@@ -107,7 +107,7 @@ interface Resources extends ClientBundle
       Styles styles();
    }
    
-   static Resources RESOURCES = (Resources)GWT.create(Resources.class) ;
+   static Resources RESOURCES = (Resources)GWT.create(Resources.class);
    public static void ensureStylesInjected()
    {
       RESOURCES.styles().ensureInjected();

File: src/gwt/src/org/rstudio/core/client/dom/ElementEx.java
Patch:
@@ -23,11 +23,11 @@ protected ElementEx()
    }
    
    public final native boolean getContentEditable() /*-{
-      return !!this.contentEditable ;
+      return !!this.contentEditable;
    }-*/;
 
    public final native void normalize() /*-{
-      this.normalize() ;
+      this.normalize();
    }-*/;
 
    public final native String getOuterHtml() /*-{

File: src/gwt/src/org/rstudio/core/client/dom/IFrameElementEx.java
Patch:
@@ -25,7 +25,7 @@ protected IFrameElementEx()
    }
    
    public final native WindowEx getContentWindow() /*-{
-      return this.contentWindow ;
+      return this.contentWindow;
    }-*/;
    
    public final void setFocus()

File: src/gwt/src/org/rstudio/core/client/events/HasSelectionCommitHandlers.java
Patch:
@@ -19,6 +19,5 @@
 
 public interface HasSelectionCommitHandlers<I> extends HasHandlers
 {
-   HandlerRegistration addSelectionCommitHandler(
-                                    SelectionCommitHandler<I> handler) ;
+   HandlerRegistration addSelectionCommitHandler(SelectionCommitHandler<I> handler);
 }

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcRequestCallback.java
Patch:
@@ -17,6 +17,6 @@
 
 public interface RpcRequestCallback 
 {
-   void onError(RpcRequest request, RpcError error) ;
+   void onError(RpcRequest request, RpcError error);
    void onResponseReceived(RpcRequest request, RpcResponse response);
 }

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcResponse.java
Patch:
@@ -56,8 +56,8 @@ public final static RpcResponse parse(String json)
     
    public final native static RpcResponse create(RpcError error) /*-{
       var response = new Object();
-      response.error = error ;
-      return response ;
+      response.error = error;
+      return response;
    }-*/;
    
    public final RpcError getError()

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogBaseResources.java
Patch:
@@ -65,5 +65,5 @@ public interface Styles extends CssResource
    @Source("iconPublishing_2x.png")
    ImageResource iconPublishing2x();
    
-   static PreferencesDialogBaseResources INSTANCE = (PreferencesDialogBaseResources)GWT.create(PreferencesDialogBaseResources.class) ;
+   static PreferencesDialogBaseResources INSTANCE = (PreferencesDialogBaseResources)GWT.create(PreferencesDialogBaseResources.class);
 }

File: src/gwt/src/org/rstudio/core/client/theme/WindowFrameButton.java
Patch:
@@ -157,6 +157,6 @@ private String stateString(WindowState state)
    private boolean maximized_;
    private boolean exclusive_;
 
-   private Command clickHandler_ ;
+   private Command clickHandler_;
    private final HandlerRegistrations releaseOnUnload_ = new HandlerRegistrations();
 }

File: src/gwt/src/org/rstudio/core/client/widget/FindTextBox.java
Patch:
@@ -64,12 +64,12 @@ public HandlerRegistration addValueChangeHandler(
    
    public String getValue()
    {
-      return textBox_.getText() ;
+      return textBox_.getText();
    }
 
    public void setValue(String text)
    {
-      textBox_.setText(text) ;
+      textBox_.setText(text);
    }
 
    public void setValue(String text, boolean fireEvents)

File: src/gwt/src/org/rstudio/core/client/widget/HyperlinkLabel.java
Patch:
@@ -146,7 +146,7 @@ private void click()
    }
 
    private final MouseHandlers mouseHandlers_ = new MouseHandlers();
-   private Command clickHandler_ ;
+   private Command clickHandler_;
    private final HandlerRegistrations releaseOnUnload_ = new HandlerRegistrations();
 
    private boolean alwaysUnderline_ = false;

File: src/gwt/src/org/rstudio/core/client/widget/MessageDialog.java
Patch:
@@ -154,7 +154,7 @@ protected void focusInitialControl()
       focusOkButton();
    }
 
-   private int type_ ;
-   private Widget messageWidget_ ;
-   private ProgressIndicator progress_ ;
+   private int type_;
+   private Widget messageWidget_;
+   private ProgressIndicator progress_;
 }

File: src/gwt/src/org/rstudio/core/client/widget/MiniDialogPopupPanel.java
Patch:
@@ -116,6 +116,6 @@ protected void restorePreviouslyFocusedElement()
    }
    
    private VerticalPanel verticalPanel_;
-   private Label captionLabel_ ;
+   private Label captionLabel_;
    private FocusContext focusContext_ = new FocusContext();
 }

File: src/gwt/src/org/rstudio/core/client/widget/ProgressPanel.java
Patch:
@@ -128,7 +128,7 @@ private int getSpinnerColor()
       return isDark ? ProgressSpinner.COLOR_WHITE : ProgressSpinner.COLOR_BLACK;
    }
 
-   private final Widget progressImage_ ;
+   private final Widget progressImage_;
    private final ProgressSpinner progressSpinner_;
    private final Label progressLabel_;
    private Timer timer_;

File: src/gwt/src/org/rstudio/core/client/widget/ShowContentDialog.java
Patch:
@@ -78,7 +78,7 @@ protected Widget createMainWidget()
      scrollPanel.setWidget(htmlContent);
       
      // if we don't have a preferred size then size based on content
-     Size size = preferredSize_ ;
+     Size size = preferredSize_;
      if (size.isEmpty())
         size = DomMetrics.measureHTML(content_, styleName_);
                                             

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -145,7 +145,7 @@ protected boolean validate(String input)
          }
       }
 
-      return true ;
+      return true;
    }
 
    public boolean getExtraOption()

File: src/gwt/src/org/rstudio/core/client/widget/images/ProgressImages.java
Patch:
@@ -21,7 +21,7 @@ public class ProgressImages
 {
    public static Image createSmall()
    {
-      return new Image(CoreResources.INSTANCE.progress()) ;
+      return new Image(CoreResources.INSTANCE.progress());
    }
    
    public static Image createSmallGray()

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationClientInit.java
Patch:
@@ -185,7 +185,7 @@ public void onError(ServerError error)
 
    private final ApplicationServerOperations server_;
    @SuppressWarnings("unused")
-   private final GlobalDisplay globalDisplay_ ;
+   private final GlobalDisplay globalDisplay_;
    private Timer timeoutTimer_ = null;
    private boolean timedOut_ = false;
    private ServerRequestCallback<SessionInfo> rpcRequestCallback_;

File: src/gwt/src/org/rstudio/studio/client/application/model/ApplicationServerOperations.java
Patch:
@@ -47,7 +47,7 @@ void acceptAgreement(Agreement agreement,
    
    // suspend the current session
    void suspendSession(boolean force,
-                       ServerRequestCallback<Void> requestCallback) ;
+                       ServerRequestCallback<Void> requestCallback);
 
    // handle unsaved changes completed
    void handleUnsavedChangesCompleted(

File: src/gwt/src/org/rstudio/studio/client/application/ui/ApplicationAgreementDialog.java
Patch:
@@ -34,7 +34,7 @@ public ApplicationAgreementDialog(String title,
             new Size(800, 1000));
       
       doNotAcceptOperation_ = doNotAcceptOperation;
-      acceptOperation_ = acceptOperation ;
+      acceptOperation_ = acceptOperation;
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/application/ui/ApplicationWindow.java
Patch:
@@ -129,7 +129,7 @@ public void showApplicationAgreement(String title,
    
    public Widget getWidget()
    {
-      return this ;
+      return this;
    }
    
    @Override
@@ -344,8 +344,8 @@ public void onResize()
    }
    
    // main application UI components
-   private LayoutPanel applicationPanel_ ;
-   private ApplicationHeader applicationHeader_ ;
+   private LayoutPanel applicationPanel_;
+   private ApplicationHeader applicationHeader_;
 
    // active serialization progress message
    private ApplicationSerializationProgress activeSerializationProgress_;

File: src/gwt/src/org/rstudio/studio/client/application/ui/appended/ApplicationEndedPopupPanel.java
Patch:
@@ -115,8 +115,8 @@ public void onSuccess()
       });
    }
 
-   private static final int PREFETCH = 0 ;
-   private static final int QUIT = 1 ;
+   private static final int PREFETCH = 0;
+   private static final int QUIT = 1;
    private static final int SUICIDE = 2;
    private static final int DISCONNECTED = 3;
    private static final int OFFLINE = 4;

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -86,8 +86,8 @@ private int getPositionAtOffset(int offset)
       return Math.max(0, Math.min(pos, history_.size()));
    }
 
-   private final ArrayList<String> history_ = new ArrayList<String>() ;
-   private int historyPos_ ;
+   private final ArrayList<String> history_ = new ArrayList<String>();
+   private int historyPos_;
    // If you start typing a command, then go up in history, then go down,
    // then what you had previously typed should still be there. This is
    // that value--it is loaded/saved whenever history navigation takes you

File: src/gwt/src/org/rstudio/studio/client/common/DefaultGlobalDisplay.java
Patch:
@@ -414,8 +414,8 @@ public void openRStudioLink(String linkName, boolean includeVersionInfo)
    {
       // build url
       final SessionInfo sessionInfo = session_.getSessionInfo();
-      String url = "https://www.rstudio.org/links/" ;
-      url += URL.encodePathSegment(linkName) ;
+      String url = "https://www.rstudio.org/links/";
+      url += URL.encodePathSegment(linkName);
       if (includeVersionInfo)
       {
          url += "?version=" + URL.encodeQueryString(sessionInfo.getRstudioVersion());

File: src/gwt/src/org/rstudio/studio/client/common/SuperDevMode.java
Patch:
@@ -26,7 +26,7 @@ public final static native void reload() /*-{
       var s = $doc.createElement('script'); 
       s.src = 'http://localhost:9876/dev_mode_on.js'; 
       void($doc.getElementsByTagName('head')[0].appendChild(s));
-   }-*/ ;
+   }-*/;
    
    
    public static final native boolean isActive()

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/ChooseMirrorDialog.java
Patch:
@@ -257,13 +257,13 @@ static interface Resources extends ClientBundle
       Styles styles();
    }
    
-   static Resources RESOURCES = (Resources)GWT.create(Resources.class) ;
+   static Resources RESOURCES = (Resources)GWT.create(Resources.class);
    public static void ensureStylesInjected()
    {
       RESOURCES.styles().ensureInjected();
    }
    
-   private final GlobalDisplay globalDisplay_ ;
+   private final GlobalDisplay globalDisplay_;
    private final Source mirrorSource_;
    private ArrayList<CRANMirror> mirrors_ = null;
    private ListBox listBox_ = null;

File: src/gwt/src/org/rstudio/studio/client/common/presentation/SlideNavigationToolbarMenu.java
Patch:
@@ -166,5 +166,5 @@ protected int getMaxHeight()
    private SlidesPopupMenu slidesMenu_ = new SlidesPopupMenu();
    private Widget menuWidget_;
    private Widget separatorWidget_ = null;
-   private final int heightOffset_ ;
+   private final int heightOffset_;
 }

File: src/gwt/src/org/rstudio/studio/client/common/repos/SecondaryReposWidget.java
Patch:
@@ -232,7 +232,7 @@ static interface Resources extends ClientBundle
       Styles styles();
    }
    
-   static Resources RES = (Resources)GWT.create(Resources.class) ;
+   static Resources RES = (Resources)GWT.create(Resources.class);
    public static void ensureStylesInjected()
    {
       RES.styles().ensureInjected();

File: src/gwt/src/org/rstudio/studio/client/common/rpubs/ui/RPubsUploadDialog.java
Patch:
@@ -266,7 +266,7 @@ interface Resources extends ClientBundle
 
    private final boolean isPublished_;
 
-   static Resources RESOURCES = GWT.create(Resources.class) ;
+   static Resources RESOURCES = GWT.create(Resources.class);
    public static void ensureStylesInjected()
    {
       RESOURCES.styles().ensureInjected();

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteApplicationView.java
Patch:
@@ -19,7 +19,7 @@
 
 public interface SatelliteApplicationView
 {
-   Widget getWidget() ;
+   Widget getWidget();
    
    void show(JavaScriptObject params);
    void reactivate(JavaScriptObject params);

File: src/gwt/src/org/rstudio/studio/client/common/shiny/model/ShinyCapabilities.java
Patch:
@@ -24,7 +24,7 @@ protected ShinyCapabilities()
    
    public static final native ShinyCapabilities createDefault()  /*-{
       var caps = new Object();
-      caps.installed = false ;
+      caps.installed = false;
       return caps;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerListResources.java
Patch:
@@ -61,6 +61,6 @@ public static interface Styles extends CssResource
    ImageResource logContextButton2x();
     
    public static SourceMarkerListResources INSTANCE = 
-      (SourceMarkerListResources)GWT.create(SourceMarkerListResources.class) ;
+      (SourceMarkerListResources)GWT.create(SourceMarkerListResources.class);
   
 }

File: src/gwt/src/org/rstudio/studio/client/common/vcs/CreateKeyDialog.java
Patch:
@@ -284,7 +284,7 @@ static interface Resources extends ClientBundle
       Styles styles();
    }
    
-   static Resources RESOURCES = (Resources)GWT.create(Resources.class) ;
+   static Resources RESOURCES = (Resources)GWT.create(Resources.class);
    public static void ensureStylesInjected()
    {
       RESOURCES.styles().ensureInjected();

File: src/gwt/src/org/rstudio/studio/client/common/vcs/SshKeyWidget.java
Patch:
@@ -181,7 +181,7 @@ static interface Resources extends ClientBundle
       Styles styles();
    }
    
-   static Resources RES = (Resources)GWT.create(Resources.class) ;
+   static Resources RES = (Resources)GWT.create(Resources.class);
    public static void ensureStylesInjected()
    {
       RES.styles().ensureInjected();

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -189,15 +189,15 @@ static interface Resources extends ClientBundle
       Styles styles();
    }
    
-   static Resources RES = (Resources)GWT.create(Resources.class) ;
+   static Resources RES = (Resources)GWT.create(Resources.class);
    public static void ensureStylesInjected()
    {
       RES.styles().ensureInjected();
    }
 
    private final DirectoryChooserTextBox dirChooser_;
    private final CaptionWithHelp ignoresCaption_;
-   private final AceEditor editor_ ;
+   private final AceEditor editor_;
    private final ThemedButton saveButton_;
    private final ProgressIndicator progressIndicator_;
   

File: src/gwt/src/org/rstudio/studio/client/packrat/ui/PackratResolveConflictDialog.java
Patch:
@@ -210,7 +210,7 @@ static interface Resources extends ClientBundle
       Styles styles();
    }
    
-   static Resources RESOURCES = (Resources)GWT.create(Resources.class) ;
+   static Resources RESOURCES = (Resources)GWT.create(Resources.class);
    public static void ensureStylesInjected()
    {
       RESOURCES.styles().ensureInjected();

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorResources.java
Patch:
@@ -29,7 +29,7 @@ public interface Styles extends CssResource
    @Source("PanmirrorStyles.css")
    Styles styles();
    
-   public static PanmirrorResources INSTANCE = (PanmirrorResources)GWT.create(PanmirrorResources.class) ;
+   public static PanmirrorResources INSTANCE = (PanmirrorResources)GWT.create(PanmirrorResources.class);
    
 
    public static void ensureStylesInjected()

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarResources.java
Patch:
@@ -84,5 +84,5 @@ interface Styles extends CssResource
    ImageResource table();
    
    public static PanmirrorToolbarResources INSTANCE = 
-      (PanmirrorToolbarResources)GWT.create(PanmirrorToolbarResources.class) ;
+      (PanmirrorToolbarResources)GWT.create(PanmirrorToolbarResources.class);
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorDialogsResources.java
Patch:
@@ -52,7 +52,7 @@ public interface Styles extends CssResource
    @Source("edit_link_2x.png")
    ImageResource edit_link();
    
-   public static PanmirrorDialogsResources INSTANCE = (PanmirrorDialogsResources)GWT.create(PanmirrorDialogsResources.class) ;
+   public static PanmirrorDialogsResources INSTANCE = (PanmirrorDialogsResources)GWT.create(PanmirrorDialogsResources.class);
    
 
    public static void ensureStylesInjected()

File: src/gwt/src/org/rstudio/studio/client/server/VoidServerRequestCallback.java
Patch:
@@ -26,7 +26,7 @@ public VoidServerRequestCallback()
    
    public VoidServerRequestCallback(ProgressIndicator progress)
    {
-      progress_ = progress ;
+      progress_ = progress;
    }
    
    public void onResponseReceived(Void response)
@@ -67,5 +67,5 @@ protected void onCompleted()
       
    }
    
-   private ProgressIndicator progress_ ;
+   private ProgressIndicator progress_;
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -20,12 +20,12 @@ class ClientEvent extends JavaScriptObject
 {   
    public static final String Busy = "busy";
    public static final String ConsolePrompt = "console_prompt";
-   public static final String ConsoleOutput = "console_output" ;
+   public static final String ConsoleOutput = "console_output";
    public static final String ConsoleError = "console_error";
    public static final String ConsoleWritePrompt = "console_write_prompt";
    public static final String ConsoleWriteInput = "console_write_input";
    public static final String ShowErrorMessage = "show_error_message";
-   public static final String ShowHelp = "show_help" ;
+   public static final String ShowHelp = "show_help";
    public static final String BrowseUrl = "browse_url";
    public static final String ShowEditor = "show_editor";
    public static final String ChooseFile = "choose_file";

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerAuth.java
Patch:
@@ -248,9 +248,9 @@ public void execute()
    
    private String createRequestData()
    {
-      JSONObject request = new JSONObject() ;
+      JSONObject request = new JSONObject();
       request.put("method", new JSONString("update_credentials"));
-      request.put("params", new JSONArray());     
+      request.put("params", new JSONArray());
       return request.toString();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -191,7 +191,7 @@ protected void performAction(boolean shouldSchedulePassive)
 
    public WorkbenchMainView getMainView()
    {
-      return view_ ;
+      return view_;
    }
 
    public void onWorkbenchLoaded(WorkbenchLoadedEvent event)

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchOracle.java
Patch:
@@ -440,7 +440,7 @@ private ArrayList<CodeSearchSuggestion> processSuggestions(
    
    private final Invalidation searchInvalidation_ = new Invalidation();
    
-   private final CodeSearchServerOperations server_ ;
+   private final CodeSearchServerOperations server_;
    private final WorkbenchContext workbenchContext_;
    private final CodeSearchCommand codeSearch_ = new CodeSearchCommand();
    

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchSuggestion.java
Patch:
@@ -138,7 +138,7 @@ public void setFileDisplayString(String file, String displayString)
    @Override
    public String getReplacementString()
    {
-      return "" ;
+      return "";
    }
    
    public CodeNavigationTarget getNavigationTarget()
@@ -159,7 +159,7 @@ private String createDisplayString(ImageResource image,
    {    
       SafeHtmlBuilder sb = new SafeHtmlBuilder();
       SafeHtmlUtil.appendImage(sb, imageStyle, image);
-      SafeHtmlUtil.appendSpan(sb, RES.styles().itemName(), name);    
+      SafeHtmlUtil.appendSpan(sb, RES.styles().itemName(), name);
       
       // check for extra info
       if (!StringUtil.isNullOrEmpty(extraInfo))
@@ -181,7 +181,7 @@ private String createDisplayString(ImageResource image,
    
    
    private final boolean isFileTarget_;
-   private final CodeNavigationTarget navigationTarget_ ;
+   private final CodeNavigationTarget navigationTarget_;
    private final String matchedString_;
    private String displayString_;
    private static final FileTypeRegistry fileTypeRegistry_ =

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/ui/CodeSearchResources.java
Patch:
@@ -41,5 +41,5 @@ public static interface Styles extends CssResource
    ImageResource gotoFunction2x();
    
    public static CodeSearchResources INSTANCE = 
-      (CodeSearchResources)GWT.create(CodeSearchResources.class) ;
+      (CodeSearchResources)GWT.create(CodeSearchResources.class);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/events/WorkbenchMetricsChangedEvent.java
Patch:
@@ -25,12 +25,12 @@ public class WorkbenchMetricsChangedEvent extends
    
    public WorkbenchMetricsChangedEvent(WorkbenchMetrics clientMetrics)
    {
-      clientMetrics_ = clientMetrics ;
+      clientMetrics_ = clientMetrics;
    }
    
    public WorkbenchMetrics getWorkbenchMetrics()
    {
-      return clientMetrics_ ;
+      return clientMetrics_;
    }
    
    @Override
@@ -45,5 +45,5 @@ public GwtEvent.Type<WorkbenchMetricsChangedHandler> getAssociatedType()
       return TYPE;
    }
    
-   private final WorkbenchMetrics clientMetrics_ ;
+   private final WorkbenchMetrics clientMetrics_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotResources.java
Patch:
@@ -67,6 +67,6 @@ public static interface Styles extends CssResource
    ImageResource rightMouse2x();
    
    public static ExportPlotResources INSTANCE = 
-      (ExportPlotResources)GWT.create(ExportPlotResources.class) ;
+      (ExportPlotResources)GWT.create(ExportPlotResources.class);
   
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotSizeEditor.java
Patch:
@@ -105,7 +105,7 @@ public ExportPlotSizeEditor(int initialWidth,
       }
       else
       {
-         optionsPanel = topPanel ;
+         optionsPanel = topPanel;
          optionsPanel.setStylePrimaryName(
                                  resources.styles().horizontalSizeOptions());
          widthAndHeightPanel = topPanel;
@@ -507,7 +507,7 @@ private void configureHorizontalOptionsPanel(HorizontalPanel panel)
    private final Focusable initialFocusWidget_;
      
    private int lastWidth_;
-   private int lastHeight_ ;
+   private int lastHeight_;
   
    private boolean settingDimenensionInProgress_ = false;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchPane.java
Patch:
@@ -43,7 +43,7 @@ public void prefetch(Command continuation)
 
    public String getTitle()
    {
-      return title_ ;
+      return title_;
    }
 
    // hook for subclasses to be notified right before & after they are selected

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchScreen.java
Patch:
@@ -425,6 +425,6 @@ public Widget asWidget()
    private final Shim edit_;
    private final org.rstudio.studio.client.workbench.ui.OptionsLoader.Shim optionsLoader_;
 
-   private final MainSplitPanel tabsPanel_ ;
+   private final MainSplitPanel tabsPanel_;
    private PaneManager paneManager_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -503,7 +503,7 @@ public void onResponseReceived(String loadAllPath)
    private final UserPrefs userPrefs_;
    private final BuildServerOperations server_;
    private FilesServerOperations fileServer_;
-   private final Display view_ ; 
+   private final Display view_;
    private final EventBus eventBus_;
    private final Session session_;
    private final DependencyManager dependencyManager_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/ui/BuildPaneResources.java
Patch:
@@ -35,6 +35,6 @@ public static interface Styles extends CssResource
    ImageResource iconBuild2x();
    
    public static BuildPaneResources INSTANCE = 
-      (BuildPaneResources)GWT.create(BuildPaneResources.class) ;
+      (BuildPaneResources)GWT.create(BuildPaneResources.class);
   
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsPresenter.java
Patch:
@@ -600,12 +600,12 @@ public boolean test(Connection connection)
    
    private final GlobalDisplay globalDisplay_;
    
-   private final Display display_ ;
+   private final Display display_;
    private final EventBus eventBus_;
    private final Commands commands_;
    private UserState state_;
    private UserPrefs userPrefs_;
-   private final ConnectionsServerOperations server_ ;
+   private final ConnectionsServerOperations server_;
    @SuppressWarnings("unused") private final ApplicationInterrupt applicationInterrupt_;
    
    // client state

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/Console.java
Patch:
@@ -167,7 +167,7 @@ public void onLayoutZoomConsole()
 
    public Display getDisplay()
    {
-      return view_ ;
+      return view_;
    }
 
    private final DelayFadeInHelper interruptFadeInHelper_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -313,7 +313,7 @@ private void initJobToolbar()
          showProgress(lastProgress_);
    }
 
-   private Provider<Shell> consoleProvider_ ;
+   private Provider<Shell> consoleProvider_;
    private Provider<JobProgressPresenter> progressProvider_;
    JobProgressPresenter progress_;
    LocalJobProgress lastProgress_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/KeyDownPreviewHandler.java
Patch:
@@ -18,5 +18,5 @@
 
 public interface KeyDownPreviewHandler
 {
-   boolean previewKeyDown(NativeEvent event) ;
+   boolean previewKeyDown(NativeEvent event);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/KeyPressPreviewHandler.java
Patch:
@@ -16,5 +16,5 @@
 
 public interface KeyPressPreviewHandler
 {
-   boolean previewKeyPress(char charCode) ;
+   boolean previewKeyPress(char charCode);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionListPopupPanel.java
Patch:
@@ -39,7 +39,7 @@ public HandlerRegistration addSelectionCommitHandler(
    public TItem getSelectedValue()
    {
       if (list_ == null || !list_.isAttached())
-         return null ;
+         return null;
 
       return list_.getSelectedItem();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManager.java
Patch:
@@ -24,7 +24,7 @@ public interface CompletionManager extends KeyDownPreviewHandler,
 {
    interface InitCompletionFilter
    {
-      boolean shouldComplete(NativeEvent keyDownEvent) ;
+      boolean shouldComplete(NativeEvent keyDownEvent);
    }
    
    void goToHelp();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HelpInfoPopupPanelResources.java
Patch:
@@ -33,7 +33,7 @@ public static interface Styles extends CssResource
    Styles styles();
   
    public static HelpInfoPopupPanelResources INSTANCE = 
-      (HelpInfoPopupPanelResources)GWT.create(HelpInfoPopupPanelResources.class) ;
+      (HelpInfoPopupPanelResources)GWT.create(HelpInfoPopupPanelResources.class);
    
   
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/editor/InputEditorSelection.java
Patch:
@@ -43,7 +43,7 @@ public InputEditorPosition getEnd()
    public int compareTo(InputEditorSelection o)
    {
       if (o == null)
-         return 1 ;
+         return 1;
 
       int result = getStart().compareTo(o.getStart());
       if (result == 0)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/edit/Edit.java
Patch:
@@ -44,7 +44,7 @@ void show(String text,
    public Edit(Display view,
                EditServerOperations server)
    {
-      view_ = view ;
+      view_ = view;
       server_ = server;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/edit/ui/EditDialog.java
Patch:
@@ -128,9 +128,9 @@ protected void focusInitialControl()
       editor_.focus();
    }
 
-   private final String sourceText_ ;
+   private final String sourceText_;
    private final boolean isRCode_;
    private final boolean lineWrapping_;
-   private final AceEditor editor_ ;
+   private final AceEditor editor_;
    private Size minimumSize_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/ClearAllDialog.java
Patch:
@@ -128,7 +128,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
       return panel;
    }
    
-   private ProgressIndicator progress_ ;
+   private ProgressIndicator progress_;
    private CheckBox chkIncludeHidden_;
    private UserState state_;
    private int numObjects_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/EnvironmentObjectAssignedEvent.java
Patch:
@@ -33,7 +33,7 @@ public interface Handler extends EventHandler
    
    public EnvironmentObjectAssignedEvent(RObject objectInfo)
    {
-      objectInfo_ = objectInfo ;
+      objectInfo_ = objectInfo;
    }
    
    public RObject getObjectInfo()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesDisplayObserver.java
Patch:
@@ -19,9 +19,9 @@
 public interface PackagesDisplayObserver
 {
    void updatePackageState(boolean showProgress, boolean manualUpdate);
-   void loadPackage(PackageInfo info) ;
-   void unloadPackage(PackageInfo info) ;
-   void showHelp(PackageInfo packageInfo) ;
+   void loadPackage(PackageInfo info);
+   void unloadPackage(PackageInfo info);
+   void showHelp(PackageInfo packageInfo);
    void removePackage(PackageInfo packageInfo);
    void onPackageFilterChanged(String filter);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/events/PackageStatusChangedEvent.java
Patch:
@@ -25,7 +25,7 @@ public class PackageStatusChangedEvent
    
    public PackageStatusChangedEvent(PackageStatus packageStatus)
    {
-      packageStatus_ = packageStatus ;
+      packageStatus_ = packageStatus;
    }
    
    public PackageStatus getPackageStatus()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/model/PackageInstallOptions.java
Patch:
@@ -29,9 +29,9 @@ public static final native PackageInstallOptions create(
                                           boolean installDependencies) /*-{
       var options = new Object();
       options.installFromRepository = installFromRepository;
-      options.libraryPath = libraryPath ;
-      options.installDependencies = installDependencies ;
-      return options ;
+      options.libraryPath = libraryPath;
+      options.installDependencies = installDependencies;
+      return options;
    }-*/;
 
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/model/PackageStatus.java
Patch:
@@ -30,10 +30,10 @@ public static final native PackageStatus create(String name,
                                                    String lib,
                                                    boolean loaded) /*-{
       var status = new Object();
-      status.name = name ;
-      status.lib = lib ;
+      status.name = name;
+      status.lib = lib;
       status.loaded = loaded;
-      return status ;
+      return status;
    }-*/;
    
    public final native String getName() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/InstallPackageDialog.java
Patch:
@@ -381,7 +381,7 @@ static interface Resources extends ClientBundle
       Styles styles();
    }
    
-   static Resources RESOURCES = (Resources)GWT.create(Resources.class) ;
+   static Resources RESOURCES = (Resources)GWT.create(Resources.class);
    public static void ensureStylesInjected()
    {
       RESOURCES.styles().ensureInjected();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/PackagesCellTableResources.java
Patch:
@@ -22,7 +22,7 @@
 public interface PackagesCellTableResources extends CellTable.Resources 
 {
    static PackagesCellTableResources INSTANCE = 
-      (PackagesCellTableResources)GWT.create(PackagesCellTableResources.class) ;
+      (PackagesCellTableResources)GWT.create(PackagesCellTableResources.class);
 
    interface PackagesCellTableStyle extends CellTable.Style
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/LocatorPanel.java
Patch:
@@ -84,7 +84,7 @@ public void onClick(ClickEvent event)
    public void showLocator(Plots.Parent parent)
    {
       // set parent 
-      parent_ = parent ;
+      parent_ = parent;
       
       // add to parent
       parent_.add(this);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/Plots.java
Patch:
@@ -575,7 +575,7 @@ private Size getPlotSize()
       // rather than size of our current plot frame
       
       if (plotSize_ != null) // first try to use the last size reported
-         return plotSize_ ;
+         return plotSize_;
       else                   // then fallback to frame size
          return view_.getPlotFrameSize();
    }
@@ -618,7 +618,7 @@ public void onError(ServerError error)
    private Size zoomWindowDefaultSize_;
    
    // export plot impl
-   private final ExportPlot exportPlot_ ;
+   private final ExportPlot exportPlot_;
    
    // size of most recently rendered plot
    Size plotSize_ = null;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/model/Point.java
Patch:
@@ -24,9 +24,9 @@ protected Point()
    
    public static final native Point create(double x, double y) /*-{
       var point = new Object();
-      point.x = x ;
-      point.y = y ;
-      return point ;
+      point.x = x;
+      point.y = y;
+      return point;
    }-*/;
    
    // size

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/model/SavePlotAsPdfOptions.java
Patch:
@@ -39,12 +39,12 @@ public static final native SavePlotAsPdfOptions create(
                                                   boolean cairoPdf,
                                                   boolean viewAfterSave) /*-{
       var options = new Object();
-      options.width = width ;
-      options.height = height ;
+      options.width = width;
+      options.height = height;
       options.portrait = portrait;
       options.cairo_pdf = cairoPdf;
       options.viewAfterSave = viewAfterSave;
-      return options ;
+      return options;
    }-*/;
    
    public static final SavePlotAsPdfOptions adaptToSize(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/PlotsToolbar.java
Patch:
@@ -31,7 +31,7 @@ public class PlotsToolbar extends Toolbar implements HasCustomizableToolbar
    public PlotsToolbar(Commands commands, RSConnectPublishButton publishButton)
    {
       super("Plots Pane");
-      commands_ = commands ;
+      commands_ = commands;
       publishButton_ = publishButton;
       installStandardUI();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/manipulator/ManipulatorControlSlider.java
Patch:
@@ -130,8 +130,8 @@ public String formatLabel(SliderBar slider, double value)
    private static boolean hasDecimals(double value)
    {
       double truncatedValue = (double)(Math.round(value));
-      return value != truncatedValue;       
+      return value != truncatedValue;
    }
    
-   private SliderBar sliderBar_ ;
+   private SliderBar sliderBar_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/manipulator/ManipulatorManager.java
Patch:
@@ -179,7 +179,7 @@ public void setPosition(int offsetWidth, int offsetHeight)
                manipulatorPopup_.focusFirstControl();
             }
             
-         }) ;
+         });
          
          
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/Presentation.java
Patch:
@@ -617,7 +617,7 @@ private static int detectSlideIndex(String contents, int cursorLine)
       return -1;
    } 
    
-   private final Display view_ ; 
+   private final Display view_;
    private final PresentationServerOperations server_;
    private final GlobalDisplay globalDisplay_;
    private final EventBus eventBus_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationPane.java
Patch:
@@ -163,7 +163,7 @@ public void onClick(ClickEvent e)
    @Override 
    protected Widget createMainWidget()
    {  
-      frame_ = new PresentationFrame(false) ;
+      frame_ = new PresentationFrame(false);
       frame_.setUrl("about:blank");
       frame_.setSize("100%", "100%");
       return new AutoGlassPanel(frame_);
@@ -340,7 +340,7 @@ private void handleKeyDown(NativeEvent e)
    private ToolbarButton progressButton_;
    private RSConnectPublishButton publishButton_;
    private boolean busyPending_ = false;
-   private PresentationFrame frame_ ;
+   private PresentationFrame frame_;
    private final Commands commands_;
    private final Session session_;
    private final PresentationServerOperations server_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/model/PresentationServerOperations.java
Patch:
@@ -23,7 +23,7 @@ public interface PresentationServerOperations extends RPubsServerOperations
 {
    String getApplicationURL(String url);
    
-   void showHelpTopic(String what, String from, int type) ;
+   void showHelpTopic(String what, String from, int type);
    
    void setWorkingDirectory(String path,
                             ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserContextWidget.java
Patch:
@@ -67,10 +67,10 @@ public void onClick(ClickEvent event)
                      public void execute()
                      {
                         SelectionEvent.fire(CodeBrowserContextWidget.this, 
-                                            method) ;   
+                                            method);
                      }
                   });
-                  mi.getElement().getStyle().setPaddingRight(20, Unit.PX);                  
+                  mi.getElement().getStyle().setPaddingRight(20, Unit.PX);
                   menu.addItem(mi);
                }
                
@@ -113,7 +113,7 @@ public HandlerRegistration addSelectionHandler(
    @Override
    public void fireEvent(GwtEvent<?> event)
    {
-      handlers_.fireEvent(event) ;
+      handlers_.fireEvent(event);
    }
    
    public void setCurrentFunction(SearchPathFunctionDefinition functionDef)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -535,7 +535,7 @@ public void initialize(SourceDocument document,
          @Override
          public void generatePublishHtml(CommandWithArg<String> onComplete)
          {
-            onComplete.execute(htmlLocalPath_) ;
+            onComplete.execute(htmlLocalPath_);
          }
 
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/model/ProfileOperationRequest.java
Patch:
@@ -25,7 +25,7 @@ protected ProfileOperationRequest()
    
    public final native static ProfileOperationRequest create(String fileName) /*-{
       var request = new Object();
-      request.fileName = fileName ;
+      request.fileName = fileName;
       
       return request;
    }-*/;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceKeyboardPreviewer.java
Patch:
@@ -26,8 +26,8 @@ public class AceKeyboardPreviewer
 {
    public interface Handler 
    {
-      boolean previewKeyDown(JavaScriptObject data, NativeEvent event) ;
-      boolean previewKeyPress(JavaScriptObject data, char charCode) ;
+      boolean previewKeyDown(JavaScriptObject data, NativeEvent event);
+      boolean previewKeyPress(JavaScriptObject data, char charCode);
    }
    
    // NOTE: The 'previewKeyDown()' handler exposed here wraps a 'true' DOM

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ImagePreviewer.java
Patch:
@@ -580,7 +580,7 @@ private static void onPreviewImage(DocDisplay display,
    private final DocUpdateSentinel sentinel_;
    private final UserPrefs prefs_;
 
-   private static final String LINE_WIDGET_TYPE = "image-preview" ;
+   private static final String LINE_WIDGET_TYPE = "image-preview";
    private static int IMAGE_ID = 0;
    
    interface Styles extends CssResource

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5664,8 +5664,8 @@ void previewRd()
          public void execute()
          {
             String previewURL = "help/preview?file=";
-            previewURL += URL.encodeQueryString(docUpdateSentinel_.getPath());   
-            events_.fireEvent(new ShowHelpEvent(previewURL)) ; 
+            previewURL += URL.encodeQueryString(docUpdateSentinel_.getPath());
+            events_.fireEvent(new ShowHelpEvent(previewURL));
          }
       });
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionManager.java
Patch:
@@ -290,7 +290,7 @@ private boolean suggestCompletions(final boolean explicit, boolean canDelay)
          return false;
       
       // check for no selection
-      InputEditorSelection selection = docDisplay_.getSelection() ;
+      InputEditorSelection selection = docDisplay_.getSelection();
       if (selection == null)
          return false;
       
@@ -449,7 +449,7 @@ private boolean shouldComplete(NativeEvent event)
    private final CppCompletionContext completionContext_;
    private CppCompletionRequest request_;
    private SuggestionTimer suggestionTimer_;
-   private final InitCompletionFilter initFilter_ ;
+   private final InitCompletionFilter initFilter_;
    private final Invalidation completionRequestInvalidation_ = new Invalidation();
    private final SnippetHelper snippets_;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionResources.java
Patch:
@@ -45,6 +45,6 @@ public static interface Styles extends CssResource
    ImageResource downArrow2x();
    
    public static CppCompletionResources INSTANCE = 
-      (CppCompletionResources)GWT.create(CppCompletionResources.class) ;
+      (CppCompletionResources)GWT.create(CppCompletionResources.class);
   
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/CodeBrowserContents.java
Patch:
@@ -29,7 +29,7 @@ protected CodeBrowserContents()
    public static final native CodeBrowserContents create(String context) /*-{
       var contents = new Object();
       contents.context = context;
-      return contents ;
+      return contents;
    }-*/;
    
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/ContentItem.java
Patch:
@@ -25,9 +25,9 @@ protected ContentItem()
    public static final native ContentItem create(String title,
                                                  String contentUrl) /*-{
       var contentItem = new Object();
-      contentItem.title = title ;
-      contentItem.contentUrl = contentUrl ;
-      return contentItem ;
+      contentItem.title = title;
+      contentItem.contentUrl = contentUrl;
+      return contentItem;
    }-*/;
    
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/CppCapabilities.java
Patch:
@@ -24,8 +24,8 @@ protected CppCapabilities()
    
    public static final native CppCapabilities createDefault()  /*-{
       var caps = new Object();
-      caps.can_build = false ;
-      caps.can_source_cpp = false ;
+      caps.can_build = false;
+      caps.can_source_cpp = false;
       return caps;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DataItem.java
Patch:
@@ -42,7 +42,7 @@ public static final native DataItem create(String caption,
       dataItem.variables = variables;
       dataItem.contentUrl = contentUrl;
       dataItem.preview = preview;
-      return dataItem ;
+      return dataItem;
    }-*/;
 
    public final String getURI()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceNavigation.java
Patch:
@@ -31,7 +31,7 @@ public static final native SourceNavigation create(
       sourceNavPosition.document_id = document_id;
       sourceNavPosition.path = path;
       sourceNavPosition.position = position;
-      return sourceNavPosition ;
+      return sourceNavPosition;
    }-*/;
    
    public native final String getDocumentId() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPresenter.java
Patch:
@@ -614,7 +614,7 @@ public void execute(ExportPlotOptions options)
             }
          };
    
-   private final Display display_ ;
+   private final Display display_;
    private final Commands commands_;
    private final GlobalDisplay globalDisplay_;
    private final WorkbenchContext workbenchContext_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -57,7 +57,9 @@ public ConsolePane(Provider<Shell> consoleProvider,
                       Commands commands,
                       Session session)
    {
-      super("Console", events);
+      // We pass null in place of events here to prevent ActivePaneEvent from being called.
+      // ActivatePaneEvent isn't necessary and causes an exception for the Console Pane.
+      super("Console", null);
 
       consoleProvider_ = consoleProvider;
       progressProvider_ = progressProvider;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -3343,7 +3343,7 @@ private void showFileTooLargeWarning(FileSystemItem file,
 
    private void confirmOpenLargeFile(FileSystemItem file,
                                      Operation openOperation,
-                                     Operation cancelOperation)
+                                     Operation noOperation)
    {
       StringBuilder msg = new StringBuilder();
       msg.append("The source file '" + file.getName() + "' is large (");
@@ -3353,7 +3353,9 @@ private void confirmOpenLargeFile(FileSystemItem file,
       globalDisplay_.showYesNoMessage(GlobalDisplay.MSG_WARNING,
                                       "Confirm Open",
                                       msg.toString(),
+                                      false, // Don't include cancel
                                       openOperation,
+                                      noOperation,
                                       false);   // 'No' is default
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -3343,7 +3343,7 @@ private void showFileTooLargeWarning(FileSystemItem file,
 
    private void confirmOpenLargeFile(FileSystemItem file,
                                      Operation openOperation,
-                                     Operation cancelOperation)
+                                     Operation noOperation)
    {
       StringBuilder msg = new StringBuilder();
       msg.append("The source file '" + file.getName() + "' is large (");
@@ -3353,7 +3353,9 @@ private void confirmOpenLargeFile(FileSystemItem file,
       globalDisplay_.showYesNoMessage(GlobalDisplay.MSG_WARNING,
                                       "Confirm Open",
                                       msg.toString(),
+                                      false, // Don't include cancel
                                       openOperation,
+                                      noOperation,
                                       false);   // 'No' is default
    }
 

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -313,7 +313,8 @@ protected void configure()
       bind(RSAccountConnector.class).in(Singleton.class);
       bind(PlotPublishMRUList.class).asEagerSingleton();
       bind(SourceWindowManager.class).in(Singleton.class);
-      bind(SourceWindow.class).in(Singleton.class);
+      //bind(SourceWindow.class).in(Singleton.class);
+      bind(SourceWindow.class).asEagerSingleton();
       bind(EditorCommandManager.class).in(Singleton.class);
       bind(UserCommandManager.class).in(Singleton.class);
       bind(ApplicationCommandManager.class).in(Singleton.class);
@@ -328,6 +329,7 @@ protected void configure()
       bind(HtmlMessageListener.class).asEagerSingleton();
       bind(BrowserEventWorkarounds.class).asEagerSingleton();
       bind(FastestSmallestTextEncoderDecoder.class).asEagerSingleton();
+      bind(Source.class).in(Singleton.class);
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -132,6 +132,8 @@
 import org.rstudio.studio.client.workbench.views.source.NewPlumberAPI;
 import org.rstudio.studio.client.workbench.views.source.NewShinyWebApplication;
 import org.rstudio.studio.client.workbench.views.source.SourceSatellite;
+import org.rstudio.studio.client.workbench.views.source.Source;
+import org.rstudio.studio.client.workbench.views.source.SourcePane;
 import org.rstudio.studio.client.workbench.views.source.SourceWindow;
 import org.rstudio.studio.client.workbench.views.source.SourceWindowManager;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTargetCodeExecution;
@@ -301,6 +303,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(PanmirrorUIDisplay panmirrorUIDisplay);
    void injectMembers(TextEditingTargetVisualMode textEditingTargetVisualMode);
    void injectMembers(OpenProjectDialog dialog);
+   void injectMembers(SourcePane sourcePane);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -50,8 +50,6 @@ public interface ThemeStyles extends CssResource
           
    String closeTabButton();
 
-   String fixedWidthFont();
-   
    String visuallyHidden();
    String tabLayout();
    String tabLayoutLeft();

File: src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerItemCodec.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SourceMarkerItemCodec.java
  *
- * Copyright (C) 2009-12 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.theme.ThemeFonts;
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.core.client.widget.HeaderBreaksItemCodec;
@@ -52,7 +53,7 @@ public void setFileHeaderBasePath(String basePath)
    public TableRowElement getRowForItem(SourceMarker entry)
    {
       TableRowElement tr = Document.get().createTRElement();
-      tr.addClassName(ThemeResources.INSTANCE.themeStyles().fixedWidthFont());
+      tr.addClassName(ThemeFonts.getFixedWidthClass());
       FontSizer.applyNormalFontSize(tr);
       
       tr.setAttribute(DATA_PATH,

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -23,7 +23,9 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 
 import com.google.gwt.core.client.JavaScriptObject;
+import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.core.client.JsArray;
+import org.rstudio.core.client.JsArrayUtil;
 
 
 /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -21,6 +21,7 @@
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.ResultCallback;
 import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.theme.ThemeFonts;
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.widget.ModalDialogBase;
 import org.rstudio.core.client.widget.ThemedButton;
@@ -102,7 +103,7 @@ public TerminalInfoDialog(String globalInfo, final TerminalSession session)
             diagnostics.append(session.getSocket().getLocalEchoDiagnostics());
       }
       textArea_ = new TextArea();
-      textArea_.addStyleName(ThemeResources.INSTANCE.themeStyles().fixedWidthFont());
+      textArea_.addStyleName(ThemeFonts.getFixedWidthClass());
       textArea_.setSize("600px", "400px");
       textArea_.setReadOnly(true);
       textArea_.setText(diagnostics.toString());

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -104,7 +104,7 @@ class SelectedTabStateValue extends IntStateValue
       @Override
       protected void onInit(Integer value)
       {
-         if (value != null)
+         if (value != null && tabPanel_.getWidgetCount() > 0)
             tabPanel_.selectTab(value);
       }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -810,7 +810,7 @@ private void initPanes(PaneConfig config)
             tabNamesToTabs(config.getHiddenTabSet()));
       panesByName_.put("HiddenTabSet", tsHide.first);
       hiddenTabSetTabPanel_ = tsHide.second;
-      hiddenTabSetTabPanel_.neverVisible(true);
+      hiddenTabSetTabPanel_.setNeverVisible(true);
       hiddenTabSetMinPanel_ = tsHide.third;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchTabPanel.java
Patch:
@@ -303,7 +303,7 @@ public LogicalWindow getParentWindow()
       return parentWindow_;
    }
 
-   public void neverVisible(boolean value)
+   public void setNeverVisible(boolean value)
    {
       neverVisible_ = value;
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarMenu.java
Patch:
@@ -41,7 +41,6 @@ private void init(PanmirrorToolbarCommands commands)
    {
       commands_ = commands;
       addStyleName(RES.styles().toolbarPopupMenu());
-      getElement().getStyle().setZIndex(1000);
       setAutoOpen(true);
    }
    
@@ -81,7 +80,7 @@ private static SafeHtml menuText(String text)
    }
    
    private static final PanmirrorToolbarResources RES = PanmirrorToolbarResources.INSTANCE;
-   private final ArrayList<PanmirrorCommandUIObject> uiObjects_ = new ArrayList<PanmirrorCommandUIObject>();
+   private final ArrayList<PanmirrorCommandUIObject> uiObjects_ = new ArrayList<>();
    private PanmirrorToolbarCommands commands_;
    
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorToolbarMenu.java
Patch:
@@ -41,7 +41,6 @@ private void init(PanmirrorToolbarCommands commands)
    {
       commands_ = commands;
       addStyleName(RES.styles().toolbarPopupMenu());
-      getElement().getStyle().setZIndex(1000);
       setAutoOpen(true);
    }
    
@@ -81,7 +80,7 @@ private static SafeHtml menuText(String text)
    }
    
    private static final PanmirrorToolbarResources RES = PanmirrorToolbarResources.INSTANCE;
-   private final ArrayList<PanmirrorCommandUIObject> uiObjects_ = new ArrayList<PanmirrorCommandUIObject>();
+   private final ArrayList<PanmirrorCommandUIObject> uiObjects_ = new ArrayList<>();
    private PanmirrorToolbarCommands commands_;
    
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/theme/PanmirrorThemeCreator.java
Patch:
@@ -16,7 +16,6 @@
 package org.rstudio.studio.client.panmirror.theme;
 
 import org.rstudio.core.client.BrowseCap;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.theme.ThemeFonts;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -23,9 +23,7 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 
 import com.google.gwt.core.client.JavaScriptObject;
-import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.core.client.JsArray;
-import org.rstudio.core.client.JsArrayUtil;
 
 
 /**

File: src/gwt/test/org/rstudio/studio/client/workbench/views/jobs/view/JobsListTests.java
Patch:
@@ -143,6 +143,7 @@ public String getModuleName()
     */
    public void testAllocate()
    {
+      @SuppressWarnings("unused")
       JobsList list = new JobsList(new Factory());
       Assert.assertTrue(true);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/PackageActionConfirmationDialog.java
Patch:
@@ -63,6 +63,8 @@ public PackageActionConfirmationDialog(
     
       addLeftButton(selectAllButton_ = new ThemedButton("Select All",
          event -> setGlobalPerformAction("Select All", true)), ElementIds.SELECT_ALL_BUTTON);
+      
+      selectAllButton_.getElement().getStyle().setMarginRight(10, Unit.PX);
      
       addLeftButton(selectNoneButton_ = new ThemedButton("Select None",
          event -> setGlobalPerformAction("Select None", false)), ElementIds.SELECT_NONE_BUTTON);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/DocumentOutlineWidget.java
Patch:
@@ -119,7 +119,6 @@ public void onClick(ClickEvent event)
                target_.navigateToPosition(
                      SourcePosition.create(node_.getPreamble().getRow(), node_.getPreamble().getColumn()),
                      true);
-               target_.getDocDisplay().alignCursor(node_.getPreamble(), 0.1);
                
                // Defer focus so it occurs after click has been fully handled
                Scheduler.get().scheduleDeferred(new ScheduledCommand()

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -157,6 +157,7 @@ public static String idFromLabel(String label)
    public final static String EDIT_DIAGNOSTICS_PREFS = "editing_diagnostics_prefs";
 
    public final static String GENERAL_BASIC_PREFS = "general_basic_prefs";
+   public final static String GENERAL_GRAPHICS_PREFS = "general_graphics_prefs";
    public final static String GENERAL_ADVANCED_PREFS = "general_advanced_prefs";
    
    public final static String RMARKDOWN_BASIC_PREFS = "rmarkdown_basic_prefs";

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -23,7 +23,9 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 
 import com.google.gwt.core.client.JavaScriptObject;
+import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.core.client.JsArray;
+import org.rstudio.core.client.JsArrayUtil;
 
 
 /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditorContainer.java
Patch:
@@ -63,6 +63,7 @@ public static interface Editor extends IsHideableWidget
    public TextEditorContainer(Editor editor)
    {
       editor_ = editor;
+      addStyleName("ace_editor_theme");
       addWidget(editor);
    }
    

File: src/gwt/src/org/rstudio/core/client/promise/PromiseWithProgress.java
Patch:
@@ -31,7 +31,7 @@ public class PromiseWithProgress<V>
 { 
    public PromiseWithProgress(Promise<V> promise, V errorVal, CommandWithArg<V> completed)
    {
-      this(promise, errorVal, 500, completed);
+      this(promise, errorVal, 2000, completed);
    }
    
    public PromiseWithProgress(Promise<V> promise, V errorVal, int delayMs, CommandWithArg<V> completed)

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java
Patch:
@@ -462,7 +462,7 @@ public boolean shouldCheckSpelling(DocDisplay dd, Range r)
       severe issues with. This is being tracked to be fixed in issue #6041 as
       soon as possible so this can then be removed.
     */
-   private static String[] realtimeDictBlacklist = {"cs_CZ", "de_DE_neu", "lt_LT", "pt_BR"};
+   private static String[] realtimeDictBlacklist = {"cs_CZ", "de_DE_neu", "lt_LT", "pt_BR", "it_IT"};
    public static boolean canRealtimeSpellcheckDict(String dict)
    {
       boolean exists = false;

File: src/gwt/src/org/rstudio/core/client/promise/PromiseWithProgress.java
Patch:
@@ -38,7 +38,7 @@ public PromiseWithProgress(Promise<V> promise, String progress, V errorVal, Comm
    {
       // setup progress
       GlobalDisplay globalDisplay = RStudioGinjector.INSTANCE.getGlobalDisplay();
-      ProgressIndicator indicator = new GlobalProgressDelayer(globalDisplay, 300, progress).getIndicator();
+      ProgressIndicator indicator = new GlobalProgressDelayer(globalDisplay, 500, progress).getIndicator();
       
       // execute the promise
       promise.then(new ThenOnFulfilledCallbackFn<V,V>() {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -810,6 +810,7 @@ private void initPanes(PaneConfig config)
             tabNamesToTabs(config.getHiddenTabSet()));
       panesByName_.put("HiddenTabSet", tsHide.first);
       hiddenTabSetTabPanel_ = tsHide.second;
+      hiddenTabSetTabPanel_.neverVisible(true);
       hiddenTabSetMinPanel_ = tsHide.third;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/spelling/CheckSpelling.java
Patch:
@@ -168,7 +168,7 @@ private void findNextMisspelling()
          showProgress();
 
          Iterable<Range> wordSource = docDisplay_.getWords(
-               docDisplay_.getFileType().getTokenPredicate(),
+               docDisplay_.getFileType().getSpellCheckTokenPredicate(),
                docDisplay_.getFileType().getCharPredicate(),
                currentPos_,
                wrapped_ ? initialCursorPos_.getPosition() : null);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/events/TutorialCommandEvent.java
Patch:
@@ -63,8 +63,6 @@ public final <T extends JavaScriptObject> T getData()
    private final String type_;
    private final JavaScriptObject data_;
    
-   public static final String TYPE_STOP = "stop";
-   
    // Boilerplate ----
    
    public interface Handler extends EventHandler
@@ -87,6 +85,7 @@ protected void dispatch(Handler handler)
    public static final Type<Handler> TYPE = new Type<Handler>();
    
    public static final String TYPE_STARTED = "started";
+   public static final String TYPE_STOP = "stop";
    public static final String TYPE_NAVIGATE = "navigate";
    public static final String TYPE_INDEXING_COMPLETED = "indexing_completed";
    public static final String TYPE_LAUNCH_DEFAULT_TUTORIAL = "launch_default_tutorial";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/PackageActionConfirmationDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PackageActionConfirmationDialog.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -105,7 +105,7 @@ protected Widget createMainWidget()
       actionsTable_ = new CellTable<>(
             15,
             GWT.<PackagesCellTableResources> create(PackagesCellTableResources.class));
-      actionsTable_.setKeyboardSelectionPolicy(KeyboardSelectionPolicy.ENABLED);
+      actionsTable_.setKeyboardSelectionPolicy(KeyboardSelectionPolicy.DISABLED);
       actionsTable_.setSelectionModel(new NoSelectionModel<>());
       actionsTable_.setWidth("100%", true);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/PackageActionConfirmationDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PackageActionConfirmationDialog.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -105,7 +105,7 @@ protected Widget createMainWidget()
       actionsTable_ = new CellTable<>(
             15,
             GWT.<PackagesCellTableResources> create(PackagesCellTableResources.class));
-      actionsTable_.setKeyboardSelectionPolicy(KeyboardSelectionPolicy.ENABLED);
+      actionsTable_.setKeyboardSelectionPolicy(KeyboardSelectionPolicy.DISABLED);
       actionsTable_.setSelectionModel(new NoSelectionModel<>());
       actionsTable_.setWidth("100%", true);
       

File: src/gwt/test/org/rstudio/core/client/ConsoleOutputWriterTests.java
Patch:
@@ -85,7 +85,7 @@ public VirtualConsole create(Element elem)
    
    private ConsoleOutputWriter getCOW()
    {
-      return new ConsoleOutputWriter(new VCFactory());
+      return new ConsoleOutputWriter(new VCFactory(), null);
    }
 
    @Override

File: src/gwt/test/org/rstudio/core/client/ConsoleOutputWriterTests.java
Patch:
@@ -85,7 +85,7 @@ public VirtualConsole create(Element elem)
    
    private ConsoleOutputWriter getCOW()
    {
-      return new ConsoleOutputWriter(new VCFactory());
+      return new ConsoleOutputWriter(new VCFactory(), null);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -111,6 +111,7 @@ public AceEditorWidget(boolean applyNormalFontSize)
       editor_.setHighlightActiveLine(false);
       editor_.setHighlightGutterLine(false);
       editor_.setFixedWidthGutter(true);
+      editor_.setIndentedSoftWrap(false);
       editor_.delegateEventsTo(AceEditorWidget.this);
       editor_.onChange(new CommandWithArg<AceDocumentChangeEventNative>()
       {

File: src/gwt/src/org/rstudio/studio/client/application/ui/RequestLogDetail.java
Patch:
@@ -51,6 +51,7 @@ public RequestLogDetail(RequestLogEntry entry)
                    + tryPrettyJson(resp)
                    + "\n");
       html.getElement().getStyle().setProperty("whiteSpace", "pre-wrap");
+      html.getElement().getStyle().setProperty("userSelect", "text");
 
       panel.add(html);
 

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellDisplay.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.common.shell;
 
+import org.rstudio.core.client.ConsoleOutputWriter;
 import org.rstudio.core.client.jsonrpc.RpcObjectList;
 import org.rstudio.core.client.widget.CanFocus;
 import org.rstudio.studio.client.workbench.model.ConsoleAction;
@@ -36,6 +37,7 @@ public interface ShellDisplay extends ShellOutputWriter,
    void consolePrompt(String prompt, boolean showInput);
    void ensureInputVisible();
    InputEditorDisplay getInputEditorDisplay();
+   ConsoleOutputWriter getConsoleOutputWriter();
    void clearOutput();
    String processCommandEntry();
    int getCharacterWidth();

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -646,7 +646,9 @@
    public abstract AppCommand showAccessibilityOptions();
    public abstract AppCommand focusMainToolbar();
    public abstract AppCommand speakEditorLocation();
-   
+   public abstract AppCommand focusConsoleOutputEnd();
+   public abstract AppCommand showAccessibilityHelp();
+
    // Internal
    public abstract AppCommand showDomElements();
    public abstract AppCommand showShortcutCommand();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpTab.java
Patch:
@@ -56,6 +56,7 @@ public abstract static class Shim extends DelayLoadTabShim<Help, HelpTab>
       @Handler public abstract void onOpenRoxygenQuickReference();
       @Handler public abstract void onBrowseCheatSheets();
       @Handler public abstract void onProfileHelp();
+      @Handler public abstract void onShowAccessibilityHelp();
       
       public abstract void bringToFront();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/r/SignatureToolTipManager.java
Patch:
@@ -391,6 +391,9 @@ private void setAnchor(TokenIterator cursor)
    
    public void resolveActiveFunctionAndDisplayToolTip()
    {
+      if (!userPrefs_.showFunctionSignatureTooltips().getGlobalValue())
+         return;
+      
       if (docDisplay_.isPopupVisible())
          return;
       

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorEditImageDialog.java
Patch:
@@ -93,7 +93,7 @@ public void focusFirstControl()
    protected PanmirrorImageProps collectInput()
    {
       PanmirrorImageProps result = new PanmirrorImageProps();
-      result.src = url_.getText().trim();
+      result.src = url_.getTextBox().getValue().trim();
       result.title = title_.getValue().trim();
       result.alt = alt_.getValue().trim();
       PanmirrorAttrProps attr = editAttr_.getAttr();

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -647,6 +647,7 @@
    public abstract AppCommand focusMainToolbar();
    public abstract AppCommand speakEditorLocation();
    public abstract AppCommand focusConsoleOutputEnd();
+   public abstract AppCommand showAccessibilityHelp();
 
    // Internal
    public abstract AppCommand showDomElements();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpTab.java
Patch:
@@ -56,6 +56,7 @@ public abstract static class Shim extends DelayLoadTabShim<Help, HelpTab>
       @Handler public abstract void onOpenRoxygenQuickReference();
       @Handler public abstract void onBrowseCheatSheets();
       @Handler public abstract void onProfileHelp();
+      @Handler public abstract void onShowAccessibilityHelp();
       
       public abstract void bringToFront();
    }

File: src/gwt/src/org/rstudio/studio/client/application/ui/RequestLogDetail.java
Patch:
@@ -51,6 +51,7 @@ public RequestLogDetail(RequestLogEntry entry)
                    + tryPrettyJson(resp)
                    + "\n");
       html.getElement().getStyle().setProperty("whiteSpace", "pre-wrap");
+      html.getElement().getStyle().setProperty("userSelect", "text");
 
       panel.add(html);
 

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyDisconnectNotifier.java
Patch:
@@ -65,9 +65,9 @@ private native void initializeEvents() /*-{
             return;
          
          self.@org.rstudio.studio.client.shiny.ShinyDisconnectNotifier::onMessage(*)(
-            e.data,
-            e.origin,
-            e.target.name
+            event.data,
+            event.origin,
+            event.target.name
          );
          
       });

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/r/SignatureToolTipManager.java
Patch:
@@ -391,6 +391,9 @@ private void setAnchor(TokenIterator cursor)
    
    public void resolveActiveFunctionAndDisplayToolTip()
    {
+      if (!userPrefs_.showFunctionSignatureTooltips().getGlobalValue())
+         return;
+      
       if (docDisplay_.isPopupVisible())
          return;
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ShellPane.java
Patch:
@@ -31,7 +31,7 @@ public class ShellPane extends ShellWidget implements Shell.Display
    @Inject
    public ShellPane(final AceEditor editor, UserPrefs uiPrefs, EventBus events, AriaLiveService ariaLive)
    {
-      super(editor, uiPrefs, events, ariaLive);
+      super(editor, uiPrefs, events, ariaLive, "Console Output");
 
       editor.setDisableOverwrite(true);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/ConsoleProgressWidget.java
Patch:
@@ -25,7 +25,7 @@ public class ConsoleProgressWidget extends ShellWidget implements ShellDisplay
 {
    public ConsoleProgressWidget()
    {
-      super(new AceEditor(), null, null, null);
+      super(new AceEditor(), null, null, null, null);
       getEditor().setInsertMatching(false);
       getEditor().setTextInputAriaLabel("Progress details");
       if (!RStudioGinjector.INSTANCE.getAriaLiveService().isDisabled(AriaLiveService.PROGRESS_LOG))

File: src/gwt/src/org/rstudio/studio/client/panmirror/theme/PanmirrorThemeCreator.java
Patch:
@@ -75,7 +75,7 @@ public static PanmirrorTheme themeFromEditorTheme(AceTheme aceTheme, UserPrefs p
       double fontSize = prefs.fontSizePoints().getValue();
       fontSize = fontSize + BrowseCap.getFontSkew();
       theme.fixedWidthFont = ThemeFonts.getFixedWidthFont();
-      theme.fixedWidthFontSizePt = fontSize + 1;
+      theme.fixedWidthFontSizePt = fontSize;
       theme.proportionalFont = ThemeFonts.getProportionalFont();
       theme.proportionalFontSizePt = fontSize + 1;
       

File: src/gwt/src/org/rstudio/studio/client/panmirror/theme/PanmirrorThemeCreator.java
Patch:
@@ -75,7 +75,7 @@ public static PanmirrorTheme themeFromEditorTheme(AceTheme aceTheme, UserPrefs p
       double fontSize = prefs.fontSizePoints().getValue();
       fontSize = fontSize + BrowseCap.getFontSkew();
       theme.fixedWidthFont = ThemeFonts.getFixedWidthFont();
-      theme.fixedWidthFontSizePt = fontSize;
+      theme.fixedWidthFontSizePt = fontSize + 1;
       theme.proportionalFont = ThemeFonts.getProportionalFont();
       theme.proportionalFontSizePt = fontSize + 1;
       

File: src/gwt/src/org/rstudio/studio/client/common/repos/SecondaryReposDialog.java
Patch:
@@ -249,8 +249,8 @@ public void onResponseReceived(SecondaryReposResult result)
                   String repoUrl = repo.getURL();
                   if (repoUrl.length() > 0 &&
                       cranRepoUrl_.length() > 0) {
-                      char mainEnd = cranRepoUrl_.charAt(cranRepoUrl_.length() - 1);
-                      char repoEnd = repo.getURL().charAt(repoUrl.length() - 1);
+                      char mainEnd = StringUtil.charAt(cranRepoUrl_, cranRepoUrl_.length() - 1);
+                      char repoEnd = StringUtil.charAt(repo.getURL(), repoUrl.length() - 1);
                       if (mainEnd == '/' && repoEnd != '/')
                          repoUrl = repoUrl + "/";
                       else if (mainEnd != '/' && repoEnd == '/')

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/DialogHtmlSanitizer.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DialogHtmlSanitizer.java
  *
- * Copyright (C) 2009-16 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -56,7 +56,7 @@ private static String dialogSanitize(String text) {
          String tag = null;
          boolean isValidTag = false;
          if (tagEnd > 0) {
-            if (segment.charAt(0) == '/') {
+            if (StringUtil.charAt(segment, 0) == '/') {
                tagStart = 1;
             }
             tag = segment.substring(tagStart, tagEnd).toLowerCase();

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchOracle.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * CodeSearchOracle.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -82,7 +82,7 @@ public static int scoreMatch(String suggestion, String query, boolean isFile)
          // Less penalty if character follows special delim
          if (matchPos >= 1)
          {
-            char prevChar = suggestionLower.charAt(matchPos - 1);
+            char prevChar = StringUtil.charAt(suggestionLower, matchPos - 1);
             if (prevChar == '_' || prevChar == '-' ||
                   (!isFile && prevChar == '.'))
             {
@@ -91,7 +91,7 @@ public static int scoreMatch(String suggestion, String query, boolean isFile)
          }
          
          // Less penalty for case-sensitive matches
-         if (suggestion.charAt(matchPos) == query.charAt(j))
+         if (StringUtil.charAt(suggestion, matchPos) == query.charAt(j))
             penalty--;
          
          // More penalty for 'uninteresting' files

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManagerBase.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * CompletionManagerBase.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -611,7 +611,7 @@ protected boolean canAutoPopup(char ch, int lookbackLimit)
       for (int i = 0; i < lookbackLimit; i++)
       {
          int index = cursorColumn - i - 1;
-         if (isBoundaryCharacter(currentLine.charAt(index)))
+         if (isBoundaryCharacter(StringUtil.charAt(currentLine, index)))
             return false;
       }
       
@@ -703,7 +703,7 @@ private void onDocumentChanged(DocumentChangedEvent event)
          }
          
          String line = docDisplay_.getCurrentLine();
-         char ch = line.charAt(cursorColumn - 1);
+         char ch = StringUtil.charAt(line, cursorColumn - 1);
          if (isBoundaryCharacter(ch))
          {
             invalidatePendingRequests();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RCompletionManager.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -753,7 +753,7 @@ public boolean previewKeyPress(char c)
          // Immediately display completions after '$', '::', etc.
          if (input_.getCursorPosition().getColumn() > 0)
          {
-            char prevChar = docDisplay_.getCurrentLine().charAt(
+            char prevChar = StringUtil.charAt(docDisplay_.getCurrentLine(),
                   input_.getCursorPosition().getColumn() - 1);
             if (
                   (c == ':' && prevChar == ':') ||
@@ -1885,7 +1885,7 @@ private void applyValueRmdOption(final String value)
             int startPos = selection_.getStart().getPosition();
             String currentLine = docDisplay_.getCurrentLine();
             while (startPos < currentLine.length() &&
-                  currentLine.charAt(startPos) == ' ')
+                  StringUtil.charAt(currentLine, startPos) == ' ')
                ++startPos;
             
             input_.setSelection(new InputEditorSelection(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AceEditor.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -1693,7 +1693,7 @@ public char getCharacterAtCursor()
       if (column == line.length())
          return '\0';
 
-      return line.charAt(column);
+      return StringUtil.charAt(line, column);
    }
 
    public char getCharacterBeforeCursor()
@@ -1704,7 +1704,7 @@ public char getCharacterBeforeCursor()
          return '\0';
 
       String line = getLine(cursorPos.getRow());
-      return line.charAt(column - 1);
+      return StringUtil.charAt(line, column - 1);
    }
 
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5246,7 +5246,7 @@ private String stangle(String sweaveStr)
       {
          String text = scopeHelper_.getSweaveChunkText(chunk);
          code.append(text);
-         if (text.length() > 0 && text.charAt(text.length()-1) != '\n')
+         if (text.length() > 0 && StringUtil.charAt(text, text.length()-1) != '\n')
             code.append('\n');
       }
       return code.toString();

File: src/gwt/src/org/rstudio/studio/client/common/repos/SecondaryReposDialog.java
Patch:
@@ -249,8 +249,8 @@ public void onResponseReceived(SecondaryReposResult result)
                   String repoUrl = repo.getURL();
                   if (repoUrl.length() > 0 &&
                       cranRepoUrl_.length() > 0) {
-                      char mainEnd = cranRepoUrl_.charAt(cranRepoUrl_.length() - 1);
-                      char repoEnd = repo.getURL().charAt(repoUrl.length() - 1);
+                      char mainEnd = StringUtil.charAt(cranRepoUrl_, cranRepoUrl_.length() - 1);
+                      char repoEnd = StringUtil.charAt(repo.getURL(), repoUrl.length() - 1);
                       if (mainEnd == '/' && repoEnd != '/')
                          repoUrl = repoUrl + "/";
                       else if (mainEnd != '/' && repoEnd == '/')

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/DialogHtmlSanitizer.java
Patch:
@@ -56,7 +56,7 @@ private static String dialogSanitize(String text) {
          String tag = null;
          boolean isValidTag = false;
          if (tagEnd > 0) {
-            if (segment.charAt(0) == '/') {
+            if (StringUtil.charAt(segment, 0) == '/') {
                tagStart = 1;
             }
             tag = segment.substring(tagStart, tagEnd).toLowerCase();

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchOracle.java
Patch:
@@ -82,7 +82,7 @@ public static int scoreMatch(String suggestion, String query, boolean isFile)
          // Less penalty if character follows special delim
          if (matchPos >= 1)
          {
-            char prevChar = suggestionLower.charAt(matchPos - 1);
+            char prevChar = StringUtil.charAt(suggestionLower, matchPos - 1);
             if (prevChar == '_' || prevChar == '-' ||
                   (!isFile && prevChar == '.'))
             {
@@ -91,7 +91,7 @@ public static int scoreMatch(String suggestion, String query, boolean isFile)
          }
          
          // Less penalty for case-sensitive matches
-         if (suggestion.charAt(matchPos) == query.charAt(j))
+         if (StringUtil.charAt(suggestion, matchPos) == query.charAt(j))
             penalty--;
          
          // More penalty for 'uninteresting' files

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManagerBase.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * CompletionManagerBase.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -611,7 +611,7 @@ protected boolean canAutoPopup(char ch, int lookbackLimit)
       for (int i = 0; i < lookbackLimit; i++)
       {
          int index = cursorColumn - i - 1;
-         if (isBoundaryCharacter(currentLine.charAt(index)))
+         if (isBoundaryCharacter(StringUtil.charAt(currentLine, index)))
             return false;
       }
       
@@ -703,7 +703,7 @@ private void onDocumentChanged(DocumentChangedEvent event)
          }
          
          String line = docDisplay_.getCurrentLine();
-         char ch = line.charAt(cursorColumn - 1);
+         char ch = StringUtil.charAt(line, cursorColumn - 1);
          if (isBoundaryCharacter(ch))
          {
             invalidatePendingRequests();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RCompletionManager.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -753,7 +753,7 @@ public boolean previewKeyPress(char c)
          // Immediately display completions after '$', '::', etc.
          if (input_.getCursorPosition().getColumn() > 0)
          {
-            char prevChar = docDisplay_.getCurrentLine().charAt(
+            char prevChar = StringUtil.charAt(docDisplay_.getCurrentLine(),
                   input_.getCursorPosition().getColumn() - 1);
             if (
                   (c == ':' && prevChar == ':') ||
@@ -1885,7 +1885,7 @@ private void applyValueRmdOption(final String value)
             int startPos = selection_.getStart().getPosition();
             String currentLine = docDisplay_.getCurrentLine();
             while (startPos < currentLine.length() &&
-                  currentLine.charAt(startPos) == ' ')
+                  StringUtil.charAt(currentLine, startPos) == ' ')
                ++startPos;
             
             input_.setSelection(new InputEditorSelection(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AceEditor.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -1693,7 +1693,7 @@ public char getCharacterAtCursor()
       if (column == line.length())
          return '\0';
 
-      return line.charAt(column);
+      return StringUtil.charAt(line, column);
    }
 
    public char getCharacterBeforeCursor()
@@ -1704,7 +1704,7 @@ public char getCharacterBeforeCursor()
          return '\0';
 
       String line = getLine(cursorPos.getRow());
-      return line.charAt(column - 1);
+      return StringUtil.charAt(line, column - 1);
    }
 
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5246,7 +5246,7 @@ private String stangle(String sweaveStr)
       {
          String text = scopeHelper_.getSweaveChunkText(chunk);
          code.append(text);
-         if (text.length() > 0 && text.charAt(text.length()-1) != '\n')
+         if (text.length() > 0 && StringUtil.charAt(text, text.length()-1) != '\n')
             code.append('\n');
       }
       return code.toString();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitStatusRenderer.java
Patch:
@@ -78,6 +78,9 @@ public SafeHtml render(String str)
 
    private String descForStatus(String str)
    {
+      if (str.length() < 2)
+         return null;
+
       String indexDesc = descForStatus(str.charAt(0));
       String treeDesc = descForStatus(str.charAt(1));
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/SVNStatusRenderer.java
Patch:
@@ -85,6 +85,9 @@ public SafeHtml render(String str)
 
    private String descForStatus(String str)
    {
+      if (str.isEmpty())
+         return "";
+
       char c = str.charAt(0);
       
       switch (c)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -254,7 +254,9 @@ private void manageFilePattern()
          ((Element) listPresetFilePatterns_.getElement().getChild(
                Include.Package.ordinal()))
             .setAttribute("disabled", "disabled");
-         listPresetFilePatterns_.setSelectedIndex(Include.AllFiles.ordinal());
+         if (listPresetFilePatterns_.getSelectedIndex() ==
+             Include.Package.ordinal())
+            listPresetFilePatterns_.setSelectedIndex(Include.AllFiles.ordinal());
       }
       else
          ((Element) listPresetFilePatterns_.getElement().getChild(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -254,7 +254,9 @@ private void manageFilePattern()
          ((Element) listPresetFilePatterns_.getElement().getChild(
                Include.Package.ordinal()))
             .setAttribute("disabled", "disabled");
-         listPresetFilePatterns_.setSelectedIndex(Include.AllFiles.ordinal());
+         if (listPresetFilePatterns_.getSelectedIndex() ==
+             Include.Package.ordinal())
+            listPresetFilePatterns_.setSelectedIndex(Include.AllFiles.ordinal());
       }
       else
          ((Element) listPresetFilePatterns_.getElement().getChild(

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorEditRawDialog.java
Patch:
@@ -135,7 +135,7 @@ private String rawContent()
    private GlobalDisplay globalDisplay_;
    
    private Widget mainWidget_; 
-   @UiField RawFormatSelect rawFormatSelect_;
+   @UiField PanmirrorRawFormatSelect rawFormatSelect_;
    @UiField FormTextArea rawContent_;
    
    private static PanmirrorEditRawDialogUiBinder uiBinder = GWT

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorRawFormatSelect.java
Patch:
@@ -20,9 +20,9 @@
 
 import org.rstudio.core.client.widget.SelectWidget;
 
-public class RawFormatSelect extends SelectWidget
+public class PanmirrorRawFormatSelect extends SelectWidget
 {
-   public RawFormatSelect()
+   public PanmirrorRawFormatSelect()
    {
       super("Format:", getOptions(), getValues(), false);
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorEditAttrDialog.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * PanimrrorEditAttributesDialog.java
+ * PanimrrorEditAttrDialog.java
  *
  * Copyright (C) 2020 by RStudio, PBC
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -201,6 +201,7 @@ public PrefValue<String> posixTerminalShell()
 
    public final static String POSIX_TERMINAL_SHELL_DEFAULT = "default";
    public final static String POSIX_TERMINAL_SHELL_BASH = "bash";
+   public final static String POSIX_TERMINAL_SHELL_ZSH = "zsh";
    public final static String POSIX_TERMINAL_SHELL_CUSTOM = "custom";
    public final static String POSIX_TERMINAL_SHELL_NONE = "none";
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalShellInfo.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalShellInfo.java
  *
- * Copyright (C) 2009-19 by RStudio, PBC
+ * Copyright (C) 2009-20 by RStudio, PBC
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -52,6 +52,8 @@ public static String getShellName(String shell)
          return "Custom";
       case UserPrefs.POSIX_TERMINAL_SHELL_NONE:
          return "User command";
+      case UserPrefs.POSIX_TERMINAL_SHELL_ZSH:
+         return "Zsh";
       default:
          return "Unknown";
       }

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -232,14 +232,14 @@ public void onPanmirrorOutlineNavigation(PanmirrorOutlineNavigationEvent event)
       });
       
       
-      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.EditorEvents.Update, () -> {
+      editorEventUnsubscribe_.add(editor_.subscribe(PanmirrorEvents.Update, () -> {
          
          // fire to clients
          DomEvent.fireNativeEvent(Document.get().createChangeEvent(), handlers_);
       
       }));
       
-      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.EditorEvents.SelectionChange, () -> {
+      editorEventUnsubscribe_.add(editor_.subscribe(PanmirrorEvents.SelectionChange, () -> {
          
          // sync toolbar commands
          if (toolbar_ != null)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -1324,7 +1324,7 @@ public PrefValue<String> latexPreviewOnCursorIdle()
     */
    public PrefValue<Boolean> wrapTabNavigation()
    {
-      return bool("wrap_tab_navigation", false);
+      return bool("wrap_tab_navigation", true);
    }
 
    /**

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -456,4 +456,7 @@ public String toString()
    // AccessibilityPreferencesPane
    public final static String A11Y_GENERAL_PREFS = "a11y_general_prefs";
    public final static String A11Y_ANNOUNCEMENTS_PREFS = "a11y_announcements_prefs";
+   
+   // SatelliteWindow
+   public final static String SATELLITE_PANEL = "satellite_panel";
 }

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteWindow.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.common.satellite;
 
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.widget.AriaLiveStatusWidget;
@@ -65,7 +66,8 @@ public SatelliteWindow(Provider<EventBus> pEventBus,
 
       // create application panel
       mainPanel_ = new LayoutPanel();
-      
+      ElementIds.assignElementId(mainPanel_.getElement(), ElementIds.SATELLITE_PANEL);
+
       // Register an event handler for themes so it will be triggered after a
       // UIPrefsChangedEvent updates the theme. Do this after SessionInit (if we
       // do it beforehand we'll trigger the event before the SessionInfo object

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -456,4 +456,7 @@ public String toString()
    // AccessibilityPreferencesPane
    public final static String A11Y_GENERAL_PREFS = "a11y_general_prefs";
    public final static String A11Y_ANNOUNCEMENTS_PREFS = "a11y_announcements_prefs";
+   
+   // SatelliteWindow
+   public final static String SATELLITE_PANEL = "satellite_panel";
 }

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteWindow.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.common.satellite;
 
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.widget.AriaLiveStatusWidget;
@@ -65,7 +66,8 @@ public SatelliteWindow(Provider<EventBus> pEventBus,
 
       // create application panel
       mainPanel_ = new LayoutPanel();
-      
+      ElementIds.assignElementId(mainPanel_.getElement(), ElementIds.SATELLITE_PANEL);
+
       // Register an event handler for themes so it will be triggered after a
       // UIPrefsChangedEvent updates the theme. Do this after SessionInit (if we
       // do it beforehand we'll trigger the event before the SessionInfo object

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -248,7 +248,8 @@ public void onResponseReceived(String handle)
                                       {
                                          view_.clearMatches();
                                          currentFindHandle_ = handle;
-                                         dialogState_.clearResultsCount();
+                                         if (dialogState_ != null)
+                                            dialogState_.clearResultsCount();
                                       }
                                    });
          }
@@ -463,7 +464,6 @@ public void initialize(FindInFilesState state)
       view_.ensureVisible(false);
 
       currentFindHandle_ = state.getHandle();
-      dialogState_.clearResultsCount();
       view_.clearMatches();
       view_.addMatches(state.getResults().toArrayList());
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/CommitListTable.java
Patch:
@@ -227,7 +227,7 @@ public String getValue(CommitInfo object)
          @Override
          public String getValue(CommitInfo object)
          {
-            return object.getId();
+            return object.getId().substring(0, 8);
          }
       };
       addColumn(idCol, idColName);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/DiffFrame.java
Patch:
@@ -93,7 +93,7 @@ public DiffFrame(ImageResource icon,
          
          viewFileHyperlink_.setClickHandler(viewFileClickHandler);
          viewFileHyperlink_.setAlwaysUnderline(false);
-         viewFileHyperlink_.setText("View file @ " + commitId);
+         viewFileHyperlink_.setText("View file @ " + commitId.substring(0, 8));
          viewFileHyperlink_.addStyleName(RES.styles().viewFileHyperlink());
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPane.java
Patch:
@@ -193,7 +193,7 @@ public void openTutorial(String url)
    @Override
    public void home()
    {
-      frame_.setUrl(TutorialPresenter.URLS_HOME);
+      frame_.setUrl("." + TutorialPresenter.URLS_HOME);
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPresenter.java
Patch:
@@ -341,6 +341,6 @@ private void manageCommands()
    
    public static final String VIEWER_TYPE_TUTORIAL = "tutorial";
    
-   public static final String URLS_HOME = "./tutorial/home";
+   public static final String URLS_HOME = "/tutorial/home";
    
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPane.java
Patch:
@@ -193,7 +193,7 @@ public void openTutorial(String url)
    @Override
    public void home()
    {
-      frame_.setUrl(TutorialPresenter.URLS_HOME);
+      frame_.setUrl("." + TutorialPresenter.URLS_HOME);
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPresenter.java
Patch:
@@ -341,6 +341,6 @@ private void manageCommands()
    
    public static final String VIEWER_TYPE_TUTORIAL = "tutorial";
    
-   public static final String URLS_HOME = "./tutorial/home";
+   public static final String URLS_HOME = "/tutorial/home";
    
 }

File: src/gwt/src/org/rstudio/studio/client/panmirror/theme/PanmirrorThemeCreator.java
Patch:
@@ -16,12 +16,13 @@
 package org.rstudio.studio.client.panmirror.theme;
 
 import org.rstudio.core.client.dom.DomUtils;
+import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceTheme;
 
 import com.google.gwt.core.client.JsArrayString;
 
 public class PanmirrorThemeCreator
 {
-   public static PanmirrorTheme themeFromEditorTheme()
+   public static PanmirrorTheme themeFromEditorTheme(AceTheme aceTheme)
    {
       // create theme from current app theme
       PanmirrorTheme theme = new PanmirrorTheme(); 
@@ -76,7 +77,7 @@ public static PanmirrorTheme themeFromEditorTheme()
       code.attributeColor = theme.textColor;
       code.hrColor = theme.textColor;
       code.linkColor = theme.linkTextColor;
-      code.errorColor = DomUtils.extractCssValue("ace_constant", "color"); 
+      code.errorColor = DomUtils.extractCssValue(AceTheme.getThemeErrorClass(aceTheme), "color"); 
       theme.code = code;
       
       return theme;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -379,7 +379,7 @@ void onShowShortcutCommand()
       commands_.showShortcutCommand().setChecked(!commands_.showShortcutCommand().isChecked());
       ShortcutManager.INSTANCE.setReportShortcutBinding(commands_.showShortcutCommand().isChecked());
       if (commands_.showShortcutCommand().isChecked())
-         display_.showWarningBar(false, "Type a shortcut to see if it bound to a command.");
+         display_.showWarningBar(false, "Type a shortcut to see if it is bound to a command.");
       else
          display_.hideWarningBar();
    }

File: src/gwt/src/org/rstudio/core/client/command/KeyMap.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * KeyMap.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -132,15 +132,15 @@ public List<KeySequence> getBindings(String id)
       return keys;
    }
    
-   public CommandBinding getActiveBinding(KeySequence keys)
+   public CommandBinding getActiveBinding(KeySequence keys, boolean includeDisabled)
    {
       List<CommandBinding> commands = getBindings(keys);
       
       if (commands == null)
          return null;
       
       for (CommandBinding command : commands)
-         if (command.isEnabled())
+         if (command.isEnabled() || includeDisabled)
             return command;
       
       return null;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -649,4 +649,5 @@
    
    // Internal
    public abstract AppCommand showDomElements();
+   public abstract AppCommand showShortcutCommand();
 }

File: src/gwt/src/org/rstudio/studio/client/application/AriaLiveService.java
Patch:
@@ -39,6 +39,7 @@ public class AriaLiveService
    public static final String CONSOLE_LOG = "console_log";
    public static final String FILTERED_LIST = "filtered_list";
    public static final String GIT_MESSAGE_LENGTH = "git_message_length";
+   public static final String INACCESSIBLE_FEATURE = "inaccessible_feature";
    public static final String INFO_BAR = "info_bar";
    public static final String PROGRESS_COMPLETION = "progress_completion";
    public static final String PROGRESS_LOG = "progress_log";
@@ -66,6 +67,7 @@ public AriaLiveService(EventBus eventBus, Provider<UserPrefs> pUserPrefs)
       announcements_.put(CONSOLE_LOG, "Console output (requires restart)");
       announcements_.put(FILTERED_LIST, "Filtered result count");
       announcements_.put(GIT_MESSAGE_LENGTH, "Commit message length");
+      announcements_.put(INACCESSIBLE_FEATURE, "Inaccessible feature warning");
       announcements_.put(INFO_BAR, "Info bars");
       announcements_.put(PROGRESS_COMPLETION, "Task completion");
       announcements_.put(PROGRESS_LOG, "Task progress details");

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -281,8 +281,9 @@ private void loadScreenReaderEnabledSetting()
          {
             Timers.singleShot(AriaLiveService.STARTUP_ANNOUNCEMENT_DELAY, () ->
             {
+               String shortcut = commands_.toggleScreenReaderSupport().getShortcutRaw();
                ariaLive_.announce(AriaLiveService.SCREEN_READER_NOT_ENABLED,
-                     "Warning: screen reader mode not enabled. Turn on using shortcut Ctrl+Shift+Forward Slash.",
+                     "Warning: screen reader mode not enabled. Turn on using shortcut " + shortcut + ".",
                      Timing.IMMEDIATE, Severity.ALERT);
             });
          }

File: src/gwt/src/org/rstudio/studio/client/application/AriaLiveService.java
Patch:
@@ -39,6 +39,7 @@ public class AriaLiveService
    public static final String CONSOLE_LOG = "console_log";
    public static final String FILTERED_LIST = "filtered_list";
    public static final String GIT_MESSAGE_LENGTH = "git_message_length";
+   public static final String INACCESSIBLE_FEATURE = "inaccessible_feature";
    public static final String INFO_BAR = "info_bar";
    public static final String PROGRESS_COMPLETION = "progress_completion";
    public static final String PROGRESS_LOG = "progress_log";
@@ -66,6 +67,7 @@ public AriaLiveService(EventBus eventBus, Provider<UserPrefs> pUserPrefs)
       announcements_.put(CONSOLE_LOG, "Console output (requires restart)");
       announcements_.put(FILTERED_LIST, "Filtered result count");
       announcements_.put(GIT_MESSAGE_LENGTH, "Commit message length");
+      announcements_.put(INACCESSIBLE_FEATURE, "Inaccessible feature warning");
       announcements_.put(INFO_BAR, "Info bars");
       announcements_.put(PROGRESS_COMPLETION, "Task completion");
       announcements_.put(PROGRESS_LOG, "Task progress details");

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -281,8 +281,9 @@ private void loadScreenReaderEnabledSetting()
          {
             Timers.singleShot(AriaLiveService.STARTUP_ANNOUNCEMENT_DELAY, () ->
             {
+               String shortcut = commands_.toggleScreenReaderSupport().getShortcutRaw();
                ariaLive_.announce(AriaLiveService.SCREEN_READER_NOT_ENABLED,
-                     "Warning: screen reader mode not enabled. Turn on using shortcut Ctrl+Shift+Forward Slash.",
+                     "Warning: screen reader mode not enabled. Turn on using shortcut " + shortcut + ".",
                      Timing.IMMEDIATE, Severity.ALERT);
             });
          }

File: src/gwt/src/org/rstudio/studio/client/application/AriaLiveService.java
Patch:
@@ -39,6 +39,7 @@ public class AriaLiveService
    public static final String CONSOLE_LOG = "console_log";
    public static final String FILTERED_LIST = "filtered_list";
    public static final String GIT_MESSAGE_LENGTH = "git_message_length";
+   public static final String INACCESSIBLE_FEATURE = "inaccessible_feature";
    public static final String INFO_BAR = "info_bar";
    public static final String PROGRESS_COMPLETION = "progress_completion";
    public static final String PROGRESS_LOG = "progress_log";
@@ -66,6 +67,7 @@ public AriaLiveService(EventBus eventBus, Provider<UserPrefs> pUserPrefs)
       announcements_.put(CONSOLE_LOG, "Console output (requires restart)");
       announcements_.put(FILTERED_LIST, "Filtered result count");
       announcements_.put(GIT_MESSAGE_LENGTH, "Commit message length");
+      announcements_.put(INACCESSIBLE_FEATURE, "Inaccessible feature warning");
       announcements_.put(INFO_BAR, "Info bars");
       announcements_.put(PROGRESS_COMPLETION, "Task completion");
       announcements_.put(PROGRESS_LOG, "Task progress details");

File: src/gwt/src/org/rstudio/core/client/widget/ShortcutInfoPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShortcutInfoPanel.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -82,7 +82,7 @@ protected Widget getShortcutContent()
       String[][] groupNames = { 
             new String[] { "Tabs", "Panes", "Files", "Main Menu (Server)" },
             new String[] { "Source Navigation", "Execute" },
-            new String[] { "Source Editor", "Debug" }, 
+            new String[] { "Source Editor", "Debug", "Accessibility" }, 
             new String[] { "Source Control", "Build", "Console", "Terminal", "Other" }
       };
       int pctWidth = 100 / groupNames.length;

File: src/gwt/src/org/rstudio/core/client/widget/ShortcutInfoPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShortcutInfoPanel.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -82,7 +82,7 @@ protected Widget getShortcutContent()
       String[][] groupNames = { 
             new String[] { "Tabs", "Panes", "Files", "Main Menu (Server)" },
             new String[] { "Source Navigation", "Execute" },
-            new String[] { "Source Editor", "Debug" }, 
+            new String[] { "Source Editor", "Debug", "Accessibility" }, 
             new String[] { "Source Control", "Build", "Console", "Terminal", "Other" }
       };
       int pctWidth = 100 / groupNames.length;

File: src/gwt/src/org/rstudio/core/client/AnsiCode.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AnsiEscapeCode.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -598,7 +598,7 @@ else if (currentColor_.code() >= FOREGROUND_MIN && currentColor_.code() <= FOREG
     
    private void resetForeground()
    {
-      for (int i = 0; i < 255; i++)
+      for (int i = 0; i < 256; i++)
       {
          clazzes_.remove(Color.clazzForColorIndex(i, false /*background*/));
       }
@@ -607,7 +607,7 @@ private void resetForeground()
 
    private void resetBackground()
    {
-      for (int i = 0; i < 255; i++)
+      for (int i = 0; i < 256; i++)
       {
          clazzes_.remove(Color.clazzForColorIndex(i, true /*background*/));
       }

File: src/gwt/src/org/rstudio/core/client/AnsiCode.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AnsiEscapeCode.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -598,7 +598,7 @@ else if (currentColor_.code() >= FOREGROUND_MIN && currentColor_.code() <= FOREG
     
    private void resetForeground()
    {
-      for (int i = 0; i < 255; i++)
+      for (int i = 0; i < 256; i++)
       {
          clazzes_.remove(Color.clazzForColorIndex(i, false /*background*/));
       }
@@ -607,7 +607,7 @@ private void resetForeground()
 
    private void resetBackground()
    {
-      for (int i = 0; i < 255; i++)
+      for (int i = 0; i < 256; i++)
       {
          clazzes_.remove(Color.clazzForColorIndex(i, true /*background*/));
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * Commands.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -438,6 +438,7 @@
    public abstract AppCommand helpBack();
    public abstract AppCommand helpForward();
    public abstract AppCommand helpHome();
+   public abstract AppCommand helpSearch();
    public abstract AppCommand printHelp();
    public abstract AppCommand clearHelpHistory();
    public abstract AppCommand helpPopout();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -605,8 +605,7 @@ public void run()
    
    private void syncVisualModeOutlineLatchState()
    {
-      boolean visible = docUpdateSentinel_.getBoolProperty(
-            TextEditingTarget.DOC_OUTLINE_VISIBLE, false);
+      boolean visible = target_.getPreferredOutlineWidgetVisibility();
       toggleVisualModeOutlineButton_.setLatched(visible);
       String title = commands_.toggleDocumentOutline().getTooltip();
       title = visible ? title.replace("Show ", "Hide ") : title.replace("Hide ", "Show ");

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ThemeStyles.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -70,6 +70,7 @@ public interface ThemeStyles extends CssResource
    String webHeaderBarCommandsProjectMenu();
    String toolbarButton();
    String noLabel();
+   String popupButton();
    String toolbarButtonPushed();
    String emptyProjectMenu();
    String menuSubheader();

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -52,6 +52,7 @@
 import org.rstudio.core.client.dom.NativeWindow;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.studio.client.RStudioGinjector;
+import org.rstudio.studio.client.application.events.AriaLiveStatusEvent.Severity;
 import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.Timers;
 
@@ -824,9 +825,9 @@ public interface Resources extends ClientBundle
    }
 
    @Override
-   public void reportStatus(String status, int delayMs)
+   public void reportStatus(String status, int delayMs, Severity severity)
    {
-      ariaLiveStatusWidget_.reportStatus(status, delayMs);
+      ariaLiveStatusWidget_.reportStatus(status, delayMs, severity);
    }
 
    private static Resources RES = GWT.create(Resources.class);

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationView.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.widget.AriaLiveStatusReporter;
 import org.rstudio.core.client.widget.Operation;
+import org.rstudio.studio.client.application.events.AriaLiveStatusEvent.Severity;
 
 public interface ApplicationView extends AriaLiveStatusReporter
 {       
@@ -46,10 +47,9 @@ void showApplicationAgreement(String title,
    // error messages
    void showSessionAbendWarning();
    
-   // informative status message for screen reader users,
-   // announced at next graceful opportunity after given delay
+   // status or alert message for screen reader users,
    @Override
-   void reportStatus(String message, int delayMs);
+   void reportStatus(String message, int delayMs, Severity severity);
 
    // progress
    void showSerializationProgress(String message, 

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellOutputWriter.java
Patch:
@@ -22,6 +22,6 @@ public interface ShellOutputWriter
    void consoleWriteExtendedError(
          String string, UnhandledError traceInfo, 
          boolean expand, String command);
-   void consoleWriteOutput(String output) ;
+   void consoleWriteOutput(String output);
    void consoleWritePrompt(String prompt);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/model/FilesServerOperations.java
Patch:
@@ -34,6 +34,9 @@ void isTextFile(String path,
    void isGitDirectory(String path,
                        ServerRequestCallback<Boolean> requestCallback);
 
+   void isPackageDirectory(String path,
+                           ServerRequestCallback<Boolean> requestCallback);
+
    void getFileContents(String path,
                         String encoding,
                         ServerRequestCallback<String> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/events/HasHelpNavigateHandlers.java
Patch:
@@ -19,5 +19,5 @@
 
 public interface HasHelpNavigateHandlers extends HasHandlers
 {
-   HandlerRegistration addHelpNavigateHandler(HelpNavigateHandler handler) ;
+   HandlerRegistration addHelpNavigateHandler(HelpNavigateHandler handler);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/events/HelpNavigateHandler.java
Patch:
@@ -18,5 +18,5 @@
 
 public interface HelpNavigateHandler extends EventHandler
 {
-   public void onNavigate(HelpNavigateEvent event) ;
+   public void onNavigate(HelpNavigateEvent event);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/model/HelpServerOperations.java
Patch:
@@ -32,7 +32,7 @@ void getHelp(String topic,
    void showHelpTopic(String topic, String pkgName, int type);
 
    void search(String query, 
-               ServerRequestCallback<JsArrayString> requestCallback) ;
+               ServerRequestCallback<JsArrayString> requestCallback);
    
    void getCustomHelp(String helpHandler,
                       String topic,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/model/VirtualHistory.java
Patch:
@@ -61,10 +61,10 @@ public void navigate(String url)
    {
       // truncate the stack to the current pos
       while (stack_.size() > pos_ + 1)
-         stack_.remove(stack_.size() - 1) ;
+         stack_.remove(stack_.size() - 1);
       
       saveScrollPosition();
-      stack_.add(new Data(url)) ;
+      stack_.add(new Data(url));
       pos_ = stack_.size() - 1;
    }
 
@@ -85,7 +85,7 @@ public Data forward()
          return null;
       
       saveScrollPosition();
-      pos_++ ;
+      pos_++;
 
       return stack_.get(pos_);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -67,6 +67,8 @@
 import org.rstudio.studio.client.application.ApplicationUtils;
 import org.rstudio.studio.client.application.AriaLiveService;
 import org.rstudio.studio.client.application.Desktop;
+import org.rstudio.studio.client.application.events.AriaLiveStatusEvent.Severity;
+import org.rstudio.studio.client.application.events.AriaLiveStatusEvent.Timing;
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.FileDialogs;
@@ -4209,7 +4211,7 @@ public void onSpeakEditorLocation()
       {
          announcement = activeEditor_.getCurrentStatus();
       }
-      ariaLive_.reportStatus(AriaLiveService.ON_DEMAND, announcement);
+      ariaLive_.announce(AriaLiveService.ON_DEMAND, announcement, Timing.IMMEDIATE, Severity.STATUS);
    }
    
    @Handler

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -125,7 +125,8 @@ public native final int getResultsCount() /*-{
       }-*/;
 
       public native final void clearResultsCount() /*-{
-         this.resultsCount = 0;
+         if (this.resultsCount != null)
+            this.resultsCount = 0;
       }-*/;
 
       public native final void updateErrorCount(int count) /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -463,7 +463,6 @@ public void initialize(FindInFilesState state)
       view_.ensureVisible(false);
 
       currentFindHandle_ = state.getHandle();
-      dialogState_.clearResultsCount();
       view_.clearMatches();
       view_.addMatches(state.getResults().toArrayList());
 

File: src/gwt/test/org/rstudio/core/client/VirtualConsoleTests.java
Patch:
@@ -1024,8 +1024,8 @@ public void testScreenReaderOffNoTextNotCaptured()
    {
       PreElement ele = Document.get().createPreElement();
       VirtualConsole vc = getVC(ele);
-      vc.submit("Hello World", "someclass");
-      Assert.assertNull(vc.getNewText());
+      vc.submit("Hello World", "someclass", false, true);
+      Assert.assertEquals(vc.getNewText(), "");
    }
 
    public void testScreenReaderOnTextCaptured()
@@ -1035,7 +1035,7 @@ public void testScreenReaderOnTextCaptured()
       prefs.screenReaderEnabled_ = true;
       VirtualConsole vc = new VirtualConsole(ele, prefs);
       String text = "Hello World\nHow are you?";
-      vc.submit(text, "someclass");
+      vc.submit(text, "someclass", false, true);
       String newText = vc.getNewText();
       Assert.assertEquals(newText, text);
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -74,7 +74,7 @@ public static class Options
       public boolean toolbar = true;
       public boolean outline = false;
       public double outlineWidth = 190;
-      public boolean border = true;
+      public boolean border = false;
    }
    
    public static void create(PanmirrorConfig config,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetVisualMode.java
Patch:
@@ -25,10 +25,12 @@
 import com.google.inject.Inject;
 
 // TODO: propogate edits as they happen (w/ 1 second delay)
+// TODO: shortcut overlap / routing / remapping
 // TOOD: command / keyboard shortcut for entering visual mode
 // TODO: panmirror outline visibility and width
 // TODO: introduce global pref to toggle availabilty of visual mode
 // TODO: disable additional source-editing commands in visual mode
+// TODO: wire up find and replace actions to panmirror stubs
 // TODO: bump toolbar icons down 1 pixel
 // TODO: standard editor dialog boxes
 
@@ -92,7 +94,6 @@ private void withPanmirror(Command ready)
          PanmirrorConfig config = new PanmirrorConfig();
          config.options.rmdCodeChunks = true;
          PanmirrorWidget.Options options = new PanmirrorWidget.Options();
-         options.border = false;
          
          PanmirrorWidget.create(config, options, (panmirror) -> {
             panmirror_ = panmirror;

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -52,6 +52,7 @@
 import org.rstudio.core.client.dom.NativeWindow;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.studio.client.RStudioGinjector;
+import org.rstudio.studio.client.application.events.AriaLiveStatusEvent.Severity;
 import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.Timers;
 
@@ -824,9 +825,9 @@ public interface Resources extends ClientBundle
    }
 
    @Override
-   public void reportStatus(String status, int delayMs)
+   public void reportStatus(String status, int delayMs, Severity severity)
    {
-      ariaLiveStatusWidget_.reportStatus(status, delayMs);
+      ariaLiveStatusWidget_.reportStatus(status, delayMs, severity);
    }
 
    private static Resources RES = GWT.create(Resources.class);

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationView.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.widget.AriaLiveStatusReporter;
 import org.rstudio.core.client.widget.Operation;
+import org.rstudio.studio.client.application.events.AriaLiveStatusEvent.Severity;
 
 public interface ApplicationView extends AriaLiveStatusReporter
 {       
@@ -46,10 +47,9 @@ void showApplicationAgreement(String title,
    // error messages
    void showSessionAbendWarning();
    
-   // informative status message for screen reader users,
-   // announced at next graceful opportunity after given delay
+   // status or alert message for screen reader users,
    @Override
-   void reportStatus(String message, int delayMs);
+   void reportStatus(String message, int delayMs, Severity severity);
 
    // progress
    void showSerializationProgress(String message, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -67,6 +67,8 @@
 import org.rstudio.studio.client.application.ApplicationUtils;
 import org.rstudio.studio.client.application.AriaLiveService;
 import org.rstudio.studio.client.application.Desktop;
+import org.rstudio.studio.client.application.events.AriaLiveStatusEvent.Severity;
+import org.rstudio.studio.client.application.events.AriaLiveStatusEvent.Timing;
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.FileDialogs;
@@ -4209,7 +4211,7 @@ public void onSpeakEditorLocation()
       {
          announcement = activeEditor_.getCurrentStatus();
       }
-      ariaLive_.reportStatus(AriaLiveService.ON_DEMAND, announcement);
+      ariaLive_.announce(AriaLiveService.ON_DEMAND, announcement, Timing.IMMEDIATE, Severity.STATUS);
    }
    
    @Handler

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -245,7 +245,7 @@ private void setScreenReaderMenuState(boolean checked)
 
    /**
     * Screen-reader enabled setting is stored differently on desktop vs server.
-    * On desktop is must be available earlier in startup so the RStudio.app/exe native
+    * On desktop it must be available earlier in startup so the RStudio.app/exe native
     * code can configure Chromium. Fetching that is async and we want interested parties
     * to be able to check it synchronously. So we cache it. Changing this setting
     * requires a reload of the UI to fully take effect.

File: src/gwt/src/org/rstudio/studio/client/application/ui/ApplicationWindow.java
Patch:
@@ -296,7 +296,8 @@ public void showSerializationProgress(String msg,
       
       // create and show progress
       activeSerializationProgress_ = 
-                    new ApplicationSerializationProgress(msg, modal, delayMs);
+                    new ApplicationSerializationProgress(msg, modal, delayMs,
+                          !ariaLive_.isDisabled(AriaLiveService.SESSION_STATE));
       
       // implement timeout for *this* serialization progress instance if 
       // requested (check to ensure the same instance because another 

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -111,6 +111,7 @@ public static String idFromLabel(String label)
 
    // global list of specific IDs we assign -- we keep this list centralized in this class as a
    // so that we can be sure an ID is not used elsewhere in the product
+   public final static String RSTUDIO_LOGO = "rstudio_logo";
    public final static String CONSOLE_INPUT = "console_input";
    public final static String CONSOLE_OUTPUT = "console_output";
    public final static String DEPLOY_CONTENT = "deploy_content";

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -124,6 +124,7 @@ public void initialize(
 
       // link target for logo
       logoAnchor_ = new Anchor();
+      ElementIds.assignElementId(logoAnchor_, ElementIds.RSTUDIO_LOGO);
       Style style = logoAnchor_.getElement().getStyle();
       style.setPosition(Position.ABSOLUTE);
       style.setLeft(18, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -595,6 +595,7 @@ private void setDocOutlineLatchState(boolean latched)
    {
       toggleDocOutlineButton_.setLatched(latched);
       docOutlineWidget_.setAriaVisible(latched);
+      docOutlineWidget_.setTabIndex(latched ? 0 : -1);
    }
    
    private ToolbarButton createLatexFormatButton()

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -448,4 +448,7 @@ public String toString()
    public final static String FRAME_MAX_BTN = "frame_max_btn";
    public final static String MIN_FRAME_MIN_BTN = "min_frame_min_btn";
    public final static String MIN_FRAME_MAX_BTN = "min_frame_max_btn";
+
+   // ProgressDialog
+   public final static String PROGRESS_TITLE_LABEL = "progress_title_label";
 }

File: src/gwt/src/org/rstudio/core/client/ScrollUtil.java
Patch:
@@ -15,7 +15,6 @@
 package org.rstudio.core.client;
 
 import org.rstudio.core.client.widget.RStudioFrame;
-import org.rstudio.studio.client.workbench.views.viewer.ViewerPane;
 
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.RepeatingCommand;

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -47,7 +47,6 @@
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.Point;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.command.ShortcutManager;
 import org.rstudio.core.client.command.ShortcutManager.Handle;
 import org.rstudio.core.client.dom.DomUtils;

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplicationSatellite.java
Patch:
@@ -24,7 +24,6 @@
 
 import com.google.inject.Inject;
 import com.google.inject.Provider;
-import com.google.inject.Singleton;
 
 public class ShinyApplicationSatellite extends SatelliteApplication
 {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -46,7 +46,6 @@
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefsAccessor;
 import org.rstudio.studio.client.workbench.ui.FontSizeManager;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
-import org.rstudio.studio.client.workbench.views.console.Console;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.NewWorkingCopyEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.SwitchToTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStartedEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/dialog/GitReviewPanel.java
Patch:
@@ -14,7 +14,6 @@
  */
 package org.rstudio.studio.client.workbench.views.vcs.git.dialog;
 
-import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.ScheduledCommand;

File: src/gwt/src/org/rstudio/studio/client/panmirror/dialogs/PanmirrorTestDialog.java
Patch:
@@ -33,7 +33,7 @@ public PanmirrorTestDialog()
      
       
       PanmirrorWidget.Options options = new PanmirrorWidget.Options();
-      options.toolbar = true;
+   
       
       PanmirrorWidget.create(config, options, editorWidget -> {
          if (editorWidget != null) {
@@ -86,7 +86,7 @@ public void onSelectionChange(SelectionChangeEvent event)
                   
                   this.editorWidget_.enableDevTools();
                   
-                  this.editorWidget_.showOutline(true);
+                  // this.editorWidget_.showOutline(true);
                }
             });
          }

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShellWidget.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -593,7 +593,7 @@ public void onKeyDown(KeyDownEvent event)
                   return;
                break;
             case KeyCodes.KEY_TAB:
-               if (prefs_.tabKeyMoveFocus().getValue())
+               if (prefs_ == null || prefs_.tabKeyMoveFocus().getValue())
                   return;
          }
          input_.setFocus(true);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPresenter.java
Patch:
@@ -341,6 +341,6 @@ private void manageCommands()
    
    public static final String VIEWER_TYPE_TUTORIAL = "tutorial";
    
-   public static final String URLS_HOME = "/tutorial/home";
+   public static final String URLS_HOME = "./tutorial/home";
    
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPresenter.java
Patch:
@@ -341,6 +341,6 @@ private void manageCommands()
    
    public static final String VIEWER_TYPE_TUTORIAL = "tutorial";
    
-   public static final String URLS_HOME = "/tutorial/home";
+   public static final String URLS_HOME = "./tutorial/home";
    
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/DiffFrame.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DiffFrame.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -25,6 +25,7 @@
 import com.google.gwt.user.client.ui.*;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.theme.res.ThemeResources;
+import org.rstudio.core.client.widget.DecorativeImage;
 import org.rstudio.core.client.widget.HyperlinkLabel;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.filetypes.FileIcon;
@@ -111,7 +112,7 @@ public static void ensureStylesInjected()
    @UiField
    Image fileIcon_;
    @UiField
-   Image separatorImage_;
+   DecorativeImage separatorImage_;
    @UiField
    HyperlinkLabel viewFileHyperlink_;
    

File: src/gwt/src/org/rstudio/studio/client/panmirror/Panmirror.java
Patch:
@@ -32,8 +32,8 @@ public static void load(ExternalJavaScriptLoader.Callback onLoaded) {
       panmirrorLoader_.addCallback(onLoaded);
    }
    
-   public static PanmirrorEvents Events;
-   public static PanmirrorCommands Commands;
+   public static PanmirrorEvents EditorEvents;
+   public static PanmirrorCommands EditorCommands;
    
    
    

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -81,12 +81,12 @@ private void attachEditor(PanmirrorEditor editor) {
       editor_ = editor;
       commands_ = editor.commands();
       
-      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.Events.Update, () -> {
+      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.EditorEvents.Update, () -> {
          DomEvent.fireNativeEvent(Document.get().createChangeEvent(), handlers_);
       }));
       
      
-      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.Events.SelectionChange, () -> {
+      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.EditorEvents.SelectionChange, () -> {
          SelectionChangeEvent.fire(this);
       }));
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorTestDialog.java
Patch:
@@ -37,7 +37,7 @@ public PanmirrorTestDialog()
             mainWidget_.add(this.editorWidget_);
             
             PanmirrorKeybindings keys = new PanmirrorKeybindings();
-            keys.add(Panmirror.Commands.Strong, new String[]{"Mod-5"});
+            keys.add(Panmirror.EditorCommands.Strong, new String[]{"Mod-5"});
             this.editorWidget_.setKeybindings(keys);
             
             this.editorWidget_.addChangeHandler(new ChangeHandler()
@@ -67,7 +67,7 @@ public void onSelectionChange(SelectionChangeEvent event)
                if (success) 
                {  
                   
-                  this.editorWidget_.execCommand(Panmirror.Commands.SelectAll);
+                  this.editorWidget_.execCommand(Panmirror.EditorCommands.SelectAll);
                   
                   this.editorWidget_.getMarkdown(markdown -> {
                      Debug.logToConsole(markdown);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindInFilesServerOperations.java
Patch:
@@ -25,7 +25,7 @@ void beginFind(String searchString,
                   boolean regex,
                   boolean ignoreCase,
                   FileSystemItem directory,
-                  JsArrayString filePatterns,
+                  JsArrayString includeFilePatterns,
                   JsArrayString excludeFilePatterns,
                   ServerRequestCallback<String> requestCallback);
 
@@ -38,7 +38,7 @@ void previewReplace(String searchString,
                        boolean regex,
                        boolean searchIgnoreCase,
                        FileSystemItem dictionary,
-                       JsArrayString filePatterns,
+                       JsArrayString includeFilePatterns,
                        JsArrayString excludeFilePatterns,
                        String replaceString,
                        ServerRequestCallback<String> requestCallback);
@@ -47,7 +47,7 @@ void completeReplace(String searchString,
                         boolean regex,
                         boolean searchIgnoreCase,
                         FileSystemItem dictionary,
-                        JsArrayString filePatterns,
+                        JsArrayString includeFilePatterns,
                         JsArrayString excludeFilePatterns,
                         int searchResults,
                         String replaceString,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -108,7 +108,7 @@ public final String[] getExcludeFilePatterns()
       private native JsArrayString getExcludeFilePatternsNative() /*-{
 
          if (!this.excludeFilePatterns)
-            this.excludeFilePatterns="";
+            this.excludeFilePatterns = [];
          return this.excludeFilePatterns;
       }-*/;
 
@@ -228,7 +228,7 @@ protected State collectInput()
       String excludeFilePatterns =
          listPresetExcludeFilePatterns_.getValue(
                listPresetExcludeFilePatterns_.getSelectedIndex());
-      if (excludeFilePatterns == "custom")
+      if (StringUtil.equals(excludeFilePatterns, "custom"))
          excludeFilePatterns = txtExcludeFilePattern_.getText();
 
       ArrayList<String> excludeList = new ArrayList<String>();

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorConfig.java
Patch:
@@ -23,7 +23,6 @@
 import jsinterop.annotations.JsType;
 
 // TODO: keybindings
-// TODO: events more like commands
 
 @JsType
 public class PanmirrorConfig

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorWidget.java
Patch:
@@ -81,12 +81,12 @@ private void attachEditor(PanmirrorEditor editor) {
       editor_ = editor;
       commands_ = editor.commands();
       
-      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.kEventUpdate, () -> {
+      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.Events.Update, () -> {
          DomEvent.fireNativeEvent(Document.get().createChangeEvent(), handlers_);
       }));
       
      
-      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.kEventSelectionChange, () -> {
+      editorEventUnsubscribe_.add(editor_.subscribe(Panmirror.Events.SelectionChange, () -> {
          SelectionChangeEvent.fire(this);
       }));
    }

File: src/gwt/src/org/rstudio/studio/client/panmirror/command/PanmirrorCommands.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * PanmirrorCommandId.java
+ * PanmirrorCommands.java
  *
  * Copyright (C) 2009-20 by RStudio, Inc.
  *
@@ -17,8 +17,8 @@
 
 import jsinterop.annotations.JsType;
 
-@JsType(isNative = true, name="EditorCommandId", namespace = "Panmirror")
-public class PanmirrorCommandId
+@JsType(isNative = true)
+public class PanmirrorCommands
 {
    // editing
    public String Undo;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -65,7 +65,7 @@
 import org.rstudio.studio.client.htmlpreview.HTMLPreviewApplication;
 import org.rstudio.studio.client.notebook.CompileNotebookOptionsDialog;
 import org.rstudio.studio.client.panmirror.pandoc.PanmirrorPandocEngine;
-import org.rstudio.studio.client.panmirror.ui.PanmirrorEditorDialogs;
+import org.rstudio.studio.client.panmirror.ui.PanmirrorDialogs;
 import org.rstudio.studio.client.plumber.PlumberAPI;
 import org.rstudio.studio.client.plumber.PlumberAPISatellite;
 import org.rstudio.studio.client.plumber.ui.PlumberViewerTypePopupMenu;
@@ -287,7 +287,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(JobsPresenterEventHandlersImpl jobPresenterBaseImpl);
    void injectMembers(JobsDisplayImpl jobDisplayBaseImpl);
    void injectMembers(PanmirrorPandocEngine panmirrorPandocEngine);
-   void injectMembers(PanmirrorEditorDialogs panmirrorEditorUI);
+   void injectMembers(PanmirrorDialogs panmirrorEditorUI);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorEditor.java
Patch:
@@ -31,7 +31,7 @@
 @JsType(isNative = true, name="Editor", namespace = "Panmirror")
 public class PanmirrorEditor
 {
-   public native static Promise<PanmirrorEditor> create(Element parent, PanmirrorEditorConfig config);
+   public native static Promise<PanmirrorEditor> create(Element parent, PanmirrorConfig config);
    
    public native void destroy();
    

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorHooks.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * PanmirrorEditorHooks.java
+ * PanmirrorHooks.java
  *
  * Copyright (C) 2009-20 by RStudio, Inc.
  *
@@ -19,7 +19,7 @@
 import jsinterop.annotations.JsType;
 
 @JsType
-public class PanmirrorEditorHooks
+public class PanmirrorHooks
 {
    
    public IsEditable isEditable;

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorOptions.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * PanmirrorEditorOptions.java
+ * PanmirrorOptions.java
  *
  * Copyright (C) 2009-20 by RStudio, Inc.
  *
@@ -19,7 +19,7 @@
 import jsinterop.annotations.JsType;
 
 @JsType
-public class PanmirrorEditorOptions
+public class PanmirrorOptions
 {    
    public boolean autoFocus;
    public boolean spellCheck;

File: src/gwt/src/org/rstudio/studio/client/panmirror/ui/PanmirrorUI.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * PanmirrorEditorUI.java
+ * PanmirrorUI.java
  *
  * Copyright (C) 2009-20 by RStudio, Inc.
  *
@@ -19,7 +19,7 @@
 import jsinterop.annotations.JsType;
 
 @JsType
-public class PanmirrorEditorUI
+public class PanmirrorUI
 {    
-   public PanmirrorEditorDialogs dialogs = new PanmirrorEditorDialogs();
+   public PanmirrorDialogs dialogs = new PanmirrorDialogs();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindInFilesServerOperations.java
Patch:
@@ -25,7 +25,7 @@ void beginFind(String searchString,
                   boolean regex,
                   boolean ignoreCase,
                   FileSystemItem directory,
-                  JsArrayString filePatterns,
+                  JsArrayString includeFilePatterns,
                   JsArrayString excludeFilePatterns,
                   ServerRequestCallback<String> requestCallback);
 
@@ -38,7 +38,7 @@ void previewReplace(String searchString,
                        boolean regex,
                        boolean searchIgnoreCase,
                        FileSystemItem dictionary,
-                       JsArrayString filePatterns,
+                       JsArrayString includeFilePatterns,
                        JsArrayString excludeFilePatterns,
                        String replaceString,
                        ServerRequestCallback<String> requestCallback);
@@ -47,7 +47,7 @@ void completeReplace(String searchString,
                         boolean regex,
                         boolean searchIgnoreCase,
                         FileSystemItem dictionary,
-                        JsArrayString filePatterns,
+                        JsArrayString includeFilePatterns,
                         JsArrayString excludeFilePatterns,
                         int searchResults,
                         String replaceString,

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ModalDialogBase.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -84,7 +84,6 @@ protected ModalDialogBase(SimplePanel containerPanel, DialogRole role)
       // a11y
       role_ = role;
       role_.set(getElement());
-      A11y.setARIADialogModal(getElement());
 
       // main panel used to host UI
       mainPanel_ = new VerticalPanel();

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ModalDialogBase.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -84,7 +84,6 @@ protected ModalDialogBase(SimplePanel containerPanel, DialogRole role)
       // a11y
       role_ = role;
       role_.set(getElement());
-      A11y.setARIADialogModal(getElement());
 
       // main panel used to host UI
       mainPanel_ = new VerticalPanel();

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -84,7 +84,7 @@
 import org.rstudio.studio.client.htmlpreview.ui.HTMLPreviewApplicationWindow;
 import org.rstudio.studio.client.htmlpreview.ui.HTMLPreviewPanel;
 import org.rstudio.studio.client.packrat.model.PackratServerOperations;
-import org.rstudio.studio.client.panmirror.model.PanmirrorServerOperations;
+import org.rstudio.studio.client.panmirror.pandoc.PanmirrorServerOperations;
 import org.rstudio.studio.client.pdfviewer.PDFViewer;
 import org.rstudio.studio.client.plumber.PlumberAPI;
 import org.rstudio.studio.client.plumber.PlumberAPIPresenter;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -64,7 +64,7 @@
 import org.rstudio.studio.client.common.spelling.ui.SpellingCustomDictionariesWidget;
 import org.rstudio.studio.client.htmlpreview.HTMLPreviewApplication;
 import org.rstudio.studio.client.notebook.CompileNotebookOptionsDialog;
-import org.rstudio.studio.client.panmirror.model.PanmirrorPandocEngine;
+import org.rstudio.studio.client.panmirror.pandoc.PanmirrorPandocEngine;
 import org.rstudio.studio.client.panmirror.ui.PanmirrorEditorDialogs;
 import org.rstudio.studio.client.plumber.PlumberAPI;
 import org.rstudio.studio.client.plumber.PlumberAPISatellite;

File: src/gwt/src/org/rstudio/studio/client/panmirror/PanmirrorEditorConfig.java
Patch:
@@ -15,7 +15,7 @@
 
 package org.rstudio.studio.client.panmirror;
 
-import org.rstudio.studio.client.panmirror.model.PanmirrorPandocEngine;
+import org.rstudio.studio.client.panmirror.pandoc.PanmirrorPandocEngine;
 import org.rstudio.studio.client.panmirror.ui.PanmirrorEditorUI;
 
 

File: src/gwt/src/org/rstudio/studio/client/panmirror/pandoc/PanmirrorPandocEngine.java
Patch:
@@ -13,7 +13,7 @@
  *
  */
 
-package org.rstudio.studio.client.panmirror.model;
+package org.rstudio.studio.client.panmirror.pandoc;
 
 import org.rstudio.core.client.promise.PromiseServerRequestCallback;
 import org.rstudio.studio.client.RStudioGinjector;

File: src/gwt/src/org/rstudio/studio/client/panmirror/pandoc/PanmirrorServerOperations.java
Patch:
@@ -13,7 +13,7 @@
  *
  */
 
-package org.rstudio.studio.client.panmirror.model;
+package org.rstudio.studio.client.panmirror.pandoc;
 
 import org.rstudio.studio.client.server.ServerRequestCallback;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -28,7 +28,7 @@
 import org.rstudio.studio.client.common.vcs.GitServerOperations;
 import org.rstudio.studio.client.common.vcs.SVNServerOperations;
 import org.rstudio.studio.client.packrat.model.PackratServerOperations;
-import org.rstudio.studio.client.panmirror.model.PanmirrorServerOperations;
+import org.rstudio.studio.client.panmirror.pandoc.PanmirrorServerOperations;
 import org.rstudio.studio.client.projects.model.ProjectTemplateServerOperations;
 import org.rstudio.studio.client.projects.model.ProjectsServerOperations;
 import org.rstudio.studio.client.renv.model.RenvServerOperations;

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DataTable.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -52,6 +52,7 @@ public void initToolbar(Toolbar toolbar, boolean isPreview)
       filterButton_ = new LatchingToolbarButton(
               "Filter",
               ToolbarButton.NoTitle,
+              false, /* textIndicatesState */
               new ImageResource2x(DataViewerResources.INSTANCE.filterIcon2x()),
               new ClickHandler() {
                  public void onClick(ClickEvent event)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -506,6 +506,7 @@ private Toolbar createToolbar(TextFileType fileType)
       toggleDocOutlineButton_ = new LatchingToolbarButton(
             ToolbarButton.NoText,
             ToolbarButton.NoTitle,
+            true, /* textIndicatesState */
             new ImageResource2x(StandardIcons.INSTANCE.outline2x()),
             event -> {
                final double initialSize = editorPanel_.getWidgetSize(docOutlineWidget_);

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteWindow.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SatelliteWindow.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -144,7 +144,7 @@ public void onResize()
    @Override
    public void onAriaLiveStatus(AriaLiveStatusEvent event)
    {
-      int delayMs = RStudioGinjector.INSTANCE.getUserPrefs().typingStatusDelayMs().getValue();
+      int delayMs = event.getImmediate() ? 0 : RStudioGinjector.INSTANCE.getUserPrefs().typingStatusDelayMs().getValue();
       if (!ModalDialogTracker.dispatchAriaLiveStatus(event.getMessage(), delayMs))
          ariaLiveStatusWidget_.announce(event.getMessage(), delayMs);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -640,6 +640,7 @@
    public abstract AppCommand toggleTabKeyMovesFocus();
    public abstract AppCommand showAccessibilityOptions();
    public abstract AppCommand focusMainToolbar();
+   public abstract AppCommand speakEditorLocation();
    
    // Internal
    public abstract AppCommand showDomElements();

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedModuleTabLayoutPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * MinimizedModuleTabLayoutPanel.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -30,9 +30,9 @@ public class MinimizedModuleTabLayoutPanel
       extends MinimizedWindowFrame
    implements HasSelectionHandlers<Integer>
 {
-   public MinimizedModuleTabLayoutPanel()
+   public MinimizedModuleTabLayoutPanel(String accessibleName)
    {
-      super(null, new HorizontalPanel());
+      super(null, accessibleName, new HorizontalPanel());
       addStyleName(ThemeResources.INSTANCE.themeStyles().moduleTabPanel());
       addStyleName(ThemeResources.INSTANCE.themeStyles().minimized());
    }

File: src/gwt/src/org/rstudio/core/client/theme/PrimaryWindowFrame.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PrimaryWindowFrame.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -45,6 +45,7 @@ public HandlerRegistration addMouseDownHandler(MouseDownHandler handler)
    public PrimaryWindowFrame(String title,
                              Widget mainWidget)
    {
+      super(title);
       ThemeStyles styles = ThemeResources.INSTANCE.themeStyles();
 
       panel_ = new ClickFlowPanel();

File: src/gwt/src/org/rstudio/studio/client/application/ui/WarningBar.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * WarningBar.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -35,8 +35,8 @@
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.Button;
 import com.google.gwt.user.client.ui.Composite;
-import com.google.gwt.user.client.ui.Image;
 import com.google.gwt.user.client.ui.Widget;
+import org.rstudio.core.client.widget.ImageButton;
 import org.rstudio.studio.client.application.Desktop;
 
 public class WarningBar extends Composite
@@ -140,7 +140,7 @@ public HandlerRegistration addCloseHandler(CloseHandler<WarningBar> handler)
    @UiField
    Button moreButton_;
    @UiField
-   Image dismiss_;
+   ImageButton dismiss_;
 
    private static final Styles styles_ =
          ((Resources) GWT.create(Resources.class)).styles();

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -250,6 +250,7 @@ public void showToolbar(boolean showToolbar)
          }
          HeaderPanel headerPanel = new HeaderPanel(headerBarPanel_, toolbar_);
          Roles.getNavigationRole().set(headerPanel.getElement());
+         Roles.getNavigationRole().setAriaLabelProperty(headerPanel.getElement(), "Main menu and toolbar");
          outerPanel_.add(headerPanel);
          preferredHeight_ = 65;
          showProjectMenu(false);
@@ -264,6 +265,7 @@ public void showToolbar(boolean showToolbar)
          }
          MenubarPanel menubarPanel = new MenubarPanel(headerBarPanel_);
          Roles.getNavigationRole().set(menubarPanel.getElement());
+         Roles.getNavigationRole().setAriaLabelProperty(menubarPanel.getElement(), "Main menu");
          outerPanel_.add(menubarPanel);
          preferredHeight_ = 45;
          showProjectMenu(true);

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchScreen.java
Patch:
@@ -124,6 +124,7 @@ public void execute()
       tabsPanel_.setSize("100%", "100%");
       tabsPanel_.addStyleDependentName("Workbench");
       Roles.getMainRole().set(tabsPanel_.getElement());
+      Roles.getMainRole().setAriaLabelProperty(tabsPanel_.getElement(), "Workbench");
 
       // Prevent doOnPaneSizesChanged() from being called more than once
       // every N milliseconds. Note that the act of sending the client metrics

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DesktopApplicationHeader.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -16,7 +16,6 @@
 
 import java.util.ArrayList;
 
-import com.google.gwt.aria.client.Roles;
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppMenuBar;
@@ -244,7 +243,6 @@ private void addSignoutToolbar()
          usernameLabel.setTitle(userIdentity);
          userIdentity = userIdentity.split("@")[0];
          usernameLabel.setText(userIdentity);
-         Roles.getPresentationRole().setAriaLabelProperty(usernameLabel.getElement(), "Username");
 
          addRightCommand(usernameLabel);
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -425,7 +425,6 @@ private void initCommandsPanel(final SessionInfo sessionInfo)
          usernameLabel.setTitle(userIdentity);
          userIdentity = userIdentity.split("@")[0];
          usernameLabel.setText(userIdentity);
-         Roles.getPresentationRole().setAriaLabelProperty(usernameLabel.getElement(), "Username");
          headerBarCommandsPanel_.add(usernameLabel);
          
          overlayUserCommandsPanel_ = new HorizontalPanel();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionExplorer.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ConnectionExplorer.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -54,7 +54,7 @@ public ConnectionExplorer()
       disconnectedUI_.add(codePanel_);
       Label label = new Label("(Not connected)");
       Style labelStyle = label.getElement().getStyle();
-      labelStyle.setColor("#888");
+      labelStyle.setColor("#767676");
       labelStyle.setMarginTop(25, Unit.PX);
       labelStyle.setTextAlign(TextAlign.CENTER);
       disconnectedUI_.add(label);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/common/CompileOutputPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * CompileOutputPane.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -58,7 +58,7 @@ protected Widget createMainWidget()
    @Override
    protected Toolbar createMainToolbar()
    {
-      Toolbar toolbar = new Toolbar("Compile Output Tab");
+      Toolbar toolbar = new Toolbar(getTitle() + " Tab");
       
       fileLabel_ = new ToolbarFileLabel(toolbar, 200);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AceEditorNative.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -201,7 +201,7 @@ public void removeHandler()
       };
    }
 
-   private native Element getTextInputElement() /*-{
+   public final native Element getTextInputElement() /*-{
       return this.textInput.getElement();
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DesktopApplicationHeader.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -16,7 +16,6 @@
 
 import java.util.ArrayList;
 
-import com.google.gwt.aria.client.Roles;
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppMenuBar;
@@ -244,7 +243,6 @@ private void addSignoutToolbar()
          usernameLabel.setTitle(userIdentity);
          userIdentity = userIdentity.split("@")[0];
          usernameLabel.setText(userIdentity);
-         Roles.getPresentationRole().setAriaLabelProperty(usernameLabel.getElement(), "Username");
 
          addRightCommand(usernameLabel);
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -425,7 +425,6 @@ private void initCommandsPanel(final SessionInfo sessionInfo)
          usernameLabel.setTitle(userIdentity);
          userIdentity = userIdentity.split("@")[0];
          usernameLabel.setText(userIdentity);
-         Roles.getPresentationRole().setAriaLabelProperty(usernameLabel.getElement(), "Username");
          headerBarCommandsPanel_.add(usernameLabel);
          
          overlayUserCommandsPanel_ = new HorizontalPanel();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionExplorer.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ConnectionExplorer.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -54,7 +54,7 @@ public ConnectionExplorer()
       disconnectedUI_.add(codePanel_);
       Label label = new Label("(Not connected)");
       Style labelStyle = label.getElement().getStyle();
-      labelStyle.setColor("#888");
+      labelStyle.setColor("#767676");
       labelStyle.setMarginTop(25, Unit.PX);
       labelStyle.setTextAlign(TextAlign.CENTER);
       disconnectedUI_.add(label);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/common/CompileOutputPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * CompileOutputPane.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -58,7 +58,7 @@ protected Widget createMainWidget()
    @Override
    protected Toolbar createMainToolbar()
    {
-      Toolbar toolbar = new Toolbar("Compile Output Tab");
+      Toolbar toolbar = new Toolbar(getTitle() + " Tab");
       
       fileLabel_ = new ToolbarFileLabel(toolbar, 200);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AceEditorNative.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -201,7 +201,7 @@ public void removeHandler()
       };
    }
 
-   private native Element getTextInputElement() /*-{
+   public final native Element getTextInputElement() /*-{
       return this.textInput.getElement();
    }-*/;
 

File: src/gwt/tools/prefs/UserPrefsAccessor.java
Patch:
@@ -1,6 +1,6 @@
 /* UserPrefsAccessor.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/tools/prefs/UserStateAccessor.java
Patch:
@@ -1,6 +1,6 @@
 /* UserStateAccessor.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * IgnoreDialog.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -45,6 +45,7 @@ public IgnoreDialog()
       super(Roles.getDialogRole());
       dirChooser_ = new DirectoryChooserTextBox("Directory:", 
                                                 "", 
+                                                ElementIds.TextBoxButtonId.VCS_IGNORE,
                                                 null);
       dirChooser_.addStyleName(RES.styles().dirChooser());
       

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectTemplateWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ProjectTemplateWidget.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -18,6 +18,7 @@
 import java.util.List;
 
 import org.rstudio.core.client.Debug;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.js.JsObject;
@@ -199,7 +200,7 @@ public void collectInput(JsObject receiver)
    private ProjectTemplateWidgetItem fileInput(final ProjectTemplateWidgetDescription description)
    {
       final FileChooserTextBox widget = new FileChooserTextBox(description.getLabel(), "",
-                                                               false, null, null);
+         ElementIds.TextBoxButtonId.PROJECT_TEMPLATE, false, null, null);
       
       String defaultValue = description.getDefault();
       if (!StringUtil.isNullOrEmpty(defaultValue))

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/ExistingDirectoryPage.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.DirectoryChooserTextBox;
 import org.rstudio.core.client.widget.MessageDialog;
@@ -43,7 +44,7 @@ protected void onAddWidgets()
    {
    
       existingProjectDir_ = new DirectoryChooserTextBox(
-            "Project working directory:", null);
+            "Project working directory:", ElementIds.TextBoxButtonId.EXISTING_PROJECT_DIR, null);
       addWidget(existingProjectDir_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectCompilePdfPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ProjectCompilePdfPreferencesPane.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.projects.ui.prefs;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.prefs.PreferencesDialogBaseResources;
 import org.rstudio.core.client.prefs.RestartRequirement;
@@ -109,6 +110,7 @@ public RootDocumentChooser()
                "(Current Document)", 
                "Browse...", 
                new HelpButton("pdf_root_document", "Get help on Compile PDF root document"),
+               ElementIds.TextBoxButtonId.PDF_ROOT,
                true,
                null);
          

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectEditingPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ProjectEditingPreferencesPane.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.projects.ui.prefs;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.prefs.PreferencesDialogBaseResources;
 import org.rstudio.core.client.prefs.RestartRequirement;
 import org.rstudio.core.client.resources.ImageResource2x;
@@ -73,6 +74,7 @@ public ProjectEditingPreferencesPane(final SourceServerOperations server)
             "",
             "Change...",
             null,
+            ElementIds.TextBoxButtonId.PROJECT_TEXT_ENCODING,
             true,
             new ClickHandler()
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * EditingPreferencesPane.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -268,6 +268,7 @@ public void onClick(ClickEvent event)
             "",
             "Change...",
             null,
+            ElementIds.TextBoxButtonId.TEXT_ENCODING,
             true,
             new ClickHandler()
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -73,6 +73,7 @@ public GeneralPreferencesPane(RemoteFileSystemContext fsContext,
                "",
                "Change...",
                null,
+               ElementIds.TextBoxButtonId.R_VERSION,
                true,
                new ClickHandler()
                {
@@ -120,6 +121,7 @@ public void onClick(ClickEvent event)
 
       basic.add(dirChooser_ = new DirectoryChooserTextBox(
             "Default working directory (when not in a project):",
+            ElementIds.TextBoxButtonId.DEFAULT_WORKING_DIR,
             null,
             fileDialogs_,
             fsContext_));

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PackagesPreferencesPane.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -103,6 +103,7 @@ public PackagesPreferencesPane(PreferencesDialogResources res,
             "",
             "Change...",
             null,
+            ElementIds.TextBoxButtonId.PRIMARY_CRAN,
             true,
             selectPrimaryRepo);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishingPreferencesPane.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -227,7 +227,8 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
             val -> caBundlePath_.setVisible(val.getValue()));
       add(useCaBundle);
 
-      caBundlePath_ = new FileChooserTextBox("", "(none)", false, null, null);
+      caBundlePath_ = new FileChooserTextBox(
+         "", "(none)", ElementIds.TextBoxButtonId.CA_BUNDLE, false, null, null);
       caBundlePath_.setText(userPrefs_.publishCaBundle().getValue());
       caBundlePath_.setVisible(userPrefs_.usePublishCaBundle().getValue());
       add(caBundlePath_);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/TerminalPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalPreferencesPane.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -125,6 +125,7 @@ public void execute()
       customShellPathLabel_ = new FormLabel("Custom shell binary:");
       customShellChooser_ = new FileChooserTextBox(customShellPathLabel_,
                                                    "(Not Found)",
+                                                   ElementIds.TextBoxButtonId.TERMINAL,
                                                    false,
                                                    null,
                                                    onShellExePathChosen);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionPreInstallOdbcHost.java
Patch:
@@ -16,6 +16,7 @@
 package org.rstudio.studio.client.workbench.views.connections.ui;
 
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.widget.DirectoryChooserTextBox;
 import org.rstudio.core.client.widget.Operation;
@@ -58,6 +59,7 @@ public NewConnectionPreInstallOdbcHost()
    {
       RStudioGinjector.INSTANCE.injectMembers(this);
 
+      dirChooser_ = new DirectoryChooserTextBox("", "", ElementIds.TextBoxButtonId.ODBC_PATH, null);
       mainWidget_ = GWT.<Binder>create(Binder.class).createAndBindUi(this);
  
       initWidget(createWidget());
@@ -112,7 +114,7 @@ public interface Styles extends CssResource
    @UiField
    Label driverLabel_;
 
-   @UiField
+   @UiField(provided = true)
    DirectoryChooserTextBox dirChooser_;
 
    @UiField

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/InstallPackageDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * InstallPackageDialog.java
  *
- * Copyright (C) 2009-19 by RStudio, Inc.
+ * Copyright (C) 2009-20 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -16,6 +16,7 @@
 
 import com.google.gwt.aria.client.Roles;
 import org.rstudio.core.client.Debug;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.files.FileSystemContext;
 import org.rstudio.core.client.files.FileSystemItem;
@@ -189,6 +190,7 @@ protected Widget createMainWidget()
                                               "",
                                               "Browse...",
                                               null,
+                                              ElementIds.TextBoxButtonId.PACKAGE_ARCHIVE,
                                               true,
                                               browseForArchiveClickHandler_);
             

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -95,6 +95,7 @@ public void onClick(ClickEvent event)
                });
          rVersion_.setWidth("100%");
          rVersion_.setText("Loading...");
+         rVersion_.getElement().getStyle().setMarginLeft(2, Unit.PX);
          Desktop.getFrame().getRVersion(version -> {
             rVersion_.setText(version);
          });

File: src/gwt/src/org/rstudio/studio/client/common/rpubs/ui/RPubsUploadDialog.java
Patch:
@@ -20,6 +20,7 @@
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.CoreResources;
 import org.rstudio.core.client.resources.ImageResource2x;
+import org.rstudio.core.client.widget.DecorativeImage;
 import org.rstudio.core.client.widget.ModalDialogBase;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.ProgressImage;
@@ -40,7 +41,6 @@
 import com.google.gwt.user.client.ui.HTML;
 import com.google.gwt.user.client.ui.HasVerticalAlignment;
 import com.google.gwt.user.client.ui.HorizontalPanel;
-import com.google.gwt.user.client.ui.Image;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.SimplePanel;
 import com.google.gwt.user.client.ui.VerticalPanel;
@@ -91,7 +91,7 @@ protected Widget createMainWidget()
   
       HorizontalPanel headerPanel = new HorizontalPanel();
       headerPanel.addStyleName(styles.headerPanel());
-      headerPanel.add(new Image(new ImageResource2x(RESOURCES.publishLarge2x())));
+      headerPanel.add(new DecorativeImage(new ImageResource2x(RESOURCES.publishLarge2x())));
       
       Label headerLabel = new Label("Publish to RPubs");
       headerLabel.addStyleName(styles.headerLabel());
@@ -117,6 +117,7 @@ protected Widget createMainWidget()
       Label descLabel = new Label(msg);
       descLabel.addStyleName(styles.descLabel());
       verticalPanel.add(descLabel);
+      setARIADescribedBy(descLabel.getElement());
 
       HTML warningLabel =  new HTML(
         "<strong>IMPORTANT: All documents published to RPubs are " +

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectLocalAccount.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RSConnectLocalAccount.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,7 +14,6 @@
  */
 package org.rstudio.studio.client.rsconnect.ui;
 
-import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.TextBoxWithCue;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.HelpLink;
@@ -42,7 +41,6 @@ public RSConnectLocalAccount()
       
       // apply the default server if one is registered
       Session session = RStudioGinjector.INSTANCE.getSession();
-      ElementIds.assignElementId(serverUrl_.getElement(), ElementIds.RSC_SERVER_URL);
       if (session != null && session.getSessionInfo() != null)
       {
          serverUrl_.setText(session.getSessionInfo().getDefaultRSConnectServer());

File: src/gwt/src/org/rstudio/studio/client/common/rpubs/ui/RPubsUploadDialog.java
Patch:
@@ -20,6 +20,7 @@
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.CoreResources;
 import org.rstudio.core.client.resources.ImageResource2x;
+import org.rstudio.core.client.widget.DecorativeImage;
 import org.rstudio.core.client.widget.ModalDialogBase;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.ProgressImage;
@@ -40,7 +41,6 @@
 import com.google.gwt.user.client.ui.HTML;
 import com.google.gwt.user.client.ui.HasVerticalAlignment;
 import com.google.gwt.user.client.ui.HorizontalPanel;
-import com.google.gwt.user.client.ui.Image;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.SimplePanel;
 import com.google.gwt.user.client.ui.VerticalPanel;
@@ -91,7 +91,7 @@ protected Widget createMainWidget()
   
       HorizontalPanel headerPanel = new HorizontalPanel();
       headerPanel.addStyleName(styles.headerPanel());
-      headerPanel.add(new Image(new ImageResource2x(RESOURCES.publishLarge2x())));
+      headerPanel.add(new DecorativeImage(new ImageResource2x(RESOURCES.publishLarge2x())));
       
       Label headerLabel = new Label("Publish to RPubs");
       headerLabel.addStyleName(styles.headerLabel());
@@ -117,6 +117,7 @@ protected Widget createMainWidget()
       Label descLabel = new Label(msg);
       descLabel.addStyleName(styles.descLabel());
       verticalPanel.add(descLabel);
+      setARIADescribedBy(descLabel.getElement());
 
       HTML warningLabel =  new HTML(
         "<strong>IMPORTANT: All documents published to RPubs are " +

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectLocalAccount.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RSConnectLocalAccount.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,7 +14,6 @@
  */
 package org.rstudio.studio.client.rsconnect.ui;
 
-import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.TextBoxWithCue;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.HelpLink;
@@ -42,7 +41,6 @@ public RSConnectLocalAccount()
       
       // apply the default server if one is registered
       Session session = RStudioGinjector.INSTANCE.getSession();
-      ElementIds.assignElementId(serverUrl_.getElement(), ElementIds.RSC_SERVER_URL);
       if (session != null && session.getSessionInfo() != null)
       {
          serverUrl_.setText(session.getSessionInfo().getDefaultRSConnectServer());

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -168,7 +168,7 @@ else if (getWindowMode() == WINDOW_MODE_BACKGROUND &&
       if (enableNoHandlerAssertions_)
       {
          assert handlers_.getHandlerCount(CommandEvent.TYPE) > 0 
-                  : "AppCommand executed but nobody was listening";
+                  : "AppCommand executed but nobody was listening: " + getId();
       }
       
       CommandEvent event = new CommandEvent(this);

File: src/gwt/src/org/rstudio/studio/client/common/vcs/CreateKeyDialog.java
Patch:
@@ -240,9 +240,8 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onLoad()
+   protected void focusInitialControl()
    {
-      super.onLoad();
       FocusHelper.setFocusDeferred(txtPassphrase_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdChoiceOption.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdChoiceOption.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -28,7 +28,6 @@ public RmdChoiceOption(RmdTemplateFormatOption option, String initialValue)
       defaultValue_ = option.getDefaultValue();
 
       HTMLPanel panel = new HTMLPanel("");
-      panel.add(getOptionLabelWidget());
       choices_ = new ListBox();
       
       JsArrayString choiceList = option.getChoiceList();
@@ -42,6 +41,7 @@ public RmdChoiceOption(RmdTemplateFormatOption option, String initialValue)
          }
       }
       choices_.setSelectedIndex(selectedIdx);
+      panel.add(getOptionLabelWidget(choices_.getElement()));
       panel.add(choices_);
 
       updateNull();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdFileOption.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdFileOption.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -29,13 +29,13 @@ public RmdFileOption(RmdTemplateFormatOption option, String initialValue)
       defaultValue_ = option.getDefaultValue();
 
       HTMLPanel panel = new HTMLPanel("");
-      panel.add(getOptionLabelWidget());
-      
+
       fileChooser_ = new FileChooserTextBox("", "", false, null, null);
       if (initialValue != "null")
          fileChooser_.setText(initialValue);
       fileChooser_.getElement().getStyle().setMarginLeft(20, Unit.PX);
       fileChooser_.getElement().getStyle().setMarginTop(3, Unit.PX);
+      panel.add(getOptionLabelWidget(fileChooser_.getTextBox().getElement()));
       panel.add(fileChooser_);
 
       updateNull();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdFloatOption.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdNumberOption.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -28,14 +28,14 @@ public RmdFloatOption(RmdTemplateFormatOption option, String initialValue)
       super(option, initialValue);
       HTMLPanel panel = new HTMLPanel("");
       defaultValue_ = Float.parseFloat(option.getDefaultValue());
-      panel.add(getOptionLabelWidget());
       txtValue_ = new NumericTextBox();
       if (initialValue.equals("null"))
          txtValue_.setValue(option.getDefaultValue());
       else
          txtValue_.setValue(initialValue);
       txtValue_.setWidth("40px");
       txtValue_.getElement().getStyle().setMarginLeft(5, Unit.PX);
+      panel.add(getOptionLabelWidget(txtValue_.getElement()));
       panel.add(txtValue_);
 
       updateNull();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdStringOption.java
Patch:
@@ -30,14 +30,14 @@ public RmdStringOption(RmdTemplateFormatOption option, String initialValue)
       defaultValue_ = option.getDefaultValue();
 
       HTMLPanel panel = new HTMLPanel("");
-      panel.add(getOptionLabelWidget());
       txtValue_ = new TextBox();
       if (initialValue != "null")
          txtValue_.setValue(initialValue);
       txtValue_.getElement().getStyle().setDisplay(Display.BLOCK);
       txtValue_.getElement().getStyle().setMarginLeft(20, Unit.PX);
       txtValue_.getElement().getStyle().setMarginTop(3, Unit.PX);
       txtValue_.setWidth("75%");
+      panel.add(getOptionLabelWidget(txtValue_.getElement()));
       panel.add(txtValue_);
 
       updateNull();

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotResources.java
Patch:
@@ -29,7 +29,7 @@ public static interface Styles extends CssResource
       String fileNameLabel();
       String fileNameTextBox();
       String directoryButton();
-      String directoryLabel();
+      String directoryTextBox();
       
       String imagePreview();
       String imageOptionLabel();

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/unsaved/UnsavedChangesDialog.java
Patch:
@@ -155,7 +155,9 @@ protected Widget createMainWidget()
       // main widget
       VerticalPanel panel = new VerticalPanel();
       Label captionLabel = new Label(
-            "The following files have unsaved changes:");
+         targets_.size() == 1 ?
+            "The following file has unsaved changes:" :
+            "The following " + targets_.size() + " files have unsaved changes:");
       captionLabel.setStylePrimaryName(RESOURCES.styles().captionLabel());
       panel.add(captionLabel);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsPdfDialog.java
Patch:
@@ -241,8 +241,7 @@ public void execute(FileSystemItem input,
       
       // view after size
       viewAfterSaveCheckBox_ = new CheckBox("View plot after saving");
-      viewAfterSaveCheckBox_.setStylePrimaryName(
-                                       styles.savePdfViewAfterCheckbox());
+      viewAfterSaveCheckBox_.addStyleName(styles.savePdfViewAfterCheckbox());
       viewAfterSaveCheckBox_.setValue(options_.getViewAfterSave());
       grid.setWidget(6, 1, viewAfterSaveCheckBox_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -200,13 +200,13 @@ public NewRMarkdownDialog(
       style.ensureInjected();
       txtAuthor_.setText(author);
       txtTitle_.setText("Untitled");
+      Roles.getListboxRole().setAriaLabelProperty(listTemplates_.getElement(), "Templates");
       listTemplates_.addChangeHandler(new ChangeHandler()
       {
          @Override
          public void onChange(ChangeEvent event)
          {
             updateOptions(getSelectedTemplate());
-            txtTitle_.setFocus(true);
          }
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -200,13 +200,13 @@ public NewRMarkdownDialog(
       style.ensureInjected();
       txtAuthor_.setText(author);
       txtTitle_.setText("Untitled");
+      Roles.getListboxRole().setAriaLabelProperty(listTemplates_.getElement(), "Templates");
       listTemplates_.addChangeHandler(new ChangeHandler()
       {
          @Override
          public void onChange(ChangeEvent event)
          {
             updateOptions(getSelectedTemplate());
-            txtTitle_.setFocus(true);
          }
       });
 

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -168,7 +168,7 @@ else if (getWindowMode() == WINDOW_MODE_BACKGROUND &&
       if (enableNoHandlerAssertions_)
       {
          assert handlers_.getHandlerCount(CommandEvent.TYPE) > 0 
-                  : "AppCommand executed but nobody was listening";
+                  : "AppCommand executed but nobody was listening: " + getId();
       }
       
       CommandEvent event = new CommandEvent(this);

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdChoiceOption.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdChoiceOption.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -28,7 +28,6 @@ public RmdChoiceOption(RmdTemplateFormatOption option, String initialValue)
       defaultValue_ = option.getDefaultValue();
 
       HTMLPanel panel = new HTMLPanel("");
-      panel.add(getOptionLabelWidget());
       choices_ = new ListBox();
       
       JsArrayString choiceList = option.getChoiceList();
@@ -42,6 +41,7 @@ public RmdChoiceOption(RmdTemplateFormatOption option, String initialValue)
          }
       }
       choices_.setSelectedIndex(selectedIdx);
+      panel.add(getOptionLabelWidget(choices_.getElement()));
       panel.add(choices_);
 
       updateNull();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdFileOption.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdFileOption.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -29,13 +29,13 @@ public RmdFileOption(RmdTemplateFormatOption option, String initialValue)
       defaultValue_ = option.getDefaultValue();
 
       HTMLPanel panel = new HTMLPanel("");
-      panel.add(getOptionLabelWidget());
-      
+
       fileChooser_ = new FileChooserTextBox("", "", false, null, null);
       if (initialValue != "null")
          fileChooser_.setText(initialValue);
       fileChooser_.getElement().getStyle().setMarginLeft(20, Unit.PX);
       fileChooser_.getElement().getStyle().setMarginTop(3, Unit.PX);
+      panel.add(getOptionLabelWidget(fileChooser_.getTextBox().getElement()));
       panel.add(fileChooser_);
 
       updateNull();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdFloatOption.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdNumberOption.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -28,14 +28,14 @@ public RmdFloatOption(RmdTemplateFormatOption option, String initialValue)
       super(option, initialValue);
       HTMLPanel panel = new HTMLPanel("");
       defaultValue_ = Float.parseFloat(option.getDefaultValue());
-      panel.add(getOptionLabelWidget());
       txtValue_ = new NumericTextBox();
       if (initialValue.equals("null"))
          txtValue_.setValue(option.getDefaultValue());
       else
          txtValue_.setValue(initialValue);
       txtValue_.setWidth("40px");
       txtValue_.getElement().getStyle().setMarginLeft(5, Unit.PX);
+      panel.add(getOptionLabelWidget(txtValue_.getElement()));
       panel.add(txtValue_);
 
       updateNull();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdStringOption.java
Patch:
@@ -30,14 +30,14 @@ public RmdStringOption(RmdTemplateFormatOption option, String initialValue)
       defaultValue_ = option.getDefaultValue();
 
       HTMLPanel panel = new HTMLPanel("");
-      panel.add(getOptionLabelWidget());
       txtValue_ = new TextBox();
       if (initialValue != "null")
          txtValue_.setValue(initialValue);
       txtValue_.getElement().getStyle().setDisplay(Display.BLOCK);
       txtValue_.getElement().getStyle().setMarginLeft(20, Unit.PX);
       txtValue_.getElement().getStyle().setMarginTop(3, Unit.PX);
       txtValue_.setWidth("75%");
+      panel.add(getOptionLabelWidget(txtValue_.getElement()));
       panel.add(txtValue_);
 
       updateNull();

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotResources.java
Patch:
@@ -29,7 +29,7 @@ public static interface Styles extends CssResource
       String fileNameLabel();
       String fileNameTextBox();
       String directoryButton();
-      String directoryLabel();
+      String directoryTextBox();
       
       String imagePreview();
       String imageOptionLabel();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsPdfDialog.java
Patch:
@@ -241,8 +241,7 @@ public void execute(FileSystemItem input,
       
       // view after size
       viewAfterSaveCheckBox_ = new CheckBox("View plot after saving");
-      viewAfterSaveCheckBox_.setStylePrimaryName(
-                                       styles.savePdfViewAfterCheckbox());
+      viewAfterSaveCheckBox_.addStyleName(styles.savePdfViewAfterCheckbox());
       viewAfterSaveCheckBox_.setValue(options_.getViewAfterSave());
       grid.setWidget(6, 1, viewAfterSaveCheckBox_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotResources.java
Patch:
@@ -29,7 +29,7 @@ public static interface Styles extends CssResource
       String fileNameLabel();
       String fileNameTextBox();
       String directoryButton();
-      String directoryLabel();
+      String directoryTextBox();
       
       String imagePreview();
       String imageOptionLabel();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsPdfDialog.java
Patch:
@@ -241,8 +241,7 @@ public void execute(FileSystemItem input,
       
       // view after size
       viewAfterSaveCheckBox_ = new CheckBox("View plot after saving");
-      viewAfterSaveCheckBox_.setStylePrimaryName(
-                                       styles.savePdfViewAfterCheckbox());
+      viewAfterSaveCheckBox_.addStyleName(styles.savePdfViewAfterCheckbox());
       viewAfterSaveCheckBox_.setValue(options_.getViewAfterSave());
       grid.setWidget(6, 1, viewAfterSaveCheckBox_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/unsaved/UnsavedChangesDialog.java
Patch:
@@ -155,7 +155,9 @@ protected Widget createMainWidget()
       // main widget
       VerticalPanel panel = new VerticalPanel();
       Label captionLabel = new Label(
-            "The following files have unsaved changes:");
+         targets_.size() == 1 ?
+            "The following file has unsaved changes:" :
+            "The following " + targets_.size() + " files have unsaved changes:");
       captionLabel.setStylePrimaryName(RESOURCES.styles().captionLabel());
       panel.add(captionLabel);
 

File: src/gwt/src/org/rstudio/studio/client/common/vcs/CreateKeyDialog.java
Patch:
@@ -240,9 +240,8 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onLoad()
+   protected void focusInitialControl()
    {
-      super.onLoad();
       FocusHelper.setFocusDeferred(txtPassphrase_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/vcs/CreateKeyDialog.java
Patch:
@@ -240,9 +240,8 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onLoad()
+   protected void focusInitialControl()
    {
-      super.onLoad();
       FocusHelper.setFocusDeferred(txtPassphrase_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -106,6 +106,9 @@ public final String[] getExcludeFilePatterns()
       }
 
       private native JsArrayString getExcludeFilePatternsNative() /*-{
+
+         if (!this.excludeFilePatterns)
+            this.excludeFilePatterns="";
          return this.excludeFilePatterns;
       }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client;
 
+import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.EntryPoint;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.core.client.RunAsyncCallback;
@@ -124,7 +125,7 @@ private Command showProgress(Widget progressAction)
    {
       final Label background = new Label();
       ariaLoadingMessage_ = new Label();
-      A11y.setAlertRole(ariaLoadingMessage_, true);
+      Roles.getAlertRole().set(ariaLoadingMessage_.getElement());
       A11y.setVisuallyHidden(ariaLoadingMessage_);
 
       background.getElement().getStyle().setZIndex(1000);

File: src/gwt/src/org/rstudio/studio/client/application/ui/WarningBar.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.application.ui;
 
+import com.google.gwt.aria.client.Roles;
 import com.google.gwt.dom.client.DivElement;
 import com.google.gwt.user.client.Timer;
 import org.rstudio.core.client.a11y.A11y;
@@ -81,7 +82,7 @@ public WarningBar()
       moreButton_.setText("Manage License...");
       moreButton_.addClickHandler(event -> Desktop.getFrame().showLicenseDialog());
       A11y.setARIAHidden(label_);
-      A11y.setAlertRole(live_, true);
+      Roles.getAlertRole().set(live_);
    }
 
    public void setText(String value)

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client;
 
+import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.EntryPoint;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.core.client.RunAsyncCallback;
@@ -124,7 +125,7 @@ private Command showProgress(Widget progressAction)
    {
       final Label background = new Label();
       ariaLoadingMessage_ = new Label();
-      A11y.setAlertRole(ariaLoadingMessage_, true);
+      Roles.getAlertRole().set(ariaLoadingMessage_.getElement());
       A11y.setVisuallyHidden(ariaLoadingMessage_);
 
       background.getElement().getStyle().setZIndex(1000);

File: src/gwt/src/org/rstudio/studio/client/application/ui/WarningBar.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.application.ui;
 
+import com.google.gwt.aria.client.Roles;
 import com.google.gwt.dom.client.DivElement;
 import com.google.gwt.user.client.Timer;
 import org.rstudio.core.client.a11y.A11y;
@@ -81,7 +82,7 @@ public WarningBar()
       moreButton_.setText("Manage License...");
       moreButton_.addClickHandler(event -> Desktop.getFrame().showLicenseDialog());
       A11y.setARIAHidden(label_);
-      A11y.setAlertRole(live_, true);
+      Roles.getAlertRole().set(live_);
    }
 
    public void setText(String value)

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectEditingPreferencesPane.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.studio.client.projects.model.RProjectConfig;
 import org.rstudio.studio.client.projects.model.RProjectOptions;
 import org.rstudio.studio.client.workbench.prefs.model.ProjectPrefs;
+import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.views.LineEndingsSelectWidget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.IconvListResult;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.ChooseEncodingDialog;
@@ -49,8 +50,9 @@ public ProjectEditingPreferencesPane(final SourceServerOperations server)
       chkSpacesForTab_.addStyleName(RESOURCES.styles().useSpacesForTab());
       add(chkSpacesForTab_);
       
-      numSpacesForTab_ = new NumericValueWidget("Tab width");
+      numSpacesForTab_ = new NumericValueWidget("Tab width", 1, UserPrefs.MAX_TAB_WIDTH);
       numSpacesForTab_.addStyleName(RESOURCES.styles().numberOfTabs());
+      numSpacesForTab_.setWidth("36px");
       add(numSpacesForTab_);
       
       chkAutoAppendNewline_ = new CheckBox("Ensure that source files end with newline");

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -341,7 +341,9 @@ void onToggleTabKeyMovesFocus()
    public static final int LAYER_COMPUTED = 2;
    public static final int LAYER_USER     = 3;
    public static final int LAYER_PROJECT  = 4;
-   
+
+   public static final int MAX_TAB_WIDTH = 64;
+
    private final Session session_;
    private final PrefsServerOperations server_;
    private final SatelliteManager satelliteManager_;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AccessibilityPreferencesPane.java
Patch:
@@ -42,7 +42,7 @@ public AccessibilityPreferencesPane(UserPrefs prefs,
             prefs.ariaApplicationRole()));
 
       typingStatusDelay_ = numericPref("Milliseconds after typing before speaking results",
-            prefs.typingStatusDelayMs());
+            1, 9999, prefs.typingStatusDelayMs());
       add(indent(typingStatusDelay_));
 
       Label displayLabel = headerLabel("Other");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindResult.java
Patch:
@@ -193,8 +193,6 @@ public final SafeHtml getLineHTML()
          int openRedTags = 0;
          int openInsTags = 0;
          String redTag = new String("strong");
-         if (!StringUtil.isNullOrEmpty(replace) || getRegexPreviewIndicator())
-            redTag = "del";
    
          for (int i = 0; i < line.length(); i++)
          {

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -188,6 +188,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ExecuteAppCommand = "execute_app_command";
    public static final String HighlightUi = "highlight_ui";
    public static final String TutorialCommand = "tutorial_command";
+   public static final String TutorialLaunch = "tutorial_launch";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchScreen.java
Patch:
@@ -345,6 +345,8 @@ void onActivateHelp()
    void onActivateViewer() { paneManager_.activateTab(Tab.Viewer); }
    @Handler
    void onActivateConnections() { paneManager_.activateTab(Tab.Connections); }
+   @Handler
+   void onActivateTutorial() { paneManager_.activateTab(Tab.Tutorial); }
    
    
    @Handler

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -1036,6 +1036,7 @@ else if (type == ClientEvent.HighlightUi)
          {
             HighlightEvent.Data data = event.getData();
             eventBus_.dispatchEvent(new HighlightEvent(data));
+         }
          else if (type == ClientEvent.TutorialCommand)
          {
             TutorialCommandEvent.Data data = event.getData();

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectEditingPreferencesPane.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.studio.client.projects.model.RProjectConfig;
 import org.rstudio.studio.client.projects.model.RProjectOptions;
 import org.rstudio.studio.client.workbench.prefs.model.ProjectPrefs;
+import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.views.LineEndingsSelectWidget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.IconvListResult;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.ChooseEncodingDialog;
@@ -49,8 +50,9 @@ public ProjectEditingPreferencesPane(final SourceServerOperations server)
       chkSpacesForTab_.addStyleName(RESOURCES.styles().useSpacesForTab());
       add(chkSpacesForTab_);
       
-      numSpacesForTab_ = new NumericValueWidget("Tab width");
+      numSpacesForTab_ = new NumericValueWidget("Tab width", 1, UserPrefs.MAX_TAB_WIDTH);
       numSpacesForTab_.addStyleName(RESOURCES.styles().numberOfTabs());
+      numSpacesForTab_.setWidth("36px");
       add(numSpacesForTab_);
       
       chkAutoAppendNewline_ = new CheckBox("Ensure that source files end with newline");

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -341,7 +341,9 @@ void onToggleTabKeyMovesFocus()
    public static final int LAYER_COMPUTED = 2;
    public static final int LAYER_USER     = 3;
    public static final int LAYER_PROJECT  = 4;
-   
+
+   public static final int MAX_TAB_WIDTH = 64;
+
    private final Session session_;
    private final PrefsServerOperations server_;
    private final SatelliteManager satelliteManager_;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AccessibilityPreferencesPane.java
Patch:
@@ -42,7 +42,7 @@ public AccessibilityPreferencesPane(UserPrefs prefs,
             prefs.ariaApplicationRole()));
 
       typingStatusDelay_ = numericPref("Milliseconds after typing before speaking results",
-            prefs.typingStatusDelayMs());
+            1, 9999, prefs.typingStatusDelayMs());
       add(indent(typingStatusDelay_));
 
       Label displayLabel = headerLabel("Other");

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationView.java
Patch:
@@ -46,9 +46,8 @@ void showApplicationAgreement(String title,
    void showSessionAbendWarning();
    
    // informative status message for screen reader users,
-   // announced at next graceful opportunity
-   void reportStatus(String message);
-   void clearStatus();
+   // announced at next graceful opportunity after given delay
+   void reportStatus(String message, int delayMs);
 
    // progress
    void showSerializationProgress(String message, 

File: src/gwt/src/org/rstudio/studio/client/application/events/ApplicationEventHandlers.java
Patch:
@@ -34,7 +34,6 @@ public interface ApplicationEventHandlers extends LogoutRequestedHandler,
                                                   SessionInitHandler,
                                                   RestartStatusEvent.Handler,
                                                   FileUploadHandler,
-                                                  AriaLiveStatusEvent.Handler,
-                                                  AriaLiveClearStatusEvent.Handler
+                                                  AriaLiveStatusEvent.Handler
 {
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -313,10 +313,8 @@ else if (listPresetFilePatterns_.getValue(2) == filePatterns)
          listPresetExcludeFilePatterns_.setSelectedIndex(0);
       else if (listPresetExcludeFilePatterns_.getValue(1) == excludeFilePatterns)
          listPresetExcludeFilePatterns_.setSelectedIndex(1);
-      else if (listPresetExcludeFilePatterns_.getValue(2) == excludeFilePatterns)
-         listPresetExcludeFilePatterns_.setSelectedIndex(2);
       else
-         listPresetExcludeFilePatterns_.setSelectedIndex(3);
+         listPresetExcludeFilePatterns_.setSelectedIndex(2);
       txtExcludeFilePattern_.setText(excludeFilePatterns);
       manageExcludeFilePattern();
    }

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationView.java
Patch:
@@ -46,9 +46,8 @@ void showApplicationAgreement(String title,
    void showSessionAbendWarning();
    
    // informative status message for screen reader users,
-   // announced at next graceful opportunity
-   void reportStatus(String message);
-   void clearStatus();
+   // announced at next graceful opportunity after given delay
+   void reportStatus(String message, int delayMs);
 
    // progress
    void showSerializationProgress(String message, 

File: src/gwt/src/org/rstudio/studio/client/application/events/ApplicationEventHandlers.java
Patch:
@@ -34,7 +34,6 @@ public interface ApplicationEventHandlers extends LogoutRequestedHandler,
                                                   SessionInitHandler,
                                                   RestartStatusEvent.Handler,
                                                   FileUploadHandler,
-                                                  AriaLiveStatusEvent.Handler,
-                                                  AriaLiveClearStatusEvent.Handler
+                                                  AriaLiveStatusEvent.Handler
 {
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -268,9 +268,9 @@ public void onClick(ClickEvent event)
             String message = "Are you sure you wish to permanently replace all? This will replace " +
                              dialogState_.getResultsCount();
             if (dialogState_.isRegex())
-               message += " occurences and cannot be undone.";
+               message += " occurrences and cannot be undone.";
             else
-               message += " occurences of '" + dialogState_.getQuery() +
+               message += " occurrences of '" + dialogState_.getQuery() +
                           "' with '" + view_.getReplaceText() +
                           "' and cannot be undone.";
             globalDisplay_.showYesNoMessage(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -76,7 +76,7 @@ protected Toolbar createMainToolbar()
       stopSearch_.setVisible(false);
       toolbar.addRightWidget(stopSearch_);
 
-      showFindButton_ = new LeftRightToggleButton("Find", "Replace", false);
+      showFindButton_ = new LeftRightToggleButton("Find", "Replace", true);
       showFindButton_.addClickHandler(new ClickHandler() {
          @Override
          public void onClick(ClickEvent event)
@@ -96,7 +96,7 @@ public void onClick(ClickEvent event)
       });
       toolbar.addRightWidget(showFindButton_);
 
-      showReplaceButton_ = new LeftRightToggleButton("Find", "Replace", true);
+      showReplaceButton_ = new LeftRightToggleButton("Find", "Replace", false);
       showReplaceButton_.setVisible(false);
       showReplaceButton_.addClickHandler(new ClickHandler() {
          @Override

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -16,6 +16,7 @@
 
 import java.util.ArrayList;
 
+import com.google.gwt.aria.client.Roles;
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppMenuBar;
@@ -234,6 +235,7 @@ private void addSignoutToolbar()
          usernameLabel.setTitle(userIdentity);
          userIdentity = userIdentity.split("@")[0];
          usernameLabel.setText(userIdentity);
+         Roles.getPresentationRole().setAriaLabelProperty(usernameLabel.getElement(), "Username");
 
          addRightCommand(usernameLabel);
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.application.ui.impl;
 
+import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.dom.client.ImageElement;
@@ -411,6 +412,7 @@ private void initCommandsPanel(final SessionInfo sessionInfo)
          usernameLabel.setTitle(userIdentity);
          userIdentity = userIdentity.split("@")[0];
          usernameLabel.setText(userIdentity);
+         Roles.getPresentationRole().setAriaLabelProperty(usernameLabel.getElement(), "Username");
          headerBarCommandsPanel_.add(usernameLabel);
          
          overlayUserCommandsPanel_ = new HorizontalPanel();

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -16,6 +16,7 @@
 
 import java.util.ArrayList;
 
+import com.google.gwt.aria.client.Roles;
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppMenuBar;
@@ -234,6 +235,7 @@ private void addSignoutToolbar()
          usernameLabel.setTitle(userIdentity);
          userIdentity = userIdentity.split("@")[0];
          usernameLabel.setText(userIdentity);
+         Roles.getPresentationRole().setAriaLabelProperty(usernameLabel.getElement(), "Username");
 
          addRightCommand(usernameLabel);
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.application.ui.impl;
 
+import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.dom.client.ImageElement;
@@ -411,6 +412,7 @@ private void initCommandsPanel(final SessionInfo sessionInfo)
          usernameLabel.setTitle(userIdentity);
          userIdentity = userIdentity.split("@")[0];
          usernameLabel.setText(userIdentity);
+         Roles.getPresentationRole().setAriaLabelProperty(usernameLabel.getElement(), "Username");
          headerBarCommandsPanel_.add(usernameLabel);
          
          overlayUserCommandsPanel_ = new HorizontalPanel();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/spelling/SpellingDialog.java
Patch:
@@ -56,6 +56,7 @@ public SpellingDialog()
             btnAdd_, btnIgnoreAll_, btnSkip_, btnChange_, btnChangeAll_
       };
 
+      Roles.getListboxRole().setAriaLabelProperty(lstSuggestions_.getElement(), "Suggestions");
       addCancelButton();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -391,6 +391,8 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.renameSourceDoc());
       dynamicCommands_.add(commands.sourceAsLauncherJob());
       dynamicCommands_.add(commands.sourceAsJob());
+      dynamicCommands_.add(commands.runSelectionAsJob());
+      dynamicCommands_.add(commands.runSelectionAsLauncherJob());
       for (AppCommand command : dynamicCommands_)
       {
          command.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -391,6 +391,8 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.renameSourceDoc());
       dynamicCommands_.add(commands.sourceAsLauncherJob());
       dynamicCommands_.add(commands.sourceAsJob());
+      dynamicCommands_.add(commands.runSelectionAsJob());
+      dynamicCommands_.add(commands.runSelectionAsLauncherJob());
       for (AppCommand command : dynamicCommands_)
       {
          command.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindResult.java
Patch:
@@ -321,13 +321,13 @@ private String getJavaStringArray(String property)
    }
 
    private native final JsArrayInteger getArray(String property) /*-{
-      if (this === null)
+      if (this == null)
          return [];
       return this[property] || [];
    }-*/;
 
   private native final JsArrayString getStringArray(String property) /*-{
-     if (this === null)
+     if (this == null)
         return [];
      return this[property] || [];
   }-*/;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -153,7 +153,7 @@ public void onClick(ClickEvent event)
                UserPrefs.SAVE_WORKSPACE_ALWAYS,
                UserPrefs.SAVE_WORKSPACE_NEVER,
                UserPrefs.SAVE_WORKSPACE_ASK
-            }, false);
+            }, false, true, false);
       spaced(saveWorkspace_);
       basic.add(saveWorkspace_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -153,7 +153,7 @@ public void onClick(ClickEvent event)
                UserPrefs.SAVE_WORKSPACE_ALWAYS,
                UserPrefs.SAVE_WORKSPACE_NEVER,
                UserPrefs.SAVE_WORKSPACE_ASK
-            }, false);
+            }, false, true, false);
       spaced(saveWorkspace_);
       basic.add(saveWorkspace_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -19,11 +19,11 @@
 
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.studio.client.RStudioGinjector;
-import org.rstudio.studio.client.common.r.knitr.RMarkdownChunkHeaderParser;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
 import org.rstudio.studio.client.workbench.prefs.model.UserStateAccessor;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.LineWidget;
+import org.rstudio.studio.client.workbench.views.source.editors.text.assist.RChunkHeaderParser;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.EditorModeChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.ScopeTreeReadyEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.ChunkContextUi;
@@ -239,8 +239,7 @@ private boolean isRunnableChunk(int row)
       String header = target_.getDocDisplay().getLine(row);
       
       // parse contents
-      Map<String, String> options = 
-            RMarkdownChunkHeaderParser.parse(header);
+      Map<String, String> options = RChunkHeaderParser.parse(header);
       
       // check runnable engine
       String engine = StringUtil.stringValue(options.get("engine"));

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -51,6 +51,7 @@ public IgnoreDialog()
       editor_ = new AceEditor();
       editor_.setUseWrapMode(false);
       editor_.setShowLineNumbers(false);
+      editor_.setTabAlwaysMovesFocus();
       editor_.setTextInputAriaLabel("Ignored files");
       
       ignoresCaption_ = new CaptionWithHelp("Ignore:",

File: src/gwt/src/org/rstudio/core/client/Debug.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * Debug.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -150,7 +150,7 @@ public static void devlogf(String format,
    
    public static void logToRConsole(String message)
    {
-      Element consoleEl = Document.get().getElementById("rstudio_console_output");
+      Element consoleEl = Document.get().getElementById(ElementIds.getElementId(ElementIds.CONSOLE_OUTPUT));
       if (consoleEl == null)
          return;
       

File: src/gwt/src/org/rstudio/core/client/HandlerRegistrations.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HandlerRegistrations.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -37,6 +37,5 @@ public void removeHandler()
          registrations_.remove(0).removeHandler();
    }
 
-   private final ArrayList<HandlerRegistration> registrations_ =
-         new ArrayList<HandlerRegistration>();
+   private final ArrayList<HandlerRegistration> registrations_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/core/client/MessageDisplay.java
Patch:
@@ -35,6 +35,7 @@ public abstract class MessageDisplay
    public final static int INPUT_OPTIONAL_TEXT = 1;
    public final static int INPUT_PASSWORD = 2;
    public final static int INPUT_NUMERIC = 3;
+   public final static int INPUT_USERNAME = 4;
    
    public static class PromptWithOptionResult
    {

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -71,6 +71,7 @@ protected void onAttach()
          parentToolbar_ = getParentToolbar();
 
          super.onAttach();
+         ElementIds.assignElementId(getElement(), "tb_" + ElementIds.idSafeString(getId()));
       }
 
       @Override
@@ -493,7 +494,6 @@ public ToolbarButton createToolbarButton(boolean synced)
                                                              synced);
       if (getTooltip() != null)
          button.setTitle(getTooltip());
-      ElementIds.assignElementId(button.getElement(), "tb_" + ElementIds.idSafeString(getId()));
       return button;
    }
 

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShortcutManager.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -467,8 +467,7 @@ public void execute()
             AceEditorNative nativeEditor = AceEditorNative.getEditor(target);
             if (editor != null && nativeEditor != null &&
                   nativeEditor == editor.getWidget().getEditor() &&
-                  editor.getWidget().getElement().getId() ==
-                     ElementIds.getElementId(ElementIds.SOURCE_TEXT_EDITOR))
+                  ElementIds.isInstanceOf(editor.getWidget(), ElementIds.SOURCE_TEXT_EDITOR))
             {
                keyBuffer_.clear();
                commands_.expandToLine().execute();

File: src/gwt/src/org/rstudio/core/client/layout/FadeInAnimation.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FadeInAnimation.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -27,7 +27,7 @@ public FadeInAnimation(Widget widget,
                           double targetOpacity,
                           Command callback)
    {
-      this(new ArrayList<Widget>(), targetOpacity, callback);
+      this(new ArrayList<>(), targetOpacity, callback);
       widgets_.add(widget);
    }
 
@@ -61,6 +61,7 @@ protected void onComplete()
       for (Widget w : widgets_)
       {
          w.getElement().getStyle().setOpacity(targetOpacity_);
+         w.setVisible(true);
       }
       if (callback_ != null)
          callback_.execute();

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogBase.java
Patch:
@@ -94,8 +94,9 @@ protected PreferencesDialogBase(String caption,
 
          // SectionChooser is first focusable control in the modal dialog, and it
          // uses a roving tabindex to determine the focused section tab, so notify dialog
-         // when focus leaves or arrives at first tab
-         if ((currentIndex_ != null && currentIndex_ == 0) || index == 0)
+         // when selected tab changes (except the initial selection, which happens before
+         // the dialog is fully assembled and thus nothing is focusable, yet)
+         if (currentIndex_ != null)
             refreshFocusableElements();
 
          if (currentIndex_ != null)

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeResources.java
Patch:
@@ -295,6 +295,9 @@ public interface ThemeResources extends ClientBundle
    @Source("user_2x.png")
    ImageResource user();
    
+   @Source("refreshWorkspaceMonitored_2x.png")
+   ImageResource refreshWorkspaceMonitored2x();
+   
    @Source("refreshWorkspaceUnmonitored_2x.png")
    ImageResource refreshWorkspaceUnmonitored2x();
    

File: src/gwt/src/org/rstudio/core/client/widget/ImageButton.java
Patch:
@@ -26,7 +26,7 @@
 import com.google.gwt.user.client.ui.FocusWidget;
 import com.google.gwt.user.client.ui.Image;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.theme.res.ThemeStyles;
+import org.rstudio.core.client.a11y.A11y;
 
 /**
  * An image that behaves like a button.
@@ -53,7 +53,7 @@ public ImageButton(String description, ImageResource image)
       button.insertFirst(image_.getElement());
 
       descriptionSpan_ = Document.get().createSpanElement();
-      descriptionSpan_.setClassName(ThemeStyles.INSTANCE.visuallyHidden());
+      A11y.setVisuallyHidden(descriptionSpan_);
       button.appendChild(descriptionSpan_);
       setDescription(description);
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -126,7 +126,7 @@ public Element getDescriptionElement()
    @UiField InlineLabel copyrightYearLabel;
    @UiField HyperlinkLabel showNoticelink_;
    @UiField HTMLPanel gplNotice;
-   @UiField Label licenseLabel;
+   @UiField HTMLPanel licenseLabel;
    @UiField TextArea licenseBox;
    @UiField Label productName;
    @UiField HTMLPanel productInfo;

File: src/gwt/src/org/rstudio/studio/client/application/ui/serializationprogress/ApplicationSerializationProgressLabel.java
Patch:
@@ -14,13 +14,13 @@
  */
 package org.rstudio.studio.client.application.ui.serializationprogress;
 
-import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.Widget;
+import org.rstudio.core.client.a11y.A11y;
 
 public class ApplicationSerializationProgressLabel extends Composite
 {
@@ -32,7 +32,7 @@ interface MyBinder
    public ApplicationSerializationProgressLabel()
    {
       initWidget(binder.createAndBindUi(this));
-      Roles.getStatusRole().set(label_.getElement());
+      A11y.setStatusRole(label_, false);
    }
 
    public void setText(String text)

File: src/gwt/src/org/rstudio/studio/client/common/impl/WebTextInput.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * WebTextInput.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -106,7 +106,7 @@ public void setPosition(int offsetWidth, int offsetHeight)
                      int left = (Window.getClientWidth()/2) - (offsetWidth/2);
                      int top = (Window.getClientHeight()/2) - (offsetHeight/2);
                      
-                     if (type == MessageDisplay.INPUT_PASSWORD)
+                     if (type == MessageDisplay.INPUT_USERNAME || type == MessageDisplay.INPUT_PASSWORD)
                         top = 50;
                      
                      setPopupPosition(left, top);

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -566,10 +566,12 @@ public void onError(ServerError error)
                   // not be currently installed; in those cases, verify that the package is
                   // installed and if not attempt installation from CRAN first
                   String pkg = newProject.getProjectTemplateOptions().getDescription().getPackage();
+                  ArrayList<Dependency> deps = new ArrayList<Dependency>();
+                  deps.add(Dependency.cranPackage(pkg));
                   RStudioGinjector.INSTANCE.getDependencyManager().withDependencies(
                         "Creating project",
                         "Creating a project with " + pkg,
-                        new Dependency[] { Dependency.cranPackage(pkg) },
+                        deps,
                         false,
                         (Boolean success) -> {
                            if (!success)

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -51,6 +51,7 @@ public IgnoreDialog()
       editor_ = new AceEditor();
       editor_.setUseWrapMode(false);
       editor_.setShowLineNumbers(false);
+      editor_.setTabAlwaysMovesFocus();
       editor_.setTextInputAriaLabel("Ignored files");
       
       ignoresCaption_ = new CaptionWithHelp("Ignore:",

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -131,6 +131,7 @@
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.server.VoidServerRequestCallback;
 import org.rstudio.studio.client.shiny.model.ShinyRunCmd;
+import org.rstudio.studio.client.shiny.model.ShinyTestResults;
 import org.rstudio.studio.client.workbench.addins.Addins.RAddins;
 import org.rstudio.studio.client.workbench.codesearch.model.CodeSearchResults;
 import org.rstudio.studio.client.workbench.codesearch.model.ObjectDefinition;
@@ -5893,11 +5894,10 @@ public void installShinyTestDependencies(ServerRequestCallback<ConsoleProcess> c
    }
 
    @Override
-   public void hasShinyTestResults(String shinyApp, String testName, ServerRequestCallback<Boolean> callback)
+   public void hasShinyTestResults(String testFile, ServerRequestCallback<ShinyTestResults> callback)
    {
       JSONArray params = new JSONArray();
-      params.set(0, new JSONString(shinyApp));
-      params.set(1, new JSONString(testName));
+      params.set(0, new JSONString(testFile));
 
       sendRequest(RPC_SCOPE,
                   HAS_SHINYTEST_RESULTS,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/TestServerOperations.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TestServerOperations.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -16,12 +16,13 @@
 
 import org.rstudio.studio.client.common.console.ConsoleProcess;
 import org.rstudio.studio.client.server.ServerRequestCallback;
+import org.rstudio.studio.client.shiny.model.ShinyTestResults;
 
 public interface TestServerOperations
 {
    void hasShinyTestDependenciesInstalled(ServerRequestCallback<Boolean> callback);
    
    void installShinyTestDependencies(ServerRequestCallback<ConsoleProcess> callback);
 
-   void hasShinyTestResults(String shinyApp, String testName, ServerRequestCallback<Boolean> callback);
+   void hasShinyTestResults(String testFile, ServerRequestCallback<ShinyTestResults> callback);
 }

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -126,7 +126,7 @@ public Element getDescriptionElement()
    @UiField InlineLabel copyrightYearLabel;
    @UiField HyperlinkLabel showNoticelink_;
    @UiField HTMLPanel gplNotice;
-   @UiField Label licenseLabel;
+   @UiField HTMLPanel licenseLabel;
    @UiField TextArea licenseBox;
    @UiField Label productName;
    @UiField HTMLPanel productInfo;

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -172,6 +172,7 @@ public static String idFromLabel(String label)
    // FindInFilesDialog
    public final static String FIND_FILES_TEXT = "find_files_text";
    public static String getFindFilesText() { return getElementId(FIND_FILES_TEXT); }
+   public final static String FIND_FILES_PATTERN_EXAMPLE = "find_files_pattern_example";
 
    // ImportFileSettingsDialog
    public final static String IMPORT_FILE_NAME = "import_file_name";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindResult.java
Patch:
@@ -172,7 +172,7 @@ public final SafeHtml getLineHTML()
                   replaceParts.add(new Pair<Boolean, Integer>(true, (replaceOn.remove(0) + difference)));
                }
                else
-                  replaceParts.add(new Pair<Boolean, Integer>(false, (replaceOff.remove(0) + difference)));
+                  replaceParts.add(new Pair<Boolean, Integer>(false, (replaceOff.remove(0))));
             }
          }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DocUpdateSentinel.java
Patch:
@@ -413,7 +413,6 @@ private boolean doSaveImpl(final String path,
       JsArray<ChunkDefinition> oldChunkDefs = 
             sourceDoc_.getNotebookDoc().getChunkDefs();
       
-      //String patch = DiffMatchPatch.diff(oldContents, newContents);
       SubstringDiff diff = new SubstringDiff(oldContents, newContents);
 
       // Don't auto-save when there are no changes. In addition to being

File: src/gwt/src/org/rstudio/core/client/Debug.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * Debug.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -150,7 +150,7 @@ public static void devlogf(String format,
    
    public static void logToRConsole(String message)
    {
-      Element consoleEl = Document.get().getElementById("rstudio_console_output");
+      Element consoleEl = Document.get().getElementById(ElementIds.getElementId(ElementIds.CONSOLE_OUTPUT));
       if (consoleEl == null)
          return;
       

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -614,5 +614,6 @@
 
    // Accessibility
    public abstract AppCommand toggleScreenReaderSupport();
+   public abstract AppCommand toggleTabKeyMovesFocus();
    public abstract AppCommand showAccessibilityOptions();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManagerBase.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * CompletionManagerBase.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -718,7 +718,7 @@ private void onDocumentChanged(DocumentChangedEvent event)
    private boolean onTab()
    {
       // Don't auto complete if tab auto completion was disabled
-      if (!userPrefs_.tabCompletion().getValue())
+      if (!userPrefs_.tabCompletion().getValue() || userPrefs_.tabKeyMoveFocus().getValue())
          return false;
 
       // if the line is blank, don't request completions unless

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -433,7 +433,7 @@ public boolean previewKeyDown(NativeEvent event)
             }
          }
          else if (event.getKeyCode() == KeyCodes.KEY_TAB &&
-                  modifier == KeyboardShortcut.SHIFT)
+                  modifier == KeyboardShortcut.SHIFT && !userPrefs_.tabKeyMoveFocus().getValue())
          {
             return snippets_.attemptSnippetInsertion(true);
          }
@@ -1078,7 +1078,7 @@ private boolean beginSuggest(boolean flushCache,
       // Don't auto complete if tab was pressed and tab completion was disabled.
       if (nativeEvent_ != null &&
               nativeEvent_.getKeyCode() == KeyCodes.KEY_TAB &&
-              !userPrefs_.tabCompletion().getValue())
+              (!userPrefs_.tabCompletion().getValue() || userPrefs_.tabKeyMoveFocus().getValue()))
          return false;
       
       if (!input_.isSelectionCollapsed())

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -402,7 +402,7 @@ public Source(Commands commands,
       commands.goToDefinition().setShortcut(new KeyboardShortcut("F2", KeyCodes.KEY_F2, KeyboardShortcut.NONE));
 
       // If tab has been disabled for auto complete by the user, set the "shortcut" to ctrl-space instead.
-      if (userPrefs_.tabCompletion().getValue())
+      if (userPrefs_.tabCompletion().getValue() && !userPrefs_.tabKeyMoveFocus().getValue())
          commands.codeCompletion().setShortcut(new KeyboardShortcut("Tab", KeyCodes.KEY_TAB, KeyboardShortcut.NONE));
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalDeckPanel.java
Patch:
@@ -36,10 +36,11 @@ public class TerminalDeckPanel extends DeckLayoutPanel
    public void addNewTerminalPanel(
          ConsoleProcessInfo procInfo,
          XTermOptions options,
+         boolean tabMovesFocus,
          boolean createdByApi,
          CommandWithArg<TerminalSession> callback)
    {
-      TerminalSession session = new TerminalSession(procInfo, options, createdByApi);
+      TerminalSession session = new TerminalSession(procInfo, options, tabMovesFocus, createdByApi);
       add(session);
       showWidget(session);
       Scheduler.get().scheduleDeferred(() ->  callback.execute(session));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -323,6 +323,7 @@ public void createTerminal(final String postCreateText)
       ConsoleProcessInfo info = ConsoleProcessInfo.createNewTerminalInfo(
             uiPrefs_.terminalTrackEnvironment().getValue());
       terminalSessionsPanel_.addNewTerminalPanel(info, defaultTerminalOptions(),
+                                                 uiPrefs_.tabKeyMoveFocus().getValue(),
                                                  false /*createdByApi*/, arg -> {
          terminals_.startTerminal(arg, new ResultCallback<Boolean, String>()
             {
@@ -838,6 +839,7 @@ public void onFailure(String msg)
       }
 
       terminalSessionsPanel_.addNewTerminalPanel(existing, defaultTerminalOptions(),
+                                                 uiPrefs_.tabKeyMoveFocus().getValue(),
                                                  event.createdByApi(), arg -> {
          terminals_.startTerminal(arg, new ResultCallback<Boolean, String>()
             {

File: src/gwt/src/org/rstudio/core/client/HandlerRegistrations.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HandlerRegistrations.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -37,6 +37,5 @@ public void removeHandler()
          registrations_.remove(0).removeHandler();
    }
 
-   private final ArrayList<HandlerRegistration> registrations_ =
-         new ArrayList<HandlerRegistration>();
+   private final ArrayList<HandlerRegistration> registrations_ = new ArrayList<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -31,7 +31,6 @@
 import com.google.inject.Inject;
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.DebouncedCommand;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.events.EnsureVisibleEvent;
 import org.rstudio.core.client.events.HasSelectionCommitHandlers;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindResult.java
Patch:
@@ -19,7 +19,6 @@
 import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.safehtml.shared.SafeHtml;
 import com.google.gwt.safehtml.shared.SafeHtmlBuilder;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.Pair;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.JsArrayUtil;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -194,7 +194,8 @@ public void onFindOperationEnded(
          {
             if (event.getHandle() == currentFindHandle_)
             {
-               currentFindHandle_ = null;
+               if (!view_.getReplaceMode())
+                  currentFindHandle_ = null;
                view_.setStopSearchButtonVisible(false);
                view_.showSearchCompleted();
             }
@@ -578,6 +579,7 @@ private void stopReplace()
                              new VoidServerRequestCallback());
          currentFindHandle_ = null;
          view_.setStopReplaceButtonVisible(false);
+         view_.hideProgress();
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -347,8 +347,8 @@ public void onReplaceResult(ReplaceResultEvent event)
             }
             dialogState_.updateErrorCount(errorCount);
 
-            view_.addMatches(results);
             view_.setReplaceMode(false);
+            view_.addMatches(results);
             
             view_.ensureVisible(true);
             view_.disableReplace();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -316,7 +316,7 @@ public void onReplaceProgress(ReplaceProgressEvent event)
             Debug.logToConsole("Replace progress event " + event.units() + " units out of " + event.max());
             view_.showProgress();
             view_.getProgress().setProgress(event.units(), event.max());
-            if (event.units() == event.max())
+            if (event.units() >= event.max())
             {
                view_.hideProgress();
                events_.fireEvent(new ReplaceOperationEndedEvent(currentFindHandle_));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/Plots.java
Patch:
@@ -22,7 +22,6 @@
 import com.google.gwt.event.logical.shared.SelectionHandler;
 import com.google.gwt.json.client.JSONObject;
 import com.google.gwt.user.client.ui.HasWidgets;
-import com.google.gwt.user.client.ui.Panel;
 import com.google.inject.Inject;
 import com.google.inject.Provider;
 
@@ -88,7 +87,7 @@ public interface Display extends WorkbenchView, HasResizeHandlers
       
       void refresh();
    
-      Panel getPlotsSurface();
+      PlotsSurface getPlotsSurface();
       
       Parent getPlotsParent();
       Size getPlotFrameSize();

File: src/gwt/src/org/rstudio/core/client/theme/ModuleTabLayoutPanel.java
Patch:
@@ -144,9 +144,9 @@ private void setBusy(boolean isBusy)
       private ProgressSpinner busySpinner_;
    }
 
-   public ModuleTabLayoutPanel(final WindowFrame owner)
+   public ModuleTabLayoutPanel(final WindowFrame owner, String tabListName)
    {
-      super(BAR_HEIGHT, Style.Unit.PX, "Pane");
+      super(BAR_HEIGHT, Style.Unit.PX, tabListName);
       owner_ = owner;
       styles_ = ThemeResources.INSTANCE.themeStyles();
       addStyleName(styles_.moduleTabPanel());

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/ConsoleTabPanel.java
Patch:
@@ -75,7 +75,7 @@ public ConsoleTabPanel(final PrimaryWindowFrame owner,
                           WorkbenchTab jobsTab,
                           WorkbenchTab launcherJobsTab)
    {
-      super(owner, parentWindow);
+      super(owner, parentWindow, "ConsoleTabSet");
       owner_ = owner;
       consolePane_ = consolePane;
       compilePdfTab_ = compilePdfTab;
@@ -421,7 +421,8 @@ public void onWorkingDirChanged(WorkingDirChangedEvent event)
          if (Desktop.hasDesktopFrame())
          {
             // if there are session servers defined, we will show the launcher tab
-            Desktop.getFrame().getSessionServers(servers -> {
+            Desktop.getFrame().getSessionServers(servers ->
+            {
                if (servers.length() > 0)
                {
                   showLauncherTab.execute();

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -977,7 +977,7 @@ private LogicalWindow createSource()
       final MinimizedModuleTabLayoutPanel minimized = new MinimizedModuleTabLayoutPanel();
       final LogicalWindow logicalWindow = new LogicalWindow(frame, minimized);
 
-      final WorkbenchTabPanel tabPanel = new WorkbenchTabPanel(frame, logicalWindow);
+      final WorkbenchTabPanel tabPanel = new WorkbenchTabPanel(frame, logicalWindow, persisterName);
 
       if (persisterName == "TabSet1")
          tabs1_ = tabs;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchTabPanel.java
Patch:
@@ -46,14 +46,14 @@ class WorkbenchTabPanel
                  HasEnsureVisibleHandlers,
                  HasEnsureHeightHandlers
 {
-   public WorkbenchTabPanel(WindowFrame owner, LogicalWindow parentWindow)
+   public WorkbenchTabPanel(WindowFrame owner, LogicalWindow parentWindow, String tabListName)
    {
       final int UTILITY_AREA_SIZE = 52;
       panel_ = new LayoutPanel();
       
       parentWindow_ = parentWindow;
 
-      tabPanel_ = new ModuleTabLayoutPanel(owner);
+      tabPanel_ = new ModuleTabLayoutPanel(owner, tabListName);
       panel_.add(tabPanel_);
       panel_.setWidgetTopBottom(tabPanel_, 0, Unit.PX, 0, Unit.PX);
       panel_.setWidgetLeftRight(tabPanel_, 0, Unit.PX, 0, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetHost.java
Patch:
@@ -15,7 +15,6 @@
 
 package org.rstudio.studio.client.workbench.views.connections.ui;
 
-
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.Comparator;
@@ -34,6 +33,7 @@
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.ThemedButton;
+import org.rstudio.core.client.widget.images.MessageDialogImages;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.DelayedProgressRequestCallback;
@@ -121,6 +121,7 @@ private void initialize(final Operation operation, final NewConnectionInfo info)
          warningPanel.addStyleName(RES.styles().warningPanel());
          Image warningImage = new Image(new ImageResource2x(ThemeResources.INSTANCE.warningSmall2x()));
          warningImage.addStyleName(RES.styles().warningImage());
+         warningImage.setAltText(MessageDialogImages.DIALOG_WARNING_TEXT);
          warningPanel.add(warningImage);
          
          Label label = new Label();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobItem.java
Patch:
@@ -21,7 +21,6 @@
 import com.google.inject.assistedinject.Assisted;
 import org.rstudio.core.client.JsArrayUtil;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.ProgressBar;
@@ -128,7 +127,6 @@ public JobItem(@Assisted Job job, FireEvents eventBus, Preferences prefs)
       name_.setText(job.name);
       progress_.setLabel(job.name);
       spinner_.setResource(new ImageResource2x(RESOURCES.jobSpinner()));
-      A11y.setDecorativeImage(spinner_.getElement());
 
       ImageResource2x detailsImage = new ImageResource2x(RESOURCES.jobSelect());
       if (JsArrayUtil.jsArrayStringContains(job.actions, JobConstants.ACTION_INFO))

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -71,6 +71,7 @@ protected void onAttach()
          parentToolbar_ = getParentToolbar();
 
          super.onAttach();
+         ElementIds.assignElementId(getElement(), "tb_" + ElementIds.idSafeString(getId()));
       }
 
       @Override
@@ -493,7 +494,6 @@ public ToolbarButton createToolbarButton(boolean synced)
                                                              synced);
       if (getTooltip() != null)
          button.setTitle(getTooltip());
-      ElementIds.assignElementId(button.getElement(), "tb_" + ElementIds.idSafeString(getId()));
       return button;
    }
 

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShortcutManager.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -467,8 +467,7 @@ public void execute()
             AceEditorNative nativeEditor = AceEditorNative.getEditor(target);
             if (editor != null && nativeEditor != null &&
                   nativeEditor == editor.getWidget().getEditor() &&
-                  editor.getWidget().getElement().getId() ==
-                     ElementIds.getElementId(ElementIds.SOURCE_TEXT_EDITOR))
+                  ElementIds.isInstanceOf(editor.getWidget(), ElementIds.SOURCE_TEXT_EDITOR))
             {
                keyBuffer_.clear();
                commands_.expandToLine().execute();

File: src/gwt/src/org/rstudio/core/client/widget/TextBoxWithButton.java
Patch:
@@ -205,7 +205,7 @@ public void focus()
    }
 
    @Override
-   public void onAttach()
+   protected void onAttach()
    {
       super.onAttach();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -423,6 +423,7 @@ protected SecondaryToolbar createSecondaryToolbar()
       connectionIcon_ = new Image();
       connectionIcon_.setWidth("16px");
       connectionIcon_.setHeight("16px");
+      connectionIcon_.setAltText(""); // decorative image
       connectionType_ = new ToolbarLabel();
       connectionType_.getElement().getStyle().setMarginLeft(5, Unit.PX);
       connectionType_.getElement().getStyle().setMarginRight(10, Unit.PX);

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.rstudio.core.client.AnsiCodeTests;
 import org.rstudio.core.client.ConsoleOutputWriterTests;
+import org.rstudio.core.client.ElementIdsTests;
 import org.rstudio.core.client.StringUtilTests;
 import org.rstudio.core.client.URIUtilsTests;
 import org.rstudio.core.client.VirtualConsoleTests;
@@ -51,6 +52,7 @@ public static Test suite()
       // suite.addTestSuite(RChunkHeaderParserTests.class);
       suite.addTestSuite(SessionScopeTests.class);
       suite.addTestSuite(JobsListTests.class);
+      suite.addTestSuite(ElementIdsTests.class);
       
       // Pro-only tests
       

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -71,6 +71,7 @@ protected void onAttach()
          parentToolbar_ = getParentToolbar();
 
          super.onAttach();
+         ElementIds.assignElementId(getElement(), "tb_" + ElementIds.idSafeString(getId()));
       }
 
       @Override
@@ -493,7 +494,6 @@ public ToolbarButton createToolbarButton(boolean synced)
                                                              synced);
       if (getTooltip() != null)
          button.setTitle(getTooltip());
-      ElementIds.assignElementId(button.getElement(), "tb_" + ElementIds.idSafeString(getId()));
       return button;
    }
 

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShortcutManager.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -467,8 +467,7 @@ public void execute()
             AceEditorNative nativeEditor = AceEditorNative.getEditor(target);
             if (editor != null && nativeEditor != null &&
                   nativeEditor == editor.getWidget().getEditor() &&
-                  editor.getWidget().getElement().getId() ==
-                     ElementIds.getElementId(ElementIds.SOURCE_TEXT_EDITOR))
+                  ElementIds.isInstanceOf(editor.getWidget(), ElementIds.SOURCE_TEXT_EDITOR))
             {
                keyBuffer_.clear();
                commands_.expandToLine().execute();

File: src/gwt/src/org/rstudio/core/client/widget/TextBoxWithButton.java
Patch:
@@ -205,7 +205,7 @@ public void focus()
    }
 
    @Override
-   public void onAttach()
+   protected void onAttach()
    {
       super.onAttach();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -423,6 +423,7 @@ protected SecondaryToolbar createSecondaryToolbar()
       connectionIcon_ = new Image();
       connectionIcon_.setWidth("16px");
       connectionIcon_.setHeight("16px");
+      connectionIcon_.setAltText(""); // decorative image
       connectionType_ = new ToolbarLabel();
       connectionType_.getElement().getStyle().setMarginLeft(5, Unit.PX);
       connectionType_.getElement().getStyle().setMarginRight(10, Unit.PX);

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.rstudio.core.client.AnsiCodeTests;
 import org.rstudio.core.client.ConsoleOutputWriterTests;
+import org.rstudio.core.client.ElementIdsTests;
 import org.rstudio.core.client.StringUtilTests;
 import org.rstudio.core.client.URIUtilsTests;
 import org.rstudio.core.client.VirtualConsoleTests;
@@ -51,6 +52,7 @@ public static Test suite()
       // suite.addTestSuite(RChunkHeaderParserTests.class);
       suite.addTestSuite(SessionScopeTests.class);
       suite.addTestSuite(JobsListTests.class);
+      suite.addTestSuite(ElementIdsTests.class);
       
       // Pro-only tests
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -362,7 +362,6 @@ public void onReplaceOperationEnded(
             if (event.getHandle() == currentFindHandle_)
             {
                Debug.logToConsole("Replace Operation Ended with "+ dialogState_.getErrorCount() + " errors.");
-               Debug.logToConsole("Errors: " + dialogState_.getReplaceErrors());
                if (dialogState_.getErrorCount() > 0)
                   globalDisplay_.showMessage(MessageDialog.INFO,
                                              "Replace Errors",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -307,7 +307,7 @@ public void addMatches(ArrayList<FindResult> findResults)
          table_.addItems(findResults.subList(0, matchesToAdd), false);
       }
       
-      if (matchesToAdd != findResults.size())
+      if (matchCount_ >= MAX_COUNT)
          showOverflow();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/events/ReplaceResultEvent.java
Patch:
@@ -34,7 +34,6 @@ protected Data()
       {
       }
 
-
       public native final String getHandle() /*-{
          return this.handle;
       }-*/;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -94,8 +94,8 @@ private native JsArrayString getFilePatternsNative() /*-{
          return this.filePatterns;
       }-*/;
 
-      public native final void setResultsCount(int count) /*-{
-         this.resultsCount = count;
+      public native final void updateResultsCount(int count) /*-{
+         this.resultsCount += count;
       }-*/;
 
       public native final int getResultsCount() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobProgress.java
Patch:
@@ -53,13 +53,15 @@ public void showProgress(LocalJobProgress progress)
    {
       name_.setText(progress.name());
       progress_.setProgress(progress.units(), progress.max());
+      progress_.setLabel(progress.name());
       jobProgress_ = progress;
    }
    
    @Override
    public void showJob(Job job)
    {
       name_.setText(job.name);
+      progress_.setLabel(job.name);
       String status = JobConstants.stateDescription(job.state);
       if (job.completed > 0)
       {

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -179,6 +179,8 @@ public static String idFromLabel(String label)
    public final static String VCS_MENUBUTTON = "vcs_menubutton";
    public final static String PANELAYOUT_MENUBUTTON = "panelayout_menubutton";
    public final static String PROJECT_MENUBUTTON = "project_menubutton";
+   public final static String PROJECT_MENUBUTTON_TOOLBAR_SUFFIX = "toolbar";
+   public final static String PROJECT_MENUBUTTON_MENUBAR_SUFFIX = "menubar";
 
    // BuildPane
    public final static String BUILD_MORE_MENUBUTTON = "build_more_menubutton";

File: src/gwt/src/org/rstudio/core/client/layout/FadeInAnimation.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FadeInAnimation.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -27,7 +27,7 @@ public FadeInAnimation(Widget widget,
                           double targetOpacity,
                           Command callback)
    {
-      this(new ArrayList<Widget>(), targetOpacity, callback);
+      this(new ArrayList<>(), targetOpacity, callback);
       widgets_.add(widget);
    }
 
@@ -61,6 +61,7 @@ protected void onComplete()
       for (Widget w : widgets_)
       {
          w.getElement().getStyle().setOpacity(targetOpacity_);
+         w.setVisible(true);
       }
       if (callback_ != null)
          callback_.execute();

File: src/gwt/src/org/rstudio/core/client/widget/ImageButton.java
Patch:
@@ -26,7 +26,7 @@
 import com.google.gwt.user.client.ui.FocusWidget;
 import com.google.gwt.user.client.ui.Image;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.theme.res.ThemeStyles;
+import org.rstudio.core.client.a11y.A11y;
 
 /**
  * An image that behaves like a button.
@@ -53,7 +53,7 @@ public ImageButton(String description, ImageResource image)
       button.insertFirst(image_.getElement());
 
       descriptionSpan_ = Document.get().createSpanElement();
-      descriptionSpan_.setClassName(ThemeStyles.INSTANCE.visuallyHidden());
+      A11y.setVisuallyHidden(descriptionSpan_);
       button.appendChild(descriptionSpan_);
       setDescription(description);
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/GlobalToolbar.java
Patch:
@@ -231,7 +231,8 @@ else if (sessionInfo.getVcsName() == VCSConstants.SVN_ID)
       // project popup menu
       if (sessionInfo.getAllowFullUI())
       {
-         ProjectPopupMenu projectMenu = new ProjectPopupMenu(sessionInfo, commands_);
+         ProjectPopupMenu projectMenu = new ProjectPopupMenu(
+               sessionInfo, commands_, ElementIds.PROJECT_MENUBUTTON_TOOLBAR_SUFFIX);
          addRightWidget(projectMenu.getToolbarButton());
       }
    }

File: src/gwt/src/org/rstudio/studio/client/application/ui/serializationprogress/ApplicationSerializationProgressLabel.java
Patch:
@@ -14,13 +14,13 @@
  */
 package org.rstudio.studio.client.application.ui.serializationprogress;
 
-import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.Widget;
+import org.rstudio.core.client.a11y.A11y;
 
 public class ApplicationSerializationProgressLabel extends Composite
 {
@@ -32,7 +32,7 @@ interface MyBinder
    public ApplicationSerializationProgressLabel()
    {
       initWidget(binder.createAndBindUi(this));
-      Roles.getStatusRole().set(label_.getElement());
+      A11y.setStatusRole(label_, false);
    }
 
    public void setText(String text)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -495,7 +495,6 @@ public HasClickHandlers getStopReplaceButton()
    @Override
    public void setStopReplaceButtonVisible(boolean visible)
    {
-      Debug.logToConsole("Set Stop Replace Button" + visible);
       stopReplace_.setVisible(visible);
    }
 

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -179,6 +179,8 @@ public static String idFromLabel(String label)
    public final static String VCS_MENUBUTTON = "vcs_menubutton";
    public final static String PANELAYOUT_MENUBUTTON = "panelayout_menubutton";
    public final static String PROJECT_MENUBUTTON = "project_menubutton";
+   public final static String PROJECT_MENUBUTTON_TOOLBAR_SUFFIX = "toolbar";
+   public final static String PROJECT_MENUBUTTON_MENUBAR_SUFFIX = "menubar";
 
    // BuildPane
    public final static String BUILD_MORE_MENUBUTTON = "build_more_menubutton";

File: src/gwt/src/org/rstudio/studio/client/application/ui/GlobalToolbar.java
Patch:
@@ -231,7 +231,8 @@ else if (sessionInfo.getVcsName() == VCSConstants.SVN_ID)
       // project popup menu
       if (sessionInfo.getAllowFullUI())
       {
-         ProjectPopupMenu projectMenu = new ProjectPopupMenu(sessionInfo, commands_);
+         ProjectPopupMenu projectMenu = new ProjectPopupMenu(
+               sessionInfo, commands_, ElementIds.PROJECT_MENUBUTTON_TOOLBAR_SUFFIX);
          addRightWidget(projectMenu.getToolbarButton());
       }
    }

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -179,6 +179,8 @@ public static String idFromLabel(String label)
    public final static String VCS_MENUBUTTON = "vcs_menubutton";
    public final static String PANELAYOUT_MENUBUTTON = "panelayout_menubutton";
    public final static String PROJECT_MENUBUTTON = "project_menubutton";
+   public final static String PROJECT_MENUBUTTON_TOOLBAR_SUFFIX = "toolbar";
+   public final static String PROJECT_MENUBUTTON_MENUBAR_SUFFIX = "menubar";
 
    // BuildPane
    public final static String BUILD_MORE_MENUBUTTON = "build_more_menubutton";

File: src/gwt/src/org/rstudio/studio/client/application/ui/GlobalToolbar.java
Patch:
@@ -231,7 +231,8 @@ else if (sessionInfo.getVcsName() == VCSConstants.SVN_ID)
       // project popup menu
       if (sessionInfo.getAllowFullUI())
       {
-         ProjectPopupMenu projectMenu = new ProjectPopupMenu(sessionInfo, commands_);
+         ProjectPopupMenu projectMenu = new ProjectPopupMenu(
+               sessionInfo, commands_, ElementIds.PROJECT_MENUBUTTON_TOOLBAR_SUFFIX);
          addRightWidget(projectMenu.getToolbarButton());
       }
    }

File: src/gwt/src/org/rstudio/core/client/layout/FadeInAnimation.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FadeInAnimation.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -27,7 +27,7 @@ public FadeInAnimation(Widget widget,
                           double targetOpacity,
                           Command callback)
    {
-      this(new ArrayList<Widget>(), targetOpacity, callback);
+      this(new ArrayList<>(), targetOpacity, callback);
       widgets_.add(widget);
    }
 
@@ -61,6 +61,7 @@ protected void onComplete()
       for (Widget w : widgets_)
       {
          w.getElement().getStyle().setOpacity(targetOpacity_);
+         w.setVisible(true);
       }
       if (callback_ != null)
          callback_.execute();

File: src/gwt/src/org/rstudio/core/client/widget/ImageButton.java
Patch:
@@ -26,7 +26,7 @@
 import com.google.gwt.user.client.ui.FocusWidget;
 import com.google.gwt.user.client.ui.Image;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.theme.res.ThemeStyles;
+import org.rstudio.core.client.a11y.A11y;
 
 /**
  * An image that behaves like a button.
@@ -53,7 +53,7 @@ public ImageButton(String description, ImageResource image)
       button.insertFirst(image_.getElement());
 
       descriptionSpan_ = Document.get().createSpanElement();
-      descriptionSpan_.setClassName(ThemeStyles.INSTANCE.visuallyHidden());
+      A11y.setVisuallyHidden(descriptionSpan_);
       button.appendChild(descriptionSpan_);
       setDescription(description);
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/serializationprogress/ApplicationSerializationProgressLabel.java
Patch:
@@ -14,13 +14,13 @@
  */
 package org.rstudio.studio.client.application.ui.serializationprogress;
 
-import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.Widget;
+import org.rstudio.core.client.a11y.A11y;
 
 public class ApplicationSerializationProgressLabel extends Composite
 {
@@ -32,7 +32,7 @@ interface MyBinder
    public ApplicationSerializationProgressLabel()
    {
       initWidget(binder.createAndBindUi(this));
-      Roles.getStatusRole().set(label_.getElement());
+      A11y.setStatusRole(label_, false);
    }
 
    public void setText(String text)

File: src/gwt/src/org/rstudio/core/client/a11y/A11y.java
Patch:
@@ -162,10 +162,10 @@ public static void setVisuallyHidden(Element el)
 
    public static void unsetVisuallyHidden(Widget widget)
    {
-      setVisuallyHidden(widget.getElement());
+      unsetVisuallyHidden(widget.getElement());
    }
 
-   public static void unsetlVisuallyHidden(Element el)
+   public static void unsetVisuallyHidden(Element el)
    {
       el.removeClassName(ThemeStyles.INSTANCE.visuallyHidden());
    }

File: src/gwt/src/org/rstudio/core/client/widget/FieldSetPanel.java
Patch:
@@ -72,7 +72,7 @@ public void setLegendHidden(boolean hidden)
       if (hidden)
          A11y.setVisuallyHidden(legendElement_);
       else
-         A11y.unsetlVisuallyHidden(legendElement_);
+         A11y.unsetVisuallyHidden(legendElement_);
    }
 
    private Element legendElement_;

File: src/gwt/src/org/rstudio/core/client/layout/FadeInAnimation.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FadeInAnimation.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -27,7 +27,7 @@ public FadeInAnimation(Widget widget,
                           double targetOpacity,
                           Command callback)
    {
-      this(new ArrayList<Widget>(), targetOpacity, callback);
+      this(new ArrayList<>(), targetOpacity, callback);
       widgets_.add(widget);
    }
 
@@ -61,6 +61,7 @@ protected void onComplete()
       for (Widget w : widgets_)
       {
          w.getElement().getStyle().setOpacity(targetOpacity_);
+         w.setVisible(true);
       }
       if (callback_ != null)
          callback_.execute();

File: src/gwt/src/org/rstudio/core/client/widget/ImageButton.java
Patch:
@@ -26,7 +26,7 @@
 import com.google.gwt.user.client.ui.FocusWidget;
 import com.google.gwt.user.client.ui.Image;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.theme.res.ThemeStyles;
+import org.rstudio.core.client.a11y.A11y;
 
 /**
  * An image that behaves like a button.
@@ -53,7 +53,7 @@ public ImageButton(String description, ImageResource image)
       button.insertFirst(image_.getElement());
 
       descriptionSpan_ = Document.get().createSpanElement();
-      descriptionSpan_.setClassName(ThemeStyles.INSTANCE.visuallyHidden());
+      A11y.setVisuallyHidden(descriptionSpan_);
       button.appendChild(descriptionSpan_);
       setDescription(description);
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/serializationprogress/ApplicationSerializationProgressLabel.java
Patch:
@@ -14,13 +14,13 @@
  */
 package org.rstudio.studio.client.application.ui.serializationprogress;
 
-import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.Widget;
+import org.rstudio.core.client.a11y.A11y;
 
 public class ApplicationSerializationProgressLabel extends Composite
 {
@@ -32,7 +32,7 @@ interface MyBinder
    public ApplicationSerializationProgressLabel()
    {
       initWidget(binder.createAndBindUi(this));
-      Roles.getStatusRole().set(label_.getElement());
+      A11y.setStatusRole(label_, false);
    }
 
    public void setText(String text)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -73,7 +73,7 @@ protected Toolbar createMainToolbar()
 
       FindOutputResources resources = GWT.create(FindOutputResources.class);
       viewReplaceButton_ = new ToolbarButton("Replace", "Replace",
-                                             resources.collapseReplaceIcon());
+                                             resources.expandReplaceIcon());
       toolbar.addRightWidget(viewReplaceButton_);
       viewReplaceButton_.addClickHandler(new ClickHandler()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindResult.java
Patch:
@@ -217,7 +217,6 @@ else if (openEmTags > 0)
 
    public final SafeHtml getLineReplaceHTML()
    {
-      Debug.logToConsole("getLineReplaceHTML");
       SafeHtmlBuilder out = new SafeHtmlBuilder();
 
       ArrayList<Integer> on = getMatchOns();
@@ -238,7 +237,6 @@ public final SafeHtml getLineReplaceHTML()
             parts.add(new Pair<Boolean, Integer>(false, offReplace.remove(0)));
       }
 
-      Debug.logToConsole("parts.size(): " + parts.size());
       String line = getLineValue();
 
       // Use a counter to ensure tags are balanced.

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -29,6 +29,7 @@
 import org.rstudio.core.client.command.ShortcutViewer;
 import org.rstudio.core.client.command.UserCommandManager;
 import org.rstudio.core.client.dom.BrowserEventWorkarounds;
+import org.rstudio.core.client.polyfill.FastestSmallestTextEncoderDecoder;
 import org.rstudio.core.client.HtmlMessageListener;
 import org.rstudio.studio.client.application.ApplicationInterrupt;
 import org.rstudio.studio.client.application.ApplicationQuit;
@@ -317,6 +318,7 @@ protected void configure()
       bind(JobManager.class).asEagerSingleton();
       bind(HtmlMessageListener.class).asEagerSingleton();
       bind(BrowserEventWorkarounds.class).asEagerSingleton();
+      bind(FastestSmallestTextEncoderDecoder.class).asEagerSingleton();
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindResultContext.java
Patch:
@@ -147,6 +147,7 @@ public AbstractDataProvider<File> getDataProvider()
    public void reset()
    {
       data_.getList().clear();
+      findResults_.clear();
       filesByName_.clear();
       maxLineWidth_ = 0;
    }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -2080,6 +2080,7 @@ public void saveDocumentDiff(String id,
                                 String replacement,
                                 int offset,
                                 int length,
+                                boolean valid,
                                 String hash,
                                 ServerRequestCallback<String> requestCallback)
    {
@@ -2095,7 +2096,8 @@ public void saveDocumentDiff(String id,
       params.set(6, new JSONString(replacement));
       params.set(7, new JSONNumber(offset));
       params.set(8, new JSONNumber(length));
-      params.set(9, new JSONString(hash));
+      params.set(9, JSONBoolean.getInstance(valid));
+      params.set(10, new JSONString(hash));
       sendRequest(RPC_SCOPE, SAVE_DOCUMENT_DIFF, params, requestCallback);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DocUpdateSentinel.java
Patch:
@@ -418,7 +418,7 @@ private boolean doSaveImpl(final String path,
 
       // Don't auto-save when there are no changes. In addition to being
       // wasteful, it causes the server to think the document is dirty.
-      if (path == null && fileType == null && diff.isEmpty()
+      if (path == null && fileType == null && diff.isValid() && diff.isEmpty()
           && foldSpec == oldFoldSpec 
           && (newChunkDefs == null || 
               ChunkDefinition.equalTo(newChunkDefs, oldChunkDefs)))
@@ -464,6 +464,7 @@ private boolean doSaveImpl(final String path,
             diff.getReplacement(),
             diff.getOffset(),
             diff.getLength(),
+            diff.isValid(),
             hash,
             new ServerRequestCallback<String>()
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -123,6 +123,7 @@ void saveDocumentDiff(String id,
                          String replacement,
                          int offset,
                          int length,
+                         boolean valid,
                          String hash,
                          ServerRequestCallback<String> requestCallback);
 

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogBase.java
Patch:
@@ -94,8 +94,9 @@ protected PreferencesDialogBase(String caption,
 
          // SectionChooser is first focusable control in the modal dialog, and it
          // uses a roving tabindex to determine the focused section tab, so notify dialog
-         // when focus leaves or arrives at first tab
-         if ((currentIndex_ != null && currentIndex_ == 0) || index == 0)
+         // when selected tab changes (except the initial selection, which happens before
+         // the dialog is fully assembled and thus nothing is focusable, yet)
+         if (currentIndex_ != null)
             refreshFocusableElements();
 
          if (currentIndex_ != null)

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogBase.java
Patch:
@@ -94,8 +94,9 @@ protected PreferencesDialogBase(String caption,
 
          // SectionChooser is first focusable control in the modal dialog, and it
          // uses a roving tabindex to determine the focused section tab, so notify dialog
-         // when focus leaves or arrives at first tab
-         if ((currentIndex_ != null && currentIndex_ == 0) || index == 0)
+         // when selected tab changes (except the initial selection, which happens before
+         // the dialog is fully assembled and thus nothing is focusable, yet)
+         if (currentIndex_ != null)
             refreshFocusableElements();
 
          if (currentIndex_ != null)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManagerBase.java
Patch:
@@ -730,8 +730,7 @@ private boolean onTab()
             return false;
       }
       
-      beginSuggest(true, true, true);
-      return true;
+      return beginSuggest(true, true, true);
    }
    
    private void showPopupHelp(QualifiedName completion)

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -417,6 +417,7 @@
    public abstract AppCommand activateTerminal();
    public abstract AppCommand renameTerminal();
    public abstract AppCommand closeTerminal();
+   public abstract AppCommand closeAllTerminals();
    public abstract AppCommand clearTerminalScrollbackBuffer();
    public abstract AppCommand previousTerminal();
    public abstract AppCommand nextTerminal();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManagerBase.java
Patch:
@@ -730,8 +730,7 @@ private boolean onTab()
             return false;
       }
       
-      beginSuggest(true, true, true);
-      return true;
+      return beginSuggest(true, true, true);
    }
    
    private void showPopupHelp(QualifiedName completion)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -172,7 +172,7 @@ public void onClick(ClickEvent event)
          @Override
          public void onPreviewReplace(PreviewReplaceEvent event)
          {
-            server_.previewReplace(dialogState.getQuery(),
+            server_.previewReplace(dialogState_.getQuery(),
                                    view_.getReplaceText(),
                                    view_.isReplaceRegex(),
                                    view_.useGitIgnore(),
@@ -182,7 +182,6 @@ public void onPreviewReplace(PreviewReplaceEvent event)
                                       public void onResponseReceived(String handle)
                                       {
                                          Debug.logToConsole("Preview replace response received");
-                                         Debug.logToConsole(string);
                                       }
                                    });
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindInFilesServerOperations.java
Patch:
@@ -37,7 +37,7 @@ void previewReplace(String searchString,
                        String replaceString,
                        boolean regex,
                        boolean gitIgnore,
-                       ServerRequestCallback<Void> requestCallback);
+                       ServerRequestCallback<String> requestCallback);
 
    void completeReplace(String searchString,
                         String replaceString,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindInFilesServerOperations.java
Patch:
@@ -43,7 +43,7 @@ void completeReplace(String searchString,
                         String replaceString,
                         boolean regex,
                         boolean gitIgnore,
-                        ServerRequestCallback<Void> requestCallback);
+                        ServerRequestCallback<String> requestCallback);
 
    void stopReplace(ServerRequestCallback<Void> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/application/ui/WarningBar.java
Patch:
@@ -105,8 +105,9 @@ public void run()
 
    public void showLicenseButton(boolean show)
    {
-      // never show the license button in server mode
-      if (Desktop.hasDesktopFrame())
+      // never show the license button in server mode or remote desktop mode
+      // license button should only be visible when error is purely the result of a local license problem
+      if (Desktop.isDesktop())
          moreButton_.setVisible(show);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/PythonCompletionManager.java
Patch:
@@ -96,9 +96,10 @@ public void onError(ServerError error)
    }
 
    @Override
-   public void getCompletions(String line, CompletionRequestContext context)
+   public boolean getCompletions(String line, CompletionRequestContext context)
    {
       server_.pythonGetCompletions(buildCompletionLine(), completionContext(), context);
+      return true;
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/SqlCompletionManager.java
Patch:
@@ -50,11 +50,12 @@ public void goToDefinition()
    }
    
    @Override
-   public void getCompletions(String line,
-                              CompletionRequestContext context)
+   public boolean getCompletions(String line,
+                                 CompletionRequestContext context)
    {
       String connection = discoverAssociatedConnectionString();
       server_.sqlGetCompletions(line, connection, completionContext(), context);
+      return true;
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/StanCompletionManager.java
Patch:
@@ -79,9 +79,10 @@ public void onError(ServerError error)
    }
    
    @Override
-   public void getCompletions(String line, CompletionRequestContext context)
+   public boolean getCompletions(String line, CompletionRequestContext context)
    {
       server_.stanGetCompletions(line, context);
+      return true;
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/PythonCompletionManager.java
Patch:
@@ -96,9 +96,10 @@ public void onError(ServerError error)
    }
 
    @Override
-   public void getCompletions(String line, CompletionRequestContext context)
+   public boolean getCompletions(String line, CompletionRequestContext context)
    {
       server_.pythonGetCompletions(buildCompletionLine(), completionContext(), context);
+      return true;
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/SqlCompletionManager.java
Patch:
@@ -50,11 +50,12 @@ public void goToDefinition()
    }
    
    @Override
-   public void getCompletions(String line,
-                              CompletionRequestContext context)
+   public boolean getCompletions(String line,
+                                 CompletionRequestContext context)
    {
       String connection = discoverAssociatedConnectionString();
       server_.sqlGetCompletions(line, connection, completionContext(), context);
+      return true;
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/StanCompletionManager.java
Patch:
@@ -79,9 +79,10 @@ public void onError(ServerError error)
    }
    
    @Override
-   public void getCompletions(String line, CompletionRequestContext context)
+   public boolean getCompletions(String line, CompletionRequestContext context)
    {
       server_.stanGetCompletions(line, context);
+      return true;
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2352,7 +2352,6 @@ public void onDeactivate()
 
       commandHandlerReg_.removeHandler();
       commandHandlerReg_ = null;
-      Debug.log("deactivated " + this.id_);
 
       // switching tabs is a navigation action
       try

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPane.java
Patch:
@@ -249,6 +249,7 @@ public void addMatches(ArrayList<FindResult> findResults)
    public void addReplaceMatches(String value)
    {
       table_.clear();
+      matchCount_ = 0;
       context_.updateFileMatches(value);
       addMatches(context_.getFindResults());
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/model/FindResult.java
Patch:
@@ -78,6 +78,8 @@ public final ArrayList<Integer> getMatchOffs()
    public final native void setReplace(String value) /*-{
       if (value)
          this.replace = value;
+      else
+         this.replace = "";
    }-*/;
 
 

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -58,7 +58,6 @@
 import org.rstudio.studio.client.application.ui.LauncherSessionStatus;
 import org.rstudio.studio.client.application.ui.appended.ApplicationEndedPopupPanel;
 import org.rstudio.studio.client.application.ui.serializationprogress.ApplicationSerializationProgress;
-import org.rstudio.studio.client.application.ui.support.SupportPopupMenu;
 import org.rstudio.studio.client.common.StudioResources;
 import org.rstudio.studio.client.common.mirrors.ChooseMirrorDialog;
 import org.rstudio.studio.client.common.repos.SecondaryReposDialog;
@@ -407,7 +406,6 @@ private void ensureStylesInjected()
       BuildPaneResources.INSTANCE.styles().ensureInjected();
       
       ProgressDialog.ensureStylesInjected();
-      SupportPopupMenu.ensureStylesInjected();
       SlideLabel.ensureStylesInjected();
       ThemedButton.ensureStylesInjected();
       ThemedPopupPanel.ensureStylesInjected();

File: src/gwt/src/org/rstudio/studio/client/common/HelpLink.java
Patch:
@@ -60,7 +60,8 @@ public HelpLink(String caption,
       DecorativeImage helpImage = new DecorativeImage(new ImageResource2x(ThemeResources.INSTANCE.help2x()));
       helpImage.getElement().getStyle().setMarginRight(4, Unit.PX);
       helpPanel.add(helpImage);
-      helpLink_ = new HyperlinkLabel(caption, () -> {
+      helpLink_ = new HyperlinkLabel(caption, () ->
+      {
          if (isRStudioLink_) {
             RStudioGinjector.INSTANCE.getGlobalDisplay().openRStudioLink(
                link_,

File: src/gwt/src/org/rstudio/studio/client/common/vcs/SshKeyWidget.java
Patch:
@@ -60,9 +60,8 @@ public SshKeyWidget(GitServerOperations server, String textWidth)
             HasHorizontalAlignment.ALIGN_LEFT);
 
       HorizontalPanel linkPanel = new HorizontalPanel();
-      publicKeyLink_ = new HyperlinkLabel("View public key");
+      publicKeyLink_ = new HyperlinkLabel("View public key", () -> viewPublicKey());
       publicKeyLink_.addStyleName(RES.styles().viewPublicKeyLink());
-      publicKeyLink_.addClickHandler(event -> viewPublicKey());
       linkPanel.add(publicKeyLink_);
       captionPanel.add(publicKeyLink_);
       captionPanel.setCellHorizontalAlignment(

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -58,7 +58,6 @@
 import org.rstudio.studio.client.application.ui.LauncherSessionStatus;
 import org.rstudio.studio.client.application.ui.appended.ApplicationEndedPopupPanel;
 import org.rstudio.studio.client.application.ui.serializationprogress.ApplicationSerializationProgress;
-import org.rstudio.studio.client.application.ui.support.SupportPopupMenu;
 import org.rstudio.studio.client.common.StudioResources;
 import org.rstudio.studio.client.common.mirrors.ChooseMirrorDialog;
 import org.rstudio.studio.client.common.repos.SecondaryReposDialog;
@@ -407,7 +406,6 @@ private void ensureStylesInjected()
       BuildPaneResources.INSTANCE.styles().ensureInjected();
       
       ProgressDialog.ensureStylesInjected();
-      SupportPopupMenu.ensureStylesInjected();
       SlideLabel.ensureStylesInjected();
       ThemedButton.ensureStylesInjected();
       ThemedPopupPanel.ensureStylesInjected();

File: src/gwt/src/org/rstudio/studio/client/common/HelpLink.java
Patch:
@@ -60,7 +60,8 @@ public HelpLink(String caption,
       DecorativeImage helpImage = new DecorativeImage(new ImageResource2x(ThemeResources.INSTANCE.help2x()));
       helpImage.getElement().getStyle().setMarginRight(4, Unit.PX);
       helpPanel.add(helpImage);
-      helpLink_ = new HyperlinkLabel(caption, () -> {
+      helpLink_ = new HyperlinkLabel(caption, () ->
+      {
          if (isRStudioLink_) {
             RStudioGinjector.INSTANCE.getGlobalDisplay().openRStudioLink(
                link_,

File: src/gwt/src/org/rstudio/studio/client/common/vcs/SshKeyWidget.java
Patch:
@@ -60,9 +60,8 @@ public SshKeyWidget(GitServerOperations server, String textWidth)
             HasHorizontalAlignment.ALIGN_LEFT);
 
       HorizontalPanel linkPanel = new HorizontalPanel();
-      publicKeyLink_ = new HyperlinkLabel("View public key");
+      publicKeyLink_ = new HyperlinkLabel("View public key", () -> viewPublicKey());
       publicKeyLink_.addStyleName(RES.styles().viewPublicKeyLink());
-      publicKeyLink_.addClickHandler(event -> viewPublicKey());
       linkPanel.add(publicKeyLink_);
       captionPanel.add(publicKeyLink_);
       captionPanel.setCellHorizontalAlignment(

File: src/gwt/src/org/rstudio/studio/client/application/ui/ProjectPopupMenu.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.application.ui;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
@@ -87,7 +88,8 @@ public ToolbarButton getToolbarButton()
                 new ImageResource2x(RESOURCES.projectMenu2x()),
                 this, 
                 true);
-          
+         ElementIds.assignElementId(toolbarButton_, ElementIds.PROJECT_MENUBUTTON);
+
          if (activeProjectFile_ != null)
          {
             toolbarButton_.setTitle(activeProjectFile_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -24,6 +24,7 @@
 import com.google.inject.Inject;
 
 import org.rstudio.core.client.CodeNavigationTarget;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.events.HasSelectionCommitHandlers;
 import org.rstudio.core.client.events.SelectionCommitEvent;
 import org.rstudio.core.client.events.SelectionCommitHandler;
@@ -95,6 +96,7 @@ protected Toolbar createMainToolbar()
          BookdownBuildPopupMenu buildPopupMenu = new BookdownBuildPopupMenu();
          ToolbarMenuButton buildMenuButton = new ToolbarMenuButton(ToolbarButton.NoText,
                "Build book options", buildPopupMenu, true);
+         ElementIds.assignElementId(buildMenuButton, ElementIds.BUILD_BOOKDOWN_MENUBUTTON);
          toolbar.addLeftWidget(buildMenuButton);
       }
       
@@ -143,6 +145,7 @@ else if (pkg)
                ToolbarButton.NoTitle,
                new ImageResource2x(StandardIcons.INSTANCE.more_actions2x()),
                moreMenu);
+         ElementIds.assignElementId(moreButton, ElementIds.BUILD_MORE_MENUBUTTON);
          toolbar.addLeftWidget(moreButton);
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -16,6 +16,7 @@
 package org.rstudio.studio.client.workbench.views.terminal;
 
 import org.rstudio.core.client.Debug;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.widget.ToolbarButton;
@@ -118,6 +119,8 @@ public ToolbarButton getToolbarButton()
                 this,
                 false);
 
+         ElementIds.assignElementId(toolbarButton_, ElementIds.TERMINAL_DROPDOWN_MENUBUTTON);
+
          setNoActiveTerminal();
       }
       return toolbarButton_;

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -236,7 +236,7 @@ public void moveTab(int index, int delta)
    public void selectTab(int index)
    {
       super.selectTab(index);
-      ensureSelectedTabIsVisible(true);
+      ensureSelectedTabIsVisible(!RStudioGinjector.INSTANCE.getUserPrefs().reducedMotion().getValue());
    }
 
    public void ensureSelectedTabIsVisible(boolean animate)
@@ -361,7 +361,7 @@ public boolean remove(int index)
          return false;
 
       fireEvent(new TabClosedEvent(index));
-      ensureSelectedTabIsVisible(true);
+      ensureSelectedTabIsVisible(!RStudioGinjector.INSTANCE.getUserPrefs().reducedMotion().getValue());
       return true;
    }
 

File: src/gwt/src/org/rstudio/core/client/widget/FilterWidget.java
Patch:
@@ -47,9 +47,9 @@ public Element getInputElement()
       return searchWidget_.getInputElement();
    }
 
-   public void speakResult(String message)
+   public void speakResult(String message, int speakDelayMs)
    {
-      searchWidget_.speakResult(message);
+      searchWidget_.speakResult(message, speakDelayMs);
    }
 
    private final SearchWidget searchWidget_;

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectCompilePdfPreferencesPane.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.prefs.PreferencesDialogBaseResources;
+import org.rstudio.core.client.prefs.RestartRequirement;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.HelpButton;
 import org.rstudio.core.client.widget.ProgressIndicator;
@@ -81,13 +82,13 @@ public boolean validate()
    }
 
    @Override
-   public boolean onApply(RProjectOptions options)
+   public RestartRequirement onApply(RProjectOptions options)
    {
       RProjectConfig config = options.getConfig();
       config.setDefaultSweaveEngine(defaultSweaveEngine_.getValue());
       config.setDefaultLatexProgram(defaultLatexProgram_.getValue());
       config.setRootDocument(rootDoc_.getText().trim());
-      return false;
+      return new RestartRequirement();
    }
    
    private void addHeader(String caption)

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectGeneralPreferencesPane.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.projects.ui.prefs;
 
 import org.rstudio.core.client.prefs.PreferencesDialogBaseResources;
+import org.rstudio.core.client.prefs.RestartRequirement;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.FormLabel;
 import org.rstudio.core.client.widget.LayoutGrid;
@@ -124,7 +125,7 @@ protected void initialize(RProjectOptions options)
    }
 
    @Override
-   public boolean onApply(RProjectOptions options)
+   public RestartRequirement onApply(RProjectOptions options)
    {
       RProjectConfig config = options.getConfig();
       config.setRestoreWorkspace(restoreWorkspace_.getSelectedIndex());
@@ -144,7 +145,7 @@ public boolean onApply(RProjectOptions options)
       }
       
       config.setQuitChildProcessesOnExit(quitChildProcessesOnExit);
-      return false;
+      return new RestartRequirement();
    }
    
    private class YesNoAskDefault extends ListBox

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPackratPreferencesPane.java
Patch:
@@ -20,6 +20,7 @@
 
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.js.JsUtil;
+import org.rstudio.core.client.prefs.RestartRequirement;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.FixedTextArea;
 import org.rstudio.core.client.widget.LabelWithHelp;
@@ -183,7 +184,7 @@ private void manageUI(boolean packified)
    }
 
    @Override
-   public boolean onApply(RProjectOptions options)
+   public RestartRequirement onApply(RProjectOptions options)
    {
       RProjectPackratOptions packratOptions = options.getPackratOptions();
       packratOptions.setUsePackrat(chkUsePackrat_.getValue());
@@ -197,7 +198,7 @@ public boolean onApply(RProjectOptions options)
       packratOptions.setLocalRepos(
             JsUtil.toJsArrayString(widgetLocalRepos_.getItems()));
             
-      return false;
+      return new RestartRequirement();
    }
    
    

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectRenvPreferencesPane.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.projects.ui.prefs;
 
+import org.rstudio.core.client.prefs.RestartRequirement;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.common.HelpLink;
 import org.rstudio.studio.client.common.dependencies.DependencyManager;
@@ -105,13 +106,13 @@ private void manageUI(boolean enabled)
    }
 
    @Override
-   public boolean onApply(RProjectOptions options)
+   public RestartRequirement onApply(RProjectOptions options)
    {
       RProjectRenvOptions renvOptions = options.getRenvOptions();
       
       renvOptions.useRenv = chkUseRenv_.getValue();
       
-      return false;
+      return new RestartRequirement();
    }
    
    

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesPane.java
Patch:
@@ -22,6 +22,7 @@
 
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.prefs.PreferencesDialogPaneBase;
+import org.rstudio.core.client.prefs.RestartRequirement;
 import org.rstudio.core.client.widget.FormLabel;
 import org.rstudio.core.client.widget.NumericValueWidget;
 import org.rstudio.studio.client.workbench.prefs.model.Prefs.PrefValue;
@@ -32,11 +33,11 @@
 public abstract class PreferencesPane extends PreferencesDialogPaneBase<UserPrefs>
 { 
    @Override
-   public boolean onApply(UserPrefs rPrefs)
+   public RestartRequirement onApply(UserPrefs rPrefs)
    {
       for (Command cmd : onApplyCommands_)
          cmd.execute();
-      return false;
+      return new RestartRequirement();
    }
    
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/SpellingPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SpellingPreferencesPane.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -21,6 +21,7 @@
 
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.prefs.PreferencesDialogBaseResources;
+import org.rstudio.core.client.prefs.RestartRequirement;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -124,7 +125,7 @@ protected void initialize(UserPrefs rPrefs)
    }
 
    @Override
-   public boolean onApply(UserPrefs rPrefs)
+   public RestartRequirement onApply(UserPrefs rPrefs)
    {
       uiPrefs_.spellingDictionaryLanguage().setGlobalValue(
                                        languageWidget_.getSelectedLanguage());

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -674,7 +674,8 @@ private void resizeHorizontally(final double start,
                                    final double end,
                                    final Command afterComplete)
    {
-      horizontalResizeAnimation(start, end, afterComplete).run(300);
+      int duration = (userPrefs_.reducedMotion().getValue() ? 0 : 300);
+      horizontalResizeAnimation(start, end, afterComplete).run(duration);
    }
    
    private Animation horizontalResizeAnimation(final double start,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1305,8 +1305,7 @@ public void initialize(final SourceDocument document,
                                           fileType_,
                                           extendedType_,
                                           events_,
-                                          session_,
-                                          server_);
+                                          session_);
 
       roxygenHelper_ = new RoxygenHelper(docDisplay_, view_);
       packageDependencyHelper_ = new TextEditingTargetPackageDependencyHelper(this, docUpdateSentinel_, docDisplay_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/spelling/SpellingDialog.java
Patch:
@@ -30,6 +30,7 @@
 import org.rstudio.core.client.Rectangle.FailureMode;
 import org.rstudio.core.client.widget.ModalDialogBase;
 import org.rstudio.core.client.widget.ThemedButton;
+import org.rstudio.studio.client.RStudioGinjector;
 
 public class SpellingDialog extends ModalDialogBase implements CheckSpelling.Display
 {
@@ -199,7 +200,8 @@ public void setEditorSelectionBounds(Rectangle selectionBounds)
          bounds = bounds.attemptToMoveInto(screen, FailureMode.NO_CHANGE);
 
          // Now avoid the selected word
-         move(bounds.avoidBounds(boundsToAvoid_, screen), true);
+         move(bounds.avoidBounds(boundsToAvoid_, screen),
+               !RStudioGinjector.INSTANCE.getUserPrefs().reducedMotion().getValue());
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -1100,6 +1100,7 @@ private XTermOptions defaultTerminalOptions()
       return XTermOptions.create(
             UserPrefsAccessor.TERMINAL_BELL_STYLE_NONE,
             uiPrefs_.blinkingCursor().getValue(),
+            uiPrefs_.getScreenReaderEnabled(),
             uiPrefs_.terminalRenderer().getValue(),
             BrowseCap.isWindowsDesktop(),
             XTermTheme.terminalThemeFromEditorTheme(),

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermOptions.java
Patch:
@@ -41,6 +41,7 @@ protected XTermOptions() {}
    public final native static XTermOptions create(
          String bellStyle,
          boolean cursorBlink,
+         boolean screenReaderMode,
          String rendererType,
          boolean windowsMode,
          XTermTheme theme,
@@ -49,6 +50,7 @@ public final native static XTermOptions create(
       return {
          "bellStyle": bellStyle,
          "cursorBlink": cursorBlink,
+         "screenReaderMode": screenReaderMode,
          "rendererType": rendererType,
          "windowsMode": windowsMode,
          "theme": theme,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -585,7 +585,8 @@ else if (keyCode == KeyCodes.KEY_ENTER && (
             processCommandEntry();
          }
          else if (
-               (keyCode == KeyCodes.KEY_ESCAPE && modifiers == 0) ||
+               (keyCode == KeyCodes.KEY_ESCAPE &&
+                     (modifiers == 0 || modifiers == KeyboardShortcut.CTRL /*iPadOS 13.1*/)) ||
                (BrowseCap.isMacintoshDesktop() && (
                      modifiers == KeyboardShortcut.CTRL &&
                      keyCode == KeyCodes.KEY_C)))

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -1,4 +1,4 @@
-*
+/*
  * GeneralPreferencesPane.java
  *
  * Copyright (C) 2009-19 by RStudio, Inc.

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1532,7 +1532,7 @@ public void onBreakpointMove(BreakpointMoveEvent event)
       rmarkdownHelper_.verifyPrerequisites(view_, fileType_);  
       
       syncFontSize(releaseOnDismiss_, events_, view_, fontSizeManager_);
-
+     
 
       releaseOnDismiss_.add(prefs_.softWrapRFiles().addValueChangeHandler(
             new ValueChangeHandler<Boolean>()

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarMenuButton.java
Patch:
@@ -14,13 +14,13 @@
  */
 package org.rstudio.core.client.widget;
 
+import com.google.gwt.aria.client.ExpandedValue;
 import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.dom.client.KeyCodes;
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.ui.PopupPanel.PositionCallback;
-import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.command.ImageResourceProvider;
 import org.rstudio.core.client.command.SimpleImageResourceProvider;
 import org.rstudio.core.client.resources.ImageResource2x;
@@ -134,7 +134,7 @@ private void menuClick()
          {
             removeStyleName(styles_.toolbarButtonPushed());
             menu.hide();
-            A11y.setARIAMenuItemExpanded(getElement(), false);
+            Roles.getMenuRole().setAriaExpandedState(getElement(), ExpandedValue.FALSE);
             setFocus(true);
          }
          else
@@ -163,7 +163,7 @@ public void setPosition(int offsetWidth,
             }
             menuShowing_ = true;
             menu_.focus();
-            A11y.setARIAMenuItemExpanded(getElement(), true);
+            Roles.getMenuRole().setAriaExpandedState(getElement(), ExpandedValue.TRUE);
          }
       });
    }

File: src/gwt/src/org/rstudio/core/client/widget/DirectoryChooserTextBox.java
Patch:
@@ -101,7 +101,7 @@ public DirectoryChooserTextBox(String label,
                                   final FileDialogs fileDialogs,
                                   final FileSystemContext fsContext)
    {
-      super(label, emptyLabel, browseLabel, null);
+      super(label, emptyLabel, browseLabel, null, true, null);
 
       if (buttonDisabled)
       {

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectTemplateWidget.java
Patch:
@@ -198,7 +198,8 @@ public void collectInput(JsObject receiver)
    
    private ProjectTemplateWidgetItem fileInput(final ProjectTemplateWidgetDescription description)
    {
-      final FileChooserTextBox widget = new FileChooserTextBox(description.getLabel(), null);
+      final FileChooserTextBox widget = new FileChooserTextBox(description.getLabel(), "",
+                                                               false, null, null);
       
       String defaultValue = description.getDefault();
       if (!StringUtil.isNullOrEmpty(defaultValue))

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectCompilePdfPreferencesPane.java
Patch:
@@ -108,6 +108,7 @@ public RootDocumentChooser()
                "(Current Document)", 
                "Browse...", 
                new HelpButton("pdf_root_document", "Get help on Compile PDF root document"),
+               true,
                null);
          
          // allow user to set the value to empty string

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectEditingPreferencesPane.java
Patch:
@@ -67,7 +67,10 @@ public ProjectEditingPreferencesPane(final SourceServerOperations server)
       
       encoding_ = new TextBoxWithButton(
             "Text encoding:",
+            "",
             "Change...",
+            null,
+            true,
             new ClickHandler()
             {
                public void onClick(ClickEvent event)

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsPanel.java
Patch:
@@ -59,7 +59,7 @@ protected abstract class PathSelector extends TextBoxWithButton
       public PathSelector(String label, 
                           final String emptyLabel)
       {
-         super(label, emptyLabel, "Browse...", null);
+         super(label, emptyLabel, "Browse...", null, true, null);
       }
       
       

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdFileOption.java
Patch:
@@ -31,7 +31,7 @@ public RmdFileOption(RmdTemplateFormatOption option, String initialValue)
       HTMLPanel panel = new HTMLPanel("");
       panel.add(getOptionLabelWidget());
       
-      fileChooser_ = new FileChooserTextBox("", null);
+      fileChooser_ = new FileChooserTextBox("", "", false, null, null);
       if (initialValue != "null")
          fileChooser_.setText(initialValue);
       fileChooser_.getElement().getStyle().setMarginLeft(20, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -263,7 +263,10 @@ public void onClick(ClickEvent event)
       encodingValue_ = prefs_.defaultEncoding().getGlobalValue();
       savePanel.add(lessSpaced(encoding_ = new TextBoxWithButton(
             "Default text encoding:",
+            "",
             "Change...",
+            null,
+            true,
             new ClickHandler()
             {
                public void onClick(ClickEvent event)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -79,7 +79,10 @@ public GeneralPreferencesPane(RemoteFileSystemContext fsContext,
       {
          rVersion_ = new TextBoxWithButton(
                "R version:",
+               "",
                "Change...",
+               null,
+               true,
                new ClickHandler()
                {
                   @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -85,6 +85,7 @@ public PackagesPreferencesPane(PreferencesDialogResources res,
             "",
             "Change...",
             null,
+            true,
             new ClickHandler()
             {
                public void onClick(ClickEvent event)
@@ -112,8 +113,7 @@ public void execute(CRANMirror cranMirror)
                      }     
                   });
                }
-            },
-            true);
+            });
       
       cranMirrorTextBox_.getTextBox().addValueChangeHandler(new ValueChangeHandler<String>()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -226,7 +226,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
             val -> caBundlePath_.setVisible(val.getValue()));
       add(useCaBundle);
 
-      caBundlePath_ = new FileChooserTextBox("", "(none)", null, null);
+      caBundlePath_ = new FileChooserTextBox("", "(none)", false, null, null);
       caBundlePath_.setText(userPrefs_.publishCaBundle().getValue());
       caBundlePath_.setVisible(userPrefs_.usePublishCaBundle().getValue());
       add(caBundlePath_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobLauncherControls.java
Patch:
@@ -37,7 +37,7 @@ interface JobLauncherControlsUiBinder extends UiBinder<Widget, JobLauncherContro
 
    public JobLauncherControls()
    {
-      file_ = new FileChooserTextBox("R Script", null);
+      file_ = new FileChooserTextBox("R Script", "", false, null, null);
       dir_ = new DirectoryChooserTextBox("Working Directory", null);
 
       initWidget(uiBinder.createAndBindUi(this));

File: src/gwt/src/org/rstudio/core/client/widget/DirectoryChooserTextBox.java
Patch:
@@ -101,7 +101,7 @@ public DirectoryChooserTextBox(String label,
                                   final FileDialogs fileDialogs,
                                   final FileSystemContext fsContext)
    {
-      super(label, emptyLabel, browseLabel, null);
+      super(label, emptyLabel, browseLabel, null, true, null);
 
       if (buttonDisabled)
       {

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectTemplateWidget.java
Patch:
@@ -198,7 +198,8 @@ public void collectInput(JsObject receiver)
    
    private ProjectTemplateWidgetItem fileInput(final ProjectTemplateWidgetDescription description)
    {
-      final FileChooserTextBox widget = new FileChooserTextBox(description.getLabel(), null);
+      final FileChooserTextBox widget = new FileChooserTextBox(description.getLabel(), "",
+                                                               false, null, null);
       
       String defaultValue = description.getDefault();
       if (!StringUtil.isNullOrEmpty(defaultValue))

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectCompilePdfPreferencesPane.java
Patch:
@@ -108,6 +108,7 @@ public RootDocumentChooser()
                "(Current Document)", 
                "Browse...", 
                new HelpButton("pdf_root_document", "Get help on Compile PDF root document"),
+               true,
                null);
          
          // allow user to set the value to empty string

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectEditingPreferencesPane.java
Patch:
@@ -67,7 +67,10 @@ public ProjectEditingPreferencesPane(final SourceServerOperations server)
       
       encoding_ = new TextBoxWithButton(
             "Text encoding:",
+            "",
             "Change...",
+            null,
+            true,
             new ClickHandler()
             {
                public void onClick(ClickEvent event)

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsPanel.java
Patch:
@@ -59,7 +59,7 @@ protected abstract class PathSelector extends TextBoxWithButton
       public PathSelector(String label, 
                           final String emptyLabel)
       {
-         super(label, emptyLabel, "Browse...", null);
+         super(label, emptyLabel, "Browse...", null, true, null);
       }
       
       

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdFileOption.java
Patch:
@@ -31,7 +31,7 @@ public RmdFileOption(RmdTemplateFormatOption option, String initialValue)
       HTMLPanel panel = new HTMLPanel("");
       panel.add(getOptionLabelWidget());
       
-      fileChooser_ = new FileChooserTextBox("", null);
+      fileChooser_ = new FileChooserTextBox("", "", false, null, null);
       if (initialValue != "null")
          fileChooser_.setText(initialValue);
       fileChooser_.getElement().getStyle().setMarginLeft(20, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -263,7 +263,10 @@ public void onClick(ClickEvent event)
       encodingValue_ = prefs_.defaultEncoding().getGlobalValue();
       savePanel.add(lessSpaced(encoding_ = new TextBoxWithButton(
             "Default text encoding:",
+            "",
             "Change...",
+            null,
+            true,
             new ClickHandler()
             {
                public void onClick(ClickEvent event)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -79,7 +79,10 @@ public GeneralPreferencesPane(RemoteFileSystemContext fsContext,
       {
          rVersion_ = new TextBoxWithButton(
                "R version:",
+               "",
                "Change...",
+               null,
+               true,
                new ClickHandler()
                {
                   @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -85,6 +85,7 @@ public PackagesPreferencesPane(PreferencesDialogResources res,
             "",
             "Change...",
             null,
+            true,
             new ClickHandler()
             {
                public void onClick(ClickEvent event)
@@ -112,8 +113,7 @@ public void execute(CRANMirror cranMirror)
                      }     
                   });
                }
-            },
-            true);
+            });
       
       cranMirrorTextBox_.getTextBox().addValueChangeHandler(new ValueChangeHandler<String>()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -226,7 +226,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
             val -> caBundlePath_.setVisible(val.getValue()));
       add(useCaBundle);
 
-      caBundlePath_ = new FileChooserTextBox("", "(none)", null, null);
+      caBundlePath_ = new FileChooserTextBox("", "(none)", false, null, null);
       caBundlePath_.setText(userPrefs_.publishCaBundle().getValue());
       caBundlePath_.setVisible(userPrefs_.usePublishCaBundle().getValue());
       add(caBundlePath_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobLauncherControls.java
Patch:
@@ -37,7 +37,7 @@ interface JobLauncherControlsUiBinder extends UiBinder<Widget, JobLauncherContro
 
    public JobLauncherControls()
    {
-      file_ = new FileChooserTextBox("R Script", null);
+      file_ = new FileChooserTextBox("R Script", "", false, null, null);
       dir_ = new DirectoryChooserTextBox("Working Directory", null);
 
       initWidget(uiBinder.createAndBindUi(this));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionShinyHost.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
+import org.rstudio.core.client.widget.LayoutGrid;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.RStudioFrame;
@@ -47,7 +48,6 @@
 import com.google.gwt.resources.client.CssResource;
 import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.ui.Composite;
-import com.google.gwt.user.client.ui.Grid;
 import com.google.gwt.user.client.ui.VerticalPanel;
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
@@ -169,7 +169,7 @@ public void execute()
       };
       updateCodeCommand.execute();
 
-      Grid codeGrid = new Grid(1, 1);
+      LayoutGrid codeGrid = new LayoutGrid(1, 1);
       codeGrid.addStyleName(RES.styles().codeGrid());
       codeGrid.setCellPadding(0);
       codeGrid.setCellSpacing(0);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/ChunkOptionsPopupPanel.java
Patch:
@@ -27,6 +27,7 @@
 import org.rstudio.core.client.dom.DomUtils.NativeEventHandler;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.widget.FormLabel;
+import org.rstudio.core.client.widget.LayoutGrid;
 import org.rstudio.core.client.widget.MiniPopupPanel;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.ProgressOperationWithInput;
@@ -160,7 +161,7 @@ public void onKeyUp(KeyUpEvent event)
       });
       
       int gridRows = includeChunkNameUI ? 2 : 1;
-      Grid nameAndOutputGrid = new Grid(gridRows, 2);
+      LayoutGrid nameAndOutputGrid = new LayoutGrid(gridRows, 2);
 
       chunkLabel_ = new FormLabel("Chunk Name:", tbChunkLabel_);
       chunkLabel_.addStyleName(RES.styles().chunkLabel());

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryPage.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.projects.ui.newproject;
 
+import com.google.gwt.aria.client.Roles;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.resources.ImageResource2x;
@@ -86,6 +87,7 @@ protected void onAddWidgets()
       txtProjectName_ = new TextBox();
       txtProjectName_.setWidth("100%");
       DomUtils.disableSpellcheck(txtProjectName_);
+      Roles.getTextboxRole().setAriaRequiredProperty(txtProjectName_.getElement(), true);
 
       // create the dir name label
       dirNameLabel_ = new FormLabel(getDirNameLabel(), txtProjectName_);

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectTemplateWidget.java
Patch:
@@ -22,13 +22,13 @@
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.core.client.widget.FileChooserTextBox;
+import org.rstudio.core.client.widget.LayoutGrid;
 import org.rstudio.core.client.widget.SelectWidget;
 import com.google.gwt.core.client.JsArray;
 import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.user.client.ui.CheckBox;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.FlowPanel;
-import com.google.gwt.user.client.ui.Grid;
 import com.google.gwt.user.client.ui.HorizontalPanel;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.TextBox;
@@ -61,7 +61,7 @@ public void collectInput(JsObject receiver)
    
    public ProjectTemplateWidget(ProjectTemplateDescription description)
    {
-      widgets_ = new ArrayList<ProjectTemplateWidgetItem>();
+      widgets_ = new ArrayList<>();
       
       // initialize widgets
       JsArray<ProjectTemplateWidgetDescription> descriptions = description.getWidgetDescription();
@@ -180,7 +180,7 @@ private ProjectTemplateWidgetItem textInput(final ProjectTemplateWidgetDescripti
       if (!StringUtil.isNullOrEmpty(defaultValue))
          primaryWidget.setText(defaultValue);
       
-      Grid grid = new Grid(1, 2);
+      LayoutGrid grid = new LayoutGrid(1, 2);
       DomUtils.disableSpellcheck(primaryWidget);
       grid.setWidget(0, 0, new Label(ensureEndsWithColon(description.getLabel())));
       grid.setWidget(0, 1, primaryWidget);

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectGeneralPreferencesPane.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.core.client.prefs.PreferencesDialogBaseResources;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.FormLabel;
+import org.rstudio.core.client.widget.LayoutGrid;
 import org.rstudio.studio.client.packrat.model.PackratContext;
 import org.rstudio.studio.client.projects.model.RProjectConfig;
 import org.rstudio.studio.client.projects.model.RProjectOptions;
@@ -26,7 +27,6 @@
 
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.ui.CheckBox;
-import com.google.gwt.user.client.ui.Grid;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.ListBox;
 import com.google.inject.Inject;
@@ -35,10 +35,10 @@ public class ProjectGeneralPreferencesPane extends ProjectPreferencesPane
 {
    @Inject
    public ProjectGeneralPreferencesPane(Session session)
-   {        
+   {
       sessionInfo_ = session.getSessionInfo();
 
-      Grid grid = new Grid(6, 2);
+      LayoutGrid grid = new LayoutGrid(6, 2);
       grid.addStyleName(RESOURCES.styles().workspaceGrid());
       grid.setCellSpacing(8);
 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -69,7 +69,6 @@
 import com.google.gwt.user.client.Timer;
 import com.google.gwt.user.client.ui.Anchor;
 import com.google.gwt.user.client.ui.Composite;
-import com.google.gwt.user.client.ui.Grid;
 import com.google.gwt.user.client.ui.HTMLPanel;
 import com.google.gwt.user.client.ui.HorizontalPanel;
 import com.google.gwt.user.client.ui.Image;
@@ -1300,7 +1299,6 @@ private void showAppError(String error)
    @UiField Anchor addAccountAnchor_;
    @UiField Anchor createNewAnchor_;
    @UiField Anchor urlAnchor_;
-   @UiField Grid mainGrid_;
    @UiField HTMLPanel appDetailsPanel_;
    @UiField HTMLPanel appInfoPanel_;
    @UiField HTMLPanel appProgressPanel_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -18,7 +18,6 @@
 import java.util.List;
 
 import com.google.gwt.aria.client.Roles;
-import com.google.gwt.user.client.ui.Grid;
 
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.StringUtil;
@@ -197,7 +196,6 @@ public NewRMarkdownDialog(
       templateChooser_ = new RmdTemplateChooser(server_);
 
       mainWidget_ = GWT.<Binder>create(Binder.class).createAndBindUi(this);
-      Roles.getPresentationRole().set(formGrid_.getElement());
       formatOptions_ = new ArrayList<>();
       style.ensureInjected();
       txtAuthor_.setText(author);
@@ -458,7 +456,6 @@ private Widget createFormatOption(String name, String description)
       return formatWrapper;
    }
    
-   @UiField Grid formGrid_;
    @UiField TextBox txtAuthor_;
    @UiField TextBox txtTitle_;
    @UiField WidgetListBox<TemplateMenuItem> listTemplates_;

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -215,6 +215,7 @@ void externalSynctexView(String pdfFile,
    void setLauncherServer(SessionServer server, CommandWithArg<Boolean> callback);
    void connectToLauncherServer();
 
+   void getLauncherServer(CommandWithArg<SessionServer> callback);
    void startLauncherJobStatusStream(String jobId);
    void stopLauncherJobStatusStream(String jobId);
    void startLauncherJobOutputStream(String jobId);

File: src/gwt/src/org/rstudio/studio/client/application/events/LauncherServerEvent.java
Patch:
@@ -31,7 +31,8 @@ public enum EventType
       JobSubmitSuccess,
       JobSubmitFailure,
       GetContainerUserSuccess,
-      GetContainerUserFailure
+      GetContainerUserFailure,
+      LauncherServerSettingsChanged
    }
 
    public LauncherServerEvent(EventType eventType, String details)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -268,6 +268,9 @@ public void activateTerminal(Command displaySelected)
       selectedCallback_ = displaySelected;
       setShowTerminalPref(true);
       closingAll_ = false;
+
+      // Ensure that console pane is not minimized
+      commands_.activateConsolePane().execute();
       bringToFront();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -268,6 +268,9 @@ public void activateTerminal(Command displaySelected)
       selectedCallback_ = displaySelected;
       setShowTerminalPref(true);
       closingAll_ = false;
+
+      // Ensure that console pane is not minimized
+      commands_.activateConsolePane().execute();
       bringToFront();
    }
 

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -804,6 +804,9 @@ private void initializeWorkbench()
          removeJobLauncherCommands();
       }
 
+      // only enable suspendSession() in devmode
+      commands_.suspendSession().setVisible(SuperDevMode.isActive());
+
       if (!sessionInfo.getAllowPackageInstallation())
       {
          commands_.installPackage().remove();

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -106,9 +106,6 @@ public ApplicationQuit(ApplicationServerOperations server,
       // bind to commands
       binder.bind(commands, this);
       
-      // only enable suspendSession() in devmode
-      commands.suspendSession().setVisible(SuperDevMode.isActive());
-      
       // subscribe to events
       eventBus.addHandler(SaveActionChangedEvent.TYPE, this);   
       eventBus.addHandler(HandleUnsavedChangesEvent.TYPE, this);

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -804,6 +804,9 @@ private void initializeWorkbench()
          removeJobLauncherCommands();
       }
 
+      // only enable suspendSession() in devmode
+      commands_.suspendSession().setVisible(SuperDevMode.isActive());
+
       if (!sessionInfo.getAllowPackageInstallation())
       {
          commands_.installPackage().remove();

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -106,9 +106,6 @@ public ApplicationQuit(ApplicationServerOperations server,
       // bind to commands
       binder.bind(commands, this);
       
-      // only enable suspendSession() in devmode
-      commands.suspendSession().setVisible(SuperDevMode.isActive());
-      
       // subscribe to events
       eventBus.addHandler(SaveActionChangedEvent.TYPE, this);   
       eventBus.addHandler(HandleUnsavedChangesEvent.TYPE, this);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -76,7 +76,6 @@ public TerminalInfoDialog(String globalInfo, final TerminalSession session)
          diagnostics.append("Working Dir: '").append(cwd).append("'\n");
          diagnostics.append("Interactive: '").append(cpi.getInteractionModeName()).append("'\n");
          diagnostics.append("WebSockets:  '").append(userPrefs_.terminalWebsockets().getValue()).append("'\n");
-         diagnostics.append("Typing lag:  '").append(session.getSocket().getTypingLagMsg()).append("'\n");
 
          diagnostics.append("\nCurrent Terminal Emulator Settings\n------------------------------------\n");
          for (String optionName : XTermOptions.stringOptions)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermThemeResources.java
Patch:
@@ -21,7 +21,7 @@
 
 public interface XTermThemeResources extends ClientBundle
 {
-   public static final XTermThemeResources INSTANCE = GWT.create(XTermThemeResources.class);
+   XTermThemeResources INSTANCE = GWT.create(XTermThemeResources.class);
 
    @Source("xterm.css")
    StaticDataResource xtermcss();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -254,6 +254,9 @@ public void onBeforeSelected()
    @Override
    public void activateTerminal(Command displaySelected)
    {
+      if (selectedCallback_ != null)
+         return;
+
       selectedCallback_ = displaySelected;
       setShowTerminalPref(true);
       closingAll_ = false;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -46,6 +46,7 @@
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.views.console.model.ProcessBufferChunk;
+import org.rstudio.studio.client.workbench.views.terminal.events.TerminalReceivedConsoleProcessInfoEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStartedEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStoppedEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalTitleEvent;
@@ -162,6 +163,7 @@ public void onResponseReceived(ConsoleProcess consoleProcess)
             // Keep an instance of the ProcessInfo so it is available even if the terminal
             // goes offline, which causes consoleProcess_ to become null.
             procInfo_ = consoleProcess_.getProcessInfo();
+            eventBus_.fireEvent(new TerminalReceivedConsoleProcessInfoEvent(procInfo_));
 
             addHandlerRegistration(addXTermTitleHandler(TerminalSession.this));
             addHandlerRegistration(eventBus_.addHandler(SessionSerializationEvent.TYPE, TerminalSession.this));

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -582,7 +582,7 @@ public PrefValue<Boolean> warnVariableDefinedButNotUsed()
    }
 
    /**
-    * Whether to automatically discover and offer to install missing R package dependenices.
+    * Whether to automatically discover and offer to install missing R package dependencies.
     */
    public PrefValue<Boolean> autoDiscoverPackageDependencies()
    {

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -393,6 +393,7 @@ private final native String getMimeTypeInternal() /*-{
       MIME_TYPES.put( "q",     "text/x-r-source");
       MIME_TYPES.put( "rd",    "text/x-r-doc");
       MIME_TYPES.put( "rnw",   "text/x-r-sweave");
+      MIME_TYPES.put( "rtex",  "text/x-r-sweave");
       MIME_TYPES.put( "rmd",   "text/x-r-markdown");
       MIME_TYPES.put( "rhtml", "text/x-r-html");
       MIME_TYPES.put( "rpres", "text/x-r-presentation");

File: src/gwt/src/org/rstudio/core/client/ColorUtil.java
Patch:
@@ -120,7 +120,7 @@ else if (cssString.startsWith("rgb"))
          
          if (pattern == null)
          {
-            Debug.logToConsole("Non-conformat RGB color string: '" + cssString + "'");
+            Debug.logToConsole("Non-conformant RGB color string: '" + cssString + "'");
             return new RGBColor();
          }
          

File: src/gwt/src/org/rstudio/core/client/MessageDisplay.java
Patch:
@@ -356,7 +356,7 @@ public void execute()
    public void showNotYetImplemented()
    {
       showMessage(MSG_INFO, 
-                 "Not Yet Implemetned", 
+                 "Not Yet Implemented",
                  "This feature has not yet been implemented.");
    }
 }

File: src/gwt/src/org/rstudio/core/client/command/CommandBinder.java
Patch:
@@ -17,7 +17,7 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 
 /**
- * Provides a mechanism for declaritively hooking up command handler methods
+ * Provides a mechanism for declaratively hooking up command handler methods
  * to the relevant commands.
  *
  * 1) Create a method for each command to be handled. It should have a return

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -129,7 +129,7 @@ private native final void addPostViewHandler() /*-{
    private native final void addNativeEditHandlers() /*-{
       var self = this;
       var callback = $entry(function(event) {
-      	self.@org.rstudio.core.client.command.ShortcutManager::onNativeEditEvent(Ljava/lang/Object;)(event);
+         self.@org.rstudio.core.client.command.ShortcutManager::onNativeEditEvent(Ljava/lang/Object;)(event);
       });
       
       $doc.body.addEventListener("copy",  callback);

File: src/gwt/src/org/rstudio/core/client/dom/DomUtils.java
Patch:
@@ -891,7 +891,7 @@ public static final Element getFirstElementWithClassName(Element parent, String
    {
       Element[] elements = getElementsByClassName(parent, classes);
       if (elements.length == 0)
-   	   return null;
+         return null;
       return elements[0];
    }
    
@@ -972,7 +972,7 @@ public static Element findParentElement(Element el,
    
    public static Element findParentElement(Element el,
                                            boolean includeSelf,
-   	                                     ElementPredicate predicate)
+                                           ElementPredicate predicate)
    {
       Element parent = includeSelf ? el : el.getParentElement();
       while (parent != null)

File: src/gwt/src/org/rstudio/core/client/layout/DualWindowLayoutPanel.java
Patch:
@@ -591,7 +591,7 @@ public void onEnsureHeight(EnsureHeightEvent event)
                            chromeHeight - 
                            targetHeight;
          
-         // see if we need to offset to acheive minimum other height
+         // see if we need to offset to achieve minimum other height
          int offset = 0;
          if (otherHeight < MINIMUM)
             offset = MINIMUM - otherHeight;

File: src/gwt/src/org/rstudio/core/client/widget/FastSelectTable.java
Patch:
@@ -449,7 +449,7 @@ public void setSelected(TableRowElement row, boolean selected)
       }
       catch (JavaScriptException ex)
       {
-    	  	 return;
+         return;
       }
 
       boolean isCurrentlySelected = isSelected(row);

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -61,7 +61,7 @@ protected ModalDialogBase(DialogRole role)
    protected ModalDialogBase(SimplePanel containerPanel, DialogRole role)
    {
       // core initialization. passing false for modal works around
-      // modal PopupPanel supressing global keyboard accelerators (like
+      // modal PopupPanel suppressing global keyboard accelerators (like
       // Ctrl-N or Ctrl-T). modality is achieved via setGlassEnabled(true)
       super(false, false);
       setGlassEnabled(true);

File: src/gwt/src/org/rstudio/core/client/widget/ShowContentDialog.java
Patch:
@@ -69,7 +69,7 @@ public void onClick(ClickEvent event) {
    @Override
    protected Widget createMainWidget()
    {
-     // main widget is scroll panel with embeddeed html 
+     // main widget is scroll panel with embedded html
      ScrollPanel scrollPanel = new ScrollPanel();  
      scrollPanel.setStylePrimaryName(styleName_);
      HTML htmlContent = new HTML(content_);

File: src/gwt/src/org/rstudio/studio/client/application/model/SuspendOptions.java
Patch:
@@ -43,7 +43,7 @@ private static native final SuspendOptions create(boolean saveMinimal,
    }-*/;
    
    /*
-    * Indidates that only a minimal amount of session state should be 
+    * Indicates that only a minimal amount of session state should be
     * saved (e.g. working directory and up-arrow history). 
     * 
     * If this option is true then the save_workspace option will be 

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -90,7 +90,7 @@ private int getPositionAtOffset(int offset)
    private int historyPos_ ;
    // If you start typing a command, then go up in history, then go down,
    // then what you had previously typed should still be there. This is
-   // that value--it is loaded/saved whenever history nagivation takes you
+   // that value--it is loaded/saved whenever history navigation takes you
    // into/out of that final history position (history_.size()).
    private String historyTail_;
    private final HasText input_;

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/MirrorsServerOperations.java
Patch:
@@ -28,5 +28,5 @@ void validateCranRepo(
          String cranRepoUrl);
 
    void getCRANActives(
-   		 ServerRequestCallback<JsArray<CRANMirror>> requestCallback);
+         ServerRequestCallback<JsArray<CRANMirror>> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/AskSecretManager.java
Patch:
@@ -69,7 +69,7 @@ private boolean handleAskSecret(String targetWindow)
                 !satelliteManager.satelliteWindowExists(targetWindow))
                return true;
             
-            // othewise don't handle
+            // otherwise don't handle
             else
                return false;
          }

File: src/gwt/src/org/rstudio/studio/client/common/vcs/AskPassManager.java
Patch:
@@ -65,7 +65,7 @@ private boolean handleAskPass(String targetWindow)
                 !satelliteManager.satelliteWindowExists(targetWindow))
                return true;
             
-            // othewise don't handle
+            // otherwise don't handle
             else
                return false;
          }

File: src/gwt/src/org/rstudio/studio/client/common/zoom/ZoomUtils.java
Patch:
@@ -41,7 +41,7 @@ public static Size getZoomWindowSize(Size sourceFrameSize, Size defaultSize)
       {
          final int PADDING = 20;
    
-         // calculate ideal heigh and width. try to be as large as possible
+         // calculate ideal height and width. try to be as large as possible
          // within the bounds of the current client size
          Size bounds = new Size(Window.getClientWidth() - PADDING,
                                 Window.getClientHeight() - PADDING);

File: src/gwt/src/org/rstudio/studio/client/events/EditEvent.java
Patch:
@@ -42,7 +42,7 @@ public int getType()
    public static final int TYPE_CUT   = 1;
    public static final int TYPE_COPY  = 2;
    public static final int TYPE_PASTE = 4;
-	
+
    // Boilerplate ----
    public interface Handler extends EventHandler
    {

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -160,7 +160,7 @@ private void findInTopic(String term, CanFocus findInputSource)
                RStudioGinjector.INSTANCE.getGlobalDisplay().showMessage(
                      MessageDialog.INFO,
                      "Find in Page", 
-                     "No occurences found",
+                     "No occurrences found",
                      findInputSource);
             }     
          }

File: src/gwt/src/org/rstudio/studio/client/projects/ProjectMRUList.java
Patch:
@@ -115,9 +115,9 @@ protected String transformMruEntryPath(String entryPath)
    
    @Override
    protected ArrayList<String> generateLabels(
-		   ArrayList<String> mruEntries, boolean includeExt)
+         ArrayList<String> mruEntries, boolean includeExt)
    {
-	   return DuplicateHelper.getPathLabels(mruEntries, true);
+      return DuplicateHelper.getPathLabels(mruEntries, true);
    }
    
    private static boolean openInNewWindow_ = false;

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -802,7 +802,7 @@ public void onOpenProjectNewWindow(OpenProjectNewWindowEvent event)
    {
       // call the desktop to open the project (since it is
       // a conventional foreground gui application it has
-      // less chance of running afowl of desktop app creation
+      // less chance of running afoul of desktop app creation
       // & activation restrictions)
       FileSystemItem project = FileSystemItem.createFile(event.getProject());
       if (Desktop.isDesktop())

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -204,7 +204,7 @@ private void findInTopic(String term, CanFocus findInputSource)
                RStudioGinjector.INSTANCE.getGlobalDisplay().showMessage(
                      MessageDialog.INFO,
                      "Find in Page", 
-                     "No occurences found",
+                     "No occurrences found",
                      findInputSource);
             }     
          }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -1037,7 +1037,7 @@ else if (type == ClientEvent.ExecuteAppCommand)
       }
       catch(Throwable e)
       {
-         GWT.log("WARNING: Exception occured dispatching event: " + type, e);
+         GWT.log("WARNING: Exception occurred dispatching event: " + type, e);
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -552,7 +552,7 @@ public void getTerminalOptions(
    public void getTerminalShells(
          ServerRequestCallback<JsArray<TerminalShellInfo>> requestCallback)
    {
-	   sendRequest(RPC_SCOPE, GET_TERMINAL_SHELLS, requestCallback);
+      sendRequest(RPC_SCOPE, GET_TERMINAL_SHELLS, requestCallback);
    }
 
    @Override
@@ -3624,7 +3624,7 @@ private native void performCallback(JavaScriptObject responseCallback,
       final ResponseHandler responseHandler = new ResponseHandler();
       
       // setup a retry handler which will call back the second time with
-      // the same args (but no retryHandler, ensurin at most 1 retry)
+      // the same args (but no retryHandler, ensuring at most 1 retry)
       RetryHandler retryHandler = new RetryHandler() {
         
          public void onRetry()

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerAuth.java
Patch:
@@ -107,7 +107,7 @@ public void attemptToUpdateCredentials()
          public void onResponseReceived(Integer response)
          {
             // this method does nothing in the case of both successfully
-            // updating credentails and method not found. however, if
+            // updating credentials and method not found. however, if
             // the credentials update fails then it needs to blow
             // away the client
             

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerError.java
Patch:
@@ -66,7 +66,7 @@ public String getMessage()
    
    public String getRedirectUrl()
    {
-	  return redirectUrl_;
+      return redirectUrl_;
    }
    
    public ServerErrorCause getCause()
@@ -121,7 +121,7 @@ private int codeFromRpcErrorCode(int code)
          
       case RpcError.MAX_SESSIONS_REACHED:
       case RpcError.MAX_USERS_REACHED:
-    	  return ServerError.LICENSE_USAGE_LIMIT;
+         return ServerError.LICENSE_USAGE_LIMIT;
                
       default:
          return ServerError.SUCCESS;

File: src/gwt/src/org/rstudio/studio/client/workbench/MRUList.java
Patch:
@@ -95,9 +95,9 @@ public void clear()
    }
    
    protected ArrayList<String> generateLabels(
-		   ArrayList<String> entries, boolean includeExt)
+         ArrayList<String> entries, boolean includeExt)
    {
-	   return DuplicateHelper.getPathLabels(entries, includeExt);
+      return DuplicateHelper.getPathLabels(entries, includeExt);
    }
    
    public String getQualifiedLabel(String mruEntry)

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearch.java
Patch:
@@ -146,7 +146,7 @@ public void onFocus(FocusEvent event)
         @Override
         public void onFileChange(FileChangeEvent event)
         {           
-           // if this was an R file then invalide the cache
+           // if this was an R file then invalidate the cache
            CodeSearchOracle oracle = display_.getSearchOracle();
            if (oracle.hasCachedResults())
            {

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotSizeEditor.java
Patch:
@@ -294,7 +294,7 @@ public void onResizingCompleted()
       initialWidth = constrainWidth(initialWidth);
       initialHeight = constrainHeight(initialHeight);
             
-      // initialie text boxes
+      // initialize text boxes
       setWidthTextBox(initialWidth);
       setHeightTextBox(initialHeight);
  

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -582,7 +582,7 @@ public PrefValue<Boolean> warnVariableDefinedButNotUsed()
    }
 
    /**
-    * Whether to automatically discover and offer to install missing R package dependenices.
+    * Whether to automatically discover and offer to install missing R package dependencies.
     */
    public PrefValue<Boolean> autoDiscoverPackageDependencies()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -588,7 +588,7 @@ private final native void registerFontListReadyCallback()
    
       var self = this;
       $wnd.onFontListReady = $entry(function() {
-      	self.@org.rstudio.studio.client.workbench.prefs.views.AppearancePreferencesPane::onFontListReady()();
+         self.@org.rstudio.studio.client.workbench.prefs.views.AppearancePreferencesPane::onFontListReady()();
       });
    
    }-*/;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneConfig.java
Patch:
@@ -184,7 +184,7 @@ public final boolean validateAndAutoCorrect()
       replaceObsoleteTabs(ts2);
 
       // Presentation tab must always be at the end of the ts1 tabset (this 
-      // is so that activating it works even in the presense of optionally
+      // is so that activating it works even in the presence of optionally
       // visible tabs). This is normally an invariant but for a time during 
       // the v0.99-1000 preview we allowed the Connections tab to be the 
       // last one in the tabset.

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsPresenter.java
Patch:
@@ -272,7 +272,7 @@ private void showError(String errorMessage)
    
    public void onNewConnection()
    {
-      // if r session bussy, fail
+      // if r session busy, fail
       if (commands_.interruptR().isEnabled()) {
          showError(
             "The R session is currently busy. Wait for completion or " +

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -425,7 +425,7 @@ public void execute()
          }
       };
       
-      // do standrd finish if we aren't animating
+      // do standard finish if we aren't animating
       if (!event.shouldAnimate())
       {
          display.clear();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ShellInputAnimator.java
Patch:
@@ -67,7 +67,7 @@ private void executePendingAnimatedInput()
    {      
       if (pendingAnimatedInput_.size() > 0)
       {
-         // get the input animaator
+         // get the input animator
          InputAnimator inputAnimator = pendingAnimatedInput_.get(0);
          
          // calculate the period (make sure the command takes no longer

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -293,7 +293,7 @@ public void goToDefinition()
          if (cursor.moveToPosition(editor.getCursorPosition(), true))
          {
             // if the cursor is 'on' a left bracket, move back to the associated
-            // token (obstensibly a funciton name)
+            // token (ostensibly a function name)
             if (cursor.isLeftBracket())
                cursor.moveToPreviousToken();
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -209,7 +209,7 @@ protected Widget createMainWidget()
       return objects_;
    }
 
-   // EnviromentPresenter.Display implementation ------------------------------
+   // EnvironmentPresenter.Display implementation ------------------------------
 
    @Override
    public void addObject(RObject object)
@@ -401,7 +401,7 @@ public void setViewDirty()
       isClientStateDirty_ = true;
    }
 
-   // EnviromentObjects.Observer implementation -------------------------------
+   // EnvironmentObjects.Observer implementation -------------------------------
 
    public void setPersistedScrollPosition(int scrollPosition)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/Help.java
Patch:
@@ -124,7 +124,7 @@ public void onListChanged(ListChangedEvent event)
             final LinkMenu history = view_.getHistory() ;
             history.clearLinks();
             
-            // intialize from the list
+            // initialize from the list
             ArrayList<String> list = event.getList();
             for (int i=0; i<list.size(); i++)
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -733,9 +733,9 @@ private void findInTopic(String term, CanFocus findInputSource)
    }
    
    private final native void replaceFrameUrl(JavaScriptObject frame, String url) /*-{
-   	 frame.contentWindow.setTimeout(function() {
-   	  	this.location.replace(url);
-   	 }, 0);
+      frame.contentWindow.setTimeout(function() {
+         this.location.replace(url);
+      }, 0);
    }-*/;
 
    public interface Styles extends CssResource

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/model/HistoryServerOperations.java
Patch:
@@ -74,7 +74,7 @@ void getHistoryArchiveItems(
    /*
     *  searchHistoryDatabase - search the history archive for the query 
     *  (return up to maxEntries). the search is conducted beginning with the
-    *  most recent history items and returned in index decsending order i.e. newest
+    *  most recent history items and returned in index descending order i.e. newest
     *  ones first)
     */
    void searchHistoryArchive(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -167,7 +167,7 @@ public void setPackageStatus(PackageStatus status)
    
    private int packageRow(String packageName, String packageLib)
    {
-      // if we haven't retreived packages yet then return not found
+      // if we haven't retrieved packages yet then return not found
       if (packagesDataProvider_ == null)
          return -1;
       
@@ -537,7 +537,7 @@ else if (source == "source")
       packagesTableContainer_.add(packagesTable_);
       layoutPackagesTable();
       
-      // unbind old table from data provider incase we've re-generated the pane
+      // unbind old table from data provider in case we've re-generated the pane
       for (HasData<PackageInfo> display : packagesDataProvider_.getDataDisplays())
          packagesDataProvider_.removeDataDisplay(display);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/manipulator/ManipulatorControlSlider.java
Patch:
@@ -63,7 +63,7 @@ public ManipulatorControlSlider(String variable,
       double step = slider.getStep();
       if (step == -1)
       {        
-         // short range or decimals means continous decimal
+         // short range or decimals means continuous decimal
          if (range < 2 || hasDecimals(max) || hasDecimals(min) )
             step = range / 250; // ~ one step per pixel
          else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -535,7 +535,7 @@ public void execute(EditingTarget editor)
       });
       
       events.addHandler(CollabEditEndedEvent.TYPE, 
-    		  new CollabEditEndedEvent.Handler() 
+            new CollabEditEndedEvent.Handler()
       {
          @Override
          public void onCollabEditEnded(final CollabEditEndedEvent collab) 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindow.java
Patch:
@@ -120,7 +120,7 @@ public void onError(ServerError error)
       
       // in desktop mode, the frame checks to see if we want to be closed, but
       // in web mode the best we can do is prompt if the user attempts to close
-      // a source window with unsaved chaanges.
+      // a source window with unsaved changes.
       if (!Desktop.hasDesktopFrame())
       {
          Window.addWindowClosingHandler(new ClosingHandler() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -972,7 +972,7 @@ private void syncWrapLimit()
          return;
 
       // We originally observed that large word-wrapped documents
-      // would cause Chrome on Liunx to freeze (bug #3207), eventually
+      // would cause Chrome on Linux to freeze (bug #3207), eventually
       // running of of memory. Running the profiler indicated that the
       // time was being spent inside wrap width calculations in Ace.
       // Looking at the Ace bug database there were other wrapping problems
@@ -991,7 +991,7 @@ private void syncWrapLimit()
       // column, essentially allowing users to opt-in to the behavior
       // we used to fix the bug. So the net is:
       //
-      // (1) To fix the horizontal scrollbar problem we revereted
+      // (1) To fix the horizontal scrollbar problem we reverted
       //     the wrap mode behavior we added from Chrome (under the
       //     assumption that the issue has been fixed in Chrome)
       //
@@ -1006,7 +1006,7 @@ private void syncWrapLimit()
       // exceed the horizontal threshold)
 
       // NOTE: we no longer do this at all since we observed the
-      // scollbar problem on desktop as well
+      // scrollbar problem on desktop as well
    }
 
    private void updateKeyboardHandlers()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -334,7 +334,7 @@ public void onCompleted()
 
       public void onError(final String message)
       {
-         // in case the error occured saving a document that wasn't 
+         // in case the error occurred saving a document that wasn't
          // in the foreground
          view_.ensureVisible();
          
@@ -6992,7 +6992,7 @@ public TextEditingTargetNotebook getNotebook()
    
    /**
     * Updates the path of the file loaded in the editor, as though the user
-    * had just saved the file at the new paht.
+    * had just saved the file at the new path.
     * 
     * @param path New path for the editor
     */

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCompilePdfHelper.java
Patch:
@@ -70,7 +70,7 @@ public void initialize(UserPrefs prefs,
    // the chunk options are ready the callback command is execute (note
    // that if there are no chunk options available then execute will 
    // never be called). this method caches the results from the server
-   // so that chunk options are only retreived once per session -- we 
+   // so that chunk options are only retrieved once per session -- we
    // do this not only to save the round-trip but also because knitr takes
    // over 500ms to load and it may need to be loaded to serve the
    // request for chunk options
@@ -139,7 +139,7 @@ public void checkCompilers(final WarningBarDisplay display,
                               TextFileType fileType)
    {
       // for all tex files we need to parse magic comments and validate
-      // any explict latex proram directive
+      // any explicit latex program directive
       ArrayList<TexMagicComment> magicComments = null;
       if (fileType.canCompilePDF())
       {
@@ -340,7 +340,7 @@ public int getRnwOptionsStart(String line, int cursorPos)
    }
 
    // get the currently active rnw weave name -- arranges to always return
-   // a valid string by returing the pref if the directive is invalid
+   // a valid string by returning the pref if the directive is invalid
    public String getActiveRnwWeaveName()
    {
       if (docDisplay_.getFileType().canKnitToHTML() || 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -865,7 +865,7 @@ public void execute()
                      public void execute()
                      {  
                         // subscribe to notification of params ready
-                        // (ensure only one handler at a time is sucscribed)
+                        // (ensure only one handler at a time is subscribed)
                         rmdParamsReadyUnsubscribe();
                         rmdParamsReadyRegistration_ = eventBus_.addHandler(
                               RmdParamsReadyEvent.TYPE, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetThemeHelper.java
Patch:
@@ -40,7 +40,7 @@ public TextEditingTargetThemeHelper(final TextEditingTarget editingTarget,
          // do the sync
          syncToEditorTheme(editingTarget);
 
-         // register for notification on subsquent changes
+         // register for notification on subsequent changes
          releaseOnDismiss.add(
                eventBus.addHandler(
                      EditorThemeChangedEvent.TYPE,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceCommandManager.java
Patch:
@@ -152,7 +152,7 @@ private final native void rebindCommand(String id, JsArrayString keys)
       var command = this.byName[id];
       
       // The command can be null if it's an excluded command, or
-      // the user has manually editted their keybinding file and
+      // the user has manually edited their keybinding file and
       // selected the ID of a non-existent command.
       if (command == null)
          return;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionUtils.java
Patch:
@@ -82,7 +82,7 @@ public static CompletionPosition getCompletionPosition(DocDisplay docDisplay,
       // determine the column right before this one
       int inputCol = position.getColumn() - 1;
                
-      // walk backwards across C++ identifer symbols 
+      // walk backwards across C++ identifier symbols
       int col = inputCol;
       if (isInclude)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalBusyEvent.java
Patch:
@@ -18,7 +18,7 @@
 import com.google.gwt.event.shared.GwtEvent;
 
 /**
- * Sent when overall state of terminal busy-ness changes. That is, if any
+ * Sent when overall state of terminal busyness changes. That is, if any
  * terminal is busy, this event signals busy.
  */
 public class TerminalBusyEvent extends GwtEvent<TerminalBusyEvent.Handler>

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPresenter.java
Patch:
@@ -379,7 +379,7 @@ public void onResponseReceived(String url)
                globalDisplay_.showErrorMessage(
                      "Error", 
                      "Unable to view " + path + " on GitHub.\n\n" +
-                     "Are you sure that this file is on GithHub and is " + 
+                     "Are you sure that this file is on GitHub and is " +
                      "contained in the currently active project?");
             }
             else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/dialog/GitReviewPanel.java
Patch:
@@ -426,7 +426,7 @@ private int getLineScroll(ScrollPanel panel)
    private int getPageScroll(ScrollPanel panel)
    {
       // Return slightly less than the client height (so there's overlap between
-      // one screen and the next) but never less than the line scoll height.
+      // one screen and the next) but never less than the line scroll height.
       return Math.max(
             getLineScroll(panel),
             panel.getElement().getClientHeight() - getLineScroll(panel));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/dialog/SVNReviewPanel.java
Patch:
@@ -334,7 +334,7 @@ private int getLineScroll(ScrollPanel panel)
    private int getPageScroll(ScrollPanel panel)
    {
       // Return slightly less than the client height (so there's overlap between
-      // one screen and the next) but never less than the line scoll height.
+      // one screen and the next) but never less than the line scroll height.
       return Math.max(
             getLineScroll(panel),
             panel.getElement().getClientHeight() - getLineScroll(panel));

File: src/gwt/src/org/rstudio/core/client/ColorUtil.java
Patch:
@@ -120,7 +120,7 @@ else if (cssString.startsWith("rgb"))
          
          if (pattern == null)
          {
-            Debug.logToConsole("Non-conformat RGB color string: '" + cssString + "'");
+            Debug.logToConsole("Non-conformant RGB color string: '" + cssString + "'");
             return new RGBColor();
          }
          

File: src/gwt/src/org/rstudio/core/client/MessageDisplay.java
Patch:
@@ -356,7 +356,7 @@ public void execute()
    public void showNotYetImplemented()
    {
       showMessage(MSG_INFO, 
-                 "Not Yet Implemetned", 
+                 "Not Yet Implemented",
                  "This feature has not yet been implemented.");
    }
 }

File: src/gwt/src/org/rstudio/core/client/command/CommandBinder.java
Patch:
@@ -17,7 +17,7 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 
 /**
- * Provides a mechanism for declaritively hooking up command handler methods
+ * Provides a mechanism for declaratively hooking up command handler methods
  * to the relevant commands.
  *
  * 1) Create a method for each command to be handled. It should have a return

File: src/gwt/src/org/rstudio/core/client/layout/DualWindowLayoutPanel.java
Patch:
@@ -591,7 +591,7 @@ public void onEnsureHeight(EnsureHeightEvent event)
                            chromeHeight - 
                            targetHeight;
          
-         // see if we need to offset to acheive minimum other height
+         // see if we need to offset to achieve minimum other height
          int offset = 0;
          if (otherHeight < MINIMUM)
             offset = MINIMUM - otherHeight;

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -61,7 +61,7 @@ protected ModalDialogBase(DialogRole role)
    protected ModalDialogBase(SimplePanel containerPanel, DialogRole role)
    {
       // core initialization. passing false for modal works around
-      // modal PopupPanel supressing global keyboard accelerators (like
+      // modal PopupPanel suppressing global keyboard accelerators (like
       // Ctrl-N or Ctrl-T). modality is achieved via setGlassEnabled(true)
       super(false, false);
       setGlassEnabled(true);

File: src/gwt/src/org/rstudio/core/client/widget/ShowContentDialog.java
Patch:
@@ -69,7 +69,7 @@ public void onClick(ClickEvent event) {
    @Override
    protected Widget createMainWidget()
    {
-     // main widget is scroll panel with embeddeed html 
+     // main widget is scroll panel with embedded html
      ScrollPanel scrollPanel = new ScrollPanel();  
      scrollPanel.setStylePrimaryName(styleName_);
      HTML htmlContent = new HTML(content_);

File: src/gwt/src/org/rstudio/studio/client/application/model/SuspendOptions.java
Patch:
@@ -43,7 +43,7 @@ private static native final SuspendOptions create(boolean saveMinimal,
    }-*/;
    
    /*
-    * Indidates that only a minimal amount of session state should be 
+    * Indicates that only a minimal amount of session state should be
     * saved (e.g. working directory and up-arrow history). 
     * 
     * If this option is true then the save_workspace option will be 

File: src/gwt/src/org/rstudio/studio/client/common/CommandLineHistory.java
Patch:
@@ -90,7 +90,7 @@ private int getPositionAtOffset(int offset)
    private int historyPos_ ;
    // If you start typing a command, then go up in history, then go down,
    // then what you had previously typed should still be there. This is
-   // that value--it is loaded/saved whenever history nagivation takes you
+   // that value--it is loaded/saved whenever history navigation takes you
    // into/out of that final history position (history_.size()).
    private String historyTail_;
    private final HasText input_;

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/AskSecretManager.java
Patch:
@@ -69,7 +69,7 @@ private boolean handleAskSecret(String targetWindow)
                 !satelliteManager.satelliteWindowExists(targetWindow))
                return true;
             
-            // othewise don't handle
+            // otherwise don't handle
             else
                return false;
          }

File: src/gwt/src/org/rstudio/studio/client/common/vcs/AskPassManager.java
Patch:
@@ -65,7 +65,7 @@ private boolean handleAskPass(String targetWindow)
                 !satelliteManager.satelliteWindowExists(targetWindow))
                return true;
             
-            // othewise don't handle
+            // otherwise don't handle
             else
                return false;
          }

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -160,7 +160,7 @@ private void findInTopic(String term, CanFocus findInputSource)
                RStudioGinjector.INSTANCE.getGlobalDisplay().showMessage(
                      MessageDialog.INFO,
                      "Find in Page", 
-                     "No occurences found",
+                     "No occurrences found",
                      findInputSource);
             }     
          }

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -802,7 +802,7 @@ public void onOpenProjectNewWindow(OpenProjectNewWindowEvent event)
    {
       // call the desktop to open the project (since it is
       // a conventional foreground gui application it has
-      // less chance of running afowl of desktop app creation
+      // less chance of running afoul of desktop app creation
       // & activation restrictions)
       FileSystemItem project = FileSystemItem.createFile(event.getProject());
       if (Desktop.isDesktop())

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -204,7 +204,7 @@ private void findInTopic(String term, CanFocus findInputSource)
                RStudioGinjector.INSTANCE.getGlobalDisplay().showMessage(
                      MessageDialog.INFO,
                      "Find in Page", 
-                     "No occurences found",
+                     "No occurrences found",
                      findInputSource);
             }     
          }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -1037,7 +1037,7 @@ else if (type == ClientEvent.ExecuteAppCommand)
       }
       catch(Throwable e)
       {
-         GWT.log("WARNING: Exception occured dispatching event: " + type, e);
+         GWT.log("WARNING: Exception occurred dispatching event: " + type, e);
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -3624,7 +3624,7 @@ private native void performCallback(JavaScriptObject responseCallback,
       final ResponseHandler responseHandler = new ResponseHandler();
       
       // setup a retry handler which will call back the second time with
-      // the same args (but no retryHandler, ensurin at most 1 retry)
+      // the same args (but no retryHandler, ensuring at most 1 retry)
       RetryHandler retryHandler = new RetryHandler() {
         
          public void onRetry()

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerAuth.java
Patch:
@@ -107,7 +107,7 @@ public void attemptToUpdateCredentials()
          public void onResponseReceived(Integer response)
          {
             // this method does nothing in the case of both successfully
-            // updating credentails and method not found. however, if
+            // updating credentials and method not found. however, if
             // the credentials update fails then it needs to blow
             // away the client
             

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearch.java
Patch:
@@ -146,7 +146,7 @@ public void onFocus(FocusEvent event)
         @Override
         public void onFileChange(FileChangeEvent event)
         {           
-           // if this was an R file then invalide the cache
+           // if this was an R file then invalidate the cache
            CodeSearchOracle oracle = display_.getSearchOracle();
            if (oracle.hasCachedResults())
            {

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotSizeEditor.java
Patch:
@@ -294,7 +294,7 @@ public void onResizingCompleted()
       initialWidth = constrainWidth(initialWidth);
       initialHeight = constrainHeight(initialHeight);
             
-      // initialie text boxes
+      // initialize text boxes
       setWidthTextBox(initialWidth);
       setHeightTextBox(initialHeight);
  

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsAccessor.java
Patch:
@@ -582,7 +582,7 @@ public PrefValue<Boolean> warnVariableDefinedButNotUsed()
    }
 
    /**
-    * Whether to automatically discover and offer to install missing R package dependenices.
+    * Whether to automatically discover and offer to install missing R package dependencies.
     */
    public PrefValue<Boolean> autoDiscoverPackageDependencies()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneConfig.java
Patch:
@@ -184,7 +184,7 @@ public final boolean validateAndAutoCorrect()
       replaceObsoleteTabs(ts2);
 
       // Presentation tab must always be at the end of the ts1 tabset (this 
-      // is so that activating it works even in the presense of optionally
+      // is so that activating it works even in the presence of optionally
       // visible tabs). This is normally an invariant but for a time during 
       // the v0.99-1000 preview we allowed the Connections tab to be the 
       // last one in the tabset.

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsPresenter.java
Patch:
@@ -272,7 +272,7 @@ private void showError(String errorMessage)
    
    public void onNewConnection()
    {
-      // if r session bussy, fail
+      // if r session busy, fail
       if (commands_.interruptR().isEnabled()) {
          showError(
             "The R session is currently busy. Wait for completion or " +

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -425,7 +425,7 @@ public void execute()
          }
       };
       
-      // do standrd finish if we aren't animating
+      // do standard finish if we aren't animating
       if (!event.shouldAnimate())
       {
          display.clear();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ShellInputAnimator.java
Patch:
@@ -67,7 +67,7 @@ private void executePendingAnimatedInput()
    {      
       if (pendingAnimatedInput_.size() > 0)
       {
-         // get the input animaator
+         // get the input animator
          InputAnimator inputAnimator = pendingAnimatedInput_.get(0);
          
          // calculate the period (make sure the command takes no longer

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -293,7 +293,7 @@ public void goToDefinition()
          if (cursor.moveToPosition(editor.getCursorPosition(), true))
          {
             // if the cursor is 'on' a left bracket, move back to the associated
-            // token (obstensibly a funciton name)
+            // token (ostensibly a function name)
             if (cursor.isLeftBracket())
                cursor.moveToPreviousToken();
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -209,7 +209,7 @@ protected Widget createMainWidget()
       return objects_;
    }
 
-   // EnviromentPresenter.Display implementation ------------------------------
+   // EnvironmentPresenter.Display implementation ------------------------------
 
    @Override
    public void addObject(RObject object)
@@ -401,7 +401,7 @@ public void setViewDirty()
       isClientStateDirty_ = true;
    }
 
-   // EnviromentObjects.Observer implementation -------------------------------
+   // EnvironmentObjects.Observer implementation -------------------------------
 
    public void setPersistedScrollPosition(int scrollPosition)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/Help.java
Patch:
@@ -124,7 +124,7 @@ public void onListChanged(ListChangedEvent event)
             final LinkMenu history = view_.getHistory() ;
             history.clearLinks();
             
-            // intialize from the list
+            // initialize from the list
             ArrayList<String> list = event.getList();
             for (int i=0; i<list.size(); i++)
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/model/HistoryServerOperations.java
Patch:
@@ -74,7 +74,7 @@ void getHistoryArchiveItems(
    /*
     *  searchHistoryDatabase - search the history archive for the query 
     *  (return up to maxEntries). the search is conducted beginning with the
-    *  most recent history items and returned in index decsending order i.e. newest
+    *  most recent history items and returned in index descending order i.e. newest
     *  ones first)
     */
    void searchHistoryArchive(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -167,7 +167,7 @@ public void setPackageStatus(PackageStatus status)
    
    private int packageRow(String packageName, String packageLib)
    {
-      // if we haven't retreived packages yet then return not found
+      // if we haven't retrieved packages yet then return not found
       if (packagesDataProvider_ == null)
          return -1;
       
@@ -537,7 +537,7 @@ else if (source == "source")
       packagesTableContainer_.add(packagesTable_);
       layoutPackagesTable();
       
-      // unbind old table from data provider incase we've re-generated the pane
+      // unbind old table from data provider in case we've re-generated the pane
       for (HasData<PackageInfo> display : packagesDataProvider_.getDataDisplays())
          packagesDataProvider_.removeDataDisplay(display);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/manipulator/ManipulatorControlSlider.java
Patch:
@@ -63,7 +63,7 @@ public ManipulatorControlSlider(String variable,
       double step = slider.getStep();
       if (step == -1)
       {        
-         // short range or decimals means continous decimal
+         // short range or decimals means continuous decimal
          if (range < 2 || hasDecimals(max) || hasDecimals(min) )
             step = range / 250; // ~ one step per pixel
          else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindow.java
Patch:
@@ -120,7 +120,7 @@ public void onError(ServerError error)
       
       // in desktop mode, the frame checks to see if we want to be closed, but
       // in web mode the best we can do is prompt if the user attempts to close
-      // a source window with unsaved chaanges.
+      // a source window with unsaved changes.
       if (!Desktop.hasDesktopFrame())
       {
          Window.addWindowClosingHandler(new ClosingHandler() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -334,7 +334,7 @@ public void onCompleted()
 
       public void onError(final String message)
       {
-         // in case the error occured saving a document that wasn't 
+         // in case the error occurred saving a document that wasn't
          // in the foreground
          view_.ensureVisible();
          
@@ -6992,7 +6992,7 @@ public TextEditingTargetNotebook getNotebook()
    
    /**
     * Updates the path of the file loaded in the editor, as though the user
-    * had just saved the file at the new paht.
+    * had just saved the file at the new path.
     * 
     * @param path New path for the editor
     */

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCompilePdfHelper.java
Patch:
@@ -70,7 +70,7 @@ public void initialize(UserPrefs prefs,
    // the chunk options are ready the callback command is execute (note
    // that if there are no chunk options available then execute will 
    // never be called). this method caches the results from the server
-   // so that chunk options are only retreived once per session -- we 
+   // so that chunk options are only retrieved once per session -- we
    // do this not only to save the round-trip but also because knitr takes
    // over 500ms to load and it may need to be loaded to serve the
    // request for chunk options
@@ -139,7 +139,7 @@ public void checkCompilers(final WarningBarDisplay display,
                               TextFileType fileType)
    {
       // for all tex files we need to parse magic comments and validate
-      // any explict latex proram directive
+      // any explicit latex program directive
       ArrayList<TexMagicComment> magicComments = null;
       if (fileType.canCompilePDF())
       {
@@ -340,7 +340,7 @@ public int getRnwOptionsStart(String line, int cursorPos)
    }
 
    // get the currently active rnw weave name -- arranges to always return
-   // a valid string by returing the pref if the directive is invalid
+   // a valid string by returning the pref if the directive is invalid
    public String getActiveRnwWeaveName()
    {
       if (docDisplay_.getFileType().canKnitToHTML() || 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -865,7 +865,7 @@ public void execute()
                      public void execute()
                      {  
                         // subscribe to notification of params ready
-                        // (ensure only one handler at a time is sucscribed)
+                        // (ensure only one handler at a time is subscribed)
                         rmdParamsReadyUnsubscribe();
                         rmdParamsReadyRegistration_ = eventBus_.addHandler(
                               RmdParamsReadyEvent.TYPE, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetThemeHelper.java
Patch:
@@ -40,7 +40,7 @@ public TextEditingTargetThemeHelper(final TextEditingTarget editingTarget,
          // do the sync
          syncToEditorTheme(editingTarget);
 
-         // register for notification on subsquent changes
+         // register for notification on subsequent changes
          releaseOnDismiss.add(
                eventBus.addHandler(
                      EditorThemeChangedEvent.TYPE,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceCommandManager.java
Patch:
@@ -152,7 +152,7 @@ private final native void rebindCommand(String id, JsArrayString keys)
       var command = this.byName[id];
       
       // The command can be null if it's an excluded command, or
-      // the user has manually editted their keybinding file and
+      // the user has manually edited their keybinding file and
       // selected the ID of a non-existent command.
       if (command == null)
          return;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionUtils.java
Patch:
@@ -82,7 +82,7 @@ public static CompletionPosition getCompletionPosition(DocDisplay docDisplay,
       // determine the column right before this one
       int inputCol = position.getColumn() - 1;
                
-      // walk backwards across C++ identifer symbols 
+      // walk backwards across C++ identifier symbols
       int col = inputCol;
       if (isInclude)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalBusyEvent.java
Patch:
@@ -18,7 +18,7 @@
 import com.google.gwt.event.shared.GwtEvent;
 
 /**
- * Sent when overall state of terminal busy-ness changes. That is, if any
+ * Sent when overall state of terminal busyness changes. That is, if any
  * terminal is busy, this event signals busy.
  */
 public class TerminalBusyEvent extends GwtEvent<TerminalBusyEvent.Handler>

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPresenter.java
Patch:
@@ -379,7 +379,7 @@ public void onResponseReceived(String url)
                globalDisplay_.showErrorMessage(
                      "Error", 
                      "Unable to view " + path + " on GitHub.\n\n" +
-                     "Are you sure that this file is on GithHub and is " + 
+                     "Are you sure that this file is on GitHub and is " +
                      "contained in the currently active project?");
             }
             else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/dialog/GitReviewPanel.java
Patch:
@@ -426,7 +426,7 @@ private int getLineScroll(ScrollPanel panel)
    private int getPageScroll(ScrollPanel panel)
    {
       // Return slightly less than the client height (so there's overlap between
-      // one screen and the next) but never less than the line scoll height.
+      // one screen and the next) but never less than the line scroll height.
       return Math.max(
             getLineScroll(panel),
             panel.getElement().getClientHeight() - getLineScroll(panel));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/dialog/SVNReviewPanel.java
Patch:
@@ -334,7 +334,7 @@ private int getLineScroll(ScrollPanel panel)
    private int getPageScroll(ScrollPanel panel)
    {
       // Return slightly less than the client height (so there's overlap between
-      // one screen and the next) but never less than the line scoll height.
+      // one screen and the next) but never less than the line scroll height.
       return Math.max(
             getLineScroll(panel),
             panel.getElement().getClientHeight() - getLineScroll(panel));

File: src/gwt/src/org/rstudio/core/client/widget/FastSelectTable.java
Patch:
@@ -18,7 +18,6 @@
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.dom.client.*;
-import com.google.gwt.dom.client.Element;
 import com.google.gwt.dom.client.Style.Cursor;
 import com.google.gwt.event.dom.client.*;
 import com.google.gwt.event.shared.HandlerRegistration;

File: src/gwt/src/org/rstudio/studio/client/application/model/RVersionSpec.java
Patch:
@@ -16,7 +16,6 @@
 
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefsAccessor.DefaultRVersion;
 
-import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
 
 public class RVersionSpec extends DefaultRVersion

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJax.java
Patch:
@@ -29,7 +29,6 @@
 import org.rstudio.studio.client.common.mathjax.display.MathJaxPopupPanel;
 import org.rstudio.studio.client.rmarkdown.model.RmdChunkOptions;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ChunkOutputSize;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ChunkOutputWidget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.DocDisplay;

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/CRANMirror.java
Patch:
@@ -19,9 +19,6 @@
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 
-import com.google.gwt.core.client.JavaScriptObject;
-
-
 public class CRANMirror extends UserPrefs.CranMirror
 {
    protected CRANMirror()

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/MirrorsServerOperations.java
Patch:
@@ -15,7 +15,6 @@
 package org.rstudio.studio.client.common.mirrors.model;
 
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.Void;
 
 import com.google.gwt.core.client.JsArray;
 

File: src/gwt/src/org/rstudio/studio/client/plumber/PlumberAPI.java
Patch:
@@ -39,7 +39,6 @@
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefsAccessor;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleBusyEvent;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
 import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent;

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryPage.java
Patch:
@@ -31,7 +31,6 @@
 import org.rstudio.studio.client.projects.model.ProjectTemplateOptions;
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserState;
 
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.logical.shared.ValueChangeEvent;

File: src/gwt/src/org/rstudio/studio/client/renv/ui/RenvActionDialogContents.java
Patch:
@@ -31,7 +31,6 @@
 import com.google.gwt.user.cellview.client.DataGrid;
 import com.google.gwt.user.cellview.client.TextColumn;
 import com.google.gwt.user.client.ui.Composite;
-import com.google.gwt.user.client.ui.HTML;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.Widget;
 

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputFramePane.java
Patch:
@@ -20,7 +20,6 @@
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.RStudioFrame;
 import org.rstudio.studio.client.application.events.EventBus;
-import org.rstudio.studio.client.rmarkdown.RmdOutput;
 import org.rstudio.studio.client.rmarkdown.model.RMarkdownServerOperations;
 import org.rstudio.studio.client.rmarkdown.model.RmdPreviewParams;
 import org.rstudio.studio.client.server.VoidServerRequestCallback;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputFrameSatellite.java
Patch:
@@ -4,7 +4,6 @@
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.common.satellite.SatelliteManager;
-import org.rstudio.studio.client.rmarkdown.RmdOutput;
 import org.rstudio.studio.client.rmarkdown.RmdOutputSatellite;
 import org.rstudio.studio.client.rmarkdown.model.RmdPreviewParams;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectAccountList.java
Patch:
@@ -17,7 +17,6 @@
 import java.util.ArrayList;
 import java.util.List;
 
-import com.google.gwt.dom.client.Element;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.WidgetListBox;
 import org.rstudio.studio.client.common.GlobalDisplay;

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -27,7 +27,6 @@
 import org.rstudio.studio.client.common.rnw.RnwWeave;
 import org.rstudio.studio.client.workbench.addins.Addins.RAddins;
 import org.rstudio.studio.client.workbench.prefs.model.PrefLayer;
-import org.rstudio.studio.client.workbench.prefs.model.Prefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildState;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/events/UserStateChangedEvent.java
Patch:
@@ -18,9 +18,7 @@
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.workbench.prefs.model.PrefLayer;
-import org.rstudio.studio.client.workbench.prefs.model.UserState;
 
-import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.event.shared.EventHandler;
 
 @JavaScriptSerializable

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefs.java
Patch:
@@ -27,8 +27,6 @@
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.Void;
-import org.rstudio.studio.client.workbench.events.SessionInitEvent;
-import org.rstudio.studio.client.workbench.events.SessionInitHandler;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.events.UserPrefsChangedEvent;
 import org.rstudio.studio.client.workbench.prefs.events.UserPrefsChangedHandler;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsComputed.java
Patch:
@@ -13,7 +13,6 @@
  */
 package org.rstudio.studio.client.workbench.prefs.model;
 
-import org.rstudio.studio.client.application.model.RVersionSpec;
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 
 import com.google.gwt.core.client.JsArray;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserState.java
Patch:
@@ -26,8 +26,6 @@
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.Void;
-import org.rstudio.studio.client.workbench.events.SessionInitEvent;
-import org.rstudio.studio.client.workbench.events.SessionInitHandler;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.events.UserStateChangedEvent;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserStateAccessor.java
Patch:
@@ -23,9 +23,7 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 
 import com.google.gwt.core.client.JavaScriptObject;
-import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.core.client.JsArray;
-import org.rstudio.core.client.JsArrayUtil;
 
 
 /**

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/RMarkdownPreferencesPane.java
Patch:
@@ -21,10 +21,8 @@
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.SelectWidget;
 import org.rstudio.studio.client.common.HelpLink;
-import org.rstudio.studio.client.rmarkdown.RmdOutput;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 
 public class RMarkdownPreferencesPane extends PreferencesPane
 {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/ConsoleTabPanel.java
Patch:
@@ -28,7 +28,6 @@
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.console.ConsoleClearButton;
 import org.rstudio.studio.client.workbench.views.console.ConsoleInterruptButton;
 import org.rstudio.studio.client.workbench.views.console.ConsoleInterruptProfilerButton;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManagerBase.java
Patch:
@@ -29,7 +29,6 @@
 import org.rstudio.studio.client.common.codetools.Completions;
 import org.rstudio.studio.client.common.codetools.RCompletionType;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionRequester.QualifiedName;
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditor;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -56,7 +56,6 @@
 import org.rstudio.studio.client.workbench.codesearch.model.ObjectDefinition;
 import org.rstudio.studio.client.workbench.codesearch.model.SearchPathFunctionDefinition;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionRequester.CompletionResult;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/ClearAllDialog.java
Patch:
@@ -33,7 +33,6 @@
 import org.rstudio.core.client.widget.ThemedButton;
 import org.rstudio.core.client.widget.images.MessageDialogImages;
 import org.rstudio.studio.client.RStudioGinjector;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
 
 public class ClearAllDialog extends ModalDialogBase

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobsPane.java
Patch:
@@ -16,7 +16,6 @@
 
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefsAccessor;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.jobs.JobsPresenter;
 import org.rstudio.studio.client.workbench.views.jobs.model.Job;
 import org.rstudio.studio.client.workbench.views.jobs.model.JobOutput;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/DocumentOutlineWidget.java
Patch:
@@ -23,7 +23,6 @@
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.filetypes.TextFileType;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.source.editors.text.Scope;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ScopeFunction;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTarget;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTargetCodeExecution.java
Patch:
@@ -24,7 +24,6 @@
 import org.rstudio.studio.client.rmarkdown.events.SendToChunkConsoleEvent;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleExecutePendingInputEvent;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
 import org.rstudio.studio.client.workbench.views.jobs.events.JobRunSelectionEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -85,7 +85,6 @@
 import org.rstudio.studio.client.workbench.model.ChangeTracker;
 import org.rstudio.studio.client.workbench.model.EventBasedChangeTracker;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionManager;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionManager.InitCompletionFilter;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorIdleCommands.java
Patch:
@@ -16,7 +16,6 @@
 
 import org.rstudio.studio.client.common.mathjax.MathJaxUtil;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetIdleMonitor.IdleCommand;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetIdleMonitor.IdleState;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Position;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ImagePreviewer.java
Patch:
@@ -29,7 +29,6 @@
 import org.rstudio.studio.client.common.FilePathUtils;
 import org.rstudio.studio.client.rmarkdown.model.RmdChunkOptions;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.LineWidget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Position;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Range;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/InlinePreviewer.java
Patch:
@@ -16,7 +16,6 @@
 
 import org.rstudio.core.client.HandlerRegistrations;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.ScopeTreeReadyEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.TextEditingTargetNotebook;
 import org.rstudio.studio.client.workbench.views.source.model.DocUpdateSentinel;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -27,7 +27,6 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.EditorModeChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.ScopeTreeReadyEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.ChunkContextUi;
-import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceTheme;
 
 import com.google.gwt.event.logical.shared.ValueChangeEvent;
 import com.google.gwt.event.logical.shared.ValueChangeHandler;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -76,7 +76,6 @@
 import org.rstudio.studio.client.workbench.model.SessionUtils;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
 import org.rstudio.studio.client.workbench.views.edit.ui.EditDialog;
 import org.rstudio.studio.client.workbench.views.source.DocumentOutlineWidget;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionManager.java
Patch:
@@ -24,7 +24,6 @@
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionManager;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionUtils;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java
Patch:
@@ -37,7 +37,6 @@
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.Void;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.EditorThemeChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.themes.model.ThemeServerOperations;

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/SavePlotAsImageDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SavePlotAsImageDialog.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -56,7 +56,7 @@ public void execute()
                {
                   onClose.execute(getCurrentOptions(options));
              
-                  closeDialog();   
+                  closeDialog();
                }
             });
          }
@@ -96,7 +96,7 @@ protected ExportPlotOptions getCurrentOptions(ExportPlotOptions previous)
                                       sizeEditor.getKeepRatio(),
                                       saveAsTarget_.getFormat(),
                                       viewAfterSaveCheckBox_.getValue(),
-                                      previous.getCopyAsMetafile());    
+                                      previous.getCopyAsMetafile());
    }
    
    private void attemptSavePlot(boolean overwrite,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -73,7 +73,6 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.files.model.FilesServerOperations;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Position;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.NewRMarkdownDialog;
@@ -107,6 +106,7 @@ public void initialize(Session session,
                           GlobalDisplay globalDisplay,
                           EventBus eventBus,
                           UserPrefs prefs,
+                          UserState state,
                           ConsoleDispatcher consoleDispatcher,
                           WorkbenchContext workbenchContext,
                           FileTypeCommands fileTypeCommands,
@@ -119,6 +119,7 @@ public void initialize(Session session,
       globalDisplay_ = globalDisplay;
       eventBus_ = eventBus;
       prefs_ = prefs;
+      state_ = state;
       consoleDispatcher_ = consoleDispatcher;
       workbenchContext_ = workbenchContext;
       dependencyManager_ = dependencyManager;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalDiagnostics.java
Patch:
@@ -22,7 +22,7 @@ public void log(String msg)
    {
       if (diagnostic_ == null)
          diagnostic_ = new StringBuilder();
-     
+
       diagnostic_.append(StringUtil.getTimestamp());
       diagnostic_.append(": ");
       diagnostic_.append(msg);
@@ -36,7 +36,7 @@ public String getLog()
       else
          return diagnostic_.toString();
    }
-   
+
    public void resetLog()
    {
       diagnostic_ = null;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalShellInfo.java
Patch:
@@ -28,8 +28,8 @@ public final native String getShellType() /*-{
 
    public final native String getShellName() /*-{
       return this.name;
-   }-*/; 
-   
+   }-*/;
+
    public static String getShellName(String shell)
    {
       switch (shell)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermDimensions.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * XTermDimensions.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -24,7 +24,7 @@
 public class XTermDimensions extends JavaScriptObject
 {
    protected XTermDimensions() {}
-   
+
    public final native int getCols() /*-{
       if (this.cols !== this.cols) { return -1; } // isNaN
       return this.cols;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermThemeResources.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * XTermThemeResources.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -22,7 +22,7 @@
 public interface XTermThemeResources extends ClientBundle
 {
    public static final XTermThemeResources INSTANCE = GWT.create(XTermThemeResources.class);
-  
+
    @Source("xterm.css")
-   StaticDataResource xtermcss();   
+   StaticDataResource xtermcss();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/SavePlotAsImageDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SavePlotAsImageDialog.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -56,7 +56,7 @@ public void execute()
                {
                   onClose.execute(getCurrentOptions(options));
              
-                  closeDialog();   
+                  closeDialog();
                }
             });
          }
@@ -96,7 +96,7 @@ protected ExportPlotOptions getCurrentOptions(ExportPlotOptions previous)
                                       sizeEditor.getKeepRatio(),
                                       saveAsTarget_.getFormat(),
                                       viewAfterSaveCheckBox_.getValue(),
-                                      previous.getCopyAsMetafile());    
+                                      previous.getCopyAsMetafile());
    }
    
    private void attemptSavePlot(boolean overwrite,

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/SavePlotAsImageDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SavePlotAsImageDialog.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -56,7 +56,7 @@ public void execute()
                {
                   onClose.execute(getCurrentOptions(options));
              
-                  closeDialog();   
+                  closeDialog();
                }
             });
          }
@@ -96,7 +96,7 @@ protected ExportPlotOptions getCurrentOptions(ExportPlotOptions previous)
                                       sizeEditor.getKeepRatio(),
                                       saveAsTarget_.getFormat(),
                                       viewAfterSaveCheckBox_.getValue(),
-                                      previous.getCopyAsMetafile());    
+                                      previous.getCopyAsMetafile());
    }
    
    private void attemptSavePlot(boolean overwrite,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -73,7 +73,6 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UserState;
-import org.rstudio.studio.client.workbench.prefs.model.UserPrefUtils;
 import org.rstudio.studio.client.workbench.views.files.model.FilesServerOperations;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Position;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.NewRMarkdownDialog;
@@ -107,6 +106,7 @@ public void initialize(Session session,
                           GlobalDisplay globalDisplay,
                           EventBus eventBus,
                           UserPrefs prefs,
+                          UserState state,
                           ConsoleDispatcher consoleDispatcher,
                           WorkbenchContext workbenchContext,
                           FileTypeCommands fileTypeCommands,
@@ -119,6 +119,7 @@ public void initialize(Session session,
       globalDisplay_ = globalDisplay;
       eventBus_ = eventBus;
       prefs_ = prefs;
+      state_ = state;
       consoleDispatcher_ = consoleDispatcher;
       workbenchContext_ = workbenchContext;
       dependencyManager_ = dependencyManager;

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotSizeEditor.java
Patch:
@@ -179,8 +179,7 @@ public void onChange(ChangeEvent event)
   
       // lock ratio check box
       keepRatioCheckBox_ = new CheckBox();
-      keepRatioCheckBox_.setStylePrimaryName(
-                           resources.styles().maintainAspectRatioCheckBox());
+      keepRatioCheckBox_.addStyleName(resources.styles().maintainAspectRatioCheckBox());
       keepRatioCheckBox_.setValue(keepRatio);
       keepRatioCheckBox_.setText("Maintain aspect ratio");
       optionsPanel.add(keepRatioCheckBox_);

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotSizeEditor.java
Patch:
@@ -179,8 +179,7 @@ public void onChange(ChangeEvent event)
   
       // lock ratio check box
       keepRatioCheckBox_ = new CheckBox();
-      keepRatioCheckBox_.setStylePrimaryName(
-                           resources.styles().maintainAspectRatioCheckBox());
+      keepRatioCheckBox_.addStyleName(resources.styles().maintainAspectRatioCheckBox());
       keepRatioCheckBox_.setValue(keepRatio);
       keepRatioCheckBox_.setText("Maintain aspect ratio");
       optionsPanel.add(keepRatioCheckBox_);

File: src/gwt/src/org/rstudio/core/client/widget/InfoBar.java
Patch:
@@ -36,6 +36,7 @@
 
 import java.util.List;
 
+import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
@@ -72,7 +73,8 @@ public InfoBar(int mode, ClickHandler dismissHandler)
      
       labelRight_ = new HorizontalPanel();
       initWidget(binder.createAndBindUi(this));
-      
+
+      A11y.setARIAHidden(label_);
       Roles.getAlertRole().setAriaLiveProperty(live_.getElement(), 
             mode == ERROR ? LiveValue.ASSERTIVE : LiveValue.POLITE);
       Roles.getAlertRole().setAriaAtomicProperty(live_.getElement(), true);

File: src/gwt/src/org/rstudio/studio/client/application/ui/WarningBar.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.aria.client.Roles;
 import com.google.gwt.dom.client.DivElement;
 import com.google.gwt.user.client.Timer;
+import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.theme.res.ThemeResources;
 
 import com.google.gwt.core.client.GWT;
@@ -81,6 +82,7 @@ public WarningBar()
       moreButton_.setVisible(false);
       moreButton_.setText("Manage License...");
       moreButton_.addClickHandler(event -> Desktop.getFrame().showLicenseDialog());
+      A11y.setARIAHidden(label_);
       Roles.getAlertRole().setAriaLiveProperty(live_, LiveValue.ASSERTIVE);
       Roles.getAlertRole().setAriaAtomicProperty(live_, true);
    }

File: src/gwt/src/org/rstudio/core/client/widget/InfoBar.java
Patch:
@@ -36,6 +36,7 @@
 
 import java.util.List;
 
+import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
@@ -72,7 +73,8 @@ public InfoBar(int mode, ClickHandler dismissHandler)
      
       labelRight_ = new HorizontalPanel();
       initWidget(binder.createAndBindUi(this));
-      
+
+      A11y.setARIAHidden(label_);
       Roles.getAlertRole().setAriaLiveProperty(live_.getElement(), 
             mode == ERROR ? LiveValue.ASSERTIVE : LiveValue.POLITE);
       Roles.getAlertRole().setAriaAtomicProperty(live_.getElement(), true);

File: src/gwt/src/org/rstudio/studio/client/application/ui/WarningBar.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.aria.client.Roles;
 import com.google.gwt.dom.client.DivElement;
 import com.google.gwt.user.client.Timer;
+import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.theme.res.ThemeResources;
 
 import com.google.gwt.core.client.GWT;
@@ -81,6 +82,7 @@ public WarningBar()
       moreButton_.setVisible(false);
       moreButton_.setText("Manage License...");
       moreButton_.addClickHandler(event -> Desktop.getFrame().showLicenseDialog());
+      A11y.setARIAHidden(label_);
       Roles.getAlertRole().setAriaLiveProperty(live_, LiveValue.ASSERTIVE);
       Roles.getAlertRole().setAriaAtomicProperty(live_, true);
    }

File: src/gwt/src/org/rstudio/core/client/StringUtil.java
Patch:
@@ -1418,7 +1418,8 @@ public static char charAt(String str, int pos)
     */
    public static native String spacedString(String str) /*-{
       return str.split('').join(' ');
-   }-*/;   
+   }-*/;
+
    private static final NumberFormat FORMAT = NumberFormat.getFormat("0.#");
    private static final NumberFormat PRETTY_NUMBER_FORMAT = NumberFormat.getFormat("#,##0.#####");
    private static final DateTimeFormat DATE_FORMAT

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/dialog/GitReviewPanel.java
Patch:
@@ -692,7 +692,7 @@ private void updateCharCount()
       // Debounce an update to the accessible character count
       if (updateCharCountTimer_.isRunning())
          updateCharCountTimer_.cancel();
-      updateCharCountTimer_.schedule(2000);
+      updateCharCountTimer_.schedule(A11y.TypingStatusDelayMs);
    }
 
    @UiField(provided = true)

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotResources.java
Patch:
@@ -51,7 +51,7 @@ public static interface Styles extends CssResource
       String savePdfMainWidget();
       String savePdfSizeListBox();
       String savePdfSizeLabel();
-      String savePdfDirectoryLabel();
+      String savePdfDirectoryTextBox();
       String savePdfFileNameLabel();
       String savePdfFileNameTextBox();
       String savePdfViewAfterCheckbox();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewShinyWebApplication.java
Patch:
@@ -22,11 +22,11 @@
 import org.rstudio.core.client.regex.Pattern;
 import org.rstudio.core.client.widget.DecorativeImage;
 import org.rstudio.core.client.widget.DirectoryChooserTextBox;
+import org.rstudio.core.client.widget.FieldSetWrapperPanel;
 import org.rstudio.core.client.widget.FormLabel;
 import org.rstudio.core.client.widget.LayoutGrid;
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
-import org.rstudio.core.client.widget.VerticalRadioPanel;
 import org.rstudio.core.client.widget.VerticalSpacer;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -211,7 +211,7 @@ public NewShinyWebApplication(String caption,
       appTypeLabel_.addStyleName(RES.styles().label());
       appTypeLabel_.getElement().getStyle().setMarginTop(2, Unit.PX);
       
-      VerticalRadioPanel radioPanel = new VerticalRadioPanel(appTypeLabel_);
+      FieldSetWrapperPanel<VerticalPanel> radioPanel = new FieldSetWrapperPanel<>(new VerticalPanel(), appTypeLabel_);
       radioPanel.setStylePrimaryName(RES.styles().shinyTypeGroup());
       appTypeSingleFileButton_ = new RadioButton("shiny", "Single File (app.R)");
       appTypeMultipleFileButton_ = new RadioButton("shiny", "Multiple File (ui.R/server.R)");

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotResources.java
Patch:
@@ -51,7 +51,7 @@ public static interface Styles extends CssResource
       String savePdfMainWidget();
       String savePdfSizeListBox();
       String savePdfSizeLabel();
-      String savePdfDirectoryLabel();
+      String savePdfDirectoryTextBox();
       String savePdfFileNameLabel();
       String savePdfFileNameTextBox();
       String savePdfViewAfterCheckbox();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewShinyWebApplication.java
Patch:
@@ -22,11 +22,11 @@
 import org.rstudio.core.client.regex.Pattern;
 import org.rstudio.core.client.widget.DecorativeImage;
 import org.rstudio.core.client.widget.DirectoryChooserTextBox;
+import org.rstudio.core.client.widget.FieldSetWrapperPanel;
 import org.rstudio.core.client.widget.FormLabel;
 import org.rstudio.core.client.widget.LayoutGrid;
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
-import org.rstudio.core.client.widget.VerticalRadioPanel;
 import org.rstudio.core.client.widget.VerticalSpacer;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -211,7 +211,7 @@ public NewShinyWebApplication(String caption,
       appTypeLabel_.addStyleName(RES.styles().label());
       appTypeLabel_.getElement().getStyle().setMarginTop(2, Unit.PX);
       
-      VerticalRadioPanel radioPanel = new VerticalRadioPanel(appTypeLabel_);
+      FieldSetWrapperPanel<VerticalPanel> radioPanel = new FieldSetWrapperPanel<>(new VerticalPanel(), appTypeLabel_);
       radioPanel.setStylePrimaryName(RES.styles().shinyTypeGroup());
       appTypeSingleFileButton_ = new RadioButton("shiny", "Single File (app.R)");
       appTypeMultipleFileButton_ = new RadioButton("shiny", "Multiple File (ui.R/server.R)");

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/ui/AskSecretDialog.java
Patch:
@@ -103,7 +103,6 @@ public void onKeyDown(KeyDownEvent event)
       });
 
       label_.setText(prompt);
-      label_.setFor(textbox_);
       Roles.getTextboxRole().setAriaRequiredProperty(textbox_.getElement(), true);
 
       install_.addClickHandler(new ClickHandler() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/ImportFileSettingsDialog.java
Patch:
@@ -33,6 +33,7 @@
 import org.rstudio.core.client.Invalidation.Token;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.js.JsObject;
+import org.rstudio.core.client.widget.LabeledTextBox;
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ProgressIndicator;
@@ -405,7 +406,7 @@ public static void ensureStylesInjected()
    @UiField
    RadioButton headingNo_;
    @UiField
-   TextBox varname_;
+   LabeledTextBox varname_;
    @UiField
    TextBox naStrings_;
    @UiField

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/ui/AskSecretDialog.java
Patch:
@@ -103,7 +103,6 @@ public void onKeyDown(KeyDownEvent event)
       });
 
       label_.setText(prompt);
-      label_.setFor(textbox_);
       Roles.getTextboxRole().setAriaRequiredProperty(textbox_.getElement(), true);
 
       install_.addClickHandler(new ClickHandler() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/ImportFileSettingsDialog.java
Patch:
@@ -33,6 +33,7 @@
 import org.rstudio.core.client.Invalidation.Token;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.js.JsObject;
+import org.rstudio.core.client.widget.LabeledTextBox;
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ProgressIndicator;
@@ -405,7 +406,7 @@ public static void ensureStylesInjected()
    @UiField
    RadioButton headingNo_;
    @UiField
-   TextBox varname_;
+   LabeledTextBox varname_;
    @UiField
    TextBox naStrings_;
    @UiField

File: src/gwt/src/org/rstudio/studio/client/application/events/ApplicationEventHandlers.java
Patch:
@@ -32,6 +32,7 @@ public interface ApplicationEventHandlers extends LogoutRequestedHandler,
                                                   ServerOfflineHandler,
                                                   InvalidSessionEvent.Handler,
                                                   SessionInitHandler,
-                                                  RestartStatusEvent.Handler
+                                                  RestartStatusEvent.Handler,
+                                                  FileUploadHandler
 {
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -116,7 +116,9 @@ void showFileUpload(
                      String targetURL,
                      FileSystemItem targetDirectory, 
                      RemoteFileSystemContext fileSystemContext,
-                     OperationWithInput<PendingFileUpload> completedOperation);
+                     Operation beginOperation,
+                     OperationWithInput<PendingFileUpload> completedOperation,
+                     Operation failedOperation);
 
 
       void showHtmlFileChoice(FileSystemItem file, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.resources.ImageResource2x;
+import org.rstudio.core.client.widget.FieldSetPanel;
 import org.rstudio.core.client.widget.FormLabel;
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
@@ -392,8 +393,7 @@ private void updateOptions(String selectedTemplate)
       else 
       {
          
-         currentTemplate_ = RmdTemplate.getTemplate(templates_,
-                                                    selectedTemplate);
+         currentTemplate_ = RmdTemplate.getTemplate(templates_, selectedTemplate);
          if (currentTemplate_ == null)
             return;
          
@@ -470,12 +470,12 @@ private Widget createFormatOption(String name, String description)
    @UiField WidgetListBox<TemplateMenuItem> listTemplates_;
    @UiField NewRmdStyle style;
    @UiField Resources resources;
+   @UiField FieldSetPanel formatFieldSet_;
    @UiField HTMLPanel templateFormatPanel_;
    @UiField HTMLPanel newTemplatePanel_;
    @UiField HTMLPanel existingTemplatePanel_;
    @UiField(provided=true) RmdTemplateChooser templateChooser_;
    @UiField HTMLPanel shinyInfoPanel_;
-   @UiField Label outputFormatLabel_;
 
    private final Widget mainWidget_;
    private List<RadioButton> formatOptions_;

File: src/gwt/src/org/rstudio/core/client/widget/InfoBar.java
Patch:
@@ -75,6 +75,7 @@ public InfoBar(int mode, ClickHandler dismissHandler)
       
       Roles.getAlertRole().setAriaLiveProperty(live_.getElement(), 
             mode == ERROR ? LiveValue.ASSERTIVE : LiveValue.POLITE);
+      Roles.getAlertRole().setAriaAtomicProperty(live_.getElement(), true);
       dismiss_.addStyleName(ThemeResources.INSTANCE.themeStyles().handCursor());
       
       if (dismissHandler != null)

File: src/gwt/src/org/rstudio/core/client/widget/LocalRepositoriesWidget.java
Patch:
@@ -40,8 +40,6 @@ public LocalRepositoriesWidget()
       RStudioGinjector.INSTANCE.injectMembers(this);
       
       VerticalPanel panel = new VerticalPanel();
-      panel.add(new LabelWithHelp("Local repositories:",
-            "packrat_local_repos", "Help on local Packrat repositories"));
       
       HorizontalPanel hp = new HorizontalPanel();
       listBox_ = new ListBox();
@@ -59,6 +57,9 @@ public LocalRepositoriesWidget()
       buttonPanel.add(buttonRemove);
       hp.add(buttonPanel);
       
+      panel.add(new LabelWithHelp("Local repositories:",
+            "packrat_local_repos", "Help on local Packrat repositories",
+            listBox_));
       panel.add(hp);
       
       initWidget(panel);

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectAccountEntry.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RSConnectAccountEntry.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,14 +15,14 @@
 package org.rstudio.studio.client.rsconnect.ui;
 
 import org.rstudio.core.client.resources.ImageResource2x;
+import org.rstudio.core.client.widget.DecorativeImage;
 import org.rstudio.studio.client.rsconnect.model.RSConnectAccount;
 
 import com.google.gwt.dom.client.Style.Cursor;
 import com.google.gwt.dom.client.Style.FontWeight;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.HorizontalPanel;
-import com.google.gwt.user.client.ui.Image;
 import com.google.gwt.user.client.ui.Label;
 
 public class RSConnectAccountEntry extends Composite
@@ -53,7 +53,7 @@ public void setAccount(RSConnectAccount account)
       if (account == null)
          return;
       
-      Image icon = new Image(account.isCloudAccount() ? 
+      DecorativeImage icon = new DecorativeImage(account.isCloudAccount() ? 
             new ImageResource2x(RSConnectResources.INSTANCE.cloudAccountIconSmall2x()) : 
             new ImageResource2x(RSConnectResources.INSTANCE.localAccountIconSmall2x()));
       icon.getElement().getStyle().setMarginRight(2, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AceEditorPreview.java
Patch:
@@ -87,6 +87,8 @@ public void onLoaded()
                         if (zoomLevel_ != null)
                            setZoomLevel(zoomLevel_);
 
+                        doc.getHead().getParentElement().setLang("en"); // accessibility requirement
+
                         body.getStyle().setMargin(0, Unit.PX);
                         body.getStyle().setBackgroundColor("white");
 

File: src/gwt/src/org/rstudio/core/client/widget/LocalRepositoriesWidget.java
Patch:
@@ -40,8 +40,6 @@ public LocalRepositoriesWidget()
       RStudioGinjector.INSTANCE.injectMembers(this);
       
       VerticalPanel panel = new VerticalPanel();
-      panel.add(new LabelWithHelp("Local repositories:",
-            "packrat_local_repos", "Help on local Packrat repositories"));
       
       HorizontalPanel hp = new HorizontalPanel();
       listBox_ = new ListBox();
@@ -59,6 +57,9 @@ public LocalRepositoriesWidget()
       buttonPanel.add(buttonRemove);
       hp.add(buttonPanel);
       
+      panel.add(new LabelWithHelp("Local repositories:",
+            "packrat_local_repos", "Help on local Packrat repositories",
+            listBox_));
       panel.add(hp);
       
       initWidget(panel);

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectAccountEntry.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RSConnectAccountEntry.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,14 +15,14 @@
 package org.rstudio.studio.client.rsconnect.ui;
 
 import org.rstudio.core.client.resources.ImageResource2x;
+import org.rstudio.core.client.widget.DecorativeImage;
 import org.rstudio.studio.client.rsconnect.model.RSConnectAccount;
 
 import com.google.gwt.dom.client.Style.Cursor;
 import com.google.gwt.dom.client.Style.FontWeight;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.HorizontalPanel;
-import com.google.gwt.user.client.ui.Image;
 import com.google.gwt.user.client.ui.Label;
 
 public class RSConnectAccountEntry extends Composite
@@ -53,7 +53,7 @@ public void setAccount(RSConnectAccount account)
       if (account == null)
          return;
       
-      Image icon = new Image(account.isCloudAccount() ? 
+      DecorativeImage icon = new DecorativeImage(account.isCloudAccount() ? 
             new ImageResource2x(RSConnectResources.INSTANCE.cloudAccountIconSmall2x()) : 
             new ImageResource2x(RSConnectResources.INSTANCE.localAccountIconSmall2x()));
       icon.getElement().getStyle().setMarginRight(2, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AceEditorPreview.java
Patch:
@@ -87,6 +87,8 @@ public void onLoaded()
                         if (zoomLevel_ != null)
                            setZoomLevel(zoomLevel_);
 
+                        doc.getHead().getParentElement().setLang("en"); // accessibility requirement
+
                         body.getStyle().setMargin(0, Unit.PX);
                         body.getStyle().setBackgroundColor("white");
 

File: src/gwt/src/org/rstudio/core/client/widget/NumericValueWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * NumericValueWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -30,11 +30,12 @@ public class NumericValueWidget extends Composite
    public NumericValueWidget(String label)
    {
       FlowPanel flowPanel = new FlowPanel();
-      flowPanel.add(new SpanLabel(label, true));
 
       textBox_ = new TextBox();
       textBox_.setWidth("30px");
       textBox_.getElement().getStyle().setMarginLeft(0.6, Unit.EM);
+
+      flowPanel.add(new SpanLabel(label, textBox_, true));
       flowPanel.add(textBox_);
 
       initWidget(flowPanel);

File: src/gwt/src/org/rstudio/core/client/widget/NumericValueWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * NumericValueWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -30,11 +30,12 @@ public class NumericValueWidget extends Composite
    public NumericValueWidget(String label)
    {
       FlowPanel flowPanel = new FlowPanel();
-      flowPanel.add(new SpanLabel(label, true));
 
       textBox_ = new TextBox();
       textBox_.setWidth("30px");
       textBox_.getElement().getStyle().setMarginLeft(0.6, Unit.EM);
+
+      flowPanel.add(new SpanLabel(label, textBox_, true));
       flowPanel.add(textBox_);
 
       initWidget(flowPanel);

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -601,8 +601,8 @@ else if (type == ClientEvent.UnhandledError)
          }
          else if (type == ClientEvent.ErrorHandlerChanged)
          {
-            String handlerType = event.getData();
-            eventBus_.dispatchEvent(new ErrorHandlerChangedEvent(handlerType));
+            ErrorHandlerChangedEvent.Data data = event.getData();
+            eventBus_.dispatchEvent(new ErrorHandlerChangedEvent(data));
          }
          else if (type == ClientEvent.ViewerNavigate)
          {

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -601,8 +601,8 @@ else if (type == ClientEvent.UnhandledError)
          }
          else if (type == ClientEvent.ErrorHandlerChanged)
          {
-            String handlerType = event.getData();
-            eventBus_.dispatchEvent(new ErrorHandlerChangedEvent(handlerType));
+            ErrorHandlerChangedEvent.Data data = event.getData();
+            eventBus_.dispatchEvent(new ErrorHandlerChangedEvent(data));
          }
          else if (type == ClientEvent.ViewerNavigate)
          {

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -150,7 +150,7 @@ void promptForText(String title,
    void openTerminal(String terminalPath,
                      String workingDirectory,
                      String extraPathEntries,
-                     int shellType);
+                     String shellType);
 
    void setFixedWidthFont(String font);
    void setZoomLevel(double zoomLevel);

File: src/gwt/src/org/rstudio/studio/client/workbench/model/TerminalOptions.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalOptions.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -32,7 +32,7 @@ public native final String getExtraPathEntries() /*-{
       return this.extra_path_entries;
    }-*/;
 
-   public native final int getShellType() /*-{
+   public native final String getShellType() /*-{
       return this.shell_type;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -150,7 +150,7 @@ void promptForText(String title,
    void openTerminal(String terminalPath,
                      String workingDirectory,
                      String extraPathEntries,
-                     int shellType);
+                     String shellType);
 
    void setFixedWidthFont(String font);
    void setZoomLevel(double zoomLevel);

File: src/gwt/src/org/rstudio/studio/client/workbench/model/TerminalOptions.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalOptions.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -32,7 +32,7 @@ public native final String getExtraPathEntries() /*-{
       return this.extra_path_entries;
    }-*/;
 
-   public native final int getShellType() /*-{
+   public native final String getShellType() /*-{
       return this.shell_type;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneConfig.java
Patch:
@@ -31,11 +31,11 @@ public native static PaneConfig create(JsArrayString panes,
                                           boolean consoleLeftOnTop,
                                           boolean consoleRightOnTop) /*-{
       return { 
-         panes: panes, 
+         quadrants: panes, 
          tabSet1: tabSet1, 
          tabSet2: tabSet2,
-         consoleLeftOnTop: consoleLeftOnTop,
-         consoleRightOnTop: consoleRightOnTop 
+         console_left_on_top: consoleLeftOnTop,
+         console_right_on_top: consoleRightOnTop 
       };
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/serializationprogress/ApplicationSerializationProgressLabel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ApplicationSerializationProgressLabel.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.application.ui.serializationprogress;
 
+import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
@@ -31,6 +32,7 @@ interface MyBinder
    public ApplicationSerializationProgressLabel()
    {
       initWidget(binder.createAndBindUi(this));
+      Roles.getStatusRole().set(label_.getElement());
    }
 
    public void setText(String text)

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/CRANMirror.java
Patch:
@@ -68,7 +68,7 @@ public final native void setURL(String url) /*-{
       this.url = url;
    }-*/;
 
-   private final native String getSecondary() /*-{
+   public final native String getSecondary() /*-{
       return this.secondary;
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/BrowseAddinsDialog.java
Patch:
@@ -334,7 +334,7 @@ private Label emptyTableLabel(String caption)
    {
       Label label = new Label(caption);
       label.getElement().getStyle().setMarginTop(20, Unit.PX);
-      label.getElement().getStyle().setColor("#888");
+      label.getElement().getStyle().setColor("#656565");
       return label;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -727,9 +727,9 @@ private void findInTopic(String term, CanFocus findInputSource)
       {
          globalDisplay_.showMessage(MessageDialog.INFO,
                "Find in Topic", 
-               "No occurences found",
+               "No occurrences found",
                findInputSource);
-      }     
+      }
    }
    
    private final native void replaceFrameUrl(JavaScriptObject frame, String url) /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobItem.java
Patch:
@@ -102,6 +102,7 @@ public JobItem(@Assisted Job job, FireEvents eventBus)
       
       name_.setText(job.name);
       spinner_.setResource(new ImageResource2x(RESOURCES.jobSpinner()));
+      spinner_.setAltText("Progress indicator");
       
       ImageResource2x detailsImage = new ImageResource2x(RESOURCES.jobSelect());
       if (JsArrayUtil.jsArrayStringContains(job.actions, JobConstants.ACTION_INFO))
@@ -110,6 +111,7 @@ public JobItem(@Assisted Job job, FireEvents eventBus)
       }
       
       select_.setResource(detailsImage);
+      select_.setAltText("Select Job");
 
       ClickHandler selectJob = evt ->
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/findreplace/FindReplaceBar.java
Patch:
@@ -28,6 +28,7 @@
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.CheckboxLabel;
+import org.rstudio.core.client.widget.DecorativeImage;
 import org.rstudio.core.client.widget.FindTextBox;
 import org.rstudio.core.client.widget.SmallButton;
 import org.rstudio.studio.client.RStudioGinjector;
@@ -151,7 +152,7 @@ public FindReplaceBar(boolean showReplace, final boolean defaultForward)
       btnClose_.addStyleName(ThemeStyles.INSTANCE.handCursor());
       Roles.getButtonRole().setAriaLabelProperty(btnClose_.getElement(), "Close find and replace");
       btnClose_.getElement().appendChild(
-            new Image(new ImageResource2x(ThemeResources.INSTANCE.closeTab2x())).getElement());
+            new DecorativeImage(new ImageResource2x(ThemeResources.INSTANCE.closeTab2x())).getElement());
 
       txtFind_.addKeyDownHandler(new KeyDownHandler()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobItem.java
Patch:
@@ -102,6 +102,7 @@ public JobItem(@Assisted Job job, FireEvents eventBus)
       
       name_.setText(job.name);
       spinner_.setResource(new ImageResource2x(RESOURCES.jobSpinner()));
+      spinner_.setAltText("Progress indicator");
       
       ImageResource2x detailsImage = new ImageResource2x(RESOURCES.jobSelect());
       if (JsArrayUtil.jsArrayStringContains(job.actions, JobConstants.ACTION_INFO))
@@ -110,6 +111,7 @@ public JobItem(@Assisted Job job, FireEvents eventBus)
       }
       
       select_.setResource(detailsImage);
+      select_.setAltText("Select Job");
 
       ClickHandler selectJob = evt ->
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/BrowseAddinsDialog.java
Patch:
@@ -334,7 +334,7 @@ private Label emptyTableLabel(String caption)
    {
       Label label = new Label(caption);
       label.getElement().getStyle().setMarginTop(20, Unit.PX);
-      label.getElement().getStyle().setColor("#888");
+      label.getElement().getStyle().setColor("#656565");
       return label;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -727,9 +727,9 @@ private void findInTopic(String term, CanFocus findInputSource)
       {
          globalDisplay_.showMessage(MessageDialog.INFO,
                "Find in Topic", 
-               "No occurences found",
+               "No occurrences found",
                findInputSource);
-      }     
+      }
    }
    
    private final native void replaceFrameUrl(JavaScriptObject frame, String url) /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/findreplace/FindReplaceBar.java
Patch:
@@ -28,6 +28,7 @@
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.CheckboxLabel;
+import org.rstudio.core.client.widget.DecorativeImage;
 import org.rstudio.core.client.widget.FindTextBox;
 import org.rstudio.core.client.widget.SmallButton;
 import org.rstudio.studio.client.RStudioGinjector;
@@ -151,7 +152,7 @@ public FindReplaceBar(boolean showReplace, final boolean defaultForward)
       btnClose_.addStyleName(ThemeStyles.INSTANCE.handCursor());
       Roles.getButtonRole().setAriaLabelProperty(btnClose_.getElement(), "Close find and replace");
       btnClose_.getElement().appendChild(
-            new Image(new ImageResource2x(ThemeResources.INSTANCE.closeTab2x())).getElement());
+            new DecorativeImage(new ImageResource2x(ThemeResources.INSTANCE.closeTab2x())).getElement());
 
       txtFind_.addKeyDownHandler(new KeyDownHandler()
       {

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdDiscoveredTemplateItem.java
Patch:
@@ -30,7 +30,7 @@ public RmdDiscoveredTemplateItem(RmdDocumentTemplate template)
       panel_ = new HTMLPanel("");
       Label pkg = new Label("{" + template.getPackage() + "}");
       pkg.getElement().getStyle().setFloat(Style.Float.RIGHT);
-      pkg.getElement().getStyle().setColor("#909090");
+      pkg.getElement().getStyle().setColor("#656565");
       panel_.add(pkg);
       Label name = new Label(template.getName());
       name.setTitle(template.getDescription());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/TemplateMenuItem.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TemplateMenuItem.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -20,8 +20,8 @@
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.FlowPanel;
-import com.google.gwt.user.client.ui.Image;
 import com.google.gwt.user.client.ui.InlineLabel;
+import org.rstudio.core.client.widget.DecorativeImage;
 
 public class TemplateMenuItem extends Composite
 {
@@ -36,7 +36,7 @@ public TemplateMenuItem(String templateName)
    
    public void addIcon(ImageResource icon)
    {
-      Image iconImage = new Image(icon);
+      DecorativeImage iconImage = new DecorativeImage(icon);
       wrapper_.insert(iconImage, 0);
       Style imageStyle = iconImage.getElement().getStyle();
       imageStyle.setVerticalAlign(VerticalAlign.MIDDLE);

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdDiscoveredTemplateItem.java
Patch:
@@ -30,7 +30,7 @@ public RmdDiscoveredTemplateItem(RmdDocumentTemplate template)
       panel_ = new HTMLPanel("");
       Label pkg = new Label("{" + template.getPackage() + "}");
       pkg.getElement().getStyle().setFloat(Style.Float.RIGHT);
-      pkg.getElement().getStyle().setColor("#909090");
+      pkg.getElement().getStyle().setColor("#656565");
       panel_.add(pkg);
       Label name = new Label(template.getName());
       name.setTitle(template.getDescription());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/TemplateMenuItem.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TemplateMenuItem.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -20,8 +20,8 @@
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.FlowPanel;
-import com.google.gwt.user.client.ui.Image;
 import com.google.gwt.user.client.ui.InlineLabel;
+import org.rstudio.core.client.widget.DecorativeImage;
 
 public class TemplateMenuItem extends Composite
 {
@@ -36,7 +36,7 @@ public TemplateMenuItem(String templateName)
    
    public void addIcon(ImageResource icon)
    {
-      Image iconImage = new Image(icon);
+      DecorativeImage iconImage = new DecorativeImage(icon);
       wrapper_.insert(iconImage, 0);
       Style imageStyle = iconImage.getElement().getStyle();
       imageStyle.setVerticalAlign(VerticalAlign.MIDDLE);

File: src/gwt/src/org/rstudio/core/client/widget/ResizeGripper.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ResizeGripper.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -24,7 +24,6 @@
 import com.google.gwt.user.client.DOM;
 import com.google.gwt.user.client.Event;
 import com.google.gwt.user.client.ui.Composite;
-import com.google.gwt.user.client.ui.Image;
 
 public class ResizeGripper extends Composite
 {
@@ -39,7 +38,7 @@ public ResizeGripper(Observer observer)
    {   
       observer_ = observer;
       gripperImageResource_ = new ImageResource2x(RESOURCES.resizeGripper2x());
-      Image image = new Image(gripperImageResource_);
+      DecorativeImage image = new DecorativeImage(gripperImageResource_);
       initWidget(image);
       setStylePrimaryName(RESOURCES.styles().resizeGripper());
       

File: src/gwt/src/org/rstudio/core/client/cellview/ImageButtonColumn.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ImageButtonColumn.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -63,7 +63,7 @@ public void render(Context context,
       {
          if (value != null)
          {
-            sb.append(TEMPLATES.render(image_.getSafeHtml(), titleProvider_.get(value)));
+            sb.append(TEMPLATES.render(image_.getSafeHtml(titleProvider_.get(value)), titleProvider_.get(value)));
          }
       }
       

File: src/gwt/src/org/rstudio/core/client/widget/ResizeGripper.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ResizeGripper.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -24,7 +24,6 @@
 import com.google.gwt.user.client.DOM;
 import com.google.gwt.user.client.Event;
 import com.google.gwt.user.client.ui.Composite;
-import com.google.gwt.user.client.ui.Image;
 
 public class ResizeGripper extends Composite
 {
@@ -39,7 +38,7 @@ public ResizeGripper(Observer observer)
    {   
       observer_ = observer;
       gripperImageResource_ = new ImageResource2x(RESOURCES.resizeGripper2x());
-      Image image = new Image(gripperImageResource_);
+      DecorativeImage image = new DecorativeImage(gripperImageResource_);
       initWidget(image);
       setStylePrimaryName(RESOURCES.styles().resizeGripper());
       

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -399,6 +399,7 @@ private final native String getMimeTypeInternal() /*-{
       MIME_TYPES.put( "rout",  "text/plain");
       MIME_TYPES.put( "po",    "text/plain");
       MIME_TYPES.put( "pot",   "text/plain");
+      MIME_TYPES.put( "rst",   "text/plain");
       MIME_TYPES.put( "gitignore",   "text/plain");
       MIME_TYPES.put( "rbuildignore","text/plain");
       MIME_TYPES.put( "rprofile", "text/x-r-source");

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -399,6 +399,7 @@ private final native String getMimeTypeInternal() /*-{
       MIME_TYPES.put( "rout",  "text/plain");
       MIME_TYPES.put( "po",    "text/plain");
       MIME_TYPES.put( "pot",   "text/plain");
+      MIME_TYPES.put( "rst",   "text/plain");
       MIME_TYPES.put( "gitignore",   "text/plain");
       MIME_TYPES.put( "rbuildignore","text/plain");
       MIME_TYPES.put( "rprofile", "text/x-r-source");

File: src/gwt/src/org/rstudio/core/client/widget/WizardNavigationPage.java
Patch:
@@ -40,8 +40,7 @@ public WizardNavigationPage(String title,
            image,
            largeImage,
            pages,
-           WizardPageSelector::new
-      );
+           pages1 -> new WizardPageSelector<I, T>(pages1));
    }
 
    public WizardNavigationPage(String title,

File: src/gwt/src/org/rstudio/core/client/widget/WizardNavigationPage.java
Patch:
@@ -40,8 +40,7 @@ public WizardNavigationPage(String title,
            image,
            largeImage,
            pages,
-           WizardPageSelector::new
-      );
+           pages1 -> new WizardPageSelector<I, T>(pages1));
    }
 
    public WizardNavigationPage(String title,

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/CRANMirror.java
Patch:
@@ -68,7 +68,7 @@ public final native void setURL(String url) /*-{
       this.url = url;
    }-*/;
 
-   private final native String getSecondary() /*-{
+   public final native String getSecondary() /*-{
       return this.secondary;
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellDisplay.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShellDisplay.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -49,6 +49,7 @@ public interface ShellDisplay extends ShellOutputWriter,
 
    int getMaxOutputLines();
    void setMaxOutputLines(int maxLines);
+   void setTextInputAriaLabel(String label);
 
    HandlerRegistration addCapturingKeyDownHandler(KeyDownHandler handler);
    HandlerRegistration addCapturingKeyUpHandler(KeyUpHandler handler);

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -50,6 +50,7 @@ public IgnoreDialog()
       editor_ = new AceEditor();
       editor_.setUseWrapMode(false);
       editor_.setShowLineNumbers(false);
+      editor_.setTextInputAriaLabel("Ignored files");
       
       ignoresCaption_ = new CaptionWithHelp("Ignore:",
                                              "Specifying ignored files",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -152,8 +152,9 @@ protected Widget createMainWidget()
       // is entered.
       syncSecondaryToolbar();
 
-      shell_ = consoleProvider_.get() ;
-      return (Widget) shell_.getDisplay() ;
+      shell_ = consoleProvider_.get();
+      shell_.getDisplay().setTextInputAriaLabel("Console");
+      return (Widget) shell_.getDisplay();
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/edit/ui/EditDialog.java
Patch:
@@ -56,6 +56,7 @@ public EditDialog(String caption,
       super(role);
       editor_ = new AceEditor();
       setText(caption);
+      editor_.setTextInputAriaLabel(caption);
       sourceText_ = text;
       isRCode_ = isRCode;
       lineWrapping_ = lineWrapping;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -34,7 +34,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.json.client.JSONString;
 import com.google.gwt.json.client.JSONValue;
-import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.Event;
 import com.google.gwt.user.client.Event.NativePreviewEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -454,4 +454,5 @@ void highlightDebugLocation(
    void goToLineEnd();
    
    void toggleTokenInfo();
+   void setTextInputAriaLabel(String label);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -226,6 +226,8 @@ public void onFocus(FocusEvent event)
          }
       });
 
+      editor_.setTextInputAriaLabel("Text editor");
+
       initWidget(panel_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellDisplay.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShellDisplay.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -49,6 +49,7 @@ public interface ShellDisplay extends ShellOutputWriter,
 
    int getMaxOutputLines();
    void setMaxOutputLines(int maxLines);
+   void setTextInputAriaLabel(String label);
 
    HandlerRegistration addCapturingKeyDownHandler(KeyDownHandler handler);
    HandlerRegistration addCapturingKeyUpHandler(KeyUpHandler handler);

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -50,6 +50,7 @@ public IgnoreDialog()
       editor_ = new AceEditor();
       editor_.setUseWrapMode(false);
       editor_.setShowLineNumbers(false);
+      editor_.setTextInputAriaLabel("Ignored files");
       
       ignoresCaption_ = new CaptionWithHelp("Ignore:",
                                              "Specifying ignored files",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -152,8 +152,9 @@ protected Widget createMainWidget()
       // is entered.
       syncSecondaryToolbar();
 
-      shell_ = consoleProvider_.get() ;
-      return (Widget) shell_.getDisplay() ;
+      shell_ = consoleProvider_.get();
+      shell_.getDisplay().setTextInputAriaLabel("Console");
+      return (Widget) shell_.getDisplay();
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/edit/ui/EditDialog.java
Patch:
@@ -56,6 +56,7 @@ public EditDialog(String caption,
       super(role);
       editor_ = new AceEditor();
       setText(caption);
+      editor_.setTextInputAriaLabel(caption);
       sourceText_ = text;
       isRCode_ = isRCode;
       lineWrapping_ = lineWrapping;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -34,7 +34,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.json.client.JSONString;
 import com.google.gwt.json.client.JSONValue;
-import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.Event;
 import com.google.gwt.user.client.Event.NativePreviewEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -454,4 +454,5 @@ void highlightDebugLocation(
    void goToLineEnd();
    
    void toggleTokenInfo();
+   void setTextInputAriaLabel(String label);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -226,6 +226,8 @@ public void onFocus(FocusEvent event)
          }
       });
 
+      editor_.setTextInputAriaLabel("Text editor");
+
       initWidget(panel_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/model/UnsavedChangesTarget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * UnsavedChangesTarget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,12 +14,12 @@
  */
 package org.rstudio.studio.client.workbench.model;
 
-import com.google.gwt.resources.client.ImageResource;
+import org.rstudio.studio.client.common.filetypes.FileIcon;
 
 public interface UnsavedChangesTarget
 {
    String getId();
-   ImageResource getIcon();
+   FileIcon getIcon();
    String getTitle();
    String getPath();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceShim.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SourceShim.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -19,7 +19,6 @@
 
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.shared.HandlerRegistration;
-import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.ui.*;
 import com.google.inject.Inject;
@@ -37,6 +36,7 @@
 import org.rstudio.core.client.layout.RequiresVisibilityChanged;
 import org.rstudio.core.client.widget.BeforeShowCallback;
 import org.rstudio.studio.client.application.events.EventBus;
+import org.rstudio.studio.client.common.filetypes.FileIcon;
 import org.rstudio.studio.client.common.filetypes.events.OpenPresentationSourceFileEvent;
 import org.rstudio.studio.client.common.filetypes.events.OpenPresentationSourceFileHandler;
 import org.rstudio.studio.client.common.filetypes.events.OpenSourceFileEvent;
@@ -226,7 +226,7 @@ public SourceShim(AsyncSource asyncSource,
 
       events.fireEvent(new DocTabsChangedEvent(null,
                                                new String[0],
-                                               new ImageResource[0],
+                                               new FileIcon[0],
                                                new String[0],
                                                new String[0]));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * EditingTarget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,7 +15,6 @@
 package org.rstudio.studio.client.workbench.views.source.editors;
 
 import com.google.gwt.event.logical.shared.HasCloseHandlers;
-import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.ui.HasValue;
 import com.google.gwt.user.client.ui.IsWidget;
@@ -26,6 +25,7 @@
 import org.rstudio.core.client.events.HasEnsureVisibleHandlers;
 import org.rstudio.core.client.files.FileSystemContext;
 import org.rstudio.studio.client.common.ReadOnlyValue;
+import org.rstudio.studio.client.common.filetypes.FileIcon;
 import org.rstudio.studio.client.common.filetypes.FileType;
 import org.rstudio.studio.client.common.filetypes.TextFileType;
 import org.rstudio.studio.client.workbench.model.UnsavedChangesTarget;
@@ -51,7 +51,7 @@ public interface EditingTarget extends IsWidget,
    String getTitle();
    String getPath();
    String getContext();
-   ImageResource getIcon();
+   FileIcon getIcon();
    String getTabTooltip();
    
    FileType getFileType();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -30,7 +30,6 @@
 import com.google.gwt.event.shared.HandlerManager;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.http.client.URL;
-import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.safehtml.shared.SafeHtmlBuilder;
 import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.Event;
@@ -74,6 +73,7 @@
 import org.rstudio.studio.client.common.debugging.model.Breakpoint;
 import org.rstudio.studio.client.common.dependencies.DependencyManager;
 import org.rstudio.studio.client.common.filetypes.DocumentMode;
+import org.rstudio.studio.client.common.filetypes.FileIcon;
 import org.rstudio.studio.client.common.filetypes.FileType;
 import org.rstudio.studio.client.common.filetypes.FileTypeCommands;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
@@ -2832,9 +2832,9 @@ public String getContext()
       return null;
    }
 
-   public ImageResource getIcon()
+   public FileIcon getIcon()
    {
-      return fileType_.getDefaultIcon();
+      return fileType_.getDefaultFileIcon();
    }
 
    public String getTabTooltip()

File: src/gwt/src/org/rstudio/core/client/theme/ModuleTabLayoutPanel.java
Patch:
@@ -66,6 +66,7 @@ public ModuleTab(String title, ThemeStyles styles, boolean canClose, boolean min
             closeButton_ = new Image(new ImageResource2x(ThemeResources.INSTANCE.closeTab2x()));
             closeButton_.setStylePrimaryName(styles.closeTabButton());
             closeButton_.addStyleName(ThemeStyles.INSTANCE.handCursor());
+            closeButton_.setAltText("Close " + title + " tab");
             center.add(closeButton_);
          }
          layoutPanel_.add(center);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/findreplace/FindReplaceBar.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FindReplaceBar.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text.findreplace;
 
+import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.event.dom.client.*;
 import com.google.gwt.resources.client.ClientBundle;
@@ -148,6 +149,7 @@ public FindReplaceBar(boolean showReplace, final boolean defaultForward)
       btnClose_.setStyleName(RES.styles().closeButton());
       btnClose_.addStyleName(ThemeStyles.INSTANCE.closeTabButton());
       btnClose_.addStyleName(ThemeStyles.INSTANCE.handCursor());
+      Roles.getButtonRole().setAriaLabelProperty(btnClose_.getElement(), "Close find and replace");
       btnClose_.getElement().appendChild(
             new Image(new ImageResource2x(ThemeResources.INSTANCE.closeTab2x())).getElement());
 

File: src/gwt/src/org/rstudio/core/client/theme/ModuleTabLayoutPanel.java
Patch:
@@ -66,6 +66,7 @@ public ModuleTab(String title, ThemeStyles styles, boolean canClose, boolean min
             closeButton_ = new Image(new ImageResource2x(ThemeResources.INSTANCE.closeTab2x()));
             closeButton_.setStylePrimaryName(styles.closeTabButton());
             closeButton_.addStyleName(ThemeStyles.INSTANCE.handCursor());
+            closeButton_.setAltText("Close " + title + " tab");
             center.add(closeButton_);
          }
          layoutPanel_.add(center);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/findreplace/FindReplaceBar.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FindReplaceBar.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text.findreplace;
 
+import com.google.gwt.aria.client.Roles;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.event.dom.client.*;
 import com.google.gwt.resources.client.ClientBundle;
@@ -148,6 +149,7 @@ public FindReplaceBar(boolean showReplace, final boolean defaultForward)
       btnClose_.setStyleName(RES.styles().closeButton());
       btnClose_.addStyleName(ThemeStyles.INSTANCE.closeTabButton());
       btnClose_.addStyleName(ThemeStyles.INSTANCE.handCursor());
+      Roles.getButtonRole().setAriaLabelProperty(btnClose_.getElement(), "Close find and replace");
       btnClose_.getElement().appendChild(
             new Image(new ImageResource2x(ThemeResources.INSTANCE.closeTab2x())).getElement());
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilePathToolbar.java
Patch:
@@ -27,6 +27,7 @@
 import org.rstudio.core.client.files.PosixFileSystemContext;
 import org.rstudio.core.client.files.filedialog.PathBreadcrumbWidget;
 import org.rstudio.core.client.theme.res.ThemeStyles;
+import org.rstudio.core.client.widget.CheckBoxHiddenLabel;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.filetypes.FileIcon;
@@ -115,7 +116,7 @@ public FilePathToolbar(Files.Display.NavigationObserver navigationObserver, bool
       navigationObserver_ = navigationObserver;
       
       // select all check box
-      CheckBox selectAllCheckBox = new CheckBox();
+      CheckBoxHiddenLabel selectAllCheckBox = new CheckBoxHiddenLabel("Select all files");
       selectAllCheckBox.addStyleDependentName("FilesSelectAll");
       selectAllCheckBox.addValueChangeHandler(new ValueChangeHandler<Boolean>(){
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -157,7 +157,7 @@ public FileIcon getValue(FileSystemItem object)
          };
       iconColumn.setSortable(true);
       filesDataGrid_.addColumn(iconColumn, 
-                                SafeHtmlUtils.fromSafeConstant("<br/>"));
+            SafeHtmlUtils.fromSafeConstant("<span aria-label=\"File Type\"><br/></span>"));
       filesDataGrid_.setColumnWidth(iconColumn, ICON_COLUMN_WIDTH_PIXELS, Unit.PX);
     
       sortHandler_.setComparator(iconColumn, new FilesListComparator() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilePathToolbar.java
Patch:
@@ -27,6 +27,7 @@
 import org.rstudio.core.client.files.PosixFileSystemContext;
 import org.rstudio.core.client.files.filedialog.PathBreadcrumbWidget;
 import org.rstudio.core.client.theme.res.ThemeStyles;
+import org.rstudio.core.client.widget.CheckBoxHiddenLabel;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.filetypes.FileIcon;
@@ -115,7 +116,7 @@ public FilePathToolbar(Files.Display.NavigationObserver navigationObserver, bool
       navigationObserver_ = navigationObserver;
       
       // select all check box
-      CheckBox selectAllCheckBox = new CheckBox();
+      CheckBoxHiddenLabel selectAllCheckBox = new CheckBoxHiddenLabel("Select all files");
       selectAllCheckBox.addStyleDependentName("FilesSelectAll");
       selectAllCheckBox.addValueChangeHandler(new ValueChangeHandler<Boolean>(){
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -157,7 +157,7 @@ public FileIcon getValue(FileSystemItem object)
          };
       iconColumn.setSortable(true);
       filesDataGrid_.addColumn(iconColumn, 
-                                SafeHtmlUtils.fromSafeConstant("<br/>"));
+            SafeHtmlUtils.fromSafeConstant("<span aria-label=\"File Type\"><br/></span>"));
       filesDataGrid_.setColumnWidth(iconColumn, ICON_COLUMN_WIDTH_PIXELS, Unit.PX);
     
       sortHandler_.setComparator(iconColumn, new FilesListComparator() {

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedModuleTabLayoutPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * MinimizedModuleTabLayoutPanel.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -50,7 +50,7 @@ public void setTabs(String[] tabNames)
          if (tabName == null)
             continue;
          ModuleTabLayoutPanel.ModuleTab tab
-               = new ModuleTabLayoutPanel.ModuleTab(tabName, styles, false);
+               = new ModuleTabLayoutPanel.ModuleTab(tabName, styles, false, true /*minimized*/);
          tab.addStyleName("gwt-TabLayoutPanelTab");
          final Integer thisIndex = i;
          tab.addClickHandler(new ClickHandler()

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedModuleTabLayoutPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * MinimizedModuleTabLayoutPanel.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -50,7 +50,7 @@ public void setTabs(String[] tabNames)
          if (tabName == null)
             continue;
          ModuleTabLayoutPanel.ModuleTab tab
-               = new ModuleTabLayoutPanel.ModuleTab(tabName, styles, false);
+               = new ModuleTabLayoutPanel.ModuleTab(tabName, styles, false, true /*minimized*/);
          tab.addStyleName("gwt-TabLayoutPanelTab");
          final Integer thisIndex = i;
          tab.addClickHandler(new ClickHandler()

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ThemeStyles.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -52,6 +52,7 @@ public interface ThemeStyles extends CssResource
 
    String fixedWidthFont();
    
+   String visuallyHidden();
    String tabLayout();
    String tabLayoutLeft();
    String rstheme_tabLayoutCenter();

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -354,7 +354,7 @@ public void onClick(ClickEvent event)
          }
       });
       
-      filterWidget_ = new SearchWidget(new SuggestOracle() {
+      filterWidget_ = new SearchWidget("Filter keyboard shortcuts", new SuggestOracle() {
 
          @Override
          public void requestSuggestions(Request request, Callback callback)

File: src/gwt/src/org/rstudio/core/client/widget/SelectWidget.java
Patch:
@@ -90,7 +90,7 @@ public SelectWidget(String label,
       if (horizontalLayout)
       {
          horizontalPanel_ = new HorizontalPanel();
-         label_ = new FormLabel(label);
+         label_ = new FormLabel(label, listBox_);
          if (listOnLeft)
          {
             horizontalPanel_.add(listBox_);
@@ -109,13 +109,12 @@ public SelectWidget(String label,
       }
       else
       {
-         label_ = new FormLabel(label, true);
+         label_ = new FormLabel(label, listBox_, true);
          flowPanel_ = new FlowPanel();
          flowPanel_.add(label_);
          panel = flowPanel_;
          panel.add(listBox_);
       }
-      label_.setFor(listBox_);
       
       initWidget(panel);
       

File: src/gwt/src/org/rstudio/core/client/widget/TextBoxWithButton.java
Patch:
@@ -77,7 +77,7 @@ public TextBoxWithButton(String label,
       FlowPanel outer = new FlowPanel();
       if (label != null)
       {
-         FormLabel lblCaption = new FormLabel(label, true);
+         FormLabel lblCaption = new FormLabel(label, textBox_, true);
          if (helpButton != null)
          {
             HorizontalPanel panel = new HorizontalPanel();
@@ -90,7 +90,6 @@ public TextBoxWithButton(String label,
          {
             outer.add(lblCaption);
          }
-         lblCaption.setFor(textBox_);
       }
       outer.add(inner_);
       initWidget(outer);

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -58,8 +58,7 @@ public TextEntryModalDialog(String title,
       }
       textBox_.setWidth("100%");
       DomUtils.disableAutoBehavior(textBox_);
-      captionLabel_ = new FormLabel(caption);
-      captionLabel_.setFor(textBox_);
+      captionLabel_ = new FormLabel(caption, textBox_);
 
       extraOption_ = new CheckBox(StringUtil.notNull(extraOptionPrompt));
       extraOption_.setVisible(

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -18,7 +18,6 @@
 import com.google.gwt.aria.client.Roles;
 import com.google.gwt.dom.client.Element;
 import com.google.gwt.user.client.ui.Anchor;
-import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.model.ProductEditionInfo;
 import org.rstudio.studio.client.application.model.ProductInfo;
@@ -63,7 +62,6 @@ public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo)
       productInfo.getElement().setId("productinfo");
       gplLinkLabel.getElement().setId("gplLinkLabel");
       Roles.getLinkRole().setAriaDescribedbyProperty(gplLink.getElement(), Id.of(gplLinkLabel.getElement()));
-      DomUtils.visuallyHide(gplLinkLabel.getElement());
 
       userAgentLabel.setText(
             Window.Navigator.getUserAgent());

File: src/gwt/src/org/rstudio/studio/client/application/ui/addins/AddinsToolbarButton.java
Patch:
@@ -100,7 +100,7 @@ public void onAttachOrDetach(AttachEvent event)
          }
       });
       
-      searchWidget_ = new SearchWidget();
+      searchWidget_ = new SearchWidget("Search for addins");
       searchValueChangeTimer_ = new Timer()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -75,7 +75,7 @@ public void onClick(ClickEvent event)
       colsSeparator_.setVisible(false);
       addColumnControls(toolbar);
 
-      searchWidget_ = new SearchWidget(new SuggestOracle() {
+      searchWidget_ = new SearchWidget("Search data table", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdTemplateChooser.java
Patch:
@@ -145,7 +145,7 @@ public DirectoryChooserTextBox makeDirectoryChooserTextbox()
    public CaptionWithHelp makeHelpCaption()
    {
       return new CaptionWithHelp("Template:", "Using R Markdown Templates",
-                                 "using_rmarkdown_templates");
+                                 "using_rmarkdown_templates", null);
    }
    
    @UiFactory

File: src/gwt/src/org/rstudio/studio/client/workbench/BrowseAddinsDialog.java
Patch:
@@ -71,7 +71,7 @@ public BrowseAddinsDialog(OperationWithInput<Command> operation)
       
       setOkButtonCaption("Execute");
       
-      filterWidget_ = new FilterWidget()
+      filterWidget_ = new FilterWidget("Filter by addin name")
       {
          @Override
          public void filter(String query)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -337,7 +337,7 @@ protected Toolbar createMainToolbar()
    {
       toolbar_ = new Toolbar();
    
-      searchWidget_ = new SearchWidget(new SuggestOracle() {
+      searchWidget_ = new SearchWidget("Filter by connection", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {
@@ -348,7 +348,7 @@ public void requestSuggestions(Request request, Callback callback)
          }
       });
 
-      objectSearchWidget_ = new SearchWidget(new SuggestOracle() {
+      objectSearchWidget_ = new SearchWidget("Filter by object", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -175,7 +175,7 @@ protected SecondaryToolbar createSecondaryToolbar()
       ThemeStyles styles = ThemeStyles.INSTANCE;
       toolbar.getWrapper().addStyleName(styles.tallerToolbarWrapper());
       
-      SearchWidget searchWidget = new SearchWidget(new SuggestOracle() {
+      SearchWidget searchWidget = new SearchWidget("Search environment", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/search/HelpSearchWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HelpSearchWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -27,7 +27,7 @@ public class HelpSearchWidget extends SearchWidget
    @Inject
    public HelpSearchWidget(HelpSearchOracle oracle)
    {
-      super(oracle);
+      super("Search help", oracle);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HistoryPane.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -564,7 +564,7 @@ public HandlerRegistration addFetchCommandsHandler(FetchCommandsHandler handler)
    @Override
    protected Toolbar createMainToolbar()
    {
-      searchWidget_ = new SearchWidget(new SuggestOracle()
+      searchWidget_ = new SearchWidget("Filter command history", new SuggestOracle()
       {
          @Override
          public void requestSuggestions(Request request,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -214,7 +214,7 @@ protected Toolbar createMainToolbar()
       toolbar.addLeftWidget(packratMenuButton_);
       packratMenuButton_.setVisible(false);
             
-      searchWidget_ = new SearchWidget(new SuggestOracle() {
+      searchWidget_ = new SearchWidget("Filter by package name", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/TabOverflowPopupPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TabOverflowPopupPanel.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -115,7 +115,7 @@ public TabOverflowPopupPanel()
 
       DockPanel dockPanel = new DockPanel();
 
-      search_ = new SearchWidget(new DocsOracle());
+      search_ = new SearchWidget("Search tabs", new DocsOracle());
       search_.addValueChangeHandler(this);
 
       search_.getElement().getStyle().setMarginRight(0, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/view/ObjectExplorerEditingTargetWidget.java
Patch:
@@ -74,7 +74,7 @@ public void onClick(ClickEvent event)
                }
             });
       
-      filterWidget_ = new SearchWidget(new SuggestOracle()
+      filterWidget_ = new SearchWidget("Search objects", new SuggestOracle()
       {
          @Override
          public void requestSuggestions(Request request, Callback callback)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/ChunkOptionsPopupPanel.java
Patch:
@@ -26,6 +26,7 @@
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.DomUtils.NativeEventHandler;
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.widget.FormLabel;
 import org.rstudio.core.client.widget.MiniPopupPanel;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.ProgressOperationWithInput;
@@ -161,7 +162,7 @@ public void onKeyUp(KeyUpEvent event)
       int gridRows = includeChunkNameUI ? 2 : 1;
       Grid nameAndOutputGrid = new Grid(gridRows, 2);
 
-      chunkLabel_ = new Label("Name:");
+      chunkLabel_ = new FormLabel("Chunk Name:", tbChunkLabel_);
       chunkLabel_.addStyleName(RES.styles().chunkLabel());
       
       if (includeChunkNameUI)
@@ -660,7 +661,7 @@ else if (lhsGroup > rhsGroup)
    
    protected final VerticalPanel panel_;
    protected final Label header_;
-   protected final Label chunkLabel_;
+   protected final FormLabel chunkLabel_;
    protected final TextBoxWithCue tbChunkLabel_;
    protected final ListBox outputComboBox_;
    protected final Grid figureDimensionsPanel_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/BranchToolbarButton.java
Patch:
@@ -155,7 +155,7 @@ public void execute()
          }
       });
       
-      searchWidget_ = new SearchWidget();
+      searchWidget_ = new SearchWidget("Search by branch name");
       
       searchValueChangeTimer_ = new Timer()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/CreateBranchDialog.java
Patch:
@@ -173,8 +173,7 @@ public boolean test(RemotesInfo info)
       
       LayoutGrid ctrBranch = new LayoutGrid(1, 2);
       ctrBranch.setWidth("100%");
-      FormLabel branchLabel = new FormLabel("Branch Name:");
-      branchLabel.setFor(tbBranch_);
+      FormLabel branchLabel = new FormLabel("Branch Name:", tbBranch_);
       ctrBranch.setWidget(0, 0, branchLabel);
       ctrBranch.setWidget(0, 1, tbBranch_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/HistoryPanel.java
Patch:
@@ -123,7 +123,8 @@ protected HistoryPanel(HistoryBranchToolbarButton branchToolbarButton,
                                  (ClickHandler) null);
       topToolbar_.addLeftWidget(refreshButton_); 
       
-      searchText_ = new SearchWidget(new MultiWordSuggestOracle(),
+      searchText_ = new SearchWidget("Search version control history", 
+                                     new MultiWordSuggestOracle(),
                                      new TextBoxWithCue("Search"),
                                      null);
       topToolbar_.addRightWidget(searchText_);

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ThemeStyles.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -52,6 +52,7 @@ public interface ThemeStyles extends CssResource
 
    String fixedWidthFont();
    
+   String visuallyHidden();
    String tabLayout();
    String tabLayoutLeft();
    String rstheme_tabLayoutCenter();

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -354,7 +354,7 @@ public void onClick(ClickEvent event)
          }
       });
       
-      filterWidget_ = new SearchWidget(new SuggestOracle() {
+      filterWidget_ = new SearchWidget("Filter keyboard shortcuts", new SuggestOracle() {
 
          @Override
          public void requestSuggestions(Request request, Callback callback)

File: src/gwt/src/org/rstudio/core/client/widget/SelectWidget.java
Patch:
@@ -90,7 +90,7 @@ public SelectWidget(String label,
       if (horizontalLayout)
       {
          horizontalPanel_ = new HorizontalPanel();
-         label_ = new FormLabel(label);
+         label_ = new FormLabel(label, listBox_);
          if (listOnLeft)
          {
             horizontalPanel_.add(listBox_);
@@ -109,13 +109,12 @@ public SelectWidget(String label,
       }
       else
       {
-         label_ = new FormLabel(label, true);
+         label_ = new FormLabel(label, listBox_, true);
          flowPanel_ = new FlowPanel();
          flowPanel_.add(label_);
          panel = flowPanel_;
          panel.add(listBox_);
       }
-      label_.setFor(listBox_);
       
       initWidget(panel);
       

File: src/gwt/src/org/rstudio/core/client/widget/TextBoxWithButton.java
Patch:
@@ -77,7 +77,7 @@ public TextBoxWithButton(String label,
       FlowPanel outer = new FlowPanel();
       if (label != null)
       {
-         FormLabel lblCaption = new FormLabel(label, true);
+         FormLabel lblCaption = new FormLabel(label, textBox_, true);
          if (helpButton != null)
          {
             HorizontalPanel panel = new HorizontalPanel();
@@ -90,7 +90,6 @@ public TextBoxWithButton(String label,
          {
             outer.add(lblCaption);
          }
-         lblCaption.setFor(textBox_);
       }
       outer.add(inner_);
       initWidget(outer);

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -58,8 +58,7 @@ public TextEntryModalDialog(String title,
       }
       textBox_.setWidth("100%");
       DomUtils.disableAutoBehavior(textBox_);
-      captionLabel_ = new FormLabel(caption);
-      captionLabel_.setFor(textBox_);
+      captionLabel_ = new FormLabel(caption, textBox_);
 
       extraOption_ = new CheckBox(StringUtil.notNull(extraOptionPrompt));
       extraOption_.setVisible(

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -18,7 +18,6 @@
 import com.google.gwt.aria.client.Roles;
 import com.google.gwt.dom.client.Element;
 import com.google.gwt.user.client.ui.Anchor;
-import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.model.ProductEditionInfo;
 import org.rstudio.studio.client.application.model.ProductInfo;
@@ -63,7 +62,6 @@ public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo)
       productInfo.getElement().setId("productinfo");
       gplLinkLabel.getElement().setId("gplLinkLabel");
       Roles.getLinkRole().setAriaDescribedbyProperty(gplLink.getElement(), Id.of(gplLinkLabel.getElement()));
-      DomUtils.visuallyHide(gplLinkLabel.getElement());
 
       userAgentLabel.setText(
             Window.Navigator.getUserAgent());

File: src/gwt/src/org/rstudio/studio/client/application/ui/addins/AddinsToolbarButton.java
Patch:
@@ -100,7 +100,7 @@ public void onAttachOrDetach(AttachEvent event)
          }
       });
       
-      searchWidget_ = new SearchWidget();
+      searchWidget_ = new SearchWidget("Search for addins");
       searchValueChangeTimer_ = new Timer()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataTable.java
Patch:
@@ -75,7 +75,7 @@ public void onClick(ClickEvent event)
       colsSeparator_.setVisible(false);
       addColumnControls(toolbar);
 
-      searchWidget_ = new SearchWidget(new SuggestOracle() {
+      searchWidget_ = new SearchWidget("Search data table", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdTemplateChooser.java
Patch:
@@ -145,7 +145,7 @@ public DirectoryChooserTextBox makeDirectoryChooserTextbox()
    public CaptionWithHelp makeHelpCaption()
    {
       return new CaptionWithHelp("Template:", "Using R Markdown Templates",
-                                 "using_rmarkdown_templates");
+                                 "using_rmarkdown_templates", null);
    }
    
    @UiFactory

File: src/gwt/src/org/rstudio/studio/client/workbench/BrowseAddinsDialog.java
Patch:
@@ -71,7 +71,7 @@ public BrowseAddinsDialog(OperationWithInput<Command> operation)
       
       setOkButtonCaption("Execute");
       
-      filterWidget_ = new FilterWidget()
+      filterWidget_ = new FilterWidget("Filter by addin name")
       {
          @Override
          public void filter(String query)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -337,7 +337,7 @@ protected Toolbar createMainToolbar()
    {
       toolbar_ = new Toolbar();
    
-      searchWidget_ = new SearchWidget(new SuggestOracle() {
+      searchWidget_ = new SearchWidget("Filter by connection", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {
@@ -348,7 +348,7 @@ public void requestSuggestions(Request request, Callback callback)
          }
       });
 
-      objectSearchWidget_ = new SearchWidget(new SuggestOracle() {
+      objectSearchWidget_ = new SearchWidget("Filter by object", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -175,7 +175,7 @@ protected SecondaryToolbar createSecondaryToolbar()
       ThemeStyles styles = ThemeStyles.INSTANCE;
       toolbar.getWrapper().addStyleName(styles.tallerToolbarWrapper());
       
-      SearchWidget searchWidget = new SearchWidget(new SuggestOracle() {
+      SearchWidget searchWidget = new SearchWidget("Search environment", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/search/HelpSearchWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HelpSearchWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -27,7 +27,7 @@ public class HelpSearchWidget extends SearchWidget
    @Inject
    public HelpSearchWidget(HelpSearchOracle oracle)
    {
-      super(oracle);
+      super("Search help", oracle);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HistoryPane.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -564,7 +564,7 @@ public HandlerRegistration addFetchCommandsHandler(FetchCommandsHandler handler)
    @Override
    protected Toolbar createMainToolbar()
    {
-      searchWidget_ = new SearchWidget(new SuggestOracle()
+      searchWidget_ = new SearchWidget("Filter command history", new SuggestOracle()
       {
          @Override
          public void requestSuggestions(Request request,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -214,7 +214,7 @@ protected Toolbar createMainToolbar()
       toolbar.addLeftWidget(packratMenuButton_);
       packratMenuButton_.setVisible(false);
             
-      searchWidget_ = new SearchWidget(new SuggestOracle() {
+      searchWidget_ = new SearchWidget("Filter by package name", new SuggestOracle() {
          @Override
          public void requestSuggestions(Request request, Callback callback)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/TabOverflowPopupPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TabOverflowPopupPanel.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -115,7 +115,7 @@ public TabOverflowPopupPanel()
 
       DockPanel dockPanel = new DockPanel();
 
-      search_ = new SearchWidget(new DocsOracle());
+      search_ = new SearchWidget("Search tabs", new DocsOracle());
       search_.addValueChangeHandler(this);
 
       search_.getElement().getStyle().setMarginRight(0, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/view/ObjectExplorerEditingTargetWidget.java
Patch:
@@ -74,7 +74,7 @@ public void onClick(ClickEvent event)
                }
             });
       
-      filterWidget_ = new SearchWidget(new SuggestOracle()
+      filterWidget_ = new SearchWidget("Search objects", new SuggestOracle()
       {
          @Override
          public void requestSuggestions(Request request, Callback callback)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/ChunkOptionsPopupPanel.java
Patch:
@@ -26,6 +26,7 @@
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.DomUtils.NativeEventHandler;
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.widget.FormLabel;
 import org.rstudio.core.client.widget.MiniPopupPanel;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.ProgressOperationWithInput;
@@ -161,7 +162,7 @@ public void onKeyUp(KeyUpEvent event)
       int gridRows = includeChunkNameUI ? 2 : 1;
       Grid nameAndOutputGrid = new Grid(gridRows, 2);
 
-      chunkLabel_ = new Label("Name:");
+      chunkLabel_ = new FormLabel("Chunk Name:", tbChunkLabel_);
       chunkLabel_.addStyleName(RES.styles().chunkLabel());
       
       if (includeChunkNameUI)
@@ -660,7 +661,7 @@ else if (lhsGroup > rhsGroup)
    
    protected final VerticalPanel panel_;
    protected final Label header_;
-   protected final Label chunkLabel_;
+   protected final FormLabel chunkLabel_;
    protected final TextBoxWithCue tbChunkLabel_;
    protected final ListBox outputComboBox_;
    protected final Grid figureDimensionsPanel_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/BranchToolbarButton.java
Patch:
@@ -155,7 +155,7 @@ public void execute()
          }
       });
       
-      searchWidget_ = new SearchWidget();
+      searchWidget_ = new SearchWidget("Search by branch name");
       
       searchValueChangeTimer_ = new Timer()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/CreateBranchDialog.java
Patch:
@@ -173,8 +173,7 @@ public boolean test(RemotesInfo info)
       
       LayoutGrid ctrBranch = new LayoutGrid(1, 2);
       ctrBranch.setWidth("100%");
-      FormLabel branchLabel = new FormLabel("Branch Name:");
-      branchLabel.setFor(tbBranch_);
+      FormLabel branchLabel = new FormLabel("Branch Name:", tbBranch_);
       ctrBranch.setWidget(0, 0, branchLabel);
       ctrBranch.setWidget(0, 1, tbBranch_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/HistoryPanel.java
Patch:
@@ -123,7 +123,8 @@ protected HistoryPanel(HistoryBranchToolbarButton branchToolbarButton,
                                  (ClickHandler) null);
       topToolbar_.addLeftWidget(refreshButton_); 
       
-      searchText_ = new SearchWidget(new MultiWordSuggestOracle(),
+      searchText_ = new SearchWidget("Search version control history", 
+                                     new MultiWordSuggestOracle(),
                                      new TextBoxWithCue("Search"),
                                      null);
       topToolbar_.addRightWidget(searchText_);

File: src/gwt/src/org/rstudio/core/client/dom/DomUtils.java
Patch:
@@ -1134,7 +1134,7 @@ public static void disableSpellcheck(Widget w)
     */
    public static void setPlaceholder(Element ele, String placeholder)
    {
-      ele.setAttribute("placeholder", "Name");
+      ele.setAttribute("placeholder", placeholder);
    }
 
    /**

File: src/gwt/src/com/google/gwt/user/client/ui/LabelBase.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.gwt.dom.client.Style.WhiteSpace;
 import com.google.gwt.i18n.shared.DirectionEstimator;
 import com.google.gwt.i18n.shared.HasDirectionEstimator;
+import org.rstudio.core.client.StringUtil;
 
 /**
  * Abstract base class for all text display widgets.
@@ -62,7 +63,8 @@ protected LabelBase(boolean inline, String forId) {
     setElement(Document.get().createLabelElement());
     if (!inline)
       getElement().getStyle().setProperty("display", "block");
-    getElement().setAttribute("for", forId);
+    if (!StringUtil.isNullOrEmpty(forId))
+      getElement().setAttribute("for", forId);
     directionalTextHelper = new DirectionalTextHelper(getElement(), inline);
   }
 

File: src/gwt/src/org/rstudio/core/client/widget/SearchWidget.java
Patch:
@@ -337,7 +337,7 @@ public String getLastValue()
    
    public void setPlaceholderText(String value)
    {
-      suggestBox_.getElement().setAttribute("placeholder", value);
+      DomUtils.setPlaceholder(suggestBox_.getElement(), value);
    }
    
    public boolean isFocused()

File: src/gwt/src/org/rstudio/core/client/widget/TextBoxWithCue.java
Patch:
@@ -50,7 +50,7 @@ public String getCueText()
    public void setCueText(String cueText)
    {
       cueText_ = cueText;
-      getElement().setAttribute("placeholder", cueText);
+      DomUtils.setPlaceholder(this, cueText);
    }
 
    private String cueText_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptionsUiXls.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DataImportOptionsUiXls.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.workbench.views.environment.dataimport;
 
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.studio.client.application.ApplicationUtils;
 import org.rstudio.studio.client.common.HelpLink;
 import org.rstudio.studio.client.workbench.views.environment.dataimport.model.DataImportAssembleResponse;
@@ -50,7 +51,7 @@ public DataImportOptionsUiXls()
       initDefaults();
       initEvents();
 
-      rangeTextBox_.getElement().setPropertyString("placeholder", "A1:D10");
+      DomUtils.setPlaceholder(rangeTextBox_, "A1:D10");
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewPlumberAPI.java
Patch:
@@ -195,7 +195,7 @@ public NewPlumberAPI(String caption,
       apiNameTextBox_ = new TextBox();
       DomUtils.disableSpellcheck(apiNameTextBox_);
       apiNameTextBox_.addStyleName(RES.styles().apiNameTextBox());
-      apiNameTextBox_.getElement().setAttribute("placeholder", "Name");
+      DomUtils.setPlaceholder(apiNameTextBox_, "Name");
       addTextFieldValidator(apiNameTextBox_);
       controls_.add(apiNameTextBox_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewShinyWebApplication.java
Patch:
@@ -202,7 +202,7 @@ public NewShinyWebApplication(String caption,
       DomUtils.disableSpellcheck(appNameTextBox_);
       appNameTextBox_.addStyleName(RES.styles().textBox());
       appNameTextBox_.addStyleName(RES.styles().appNameTextBox());
-      appNameTextBox_.getElement().setAttribute("placeholder", "Name");
+      DomUtils.setPlaceholder(appNameTextBox_, "Name");
       addTextFieldValidator(appNameTextBox_);
       
       appTypeLabel_ = new Label("Application type:");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/ChunkOptionsPopupPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ChunkOptionsPopupPanel.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -408,7 +408,7 @@ public void focus()
    private TextBox makeInputBox(final String option, final boolean enquote)
    {
       final TextBox box = new TextBox();
-      box.getElement().setAttribute("placeholder", "Default");
+      DomUtils.setPlaceholder(box, "Default");
       box.setWidth("40px");
       
       DomUtils.addKeyHandlers(box, new NativeEventHandler()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -150,7 +150,7 @@ private Column<FileSystemItem, FileIcon> addIconColumn(
             public FileIcon getValue(FileSystemItem object)
             {
                if (object == parentPath_)
-                  return FileIcon.FOLDER_ICON;
+                  return FileIcon.PARENT_FOLDER_ICON;
                else
                   return fileTypeRegistry.getIconForFile(object);
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -149,7 +149,7 @@ private Column<FileSystemItem, FileIcon> addIconColumn(
             public FileIcon getValue(FileSystemItem object)
             {
                if (object == parentPath_)
-                  return FileIcon.FOLDER_ICON;
+                  return FileIcon.PARENT_FOLDER_ICON;
                else
                   return fileTypeRegistry.getIconForFile(object);
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -149,7 +149,7 @@ private Column<FileSystemItem, FileIcon> addIconColumn(
             public FileIcon getValue(FileSystemItem object)
             {
                if (object == parentPath_)
-                  return FileIcon.FOLDER_ICON;
+                  return FileIcon.PARENT_FOLDER_ICON;
                else
                   return fileTypeRegistry.getIconForFile(object);
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -151,4 +151,6 @@ void startTerminal(ConsoleProcessInfo cpi,
                       ServerRequestCallback<ConsoleProcess> requestCallback);
    
    void executeCode(String code, ServerRequestCallback<Void> requestCallback);
+
+   void setUserCrashHandlerPrompted(boolean enableCrashHandling, ServerRequestCallback<Void> requestCallback);
 }

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogPaneBase.java
Patch:
@@ -140,11 +140,11 @@ protected Widget textBoxWithChooser(Widget widget)
       return widget;
    }
    
-   protected HorizontalPanel checkBoxWithHelp(CheckBox checkBox, String topic)
+   protected HorizontalPanel checkBoxWithHelp(CheckBox checkBox, String topic, String title)
    {
       HorizontalPanel panel = new HorizontalPanel();
       panel.add(checkBox);
-      HelpButton helpButton = new HelpButton(topic, false);
+      HelpButton helpButton = new HelpButton(topic, false, title);
       Style helpStyle = helpButton.getElement().getStyle();
       helpStyle.setMarginTop(1, Unit.PX);
       helpStyle.setMarginLeft(6, Unit.PX);

File: src/gwt/src/org/rstudio/core/client/widget/ImageFrame.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ImageFrame.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -20,9 +20,10 @@
 
 public class ImageFrame extends Frame
 {
-   public ImageFrame()
+   public ImageFrame(String title)
    {
       setUrl("javascript:false");
+      setTitle(title);
    }
 
    @Override

File: src/gwt/src/org/rstudio/core/client/widget/LocalRepositoriesWidget.java
Patch:
@@ -41,7 +41,7 @@ public LocalRepositoriesWidget()
       
       VerticalPanel panel = new VerticalPanel();
       panel.add(new LabelWithHelp("Local repositories:",
-            "packrat_local_repos"));
+            "packrat_local_repos", "Help on local Packrat repositories"));
       
       HorizontalPanel hp = new HorizontalPanel();
       listBox_ = new ListBox();

File: src/gwt/src/org/rstudio/studio/client/application/ui/RVersionSelectWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RVersionSelectWidget.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -44,7 +44,7 @@ public RVersionSelectWidget(String caption,
             false,
             fillContainer);
       if (includeHelpButton)
-         HelpButton.addHelpButton(this, "multiple_r_versions");
+         HelpButton.addHelpButton(this, "multiple_r_versions", "Help on R versions");
    }
    
    public void setRVersion(RVersionSpec version)

File: src/gwt/src/org/rstudio/studio/client/common/latex/LatexProgramSelectWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * LatexProgramSelectWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -24,7 +24,7 @@ public LatexProgramSelectWidget()
    {
       super("Typeset LaTeX into PDF using:", latexProgramRegistry_.getTypeNames());
          
-      HelpButton.addHelpButton(this, "latex_program");
+      HelpButton.addHelpButton(this, "latex_program", "Help on customizing LaTeX options");
    }
    
    

File: src/gwt/src/org/rstudio/studio/client/common/rnw/RnwWeaveSelectWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RnwWeaveSelectWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -39,7 +39,7 @@ public RnwWeaveSelectWidget()
    { 
       super("Weave Rnw files using:", rnwWeaveRegistry_.getTypeNames());
   
-      HelpButton.addHelpButton(this, "rnw_weave_method");
+      HelpButton.addHelpButton(this, "rnw_weave_method", "Help on weaving Rnw files");
       
       RStudioGinjector.INSTANCE.injectMembers(this);
       

File: src/gwt/src/org/rstudio/studio/client/common/spelling/ui/SpellingCustomDictionariesWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SpellingCustomDictionariesWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -51,7 +51,8 @@ public SpellingCustomDictionariesWidget()
       VerticalPanel panel = new VerticalPanel();
       
       panel.add(new LabelWithHelp("Custom dictionaries:", 
-                                  "custom_dictionaries"));
+                                  "custom_dictionaries",
+                                  "Help on custom spelling dictionaries"));
       
       HorizontalPanel dictionariesPanel = new HorizontalPanel();
       listBox_ = new ListBox();

File: src/gwt/src/org/rstudio/studio/client/common/spelling/ui/SpellingLanguageSelectWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SpellingLanguageSelectWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -36,7 +36,7 @@ public SpellingLanguageSelectWidget(
             true, 
             false);    
       
-      HelpButton.addHelpButton(this, "spelling_dictionaries");
+      HelpButton.addHelpButton(this, "spelling_dictionaries", "Help on spelling dictionaries");
       
       getListBox().addChangeHandler(new ChangeHandler() {
 

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -56,6 +56,8 @@ public IgnoreDialog()
       editor_.setUseWrapMode(false);
       editor_.setShowLineNumbers(false);
       
+      ignoresCaption_.setFor(editor_.getWidget());
+
       saveButton_ = new ThemedButton("Save", (ClickHandler)null); 
       addButton(saveButton_);
       addCancelButton();

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HTMLPreviewPanel.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -62,7 +62,7 @@ public HTMLPreviewPanel(Commands commands)
       layoutPanel_.setWidgetLeftRight(toolbar_, 0, Unit.PX, 0, Unit.PX);
       layoutPanel_.setWidgetTopHeight(toolbar_, 0, Unit.PX, tbHeight_, Unit.PX);
       
-      previewFrame_ = new AnchorableFrame();
+      previewFrame_ = new AnchorableFrame("HTML Preview Panel");
       previewFrame_.setSize("100%", "100%");
       layoutPanel_.add(previewFrame_);
       layoutPanel_.setWidgetLeftRight(previewFrame_,  0, Unit.PX, 0, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/plumber/ui/PlumberAPIPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PlumberAPIPanel.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -114,7 +114,7 @@ public String getAbsoluteUrl()
    @Override
    protected RStudioFrame createFrame(String url)
    {
-      return new RStudioFrame(url);
+      return new RStudioFrame("Plumber API Panel", url);
    }
 
    private Label urlBox_;

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectCompilePdfPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ProjectCompilePdfPreferencesPane.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -107,7 +107,7 @@ public RootDocumentChooser()
          super("Compile PDF root document:", 
                "(Current Document)", 
                "Browse...", 
-               new HelpButton("pdf_root_document"),
+               new HelpButton("pdf_root_document", "Get help on Compile PDF root document"),
                null);
          
          // allow user to set the value to empty string

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPackratPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ProjectPackratPreferencesPane.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -135,7 +135,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
         panelExternalPackages_.add(new LabelWithHelp(
               "External packages (comma separated):",
               "packrat_external_packages",
-              false));
+              false, "Help on external packages"));
         taExternalPackages_ = new FixedTextArea(3);
         taExternalPackages_.addStyleName(styles.externalPackages());
         taExternalPackages_.setText(

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdOutputPanel.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -226,7 +226,7 @@ private void findInTopic(String term, CanFocus findInputSource)
    @Override
    protected AnchorableFrame createFrame(String url)
    {
-      AnchorableFrame frame = new AnchorableFrame();
+      AnchorableFrame frame = new AnchorableFrame("Rmd Output Panel");
       
       // allow full screen
       Element el = frame.getElement();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdTemplateChooser.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdTemplateChooser.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -69,6 +69,7 @@ public void onChange(ChangeEvent evt)
                   item.getTemplate().getCreateDir() == "true");
          }
       });
+      captionWithHelp_.setFor(listTemplates_);
    }
    
    public void populateTemplates()
@@ -213,6 +214,7 @@ private boolean createDirectory()
    
    private final RMarkdownServerOperations server_;
    
+   @UiField CaptionWithHelp captionWithHelp_;
    @UiField WidgetListBox<RmdDiscoveredTemplateItem> listTemplates_;
    @UiField TextBox txtName_;
    @UiField DirectoryChooserTextBox dirLocation_;

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyApplicationPanel.java
Patch:
@@ -121,7 +121,7 @@ public String getAbsoluteUrl()
    @Override
    protected RStudioFrame createFrame(String url)
    {
-      return new RStudioFrame(url);
+      return new RStudioFrame("Shiny Application", url);
    }
 
    private Label urlBox_;

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyGadgetDialog.java
Patch:
@@ -83,7 +83,7 @@ protected void onUnload()
    @Override
    protected Widget createMainWidget()
    {
-      frame_ = new RStudioFrame();
+      frame_ = new RStudioFrame("Shiny Gadget");
       frame_.addStyleName(ThemeStyles.INSTANCE.borderedIFrame());
       
       // compute the widget size and set it

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AceEditorPreview.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AceEditorPreview.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -19,7 +19,6 @@
 import com.google.gwt.dom.client.Style.BorderStyle;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.resources.client.ClientBundle;
-import com.google.gwt.resources.client.CssResource;
 import com.google.gwt.resources.client.TextResource;
 
 import org.rstudio.core.client.ExternalJavaScriptLoader;
@@ -33,6 +32,7 @@ public class AceEditorPreview extends DynamicIFrame
 {
    public AceEditorPreview(String code)
    {
+      super("Editor Theme Preview");
       code_ = code;
       Style style = getStyleElement().getStyle();
       style.setBorderColor("#CCC");

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/CompilePdfPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * CompilePdfPreferencesPane.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -103,7 +103,7 @@ public PdfPreviewSelectWidget()
             true, 
             false);   
          
-         HelpButton.addHelpButton(this, "pdf_preview");
+         HelpButton.addHelpButton(this, "pdf_preview", "Help on previewing PDF files");
       }
    }
   

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * EditingPreferencesPane.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -183,7 +183,7 @@ public void onClick(ClickEvent event)
       });
       panel.add(editSnippets);
       
-      HelpButton snippetHelp = new HelpButton("code_snippets");
+      HelpButton snippetHelp = new HelpButton("code_snippets", "Help on code snippets");
       snippetHelp.getElement().getStyle().setMarginTop(2, Unit.PX);
       snippetHelp.getElement().getStyle().setMarginLeft(6, Unit.PX);
       panel.add(snippetHelp);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PackagesPreferencesPane.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -165,7 +165,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
       useSecurePackageDownload_ = new CheckBox(
             "Use secure download method for HTTP");
       HorizontalPanel secureDownloadPanel = checkBoxWithHelp(
-                        useSecurePackageDownload_, "secure_download");
+                        useSecurePackageDownload_, "secure_download", "Help on secure package downloads for R");
       lessSpaced(secureDownloadPanel);
       management.add(secureDownloadPanel);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishingPreferencesPane.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -190,7 +190,8 @@ public void execute(Boolean succeeded)
       final CheckBox chkEnableRSConnect = checkboxPref("Enable publishing to RStudio Connect",
             uiPrefs_.enableRStudioConnect());
       final HorizontalPanel rsconnectPanel = checkBoxWithHelp(chkEnableRSConnect,
-                                                              "rstudio_connect");
+                                                              "rstudio_connect",
+                                                              "Information about RStudio Connect");
       lessSpaced(rsconnectPanel);
       
       add(headerLabel("Settings"));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionShinyHost.java
Patch:
@@ -151,7 +151,7 @@ private Widget createWidget()
       VerticalPanel container = new VerticalPanel();
       
       // create iframe for miniUI
-      frame_ = new RStudioFrame();
+      frame_ = new RStudioFrame("Shiny Mini UI");
       frame_.setSize("100%", "140px");
 
       container.add(frame_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DataImport.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -104,6 +104,7 @@ public <T> DataImport(DataImportModes dataImportMode,
       dataImportResources_ = GWT.create(DataImportResources.class);
       dataImportMode_ = dataImportMode;
       
+      gridViewer_ = new GridViewerFrame("Data Import Grid Viewer");
       copyButton_ = makeCopyButton();
 
       progressIndicator_ = new ProgressIndicatorDelay(progressIndicator);
@@ -283,7 +284,7 @@ void resetColumnDefinitions()
    @UiField
    DataImportFileChooser dataImportFileChooser_;
    
-   @UiField
+   @UiField(provided=true)
    GridViewerFrame gridViewer_;
    
    @UiField

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HelpPane.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -106,6 +106,7 @@ public void onResize(ResizeEvent event)
       });
 
       frame_ = new RStudioThemedFrame(
+         "Help Pane",
          null,
          RES.editorStyles().getText(),
          null,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobQuitDialog.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * JobQuitControls.java
+ * JobQuitDialog.java
  *
  * Copyright (C) 2009-19 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/data/DataOutputPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DataOutputPane.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -38,7 +38,7 @@ public DataOutputPane()
    @Override
    protected Widget createMainWidget()
    { 
-      gridViewer_ = new GridViewerFrame(true);
+      gridViewer_ = new GridViewerFrame("Data Output Pane", true);
       return gridViewer_;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/PackageActionConfirmationDialog.java
Patch:
@@ -80,7 +80,6 @@ public void onClick(ClickEvent event)
       }));  
       
       enableOkButton(false);
-      enableCancelButton(false);
       selectAllButton_.setEnabled(false);
       selectNoneButton_.setEnabled(false);
    }
@@ -118,7 +117,7 @@ protected Widget createMainWidget()
       actionsTable_ = new CellTable<PendingAction>(
             15,
             GWT.<PackagesCellTableResources> create(PackagesCellTableResources.class));
-      actionsTable_.setKeyboardSelectionPolicy(KeyboardSelectionPolicy.DISABLED);
+      actionsTable_.setKeyboardSelectionPolicy(KeyboardSelectionPolicy.ENABLED);
       actionsTable_.setSelectionModel(new NoSelectionModel<PendingAction>());
       actionsTable_.setWidth("100%", true);
       
@@ -150,9 +149,10 @@ public void onResponseReceived(JsArray<T> actions)
                actionsDataProvider_.setList(pendingActions);
                actionsDataProvider_.addDataDisplay(actionsTable_);
                
-               enableCancelButton(true);
                selectAllButton_.setEnabled(true);
                selectNoneButton_.setEnabled(true);
+               refreshFocusableElements();
+               focusInitialControl();
             }
             else
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PlotsPane.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -113,7 +113,7 @@ protected Widget createMainWidget()
       panel_.addStyleName("ace_editor_theme");
       panel_.setSize("100%", "100%");
 
-      frame_ = new ImageFrame();
+      frame_ = new ImageFrame("Plots Pane");
       frame_.setStyleName("rstudio-HelpFrame");
       frame_.setMarginWidth(0);
       frame_.setMarginHeight(0);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/PlotsPanePreviewer.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PlotsPanePreviewer.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -54,7 +54,7 @@ public Widget getWidget()
    {
       if (imageFrame_ == null)
       {
-         imageFrame_ = new ImageFrame();
+         imageFrame_ = new ImageFrame("Plot Preview");
          imageFrame_.setUrl("about:blank");
          imageFrame_.setSize("100%", "100%");
          imageFrame_.setMarginHeight(0);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationFrame.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PresentationFrame.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -42,7 +42,7 @@ public PresentationFrame(boolean autoFocus,
                             boolean allowFullScreen,
                             final HasText titleWidget)
    {
-      super(autoFocus);
+      super("Presentation Frame", autoFocus);
       
       // allow full-screen view of iframe
       if (allowFullScreen)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTarget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DataEditingTarget.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -153,6 +153,7 @@ private void clearDisplay()
    private void reloadDisplay()
    {
       view_ = new DataEditingTargetWidget(
+            "Data Editing Target",
             commands_,
             events_,
             getDataItem());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ProfilerEditingTarget.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -547,7 +547,7 @@ public String getTitle()
          }
       };
       
-      view_ = new ProfilerEditingTargetWidget(commands_, publishHtmlSource);
+      view_ = new ProfilerEditingTargetWidget("Profiler", commands_, publishHtmlSource);
       defaultNameProvider_ = defaultNameProvider;
       
       getName().setValue(getAndSetInitialName());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ProfilerEditingTargetWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -36,7 +36,7 @@ public class ProfilerEditingTargetWidget extends Composite
 {
    private RStudioThemedFrame profilePage_;
    
-   public ProfilerEditingTargetWidget(Commands commands, PublishHtmlSource publishHtmlSource)
+   public ProfilerEditingTargetWidget(String title, Commands commands, PublishHtmlSource publishHtmlSource)
    {
       VerticalPanel panel = new VerticalPanel();
 
@@ -46,6 +46,7 @@ public ProfilerEditingTargetWidget(Commands commands, PublishHtmlSource publishH
                                           panel);
 
       profilePage_ = new RStudioThemedFrame(
+         title,
          null,
          getCustomStyle(),
          "../profiler_resource/profiler.css",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AceEditor.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -1296,6 +1296,7 @@ class PrintIFrame extends DynamicIFrame
    {
       public PrintIFrame(String code, double fontSize)
       {
+         super("Print Frame");
          code_ = code;
          fontSize_ = fontSize;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkHtmlPage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ChunkHtmlPage.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -54,7 +54,7 @@ public ChunkHtmlPage(String url, NotebookHtmlMetadata metadata,
          url += "?";
       url += "viewer_pane=1&capabilities=1";
 
-      frame_ = new ChunkOutputFrame();
+      frame_ = new ChunkOutputFrame("Chunk HTML Page Output Frame");
       
       if (chunkOutputSize != ChunkOutputSize.Full) {
          content_ = new FixedRatioWidget(frame_, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -203,7 +203,7 @@ public void showHtmlOutput(String url, NotebookHtmlMetadata metadata,
          url += "viewer_pane=1&capabilities=1";
       }
 
-      final ChunkOutputFrame frame = new ChunkOutputFrame();
+      final ChunkOutputFrame frame = new ChunkOutputFrame("Chunk HTML Output Frame");
 
       if (chunkOutputSize_ == ChunkOutputSize.Default) {
          if (knitrFigure) {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/RMarkdownNoParamsDialog.java
Patch:
@@ -58,6 +58,7 @@ protected Widget createMainWidget()
       // add image
       MessageDialogImages images = MessageDialogImages.INSTANCE;
       Image image = new Image(new ImageResource2x(images.dialog_warning2x()));
+      image.setAltText("Warning");
       horizontalPanel.add(image);
 
       // add message widget
@@ -80,6 +81,8 @@ protected Widget createMainWidget()
       horizontalPanel.add(messagePanel);
       panel.add(horizontalPanel);
       
+      // read the message when dialog is shown
+      setARIADescribedBy(label.getElement());
       return panel;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * UrlContentEditingTargetWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -26,11 +26,11 @@
 public class UrlContentEditingTargetWidget extends Composite
    implements UrlContentEditingTarget.Display
 {
-   public UrlContentEditingTargetWidget(Commands commands, String url)
+   public UrlContentEditingTargetWidget(String title, Commands commands, String url)
    {
       commands_ = commands;
 
-      frame_ = new RStudioThemedFrame(url, true, "allow-same-origin", null, null, false, true);
+      frame_ = new RStudioThemedFrame(title, url, true, "allow-same-origin", null, null, false, true);
       frame_.setSize("100%", "100%");
 
       PanelWithToolbars panel = new PanelWithToolbars(createToolbar(),

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -151,7 +151,7 @@ public String getTitle()
    @Override 
    protected Widget createMainWidget()
    {
-      frame_ = new RStudioFrame();
+      frame_ = new RStudioFrame("Viewer Pane");
       frame_.setSize("100%", "100%");
       frame_.addStyleName("ace_editor_theme");
       navigate(ABOUT_BLANK, false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/export/ViewerPanePreviewer.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ViewerPanePreviewer.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -41,7 +41,7 @@ public Widget getWidget()
    {
       if (frame_ == null)
       {
-         frame_ = new RStudioFrame();
+         frame_ = new RStudioFrame("Viewer Pane Preview");
          frame_.setUrl(url_);
          frame_.setSize("100%", "100%");
          frame_.setStylePrimaryName(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTargetWidget.java
Patch:
@@ -115,9 +115,12 @@ public DataEditingTargetWidget(String title,
                      "[[" + col + "]]" + 
                      "[[" + row + "]])", true));
          };
+         
+         table_.addKeyDownHandler();
          table_.setDataViewerCallback(view);
          table_.setListViewerCallback(view);
          table_.setColumnFrameCallback();
+         
       });
 
       Widget mainWidget;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTargetWidget.java
Patch:
@@ -113,9 +113,12 @@ public DataEditingTargetWidget(Commands commands,
                      "[[" + col + "]]" + 
                      "[[" + row + "]])", true));
          };
+         
+         table_.addKeyDownHandler();
          table_.setDataViewerCallback(view);
          table_.setListViewerCallback(view);
          table_.setColumnFrameCallback();
+         
       });
 
       Widget mainWidget;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -44,7 +44,6 @@
 import org.rstudio.studio.client.application.ui.impl.WebApplicationHeaderOverlay;
 import org.rstudio.studio.client.common.FileDialogs;
 import org.rstudio.studio.client.common.GlobalDisplay;
-import org.rstudio.studio.client.common.compilepdf.dialog.CompilePdfProgressDialog;
 import org.rstudio.studio.client.common.dependencies.DependencyManager;
 import org.rstudio.studio.client.common.fileexport.FileExport;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
@@ -184,7 +183,6 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(SVNCommandHandler svnCommandHandler);
    void injectMembers(CaptionWithHelp captionWithHelp);
    void injectMembers(RnwWeaveSelectWidget selectWidget);
-   void injectMembers(CompilePdfProgressDialog compilePdfProgressDialog);
    void injectMembers(TextEditingTargetCompilePdfHelper compilePdfHelper);
    void injectMembers(TypoSpellChecker typoSpellChecker);
    void injectMembers(SpellingCustomDictionariesWidget widget);

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -44,7 +44,6 @@
 import org.rstudio.studio.client.application.ui.impl.WebApplicationHeaderOverlay;
 import org.rstudio.studio.client.common.FileDialogs;
 import org.rstudio.studio.client.common.GlobalDisplay;
-import org.rstudio.studio.client.common.compilepdf.dialog.CompilePdfProgressDialog;
 import org.rstudio.studio.client.common.dependencies.DependencyManager;
 import org.rstudio.studio.client.common.fileexport.FileExport;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
@@ -184,7 +183,6 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(SVNCommandHandler svnCommandHandler);
    void injectMembers(CaptionWithHelp captionWithHelp);
    void injectMembers(RnwWeaveSelectWidget selectWidget);
-   void injectMembers(CompilePdfProgressDialog compilePdfProgressDialog);
    void injectMembers(TextEditingTargetCompilePdfHelper compilePdfHelper);
    void injectMembers(TypoSpellChecker typoSpellChecker);
    void injectMembers(SpellingCustomDictionariesWidget widget);

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileDialog.java
Patch:
@@ -196,7 +196,7 @@ public void onNavigated()
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       browser_.setFilenameFocus(true);
       browser_.selectFilename();

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -69,7 +69,7 @@ public TextEntryModalDialog(String title,
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       textBox_.setFocus(true);
       

File: src/gwt/src/org/rstudio/studio/client/common/rpubs/ui/RPubsUploadDialog.java
Patch:
@@ -257,12 +257,12 @@ public void onClick(ClickEvent event)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
-      
       if (hasTitle())
          titleTextBox_.setFocus(true);
+      else
+         super.focusInitialControl();
    }
    
    protected void onUnload()

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -166,7 +166,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       editor_.focus();
    }

File: src/gwt/src/org/rstudio/studio/client/notebook/CompileNotebookOptionsDialog.java
Patch:
@@ -92,7 +92,7 @@ void initialize(FileTypeCommands fileTypeCommands)
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       txtTitle_.setFocus(true);
       txtTitle_.selectAll();

File: src/gwt/src/org/rstudio/studio/client/notebookv2/CompileNotebookv2OptionsDialog.java
Patch:
@@ -55,9 +55,8 @@ public CompileNotebookv2OptionsDialog(
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       listFormat_.setFocus(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyGadgetDialog.java
Patch:
@@ -102,9 +102,8 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       frame_.getWindow().focus();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/ui/CodeSearchDialog.java
Patch:
@@ -72,7 +72,7 @@ public void setPosition(int offsetWidth, int offsetHeight)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    { 
       ((CanFocus)codeSearch_.getSearchWidget()).focus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotDialog.java
Patch:
@@ -98,9 +98,8 @@ protected ExportPlotOptions getCurrentOptions(ExportPlotOptions previous)
     
   
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       sizeEditor_.onSizerShown();
    }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/SavePlotAsImageDialog.java
Patch:
@@ -82,9 +82,8 @@ protected Widget createTopLeftWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       saveAsTarget_.focus();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/snippets/ui/EditSnippetsDialog.java
Patch:
@@ -164,7 +164,7 @@ public void onValueChange(ValueChangeEvent<Void> event)
    }
    
    @Override
-   public void onDialogShown()
+   public void focusInitialControl()
    {
       docDisplay_.focus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/edit/ui/EditDialog.java
Patch:
@@ -121,7 +121,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       editor_.focus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -196,10 +196,8 @@ protected Widget createMainWidget()
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
-
       txtSearchPattern_.setFocus(true);
       txtSearchPattern_.selectAll();
       updateOkButtonEnabled();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/InstallPackageDialog.java
Patch:
@@ -252,7 +252,7 @@ public void onChange(ChangeEvent event)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       if (installFromRepository())
          FocusHelper.setFocusDeferred(packagesSuggestBox_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsPdfDialog.java
Patch:
@@ -131,7 +131,7 @@ public void onClick(ClickEvent event)
    }
    
    @Override 
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       fileNameTextBox_.setFocus(true);
       fileNameTextBox_.selectAll();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewPlumberAPI.java
Patch:
@@ -222,9 +222,8 @@ public NewPlumberAPI(String caption,
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       apiNameTextBox_.setFocus(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewShinyWebApplication.java
Patch:
@@ -261,9 +261,8 @@ else if (TYPE_MULTI_FILE.equals(cachedAppType))
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       appNameTextBox_.setFocus(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -268,11 +268,10 @@ public HelpLink makeHelpCaption()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       // when dialog is finished booting, focus the title so it's ready to
       // accept input
-      super.onDialogShown();
       txtTitle_.setSelectionRange(0, txtTitle_.getText().length());
       txtTitle_.setFocus(true);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRdDialog.java
Patch:
@@ -62,7 +62,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       txtName_.setFocus(true);
    }

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileDialog.java
Patch:
@@ -196,7 +196,7 @@ public void onNavigated()
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       browser_.setFilenameFocus(true);
       browser_.selectFilename();

File: src/gwt/src/org/rstudio/core/client/widget/MessageDialog.java
Patch:
@@ -144,13 +144,13 @@ public static Label labelForMessage(String message)
                      ThemeResources.INSTANCE.themeStyles().dialogMessage());
       return label;
    }
-    
+
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       focusOkButton();
    }
-   
+
    private int type_ ;
    private Widget messageWidget_ ;
    private ProgressIndicator progress_ ;

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -69,7 +69,7 @@ public TextEntryModalDialog(String title,
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       textBox_.setFocus(true);
       

File: src/gwt/src/org/rstudio/studio/client/common/rpubs/ui/RPubsUploadDialog.java
Patch:
@@ -257,12 +257,12 @@ public void onClick(ClickEvent event)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
-      
       if (hasTitle())
          titleTextBox_.setFocus(true);
+      else
+         super.focusInitialControl();
    }
    
    protected void onUnload()

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/ui/AskSecretDialog.java
Patch:
@@ -191,7 +191,7 @@ protected AskSecretDialogResult collectInput()
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       textbox_.setFocus(true);
       textbox_.setSelectionRange(0, textbox_.getText().length());

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -166,7 +166,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       editor_.focus();
    }

File: src/gwt/src/org/rstudio/studio/client/notebook/CompileNotebookOptionsDialog.java
Patch:
@@ -92,7 +92,7 @@ void initialize(FileTypeCommands fileTypeCommands)
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       txtTitle_.setFocus(true);
       txtTitle_.selectAll();

File: src/gwt/src/org/rstudio/studio/client/notebookv2/CompileNotebookv2OptionsDialog.java
Patch:
@@ -55,9 +55,8 @@ public CompileNotebookv2OptionsDialog(
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       listFormat_.setFocus(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyGadgetDialog.java
Patch:
@@ -102,9 +102,8 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       frame_.getWindow().focus();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/ui/CodeSearchDialog.java
Patch:
@@ -72,7 +72,7 @@ public void setPosition(int offsetWidth, int offsetHeight)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    { 
       ((CanFocus)codeSearch_.getSearchWidget()).focus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotDialog.java
Patch:
@@ -98,9 +98,8 @@ protected ExportPlotOptions getCurrentOptions(ExportPlotOptions previous)
     
   
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       sizeEditor_.onSizerShown();
    }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/SavePlotAsImageDialog.java
Patch:
@@ -82,9 +82,8 @@ protected Widget createTopLeftWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       saveAsTarget_.focus();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/snippets/ui/EditSnippetsDialog.java
Patch:
@@ -164,7 +164,7 @@ public void onValueChange(ValueChangeEvent<Void> event)
    }
    
    @Override
-   public void onDialogShown()
+   public void focusInitialControl()
    {
       docDisplay_.focus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/unsaved/UnsavedChangesDialog.java
Patch:
@@ -120,7 +120,7 @@ public void onClick(ClickEvent event)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       focusOkButton();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/edit/ui/EditDialog.java
Patch:
@@ -121,7 +121,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       editor_.focus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -196,10 +196,8 @@ protected Widget createMainWidget()
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
-
       txtSearchPattern_.setFocus(true);
       txtSearchPattern_.selectAll();
       updateOkButtonEnabled();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/InstallPackageDialog.java
Patch:
@@ -252,7 +252,7 @@ public void onChange(ChangeEvent event)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       if (installFromRepository())
          FocusHelper.setFocusDeferred(packagesSuggestBox_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsPdfDialog.java
Patch:
@@ -131,7 +131,7 @@ public void onClick(ClickEvent event)
    }
    
    @Override 
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       fileNameTextBox_.setFocus(true);
       fileNameTextBox_.selectAll();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewPlumberAPI.java
Patch:
@@ -222,9 +222,8 @@ public NewPlumberAPI(String caption,
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       apiNameTextBox_.setFocus(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewShinyWebApplication.java
Patch:
@@ -261,9 +261,8 @@ else if (TYPE_MULTI_FILE.equals(cachedAppType))
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       appNameTextBox_.setFocus(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -268,11 +268,10 @@ public HelpLink makeHelpCaption()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       // when dialog is finished booting, focus the title so it's ready to
       // accept input
-      super.onDialogShown();
       txtTitle_.setSelectionRange(0, txtTitle_.getText().length());
       txtTitle_.setFocus(true);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRdDialog.java
Patch:
@@ -62,7 +62,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       txtName_.setFocus(true);
    }

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -627,7 +627,8 @@ protected void focusFirstControl()
     /**
     * Set focus on last keyboard focusable element in dialog, as set by 
     * <code>refreshFocusableElements</code> or <code>setLastFocusableElement</code>.
-    */  protected void focusLastControl()
+    */
+   protected void focusLastControl()
    {
       Element last = getByClass(lastFocusClass);
       if (last != null)

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileDialog.java
Patch:
@@ -196,7 +196,7 @@ public void onNavigated()
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       browser_.setFilenameFocus(true);
       browser_.selectFilename();

File: src/gwt/src/org/rstudio/core/client/widget/MessageDialog.java
Patch:
@@ -144,13 +144,13 @@ public static Label labelForMessage(String message)
                      ThemeResources.INSTANCE.themeStyles().dialogMessage());
       return label;
    }
-    
+
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       focusOkButton();
    }
-   
+
    private int type_ ;
    private Widget messageWidget_ ;
    private ProgressIndicator progress_ ;

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -69,7 +69,7 @@ public TextEntryModalDialog(String title,
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       textBox_.setFocus(true);
       

File: src/gwt/src/org/rstudio/studio/client/common/rpubs/ui/RPubsUploadDialog.java
Patch:
@@ -257,12 +257,12 @@ public void onClick(ClickEvent event)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
-      
       if (hasTitle())
          titleTextBox_.setFocus(true);
+      else
+         super.focusInitialControl();
    }
    
    protected void onUnload()

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/ui/AskSecretDialog.java
Patch:
@@ -191,7 +191,7 @@ protected AskSecretDialogResult collectInput()
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       textbox_.setFocus(true);
       textbox_.setSelectionRange(0, textbox_.getText().length());

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ignore/IgnoreDialog.java
Patch:
@@ -166,7 +166,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       editor_.focus();
    }

File: src/gwt/src/org/rstudio/studio/client/notebook/CompileNotebookOptionsDialog.java
Patch:
@@ -92,7 +92,7 @@ void initialize(FileTypeCommands fileTypeCommands)
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       txtTitle_.setFocus(true);
       txtTitle_.selectAll();

File: src/gwt/src/org/rstudio/studio/client/notebookv2/CompileNotebookv2OptionsDialog.java
Patch:
@@ -55,9 +55,8 @@ public CompileNotebookv2OptionsDialog(
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       listFormat_.setFocus(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyGadgetDialog.java
Patch:
@@ -102,9 +102,8 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       frame_.getWindow().focus();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/ui/CodeSearchDialog.java
Patch:
@@ -72,7 +72,7 @@ public void setPosition(int offsetWidth, int offsetHeight)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    { 
       ((CanFocus)codeSearch_.getSearchWidget()).focus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/ExportPlotDialog.java
Patch:
@@ -98,9 +98,8 @@ protected ExportPlotOptions getCurrentOptions(ExportPlotOptions previous)
     
   
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       sizeEditor_.onSizerShown();
    }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/exportplot/SavePlotAsImageDialog.java
Patch:
@@ -82,9 +82,8 @@ protected Widget createTopLeftWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       saveAsTarget_.focus();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/snippets/ui/EditSnippetsDialog.java
Patch:
@@ -164,7 +164,7 @@ public void onValueChange(ValueChangeEvent<Void> event)
    }
    
    @Override
-   public void onDialogShown()
+   public void focusInitialControl()
    {
       docDisplay_.focus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/unsaved/UnsavedChangesDialog.java
Patch:
@@ -120,7 +120,7 @@ public void onClick(ClickEvent event)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       focusOkButton();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/edit/ui/EditDialog.java
Patch:
@@ -121,7 +121,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       editor_.focus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindInFilesDialog.java
Patch:
@@ -196,10 +196,8 @@ protected Widget createMainWidget()
    }
 
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
-
       txtSearchPattern_.setFocus(true);
       txtSearchPattern_.selectAll();
       updateOkButtonEnabled();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/InstallPackageDialog.java
Patch:
@@ -252,7 +252,7 @@ public void onChange(ChangeEvent event)
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       if (installFromRepository())
          FocusHelper.setFocusDeferred(packagesSuggestBox_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsPdfDialog.java
Patch:
@@ -131,7 +131,7 @@ public void onClick(ClickEvent event)
    }
    
    @Override 
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       fileNameTextBox_.setFocus(true);
       fileNameTextBox_.selectAll();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewPlumberAPI.java
Patch:
@@ -222,9 +222,8 @@ public NewPlumberAPI(String caption,
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       apiNameTextBox_.setFocus(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewShinyWebApplication.java
Patch:
@@ -261,9 +261,8 @@ else if (TYPE_MULTI_FILE.equals(cachedAppType))
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
-      super.onDialogShown();
       appNameTextBox_.setFocus(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -268,11 +268,10 @@ public HelpLink makeHelpCaption()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       // when dialog is finished booting, focus the title so it's ready to
       // accept input
-      super.onDialogShown();
       txtTitle_.setSelectionRange(0, txtTitle_.getText().length());
       txtTitle_.setFocus(true);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRdDialog.java
Patch:
@@ -62,7 +62,7 @@ protected Widget createMainWidget()
    }
    
    @Override
-   protected void onDialogShown()
+   protected void focusInitialControl()
    {
       txtName_.setFocus(true);
    }

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -499,9 +499,10 @@ public void onPreviewNativeEvent(Event.NativePreviewEvent event)
             if (enterDisabled_)
                break;
 
-            // allow Enter on textareas or anchors
+            // allow Enter on textareas or anchors (including custom links)
             Element e = DomUtils.getActiveElement();
-            if (e.hasTagName("TEXTAREA") || e.hasTagName("A"))
+            if (e.hasTagName("TEXTAREA") || e.hasTagName("A") || 
+                  (e.hasAttribute("role") && e.getAttribute("role") == "link"))
                return;
 
             ThemedButton defaultButton = defaultOverrideButton_ == null

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -24,11 +24,11 @@
 import com.google.gwt.dom.client.Style.Position;
 import com.google.gwt.dom.client.Style.TextDecoration;
 import com.google.gwt.dom.client.Style.Unit;
-import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.logical.shared.CloseEvent;
 import com.google.gwt.event.logical.shared.CloseHandler;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.ImageResource;
+import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.Event;
 import com.google.gwt.user.client.Event.NativePreviewEvent;
 import com.google.gwt.user.client.Event.NativePreviewHandler;
@@ -444,7 +444,7 @@ private Widget createCommandSeparator()
       return sep;
    }
    
-   private Widget createCommandLink(String caption, ClickHandler clickHandler)
+   private Widget createCommandLink(String caption, Command clickHandler)
    {
       HyperlinkLabel link = new HyperlinkLabel(caption, clickHandler);
       return link;

File: src/gwt/src/org/rstudio/studio/client/common/DiagnosticsHelpLink.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DiagnosticsHelpLink.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,8 +15,6 @@
 
 package org.rstudio.studio.client.common;
 
-import org.rstudio.studio.client.common.HelpLink;
-
 public class DiagnosticsHelpLink extends HelpLink
 {
    public DiagnosticsHelpLink()

File: src/gwt/src/org/rstudio/studio/client/common/PackagesHelpLink.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PackagesHelpLink.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,8 +15,6 @@
 
 package org.rstudio.studio.client.common;
 
-import org.rstudio.studio.client.common.HelpLink;
-
 public class PackagesHelpLink extends HelpLink
 {
    public PackagesHelpLink()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/DiffFrame.java
Patch:
@@ -15,13 +15,13 @@
 package org.rstudio.studio.client.workbench.views.vcs.dialog;
 
 import com.google.gwt.core.client.GWT;
-import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.CssResource;
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.resources.client.ImageResource.ImageOptions;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
+import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.ui.*;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.theme.res.ThemeResources;
@@ -62,7 +62,7 @@ public DiffFrame(ImageResource icon,
                     String filename2,
                     String commitId,
                     LineTableView diff,
-                    ClickHandler viewFileClickHandler,
+                    Command viewFileClickHandler,
                     boolean suppressViewLink)
    {
       initWidget(GWT.<Binder>create(Binder.class).createAndBindUi(this));

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -488,9 +488,10 @@ public void onPreviewNativeEvent(Event.NativePreviewEvent event)
             if (enterDisabled_)
                break;
 
-            // allow Enter on textareas or anchors
+            // allow Enter on textareas or anchors (including custom links)
             Element e = DomUtils.getActiveElement();
-            if (e.hasTagName("TEXTAREA") || e.hasTagName("A"))
+            if (e.hasTagName("TEXTAREA") || e.hasTagName("A") || 
+                  (e.hasAttribute("role") && e.getAttribute("role") == "link"))
                return;
 
             ThemedButton defaultButton = defaultOverrideButton_ == null

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -24,11 +24,11 @@
 import com.google.gwt.dom.client.Style.Position;
 import com.google.gwt.dom.client.Style.TextDecoration;
 import com.google.gwt.dom.client.Style.Unit;
-import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.logical.shared.CloseEvent;
 import com.google.gwt.event.logical.shared.CloseHandler;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.ImageResource;
+import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.Event;
 import com.google.gwt.user.client.Event.NativePreviewEvent;
 import com.google.gwt.user.client.Event.NativePreviewHandler;
@@ -444,7 +444,7 @@ private Widget createCommandSeparator()
       return sep;
    }
    
-   private Widget createCommandLink(String caption, ClickHandler clickHandler)
+   private Widget createCommandLink(String caption, Command clickHandler)
    {
       HyperlinkLabel link = new HyperlinkLabel(caption, clickHandler);
       return link;

File: src/gwt/src/org/rstudio/studio/client/common/DiagnosticsHelpLink.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DiagnosticsHelpLink.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,8 +15,6 @@
 
 package org.rstudio.studio.client.common;
 
-import org.rstudio.studio.client.common.HelpLink;
-
 public class DiagnosticsHelpLink extends HelpLink
 {
    public DiagnosticsHelpLink()

File: src/gwt/src/org/rstudio/studio/client/common/PackagesHelpLink.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PackagesHelpLink.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,8 +15,6 @@
 
 package org.rstudio.studio.client.common;
 
-import org.rstudio.studio.client.common.HelpLink;
-
 public class PackagesHelpLink extends HelpLink
 {
    public PackagesHelpLink()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/DiffFrame.java
Patch:
@@ -15,13 +15,13 @@
 package org.rstudio.studio.client.workbench.views.vcs.dialog;
 
 import com.google.gwt.core.client.GWT;
-import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.CssResource;
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.resources.client.ImageResource.ImageOptions;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
+import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.ui.*;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.theme.res.ThemeResources;
@@ -62,7 +62,7 @@ public DiffFrame(ImageResource icon,
                     String filename2,
                     String commitId,
                     LineTableView diff,
-                    ClickHandler viewFileClickHandler,
+                    Command viewFileClickHandler,
                     boolean suppressViewLink)
    {
       initWidget(GWT.<Binder>create(Binder.class).createAndBindUi(this));

File: src/gwt/src/org/rstudio/core/client/command/AppMenuItem.java
Patch:
@@ -53,6 +53,7 @@ public void onShow()
 
       setHTML(cmd_.getMenuHTML(mainMenu_));
       setTitle(cmd_.getDesc());
+      setChecked(cmd_.isChecked());
    }
 
    public boolean cmdVisible()

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcResponse.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RpcResponse.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -43,6 +43,7 @@ public final static RpcResponse parse(String json)
             // server isn't parsable by parseStrict (for example,
             // see bug #3025). for these situations we call 
             // parseLenient (which in turn calls eval)
+            @SuppressWarnings("deprecation")
             JSONValue val = JSONParser.parseLenient(json);
             return val.isObject().getJavaScriptObject().cast();
          }

File: src/gwt/src/org/rstudio/core/client/resources/ImageResourceUrl.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ImageResourceUrl.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -59,6 +59,7 @@ public int getTop()
    }
 
    @Override
+   @SuppressWarnings("deprecation")
    public String getURL()
    {
       return url_.asString();

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -16,7 +16,7 @@
 
 import com.google.gwt.aria.client.Id;
 import com.google.gwt.aria.client.Roles;
-import com.google.gwt.user.client.Element;
+import com.google.gwt.dom.client.Element;
 import com.google.gwt.user.client.ui.Anchor;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.studio.client.application.Desktop;

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcResponse.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RpcResponse.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -43,6 +43,7 @@ public final static RpcResponse parse(String json)
             // server isn't parsable by parseStrict (for example,
             // see bug #3025). for these situations we call 
             // parseLenient (which in turn calls eval)
+            @SuppressWarnings("deprecation")
             JSONValue val = JSONParser.parseLenient(json);
             return val.isObject().getJavaScriptObject().cast();
          }

File: src/gwt/src/org/rstudio/core/client/resources/ImageResourceUrl.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ImageResourceUrl.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -59,6 +59,7 @@ public int getTop()
    }
 
    @Override
+   @SuppressWarnings("deprecation")
    public String getURL()
    {
       return url_.asString();

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -16,7 +16,7 @@
 
 import com.google.gwt.aria.client.Id;
 import com.google.gwt.aria.client.Roles;
-import com.google.gwt.user.client.Element;
+import com.google.gwt.dom.client.Element;
 import com.google.gwt.user.client.ui.Anchor;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.studio.client.application.Desktop;

File: src/gwt/src/org/rstudio/studio/client/common/plumber/model/PlumberServerOperations.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PlumberServerOperations.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,12 +15,11 @@
 package org.rstudio.studio.client.common.plumber.model;
 
 import org.rstudio.studio.client.plumber.model.PlumberRunCmd;
-import org.rstudio.studio.client.plumber.model.PlumberViewerType;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 
 public interface PlumberServerOperations
 {
-   void getPlumberViewerType(ServerRequestCallback<PlumberViewerType> requestCallback);
+   void getPlumberViewerType(ServerRequestCallback<String> requestCallback);
    
    void getPlumberRunCmd(
                String plumberFile,

File: src/gwt/src/org/rstudio/studio/client/common/shiny/model/ShinyServerOperations.java
Patch:
@@ -17,18 +17,17 @@
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.shiny.model.ShinyRunCmd;
-import org.rstudio.studio.client.shiny.model.ShinyViewerType;
 
 public interface ShinyServerOperations
 {
    void getShinyCapabilities(
                ServerRequestCallback<ShinyCapabilities> requestCallback);
 
    void getShinyViewerType(
-               ServerRequestCallback<ShinyViewerType> requestCallback);
+               ServerRequestCallback<String> requestCallback);
    
    void setShinyViewerType(
-               int viewerType, 
+               String viewerType, 
                ServerRequestCallback<Void> requestCallback);
    
    void getShinyRunCmd(

File: src/gwt/src/org/rstudio/studio/client/plumber/PlumberAPI.java
Patch:
@@ -35,7 +35,6 @@
 import org.rstudio.studio.client.plumber.events.PlumberAPIStatusEvent;
 import org.rstudio.studio.client.plumber.model.PlumberAPIParams;
 import org.rstudio.studio.client.plumber.model.PlumberRunCmd;
-import org.rstudio.studio.client.plumber.model.PlumberViewerType;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.workbench.commands.Commands;

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplication.java
Patch:
@@ -37,7 +37,6 @@
 import org.rstudio.studio.client.shiny.model.ShinyApplicationParams;
 import org.rstudio.studio.client.shiny.model.ShinyRunCmd;
 import org.rstudio.studio.client.shiny.model.ShinyViewerOptions;
-import org.rstudio.studio.client.shiny.model.ShinyViewerType;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleBusyEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -95,7 +95,6 @@
 import org.rstudio.studio.client.plumber.events.LaunchPlumberAPIEvent;
 import org.rstudio.studio.client.plumber.events.PlumberAPIStatusEvent;
 import org.rstudio.studio.client.plumber.model.PlumberAPIParams;
-import org.rstudio.studio.client.plumber.model.PlumberViewerType;
 import org.rstudio.studio.client.rmarkdown.RmdOutput;
 import org.rstudio.studio.client.rmarkdown.events.ConvertToShinyDocEvent;
 import org.rstudio.studio.client.rmarkdown.events.RmdOutputFormatChangedEvent;
@@ -120,7 +119,6 @@
 import org.rstudio.studio.client.shiny.events.LaunchShinyApplicationEvent;
 import org.rstudio.studio.client.shiny.events.ShinyApplicationStatusEvent;
 import org.rstudio.studio.client.shiny.model.ShinyApplicationParams;
-import org.rstudio.studio.client.shiny.model.ShinyViewerType;
 import org.rstudio.studio.client.workbench.WorkbenchContext;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.Session;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPresenter.java
Patch:
@@ -44,15 +44,13 @@
 import org.rstudio.studio.client.common.zoom.ZoomUtils;
 import org.rstudio.studio.client.plumber.events.PlumberAPIStatusEvent;
 import org.rstudio.studio.client.plumber.model.PlumberAPIParams;
-import org.rstudio.studio.client.plumber.model.PlumberViewerType;
 import org.rstudio.studio.client.rmarkdown.model.RmdPreviewParams;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.VoidServerRequestCallback;
 import org.rstudio.studio.client.shiny.ShinyDisconnectNotifier;
 import org.rstudio.studio.client.shiny.ShinyDisconnectNotifier.ShinyDisconnectSource;
 import org.rstudio.studio.client.shiny.events.ShinyApplicationStatusEvent;
 import org.rstudio.studio.client.shiny.model.ShinyApplicationParams;
-import org.rstudio.studio.client.shiny.model.ShinyViewerType;
 import org.rstudio.studio.client.workbench.WorkbenchContext;
 import org.rstudio.studio.client.workbench.WorkbenchView;
 import org.rstudio.studio.client.workbench.commands.Commands;

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarPopupMenu.java
Patch:
@@ -259,10 +259,11 @@ public void onPreviewNativeEvent(NativePreviewEvent e)
                         selectLast();
                         break;
                      case KeyCodes.KEY_ENTER:
-                        e.cancel();
+                     case KeyCodes.KEY_SPACE:
                         final MenuItem menuItem = getSelectedItem();
                         if (menuItem != null)
                         {
+                           e.cancel();
                            NativeEvent evt = Document.get().createClickEvent(
                                  0,
                                  0,

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationInterrupt.java
Patch:
@@ -118,9 +118,9 @@ public void onFailure()
    }
 
    public void interruptR(final InterruptHandler handler,
-                          List<Integer> errorHandlerTypes,
-                          int replacedWithHandlerType) {
-      final int originalDebugType = errorManager_.getErrorHandlerType();
+                          List<String> errorHandlerTypes,
+                          String replacedWithHandlerType) {
+      final String originalDebugType = errorManager_.getErrorHandlerType();
       
       if (!errorHandlerTypes.contains(originalDebugType)) {
          interruptR(handler);

File: src/gwt/src/org/rstudio/studio/client/common/debugging/DebuggingServerOperations.java
Patch:
@@ -48,7 +48,7 @@ public void getFunctionState(
          ServerRequestCallback<FunctionState> requestCallback);
    
    public void setErrorManagementType(
-         int type,
+         String type,
          ServerRequestCallback<Void> requestCallback);
    
    public void updateBreakpoints(

File: src/gwt/src/org/rstudio/studio/client/common/debugging/model/ErrorManagerState.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ErrorManagerState.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -21,11 +21,11 @@ public class ErrorManagerState extends JavaScriptObject
 {
    protected ErrorManagerState() {}
    
-   public final native int getErrorHandlerType() /*-{
+   public final native String getErrorHandlerType() /*-{
       return this.error_handler_type;
    }-*/;
    
-   public final native void setErrorHandlerType(int type) /*-{
+   public final native void setErrorHandlerType(String type) /*-{
       this.error_handler_type = type;
    }-*/;
 } 

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -44,7 +44,6 @@
 import org.rstudio.studio.client.common.debugging.events.PackageLoadedEvent;
 import org.rstudio.studio.client.common.debugging.events.PackageUnloadedEvent;
 import org.rstudio.studio.client.common.debugging.events.UnhandledErrorEvent;
-import org.rstudio.studio.client.common.debugging.model.ErrorHandlerType;
 import org.rstudio.studio.client.common.debugging.model.UnhandledError;
 import org.rstudio.studio.client.common.dependencies.events.InstallShinyEvent;
 import org.rstudio.studio.client.common.rpubs.events.RPubsUploadStatusEvent;
@@ -595,7 +594,7 @@ else if (type == ClientEvent.UnhandledError)
          }
          else if (type == ClientEvent.ErrorHandlerChanged)
          {
-            ErrorHandlerType handlerType = event.getData();
+            String handlerType = event.getData();
             eventBus_.dispatchEvent(new ErrorHandlerChangedEvent(handlerType));
          }
          else if (type == ClientEvent.ViewerNavigate)

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -4585,11 +4585,11 @@ public void executeDebugSource(
    }
    
    public void setErrorManagementType(
-         int type,
+         String type,
          ServerRequestCallback<Void> requestCallback)
    {
       JSONArray params = new JSONArray();
-      params.set(0, new JSONNumber(type));
+      params.set(0, new JSONString(type));
       
       sendRequest(RPC_SCOPE, 
             SET_ERROR_MANAGEMENT_TYPE, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -38,7 +38,6 @@
 import org.rstudio.studio.client.common.CommandLineHistory;
 import org.rstudio.studio.client.common.debugging.ErrorManager;
 import org.rstudio.studio.client.common.debugging.events.UnhandledErrorEvent;
-import org.rstudio.studio.client.common.debugging.model.ErrorHandlerType;
 import org.rstudio.studio.client.common.dependencies.DependencyManager;
 import org.rstudio.studio.client.common.shell.ShellDisplay;
 import org.rstudio.studio.client.server.ServerError;
@@ -54,6 +53,7 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.studio.client.workbench.model.helper.StringStateValue;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
+import org.rstudio.studio.client.workbench.prefs.model.UserState;
 import org.rstudio.studio.client.workbench.views.console.events.*;
 import org.rstudio.studio.client.workbench.views.console.model.ConsoleServerOperations;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionManager;
@@ -489,7 +489,7 @@ public void onRunCommandWithDebug(final RunCommandWithDebugEvent event)
    {
       // Invoked from the "Rerun with Debug" command in the ConsoleError widget.
       errorManager_.setDebugSessionHandlerType(
-            ErrorHandlerType.ERRORS_BREAK,
+            UserState.ERROR_HANDLER_TYPE_BREAK,
             new ServerRequestCallback<Void>()
             {
                @Override

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarPopupMenu.java
Patch:
@@ -259,10 +259,11 @@ public void onPreviewNativeEvent(NativePreviewEvent e)
                         selectLast();
                         break;
                      case KeyCodes.KEY_ENTER:
-                        e.cancel();
+                     case KeyCodes.KEY_SPACE:
                         final MenuItem menuItem = getSelectedItem();
                         if (menuItem != null)
                         {
+                           e.cancel();
                            NativeEvent evt = Document.get().createClickEvent(
                                  0,
                                  0,

File: src/gwt/src/org/rstudio/core/client/command/impl/DesktopMenuCallback.java
Patch:
@@ -94,7 +94,8 @@ private native static final void setCommandCheckedImpl(String commandId, boolean
 
    public native static final void setMainMenuEnabled(boolean enabled)
    /*-{
-       $wnd.desktopMenuCallback.setMainMenuEnabled(enabled);
+       if ($wnd.desktopMenuCallback)
+          $wnd.desktopMenuCallback.setMainMenuEnabled(enabled);
    }-*/;
 
    public static final void setCommandLabel(String commandId, String label)

File: src/gwt/src/org/rstudio/core/client/command/impl/DesktopMenuCallback.java
Patch:
@@ -94,7 +94,8 @@ private native static final void setCommandCheckedImpl(String commandId, boolean
 
    public native static final void setMainMenuEnabled(boolean enabled)
    /*-{
-       $wnd.desktopMenuCallback.setMainMenuEnabled(enabled);
+       if ($wnd.desktopMenuCallback)
+          $wnd.desktopMenuCallback.setMainMenuEnabled(enabled);
    }-*/;
 
    public static final void setCommandLabel(String commandId, String label)

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarPopupMenuButton.java
Patch:
@@ -26,7 +26,7 @@
 import com.google.gwt.user.client.ui.MenuBar;
 import com.google.gwt.user.client.ui.MenuItem;
 
-public class ToolbarPopupMenuButton extends ToolbarButton
+public class ToolbarPopupMenuButton extends ToolbarMenuButton
                                     implements HasValueChangeHandlers<String>
 {
    public ToolbarPopupMenuButton()

File: src/gwt/src/org/rstudio/studio/client/application/ui/ProjectPopupMenu.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.Desktop;
@@ -80,7 +81,7 @@ public ToolbarButton getToolbarButton()
                   mruList_.getQualifiedLabel(activeProjectFile_) :
                   "Project: (None)";
           
-         toolbarButton_ = new ToolbarButton(
+         toolbarButton_ = new ToolbarMenuButton(
                 buttonText,
                 ToolbarButton.NoTitle,
                 new ImageResource2x(RESOURCES.projectMenu2x()),
@@ -281,7 +282,7 @@ public void execute()
    private static final int MAX_SHARED_PROJECTS = 5;
    private static final int MAX_MRU_ENTRIES = 10;
    private final String activeProjectFile_;
-   private ToolbarButton toolbarButton_ = null;
+   private ToolbarMenuButton toolbarButton_ = null;
 
    private ProjectMRUList mruList_;
    private Commands commands_;

File: src/gwt/src/org/rstudio/studio/client/application/ui/addins/AddinsToolbarButton.java
Patch:
@@ -28,6 +28,7 @@
 import org.rstudio.core.client.widget.ScrollableToolbarPopupMenu;
 import org.rstudio.core.client.widget.SearchWidget;
 import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;
@@ -51,7 +52,7 @@
 import com.google.gwt.user.client.ui.MenuItem;
 import com.google.inject.Inject;
 
-public class AddinsToolbarButton extends ToolbarButton
+public class AddinsToolbarButton extends ToolbarMenuButton
 {
    public AddinsToolbarButton()
    {

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -38,6 +38,7 @@
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.core.client.widget.ToolbarLabel;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.Desktop;
@@ -75,7 +76,7 @@ private void setToolbarVisible(boolean visible)
    {
       toolbar_.setVisible(visible);
       int frameTop = visible ? tbHeight_+1 : 0;
-      layoutPanel_.setWidgetTopBottom(previewFrame_, frameTop, Unit.PX, 0, Unit.PX);    
+      layoutPanel_.setWidgetTopBottom(previewFrame_, frameTop, Unit.PX, 0, Unit.PX);
    }
    
    private Toolbar createToolbar(Commands commands)
@@ -108,7 +109,7 @@ private Toolbar createToolbar(Commands commands)
          menu.addItem(commands.saveHtmlPreviewAs().createMenuItem(false));
          menu.addItem(commands.saveHtmlPreviewAsLocalFile().createMenuItem(false));
       
-         saveHtmlPreviewAs_ = toolbar.addLeftWidget(new ToolbarButton(
+         saveHtmlPreviewAs_ = toolbar.addLeftWidget(new ToolbarMenuButton(
                "Save As",
                ToolbarButton.NoTitle,
                commands.saveSourceDoc().getImageResource(),

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishButton.java
Patch:
@@ -26,6 +26,7 @@
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -116,7 +117,7 @@ public void onClick(ClickEvent arg0)
       
       // create drop menu of previous deployments/other commands
       publishMenu_ = new DeploymentPopupMenu();
-      publishMenuButton_ = new ToolbarButton(ToolbarButton.NoText, "Publish options", publishMenu_, true);
+      publishMenuButton_ = new ToolbarMenuButton(ToolbarButton.NoText, "Publish options", publishMenu_, true);
       publishMenuButton_.getElement().setId(ElementIds.ID_PREFIX + 
             ElementIds.PUBLISH_SHOW_DEPLOYMENTS + "_" + host);
       panel.add(publishMenuButton_);
@@ -948,7 +949,7 @@ public void onError(ServerError error)
    
    private final ToolbarButton publishButton_;
    private final DeploymentPopupMenu publishMenu_;
-   private ToolbarButton publishMenuButton_;
+   private ToolbarMenuButton publishMenuButton_;
 
    private RSConnectServerOperations server_;
    private RMarkdownServerOperations rmdServer_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -61,6 +61,7 @@
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.core.client.widget.ToolbarLabel;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.workbench.commands.Commands;
@@ -388,7 +389,7 @@ public void requestSuggestions(Request request, Callback callback)
                "Copy to Clipboard",
                ConnectionOptions.CONNECT_COPY_TO_CLIPBOARD));
       }
-      connectMenuButton_ = new ToolbarButton(
+      connectMenuButton_ = new ToolbarMenuButton(
             "Connect",
             ToolbarButton.NoTitle,
             commands_.newConnection().getImageResource(), 
@@ -591,7 +592,7 @@ else if (conn2Connected && !conn1Connected)
    private SearchWidget searchWidget_;
    private SearchWidget objectSearchWidget_;
    private ToolbarButton backToConnectionsButton_;
-   private ToolbarButton connectMenuButton_;
+   private ToolbarMenuButton connectMenuButton_;
    
    private SecondaryToolbar secondaryToolbar_;
    private ToolbarLabel connectionName_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -29,6 +29,7 @@
 import org.rstudio.core.client.widget.SearchWidget;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -212,7 +213,7 @@ protected Toolbar createMainToolbar()
       packratMenu.addItem(commands_.packratBundle().createMenuItem(false));
       packratMenu.addSeparator();
       packratMenu.addItem(commands_.packratOptions().createMenuItem(false));
-      packratMenuButton_ = new ToolbarButton(
+      packratMenuButton_ = new ToolbarMenuButton(
             "Packrat", 
             ToolbarButton.NoTitle,
             commands_.packratBootstrap().getImageResource(),
@@ -670,7 +671,7 @@ public void render(Context context, PackageInfo pkgInfo,
    private PackagesDisplayObserver observer_ ;
    
    private ToolbarButton packratBootstrapButton_;
-   private ToolbarButton packratMenuButton_;
+   private ToolbarMenuButton packratMenuButton_;
    private Widget prePackratSeparator_;
    private LayoutPanel packagesTableContainer_;
    private int gridRenderRetryCount_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/PlotsToolbar.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.widget.HasCustomizableToolbar;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.common.icons.StandardIcons;
 import org.rstudio.studio.client.rsconnect.ui.RSConnectPublishButton;
@@ -62,7 +63,7 @@ private void installStandardUI()
       exportMenu.addItem(commands_.savePlotAsPdf().createMenuItem(false));
       exportMenu.addSeparator();
       exportMenu.addItem(commands_.copyPlotToClipboard().createMenuItem(false));
-      ToolbarButton exportButton = new ToolbarButton(
+      ToolbarMenuButton exportButton = new ToolbarMenuButton(
             "Export", ToolbarButton.NoTitle, 
             new ImageResource2x(StandardIcons.INSTANCE.export_menu2x()),
             exportMenu);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTargetWidget.java
Patch:
@@ -38,6 +38,7 @@
 import org.rstudio.core.client.widget.SecondaryToolbar;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -406,7 +407,7 @@ private Toolbar createToolbar()
       ToolbarPopupMenu menu = new ToolbarPopupMenu();
       menu.addItem(commands_.goToHelp().createMenuItem(false));
       menu.addItem(commands_.goToDefinition().createMenuItem(false));
-      ToolbarButton codeTools = new ToolbarButton(ToolbarButton.NoText, "Code Tools", icon, menu);
+      ToolbarMenuButton codeTools = new ToolbarMenuButton(ToolbarButton.NoText, "Code Tools", icon, menu);
       toolbar.addLeftWidget(codeTools);
       
       toolbar.addRightWidget(commands_.executeCode().createToolbarButton());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
@@ -114,7 +115,7 @@ public ToolbarButton getToolbarButton()
       {
          String buttonText = "Terminal";
          
-         toolbarButton_ = new ToolbarButton(
+         toolbarButton_ = new ToolbarMenuButton(
                 buttonText, 
                 ToolbarButton.NoTitle,
                 StandardIcons.INSTANCE.empty_command(),
@@ -303,7 +304,7 @@ private String getNextTerminalHandle()
       return null;
    }
 
-   private ToolbarButton toolbarButton_;
+   private ToolbarMenuButton toolbarButton_;
    private String activeTerminalHandle_;
    private TerminalList terminals_;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/BranchToolbarButton.java
Patch:
@@ -59,13 +59,14 @@
 import org.rstudio.core.client.widget.ScrollableToolbarPopupMenu;
 import org.rstudio.core.client.widget.SearchWidget;
 import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.common.icons.StandardIcons;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshHandler;
 import org.rstudio.studio.client.workbench.views.vcs.git.model.GitState;
 
-public class BranchToolbarButton extends ToolbarButton
+public class BranchToolbarButton extends ToolbarMenuButton
                                  implements HasValueChangeHandlers<String>,
                                             VcsRefreshHandler
 {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/CommitFilterToolbarButton.java
Patch:
@@ -17,7 +17,7 @@
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.ProgressOperationWithInput;
-import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.common.FileDialogs;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
@@ -33,7 +33,7 @@
 import com.google.gwt.user.client.ui.MenuItem;
 import com.google.inject.Inject;
 
-public class CommitFilterToolbarButton extends ToolbarButton
+public class CommitFilterToolbarButton extends ToolbarMenuButton
                                        implements HasValue<FileSystemItem>
 {
    @Inject

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/SVNPane.java
Patch:
@@ -21,6 +21,7 @@
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
+import org.rstudio.core.client.widget.ToolbarMenuButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.common.icons.StandardIcons;
 import org.rstudio.studio.client.common.vcs.StatusAndPath;
@@ -84,7 +85,7 @@ protected Toolbar createMainToolbar()
       moreMenu.addSeparator();
       moreMenu.addItem(commands_.showShellDialog().createMenuItem(false));
 
-      toolbar.addLeftWidget(new ToolbarButton(
+      toolbar.addLeftWidget(new ToolbarMenuButton(
           "More",
           ToolbarButton.NoTitle,
           new ImageResource2x(StandardIcons.INSTANCE.more_actions2x()),

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -289,7 +289,6 @@
    public abstract AppCommand presentationViewInBrowser();
    public abstract AppCommand presentationSaveAsStandalone();
    public abstract AppCommand activatePresentation();
-   public abstract AppCommand tutorialFeedback();
    public abstract AppCommand clearPresentationCache();
    
    // View

File: src/gwt/src/org/rstudio/core/client/command/AppMenuItem.java
Patch:
@@ -49,11 +49,12 @@ public void onShow()
          getElement().addClassName("disabled");
 
       setVisible(cmd_.isVisible());
+      setEnabled(cmd_.isEnabled());
 
       setHTML(cmd_.getMenuHTML(mainMenu_));
       setTitle(cmd_.getDesc());
    }
-   
+
    public boolean cmdVisible()
    {
       return cmd_.isVisible();

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -26,13 +26,11 @@
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.dom.client.*;
 import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DOM;
 import com.google.gwt.user.client.Event;
 import com.google.gwt.user.client.Timer;
 import com.google.gwt.user.client.ui.*;
 import com.google.gwt.user.client.ui.HasHorizontalAlignment.HorizontalAlignmentConstant;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.Point;
 import org.rstudio.core.client.a11y.A11y;
 import org.rstudio.core.client.command.ShortcutManager;

File: src/gwt/src/org/rstudio/core/client/widget/ShortcutInfoPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShortcutInfoPanel.java
  *
- * Copyright (C) 2009-13 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -80,7 +80,7 @@ protected Widget getShortcutContent()
       List<ShortcutInfo> shortcuts = 
             ShortcutManager.INSTANCE.getActiveShortcutInfo();
       String[][] groupNames = { 
-            new String[] { "Tabs", "Panes", "Files" },
+            new String[] { "Tabs", "Panes", "Files", "Main Menu (Server)" },
             new String[] { "Source Navigation", "Execute" },
             new String[] { "Source Editor", "Debug" }, 
             new String[] { "Source Control", "Build", "Console", "Terminal", "Other" }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -410,7 +410,8 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       {
          results.add(commands.toggleDocumentOutline());
       }
-      
+
+      results.add(commands.wordCount());
       results.add(commands.goToNextSection());
       results.add(commands.goToPrevSection());
       results.add(commands.goToNextChunk());

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -581,6 +581,7 @@
 
    // Other
    public abstract AppCommand checkSpelling();
+   public abstract AppCommand wordCount();
    public abstract AppCommand layoutZoomCurrentPane();
    public abstract AppCommand layoutEndZoom();
    public abstract AppCommand layoutConsoleOnLeft();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -352,6 +352,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.debugImportDump());
       dynamicCommands_.add(commands.goToLine());
       dynamicCommands_.add(commands.checkSpelling());
+      dynamicCommands_.add(commands.wordCount());
       dynamicCommands_.add(commands.codeCompletion());
       dynamicCommands_.add(commands.findUsages());
       dynamicCommands_.add(commands.debugBreakpoint());

File: src/gwt/src/org/rstudio/core/client/command/AppMenuItem.java
Patch:
@@ -49,11 +49,12 @@ public void onShow()
          getElement().addClassName("disabled");
 
       setVisible(cmd_.isVisible());
+      setEnabled(cmd_.isEnabled());
 
       setHTML(cmd_.getMenuHTML(mainMenu_));
       setTitle(cmd_.getDesc());
    }
-   
+
    public boolean cmdVisible()
    {
       return cmd_.isVisible();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -2586,18 +2586,21 @@ public void setMarks(JsMap<Position> marks)
    public void jumpToMatching()
    {
       widget_.getEditor().jumpToMatching(false, false);
+      scrollCursorIntoViewIfNecessary();
    }
 
    @Override
    public void selectToMatching()
    {
       widget_.getEditor().jumpToMatching(true, false);
+      scrollCursorIntoViewIfNecessary();
    }
 
    @Override
    public void expandToMatching()
    {
       widget_.getEditor().jumpToMatching(true, true);
+      scrollCursorIntoViewIfNecessary();
    }
    
    @Override

File: src/gwt/src/org/rstudio/core/client/command/AppMenuBar.java
Patch:
@@ -14,9 +14,9 @@
  */
 package org.rstudio.core.client.command;
 
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.event.shared.HandlerManager;
 import com.google.gwt.event.shared.HandlerRegistration;
-import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.ui.MenuBar;
 import com.google.gwt.user.client.ui.MenuItem;
 
@@ -36,13 +36,13 @@ public AppMenuBar(boolean vertical)
    }
 
    @Override
-   public MenuItem addItem(String text, Command cmd)
+   public MenuItem addItem(String text, ScheduledCommand cmd)
    {
       return addItem(text, false, cmd);
    }
 
    @Override
-   public MenuItem addItem(String text, boolean asHTML, Command cmd)
+   public MenuItem addItem(String text, boolean asHTML, ScheduledCommand cmd)
    {
       if (vertical_ && !asHTML)
          text = AppCommand.formatMenuLabel(null, text, null);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -33,7 +33,6 @@
 import com.google.gwt.view.client.ListDataProvider;
 
 import org.rstudio.core.client.Debug;
-import org.rstudio.core.client.cellview.AutoHidingSplitLayoutPanel;
 import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.studio.client.common.SuperDevMode;
@@ -722,7 +721,7 @@ private void redrawRowSafely(int idx)
    public static final int OBJECT_GRID_VIEW = 1;
 
    @UiField EnvironmentStyle style;
-   @UiField AutoHidingSplitLayoutPanel splitPanel;
+   @UiField SplitLayoutPanel splitPanel;
 
    EnvironmentObjectDisplay objectDisplay_;
    CallFramePanel callFramePanel_;

File: src/gwt/src/com/google/gwt/user/client/ui/MenuBar.java
Patch:
@@ -785,7 +785,7 @@ public void onPopupClosed(PopupPanel sender, boolean autoClosed) {
       closeAllParents();
     }
 
-    onHide(!autoClosed && focusOnHover);
+    onHide(!autoClosed);
     CloseEvent.fire(MenuBar.this, sender);
     // When the menu popup closes, remember that no item is
     // currently showing a popup menu.

File: src/gwt/src/com/google/gwt/user/client/ui/MenuBar.java
Patch:
@@ -1089,7 +1089,7 @@ void setMenuItemDebugIds(String baseID) {
    *
    * @param item the item with or without a submenu
    */
-  void updateSubmenuIcon(MenuItem item) {
+  protected void updateSubmenuIcon(MenuItem item) {
     // The submenu icon only applies to vertical menus
     if (!vertical) {
       return;
@@ -1105,7 +1105,7 @@ void updateSubmenuIcon(MenuItem item) {
     Element tr = DOM.getChild(container, idx);
     int tdCount = DOM.getChildCount(tr);
     MenuBar submenu = item.getSubMenu();
-    if (submenu == null) {
+    if (submenu == null || !item.isVisible()) {
       // Remove the submenu indicator
       if (tdCount == 2) {
         tr.removeChild(DOM.getChild(tr, 1));

File: src/gwt/src/org/rstudio/core/client/command/AppMenuBar.java
Patch:
@@ -14,9 +14,9 @@
  */
 package org.rstudio.core.client.command;
 
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.event.shared.HandlerManager;
 import com.google.gwt.event.shared.HandlerRegistration;
-import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.ui.MenuBar;
 import com.google.gwt.user.client.ui.MenuItem;
 
@@ -36,13 +36,13 @@ public AppMenuBar(boolean vertical)
    }
 
    @Override
-   public MenuItem addItem(String text, Command cmd)
+   public MenuItem addItem(String text, ScheduledCommand cmd)
    {
       return addItem(text, false, cmd);
    }
 
    @Override
-   public MenuItem addItem(String text, boolean asHTML, Command cmd)
+   public MenuItem addItem(String text, boolean asHTML, ScheduledCommand cmd)
    {
       if (vertical_ && !asHTML)
          text = AppCommand.formatMenuLabel(null, text, null);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -33,7 +33,6 @@
 import com.google.gwt.view.client.ListDataProvider;
 
 import org.rstudio.core.client.Debug;
-import org.rstudio.core.client.cellview.AutoHidingSplitLayoutPanel;
 import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.studio.client.common.SuperDevMode;
@@ -722,7 +721,7 @@ private void redrawRowSafely(int idx)
    public static final int OBJECT_GRID_VIEW = 1;
 
    @UiField EnvironmentStyle style;
-   @UiField AutoHidingSplitLayoutPanel splitPanel;
+   @UiField SplitLayoutPanel splitPanel;
 
    EnvironmentObjectDisplay objectDisplay_;
    CallFramePanel callFramePanel_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/editor/InputEditorDisplay.java
Patch:
@@ -57,6 +57,7 @@ public interface InputEditorDisplay extends HasAllFocusHandlers,
    boolean isCursorAtEnd();
    
    Position getCursorPosition();
+   void setCursorPosition(Position position);
    String getLanguageMode(Position position);
    
    void goToLineStart();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectList.java
Patch:
@@ -245,6 +245,8 @@ public SafeHtml render(String object)
             @Override
             public String getValue(RObjectEntry object)
             {
+               // We don't have ready access to the DOM (still under
+               // construction at this point), so we use a window method here.
                return "<div class=\"" + style_.colResizer() + "\" " +
                       "onmousedown=\"rstudio_beginResize(this, " +
                       "\'" + style_.nameCol() + "'" +
@@ -291,7 +293,6 @@ else if (newWidth > 500)
       }
    }-*/;
    
-   
    private void expandObject(final int index, final RObjectEntry object)
    {
       if (!object.expanded && 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/editor/InputEditorDisplay.java
Patch:
@@ -57,6 +57,7 @@ public interface InputEditorDisplay extends HasAllFocusHandlers,
    boolean isCursorAtEnd();
    
    Position getCursorPosition();
+   void setCursorPosition(Position position);
    String getLanguageMode(Position position);
    
    void goToLineStart();

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -69,6 +69,8 @@ protected ModalDialogBase(SimplePanel containerPanel, DialogRole role)
       A11y.setModal(getElement());
       firstControl_ = new Button("First");
       lastControl_ = new Button("Last");
+      Roles.getButtonRole().setAriaHiddenState(firstControl_.getElement(), true);
+      Roles.getButtonRole().setAriaHiddenState(lastControl_.getElement(), true);
       noDescription_ = new Label("Warning: dialog may not be accessible");
       noDescription_.getElement().setId("noDescription");
       DomUtils.visuallyHide(firstControl_.getElement());

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcessInfo.java
Patch:
@@ -59,7 +59,7 @@ public static final native ConsoleProcessInfo createNewTerminalInfo(
       procInfo.allow_restart = true;
       procInfo.title = "";
       procInfo.child_procs = true;
-      procInfo.shell_type = @org.rstudio.studio.client.workbench.views.terminal.TerminalShellInfo::SHELL_DEFAULT,
+      procInfo.shell_type = @org.rstudio.studio.client.workbench.prefs.model.UserPrefsAccessor::WINDOWS_TERMINAL_SHELL_DEFAULT;
       procInfo.channel_mode = @org.rstudio.studio.client.common.console.ConsoleProcessInfo::CHANNEL_RPC;
       procInfo.channel_id = "";
       procInfo.alt_buffer = false;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UserPrefsComputed.java
Patch:
@@ -34,7 +34,7 @@ public PrefValue<Boolean> haveRsaKey()
    
    public PrefValue<SpellingPrefsContext> spellingPrefsContext()
    {
-      return object("spelling_prefs_context", null);
+      return object("spelling", null);
    }
    
    public PrefValue<Boolean> enableCrashReporting()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -6799,7 +6799,7 @@ public void execute(Boolean arg) {
             new CommandWithArg<String>() {
                public void execute(String style)
                {
-                  docDisplay.setFoldStyle(style);
+                  docDisplay.setFoldStyle(FoldStyle.fromPref(style));
                }}));
       releaseOnDismiss.add(prefs.surroundSelection().bind(
             new CommandWithArg<String>() {

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialog.java
Patch:
@@ -46,6 +46,7 @@ public AboutDialog(ProductInfo info)
       }
       contents_ = new AboutDialogContents(info, editionInfo_);
       setWidth("600px");
+      setARIADescribedBy(contents_.getDescriptionElement());
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1569,7 +1569,7 @@ else if (event.getFileChange().getType() == FileChange.MODIFIED &&
          }
       }));
       
-      spelling_ = new TextEditingTargetSpelling(docDisplay_, docUpdateSentinel_, lintManager_);
+      spelling_ = new TextEditingTargetSpelling(docDisplay_, docUpdateSentinel_, lintManager_, prefs_);
 
 
       // show/hide the debug toolbar when the dirty state changes. (note:

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -827,7 +827,7 @@ public void withTestPackage(final Command command, boolean useTestThat)
    {
       String message = "Using shinytest";
       Dependency[] dependencies = new Dependency[] {
-         Dependency.cranPackage("shinytest", "1.2")
+         Dependency.cranPackage("shinytest", "1.3.1")
       };
 
       if (useTestThat) {

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -22,6 +22,7 @@
 import org.rstudio.core.client.widget.PreWidget;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.workbench.views.console.ConsoleResources;
+import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceTheme;
 
 import com.google.gwt.user.client.ui.Composite;
 
@@ -88,7 +89,8 @@ private void write(String output, String className)
    private String getErrorClass()
    {
       return styles_.output() + " " + 
-             RStudioGinjector.INSTANCE.getUserPrefs().getThemeErrorClass();
+             AceTheme.getThemeErrorClass(
+                RStudioGinjector.INSTANCE.getUserState().theme().getValue().cast());
    }
  
    PreWidget output_;

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -43,6 +43,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.CursorChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.CursorChangedHandler;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.PasteEvent;
+import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceTheme;
 
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.RepeatingCommand;
@@ -389,7 +390,8 @@ public void ensureInputVisible()
    private String getErrorClass()
    {
       return styles_.error() + " " + 
-             RStudioGinjector.INSTANCE.getUserPrefs().getThemeErrorClass();
+             AceTheme.getThemeErrorClass(
+                RStudioGinjector.INSTANCE.getUserState().theme().getValue().cast());
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java
Patch:
@@ -167,7 +167,7 @@ private boolean isWordIgnored(String word)
 
    private boolean ignoreUppercaseWord(String word)
    {
-      if (!userPrefs_.ignoreWordsInUppercase().getValue())
+      if (!userPrefs_.ignoreUppercaseWords().getValue())
          return false;
 
       for (char c: word.toCharArray())

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/SpellingPreferencesPane.java
Patch:
@@ -55,11 +55,11 @@ public SpellingPreferencesPane(GlobalDisplay globalDisplay,
       nudgeRight(customDictsWidget_);
       add(customDictsWidget_);
             
-      add(checkboxPref("Ignore words in UPPERCASE", prefs.ignoreWordsInUppercase()));
+      add(checkboxPref("Ignore words in UPPERCASE", prefs.ignoreUppercaseWords()));
       
-      add(checkboxPref("Ignore words with numbers", prefs.ignoreWordsInUppercase()));
+      add(checkboxPref("Ignore words with numbers", prefs.ignoreWordsWithNumbers()));
 
-      add(checkboxPref("Use real time spellchecking", prefs.realTimeSpellChecking()));
+      add(checkboxPref("Use real time spellchecking", prefs.realTimeSpellchecking()));
    }
 
    

File: src/gwt/src/org/rstudio/core/client/HtmlMessageListener.java
Patch:
@@ -27,7 +27,7 @@
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.workbench.prefs.events.UserPrefsChangedEvent;
-import org.rstudio.studio.client.workbench.prefs.events.UiPrefsChangedHandler;
+import org.rstudio.studio.client.workbench.prefs.events.UserPrefsChangedHandler;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceTheme;
 
@@ -46,7 +46,7 @@ public HtmlMessageListener(FileTypeRegistry fileTypeRegistry,
       
       initializeMessageListeners();
 
-      eventBus.addHandler(UserPrefsChangedEvent.TYPE, new UiPrefsChangedHandler() 
+      eventBus.addHandler(UserPrefsChangedEvent.TYPE, new UserPrefsChangedHandler() 
       {
          @Override
          public void onUiPrefsChanged(UserPrefsChangedEvent e)

File: src/gwt/src/org/rstudio/core/client/widget/RStudioThemedFrame.java
Patch:
@@ -134,7 +134,7 @@ private void addThemesStyle(String customStyle, String urlStyle, boolean removeB
             if (removeBodyStyle) body.removeAttribute("style");
             
             RStudioThemes.initializeThemes(
-              RStudioGinjector.INSTANCE.getUIPrefs(),
+              RStudioGinjector.INSTANCE.getUserPrefs(),
               document, document.getBody());
             
             body.addClassName("ace_editor_theme");

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -92,6 +92,7 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.SessionOpener;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
+import org.rstudio.studio.client.workbench.prefs.model.UserState;
 import org.rstudio.studio.client.workbench.snippets.SnippetHelper;
 import org.rstudio.studio.client.workbench.snippets.ui.EditSnippetsDialog;
 import org.rstudio.studio.client.workbench.ui.ConsoleTabPanel;
@@ -301,7 +302,8 @@ public interface RStudioGinjector extends Ginjector
    RnwWeaveRegistry getRnwWeaveRegistry();
    LatexProgramRegistry getLatexProgramRegistry();
    Commands getCommands();
-   UserPrefs getUIPrefs();
+   UserPrefs getUserPrefs();
+   UserState getUserState();
    Session getSession();
    HelpStrategy getHelpStrategy();
    ShortcutViewer getShortcutViewer();

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -88,7 +88,7 @@ private void write(String output, String className)
    private String getErrorClass()
    {
       return styles_.output() + " " + 
-             RStudioGinjector.INSTANCE.getUIPrefs().getThemeErrorClass();
+             RStudioGinjector.INSTANCE.getUserPrefs().getThemeErrorClass();
    }
  
    PreWidget output_;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RFileType.java
Patch:
@@ -42,7 +42,7 @@ public class RFileType extends TextFileType
    @Override
    public boolean getWordWrap()
    {
-      return RStudioGinjector.INSTANCE.getUIPrefs().softWrapRFiles().getValue();
+      return RStudioGinjector.INSTANCE.getUserPrefs().softWrapRFiles().getValue();
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/StanFileType.java
Patch:
@@ -40,7 +40,7 @@ public String getPreviewButtonText()
    @Override
    public boolean getWordWrap()
    {
-      return RStudioGinjector.INSTANCE.getUIPrefs().softWrapRFiles().getValue();
+      return RStudioGinjector.INSTANCE.getUserPrefs().softWrapRFiles().getValue();
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -389,7 +389,7 @@ public void ensureInputVisible()
    private String getErrorClass()
    {
       return styles_.error() + " " + 
-             RStudioGinjector.INSTANCE.getUIPrefs().getThemeErrorClass();
+             RStudioGinjector.INSTANCE.getUserPrefs().getThemeErrorClass();
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryPage.java
Patch:
@@ -95,7 +95,7 @@ protected void onAddWidgets()
       addWidget(newProjectParent_);
       
       // if git is available then add git init
-      UserPrefs uiPrefs = RStudioGinjector.INSTANCE.getUIPrefs();
+      UserPrefs uiPrefs = RStudioGinjector.INSTANCE.getUserPrefs();
       SessionInfo sessionInfo = 
          RStudioGinjector.INSTANCE.getSession().getSessionInfo();
       

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/RmdOutput.java
Patch:
@@ -64,7 +64,7 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.events.UserPrefsChangedEvent;
-import org.rstudio.studio.client.workbench.prefs.events.UiPrefsChangedHandler;
+import org.rstudio.studio.client.workbench.prefs.events.UserPrefsChangedHandler;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.views.source.SourceBuildHelper;
 import org.rstudio.studio.client.workbench.views.source.events.NotebookRenderFinishedEvent;
@@ -91,7 +91,7 @@ public class RmdOutput implements RmdRenderStartedEvent.Handler,
                                   NotebookRenderFinishedEvent.Handler,
                                   RmdRenderPendingEvent.Handler,
                                   QuitInitiatedHandler,
-                                  UiPrefsChangedHandler
+                                  UserPrefsChangedHandler
 {
    public interface Binder
    extends CommandBinder<Commands, RmdOutput> {}

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdTemplateChooser.java
Patch:
@@ -87,7 +87,7 @@ public void onResponseReceived(JsArray<RmdDocumentTemplate> templates)
             {
                final RmdDocumentTemplate template = templates.get(i);
 
-               String preferredTemplate = RStudioGinjector.INSTANCE.getUIPrefs()
+               String preferredTemplate = RStudioGinjector.INSTANCE.getUserPrefs()
                      .rmdPreferredTemplatePath().getValue();
 
                // create a template list item from the template; add it at the

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -180,8 +180,8 @@ public RSConnectDeploy(RSConnectPublishSource source,
          hideCheckUncheckAllButton();
       }
 
-      final boolean rsConnectEnabled = RStudioGinjector.INSTANCE.getUIPrefs()
-            .enableRStudioConnect().getGlobalValue();
+      final boolean rsConnectEnabled = RStudioGinjector.INSTANCE.getUserState()
+            .enableRsconnectPublishUi().getGlobalValue();
       
       // Invoke the "add account" wizard
       if (contentType == RSConnect.CONTENT_TYPE_APP || rsConnectEnabled)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -409,8 +409,8 @@ public void onChange(ChangeEvent event)
       rOptionsPanel.add(checkboxPref("Check arguments to R function calls", prefs.checkArgumentsToRFunctionCalls()));
       rOptionsPanel.add(checkboxPref("Check usage of '<-' in function call", prefs.checkUnexpectedAssignmentInFunctionCall()));
       rOptionsPanel.add(checkboxPref("Warn if variable used has no definition in scope", prefs.warnIfNoSuchVariableInScope()));
-      rOptionsPanel.add(checkboxPref("Warn if variable is defined but not used", prefs.warnIfVariableDefinedButNotUsed()));
-      rOptionsPanel.add(checkboxPref("Provide R style diagnostics (e.g. whitespace)", prefs.enableStyleDiagnostics()));
+      rOptionsPanel.add(checkboxPref("Warn if variable is defined but not used", prefs.warnVariableDefinedButNotUsed()));
+      rOptionsPanel.add(checkboxPref("Provide R style diagnostics (e.g. whitespace)", prefs.styleDiagnostics()));
       rOptionsPanel.setVisible(prefs.showDiagnosticsR().getValue());
       chkShowRDiagnostics.addValueChangeHandler(new ValueChangeHandler<Boolean>() {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -188,7 +188,7 @@ public void execute(Boolean succeeded)
       add(missingPkgPanel);
       
       final CheckBox chkEnableRSConnect = checkboxPref("Enable publishing to RStudio Connect",
-            userPrefs_.enableRStudioConnect());
+            userState_.enableRStudioConnect());
       final HorizontalPanel rsconnectPanel = checkBoxWithHelp(chkEnableRSConnect, 
                                                         "rstudio_connect");
       lessSpaced(rsconnectPanel);
@@ -404,6 +404,7 @@ private void setButtonEnabledState()
    
    private final GlobalDisplay display_;
    private final UserPrefs userPrefs_;
+   private final UserState userState_;
    private final RSConnectServerOperations server_;
    private final RSAccountConnector connector_;
    private final DependencyManager deps_;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/FontSizeManager.java
Patch:
@@ -28,7 +28,7 @@ public class FontSizeManager
    public FontSizeManager(final EventBus events,
                           UserPrefs prefs)
    {
-      prefs.fontSize().bind(new CommandWithArg<Double>()
+      prefs.fontSizePoints().bind(new CommandWithArg<Double>()
       {
          public void execute(Double value)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -49,7 +49,7 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.studio.client.workbench.prefs.events.UserPrefsChangedEvent;
-import org.rstudio.studio.client.workbench.prefs.events.UiPrefsChangedHandler;
+import org.rstudio.studio.client.workbench.prefs.events.UserPrefsChangedHandler;
 import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;
 import org.rstudio.studio.client.workbench.views.BasePresenter;
 import org.rstudio.studio.client.workbench.views.buildtools.events.BuildCompletedEvent;
@@ -199,7 +199,7 @@ public void onBuildCompleted(BuildCompletedEvent event)
       
       // invalidate devtools load all path whenever the project ui prefs
       // or working directory changes
-      eventBus.addHandler(UserPrefsChangedEvent.TYPE, new UiPrefsChangedHandler() 
+      eventBus.addHandler(UserPrefsChangedEvent.TYPE, new UserPrefsChangedHandler() 
       {
          @Override
          public void onUiPrefsChanged(UserPrefsChangedEvent e)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -693,7 +693,7 @@ private void indentPastedRange(Range range)
    {
       if (fileType_ == null ||
           !fileType_.canAutoIndent() ||
-          !RStudioGinjector.INSTANCE.getUIPrefs().reindentOnPaste().getValue())
+          !RStudioGinjector.INSTANCE.getUserPrefs().reindentOnPaste().getValue())
       {
          return;
       }
@@ -1344,7 +1344,7 @@ public void print()
          // the frame using the browser
          PrintIFrame printIFrame = new PrintIFrame(
                getCode(),
-               RStudioGinjector.INSTANCE.getUIPrefs().fontSize().getValue());
+               RStudioGinjector.INSTANCE.getUserPrefs().fontSizePoints().getValue());
          RootPanel.get().add(printIFrame);
       }
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -309,7 +309,7 @@ public void showErrorOutput(UnhandledError err)
          flushQueuedErrors();
       }
       
-      UserPrefs prefs =  RStudioGinjector.INSTANCE.getUIPrefs();
+      UserPrefs prefs =  RStudioGinjector.INSTANCE.getUserPrefs();
       ConsoleError error = new ConsoleError(err, prefs.getThemeErrorClass(), 
             this, null);
       error.setTracebackVisible(prefs.autoExpandErrorTracebacks().getValue());
@@ -590,7 +590,7 @@ public String getAllConsoleText()
    private String classOfOutput(int type)
    {
       if (type == ChunkConsolePage.CONSOLE_ERROR)
-        return RStudioGinjector.INSTANCE.getUIPrefs().getThemeErrorClass();
+        return RStudioGinjector.INSTANCE.getUserPrefs().getThemeErrorClass();
       else if (type == ChunkConsolePage.CONSOLE_INPUT)
         return "ace_keyword";
       return null;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionToolTip.java
Patch:
@@ -114,8 +114,8 @@ public static int tooltipTopPadding(DocDisplay docDisplay)
          if (docDisplay.getLine(lineNumberAbove).length() > 
              docDisplay.getLength(docDisplay.getCurrentLineNum()))
          {
-            Double fontPad = RStudioGinjector.INSTANCE.getUIPrefs()
-                  .fontSize().getValue();
+            Double fontPad = RStudioGinjector.INSTANCE.getUserPrefs()
+                  .fontSizePoints().getValue();
             if (fontPad >= 13)
                fontPad *= 1.3;
             topPad = topPad + fontPad.intValue();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -1345,7 +1345,7 @@ public void syncOutputMode()
          // otherwise, use the global preference to set the value
          docDisplay_.setShowChunkOutputInline(
             docDisplay_.getModeId() == "mode/rmarkdown" &&
-            RStudioGinjector.INSTANCE.getUIPrefs()
+            RStudioGinjector.INSTANCE.getUserPrefs()
                                      .showRmdChunkOutputInline().getValue());
       }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkRowExecState.java
Patch:
@@ -118,6 +118,7 @@ public void setState(int state)
          return;
       
       state_ = state;
+      resetTimer();
       if (state_ == LINE_RESTING)
       {
          timer_ = new Timer()

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoResources.java
Patch:
@@ -23,6 +23,6 @@ public interface TypoResources extends ClientBundle
 {
    TypoResources INSTANCE = GWT.create(TypoResources.class);
 
-   @Source("typo.js")
+   @Source("typo.min.js")
    StaticDataResource typojs();
 }

File: src/gwt/src/org/rstudio/core/client/widget/RStudioDataGrid.java
Patch:
@@ -74,7 +74,8 @@ protected void onLoad()
          Element el = children.getItem(i);
          com.google.gwt.dom.client.Style style = el.getStyle();
          String overflow = style.getOverflow();
-         if (!StringUtil.isNullOrEmpty(overflow))
+         String visibility = style.getVisibility();
+         if (StringUtil.equals(visibility, "hidden") && !StringUtil.isNullOrEmpty(overflow))
             style.setOverflowX(Overflow.HIDDEN);
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1667,6 +1667,7 @@ public void execute()
       
       syncPublishPath(document.getPath());
       initStatusBar();
+      lintManager_.relintAfterDelay(prefs_.documentLoadLintDelay().getValue());
    }
    
    private void updateBreakpointWarningBar()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetSpelling.java
Patch:
@@ -102,7 +102,7 @@ public JsArray<LintItem> getLint()
                   range.getEnd().getRow(),
                   range.getEnd().getColumn(),
                   "Spellcheck warning",
-                  "warning"));
+                  "spelling"));
             }
          }
       }
@@ -143,7 +143,7 @@ public void onCancelled()
    @Override
    public void invalidateAllWords()
    {
-      lintManager_.forceRelint();
+      lintManager_.relintAfterDelay(LintManager.DEFAULT_LINT_DELAY);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/application/model/ProductInfo.java
Patch:
@@ -26,4 +26,6 @@ protected ProductInfo() {}
    public String commit;
    public String build;
    public String notice;
+   public String date;
+   public String copyright_year;
 }

File: src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java
Patch:
@@ -98,7 +98,7 @@ void initialize(SpellingService spellingService, WorkbenchListManager workbenchL
    // word is deemed correct by the dictionary
    public boolean checkSpelling(String word)
    {
-      return typoNative_.check(word);
+      return allIgnoredWords_.contains(word) || typoNative_.check(word);
    }
 
    public void checkSpelling(List<String> words, final ServerRequestCallback<SpellCheckerResult> callback)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -137,7 +137,9 @@ public void onValueChange(ValueChangeEvent<DataImportOptions> dataImportOptions)
          }
       });
       
-      assembleDataImport(null);
+      if (path.isEmpty()) {
+         assembleDataImport(null);
+      }
       
       Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -137,7 +137,9 @@ public void onValueChange(ValueChangeEvent<DataImportOptions> dataImportOptions)
          }
       });
       
-      assembleDataImport(null);
+      if (path.isEmpty()) {
+         assembleDataImport(null);
+      }
       
       Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -137,7 +137,9 @@ public void onValueChange(ValueChangeEvent<DataImportOptions> dataImportOptions)
          }
       });
       
-      assembleDataImport(null);
+      if (path.isEmpty()) {
+         assembleDataImport(null);
+      }
       
       Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -28,7 +28,6 @@
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.SafeHtmlUtil;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.core.client.command.impl.DesktopMenuCallback;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.resources.ImageResource2x;

File: src/gwt/src/org/rstudio/core/client/command/ApplicationCommandManager.java
Patch:
@@ -18,7 +18,6 @@
 import org.rstudio.core.client.Pair;
 import org.rstudio.core.client.command.EditorCommandManager.EditorKeyBindings;
 import org.rstudio.core.client.command.KeyMap.KeyMapType;
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.core.client.files.FileBacked;
 import org.rstudio.core.client.events.ExecuteAppCommandEvent;
 import org.rstudio.core.client.events.RStudioKeybindingsChangedEvent;

File: src/gwt/src/org/rstudio/core/client/command/EditorCommandManager.java
Patch:
@@ -21,7 +21,6 @@
 
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.core.client.files.FileBacked;
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.core.client.js.JsUtil;

File: src/gwt/src/org/rstudio/core/client/command/KeyMap.java
Patch:
@@ -25,8 +25,6 @@
 import org.rstudio.core.client.Mutable;
 import org.rstudio.core.client.DirectedGraph.DefaultConstructor;
 import org.rstudio.core.client.DirectedGraph.ForEachNodeCommand;
-import org.rstudio.core.client.command.KeyboardShortcut.KeyCombination;
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.core.client.container.SafeMap;
 
 public class KeyMap

File: src/gwt/src/org/rstudio/core/client/command/UserCommandManager.java
Patch:
@@ -7,7 +7,6 @@
 import com.google.inject.Inject;
 import com.google.inject.Singleton;
 
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.server.remote.ExecuteUserCommandEvent;

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -68,7 +68,6 @@
 import org.rstudio.core.client.command.*;
 import org.rstudio.core.client.command.EditorCommandManager.EditorKeyBinding;
 import org.rstudio.core.client.command.EditorCommandManager.EditorKeyBindings;
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.core.client.command.ShortcutManager.Handle;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.DomUtils.ElementPredicate;

File: src/gwt/src/org/rstudio/studio/client/application/events/SetEditorCommandBindingsEvent.java
Patch:
@@ -16,7 +16,7 @@
 
 import java.util.List;
 
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
+import org.rstudio.core.client.command.KeySequence;
 
 import com.google.gwt.event.shared.EventHandler;
 import com.google.gwt.event.shared.GwtEvent;

File: src/gwt/src/org/rstudio/studio/client/common/vcs/ShowPublicKeyDialog.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.common.vcs;
 
 import org.rstudio.core.client.BrowseCap;
+import org.rstudio.core.client.command.KeyCombination;
 import org.rstudio.core.client.command.KeyboardShortcut;
 import org.rstudio.core.client.widget.FocusHelper;
 import org.rstudio.core.client.widget.FontSizer;
@@ -59,7 +60,7 @@ protected Widget createMainWidget()
       
       int mod = BrowseCap.hasMetaKey() ? KeyboardShortcut.META : 
                                          KeyboardShortcut.CTRL;
-      String cmdText = new KeyboardShortcut(mod, 'C').toString(true);
+      String cmdText = new KeyCombination("c", 'C', mod).toString(true);
       HTML label = new HTML("Press " + cmdText + 
                             " to copy the key to the clipboard");
       label.addStyleName(RES.styles().viewPublicKeyLabel());

File: src/gwt/src/org/rstudio/studio/client/workbench/addins/AddinsCommandManager.java
Patch:
@@ -11,7 +11,7 @@
 import org.rstudio.core.client.command.KeyMap;
 import org.rstudio.core.client.command.KeyMap.CommandBinding;
 import org.rstudio.core.client.command.KeyMap.KeyMapType;
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
+import org.rstudio.core.client.command.KeySequence;
 import org.rstudio.core.client.command.ShortcutManager;
 import org.rstudio.core.client.files.FileBacked;
 import org.rstudio.studio.client.application.events.EventBus;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionPopupPanel.java
Patch:
@@ -37,8 +37,8 @@
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.Rectangle;
 import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.command.KeyCombination;
 import org.rstudio.core.client.command.KeyboardShortcut;
-import org.rstudio.core.client.command.KeyboardShortcut.KeyCombination;
 import org.rstudio.core.client.command.ShortcutManager;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.events.SelectionCommitEvent;
@@ -449,8 +449,8 @@ private void registerIgnoredKeys()
    {
       resetIgnoredKeysHandle();
       Set<KeyCombination> keySet = new HashSet<KeyCombination>();
-      keySet.add(new KeyCombination(KeyCodes.KEY_N, KeyboardShortcut.CTRL));
-      keySet.add(new KeyCombination(KeyCodes.KEY_P, KeyboardShortcut.CTRL));
+      keySet.add(new KeyCombination("n", KeyCodes.KEY_N, KeyboardShortcut.CTRL));
+      keySet.add(new KeyCombination("p", KeyCodes.KEY_P, KeyboardShortcut.CTRL));
       handle_ = ShortcutManager.INSTANCE.addIgnoredKeys(keySet);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -58,7 +58,7 @@
 import org.rstudio.core.client.ExternalJavaScriptLoader.Callback;
 import org.rstudio.core.client.Rectangle;
 import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
+import org.rstudio.core.client.command.KeySequence;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.js.JsMap;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -15,10 +15,10 @@
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
 import org.rstudio.core.client.Rectangle;
+import org.rstudio.core.client.command.KeySequence;
 
 import java.util.List;
 
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.core.client.events.HasContextMenuHandlers;
 import org.rstudio.core.client.js.JsMap;
 import org.rstudio.studio.client.common.debugging.model.Breakpoint;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -40,6 +40,7 @@
 import org.rstudio.core.client.MathUtil;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppCommand;
+import org.rstudio.core.client.command.KeyCombination;
 import org.rstudio.core.client.command.KeyboardShortcut;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.events.EnsureHeightEvent;
@@ -320,7 +321,7 @@ private Toolbar createToolbar(TextFileType fileType)
       int mod = BrowseCap.hasMetaKey() ? KeyboardShortcut.META : 
          KeyboardShortcut.CTRL;
       String cmdText = 
-        new KeyboardShortcut(mod + KeyboardShortcut.SHIFT, 'K').toString(true);
+        new KeyCombination("K", 'K', mod + KeyboardShortcut.SHIFT).toString(true);
       cmdText = DomUtils.htmlToText(cmdText);
       notebookToolbarButton_.setTitle("Compile Report (" + cmdText + ")");
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceCommandManager.java
Patch:
@@ -7,9 +7,9 @@
 import com.google.gwt.core.client.JsArrayString;
 
 import org.rstudio.core.client.BrowseCap;
+import org.rstudio.core.client.command.KeyCombination;
+import org.rstudio.core.client.command.KeySequence;
 import org.rstudio.core.client.command.KeyboardHelper;
-import org.rstudio.core.client.command.KeyboardShortcut.KeyCombination;
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.core.client.js.JsUtil;
 

File: src/gwt/src/org/rstudio/core/client/command/KeySequence.java
Patch:
@@ -67,7 +67,7 @@ else if (sc.endsWith("+"))
          else
          {
             String[] keySplit = sc.split("[-+]");
-            String key = keySplit[keySplit.length - 1];
+            String key = StringUtil.capitalize(keySplit[keySplit.length - 1]);
             int keyCode = KeyboardHelper.keyCodeFromKeyName(key);
             keyCombination = new KeyCombination(key, keyCode, modifiers);
          }

File: src/gwt/src/org/rstudio/studio/client/server/Bool.java
Patch:
@@ -12,9 +12,9 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
-package org.rstudio.core.client.dom;
+package org.rstudio.studio.client.server;
 
-import com.google.gwt.dom.client.NativeEvent;
+import com.google.gwt.core.client.JavaScriptObject;
 
 public class Bool extends JavaScriptObject
 {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -19,7 +19,6 @@
 
 import java.util.List;
 
-import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.core.client.events.HasContextMenuHandlers;
 import org.rstudio.core.client.js.JsMap;
 import org.rstudio.studio.client.common.debugging.model.Breakpoint;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneConfig.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PaneConfig.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -79,8 +79,7 @@ public static String[] getAllTabs()
       // A list of all the tabs. Order matters; the Presentation tab must be the
       // last element in this array that's part of the first tabset (ts1)
       return new String[] {"Environment", "History", "Files", "Plots", "Connections",
-                           "Packages", "Help", "Build", "VCS", "Presentation",
-                           "Viewer"};
+                           "Packages", "Help", "Build", "VCS", "Viewer", "Presentation"};
    }
 
    public static String[] getAlwaysVisibleTabs()

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneConfig.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PaneConfig.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -79,8 +79,7 @@ public static String[] getAllTabs()
       // A list of all the tabs. Order matters; the Presentation tab must be the
       // last element in this array that's part of the first tabset (ts1)
       return new String[] {"Environment", "History", "Files", "Plots", "Connections",
-                           "Packages", "Help", "Build", "VCS", "Presentation",
-                           "Viewer"};
+                           "Packages", "Help", "Build", "VCS", "Viewer", "Presentation"};
    }
 
    public static String[] getAlwaysVisibleTabs()

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneConfig.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PaneConfig.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -79,8 +79,7 @@ public static String[] getAllTabs()
       // A list of all the tabs. Order matters; the Presentation tab must be the
       // last element in this array that's part of the first tabset (ts1)
       return new String[] {"Environment", "History", "Files", "Plots", "Connections",
-                           "Packages", "Help", "Build", "VCS", "Presentation",
-                           "Viewer"};
+                           "Packages", "Help", "Build", "VCS", "Viewer", "Presentation"};
    }
 
    public static String[] getAlwaysVisibleTabs()

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneConfig.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PaneConfig.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -79,8 +79,7 @@ public static String[] getAllTabs()
       // A list of all the tabs. Order matters; the Presentation tab must be the
       // last element in this array that's part of the first tabset (ts1)
       return new String[] {"Environment", "History", "Files", "Plots", "Connections",
-                           "Packages", "Help", "Build", "VCS", "Presentation",
-                           "Viewer"};
+                           "Packages", "Help", "Build", "VCS", "Viewer", "Presentation"};
    }
 
    public static String[] getAlwaysVisibleTabs()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/BusyPresenter.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * BusyPresenter.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -46,7 +46,7 @@ public void setIsBusy(boolean isBusy)
    @Override
    public void addBusyHandler(BusyHandler handler)
    {
-      // if a handler is added while when we're already busy, invoke the
+      // if a handler is added when we're already busy, invoke the
       // handler immediately
       if (isBusy())
          handler.onBusy(new BusyEvent(true));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/JobsPresenter.java
Patch:
@@ -24,14 +24,14 @@
 import org.rstudio.studio.client.workbench.views.BasePresenter;
 import org.rstudio.studio.client.workbench.views.jobs.events.JobUpdatedEvent;
 import org.rstudio.studio.client.workbench.views.jobs.events.JobElapsedTickEvent;
-import org.rstudio.studio.client.workbench.views.jobs.events.JobInitEvent;
 import org.rstudio.studio.client.workbench.views.jobs.events.JobOutputEvent;
 import org.rstudio.studio.client.workbench.views.jobs.events.JobSelectionEvent;
 import org.rstudio.studio.client.workbench.views.jobs.events.JobsPresenterEventHandlers;
 import org.rstudio.studio.client.workbench.views.jobs.events.JobsPresenterEventHandlersImpl;
 import org.rstudio.studio.client.workbench.views.jobs.model.Job;
 import org.rstudio.studio.client.workbench.views.jobs.model.JobConstants;
 import org.rstudio.studio.client.workbench.views.jobs.model.JobManager;
+import org.rstudio.studio.client.workbench.views.jobs.model.JobState;
 import org.rstudio.studio.client.workbench.views.jobs.view.JobsDisplay;
 
 import com.google.gwt.user.client.Command;
@@ -70,9 +70,9 @@ public void onJobUpdated(JobUpdatedEvent event)
    }
 
    @Override
-   public void onJobInit(JobInitEvent event)
+   public void setInitialJobs(JobState state)
    {
-      jobEventHandler_.onJobInit(event);
+      jobEventHandler_.setInitialJobs(state);
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/events/JobsPresenterEventHandlers.java
Patch:
@@ -14,10 +14,12 @@
  */
 package org.rstudio.studio.client.workbench.views.jobs.events;
 
+import org.rstudio.studio.client.workbench.views.jobs.model.JobState;
+
 public interface JobsPresenterEventHandlers extends JobUpdatedEvent.Handler,
-                                                    JobInitEvent.Handler,
                                                     JobOutputEvent.Handler,
                                                     JobSelectionEvent.Handler,
                                                     JobElapsedTickEvent.Handler
 {
+   void setInitialJobs(JobState state);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/renderrmd/RenderRmdOutputTab.java
Patch:
@@ -2,7 +2,7 @@
 /*
  * RenderRmdOutputTab.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -42,7 +42,6 @@ public abstract static class Shim extends
                  RestartStatusEvent.Handler,
                  ProvidesBusy
    {
-      abstract void initialize();
       abstract void confirmClose(Command onConfirmed);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/BusyPresenter.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * BusyPresenter.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -46,7 +46,7 @@ public void setIsBusy(boolean isBusy)
    @Override
    public void addBusyHandler(BusyHandler handler)
    {
-      // if a handler is added while when we're already busy, invoke the
+      // if a handler is added when we're already busy, invoke the
       // handler immediately
       if (isBusy())
          handler.onBusy(new BusyEvent(true));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/renderrmd/RenderRmdOutputTab.java
Patch:
@@ -2,7 +2,7 @@
 /*
  * RenderRmdOutputTab.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -42,7 +42,6 @@ public abstract static class Shim extends
                  RestartStatusEvent.Handler,
                  ProvidesBusy
    {
-      abstract void initialize();
       abstract void confirmClose(Command onConfirmed);
    }
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ClientEvent.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -35,7 +35,6 @@ class ClientEvent extends JavaScriptObject
    public static final String FileChanged = "file_changed";
    public static final String WorkingDirChanged = "working_dir_changed";
    public static final String PlotsStateChanged = "plots_state_changed";
-   public static final String ViewData = "view_data";
    public static final String PackageStatusChanged = "package_status_changed";
    public static final String PackageStateChanged = "package_state_changed";
    public static final String Locator = "locator";

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * WorkbenchServerOperations.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -42,7 +42,6 @@
 import org.rstudio.studio.client.workbench.views.choosefile.model.ChooseFileServerOperations;
 import org.rstudio.studio.client.workbench.views.connections.model.ConnectionsServerOperations;
 import org.rstudio.studio.client.workbench.views.console.model.ConsoleServerOperations;
-import org.rstudio.studio.client.workbench.views.data.model.DataServerOperations;
 import org.rstudio.studio.client.workbench.views.edit.model.EditServerOperations;
 import org.rstudio.studio.client.workbench.views.environment.dataimport.model.DataImportServerOperations;
 import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentServerOperations;
@@ -72,7 +71,6 @@ public interface WorkbenchServerOperations extends ConsoleServerOperations,
                                                    PlotsServerOperations,
                                                    EditServerOperations,
                                                    SourceServerOperations,
-                                                   DataServerOperations,
                                                    ChooseFileServerOperations,
                                                    HistoryServerOperations,
                                                    MirrorsServerOperations,

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * CompileOutputBufferWithHighlight.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -36,7 +36,7 @@ public CompileOutputBufferWithHighlight()
       output_.setStylePrimaryName(styles_.output());
       output_.addStyleName(styles_.paddedOutput());
       FontSizer.applyNormalFontSize(output_);
-      console_ = new VirtualConsole(output_.getElement());
+      console_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(output_.getElement());
     
       scrollPanel_ = new BottomScrollPanel();
       scrollPanel_.setSize("100%", "100%");

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleError.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ConsoleError.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -16,6 +16,7 @@
 package org.rstudio.studio.client.common.debugging.ui;
 
 import org.rstudio.core.client.VirtualConsole;
+import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.debugging.model.UnhandledError;
 
 import com.google.gwt.core.client.GWT;
@@ -56,7 +57,7 @@ public ConsoleError(UnhandledError err,
       
       initWidget(uiBinder.createAndBindUi(this));
       
-      VirtualConsole vc = new VirtualConsole(errorMessage.getElement());
+      VirtualConsole vc = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(errorMessage.getElement());
       vc.submit(err.getErrorMessage().trim());
       errorMessage.addStyleName(errorClass);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkInlineOutput.java
Patch:
@@ -2,7 +2,7 @@
 /*
  * ChunkInlineOutput.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -18,6 +18,7 @@
 import org.rstudio.core.client.VirtualConsole;
 import org.rstudio.core.client.widget.MiniPopupPanel;
 import org.rstudio.core.client.widget.PreWidget;
+import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleWriteErrorEvent;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleWriteErrorHandler;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleWriteOutputEvent;
@@ -48,7 +49,7 @@ public ChunkInlineOutput(String chunkId, final AnchoredSelection selection)
       super(true, false, true);
       
       console_ = new PreWidget();
-      vconsole_ = new VirtualConsole(console_.getElement());
+      vconsole_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(console_.getElement());
       chunkId_ = chunkId;
       selection_ = selection;
       state_ = State.Queued;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ChunkOutputStream.java
  *
- * Copyright (C) 2009-18 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -651,7 +651,7 @@ private void initConsole()
          console_.getElement().setInnerHTML("");
       }
       if (vconsole_ == null)
-         vconsole_ = new VirtualConsole(console_.getElement());
+         vconsole_ = RStudioGinjector.INSTANCE.getVirtualConsoleFactory().create(console_.getElement());
       else
          vconsole_.clear();
 

File: src/gwt/test/org/rstudio/core/client/AnsiCodeTests.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AnsiCodeTests.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-19 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,7 +14,6 @@
  */
 package org.rstudio.core.client;
 
-import org.rstudio.core.client.AnsiCode;
 import org.rstudio.core.client.regex.Match;
 import org.rstudio.core.client.regex.Pattern;
 

File: src/gwt/test/org/rstudio/core/client/StringUtilTests.java
Patch:
@@ -19,7 +19,6 @@
 import com.google.gwt.core.client.JavaScriptException;
 import com.google.gwt.junit.client.GWTTestCase;
 
-
 public class StringUtilTests extends GWTTestCase
 {
    @Override
@@ -128,11 +127,11 @@ public void testFormatDateNullInput()
       String result = StringUtil.formatDate(input);
       assertEquals(expected, result);
    }
-   
+
    public void testFormatDate()
    {
       String result = StringUtil.formatDate(new Date());
-      
+   
       // just check that it's got minimum valid length; don't want to 
       // mess with timezone awareness to do exact check
       // MMM d, yyyy, h:mm AM

File: src/gwt/src/org/rstudio/core/client/ConsoleOutputWriter.java
Patch:
@@ -148,7 +148,5 @@ public int getCurrentLines()
    private int lines_ = 0;
    private final PreWidget output_;
    private VirtualConsole virtualConsole_;
-   
-   // injected
    private VirtualConsoleFactory vcFactory_;
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -113,6 +113,7 @@
 import org.rstudio.studio.client.workbench.views.console.shell.assist.RCompletionManager;
 import org.rstudio.studio.client.workbench.views.jobs.events.JobsPresenterEventHandlersImpl;
 import org.rstudio.studio.client.workbench.views.jobs.model.JobManager;
+import org.rstudio.studio.client.workbench.views.jobs.view.JobItemFactory;
 import org.rstudio.studio.client.workbench.views.jobs.view.JobsDisplayImpl;
 import org.rstudio.studio.client.workbench.views.output.lint.LintManager;
 import org.rstudio.studio.client.workbench.views.packages.ui.CheckForUpdatesDialog;
@@ -322,4 +323,5 @@ public interface RStudioGinjector extends Ginjector
    JobManager getJobManager();
    SessionOpener getSessionOpener();
    VirtualConsoleFactory getVirtualConsoleFactory();
+   JobItemFactory getJobItemFactory();
 }

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -81,7 +81,7 @@ public ShellWidget(AceEditor editor, UIPrefs prefs, EventBus events)
       
       SelectInputClickHandler secondaryInputHandler = new SelectInputClickHandler();
 
-      output_ = new ConsoleOutputWriter();
+      output_ = new ConsoleOutputWriter(RStudioGinjector.INSTANCE.getVirtualConsoleFactory());
       output_.getWidget().setStylePrimaryName(styles_.output());
       output_.getWidget().addClickHandler(secondaryInputHandler);
       ElementIds.assignElementId(output_.getElement(), 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -2122,7 +2122,10 @@ public void autoDetectIndentation(boolean on)
 
       int indentSize = StringUtil.detectIndent(lines);
       if (indentSize > 0)
+      {
          setTabSize(indentSize);
+         setUseSoftTabs(true);
+      }
    }
 
    public void setShowInvisibles(boolean show)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -2122,7 +2122,10 @@ public void autoDetectIndentation(boolean on)
 
       int indentSize = StringUtil.detectIndent(lines);
       if (indentSize > 0)
+      {
          setTabSize(indentSize);
+         setUseSoftTabs(true);
+      }
    }
 
    public void setShowInvisibles(boolean show)

File: src/gwt/src/org/rstudio/core/client/widget/RStudioDataGrid.java
Patch:
@@ -15,6 +15,8 @@
 package org.rstudio.core.client.widget;
 
 import org.rstudio.core.client.BrowseCap;
+import org.rstudio.core.client.dom.DomUtils;
+
 import com.google.gwt.dom.client.Element;
 import com.google.gwt.dom.client.NodeList;
 import com.google.gwt.user.cellview.client.DataGrid;
@@ -63,7 +65,7 @@ protected void onLoad()
       // assigned class, and have all their style attributes applied inline, so
       // instead we scan the attached DOM subtree and change the inline styles.
       Element parent = getElement().getParentElement().getParentElement();
-      NodeList<Element> children = parent.getElementsByTagName("div");
+      NodeList<Element> children = DomUtils.querySelectorAll(parent, "div[style*='z-index: -1']");
       for (int i = 0; i < children.getLength(); i++)
       {
          Element el = children.getItem(i);

File: src/gwt/src/org/rstudio/core/client/cellview/ScrollingDataGrid.java
Patch:
@@ -15,15 +15,16 @@
 
 package org.rstudio.core.client.cellview;
 
-import com.google.gwt.user.cellview.client.DataGrid;
+import org.rstudio.core.client.widget.RStudioDataGrid;
+
 import com.google.gwt.user.client.ui.HeaderPanel;
 import com.google.gwt.user.client.ui.ScrollPanel;
 import com.google.gwt.view.client.ProvidesKey;
 
 // this class extends GWT's DataGrid with a single method that gives us access
 // to the scrolling panel used by the grid, which we need in order to
 // manipulate the scroll position directly (e.g. to save and restore it)
-public class ScrollingDataGrid<T> extends DataGrid<T>
+public class ScrollingDataGrid<T> extends RStudioDataGrid<T>
 {
    public ScrollingDataGrid(int pageSize, ProvidesKey<T> keyProvider)
    {

File: src/gwt/src/org/rstudio/studio/client/packrat/ui/PackratActionDialogContents.java
Patch:
@@ -17,6 +17,7 @@
 import java.util.ArrayList;
 
 import org.rstudio.core.client.JsArrayUtil;
+import org.rstudio.core.client.widget.RStudioDataGrid;
 import org.rstudio.studio.client.packrat.model.PackratPackageAction;
 import org.rstudio.studio.client.workbench.views.packages.ui.PackagesDataGridCommon;
 
@@ -45,7 +46,7 @@ public PackratActionDialogContents(
       prRestoreActionsList_ = new ArrayList<PackratPackageAction>();
       JsArrayUtil.fillList(prRestoreActionsArray, prRestoreActionsList_);
       
-      table_ = new DataGrid<PackratPackageAction>(prRestoreActionsList_.size(),
+      table_ = new RStudioDataGrid<PackratPackageAction>(prRestoreActionsList_.size(),
             (PackagesDataGridCommon)GWT.create(PackagesDataGridCommon.class));
       table_.setRowData(prRestoreActionsList_);
       

File: src/gwt/src/org/rstudio/studio/client/packrat/ui/PackratResolveConflictDialog.java
Patch:
@@ -20,6 +20,7 @@
 import org.rstudio.core.client.widget.MessageDialog;
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
+import org.rstudio.core.client.widget.RStudioDataGrid;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.StyleUtils;
 import org.rstudio.studio.client.packrat.model.PackratConflictActions;
@@ -70,7 +71,7 @@ public PackratResolveConflictDialog(
       mainWidget_.add(label);
             
       // table
-      table_ = new DataGrid<PackratConflictActions>(conflictActions.size(),
+      table_ = new RStudioDataGrid<PackratConflictActions>(conflictActions.size(),
             (PackagesDataGridCommon)GWT.create(PackagesDataGridCommon.class));
       StyleUtils.forceMacScrollbars(table_);
       table_.addStyleName(RESOURCES.styles().conflictsTable());

File: src/gwt/src/org/rstudio/studio/client/workbench/BrowseAddinsDialog.java
Patch:
@@ -47,6 +47,7 @@
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.ModifyKeyboardShortcutsWidget;
 import org.rstudio.core.client.widget.OperationWithInput;
+import org.rstudio.core.client.widget.RStudioDataGrid;
 import org.rstudio.core.client.widget.ThemedButton;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.HelpLink;
@@ -96,7 +97,7 @@ public Object getKey(RAddin addin)
          }
       };
       
-      table_ = new DataGrid<RAddin>(1000, RES, keyProvider_);
+      table_ = new RStudioDataGrid<RAddin>(1000, RES, keyProvider_);
       table_.setWidth("500px");
       table_.setHeight("400px");
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -54,6 +54,7 @@
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.Base64ImageCell;
 import org.rstudio.core.client.widget.OperationWithInput;
+import org.rstudio.core.client.widget.RStudioDataGrid;
 import org.rstudio.core.client.widget.SearchWidget;
 import org.rstudio.core.client.widget.SecondaryToolbar;
 import org.rstudio.core.client.widget.SlidingLayoutPanel;
@@ -100,7 +101,7 @@ public Object getKey(Connection connection)
       };
       
       selectionModel_ = new SingleSelectionModel<Connection>();
-      connectionsDataGrid_ = new DataGrid<Connection>(1000, RES, keyProvider_);
+      connectionsDataGrid_ = new RStudioDataGrid<Connection>(1000, RES, keyProvider_);
       connectionsDataGrid_.setSelectionModel(selectionModel_);
       selectionModel_.addSelectionChangeHandler(new SelectionChangeEvent.Handler()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -25,6 +25,7 @@
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.OperationWithInput;
+import org.rstudio.core.client.widget.RStudioDataGrid;
 import org.rstudio.core.client.widget.SearchWidget;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
@@ -311,7 +312,7 @@ private void createPackagesTable()
       try
       {
          packagesTableContainer_.clear();
-         packagesTable_ = new DataGrid<PackageInfo>(
+         packagesTable_ = new RStudioDataGrid<PackageInfo>(
             packagesDataProvider_.getList().size(), dataGridRes_);
       }
       catch (Exception e)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobsPaneWidgets.java
Patch:
@@ -166,19 +166,19 @@ public void setInitialJobs(List<Job> jobs)
    @Override
    public void addJob(Job job)
    {
-      list_.addJob(job, null);
+      list_.addJob(job);
    }
 
    @Override
    public void insertJob(Job job)
    {
-      list_.insertJob(job, null);
+      list_.insertJob(job);
    }
    
    @Override
    public void removeJob(Job job)
    {
-      list_.removeJob(job, null);
+      list_.removeJob(job);
    }
    
    @Override

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -50,6 +50,9 @@ public static Test suite()
       suite.addTestSuite(RChunkHeaderParserTests.class);
       suite.addTestSuite(SessionScopeTests.class);
       suite.addTestSuite(JobsListTests.class);
+      
+      // Pro-only tests
+      
       return suite;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -1102,7 +1102,6 @@ private void removeJobLauncherCommands()
       commands_.activateLauncherJobs().remove();
       commands_.sortLauncherJobsRecorded().remove();
       commands_.sortLauncherJobsState().remove();
-      commands_.refreshLauncherJobsList().remove();
    }
 
    private void pauseClientStateUpdater()

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -578,7 +578,6 @@
    public abstract AppCommand activateLauncherJobs();
    public abstract AppCommand sortLauncherJobsRecorded();
    public abstract AppCommand sortLauncherJobsState();
-   public abstract AppCommand refreshLauncherJobsList();
 
    // Other
    public abstract AppCommand checkSpelling();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/LauncherJobsPaneWidgets.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.jobs.view;
 
+import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
 import org.rstudio.core.client.widget.SlidingLayoutPanel;
@@ -32,7 +33,7 @@ public LauncherJobsPaneWidgets()
    @Override
    public Widget createMainWidget()
    {
-      return null;
+      return new Label();
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/LauncherJobsPaneWidgets.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.jobs.view;
 
+import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
 import org.rstudio.core.client.widget.SlidingLayoutPanel;
@@ -32,7 +33,7 @@ public LauncherJobsPaneWidgets()
    @Override
    public Widget createMainWidget()
    {
-      return null;
+      return new Label();
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectsServerOperations.java
Patch:
@@ -44,8 +44,8 @@ void createProject(String projectFile,
                       ProjectTemplateOptions projectTemplateOptions,
                       ServerRequestCallback<String> callback);
    
-   void createProjectFile(String projectFile,
-                          ServerRequestCallback<Boolean> callback);
+   void createProjectFile(String projectDir,
+                          ServerRequestCallback<String> callback);
    
    void packageSkeleton(String packageName,
                         String packageDirectory,

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -1935,11 +1935,11 @@ public void createProject(String projectFile,
    }
    
    @Override
-   public void createProjectFile(String projectFile,
-                                 ServerRequestCallback<Boolean> requestCallback)
+   public void createProjectFile(String projectDir,
+                                 ServerRequestCallback<String> requestCallback)
    {
       JSONArray params = new JSONArray();
-      params.set(0, new JSONString(StringUtil.notNull(projectFile)));
+      params.set(0, new JSONString(StringUtil.notNull(projectDir)));
       sendRequest(RPC_SCOPE, CREATE_PROJECT_FILE, params, requestCallback);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -896,7 +896,8 @@ private void doAddDisplayNameGeneric(SafeHtmlBuilder sb)
          // is a custom helpHandler provided, indicating that the "source"
          // isn't a package but rather some custom DollarNames scope)
          if ((RCompletionType.isFunctionType(type) ||
-             type == RCompletionType.SNIPPET) &&
+             type == RCompletionType.SNIPPET ||
+             type == RCompletionType.DATASET) &&
              helpHandler == null)
          {
             SafeHtmlUtil.appendSpan(

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -75,7 +75,7 @@ public PublishingPreferencesPane(GlobalDisplay globalDisplay,
       
       accountList_ = new RSConnectAccountList(server, globalDisplay, true, 
             true);
-      accountList_.setHeight("200px");
+      accountList_.setHeight("150px");
       accountList_.setWidth("300px");
       accountList_.getElement().getStyle().setMarginBottom(15, Unit.PX);
       accountList_.getElement().getStyle().setMarginLeft(3, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -75,7 +75,7 @@ public PublishingPreferencesPane(GlobalDisplay globalDisplay,
       
       accountList_ = new RSConnectAccountList(server, globalDisplay, true, 
             true);
-      accountList_.setHeight("200px");
+      accountList_.setHeight("150px");
       accountList_.setWidth("300px");
       accountList_.getElement().getStyle().setMarginBottom(15, Unit.PX);
       accountList_.getElement().getStyle().setMarginLeft(3, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -261,7 +261,6 @@ public void onSessionInit(SessionInitEvent sie)
       
       // create server event listener
       serverEventListener_ = new RemoteServerEventListener(this,
-                                                           eventBus_,
                                                            externalListener);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -7273,7 +7273,9 @@ public void onError(ServerError error)
          }
       });
    }
-   
+
+   public TextEditingTargetSpelling getSpellingTarget() { return this.spelling_; }
+
    private StatusBar statusBar_;
    private final DocDisplay docDisplay_;
    private final UIPrefs prefs_;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -340,7 +340,8 @@ else if (input.isConnectUIEnabled() && !input.isExternalUIEnabled())
             publishAsStatic(input);
          }
       }
-      else if (input.getContentType() == CONTENT_TYPE_WEBSITE)
+      else if (input.getContentType() == CONTENT_TYPE_WEBSITE ||
+               (input.getContentType() == CONTENT_TYPE_DOCUMENT && input.isWebsiteRmd()))
       {
          if (input.hasDocOutput())
          {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -180,7 +180,9 @@ private boolean supportedRPubsDocExtension(String filename)
          return false;
       
       String extension = FileSystemItem.getExtensionFromPath(filename).toLowerCase();
-      return StringUtil.equals(extension, ".html") || StringUtil.equals(extension, ".htm");
+      return StringUtil.equals(extension, ".html") || 
+             StringUtil.equals(extension, ".htm") ||
+             StringUtil.equals(extension, ".nb.html");
    }
 
    private void publishAsRPubs(RSConnectActionEvent event)

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -3494,7 +3494,7 @@ else if (error.getCode() == RpcError.INVALID_SESSION)
    private native void registerSatelliteCallback() /*-{
       var server = this;     
       $wnd.sendRemoteServerRequest = $entry(
-         function(sourceWindow, scope, method, params, redactLog, responseCallback) {
+         function(sourceWindow, scope, method, params, redactLog, resultFieldName, responseCallback) {
             server.@org.rstudio.studio.client.server.remote.RemoteServer::sendRemoteServerRequest(*)(sourceWindow, scope, method, params, redactLog, resultFieldName, responseCallback);
          }
       ); 

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewProjectWizard.java
Patch:
@@ -97,7 +97,7 @@ protected void onSelectorActivated()
    }
    
    @Override
-   protected NewProjectResult ammendInput(NewProjectResult result)
+   protected NewProjectResult amendInput(NewProjectResult result)
    {
       if (result != null)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobProgress.java
Patch:
@@ -67,6 +67,7 @@ public void showJob(Job job)
          progress_.setVisible(false);
          status += " " + StringUtil.friendlyDateTime(new Date(job.completed * 1000));
          elapsed_.setText(StringUtil.conciseElaspedTime(job.completed - job.started));
+         status_.setVisible(true);
       }
       else if (job.max > 0)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetSqlHelper.java
Patch:
@@ -21,7 +21,6 @@
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.remote.Expected;
 import org.rstudio.studio.client.sql.model.SqlServerOperations;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTarget;
 import com.google.inject.Inject;

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -1161,7 +1161,7 @@ public void getOutputPreview(String dataFilePath,
    
    @Override
    public void previewSql(String command,
-                          ServerRequestCallback<Void> requestCallback)
+                          ServerRequestCallback<String> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(command));

File: src/gwt/src/org/rstudio/studio/client/sql/model/SqlServerOperations.java
Patch:
@@ -14,11 +14,10 @@
  */
 package org.rstudio.studio.client.sql.model;
 
-import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildServerOperations;
 
 public interface SqlServerOperations extends BuildServerOperations
 {
-   void previewSql(String command, ServerRequestCallback<Void> requestCallback);
+   void previewSql(String command, ServerRequestCallback<String> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -1161,7 +1161,7 @@ public void getOutputPreview(String dataFilePath,
    
    @Override
    public void previewSql(String command,
-                          ServerRequestCallback<Void> requestCallback)
+                          ServerRequestCallback<String> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(command));

File: src/gwt/src/org/rstudio/studio/client/sql/model/SqlServerOperations.java
Patch:
@@ -14,11 +14,10 @@
  */
 package org.rstudio.studio.client.sql.model;
 
-import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildServerOperations;
 
 public interface SqlServerOperations extends BuildServerOperations
 {
-   void previewSql(String command, ServerRequestCallback<Void> requestCallback);
+   void previewSql(String command, ServerRequestCallback<String> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -110,6 +110,9 @@ public interface FileIconResources extends ClientBundle
    @Source("iconCss_2x.png")
    ImageResource iconCss2x();
 
+   @Source("iconScss_2x.png")
+   ImageResource iconScss2x();
+
    @Source("iconJavascript_2x.png")
    ImageResource iconJavascript2x();
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeCommands.java
Patch:
@@ -93,6 +93,8 @@ public TextFileType[] statusBarFileTypes()
       types.add(FileTypeRegistry.SH);
       types.add(FileTypeRegistry.HTML);
       types.add(FileTypeRegistry.CSS);
+      types.add(FileTypeRegistry.SASS);
+      types.add(FileTypeRegistry.SCSS);
       types.add(FileTypeRegistry.JS);
       types.add(FileTypeRegistry.CPP);
       types.add(FileTypeRegistry.PYTHON);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -110,6 +110,9 @@ public interface FileIconResources extends ClientBundle
    @Source("iconCss_2x.png")
    ImageResource iconCss2x();
 
+   @Source("iconScss_2x.png")
+   ImageResource iconScss2x();
+
    @Source("iconJavascript_2x.png")
    ImageResource iconJavascript2x();
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeCommands.java
Patch:
@@ -93,6 +93,7 @@ public TextFileType[] statusBarFileTypes()
       types.add(FileTypeRegistry.SH);
       types.add(FileTypeRegistry.HTML);
       types.add(FileTypeRegistry.CSS);
+      types.add(FileTypeRegistry.SCSS);
       types.add(FileTypeRegistry.JS);
       types.add(FileTypeRegistry.CPP);
       types.add(FileTypeRegistry.PYTHON);

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * EditorLanguage.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -74,6 +74,8 @@ public class EditorLanguage
          "ace/mode/toml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(
          "ace/mode/xml", false, false);
+   public static final EditorLanguage LANG_SCSS = new EditorLanguage(
+         "ace/mode/scss", false, true);
    
    public static final EditorLanguage LANG_GRAPHVIZ = new EditorLanguage("ace/mode/dot", false, true);
    public static final EditorLanguage LANG_CLOJURE = new EditorLanguage("ace/mode/clojure", false, true);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/SqlCompletionManager.java
Patch:
@@ -237,6 +237,7 @@ private boolean parseSqlTableScopedKeyword(String keyword,
          return false;
       
       String table = sqlIdentifierValue(it);
+      ctx.schemas.push("");
       ctx.tables.push(table);
       return true;
    }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -110,6 +110,7 @@
 import org.rstudio.studio.client.workbench.views.console.shell.assist.PythonCompletionManager;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.RCompletionManager;
 import org.rstudio.studio.client.workbench.views.jobs.model.JobManager;
+import org.rstudio.studio.client.workbench.views.jobs.view.JobsList;
 import org.rstudio.studio.client.workbench.views.output.lint.LintManager;
 import org.rstudio.studio.client.workbench.views.packages.ui.CheckForUpdatesDialog;
 import org.rstudio.studio.client.workbench.views.source.DocsMenu;
@@ -273,6 +274,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(SecondaryReposWidget widget);
    void injectMembers(SecondaryReposDialog widget);
    void injectMembers(CheckForUpdatesDialog dialog);
+   void injectMembers(JobsList widget);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -570,6 +570,7 @@
    public abstract AppCommand clearJobs();
    public abstract AppCommand activateJobs();
    public abstract AppCommand runSelectionAsJob();
+   public abstract AppCommand hideCompletedJobs();
 
    // Other
    public abstract AppCommand checkSpelling();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/JobManager.java
Patch:
@@ -187,8 +187,8 @@ public void onClearJobs()
    {
       display_.showYesNoMessage(
             GlobalDisplay.MSG_QUESTION, 
-            "Remove Completed Jobs", 
-            "Do you want to remove completed jobs from the list of jobs?\n\nYou can't undo this.", 
+            "Remove Completed Session Jobs",
+            "Do you want to remove completed session jobs from the list of jobs?\n\nYou can't undo this.",
             false, // include cancel
             () ->  server_.clearJobs(new VoidServerRequestCallback()),
             null,  // do nothing on No

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1403,7 +1403,7 @@ public void onNewSqlDoc()
            @Override
            public void execute(EditingTarget target)
            {
-              target.verifySqlPrerequisites(); 
+              target.verifyNewSqlPrerequisites(); 
               target.setSourceOnSave(true);
            }
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -67,7 +67,7 @@ public interface EditingTarget extends IsWidget,
    void verifyCppPrerequisites();
    void verifyPythonPrerequisites();
    void verifyD3Prerequisites();
-   void verifySqlPrerequisites();
+   void verifyNewSqlPrerequisites();
 
    void focus();
    void onActivate();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -478,7 +478,7 @@ public void verifyD3Prerequisites()
    }
 
    @Override
-   public void verifySqlPrerequisites()
+   public void verifyNewSqlPrerequisites()
    {
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -220,7 +220,7 @@ public void verifyD3Prerequisites()
    }
 
    @Override
-   public void verifySqlPrerequisites()
+   public void verifyNewSqlPrerequisites()
    {
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTarget.java
Patch:
@@ -180,7 +180,7 @@ public void verifyD3Prerequisites()
    }
 
    @Override
-   public void verifySqlPrerequisites()
+   public void verifyNewSqlPrerequisites()
    {
    }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/JobManager.java
Patch:
@@ -415,7 +415,7 @@ public void onError(ServerError error)
    
    private void showJobLauncherDialog(FileSystemItem path)
    {
-      JobLauncherDialog dialog = new JobLauncherDialog("Run Script as Job",
+      JobLauncherDialog dialog = new JobLauncherDialog("Run Script as Session Job",
             path.getName(),
             path,
             spec ->

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/JobManager.java
Patch:
@@ -415,7 +415,7 @@ public void onError(ServerError error)
    
    private void showJobLauncherDialog(FileSystemItem path)
    {
-      JobLauncherDialog dialog = new JobLauncherDialog("Run Script as Job",
+      JobLauncherDialog dialog = new JobLauncherDialog("Run Script as Session Job",
             path.getName(),
             path,
             spec ->

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobProgress.java
Patch:
@@ -64,6 +64,7 @@ public void showJob(Job job)
       {
          progress_.setVisible(true);
          progress_.setProgress(job.progress, job.max);
+         status_.setVisible(false);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobProgress.java
Patch:
@@ -64,6 +64,7 @@ public void showJob(Job job)
       {
          progress_.setVisible(true);
          progress_.setProgress(job.progress, job.max);
+         status_.setVisible(false);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPackratPreferencesPane.java
Patch:
@@ -226,7 +226,7 @@ private void verifyPrerequisites()
    {
       final ProgressIndicator indicator = getProgressIndicator();
       
-      indicator.onProgress("Verifying prequisites...");
+      indicator.onProgress("Verifying prerequisites...");
       
       server_.getPackratPrerequisites(
         new ServerRequestCallback<PackratPrerequisites>() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1285,7 +1285,7 @@ public void initialize(final SourceDocument document,
                                                           extendedType_, 
                                                           fileType_);
 
-      themeHelper_ = new TextEditingTargetThemeHelper(this, events_);
+      themeHelper_ = new TextEditingTargetThemeHelper(this, events_, releaseOnDismiss_);
       
       docUpdateSentinel_ = new DocUpdateSentinel(
             server_,

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -869,7 +869,7 @@ public void run()
          return;
       }
 
-      // ternery operator maps to appropriate files to list for deployment:
+      // ternary operator maps to appropriate files to list for deployment:
       // website code    - website code directory 
       // static website  - website build directory
       // document        - R Markdown document

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -964,8 +964,8 @@ public void execute(Boolean arg)
          initialChunkDefs_ = null;
          
          // sync to editor style changes
-         editingTarget_.addEditorThemeStyleChangedHandler(
-                                       TextEditingTargetNotebook.this);
+         releaseOnDismiss_.add(
+               editingTarget_.addEditorThemeStyleChangedHandler(TextEditingTargetNotebook.this));
          
          // read and/or set initial render width
          lastPlotWidth_ = notebookDoc_.getChunkRenderedWidth();

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -203,6 +203,8 @@ public interface ThemeStyles extends CssResource
    String terminalClearButton();
    String refreshToolbarButton();
 
+   String dataTableColumnWidget();
+
    String tabIcon();
    
    String menuCheckable();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTargetWidget.java
Patch:
@@ -115,6 +115,7 @@ public DataEditingTargetWidget(Commands commands,
          };
          table_.setDataViewerCallback(view);
          table_.setListViewerCallback(view);
+         table_.setColumnFrameCallback();
       });
 
       Widget mainWidget;

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -234,7 +234,7 @@ public ModifyKeyboardShortcutsWidget(String filterText)
       changes_ = new HashMap<KeyboardShortcutEntry, KeyboardShortcutEntry>();
       buffer_ = new KeySequence();
       
-      table_ = new DataGrid<KeyboardShortcutEntry>(1000, RES, KEY_PROVIDER);
+      table_ = new RStudioDataGrid<KeyboardShortcutEntry>(1000, RES, KEY_PROVIDER);
       
       FlowPanel emptyWidget = new FlowPanel();
       Label emptyLabel = new Label("No bindings available");

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -105,6 +105,7 @@
 import org.rstudio.studio.client.shiny.ui.ShinyApplicationPanel;
 import org.rstudio.studio.client.shiny.ui.ShinyApplicationView;
 import org.rstudio.studio.client.shiny.ui.ShinyApplicationWindow;
+import org.rstudio.studio.client.sql.model.SqlServerOperations;
 import org.rstudio.studio.client.vcs.VCSApplicationView;
 import org.rstudio.studio.client.vcs.ui.VCSApplicationWindow;
 import org.rstudio.studio.client.workbench.ClientStateUpdater;
@@ -422,6 +423,7 @@ protected void configure()
       bind(FindInFilesServerOperations.class).to(RemoteServer.class);
       bind(SynctexServerOperations.class).to(RemoteServer.class);
       bind(HTMLPreviewServerOperations.class).to(RemoteServer.class);
+      bind(SqlServerOperations.class).to(RemoteServer.class);
       bind(ShinyServerOperations.class).to(RemoteServer.class);
       bind(PlumberServerOperations.class).to(RemoteServer.class);
       bind(RSConnectServerOperations.class).to(RemoteServer.class);

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModuleOverlay.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RStudioGinModuleOverlay.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -160,6 +160,7 @@ void openTerminal(String terminalPath,
    void zoomActualSize();
    
    void setBackgroundColor(JsArrayInteger rgbColor);
+   void changeTitleBarColor(int r, int g, int b);
    void syncToEditorTheme(boolean isDark);
    
    void getEnableAccessibility(CommandWithArg<Boolean> callback);

File: src/gwt/src/org/rstudio/studio/client/application/events/ApplicationEventHandlers.java
Patch:
@@ -23,6 +23,7 @@ public interface ApplicationEventHandlers extends LogoutRequestedHandler,
                                                   SuicideHandler,
                                                   SessionAbendWarningHandler,
                                                   SessionSerializationHandler,
+                                                  SessionRelaunchHandler,
                                                   ServerUnavailableHandler,
                                                   ClientDisconnectedHandler,
                                                   InvalidClientVersionHandler,

File: src/gwt/src/org/rstudio/studio/client/application/model/RVersionsInfo.java
Patch:
@@ -49,7 +49,8 @@ public final native boolean getRestoreProjectRVersion() /*-{
    
    public final boolean isMultiVersion()
    {
-      return getAvailableRVersions() != null;
+      JsArray<RVersionSpec> versions = getAvailableRVersions();
+      return versions != null && versions.length() > 0;
    }
    
    public final native JsArray<RVersionSpec> getAvailableRVersions() /*-{

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/MirrorsServerOperations.java
Patch:
@@ -30,4 +30,7 @@ void getCRANMirrors(
    void validateCranRepo(
          ServerRequestCallback<Boolean> requestCallback,
          String cranRepoUrl);
+
+   void getCRANActives(
+   		 ServerRequestCallback<JsArray<CRANMirror>> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishReportSourcePage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishReportSourcePage.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -35,7 +35,7 @@ public PublishReportSourcePage(
          RSConnectPublishInput input,
          boolean asMultiple)
    {
-      super(title, subTitle, "Publish Source Code", icon, null, 
+      super(title, subTitle, "Publish to RStudio Connect", icon, null,
             createPages(input, asMultiple));
    }
 

File: src/gwt/src/org/rstudio/studio/client/server/Server.java
Patch:
@@ -21,11 +21,13 @@
 import org.rstudio.studio.client.common.shiny.model.ShinyServerOperations;
 import org.rstudio.studio.client.htmlpreview.model.HTMLPreviewServerOperations;
 import org.rstudio.studio.client.rsconnect.model.RSConnectServerOperations;
+import org.rstudio.studio.client.sql.model.SqlServerOperations;
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 
 public interface Server extends ApplicationServerOperations,
                                 WorkbenchServerOperations,
                                 HTMLPreviewServerOperations,
+                                SqlServerOperations,
                                 ShinyServerOperations,
                                 RSConnectServerOperations,
                                 RStudioAPIServerOperations,

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -148,6 +148,7 @@
    public abstract AppCommand joinLines();
    public abstract AppCommand removeLine();
    public abstract AppCommand splitIntoLines();
+   public abstract AppCommand editLinesFromStart();
    public abstract AppCommand toggleDocumentOutline();
    public abstract AppCommand expandSelection();
    public abstract AppCommand shrinkSelection();
@@ -567,6 +568,7 @@
    public abstract AppCommand startJob();
    public abstract AppCommand sourceAsJob();
    public abstract AppCommand clearJobs();
+   public abstract AppCommand activateJobs();
 
    // Other
    public abstract AppCommand checkSpelling();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/RMarkdownPreferencesPane.java
Patch:
@@ -41,6 +41,7 @@ public RMarkdownPreferencesPane(UIPrefs prefs,
       
       add(checkboxPref("Show inline toolbar for R code chunks", prefs_.showInlineToolbarForRCodeChunks()));
       add(checkboxPref("Show document outline by default", prefs_.showDocumentOutlineRmd()));
+      add(checkboxPref("Enable chunk background highlight", prefs_.highlightCodeChunks()));
       
       docOutlineDisplay_ = new SelectWidget(
             "Show in document outline: ",

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/ToolbarPane.java
Patch:
@@ -41,7 +41,9 @@ public void setProgress(boolean progress)
       ensureWidget();
 
       if (progress)
+      {
          progressPanel_.showProgress(progressDelayMs_);
+      }
       else
       {
          progressPanel_.setWidget(mainWidget_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/SqlCompletionParseContext.java
Patch:
@@ -24,6 +24,8 @@ public class SqlCompletionParseContext
 {
    public final JsVectorString identifiers = JsVectorString.createVector();
    public final JsVectorString tables = JsVectorString.createVector();
+   public final JsVectorString schemas = JsVectorString.createVector();
    public final JsMapString aliases = JsMapString.create();
+   public String contextKeyword = "";
    public boolean preferLowercaseKeywords = true;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/Job.java
Patch:
@@ -34,6 +34,9 @@ public class Job
    
    // the job's state (idle, running, completed, etc.)
    public int state;
+
+   // the job's type (session, ad-hoc)
+   public int type;
    
    // the number of progress units the job has completed so far
    public int progress;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/LocalJobProgress.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * GlobalJobProgress.java
+ * LocalJobProgress.java
  *
  * Copyright (C) 2009-18 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputPresenter.java
Patch:
@@ -59,6 +59,7 @@ void showDataOutput(JavaScriptObject data, NotebookFrameMetadata metadata,
    boolean hasOutput();
    boolean hasPlots();
    boolean hasErrors();
+   boolean hasHtmlWidgets();
    
    // notify of size changes
    void onResize();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputPresenter.java
Patch:
@@ -59,6 +59,7 @@ void showDataOutput(JavaScriptObject data, NotebookFrameMetadata metadata,
    boolean hasOutput();
    boolean hasPlots();
    boolean hasErrors();
+   boolean hasHtmlWidgets();
    
    // notify of size changes
    void onResize();

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -568,6 +568,7 @@
    public abstract AppCommand startJob();
    public abstract AppCommand sourceAsJob();
    public abstract AppCommand clearJobs();
+   public abstract AppCommand activateJobs();
 
    // Other
    public abstract AppCommand checkSpelling();

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -224,8 +224,7 @@ public void withRSConnect(String userAction,
       if (requiresRmarkdown)
          deps.addAll(rmarkdownDependencies());
       deps.add(Dependency.cranPackage("packrat", "0.4.8-1", true));
-      // deps.add(Dependency.cranPackage("rsconnect", "0.8.8"));
-      deps.add(Dependency.embeddedPackage("rsconnect"));
+      deps.add(Dependency.cranPackage("rsconnect", "0.8.11"));
       
       withDependencies(
         "Publishing",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java
Patch:
@@ -65,7 +65,9 @@ private void applyTheme(Document document, final AceTheme theme)
       // Build a relative path to avoid having to register 80000 theme URI handlers on the server.
       int pathUpCount = 0;
       String baseUrl = GWT.getHostPageBaseURL();
-      String currentUrl = document.getURL();
+      
+      // Strip any query out of the current URL since it isn't relevant to the path.
+      String currentUrl = document.getURL().split("\\?")[0];
       if (!currentUrl.equals(baseUrl) &&
          currentUrl.indexOf(baseUrl) == 0)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java
Patch:
@@ -65,7 +65,9 @@ private void applyTheme(Document document, final AceTheme theme)
       // Build a relative path to avoid having to register 80000 theme URI handlers on the server.
       int pathUpCount = 0;
       String baseUrl = GWT.getHostPageBaseURL();
-      String currentUrl = document.getURL();
+      
+      // Strip any query out of the current URL since it isn't relevant to the path.
+      String currentUrl = document.getURL().split("\\?")[0];
       if (!currentUrl.equals(baseUrl) &&
          currentUrl.indexOf(baseUrl) == 0)
       {

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -62,6 +62,8 @@ void getExistingDirectory(String caption,
    void clipboardCopy();
    void clipboardPaste();
    
+   void performWebAction(int action, Command onExecuted);
+   
    void setClipboardText(String text);
    void getClipboardText(CommandWithArg<String> callback);
    

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModuleOverlay.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RStudioGinModuleOverlay.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/Job.java
Patch:
@@ -34,6 +34,9 @@ public class Job
    
    // the job's state (idle, running, completed, etc.)
    public int state;
+
+   // the job's type (session, ad-hoc)
+   public int type;
    
    // the number of progress units the job has completed so far
    public int progress;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/JobsServerOperations.java
Patch:
@@ -26,4 +26,7 @@ void setJobListening(String id, boolean listening,
    void startJob(JobLaunchSpec spec, ServerRequestCallback<String> callback);
    void clearJobs(ServerRequestCallback<Void> callback);
    void executeJobAction(String id, String action, ServerRequestCallback<Void> callback);
+   void getLauncherJobsEnabled(ServerRequestCallback<Boolean> callback);
+   void startLauncherJobStatusStream(String jobId, ServerRequestCallback<Void> callback);
+   void stopLauncherJobStatusStream(String jobId, ServerRequestCallback<Void> callback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/LocalJobProgress.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * GlobalJobProgress.java
+ * LocalJobProgress.java
  *
  * Copyright (C) 2009-18 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -1280,7 +1280,7 @@ private void showAppError(String error)
       appErrorMessage_.setText(lines[lines.length - 1]);
       appErrorMessage_.setTitle(error);
    }
-
+   
    @UiField Anchor addAccountAnchor_;
    @UiField Anchor createNewAnchor_;
    @UiField Anchor urlAnchor_;

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -5630,7 +5630,7 @@ public void executeJobAction(String id, String action,
 
    @Override
    public void startJob(JobLaunchSpec spec, 
-                        ServerRequestCallback<Void> callback)
+                        ServerRequestCallback<String> callback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONObject(spec));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/JobsServerOperations.java
Patch:
@@ -23,7 +23,7 @@ public interface JobsServerOperations
 {
    void setJobListening(String id, boolean listening,
                         ServerRequestCallback<JsArray<JobOutput> > output);
-   void startJob(JobLaunchSpec spec, ServerRequestCallback<Void> callback); 
+   void startJob(JobLaunchSpec spec, ServerRequestCallback<String> callback);
    void clearJobs(ServerRequestCallback<Void> callback);
    void executeJobAction(String id, String action, ServerRequestCallback<Void> callback);
 }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishReportSourcePage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishReportSourcePage.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -35,7 +35,7 @@ public PublishReportSourcePage(
          RSConnectPublishInput input,
          boolean asMultiple)
    {
-      super(title, subTitle, "Publish Source Code", icon, null, 
+      super(title, subTitle, "Publish to RStudio Connect", icon, null,
             createPages(input, asMultiple));
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/ToolbarPane.java
Patch:
@@ -41,7 +41,9 @@ public void setProgress(boolean progress)
       ensureWidget();
 
       if (progress)
+      {
          progressPanel_.showProgress(progressDelayMs_);
+      }
       else
       {
          progressPanel_.setWidget(mainWidget_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -679,7 +679,6 @@ private void showBusyState()
       if (spinner_ != null)
       {
          spinner_.removeFromParent();
-         spinner_.detach();
          spinner_ = null;
       }
       // create a black or white spinner as appropriate
@@ -694,6 +693,7 @@ private void showBusyState()
       spinner_.getElement().getStyle().setOpacity(1);
       root_.getElement().getStyle().setOpacity(0.2);
 
+      spinner_.setVisible(true);
       clear_.setVisible(false);
       expand_.setVisible(false);
       popout_.setVisible(false);
@@ -708,8 +708,8 @@ private void showReadyState()
 
       if (spinner_ != null)
       {
+         spinner_.setVisible(false);
          spinner_.removeFromParent();
-         spinner_.detach();
          spinner_ = null;
       }
 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishReportSourcePage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishReportSourcePage.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -35,7 +35,7 @@ public PublishReportSourcePage(
          RSConnectPublishInput input,
          boolean asMultiple)
    {
-      super(title, subTitle, "Publish Source Code", icon, null, 
+      super(title, subTitle, "Publish to RStudio Connect", icon, null,
             createPages(input, asMultiple));
    }
 

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -234,7 +234,7 @@ public ModifyKeyboardShortcutsWidget(String filterText)
       changes_ = new HashMap<KeyboardShortcutEntry, KeyboardShortcutEntry>();
       buffer_ = new KeySequence();
       
-      table_ = new DataGrid<KeyboardShortcutEntry>(1000, RES, KEY_PROVIDER);
+      table_ = new RStudioDataGrid<KeyboardShortcutEntry>(1000, RES, KEY_PROVIDER);
       
       FlowPanel emptyWidget = new FlowPanel();
       Label emptyLabel = new Label("No bindings available");

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -3522,7 +3522,7 @@ private <T> void sendRequestViaMainWorkbench(
             scope, 
             method, 
             params.getJavaScriptObject(),
-            kwparams.getJavaScriptObject(),
+            kwparams == null ? JavaScriptObject.createObject() : kwparams.getJavaScriptObject(),
             redactLog, 
             new RpcResponseHandler() {
                @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ScopeManager.java
Patch:
@@ -35,7 +35,7 @@ public class ScopeManager
    public final native void onScopeEnd(Position position);
    public final native JsArray<Scope> getActiveScopes(Position position);
    public final native JsArray<Scope> getScopeList();
-   public final native void invalidateFrom(Position position);
+   public final native Position invalidateFrom(Position position);
    
    @JsOverlay
    public final Scope getScopeAt(Position position)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -342,15 +342,15 @@ protected void initialize(RPrefs rPrefs)
       // general prefs
       final GeneralPrefs generalPrefs = rPrefs.getGeneralPrefs();
       
-      boolean isSpawnerSession = session_.getSessionInfo().getSpawnerSession();
-      showServerHomePage_.setEnabled(!isSpawnerSession);
+      boolean isLauncherSession = session_.getSessionInfo().getLauncherSession();
+      showServerHomePage_.setEnabled(!isLauncherSession);
       
       reuseSessionsForProjectLinks_.setEnabled(true);
       saveWorkspace_.setEnabled(true);
       loadRData_.setEnabled(true);
       dirChooser_.setEnabled(true);
       
-      if (!isSpawnerSession)
+      if (!isLauncherSession)
          showServerHomePage_.setValue(generalPrefs.getShowUserHomePage());
       else
     	  showServerHomePage_.setValue("always");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ScopeManager.java
Patch:
@@ -35,7 +35,7 @@ public class ScopeManager
    public final native void onScopeEnd(Position position);
    public final native JsArray<Scope> getActiveScopes(Position position);
    public final native JsArray<Scope> getScopeList();
-   public final native void invalidateFrom(Position position);
+   public final native Position invalidateFrom(Position position);
    
    @JsOverlay
    public final Scope getScopeAt(Position position)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -76,7 +76,7 @@ public PackagesPreferencesPane(PreferencesDialogResources res,
       management.add(headerLabel("Package Management"));
 
       infoBar_ = new InfoBar(InfoBar.WARNING);
-      infoBar_.setText("CRAN repositories were modified outside package preferences.");
+      infoBar_.setText("CRAN repositories modified outside package preferences.");
       infoBar_.addStyleName(res_.styles().themeInfobar());
       spaced(infoBar_);
       

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -105,6 +105,7 @@
 import org.rstudio.studio.client.shiny.ui.ShinyApplicationPanel;
 import org.rstudio.studio.client.shiny.ui.ShinyApplicationView;
 import org.rstudio.studio.client.shiny.ui.ShinyApplicationWindow;
+import org.rstudio.studio.client.sql.model.SqlServerOperations;
 import org.rstudio.studio.client.vcs.VCSApplicationView;
 import org.rstudio.studio.client.vcs.ui.VCSApplicationWindow;
 import org.rstudio.studio.client.workbench.ClientStateUpdater;
@@ -422,6 +423,7 @@ protected void configure()
       bind(FindInFilesServerOperations.class).to(RemoteServer.class);
       bind(SynctexServerOperations.class).to(RemoteServer.class);
       bind(HTMLPreviewServerOperations.class).to(RemoteServer.class);
+      bind(SqlServerOperations.class).to(RemoteServer.class);
       bind(ShinyServerOperations.class).to(RemoteServer.class);
       bind(PlumberServerOperations.class).to(RemoteServer.class);
       bind(RSConnectServerOperations.class).to(RemoteServer.class);

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -160,6 +160,7 @@ void openTerminal(String terminalPath,
    void zoomActualSize();
    
    void setBackgroundColor(JsArrayInteger rgbColor);
+   void changeTitleBarColor(int r, int g, int b);
    void syncToEditorTheme(boolean isDark);
    
    void getEnableAccessibility(CommandWithArg<Boolean> callback);

File: src/gwt/src/org/rstudio/studio/client/server/Server.java
Patch:
@@ -21,11 +21,13 @@
 import org.rstudio.studio.client.common.shiny.model.ShinyServerOperations;
 import org.rstudio.studio.client.htmlpreview.model.HTMLPreviewServerOperations;
 import org.rstudio.studio.client.rsconnect.model.RSConnectServerOperations;
+import org.rstudio.studio.client.sql.model.SqlServerOperations;
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 
 public interface Server extends ApplicationServerOperations,
                                 WorkbenchServerOperations,
                                 HTMLPreviewServerOperations,
+                                SqlServerOperations,
                                 ShinyServerOperations,
                                 RSConnectServerOperations,
                                 RStudioAPIServerOperations,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/SqlCompletionParseContext.java
Patch:
@@ -24,6 +24,8 @@ public class SqlCompletionParseContext
 {
    public final JsVectorString identifiers = JsVectorString.createVector();
    public final JsVectorString tables = JsVectorString.createVector();
+   public final JsVectorString schemas = JsVectorString.createVector();
    public final JsMapString aliases = JsMapString.create();
+   public String contextKeyword = "";
    public boolean preferLowercaseKeywords = true;
 }

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -160,6 +160,7 @@ void openTerminal(String terminalPath,
    void zoomActualSize();
    
    void setBackgroundColor(JsArrayInteger rgbColor);
+   void changeTitleBarColor(int r, int g, int b);
    void syncToEditorTheme(boolean isDark);
    
    void getEnableAccessibility(CommandWithArg<Boolean> callback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkSatelliteWindow.java
Patch:
@@ -175,8 +175,6 @@ public void onChunkSatelliteCodeExecuting(ChunkSatelliteCodeExecutingEvent event
    @Override
    public void onChunkSatelliteCacheEditorStyle(ChunkSatelliteCacheEditorStyleEvent event)
    {
-      Debug.logToConsole("receiveEvent ChunkSatelliteCacheEditorStyleEvent: " + event.getDocId());
-
       String docId = chunkWindowParams_.getDocId();
       
       if (event.getDocId() != docId)

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -217,7 +217,7 @@ public void withRSConnect(String userAction,
       // build dependency array
       ArrayList<Dependency> deps = new ArrayList<Dependency>();
       deps.add(Dependency.cranPackage("RCurl", "1.95"));
-      deps.add(Dependency.cranPackage("RJSONIO", "1.0"));
+      deps.add(Dependency.cranPackage("jsonlite", "1.5"));
       deps.add(Dependency.cranPackage("openssl", "1.0.2"));
       deps.add(Dependency.cranPackage("rstudioapi", "0.5"));
       deps.add(Dependency.cranPackage("yaml", "2.1.5"));

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/MirrorsServerOperations.java
Patch:
@@ -30,4 +30,7 @@ void getCRANMirrors(
    void validateCranRepo(
          ServerRequestCallback<Boolean> requestCallback,
          String cranRepoUrl);
+
+   void getCRANActives(
+   		 ServerRequestCallback<JsArray<CRANMirror>> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/RMarkdownPreferencesPane.java
Patch:
@@ -41,6 +41,7 @@ public RMarkdownPreferencesPane(UIPrefs prefs,
       
       add(checkboxPref("Show inline toolbar for R code chunks", prefs_.showInlineToolbarForRCodeChunks()));
       add(checkboxPref("Show document outline by default", prefs_.showDocumentOutlineRmd()));
+      add(checkboxPref("Enable chunk background highlight", prefs_.highlightCodeChunks()));
       
       docOutlineDisplay_ = new SelectWidget(
             "Show in document outline: ",

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/MirrorsServerOperations.java
Patch:
@@ -30,4 +30,7 @@ void getCRANMirrors(
    void validateCranRepo(
          ServerRequestCallback<Boolean> requestCallback,
          String cranRepoUrl);
+
+   void getCRANActives(
+   		 ServerRequestCallback<JsArray<CRANMirror>> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -6280,10 +6280,9 @@ else if (fileType_.canPreviewFromR())
                {
                   previewFromR();
                }
-               else if (fileType_.isR())
+               else if (fileType_.isR() && extendedType_ == SourceDocument.XT_R_CUSTOM_SOURCE)
                {
-                  if (extendedType_ == SourceDocument.XT_R_CUSTOM_SOURCE)
-                     customSource();
+                  customSource();
                }
                else
                {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/model/ThemeServerOperations.java
Patch:
@@ -28,4 +28,6 @@ public interface ThemeServerOperations
    void addTheme(ServerRequestCallback<String> request, String themeLocation);
    
    void removeTheme(ServerRequestCallback<Void> request, String themeName);
+   
+   void getThemeName(ServerRequestCallback<String> request, String themeLocation);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -32,6 +32,7 @@
 import java.util.ArrayList;
 
 import org.rstudio.core.client.BrowseCap;
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.DialogTabLayoutPanel;
 import org.rstudio.core.client.widget.InfoBar;
@@ -353,6 +354,7 @@ public void onResponseReceived(JsArray<CRANMirror> mirrors)
             @Override
             public void onError(ServerError error)
             {
+               Debug.logError(error);
             }
          }
       );

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/MirrorsServerOperations.java
Patch:
@@ -30,4 +30,7 @@ void getCRANMirrors(
    void validateCranRepo(
          ServerRequestCallback<Boolean> requestCallback,
          String cranRepoUrl);
+
+   void getCRANActives(
+   		 ServerRequestCallback<JsArray<CRANMirror>> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCommentHeaderHelper.java
Patch:
@@ -88,7 +88,7 @@ public TextEditingTargetCommentHeaderHelper(String code, String keyword, String
       RStudioGinjector.INSTANCE.injectMembers(this);
 
       customHeaderPattern_ = Pattern.create(
-         "^" + comment + "\\s*!" + keyword + "\\s*([.a-zA-Z]+[.a-zA-Z0-9:_]*)?\\s*(\\s+|\\()(.*)$",
+         "^" + comment + "\\s*!" + keyword + "\\s*([.a-zA-Z]+[.a-zA-Z0-9:_]*)?\\s*(\\s+|\\(|$)(.*)$",
          ""
       );
 

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -216,10 +216,9 @@ public void withRSConnect(String userAction,
    {
       // build dependency array
       ArrayList<Dependency> deps = new ArrayList<Dependency>();
-      deps.add(Dependency.cranPackage("digest", "0.6"));
       deps.add(Dependency.cranPackage("RCurl", "1.95"));
       deps.add(Dependency.cranPackage("RJSONIO", "1.0"));
-      deps.add(Dependency.cranPackage("PKI", "0.1"));
+      deps.add(Dependency.cranPackage("openssl", "1.0.2"));
       deps.add(Dependency.cranPackage("rstudioapi", "0.5"));
       deps.add(Dependency.cranPackage("yaml", "2.1.5"));
       if (requiresRmarkdown)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/r/SignatureToolTipManager.java
Patch:
@@ -164,9 +164,9 @@ public void execute()
                   if (anchor_ == null || !toolTip_.isShowing())
                      return;
                   
-                  Position position = event.getPosition();
-                  if (position == null)
-                     return;
+                  // re-request cursor position in case it's changed since the
+                  // last cursor change without signaling event handlers
+                  Position position = docDisplay_.getCursorPosition();
                   
                   if (anchor_.getRange().contains(position))
                   {

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -1085,7 +1085,7 @@ public void onDragStart(DragStartEvent evt)
 
          contentPanel_ = new HorizontalPanel();
          contentPanel_.setTitle(tooltip);
-         contentPanel_.setStylePrimaryName(styles_.tabLayoutCenter());
+         contentPanel_.setStylePrimaryName(styles_.rstheme_tabLayoutCenter());
          contentPanel_.setVerticalAlignment(HasVerticalAlignment.ALIGN_MIDDLE);
 
          if (icon != null) {

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedWindowFrame.java
Patch:
@@ -54,15 +54,15 @@ public MinimizedWindowFrame(String title, Widget extraWidget)
 
       layout_ = new ClickDockLayoutPanel(Style.Unit.PX);
       layout_.setStylePrimaryName(themeStyles.minimizedWindow());
-      layout_.addStyleName(themeStyles.minimizedWindowObject());
+      layout_.addStyleName(themeStyles.rstheme_minimizedWindowObject());
 
       int leftPadding = title != null ? 8 : 4;
       layout_.addWest(createDiv(themeStyles.left()), leftPadding);
       layout_.addEast(createDiv(themeStyles.right()), 8);
 
       HorizontalPanel inner = new HorizontalPanel();
       inner.setWidth("100%");
-      inner.setStylePrimaryName(themeStyles.center());
+      inner.setStylePrimaryName(themeStyles.rstheme_center());
 
       if (title != null)
       {

File: src/gwt/src/org/rstudio/core/client/theme/ModuleTabLayoutPanel.java
Patch:
@@ -49,7 +49,7 @@ public ModuleTab(String title, ThemeStyles styles, boolean canClose)
          layoutPanel_.add(left);
 
          HorizontalPanel center = new HorizontalPanel();
-         center.setStylePrimaryName(styles.tabLayoutCenter());
+         center.setStylePrimaryName(styles.rstheme_tabLayoutCenter());
          Label label = new Label(title, false);
          center.add(label);
          if (canClose)

File: src/gwt/src/org/rstudio/core/client/widget/SecondaryToolbar.java
Patch:
@@ -26,7 +26,7 @@ public SecondaryToolbar(boolean appearAsPrimary)
       super();
       
       if (!appearAsPrimary)
-         addStyleName(styles_.secondaryToolbar());
+         addStyleName(styles_.rstheme_secondaryToolbar());
    }
 
    @Override

File: src/gwt/src/org/rstudio/core/client/widget/Toolbar.java
Patch:
@@ -130,7 +130,7 @@ public Toolbar()
       toolbarWrapper_.add(horizontalPanel_);
       initWidget(toolbarWrapper_);
 
-      setStyleName(styles_.toolbarWrapper());
+      setStyleName(styles_.rstheme_toolbarWrapper());
    }
 
    protected void manageSeparators()

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchTabPanel.java
Patch:
@@ -63,7 +63,7 @@ public WorkbenchTabPanel(WindowFrame owner, LogicalWindow parentWindow)
 
       utilPanel_ = new HTML();
       utilPanel_.setStylePrimaryName(ThemeStyles.INSTANCE.multiPodUtilityArea());
-      utilPanel_.addStyleName(ThemeStyles.INSTANCE.multiPodUtilityTabArea());
+      utilPanel_.addStyleName(ThemeStyles.INSTANCE.rstheme_multiPodUtilityTabArea());
       panel_.add(utilPanel_);
       panel_.setWidgetRightWidth(utilPanel_,
                                  0, Unit.PX,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionExplorer.java
Patch:
@@ -46,7 +46,7 @@ public ConnectionExplorer()
       disconnectedUI_.setWidth("100%");
       disconnectedUI_.setVerticalAlignment(HasVerticalAlignment.ALIGN_TOP);
       codePanel_ = new ConnectionCodePanel(false);
-      codePanel_.addStyleName(ThemeStyles.INSTANCE.toolbarWrapper());
+      codePanel_.addStyleName(ThemeStyles.INSTANCE.rstheme_toolbarWrapper());
       codePanel_.addStyleName(ThemeStyles.INSTANCE.secondaryToolbarPanel());
       codePanel_.getElement().getStyle().setPadding(8, Unit.PX);
       codePanel_.setHeight((codePanelHeight-5) + "px");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilePathToolbar.java
Patch:
@@ -109,8 +109,8 @@ public FilePathToolbar(Files.Display.NavigationObserver navigationObserver, bool
       layout.setSize("100%", "21px");
 
       initWidget(layout);
-      addStyleName(ThemeStyles.INSTANCE.toolbarWrapper());
-      addStyleName(ThemeStyles.INSTANCE.secondaryToolbar());
+      addStyleName(ThemeStyles.INSTANCE.rstheme_toolbarWrapper());
+      addStyleName(ThemeStyles.INSTANCE.rstheme_secondaryToolbar());
 
       navigationObserver_ = navigationObserver;
       

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/model/Dependency.java
Patch:
@@ -29,7 +29,9 @@ protected Dependency()
    
    public static Dependency cranPackage(String name)
    {
-      return cranPackage(name, "", false);
+      // use version '0.0.0' just to indicate that any currently installed
+      // version of the requested package should suffice
+      return cranPackage(name, "0.0.0", false);
    }
    
    public static Dependency cranPackage(String name, 

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectTemplateOptions.java
Patch:
@@ -32,4 +32,7 @@ public static final native ProjectTemplateOptions create(ProjectTemplateDescript
          inputs: inputs
       };
    }-*/;
+   
+   public final native ProjectTemplateDescription getDescription() /*-{ return this.description; }-*/;
+   public final native JsObject getInputs() /*-{ return this.inputs; }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/SqlCompletionManager.java
Patch:
@@ -169,12 +169,12 @@ private boolean parseSqlInto(TokenIterator it, SqlCompletionParseContext ctx)
    
    private boolean parseSqlJoin(TokenIterator it, SqlCompletionParseContext ctx)
    {
-      return parseSqlTableScopedKeyword("into", it, ctx);
+      return parseSqlTableScopedKeyword("join", it, ctx);
    }
    
    private boolean parseSqlUpdate(TokenIterator it, SqlCompletionParseContext ctx)
    {
-      return parseSqlTableScopedKeyword("into", it, ctx);
+      return parseSqlTableScopedKeyword("update", it, ctx);
    }
    
    private boolean parseSqlIdentifier(TokenIterator it, SqlCompletionParseContext ctx)

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -225,7 +225,8 @@ public void withRSConnect(String userAction,
       if (requiresRmarkdown)
          deps.addAll(rmarkdownDependencies());
       deps.add(Dependency.cranPackage("packrat", "0.4.8-1", true));
-      deps.add(Dependency.cranPackage("rsconnect", "0.8.8"));
+      // deps.add(Dependency.cranPackage("rsconnect", "0.8.8"));
+      deps.add(Dependency.embeddedPackage("rsconnect"));
       
       withDependencies(
         "Publishing",

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishFilesPage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishCodePage.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -56,6 +56,7 @@ public PublishFilesPage(String title, String subTitle, ImageResource icon,
                               input.getOriginatingEvent().getPath(),
                               input.getOriginatingEvent().getHtmlFile(),
                               input.getWebsiteDir(),
+                              input.getWebsiteOutputDir(),
                               input.isSelfContained(),
                               asStatic,
                               input.isShiny(),

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishRPubsPage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishRPubsPage.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -58,6 +58,7 @@ protected RSConnectPublishResult collectInput()
                   initialData_.getOriginatingEvent().getPath(), 
                   initialData_.getOriginatingEvent().getHtmlFile(),
                   null, // website directory
+                  null, // website output directory
                   initialData_.isSelfContained(),
                   true, // as static
                   initialData_.isShiny(),

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -1077,7 +1077,7 @@ else if (contentType_ == RSConnect.CONTENT_TYPE_PLOT)
          illustration = new ImageResource2x(RESOURCES.publishPlotIllustration2x());
       else if (contentType_ == RSConnect.CONTENT_TYPE_DOCUMENT)
          illustration = new ImageResource2x(RESOURCES.publishRmdIllustration2x());
-      else if (contentType_ == RSConnect.CONTENT_TYPE_HTML)
+      else if (contentType_ == RSConnect.CONTENT_TYPE_HTML || contentType_ == RSConnect.CONTENT_TYPE_WEBSITE)
          illustration = new ImageResource2x(RESOURCES.publishHTMLIllustration2x());
       else if (contentType_ == RSConnect.CONTENT_TYPE_PRES)
          illustration = new ImageResource2x(RESOURCES.publishPresentationIllustration2x());

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -225,7 +225,8 @@ public void withRSConnect(String userAction,
       if (requiresRmarkdown)
          deps.addAll(rmarkdownDependencies());
       deps.add(Dependency.cranPackage("packrat", "0.4.8-1", true));
-      deps.add(Dependency.cranPackage("rsconnect", "0.8.8"));
+      // deps.add(Dependency.cranPackage("rsconnect", "0.8.8"));
+      deps.add(Dependency.embeddedPackage("rsconnect"));
       
       withDependencies(
         "Publishing",

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishFilesPage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishCodePage.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -56,6 +56,7 @@ public PublishFilesPage(String title, String subTitle, ImageResource icon,
                               input.getOriginatingEvent().getPath(),
                               input.getOriginatingEvent().getHtmlFile(),
                               input.getWebsiteDir(),
+                              input.getWebsiteOutputDir(),
                               input.isSelfContained(),
                               asStatic,
                               input.isShiny(),

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishRPubsPage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishRPubsPage.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -58,6 +58,7 @@ protected RSConnectPublishResult collectInput()
                   initialData_.getOriginatingEvent().getPath(), 
                   initialData_.getOriginatingEvent().getHtmlFile(),
                   null, // website directory
+                  null, // website output directory
                   initialData_.isSelfContained(),
                   true, // as static
                   initialData_.isShiny(),

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -1077,7 +1077,7 @@ else if (contentType_ == RSConnect.CONTENT_TYPE_PLOT)
          illustration = new ImageResource2x(RESOURCES.publishPlotIllustration2x());
       else if (contentType_ == RSConnect.CONTENT_TYPE_DOCUMENT)
          illustration = new ImageResource2x(RESOURCES.publishRmdIllustration2x());
-      else if (contentType_ == RSConnect.CONTENT_TYPE_HTML)
+      else if (contentType_ == RSConnect.CONTENT_TYPE_HTML || contentType_ == RSConnect.CONTENT_TYPE_WEBSITE)
          illustration = new ImageResource2x(RESOURCES.publishHTMLIllustration2x());
       else if (contentType_ == RSConnect.CONTENT_TYPE_PRES)
          illustration = new ImageResource2x(RESOURCES.publishPresentationIllustration2x());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -586,7 +586,9 @@ else if (keyCode == KeyCodes.KEY_ENTER && (
          }
          else if (
                (keyCode == KeyCodes.KEY_ESCAPE && modifiers == 0) ||
-               (!BrowseCap.isWindows() && (keyCode == KeyCodes.KEY_C && modifiers == KeyboardShortcut.CTRL)))
+               (BrowseCap.isMacintoshDesktop() && (
+                     modifiers == KeyboardShortcut.CTRL &&
+                     keyCode == KeyCodes.KEY_C)))
          {
             event.preventDefault();
 

File: src/gwt/src/org/rstudio/core/client/StringUtil.java
Patch:
@@ -17,7 +17,6 @@
 import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.i18n.client.DateTimeFormat;
 import com.google.gwt.i18n.client.NumberFormat;
-import com.google.gwt.user.client.Window;
 
 import org.rstudio.core.client.container.SafeMap;
 import org.rstudio.core.client.dom.DomMetrics;

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -41,7 +41,6 @@
 
 import org.rstudio.core.client.Barrier;
 import org.rstudio.core.client.BrowseCap;
-import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.Barrier.Token;
@@ -82,7 +81,6 @@
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.studio.client.workbench.model.SessionUtils;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
-import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceTheme;
 import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;
 
 @Singleton

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -35,8 +35,6 @@
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.application.events.EventBus;
-import org.rstudio.studio.client.application.events.ThemeChangedEvent;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;
 import org.rstudio.studio.client.common.satellite.events.AllSatellitesClosingEvent;
 import org.rstudio.studio.client.common.satellite.events.SatelliteClosedEvent;

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteWindow.java
Patch:
@@ -24,7 +24,6 @@
 import org.rstudio.studio.client.application.events.ThemeChangedEvent;
 import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.satellite.events.SatelliteWindowEventHandlers;
-import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 import org.rstudio.studio.client.workbench.ui.FontSizeManager;
 
 import com.google.gwt.core.client.JavaScriptObject;
@@ -35,7 +34,6 @@
 import com.google.gwt.user.client.ui.ProvidesResize;
 import com.google.gwt.user.client.ui.RequiresResize;
 import com.google.inject.Provider;
-import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;
 
 
 public abstract class SatelliteWindow extends Composite

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/NewRSConnectAuthPage.java
Patch:
@@ -21,7 +21,6 @@
 import org.rstudio.core.client.widget.WizardPage;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.Desktop;
-import org.rstudio.studio.client.application.DesktopInfo;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;
 import org.rstudio.studio.client.common.Value;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSAccountConnector.java
Patch:
@@ -20,7 +20,6 @@
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ProgressOperationWithInput;
 import org.rstudio.core.client.widget.ProgressIndicator;
-import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.satellite.Satellite;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/JobsPresenter.java
Patch:
@@ -15,7 +15,6 @@
 
 package org.rstudio.studio.client.workbench.views.jobs;
 
-import java.util.Arrays;
 import java.util.List;
 
 import org.rstudio.core.client.Debug;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetSqlHelper.java
Patch:
@@ -14,9 +14,6 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
-import org.rstudio.core.client.StringUtil;
-import org.rstudio.core.client.regex.Match;
-import org.rstudio.core.client.regex.Pattern;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishFilesPage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishCodePage.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -56,6 +56,7 @@ public PublishFilesPage(String title, String subTitle, ImageResource icon,
                               input.getOriginatingEvent().getPath(),
                               input.getOriginatingEvent().getHtmlFile(),
                               input.getWebsiteDir(),
+                              input.getWebsiteOutputDir(),
                               input.isSelfContained(),
                               asStatic,
                               input.isShiny(),

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishRPubsPage.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishRPubsPage.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -58,6 +58,7 @@ protected RSConnectPublishResult collectInput()
                   initialData_.getOriginatingEvent().getPath(), 
                   initialData_.getOriginatingEvent().getHtmlFile(),
                   null, // website directory
+                  null, // website output directory
                   initialData_.isSelfContained(),
                   true, // as static
                   initialData_.isShiny(),

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -1077,7 +1077,7 @@ else if (contentType_ == RSConnect.CONTENT_TYPE_PLOT)
          illustration = new ImageResource2x(RESOURCES.publishPlotIllustration2x());
       else if (contentType_ == RSConnect.CONTENT_TYPE_DOCUMENT)
          illustration = new ImageResource2x(RESOURCES.publishRmdIllustration2x());
-      else if (contentType_ == RSConnect.CONTENT_TYPE_HTML)
+      else if (contentType_ == RSConnect.CONTENT_TYPE_HTML || contentType_ == RSConnect.CONTENT_TYPE_WEBSITE)
          illustration = new ImageResource2x(RESOURCES.publishHTMLIllustration2x());
       else if (contentType_ == RSConnect.CONTENT_TYPE_PRES)
          illustration = new ImageResource2x(RESOURCES.publishPresentationIllustration2x());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceTheme.java
Patch:
@@ -28,7 +28,7 @@ protected AceTheme() {}
    
    public static final AceTheme createDefault()
    {
-      return create("Textmate (default)", "/theme/default/textmate.rstheme", false);
+      return create("Textmate (default)", "theme/default/textmate.rstheme", false);
    }
    
    public static final native AceTheme create(String name, String url, Boolean isDark)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceTheme.java
Patch:
@@ -28,7 +28,7 @@ protected AceTheme() {}
    
    public static final AceTheme createDefault()
    {
-      return create("Textmate (default)", "/theme/default/textmate.rstheme", false);
+      return create("Textmate (default)", "theme/default/textmate.rstheme", false);
    }
    
    public static final native AceTheme create(String name, String url, Boolean isDark)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -260,6 +260,9 @@ public void onUiPrefsChanged(UiPrefsChangedEvent e)
          checkArgumentsToRFunctionCalls().setGlobalValue(
                newUiPrefs.checkArgumentsToRFunctionCalls().getGlobalValue());
          
+         checkUnexpectedAssignmentInFunctionCall().setGlobalValue(
+               newUiPrefs.checkUnexpectedAssignmentInFunctionCall().getGlobalValue());
+         
          warnIfNoSuchVariableInScope().setGlobalValue(
                newUiPrefs.warnIfNoSuchVariableInScope().getGlobalValue());
          

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -405,6 +405,7 @@ public void onChange(ChangeEvent event)
       final VerticalPanel rOptionsPanel = new VerticalPanel();
       rOptionsPanel.add(checkboxPref("Enable diagnostics within R function calls", prefs.diagnosticsInRFunctionCalls()));
       rOptionsPanel.add(checkboxPref("Check arguments to R function calls", prefs.checkArgumentsToRFunctionCalls()));
+      rOptionsPanel.add(checkboxPref("Check usage of '<-' in function call", prefs.checkUnexpectedAssignmentInFunctionCall()));
       rOptionsPanel.add(checkboxPref("Warn if variable used has no definition in scope", prefs.warnIfNoSuchVariableInScope()));
       rOptionsPanel.add(checkboxPref("Warn if variable is defined but not used", prefs.warnIfVariableDefinedButNotUsed()));
       rOptionsPanel.add(checkboxPref("Provide R style diagnostics (e.g. whitespace)", prefs.enableStyleDiagnostics()));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -584,7 +584,9 @@ else if (keyCode == KeyCodes.KEY_ENTER && (
             restoreFocus_ = true;
             processCommandEntry();
          }
-         else if (keyCode == KeyCodes.KEY_ESCAPE && modifiers == 0)
+         else if (
+               (keyCode == KeyCodes.KEY_ESCAPE && modifiers == 0) ||
+               (!BrowseCap.isWindows() && (keyCode == KeyCodes.KEY_C && modifiers == KeyboardShortcut.CTRL)))
          {
             event.preventDefault();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -260,6 +260,9 @@ public void onUiPrefsChanged(UiPrefsChangedEvent e)
          checkArgumentsToRFunctionCalls().setGlobalValue(
                newUiPrefs.checkArgumentsToRFunctionCalls().getGlobalValue());
          
+         checkUnexpectedAssignmentInFunctionCall().setGlobalValue(
+               newUiPrefs.checkUnexpectedAssignmentInFunctionCall().getGlobalValue());
+         
          warnIfNoSuchVariableInScope().setGlobalValue(
                newUiPrefs.warnIfNoSuchVariableInScope().getGlobalValue());
          

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -405,6 +405,7 @@ public void onChange(ChangeEvent event)
       final VerticalPanel rOptionsPanel = new VerticalPanel();
       rOptionsPanel.add(checkboxPref("Enable diagnostics within R function calls", prefs.diagnosticsInRFunctionCalls()));
       rOptionsPanel.add(checkboxPref("Check arguments to R function calls", prefs.checkArgumentsToRFunctionCalls()));
+      rOptionsPanel.add(checkboxPref("Check usage of '<-' in function call", prefs.checkUnexpectedAssignmentInFunctionCall()));
       rOptionsPanel.add(checkboxPref("Warn if variable used has no definition in scope", prefs.warnIfNoSuchVariableInScope()));
       rOptionsPanel.add(checkboxPref("Warn if variable is defined but not used", prefs.warnIfVariableDefinedButNotUsed()));
       rOptionsPanel.add(checkboxPref("Provide R style diagnostics (e.g. whitespace)", prefs.enableStyleDiagnostics()));

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/GraphvizFileType.java
Patch:
@@ -23,6 +23,7 @@ public class GraphvizFileType extends PreviewableFromRFileType
    public GraphvizFileType()
    {
       super("graphviz", "GraphViz", EditorLanguage.LANG_GRAPHVIZ, ".gv",
-            new ImageResource2x(FileIconResources.INSTANCE.iconGraphviz2x()), "DiagrammeR::grViz");
+            new ImageResource2x(FileIconResources.INSTANCE.iconGraphviz2x()), "DiagrammeR::grViz",
+            false);
    }
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/MermaidFileType.java
Patch:
@@ -23,6 +23,7 @@ public class MermaidFileType extends PreviewableFromRFileType
    public MermaidFileType()
    {
       super("mermaid", "Mermaid", EditorLanguage.LANG_MERMAID, ".mmd",
-            new ImageResource2x(FileIconResources.INSTANCE.iconMermaid2x()), "DiagrammeR::mermaid");
+            new ImageResource2x(FileIconResources.INSTANCE.iconMermaid2x()), "DiagrammeR::mermaid",
+            false);
    }
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/PreviewableFromRFileType.java
Patch:
@@ -29,11 +29,12 @@ public PreviewableFromRFileType(String id,
                                    EditorLanguage editorLanguage,
                                    String defaultExtension,
                                    ImageResource icon,
-                                   String previewFunction)
+                                   String previewFunction,
+                                   boolean canShowScopeTree)
    {
       super(id, label, editorLanguage, defaultExtension, icon,
             true, true, false, false, false, false, 
-            false, false, false, false, false, false, true);
+            false, false, false, false, false, canShowScopeTree, true);
       
       previewFunction_ = previewFunction;
    }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/StanFileType.java
Patch:
@@ -27,7 +27,8 @@ public class StanFileType extends PreviewableFromRFileType
    public StanFileType()
    {
       super("stan", "Stan", EditorLanguage.LANG_STAN, ".stan",
-            new ImageResource2x(FileIconResources.INSTANCE.iconStan2x()), "rstan:::rstudio_stanc");
+            new ImageResource2x(FileIconResources.INSTANCE.iconStan2x()), "rstan:::rstudio_stanc",
+            true);
    }
    
    public String getPreviewButtonText()

File: src/gwt/src/org/rstudio/studio/client/server/ServerErrorCause.java
Patch:
@@ -36,4 +36,6 @@ public String toString()
    private final int code_;
    private final String category_;
    private final String message_;
+   
+   public static final int FILE_NOT_FOUND = 2;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -44,6 +44,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.spelling.CharClassifier;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.spelling.TokenPredicate;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionContext;
+import org.rstudio.studio.client.workbench.views.source.editors.text.events.ActiveScopeChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.BreakpointMoveEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.BreakpointSetEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.CommandClickEvent;
@@ -229,6 +230,7 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
 
    boolean isScopeTreeReady(int row);
    HandlerRegistration addScopeTreeReadyHandler(ScopeTreeReadyEvent.Handler handler);
+   HandlerRegistration addActiveScopeChangedHandler(ActiveScopeChangedEvent.Handler handler);
    
    Position getCursorPosition();
    void setCursorPosition(Position position);
@@ -281,7 +283,7 @@ InputEditorSelection search(String needle,
    Scope getCurrentSection();
    ScopeFunction getFunctionAtPosition(Position position, boolean allowAnonymous);
    Scope getSectionAtPosition(Position position);
-   boolean hasScopeTree();
+   boolean hasCodeModelScopeTree();
    JsArray<Scope> getScopeTree();
    InsertChunkInfo getInsertChunkInfo();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceTheme.java
Patch:
@@ -28,7 +28,7 @@ protected AceTheme() {}
    
    public static final AceTheme createDefault()
    {
-      return create("Textmate (default)", "/theme/default/textmate.rstheme", false);
+      return create("Textmate (default)", "theme/default/textmate.rstheme", false);
    }
    
    public static final native AceTheme create(String name, String url, Boolean isDark)

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectPublishSource.java
Patch:
@@ -209,6 +209,7 @@ public JavaScriptObject toJso()
                getSourceFile() : "");
       obj.setString("content_category", StringUtil.notNull(
             getContentCategory()));
+      obj.setString("website_dir", StringUtil.notNull(getWebsiteDir()));
       return obj.cast();
    }
    

File: src/gwt/src/org/rstudio/studio/client/server/ServerErrorCause.java
Patch:
@@ -36,4 +36,6 @@ public String toString()
    private final int code_;
    private final String category_;
    private final String message_;
+   
+   public static final int FILE_NOT_FOUND = 2;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2387,7 +2387,7 @@ public void execute() {
    
    public void revertChanges(Command onCompleted)
    {
-      docUpdateSentinel_.revert(onCompleted);
+      docUpdateSentinel_.revert(onCompleted, ignoreDeletes_);
    }
 
    public void saveThenExecute(String encodingOverride, final Command command)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -410,7 +410,6 @@ void highlightDebugLocation(
    void setDragEnabled(boolean enabled);
    
    boolean isSnippetsTabStopManagerActive();
-   boolean onInsertSnippet();
 
    void addLineWidget(LineWidget widget);
    void removeLineWidget(LineWidget widget);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -410,7 +410,6 @@ void highlightDebugLocation(
    void setDragEnabled(boolean enabled);
    
    boolean isSnippetsTabStopManagerActive();
-   boolean onInsertSnippet();
 
    void addLineWidget(LineWidget widget);
    void removeLineWidget(LineWidget widget);

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdPreviewParams.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -56,7 +56,7 @@ public native final boolean isShinyDocument() /*-{
    }-*/;
    
    public native final String getWebsiteDir() /*-{
-      return this.website_dir;
+      return this.result.website_dir;
    }-*/;
    
    public native final int getScrollPosition() /*-{

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdPreviewParams.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -56,7 +56,7 @@ public native final boolean isShinyDocument() /*-{
    }-*/;
    
    public native final String getWebsiteDir() /*-{
-      return this.website_dir;
+      return this.result.website_dir;
    }-*/;
    
    public native final int getScrollPosition() /*-{

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectPublishSource.java
Patch:
@@ -135,7 +135,9 @@ public boolean isSourceExt(String ext)
    public boolean isDocument()
    {
       return isSourceExt("rmd") || isSourceExt("md") || isSourceExt("html") ||
-             isSourceExt("htm") || isSourceExt("rpres");
+             isSourceExt("htm") || isSourceExt("rpres") || isSourceExt("pdf") ||
+             isSourceExt("docx") || isSourceExt("odt") || isSourceExt("rtf") ||
+             isSourceExt("pptx");
    }
    
    public String getDeployKey()

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectPublishSource.java
Patch:
@@ -135,7 +135,9 @@ public boolean isSourceExt(String ext)
    public boolean isDocument()
    {
       return isSourceExt("rmd") || isSourceExt("md") || isSourceExt("html") ||
-             isSourceExt("htm") || isSourceExt("rpres");
+             isSourceExt("htm") || isSourceExt("rpres") || isSourceExt("pdf") ||
+             isSourceExt("docx") || isSourceExt("odt") || isSourceExt("rtf") ||
+             isSourceExt("pptx");
    }
    
    public String getDeployKey()

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -455,6 +455,7 @@ public boolean test(Token token, int row, int column)
             }
 
             return reTextType_.match(token.getType(), 0) != null ||
+               reStringType_.match(token.getType(), 0) != null ||
                reHeaderType_.match(token.getType(), 0) != null;
          }
       };
@@ -508,6 +509,7 @@ public Pattern getRnwStartPatternEnd()
    private final String defaultExtension_;
 
    private static Pattern reTextType_ = Pattern.create("\\btext\\b");
+   private static Pattern reStringType_ = Pattern.create("\\bstring\\b");
    private static Pattern reHeaderType_ = Pattern.create("\\bheading\\b");
    private static Pattern reNospellType_ = Pattern.create("\\bnospell\\b");
 }

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -171,6 +171,9 @@ void openTerminal(String terminalPath,
    void getIgnoreGpuBlacklist(CommandWithArg<Boolean> callback);
    void setIgnoreGpuBlacklist(boolean ignore);
    
+   void getDisableGpuDriverBugWorkarounds(CommandWithArg<Boolean> callback);
+   void setDisableGpuDriverBugWorkarounds(boolean disable);
+   
    void showLicenseDialog();
    void getInitMessages(CommandWithArg<String> callback);
    void getLicenseStatusMessage(CommandWithArg<String> callback);

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishButton.java
Patch:
@@ -874,6 +874,9 @@ public void onResponseReceived(RmdOutputInfo response)
                   public void onError(ServerError error)
                   {
                      Debug.logError(error);
+                     display_.showErrorMessage("Content Publish Failed",
+                           "Unable to determine file to be published. Click Knit or Preview " +
+                           "to render it again, then click the Publish button above the rendered document.");
                      rmdInfoPending_ = false;
                   }
                });

File: src/gwt/src/org/rstudio/core/client/HtmlMessageListener.java
Patch:
@@ -53,8 +53,6 @@ public void onUiPrefsChanged(UiPrefsChangedEvent e)
          {
             if (e.getType() == UiPrefsChangedEvent.GLOBAL_TYPE)
             {
-               AceTheme editorTheme = pUIPrefs_.get().theme().getGlobalValue();
-
                for (JavaScriptObject themeSource : themeSources_) {
                   postThemeMessage(themeSource, themeOrigin_);
                }

File: src/gwt/src/org/rstudio/core/client/URIUtils.java
Patch:
@@ -15,6 +15,8 @@
 
 package org.rstudio.core.client;
 
+import org.rstudio.core.client.dom.DomUtils;
+
 import com.google.gwt.http.client.URL;
 
 public class URIUtils
@@ -52,7 +54,7 @@ public static String addQueryParam(String url, String name, String value)
    public static boolean isLocalUrl(String url)
    {
       // ensure URL is absolute
-      String absolute = StringUtil.makeAbsoluteUrl(url);
+      String absolute = DomUtils.makeAbsoluteUrl(url);
       
       // extract host and see if it's on the whitelist of loopback hosts
       String host = StringUtil.getHostFromUrl(absolute);

File: src/gwt/src/org/rstudio/core/client/regex/Pattern.java
Patch:
@@ -49,8 +49,8 @@ public final native Match match(String input, int index) /*-{
          next: this.lastIndex,
          pattern: this,
          match: result
-      } ;
-   }-*/ ;
+      };
+   }-*/;
    
    public final native boolean test(String input) /*-{
       return this.test(input);

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -157,6 +157,7 @@ void openTerminal(String terminalPath,
    void zoomActualSize();
    
    void setBackgroundColor(JsArrayInteger rgbColor);
+   void syncToEditorTheme(boolean isDark);
    
    void getEnableAccessibility(CommandWithArg<Boolean> callback);
    void setEnableAccessibility(boolean enable);

File: src/gwt/src/org/rstudio/studio/client/plumber/ui/PlumberAPIPanel.java
Patch:
@@ -20,7 +20,7 @@
 import com.google.gwt.user.client.ui.Label;
 import com.google.inject.Inject;
 
-import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.RStudioFrame;
 import org.rstudio.core.client.widget.SatelliteFramePanel;
@@ -108,7 +108,7 @@ public String getUrl()
    @Override
    public String getAbsoluteUrl()
    {
-      return StringUtil.makeAbsoluteUrl(appParams_.getUrl());
+      return DomUtils.makeAbsoluteUrl(appParams_.getUrl());
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputFramePane.java
Patch:
@@ -15,7 +15,7 @@
 package org.rstudio.studio.client.rmarkdown.ui;
 
 import org.rstudio.core.client.ScrollUtil;
-import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.RStudioFrame;
@@ -80,7 +80,7 @@ public void onViewerNavigated(ViewerNavigatedEvent event)
          if (params.isShinyDocument())
          {
             shinyFrame_.initialize(
-               StringUtil.makeAbsoluteUrl(params.getOutputUrl()),
+               DomUtils.makeAbsoluteUrl(params.getOutputUrl()),
                new Operation() {
                   @Override
                   public void execute()

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdOutputPanel.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -31,7 +31,7 @@
 
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.ScrollUtil;
-import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.IFrameElementEx;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.files.FileSystemItem;
@@ -101,7 +101,7 @@ public void showOutput(RmdPreviewParams params, boolean enablePublish,
       {
          fileLabel_.setVisible(false);
          fileLabelSeparator_.setVisible(false);
-         shinyUrl_ = StringUtil.makeAbsoluteUrl(params.getOutputUrl());
+         shinyUrl_ = DomUtils.makeAbsoluteUrl(params.getOutputUrl());
          isShiny_ = true;
       }
       else

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPresenter.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdOutputPresenter.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,9 +14,9 @@
  */
 package org.rstudio.studio.client.rmarkdown.ui;
 
-import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.command.Handler;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -115,7 +115,7 @@ public Widget asWidget()
    @Override
    public String getShinyUrl()
    {
-      return StringUtil.makeAbsoluteUrl(params_.getOutputUrl());
+      return DomUtils.makeAbsoluteUrl(params_.getOutputUrl());
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyApplicationPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShinyApplicationPanel.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -20,7 +20,7 @@
 import com.google.gwt.user.client.ui.Label;
 import com.google.inject.Inject;
 
-import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.RStudioFrame;
 import org.rstudio.core.client.widget.SatelliteFramePanel;
@@ -114,7 +114,7 @@ public String getUrl()
    @Override
    public String getAbsoluteUrl()
    {
-      return StringUtil.makeAbsoluteUrl(appParams_.getUrl());
+      return DomUtils.makeAbsoluteUrl(appParams_.getUrl());
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -361,7 +361,7 @@ public PrefValue<AceTheme> theme()
    public String getThemeErrorClass()
    {    
       if ((theme().getValue() == null) ||
-          AceTheme.createDefault().equals(theme().getValue()))
+          AceTheme.createDefault().isEqualTo(theme().getValue()))
          return " ace_constant";
       else  
          return " ace_constant ace_language";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionShinyHost.java
Patch:
@@ -18,6 +18,7 @@
 
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.RStudioFrame;
@@ -223,7 +224,7 @@ public void onShinyFrameNavigated(ShinyFrameNavigatedEvent event)
       if (Desktop.isDesktop())
          Desktop.getFrame().setShinyDialogUrl(StringUtil.notNull(url));
 
-      frame_.setUrl(StringUtil.makeAbsoluteUrl(url));
+      frame_.setUrl(DomUtils.makeAbsoluteUrl(url));
       appendStyleOnLoad(frame_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetThemeHelper.java
Patch:
@@ -91,8 +91,7 @@ private void syncToEditorTheme(TextEditingTarget editingTarget)
       currentContent_ = content;
       
       // call all registered handlers
-      handlers_.fireEvent(new EditorThemeStyleChangedEvent(content, 
-            currentStyle_));
+      handlers_.fireEvent(new EditorThemeStyleChangedEvent(content, currentStyle_));
    }
    
    private HandlerManager handlers_ = new HandlerManager(this);

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -809,7 +809,8 @@ public void withTestPackage(final Command command, boolean useTestThat)
 
       if (useTestThat) {
          dependencies = new Dependency[] {
-            Dependency.cranPackage("testthat", "2.0.0")
+            Dependency.cranPackage("testthat", "2.0.0"),
+            Dependency.cranPackage("devtools", "1.11.1")
          };
 
          message = "Using testthat";

File: src/gwt/src/org/rstudio/core/client/URIUtils.java
Patch:
@@ -15,6 +15,8 @@
 
 package org.rstudio.core.client;
 
+import org.rstudio.core.client.dom.DomUtils;
+
 import com.google.gwt.http.client.URL;
 
 public class URIUtils
@@ -52,7 +54,7 @@ public static String addQueryParam(String url, String name, String value)
    public static boolean isLocalUrl(String url)
    {
       // ensure URL is absolute
-      String absolute = StringUtil.makeAbsoluteUrl(url);
+      String absolute = DomUtils.makeAbsoluteUrl(url);
       
       // extract host and see if it's on the whitelist of loopback hosts
       String host = StringUtil.getHostFromUrl(absolute);

File: src/gwt/src/org/rstudio/studio/client/plumber/ui/PlumberAPIPanel.java
Patch:
@@ -20,7 +20,7 @@
 import com.google.gwt.user.client.ui.Label;
 import com.google.inject.Inject;
 
-import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.RStudioFrame;
 import org.rstudio.core.client.widget.SatelliteFramePanel;
@@ -108,7 +108,7 @@ public String getUrl()
    @Override
    public String getAbsoluteUrl()
    {
-      return StringUtil.makeAbsoluteUrl(appParams_.getUrl());
+      return DomUtils.makeAbsoluteUrl(appParams_.getUrl());
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputFramePane.java
Patch:
@@ -15,7 +15,7 @@
 package org.rstudio.studio.client.rmarkdown.ui;
 
 import org.rstudio.core.client.ScrollUtil;
-import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.RStudioFrame;
@@ -80,7 +80,7 @@ public void onViewerNavigated(ViewerNavigatedEvent event)
          if (params.isShinyDocument())
          {
             shinyFrame_.initialize(
-               StringUtil.makeAbsoluteUrl(params.getOutputUrl()),
+               DomUtils.makeAbsoluteUrl(params.getOutputUrl()),
                new Operation() {
                   @Override
                   public void execute()

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdOutputPanel.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -31,7 +31,7 @@
 
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.ScrollUtil;
-import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.IFrameElementEx;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.files.FileSystemItem;
@@ -101,7 +101,7 @@ public void showOutput(RmdPreviewParams params, boolean enablePublish,
       {
          fileLabel_.setVisible(false);
          fileLabelSeparator_.setVisible(false);
-         shinyUrl_ = StringUtil.makeAbsoluteUrl(params.getOutputUrl());
+         shinyUrl_ = DomUtils.makeAbsoluteUrl(params.getOutputUrl());
          isShiny_ = true;
       }
       else

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPresenter.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RmdOutputPresenter.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -14,9 +14,9 @@
  */
 package org.rstudio.studio.client.rmarkdown.ui;
 
-import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.command.Handler;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -115,7 +115,7 @@ public Widget asWidget()
    @Override
    public String getShinyUrl()
    {
-      return StringUtil.makeAbsoluteUrl(params_.getOutputUrl());
+      return DomUtils.makeAbsoluteUrl(params_.getOutputUrl());
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyApplicationPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShinyApplicationPanel.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -20,7 +20,7 @@
 import com.google.gwt.user.client.ui.Label;
 import com.google.inject.Inject;
 
-import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.RStudioFrame;
 import org.rstudio.core.client.widget.SatelliteFramePanel;
@@ -114,7 +114,7 @@ public String getUrl()
    @Override
    public String getAbsoluteUrl()
    {
-      return StringUtil.makeAbsoluteUrl(appParams_.getUrl());
+      return DomUtils.makeAbsoluteUrl(appParams_.getUrl());
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionShinyHost.java
Patch:
@@ -18,6 +18,7 @@
 
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.RStudioFrame;
@@ -223,7 +224,7 @@ public void onShinyFrameNavigated(ShinyFrameNavigatedEvent event)
       if (Desktop.isDesktop())
          Desktop.getFrame().setShinyDialogUrl(StringUtil.notNull(url));
 
-      frame_.setUrl(StringUtil.makeAbsoluteUrl(url));
+      frame_.setUrl(DomUtils.makeAbsoluteUrl(url));
       appendStyleOnLoad(frame_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -19,7 +19,6 @@
 
 import org.rstudio.core.client.JsArrayUtil;
 import org.rstudio.core.client.VirtualConsole;
-import org.rstudio.core.client.events.UpdateTabPanelsEvent;
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.DesktopInfo;
@@ -359,7 +358,7 @@ public PrefValue<AceTheme> theme()
    public String getThemeErrorClass()
    {    
       if ((theme().getValue() == null) ||
-          AceTheme.createDefault().equals(theme().getValue()))
+          AceTheme.createDefault().isEqualTo(theme().getValue()))
          return " ace_constant";
       else  
          return " ace_constant ace_language";

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -343,7 +343,7 @@ private void showThemeExistsDialog(String inputFileName, Operation continueOpera
       msg.append("A theme file with the same name, '")
          .append(inputFileName)
          .append("', already exists. Adding the theme will cause the existing file to be ")
-         .append("overwritten. Would you like to add the theme anyways?");
+         .append("overwritten. Would you like to add the theme anyway?");
       globalDisplay_.showYesNoMessage(
          GlobalDisplay.MSG_WARNING,
          "Theme File Already Exists",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -884,7 +884,7 @@ public void showRequiredPackagesMissingWarning(List<String> packages)
       
       Command onInstall = () -> {
          StringBuilder builder = new StringBuilder();
-         builder.append("utils::install.packages(\"")
+         builder.append("install.packages(\"")
                 .append(StringUtil.join(packages, "\", \""))
                 .append("\")");
          events_.fireEvent(new SendToConsoleEvent(builder.toString(), true));

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -616,7 +616,6 @@ protected class ClickableScrollPanel extends BottomScrollPanel
       private ClickableScrollPanel()
       {
          super();
-         getElement().setTabIndex(-1);
       }
 
       public HandlerRegistration addClickHandler(ClickHandler handler)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AceThemes.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -195,7 +195,7 @@ public void onChange(ChangeEvent event)
             "Theme Files (*.tmTheme *.rstheme)",
             RStudioGinjector.INSTANCE.getRemoteFileSystemContext(),
             workbenchContext.getCurrentWorkingDir(),
-            "tmTheme Files (*.tmTheme);;rstheme Files (*.rstheme)",
+            "Theme Files (*.tmTheme *.rstheme)",
             (input, indicator) ->
             {
                if (input == null)

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -751,7 +751,7 @@ public void withKeyring(final Command command)
         "Preparing Keyring",
         "Using keyring", 
         new Dependency[] {
-           Dependency.cranPackage("keyring", "1.0.0", true)
+           Dependency.cranPackage("keyring", "1.1.0", true)
         }, 
         true, // update keyring if needed
         new CommandWithArg<Boolean>()

File: src/gwt/src/org/rstudio/core/client/HtmlMessageListener.java
Patch:
@@ -53,8 +53,6 @@ public void onUiPrefsChanged(UiPrefsChangedEvent e)
          {
             if (e.getType() == UiPrefsChangedEvent.GLOBAL_TYPE)
             {
-               AceTheme editorTheme = pUIPrefs_.get().theme().getGlobalValue();
-
                for (JavaScriptObject themeSource : themeSources_) {
                   postThemeMessage(themeSource, themeOrigin_);
                }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java
Patch:
@@ -131,7 +131,8 @@ public void onSuccess(JsArray<AceTheme> jsonThemeArray)
                themes_.put(theme.getName(), theme);
             }
             
-            Debug.logWarning("Server was unable to find any installed themes.");
+            if (len == 0)
+               Debug.logWarning("Server was unable to find any installed themes.");
             themeConsumer.accept(themes_);
          }
       });

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/export/CopyViewerPlotToClipboardDesktopDialog.java
Patch:
@@ -46,7 +46,8 @@ public void execute(Rectangle viewerRect)
                      viewerRect.getLeft(),
                      viewerRect.getTop(),
                      viewerRect.getWidth(),
-                     viewerRect.getHeight());
+                     viewerRect.getHeight(),
+                     onCompleted::execute);
             }
          
          },

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesDisplayObserver.java
Patch:
@@ -19,8 +19,8 @@
 public interface PackagesDisplayObserver
 {
    void updatePackageState(boolean showProgress, boolean manualUpdate);
-   void loadPackage(String pkgName, String libName) ;
-   void unloadPackage(String pkgName, String libName) ;
+   void loadPackage(PackageInfo info) ;
+   void unloadPackage(PackageInfo info) ;
    void showHelp(PackageInfo packageInfo) ;
    void removePackage(PackageInfo packageInfo);
    void onPackageFilterChanged(String filter);

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -109,6 +109,7 @@
 import org.rstudio.studio.client.workbench.views.console.shell.assist.PythonCompletionManager;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.RCompletionManager;
 import org.rstudio.studio.client.workbench.views.output.lint.LintManager;
+import org.rstudio.studio.client.workbench.views.packages.ui.CheckForUpdatesDialog;
 import org.rstudio.studio.client.workbench.views.source.DocsMenu;
 import org.rstudio.studio.client.workbench.views.source.DocumentOutlineWidget;
 import org.rstudio.studio.client.workbench.views.source.NewPlumberAPI;
@@ -260,6 +261,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(NewConnectionPreInstallOdbcHost NewConnectionPreInstallOdbcHost);
    void injectMembers(SecondaryReposWidget widget);
    void injectMembers(SecondaryReposDialog widget);
+   void injectMembers(CheckForUpdatesDialog dialog);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/Packages.java
Patch:
@@ -409,7 +409,6 @@ public void execute()
    private void doUpdatePackages(final PackageInstallContext installContext)
    {
       new CheckForUpdatesDialog(
-         globalDisplay_,
          new ServerDataSource<JsArray<PackageUpdate>>() {
             public void requestData(
                ServerRequestCallback<JsArray<PackageUpdate>> requestCallback)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/Packages.java
Patch:
@@ -717,7 +717,7 @@ public void unloadPackage(String packageName, String libName)
    
    public void showHelp(PackageInfo packageInfo)
    {
-      events_.fireEvent(new ShowHelpEvent(packageInfo.getUrl())) ;
+      events_.fireEvent(new ShowHelpEvent(packageInfo.getHelpUrl())) ;
    }
    
    public void onPackageStateChanged(PackageStateChangedEvent event)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/JobConstants.java
Patch:
@@ -30,4 +30,5 @@ public class JobConstants
    
    // special job actions
    public final static String ACTION_STOP = "stop";
+   public final static String ACTION_INFO = "info";
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobItem.java
Patch:
@@ -84,8 +84,8 @@ public JobItem(final Job job)
       
       name_.setText(job.name);
 
-      ImageResource2x detailsImage = new ImageResource2x(RESOURCES.jobInfo());
-      if (JsArrayUtil.jsArrayStringContains(job.actions, "info"))
+      ImageResource2x detailsImage = new ImageResource2x(RESOURCES.jobSelect());
+      if (JsArrayUtil.jsArrayStringContains(job.actions, JobConstants.ACTION_INFO))
       {
          detailsImage = new ImageResource2x(RESOURCES.jobInfo());
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobOutputPanel.java
Patch:
@@ -36,6 +36,7 @@ interface JobOutputPanelUiBinder extends UiBinder<Widget, JobOutputPanel>
    public JobOutputPanel()
    {
       output_ = new CompilePanel(new CompileOutputBufferWithHighlight());
+      output_.setHeight("100%");
 
       initWidget(uiBinder.createAndBindUi(this));
       

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -250,6 +250,8 @@ protected void initialize(RPrefs prefs)
       cranMirrorTextBox_.setEnabled(true);
       if (!packagesPrefs.getCRANMirror().isEmpty())
       {
+         cranMirror_ = packagesPrefs.getCRANMirror();
+         
          secondaryReposWidget_.setCranRepoUrl(
             cranMirror_.getURL(),
             cranMirror_.getHost().equals("Custom")

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -250,6 +250,8 @@ protected void initialize(RPrefs prefs)
       cranMirrorTextBox_.setEnabled(true);
       if (!packagesPrefs.getCRANMirror().isEmpty())
       {
+         cranMirror_ = packagesPrefs.getCRANMirror();
+         
          secondaryReposWidget_.setCranRepoUrl(
             cranMirror_.getURL(),
             cranMirror_.getHost().equals("Custom")

File: src/gwt/src/org/rstudio/core/client/widget/RStudioThemedFrame.java
Patch:
@@ -107,7 +107,8 @@ private void addThemesStyle(String customStyle, String urlStyle, boolean removeB
       {
          Document document = getWindow().getDocument();
          
-         if (customStyle == null) customStyle = "";
+         if (customStyle == null)
+            customStyle = "";
          
          customStyle += "\n" +
          ".rstudio-themes-flat.rstudio-themes-dark.rstudio-themes-scrollbars::-webkit-scrollbar,\n" +

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/view/ObjectExplorerDataGrid.java
Patch:
@@ -876,7 +876,7 @@ else if (n == 3)
          buttonWidth = 48;
 
       // add a bit of extra padding for the scroll bar
-      buttonWidth += 12;
+      buttonWidth += DomUtils.getScrollbarWidth();
       
       int totalWidth = getOffsetWidth();
       int remainingWidth = totalWidth - otherWidth - buttonWidth - 20;

File: src/gwt/src/org/rstudio/core/client/widget/VirtualizedDataGrid.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * VirtualizedDataGrid.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -23,7 +23,6 @@
 import com.google.gwt.event.dom.client.ScrollHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.user.cellview.client.AbstractCellTable;
-import com.google.gwt.user.cellview.client.DataGrid;
 import com.google.gwt.user.cellview.client.DefaultCellTableBuilder;
 import com.google.gwt.user.client.Timer;
 import com.google.gwt.user.client.ui.HeaderPanel;
@@ -33,7 +32,7 @@
 // allowing the class to render large tables without overloading the DOM.
 // The main requirement is that all rows within the drawn table have the
 // same height.
-public abstract class VirtualizedDataGrid<T> extends DataGrid<T>
+public abstract class VirtualizedDataGrid<T> extends RStudioDataGrid<T>
 {
    public class TableBuilder extends DefaultCellTableBuilder<T>
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -26,6 +26,7 @@
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.OperationWithInput;
+import org.rstudio.core.client.widget.RStudioDataGrid;
 import org.rstudio.studio.client.ResizableHeader;
 import org.rstudio.studio.client.common.filetypes.FileIconResources;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
@@ -71,7 +72,7 @@ public FilesList(final Files.Display.Observer observer,
                                                       dataProvider_.getList());
       
       // create cell table
-      filesDataGrid_ = new DataGrid<FileSystemItem>(
+      filesDataGrid_ = new RStudioDataGrid<FileSystemItem>(
                                           15,
                                           FilesListDataGridResources.INSTANCE,
                                           KEY_PROVIDER);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -757,7 +757,7 @@ private boolean isShinyFile()
 
    private boolean isPlumberFile()
    {
-      return extendedType_ != null && extendedType_ == SourceDocument.XT_PLUMBER_API;
+      return SourceDocument.isPlumberFile(extendedType_);
    }
 
    private boolean isTestFile()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -757,7 +757,7 @@ private boolean isShinyFile()
 
    private boolean isPlumberFile()
    {
-      return extendedType_ != null && extendedType_ == SourceDocument.XT_PLUMBER_API;
+      return SourceDocument.isPlumberFile(extendedType_);
    }
 
    private boolean isTestFile()

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -753,6 +753,7 @@ private void updateTheme(String themeName)
             Document.get(),
             rootPanel_.getElement());
    
+      events_.fireEvent(new ThemeChangedEvent(themeName));
       events_.fireEventToAllSatellites(new ThemeChangedEvent(themeName));
    }
    

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -53,7 +53,6 @@
 import org.rstudio.core.client.events.BarrierReleasedEvent;
 import org.rstudio.core.client.events.BarrierReleasedHandler;
 import org.rstudio.core.client.widget.Operation;
-import org.rstudio.studio.client.RStudio;
 import org.rstudio.studio.client.application.ApplicationQuit.QuitContext;
 import org.rstudio.studio.client.application.events.*;
 import org.rstudio.studio.client.application.model.InvalidSessionInfo;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -355,7 +355,9 @@ public PrefValue<Boolean> useLigatures()
 
    public PrefValue<AceTheme> theme()
    {
-      return object("theme", AceTheme.createDefault());
+      // Prior to 1.2 this value was "theme". Since the object structure has changed, we've renamed
+      // it, and users upgrading will have to re-apply their desired theme.
+      return object("rstheme", AceTheme.createDefault());
    }
    
    public String getThemeErrorClass()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/Job.java
Patch:
@@ -52,4 +52,7 @@ public class Job
    
    // the time the browser (client) received the job
    public int received;
+
+   // whether the job pane should should be shown at start
+   public boolean show;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/model/Job.java
Patch:
@@ -52,4 +52,7 @@ public class Job
    
    // the time the browser (client) received the job
    public int received;
+
+   // whether the job pane should should be shown at start
+   public boolean show;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobsPane.java
Patch:
@@ -90,7 +90,7 @@ public void updateJob(int type, Job job)
             list_.addJob(job);
             
             // bring the pane to the front so the new job is visible
-            bringToFront();
+            if (job.show) bringToFront();
             
             // select the job
             events_.fireEvent(new JobSelectionEvent(job.id, true, false));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/History.java
Patch:
@@ -159,7 +159,7 @@ protected void performAction(boolean shouldSchedulePassive)
                      public void onResponseReceived(
                            RpcObjectList<HistoryEntry> response)
                      {
-                        if (query == searchQuery_)
+                        if (!StringUtil.equals(query, searchQuery_))
                            return;
 
                         ArrayList<HistoryEntry> entries = toList(response);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -65,6 +65,7 @@
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
+import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.AutoGlassPanel;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;
@@ -120,7 +121,8 @@ public void onResize(ResizeEvent event)
          "  background-color: #CCC;\n" +
          "}\n",
          null,
-         false);
+         false,
+         RStudioThemes.isFlat());
       frame_.setSize("100%", "100%");
       frame_.setStylePrimaryName("rstudio-HelpFrame");
       frame_.addStyleName("ace_editor_theme");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -65,6 +65,7 @@
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
+import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.AutoGlassPanel;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;
@@ -120,7 +121,8 @@ public void onResize(ResizeEvent event)
          "  background-color: #CCC;\n" +
          "}\n",
          null,
-         false);
+         false,
+         RStudioThemes.isFlat());
       frame_.setSize("100%", "100%");
       frame_.setStylePrimaryName("rstudio-HelpFrame");
       frame_.addStyleName("ace_editor_theme");

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -772,7 +772,7 @@ public void withOdbc(final Command command, final String name)
         "Preparing " + name,
         "Using " + name, 
         new Dependency[] {
-           Dependency.cranPackage("odbc", "1.1.5"),
+           Dependency.cranPackage("odbc", "1.1.6"),
            Dependency.cranPackage("rstudioapi", "0.5")
         }, 
         true, // update odbc if needed

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -772,7 +772,7 @@ public void withOdbc(final Command command, final String name)
         "Preparing " + name,
         "Using " + name, 
         new Dependency[] {
-           Dependency.cranPackage("odbc", "1.1.5"),
+           Dependency.cranPackage("odbc", "1.1.6"),
            Dependency.cranPackage("rstudioapi", "0.5")
         }, 
         true, // update odbc if needed

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/model/BuildServerOperations.java
Patch:
@@ -45,4 +45,7 @@ void startBuild(String type,
    
    // get bookdown output formats
    void getBookdownFormats(ServerRequestCallback<BookdownFormats> requestCallback);
+
+   // check if test file exists
+   void checkTestFileExists(ServerRequestCallback<Boolean> callback, String path);
 }

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeResources.java
Patch:
@@ -69,6 +69,9 @@ public interface ThemeResources extends ClientBundle
 
    @Source("rstudio_2x.png")
    ImageResource rstudio2x();
+   
+   @Source("rstudio_large_2x.png")
+   ImageResource rstudioLarge2x();
 
    @Source("rstudio_small_2x.png")
    ImageResource rstudio_small2x();

File: src/gwt/src/org/rstudio/studio/client/application/ui/AboutDialogContents.java
Patch:
@@ -55,7 +55,7 @@ public AboutDialogContents(ProductInfo info, ProductEditionInfo editionInfo)
       userAgentLabel.setText(
             Window.Navigator.getUserAgent());
       buildLabel.setText(
-           "Build " + info.build + " (" + info.commit.substring(0,  8) + ")");
+           "Build " + info.build + " (" + info.commit.substring(0, 8) + ")");
       noticeBox.setValue(info.notice);
       productName.setText(editionInfo.editionName());
       

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -161,7 +161,7 @@ public void withRPlumber(String userAction, final Command command)
             Dependency.cranPackage("jsonlite", "0.9.19"),
             Dependency.cranPackage("httpuv", "1.3.3"),
             Dependency.cranPackage("crayon", "1.3.4"),
-            Dependency.embeddedPackage("plumber")
+            Dependency.cranPackage("plumber", "0.4.6", true)
          },
          true,
          new CommandWithArg<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialogResources.java
Patch:
@@ -31,7 +31,6 @@ public interface Styles extends CssResource
       String alwaysCompletePanel();
       String themeInfobar();
       String themeInfobarShowing();
-      String settingDefault();
    }
 
    @Source("PreferencesDialog.css")

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialogResources.java
Patch:
@@ -31,6 +31,7 @@ public interface Styles extends CssResource
       String alwaysCompletePanel();
       String themeInfobar();
       String themeInfobarShowing();
+      String settingDefault();
    }
 
    @Source("PreferencesDialog.css")

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialogResources.java
Patch:
@@ -31,6 +31,7 @@ public interface Styles extends CssResource
       String alwaysCompletePanel();
       String themeInfobar();
       String themeInfobarShowing();
+      String settingDefault();
    }
 
    @Source("PreferencesDialog.css")

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -316,7 +316,8 @@ public boolean onApply(RPrefs rPrefs)
                                       mirrotTextValue.startsWith("http");
       ArrayList<CRANMirror> secondaryRepos = secondaryReposWidget_.getRepos();
 
-      if (cranRepoChangedToUrl || secondaryRepos.size() > 0) {
+      if (cranRepoChangedToUrl ||
+          secondaryRepos.size() != cranMirror_.getSecondaryRepos().size()) {
 
          if (cranRepoChangedToUrl)
          {
@@ -328,8 +329,7 @@ public boolean onApply(RPrefs rPrefs)
          }
          
          ArrayList<CRANMirror> repos = secondaryReposWidget_.getRepos();
-         if (repos.size() > 0)
-            cranMirror_.setSecondaryRepos(repos);
+         cranMirror_.setSecondaryRepos(repos);
 
          server_.setCRANMirror(
             cranMirror_,

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -316,7 +316,8 @@ public boolean onApply(RPrefs rPrefs)
                                       mirrotTextValue.startsWith("http");
       ArrayList<CRANMirror> secondaryRepos = secondaryReposWidget_.getRepos();
 
-      if (cranRepoChangedToUrl || secondaryRepos.size() > 0) {
+      if (cranRepoChangedToUrl ||
+          secondaryRepos.size() != cranMirror_.getSecondaryRepos().size()) {
 
          if (cranRepoChangedToUrl)
          {
@@ -328,8 +329,7 @@ public boolean onApply(RPrefs rPrefs)
          }
          
          ArrayList<CRANMirror> repos = secondaryReposWidget_.getRepos();
-         if (repos.size() > 0)
-            cranMirror_.setSecondaryRepos(repos);
+         cranMirror_.setSecondaryRepos(repos);
 
          server_.setCRANMirror(
             cranMirror_,

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -135,7 +135,7 @@ public void withR2D3(String userAction, final Command command)
          new Dependency[] {
             Dependency.cranPackage("htmltools", "0.3.6"),
             Dependency.cranPackage("htmlwidgets", "1.2", true),
-            Dependency.embeddedPackage("r2d3")
+            Dependency.cranPackage("r2d3", "0.2.0")
          },
          true,
          new CommandWithArg<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -30,7 +30,7 @@ public UrlContentEditingTargetWidget(Commands commands, String url)
    {
       commands_ = commands;
 
-      frame_ = new RStudioThemedFrame(url, true, "allow-same-origin", null, null, false);
+      frame_ = new RStudioThemedFrame(url, true, "allow-same-origin", null, null, false, true);
       frame_.setSize("100%", "100%");
 
       PanelWithToolbars panel = new PanelWithToolbars(createToolbar(),

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/data/DataOutputPane.java
Patch:
@@ -38,7 +38,7 @@ public DataOutputPane()
    @Override
    protected Widget createMainWidget()
    { 
-      gridViewer_ = new GridViewerFrame();
+      gridViewer_ = new GridViewerFrame(true);
       return gridViewer_;
    }
 

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.core.client.AnsiCodeTests;
 import org.rstudio.core.client.ConsoleOutputWriterTests;
 import org.rstudio.core.client.StringUtilTests;
+import org.rstudio.core.client.URIUtilsTests;
 import org.rstudio.core.client.VirtualConsoleTests;
 import org.rstudio.core.client.dom.DomUtilsTests;
 import org.rstudio.studio.client.common.r.RTokenizerTests;
@@ -42,6 +43,7 @@ public static Test suite()
         suite.addTestSuite(TerminalLocalEchoTests.class);
         suite.addTestSuite(TerminalSessionSocketTests.class);
         suite.addTestSuite(JobManagerTests.class);
+        suite.addTestSuite(URIUtilsTests.class);
         return suite;
     }
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -180,6 +180,7 @@ class ClientEvent extends JavaScriptObject
    public static final String JobRefresh = "job_refresh";
    public static final String JobOutput = "job_output";
    public static final String DataOutputCompleted = "data_output_completed";
+   public static final String NewDocumentWithCode = "new_document_with_code";
    public static final String PlumberViewer = "plumber_viewer";
 
    protected ClientEvent()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -2587,12 +2587,12 @@ else if (event.getType() == NewDocumentWithCodeEvent.SQL)
          @Override
          public void execute()
          {
-            newDoc(docType,  
-                  new ResultCallback<EditingTarget, ServerError>() {
+            newDoc(docType,
+                   event.getCode(),
+                   new ResultCallback<EditingTarget, ServerError>() {
                public void onSuccess(EditingTarget arg)
                {
                   TextEditingTarget editingTarget = (TextEditingTarget)arg;
-                  editingTarget.insertCode(event.getCode(), false);
                   
                   if (event.getCursorPosition() != null)
                   {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -108,7 +108,7 @@ public void execute(CRANMirror cranMirror)
                  
                }
             },
-            false);
+            true);
       
       cranMirrorTextBox_.getTextBox().addValueChangeHandler(new ValueChangeHandler<String>()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -108,7 +108,7 @@ public void execute(CRANMirror cranMirror)
                  
                }
             },
-            false);
+            true);
       
       cranMirrorTextBox_.getTextBox().addValueChangeHandler(new ValueChangeHandler<String>()
       {

File: src/gwt/src/org/rstudio/studio/client/common/repos/SecondaryReposDialog.java
Patch:
@@ -133,6 +133,7 @@ protected Widget createMainWidget()
       Label nameLabel = new Label("Name:");
       namePanel.add(nameLabel);
       nameTextBox_ = new TextBox();
+      nameTextBox_.setStylePrimaryName(RESOURCES.styles().nameTextBox());
       namePanel.add(nameTextBox_);
       customPanel.add(namePanel);
 
@@ -241,6 +242,7 @@ static interface Styles extends CssResource
       String customPanel();
       String namePanel();
       String urlTextBox();
+      String nameTextBox();
    }
   
    static interface Resources extends ClientBundle

File: src/gwt/src/org/rstudio/studio/client/common/repos/SecondaryReposWidget.java
Patch:
@@ -65,7 +65,6 @@ public SecondaryReposWidget()
       listBox_.setMultipleSelect(false);
       listBox_.addStyleName(RES.styles().listBox());
       listBox_.getElement().<SelectElement>cast().setSize(6);
-      listBox_.setHeight("90px");
       horizontal.add(listBox_);
       
       VerticalPanel buttonPanel = new VerticalPanel();

File: src/gwt/src/org/rstudio/studio/client/common/repos/model/SecondaryReposServerOperations.java
Patch:
@@ -23,5 +23,6 @@ public interface SecondaryReposServerOperations
 {
    void getSecondaryRepos(
          ServerRequestCallback<SecondaryReposResult> requestCallback,
-         String cranRepoUrl);
+         String cranRepoUrl,
+         boolean cranIsCustom);
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -5397,10 +5397,12 @@ public void hasShinyTestResults(String shinyApp, String testName, ServerRequestC
 
    @Override
    public void getSecondaryRepos(ServerRequestCallback<SecondaryReposResult> callback,
-                                 String cranRepoUrl)
+                                 String cranRepoUrl,
+                                 boolean cranIsCustom)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(cranRepoUrl));
+      params.set(1, JSONBoolean.getInstance(cranIsCustom));
 
       sendRequest(RPC_SCOPE,
                   GET_SECONDARY_REPOS,

File: src/gwt/src/org/rstudio/studio/client/common/repos/model/SecondaryReposServerOperations.java
Patch:
@@ -22,6 +22,6 @@
 public interface SecondaryReposServerOperations
 {
    void getSecondaryRepos(
-         ServerRequestCallback<JsArray<CRANMirror>> requestCallback,
+         ServerRequestCallback<SecondaryReposResult> requestCallback,
          String cranRepoUrl);
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -69,6 +69,7 @@
 import org.rstudio.studio.client.common.r.roxygen.RoxygenHelper.SetGenericCall;
 import org.rstudio.studio.client.common.r.roxygen.RoxygenHelper.SetMethodCall;
 import org.rstudio.studio.client.common.r.roxygen.RoxygenHelper.SetRefClassCall;
+import org.rstudio.studio.client.common.repos.model.SecondaryReposResult;
 import org.rstudio.studio.client.common.satellite.Satellite;
 import org.rstudio.studio.client.common.satellite.SatelliteManager;
 import org.rstudio.studio.client.common.shell.ShellInput;
@@ -5395,7 +5396,7 @@ public void hasShinyTestResults(String shinyApp, String testName, ServerRequestC
    }
 
    @Override
-   public void getSecondaryRepos(ServerRequestCallback<JsArray<CRANMirror>> callback,
+   public void getSecondaryRepos(ServerRequestCallback<SecondaryReposResult> callback,
                                  String cranRepoUrl)
    {
       JSONArray params = new JSONArray();

File: src/gwt/src/org/rstudio/studio/client/application/ui/GlobalToolbar.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * GlobalToolbar.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -59,6 +59,7 @@ public GlobalToolbar(Commands commands,
       newMenu_.addSeparator();
       newMenu_.addItem(commands.newRMarkdownDoc().createMenuItem(false));
       newMenu_.addItem(commands.newRShinyApp().createMenuItem(false));
+      newMenu_.addItem(commands.newRPlumberDoc().createMenuItem(false));
       newMenu_.addSeparator();
       newMenu_.addItem(commands.newTextDoc().createMenuItem(false));
       newMenu_.addItem(commands.newCppDoc().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectAccountWizard.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RSConnectAccountWizard.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -122,5 +122,5 @@ NewRSConnectAccountResult>> createPages()
    public static final String SERVICE_NAME =  "RStudio Connect";
    public static final String SERVICE_DESCRIPTION = 
      "RStudio Connect is a server product from RStudio " +
-     "for secure sharing of applications, reports, and plots.";
+     "for secure sharing of applications, reports, plots, and APIs.";
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ClientEvent.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -180,6 +180,7 @@ class ClientEvent extends JavaScriptObject
    public static final String JobRefresh = "job_refresh";
    public static final String JobOutput = "job_output";
    public static final String DataOutputCompleted = "data_output_completed";
+   public static final String PlumberViewer = "plumber_viewer";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -53,6 +53,7 @@
 import org.rstudio.studio.client.htmlpreview.events.ShowPageViewerHandler;
 import org.rstudio.studio.client.htmlpreview.model.HTMLPreviewParams;
 import org.rstudio.studio.client.pdfviewer.PDFViewer;
+import org.rstudio.studio.client.plumber.PlumberAPI;
 import org.rstudio.studio.client.projects.ProjectOpener;
 import org.rstudio.studio.client.projects.model.ProjectTemplateRegistryProvider;
 import org.rstudio.studio.client.rmarkdown.RmdOutput;
@@ -117,6 +118,7 @@ public Workbench(WorkbenchMainView view,
                     HTMLPreview htmlPreview,                    // force gin to create
                     ProfilerPresenter prof,                     // force gin to create
                     ShinyApplication sApp,                      // force gin to create
+                    PlumberAPI sAPI,                            // force gin to create
                     DependencyManager dm,                       // force gin to create
                     ApplicationVisibility av,                   // force gin to create
                     RmdOutput rmdOutput,                        // force gin to create    

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * PublishingPreferencesPane.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -193,7 +193,7 @@ public void execute(Boolean succeeded)
       lessSpaced(rsconnectPanel);
       
       add(headerLabel("Settings"));
-      CheckBox chkEnablePublishing = checkboxPref("Enable publishing documents and apps", 
+      CheckBox chkEnablePublishing = checkboxPref("Enable publishing documents, apps, and APIs", 
             uiPrefs_.showPublishUi());
       chkEnablePublishing.addValueChangeHandler(new ValueChangeHandler<Boolean>(){
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceShim.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SourceShim.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -94,6 +94,8 @@ public abstract static class AsyncSource extends AsyncShim<Source>
       @Handler
       public abstract void onNewRPresentationDoc();
       @Handler
+      public abstract void onNewRPlumberDoc();
+      @Handler
       public abstract void onNewSqlDoc();
       @Handler
       public abstract void onOpenSourceDoc();

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ModalDialogBase.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -329,8 +329,7 @@ protected ProgressIndicator addProgressIndicator()
       return addProgressIndicator(true);
    }
 
-   protected ProgressIndicator addProgressIndicator(
-                                                    final boolean closeOnCompleted)
+   protected ProgressIndicator addProgressIndicator(final boolean closeOnCompleted)
    {
       final SlideLabel label = new SlideLabel(true);
       Element labelEl = label.getElement();

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreview.java
Patch:
@@ -49,7 +49,7 @@ public void onShowHTMLPreview(ShowHTMLPreviewEvent event)
             {
                satelliteManager.openSatellite(HTMLPreviewApplication.NAME,     
                                               event.getParams(),
-                                              new Size(1100,1200));
+                                              new Size(1180,1200));
                                               
             } 
          }  

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -86,7 +86,7 @@ public final Size getPreferredSize()
          return new Size(1100, 900 + chromeHeight);
       
       // default size (html_document and others)
-      return new Size(1100, 1000 + chromeHeight);
+      return new Size(1180, 1000 + chromeHeight);
    }
    
    public final boolean isWebsiteRmd() 

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreview.java
Patch:
@@ -49,7 +49,7 @@ public void onShowHTMLPreview(ShowHTMLPreviewEvent event)
             {
                satelliteManager.openSatellite(HTMLPreviewApplication.NAME,     
                                               event.getParams(),
-                                              new Size(1100,1200));
+                                              new Size(1180,1200));
                                               
             } 
          }  

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -86,7 +86,7 @@ public final Size getPreferredSize()
          return new Size(1100, 900 + chromeHeight);
       
       // default size (html_document and others)
-      return new Size(1100, 1000 + chromeHeight);
+      return new Size(1180, 1000 + chromeHeight);
    }
    
    public final boolean isWebsiteRmd() 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -650,7 +650,7 @@ public void adaptToFileType(TextFileType fileType)
       
       sourceOnSave_.setVisible(canSourceOnSave);
       srcOnSaveLabel_.setVisible(canSourceOnSave);
-      if (fileType.isRd() || fileType.isJS() || canPreviewFromR)
+      if (fileType.isRd() || fileType.isJS() || canPreviewFromR || fileType.isSql() )
          srcOnSaveLabel_.setText(fileType.getPreviewButtonText() + " on Save");
       else
          srcOnSaveLabel_.setText("Source on Save");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetSqlHelper.java
Patch:
@@ -45,7 +45,7 @@ void initialize(EventBus eventBus, SourceServerOperations server)
    public void previewSql(EditingTarget editingTarget)
    {
       SqlPreview sqlPreview = parseSqlPreview();
-      if (sqlPreview != null && sqlPreview.pkg.equals("DBI"))
+      if (sqlPreview != null && sqlPreview.pkg.equals("dbGetQuery"))
       {
          server_.getMinimalSourcePath(
             editingTarget.getPath(), 
@@ -70,7 +70,7 @@ private SqlPreview parseSqlPreview()
          {
             continue;
          }
-         else if (line.startsWith("//"))
+         else if (line.startsWith("--"))
          {
             Match match = sqlPreviewPattern_.match(line, 0);
             if (match != null)
@@ -99,7 +99,7 @@ public SqlPreview(String pkg, String args)
    }
    
    private static final Pattern sqlPreviewPattern_ = 
-         Pattern.create("^//\\s*!preview\\s+(\\w+)(.*)$");
+         Pattern.create("^--\\s*!preview\\s+(\\w+)(.*)$");
    
    private EventBus eventBus_; 
    private DocDisplay docDisplay_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5347,7 +5347,7 @@ void previewJS()
          @Override
          public void execute()
          {
-            save(new Command() {
+            saveThenExecute(null, new Command() {
                @Override
                public void execute()
                {
@@ -5364,7 +5364,7 @@ void previewSql()
          @Override
          public void execute()
          {
-            save(new Command() {
+            saveThenExecute(null, new Command() {
                @Override
                public void execute()
                {

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -801,7 +801,7 @@ public void withDBI(String userAction, final Command command)
         "DBI",
          userAction,
          new Dependency[] {
-            Dependency.cranPackage("dbi", "0.8")
+            Dependency.cranPackage("DBI", "0.8")
          },
          true,
          new CommandWithArg<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkHtmlPage.java
Patch:
@@ -51,7 +51,7 @@ public ChunkHtmlPage(String url, NotebookHtmlMetadata metadata,
          url += "&";
       else
          url += "?";
-      url += "viewer_pane=1";
+      url += "viewer_pane=1&capabilities=1";
 
       frame_ = new ChunkOutputFrame();
       

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -546,7 +546,7 @@ private void satelliteEditFile(JavaScriptObject file,
    {
       FileSystemItem fsi = file.cast();
       FilePosition pos = position.cast();
-      editFile(fsi, pos);
+      editFile(fsi, pos, highlightLine);
    }
 
    private final native void exportEditFileCallback()/*-{

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreviewPresenter.java
Patch:
@@ -204,6 +204,7 @@ public void onHTMLPreviewCompleted(HTMLPreviewCompletedEvent event)
                                             "host",
                                             htmlMessageListener_.getOriginDomain());
                
+               htmlMessageListener_.allowOpenOnLoad();
                htmlMessageListener_.setUrl(url);
 
                view_.showPreview(

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -20,11 +20,11 @@
 import com.google.inject.Singleton;
 import com.google.inject.name.Names;
 
-import org.rstudio.core.client.CodeNavigationListener;
 import org.rstudio.core.client.command.ApplicationCommandManager;
 import org.rstudio.core.client.command.EditorCommandManager;
 import org.rstudio.core.client.command.ShortcutViewer;
 import org.rstudio.core.client.command.UserCommandManager;
+import org.rstudio.core.client.HtmlMessageListener;
 import org.rstudio.studio.client.application.ApplicationInterrupt;
 import org.rstudio.studio.client.application.ApplicationQuit;
 import org.rstudio.studio.client.application.ApplicationView;
@@ -287,7 +287,7 @@ protected void configure()
       bind(ProjectTemplateRegistryProvider.class).in(Singleton.class);
       bind(PackageProvidedExtensions.class).asEagerSingleton();
       bind(JavaScriptEventHistory.class).asEagerSingleton();
-      bind(CodeNavigationListener.class).asEagerSingleton();
+      bind(HtmlMessageListener.class).asEagerSingleton();
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -18,7 +18,7 @@
 import com.google.gwt.inject.client.GinModules;
 import com.google.gwt.inject.client.Ginjector;
 
-import org.rstudio.core.client.CodeNavigationListener;
+import org.rstudio.core.client.HtmlMessageListener;
 import org.rstudio.core.client.VirtualConsole;
 import org.rstudio.core.client.command.AddinCommandBinding;
 import org.rstudio.core.client.command.ApplicationCommandManager;
@@ -285,5 +285,5 @@ public interface RStudioGinjector extends Ginjector
    AddinsCommandManager getAddinsCommandManager();
    DependencyManager getDependencyManager();
    ShinyTestPopupMenu getShinyTestPopupMenu();
-   CodeNavigationListener getCodeNavigationListener();
+   HtmlMessageListener getHtmlMessageListener();
 }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.inject.Singleton;
 import com.google.inject.name.Names;
 
+import org.rstudio.core.client.CodeNavigationListener;
 import org.rstudio.core.client.command.ApplicationCommandManager;
 import org.rstudio.core.client.command.EditorCommandManager;
 import org.rstudio.core.client.command.ShortcutViewer;
@@ -286,6 +287,7 @@ protected void configure()
       bind(ProjectTemplateRegistryProvider.class).in(Singleton.class);
       bind(PackageProvidedExtensions.class).asEagerSingleton();
       bind(JavaScriptEventHistory.class).asEagerSingleton();
+      bind(CodeNavigationListener.class).asEagerSingleton();
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.inject.client.GinModules;
 import com.google.gwt.inject.client.Ginjector;
 
+import org.rstudio.core.client.CodeNavigationListener;
 import org.rstudio.core.client.VirtualConsole;
 import org.rstudio.core.client.command.AddinCommandBinding;
 import org.rstudio.core.client.command.ApplicationCommandManager;
@@ -284,4 +285,5 @@ public interface RStudioGinjector extends Ginjector
    AddinsCommandManager getAddinsCommandManager();
    DependencyManager getDependencyManager();
    ShinyTestPopupMenu getShinyTestPopupMenu();
+   CodeNavigationListener getCodeNavigationListener();
 }

File: src/gwt/src/org/rstudio/core/client/ElementIds.java
Patch:
@@ -66,4 +66,5 @@ public static String idFromLabel(String label)
    public final static String SHELL_WIDGET = "shell_widget";
    public final static String SOURCE_TEXT_EDITOR = "source_text_editor";
    public final static String XTERM_WIDGET = "xterm_widget";
+   public final static String FILE_DIALOG_NAME_PROMPT = "file_dialog_name_prompt";
 }

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileBrowserWidget.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.core.client.files.filedialog;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.FocusTransitionManager;
 import org.rstudio.core.client.events.SelectionCommitHandler;
 import org.rstudio.core.client.files.FileSystemContext;
@@ -194,6 +195,7 @@ private Widget createTopWidget()
       if (initialFilename_ != null)
          filename_.setText(initialFilename_);
       filename_.setStylePrimaryName(styles.filename());
+      filename_.getElement().setId(ElementIds.FILE_DIALOG_NAME_PROMPT);
       filenamePanel.add(filename_);
       filenamePanel.setCellWidth(filename_, "100%");
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobItem.java
Patch:
@@ -122,7 +122,7 @@ public void syncTime(int timestamp)
       // if job is not running, we have nothing to do
       if (job_.state == JobConstants.STATE_IDLE)
       {
-         elapsed_.setText("");
+         elapsed_.setText("Waiting");
          return;
       }
       

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -70,6 +70,7 @@
    public abstract AppCommand insertChunk();
    public abstract AppCommand insertChunkR();
    public abstract AppCommand insertChunkBash();
+   public abstract AppCommand insertChunkD3();
    public abstract AppCommand insertChunkPython();
    public abstract AppCommand insertChunkRCPP();
    public abstract AppCommand insertChunkStan(); 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -355,6 +355,7 @@ private Toolbar createToolbar(TextFileType fileType)
          insertChunksMenu.addItem(commands_.insertChunkBash().createMenuItem(false));
       }
 
+      insertChunksMenu.addItem(commands_.insertChunkD3().createMenuItem(false));
       insertChunksMenu.addItem(commands_.insertChunkPython().createMenuItem(false));
       insertChunksMenu.addItem(commands_.insertChunkRCPP().createMenuItem(false));
       insertChunksMenu.addItem(commands_.insertChunkSQL().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -164,6 +164,9 @@ void openTerminal(String terminalPath,
    
    void setBackgroundColor(JsArrayInteger rgbColor);
    
+   void getEnableAccessibility(CommandWithArg<Boolean> callback);
+   void setEnableAccessibility(boolean enable);
+   
    void showLicenseDialog();
    void getInitMessages(CommandWithArg<String> callback);
    void getLicenseStatusMessage(CommandWithArg<String> callback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1254,12 +1254,13 @@ public void onNewD3Doc()
          FileTypeRegistry.JS, 
          "", 
          "d3.js",
-         Position.create(0, 0),
+         Position.create(5, 0),
          new CommandWithArg<EditingTarget> () {
            @Override
            public void execute(EditingTarget target)
            {
               target.verifyD3Prerequisites(); 
+              target.setSourceOnSave(true);
            }
          }
       );

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -86,6 +86,8 @@ void navigateToPosition(SourcePosition position,
    
    void forceLineHighlighting();
    
+   void setSourceOnSave(boolean sourceOnSave);
+   
    void setCursorPosition(Position position);
    void ensureCursorVisible();
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -381,6 +381,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.notebookClearAllOutput());
       dynamicCommands_.add(commands.notebookToggleExpansion());
       dynamicCommands_.add(commands.sendToTerminal());
+      dynamicCommands_.add(commands.renameSourceDoc());
       for (AppCommand command : dynamicCommands_)
       {
          command.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1253,12 +1253,13 @@ public void onNewD3Doc()
          FileTypeRegistry.JS, 
          "", 
          "d3.js",
-         Position.create(0, 0),
+         Position.create(5, 0),
          new CommandWithArg<EditingTarget> () {
            @Override
            public void execute(EditingTarget target)
            {
               target.verifyD3Prerequisites(); 
+              target.setSourceOnSave(true);
            }
          }
       );

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -86,6 +86,8 @@ void navigateToPosition(SourcePosition position,
    
    void forceLineHighlighting();
    
+   void setSourceOnSave(boolean sourceOnSave);
+   
    void setCursorPosition(Position position);
    void ensureCursorVisible();
    

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -117,6 +117,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditorIdleCommands;
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditorMixins;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetIdleMonitor;
+import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetJSHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditorWidget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ChunkSatellite;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ChunkWindowManager;
@@ -176,6 +177,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(TextEditingTargetPresentationHelper presHelper);
    void injectMembers(TextEditingTargetRMarkdownHelper rmarkdownHelper);
    void injectMembers(TextEditingTargetCppHelper cppHelper);
+   void injectMembers(TextEditingTargetJSHelper jsHelper);
    void injectMembers(TextEditingTargetChunks chunks);
    void injectMembers(EditingTargetCodeExecution codeExecution);
    void injectMembers(LocalRepositoriesWidget localRepositoriesWidget);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -133,7 +133,7 @@ public class FileTypeRegistry
          new TextFileType("js", "JavaScript", EditorLanguage.LANG_JAVASCRIPT, ".js",
                           new ImageResource2x(ICONS.iconJavascript2x()),
                           true,
-                          false, false, false, false, false, false, false, false, false, false, false, false);
+                          true, false, false, false, false, false, false, false, false, false, false, false);
    
    public static final TextFileType JSON =
          new TextFileType("json", "JSON", EditorLanguage.LANG_JAVASCRIPT, ".json",

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -52,6 +52,7 @@
    public abstract AppCommand closeAllSourceDocs();
    public abstract AppCommand executeAllCode();
    public abstract AppCommand sourceFile();
+   public abstract AppCommand previewJS();
    public abstract AppCommand sourceActiveDocument();
    public abstract AppCommand sourceActiveDocumentWithEcho();
    public abstract AppCommand executeCode();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -322,6 +322,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.executeSubsequentChunks());
       dynamicCommands_.add(commands.executeCurrentChunk());
       dynamicCommands_.add(commands.executeNextChunk());
+      dynamicCommands_.add(commands.previewJS());
       dynamicCommands_.add(commands.sourceActiveDocument());
       dynamicCommands_.add(commands.sourceActiveDocumentWithEcho());
       dynamicCommands_.add(commands.knitDocument());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -271,7 +271,7 @@ private boolean isExecutableKnitrEngine(String engine)
    
    // runnable engines within the R Notebook mode
    private static final String RE_RUNNABLE_ENGINES =
-         "r|rscript|rcpp|python|ruby|perl|bash|sh|stan|sql|";
+         "r|rscript|rcpp|python|ruby|perl|bash|sh|stan|sql|d3|";
    
    // renderPass_ need only be unique from one pass through the scope tree to
    // the next; we wrap it at 255 to avoid the possibility of overflow

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextUi.java
Patch:
@@ -228,7 +228,8 @@ private ChunkOptionsPopupPanel createPopupPanel()
          return new SetupChunkOptionsPopupPanel();
       
       String engine = getEngine(row);
-      if (!engine.toLowerCase().equals("r"))
+      if (!engine.toLowerCase().equals("r") &&
+          !engine.toLowerCase().equals("d3"))
          return new CustomEngineChunkOptionsPopupPanel(engine_);
       
       return new DefaultChunkOptionsPopupPanel(engine_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceDocument.java
Patch:
@@ -183,4 +183,5 @@ public native final JsArrayString getReadOnlyAlternatives() /*-{
    public final static String XT_TEST_PREFIX = "test-";
    public final static String XT_TEST_TESTTHAT = "test-testthat";
    public final static String XT_TEST_SHINYTEST = "test-shinytest";
+   public final static String XT_JS_PREVIEWABLE = "js-previewable";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetChunks.java
Patch:
@@ -271,7 +271,7 @@ private boolean isExecutableKnitrEngine(String engine)
    
    // runnable engines within the R Notebook mode
    private static final String RE_RUNNABLE_ENGINES =
-         "r|rscript|rcpp|python|ruby|perl|bash|sh|stan|sql|";
+         "r|rscript|rcpp|python|ruby|perl|bash|sh|stan|sql|d3|";
    
    // renderPass_ need only be unique from one pass through the scope tree to
    // the next; we wrap it at 255 to avoid the possibility of overflow

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextUi.java
Patch:
@@ -228,7 +228,8 @@ private ChunkOptionsPopupPanel createPopupPanel()
          return new SetupChunkOptionsPopupPanel();
       
       String engine = getEngine(row);
-      if (!engine.toLowerCase().equals("r"))
+      if (!engine.toLowerCase().equals("r") &&
+          !engine.toLowerCase().equals("d3"))
          return new CustomEngineChunkOptionsPopupPanel(engine_);
       
       return new DefaultChunkOptionsPopupPanel(engine_);

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -38,18 +38,21 @@ void getOpenFileName(String caption,
                         String dir,
                         String filter,
                         boolean canChooseDirectories,
+                        boolean focusOpener,
                         CommandWithArg<String> callback);
    
    void getSaveFileName(String caption,
                         String label,
                         String dir, 
                         String defaultExtension, 
                         boolean forceDefaultExtension,
+                        boolean focusOpener,
                         CommandWithArg<String> callback);
    
    void getExistingDirectory(String caption,
                              String label,
                              String dir,
+                             boolean focusOpener,
                              CommandWithArg<String> callback);
    
    void undo();

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -568,6 +568,7 @@ public void execute(FileSystemItem input,
                   initialFilePath,
                   filter,
                   false,
+                  false,
                   onSelected);
          }
          else
@@ -579,6 +580,7 @@ public void execute(FileSystemItem input,
                   initialFilePath,
                   "",
                   false,
+                  false,
                   onSelected);
          }
       }
@@ -589,6 +591,7 @@ else if (type == OpenFileDialogEvent.TYPE_SELECT_DIRECTORY)
                label,
                fsContext_,
                initialFilePath,
+               false,
                onSelected);
       }
       else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -122,7 +122,6 @@ public Shell(ConsoleServerOperations server,
       historyManager_ = new CommandLineHistory(input_);
       browseHistoryManager_ = new CommandLineHistory(input_);
       prefs_ = uiPrefs;
-      editorProvider_ = editorProvider;
       languageTracker_ = languageTracker;
       
       editorProvider.setConsoleEditor(input_);
@@ -767,7 +766,6 @@ public void onSelected()
    private String lastPromptText_ ;
    private final UIPrefs prefs_;
    
-   private final ConsoleEditorProvider editorProvider_;
    private final ConsoleLanguageTracker languageTracker_;
    
    private final CommandLineHistory historyManager_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -242,9 +242,10 @@ public void showOutput(CompileOutput output, boolean scrollToBottom)
    public void showErrors(String basePath,
                           JsArray<SourceMarker> errors, 
                           boolean ensureVisible,
-                          int autoSelect)
+                          int autoSelect,
+                          boolean openErrors)
    {
-      compilePanel_.showErrors(basePath, errors, autoSelect);
+      compilePanel_.showErrors(basePath, errors, autoSelect, openErrors);
       
       if (ensureVisible && SourceMarker.showErrorList(errors))
          ensureVisible();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/common/CompileOutputPane.java
Patch:
@@ -116,7 +116,7 @@ public void showOutput(CompileOutput output, boolean scrollToBottom)
    @Override
    public void showErrors(JsArray<SourceMarker> errors)
    {
-      compilePanel_.showErrors(null, errors, SourceMarkerList.AUTO_SELECT_FIRST);
+      compilePanel_.showErrors(null, errors, SourceMarkerList.AUTO_SELECT_FIRST, true);
       
       if (SourceMarker.showErrorList(errors))
          ensureVisible(true);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -242,9 +242,10 @@ public void showOutput(CompileOutput output, boolean scrollToBottom)
    public void showErrors(String basePath,
                           JsArray<SourceMarker> errors, 
                           boolean ensureVisible,
-                          int autoSelect)
+                          int autoSelect,
+                          boolean openErrors)
    {
-      compilePanel_.showErrors(basePath, errors, autoSelect);
+      compilePanel_.showErrors(basePath, errors, autoSelect, openErrors);
       
       if (ensureVisible && SourceMarker.showErrorList(errors))
          ensureVisible();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/common/CompileOutputPane.java
Patch:
@@ -116,7 +116,7 @@ public void showOutput(CompileOutput output, boolean scrollToBottom)
    @Override
    public void showErrors(JsArray<SourceMarker> errors)
    {
-      compilePanel_.showErrors(null, errors, SourceMarkerList.AUTO_SELECT_FIRST);
+      compilePanel_.showErrors(null, errors, SourceMarkerList.AUTO_SELECT_FIRST, true);
       
       if (SourceMarker.showErrorList(errors))
          ensureVisible(true);

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.js.BaseExpression;
 import org.rstudio.core.client.js.JavaScriptPassthrough;
 
+import com.google.gwt.core.client.JsArrayInteger;
 import com.google.gwt.user.client.Command;
 
 /**
@@ -158,6 +159,8 @@ void openTerminal(String terminalPath,
    void zoomOut();
    void zoomActualSize();
    
+   void setBackgroundColor(JsArrayInteger rgbColor);
+   
    void showLicenseDialog();
    void getInitMessages(CommandWithArg<String> callback);
    void getLicenseStatusMessage(CommandWithArg<String> callback);

File: src/gwt/src/org/rstudio/studio/client/application/ui/RStudioThemes.java
Patch:
@@ -65,6 +65,7 @@ public static void initializeThemes(String themeName,
          }
             
          element.addClassName("rstudio-themes-" + themeName);
+         element.setId("rstudio_container");
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -219,7 +219,6 @@ public void onError(ServerError error)
       }) ;
    }  
    
-   
    @Handler
    public void onShowToolbar()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -327,6 +327,9 @@ public void syncHeight(final boolean scrollToBottom,
       {
          int contentHeight = root_.getElement().getOffsetHeight() + 19;
          height = Math.max(ChunkOutputUi.MIN_CHUNK_HEIGHT, contentHeight);
+         
+         // clamp height of widgets
+         height = Math.min(height, ChunkOutputUi.MAX_CHUNK_HEIGHT);
 
          // if we have renders pending, don't shrink until they're loaded 
          if (pendingRenders_ > 0 && height < renderedHeight_)

File: src/gwt/src/org/rstudio/studio/client/application/Desktop.java
Patch:
@@ -27,7 +27,7 @@ public static native boolean isDesktop() /*-{
    public static native boolean isDesktopReady() /*-{
       return !!$wnd.desktop;
    }-*/;
-
+   
    public static DesktopFrame getFrame()
    {
       return desktopFrame_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -425,7 +425,7 @@ public void onAttachOrDetach(AttachEvent event)
          public void onFocus(FocusEvent event)
          {
             String id = AceEditor.this.getWidget().getElement().getId();
-            MainWindowObject.lastFocusedEditor().set(id);
+            MainWindowObject.lastFocusedEditorId().set(id);
          }
       });
       

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -723,7 +723,8 @@ public void withOdbc(final Command command, final String name)
         "Preparing " + name,
         "Using " + name, 
         new Dependency[] {
-           Dependency.cranPackage("odbc", "1.1.5")
+           Dependency.cranPackage("odbc", "1.1.5"),
+           Dependency.cranPackage("rstudioapi", "0.5")
         }, 
         true, // update odbc if needed
         new CommandWithArg<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/jobs/view/JobProgress.java
Patch:
@@ -51,6 +51,7 @@ public void showProgress(GlobalJobProgress progress)
    @Override
    public void updateElapsed(int timestamp)
    {
+      // TODO: this should not be diffing times from the client and the server
       elapsed_.setText(StringUtil.conciseElaspedTime(timestamp - started_));
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/MainWindowObject.java
Patch:
@@ -98,7 +98,7 @@ public static final MainWindowObject<Window> lastFocusedWindow()
          @Override
          public Window defaultValue()
          {
-            return null;
+            return ownWindow();
          }
       });
    }
@@ -153,6 +153,8 @@ public RAddins defaultValue()
    
    // Private methods ----
    
+   private static final native Window ownWindow() /*-{ return $wnd; }-*/;
+   
    private static final String LAST_FOCUSED_WINDOW           = "last_focused_window";
    private static final String LAST_FOCUSED_WINDOW_ID        = "last_focused_window_id";
    private static final String LAST_FOCUSED_EDITOR_ID        = "last_focused_editor_id";

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -107,7 +107,7 @@ public void onVisibleChanged(AppCommand command)
    
    public AppCommand()
    {
-      if (Desktop.isDesktop())
+      if (Desktop.isDesktopReady())
       {
          addEnabledChangedHandler((command) ->
             DesktopMenuCallback.setCommandEnabled(id_, enabled_));
@@ -386,7 +386,7 @@ public void setMenuLabel(String menuLabel)
       menuLabel_ = menuLabel;
 
       // sync with desktop frame
-      if (Desktop.isDesktop())
+      if (Desktop.isDesktopReady())
          DesktopMenuCallback.setCommandLabel(id_, menuLabel_);
    }
 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeploy.java
Patch:
@@ -97,6 +97,7 @@ public interface DeployStyle extends CssResource
       String appErrorPanel();
       String appWarningIcon();
       String controlLabel();
+      String deployIllustration();
       String deployLabel();
       String descriptionPanel();
       String fileList();

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -471,7 +471,8 @@
    public abstract AppCommand roxygenizePackage();
    public abstract AppCommand checkPackage();
    public abstract AppCommand testPackage();
-   public abstract AppCommand testFile();
+   public abstract AppCommand testTestthatFile();
+   public abstract AppCommand testShinytestFile();
    public abstract AppCommand stopBuild();
    public abstract AppCommand buildToolsProjectSetup();
    public abstract AppCommand activateBuild();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -308,7 +308,7 @@ void onTestPackage()
       startBuild("test-package");
    }
 
-   void onTestFile()
+   void onTestTestthatFile()
    {
       startBuild("test-file");
    }

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -67,7 +67,6 @@ void getExistingDirectory(String caption,
    void doesWindowExistAtCursorPosition(CommandWithArg<Boolean> callback);
    void getCursorPosition(CommandWithArg<Point> callback);
    
-   String getUriForPath(String path);
    void onWorkbenchInitialized(String scratchDir);
    void showFolder(String path);
    void showFile(String path);

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -56,7 +56,7 @@ public final native String getClientVersion() /*-{
    public final native String getUserIdentity() /*-{
       return this.userIdentity;
    }-*/;
-
+   
    public final native String getSessionId() /*-{
       return this.session_id;
    }-*/;
@@ -550,4 +550,5 @@ public final native String getDefaultRSConnectServer() /*-{
    public final native String getRLibsUser() /*-{
       return this.r_libs_user;
    }-*/;
+   
 }

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -67,7 +67,6 @@ void getExistingDirectory(String caption,
    void doesWindowExistAtCursorPosition(CommandWithArg<Boolean> callback);
    void getCursorPosition(CommandWithArg<Point> callback);
    
-   String getUriForPath(String path);
    void onWorkbenchInitialized(String scratchDir);
    void showFolder(String path);
    void showFile(String path);

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -260,7 +260,7 @@ else if (left != null && right == null)
                   parent_.insertAfter(range.element, overlap.element);
             }
          }
-         else if (start <= l && end <= r && end >= l)
+         else if (start <= l && end <= r && end > l)
          {
             // overlapping on the right side of the new range
             int delta = end - l;

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -260,7 +260,7 @@ else if (left != null && right == null)
                   parent_.insertAfter(range.element, overlap.element);
             }
          }
-         else if (start <= l && end <= r && end >= l)
+         else if (start <= l && end <= r && end > l)
          {
             // overlapping on the right side of the new range
             int delta = end - l;

File: src/gwt/src/org/rstudio/core/client/events/UpdateTabPanelsEvent.java
Patch:
@@ -24,7 +24,7 @@ public interface Handler extends EventHandler
       void onUpdateTabPanels(UpdateTabPanelsEvent event);
    }
 
-   public UpdateTabPanelsEvent(string activeTab)
+   public UpdateTabPanelsEvent(String activeTab)
    {
       activeTab_ = activeTab;
    }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -5284,7 +5284,7 @@ public void installShinyTestDependencies(ServerRequestCallback<ConsoleProcess> c
    {
       sendRequest(RPC_SCOPE,
                   INSTALL_SHINYTEST_DEPENDENCIES,
-                  callback);
+                  new ConsoleProcessCallbackAdapter(callback));
    }
 
    private String clientId_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -125,7 +125,7 @@ private boolean usingCache(
          // otherwise, produce a new completion list
          if (diff.length() > 0 && !diff.endsWith("::"))
          {
-            callback.onResponseReceived(narrow(token, diff, cachedResult)) ;
+            callback.onResponseReceived(narrow(cachedResult.token + diff, diff, cachedResult)) ;
             return true;
          }
       }

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -737,7 +737,7 @@ public void withTestPackage(final Command command, boolean useTestThat)
         "Preparing Tests",
         message, 
         dependencies, 
-        true, // update shinytest if needed
+        true, // update package if needed
         new CommandWithArg<Boolean>()
         {
            @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -6753,7 +6753,7 @@ public void execute()
                events_.fireEvent(new SendToConsoleEvent(code, true));
             }
          },
-         true
+         false
       );
    }
 
@@ -6782,7 +6782,7 @@ public void onError(ServerError error)
                });
             }
          },
-         true
+         false
       );
    }
 
@@ -6801,7 +6801,7 @@ public void execute()
                events_.fireEvent(new SendToConsoleEvent(code, true));
             }
          },
-         true
+         false
       );
    }
    

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -116,10 +116,9 @@ void showMessageBox(int type,
    void promptForText(String title,
                       String label,
                       String initialValue,
-                      boolean usePasswordMask,
+                      int type,
                       String rememberPasswordPrompt,
                       boolean rememberByDefault,
-                      boolean numbersOnly,
                       int selectionStart,
                       int selectionLength,
                       String okButtonCaption,

File: src/gwt/src/org/rstudio/studio/client/common/TextInput.java
Patch:
@@ -23,8 +23,7 @@ public interface TextInput
    public void promptForText(String title,
                              String label,
                              String initialValue,
-                             boolean usePasswordMask,
-                             boolean numbersOnly,
+                             int type,
                              int selectionStart,
                              int selectionLength,
                              String okButtonCaption,
@@ -35,7 +34,7 @@ void promptForTextWithOption(
                           String title,
                           String label,
                           String initialValue,
-                          boolean usePasswordMask,
+                          int type,
                           // Null or "" means don't prompt for remembering pw
                           String extraOptionPrompt,
                           boolean extraOptionDefault,

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/RStudioAPI.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RStudioAPI.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -133,9 +133,9 @@ private void showPrompt(String title,
          title, 
          message, 
          prompt, 
-         false, 
+         MessageDisplay.INPUT_REQUIRED_TEXT,
          null, 
-         false, 
+         false,
          new ProgressOperationWithInput<PromptWithOptionResult>() {
             @Override
             public void execute(PromptWithOptionResult input,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptionsUiCsv.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.workbench.views.environment.dataimport;
 
+import org.rstudio.core.client.MessageDisplay;
 import org.rstudio.core.client.MessageDisplay.PromptWithOptionResult;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.OperationWithInput;
@@ -205,7 +206,7 @@ public void onChange(ChangeEvent arg0)
                   "Other Delimiter",
                   "Please enter a single character delimiter.",
                   "",
-                  false,
+                  MessageDisplay.INPUT_REQUIRED_TEXT,
                   "",
                   false,
                   new ProgressOperationWithInput<PromptWithOptionResult>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4428,7 +4428,7 @@ void onInsertChunkPython()
    @Handler
    void onInsertChunkRCPP()
    {
-      onInsertChunk("```{rcpp}\n\n```\n", 1, 0);
+      onInsertChunk("```{Rcpp}\n\n```\n", 1, 0);
    }
 
    @Handler

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -529,7 +529,7 @@
    public abstract AppCommand shinyRunInBrowser();
    public abstract AppCommand shinyRecordTest();
    public abstract AppCommand shinyRunAllTests();
-   public abstract AppCommand shinyCompareFile();
+   public abstract AppCommand shinyCompareTest();
    
    // RSConnect connectivity
    public abstract AppCommand rsconnectDeploy();

File: src/gwt/src/org/rstudio/core/client/theme/ThemeFonts.java
Patch:
@@ -26,12 +26,12 @@ public class ThemeFonts
    
    public static String getProportionalFont()
    {
-      return fontLoader.getProportionalFont();
+      return fontLoader.getProportionalFont() + ", serif";
    }
 
    public static String getFixedWidthFont()
    {
-      return fontLoader.getFixedWidthFont();
+      return fontLoader.getFixedWidthFont() + ", monospace";
    }
 
    static interface ThemeFontLoader

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -595,7 +595,7 @@ public void adaptToFileType(TextFileType fileType)
       
       // don't show the run buttons for cpp files, or R files in Shiny/Tests
       runButton_.setVisible(canExecuteCode && !canExecuteChunks && !isCpp && 
-            !(isShinyFile() || isTestThatFile()) && !(isScript && !terminalAllowed));
+            !isShinyFile() && !(isScript && !terminalAllowed));
       runLastButton_.setVisible(runButton_.isVisible() && !canExecuteChunks && !isScript);
       
       // show insertion options for various knitr engines in rmarkdown v2
@@ -652,7 +652,7 @@ public void adaptToFileType(TextFileType fileType)
          shinyLaunchButton_.setVisible(true);
          setSourceButtonFromShinyState();
       }
-      if (isTestThatFile())
+      else if (isTestThatFile())
       {
          shinyLaunchButton_.setVisible(false);
          sourceButton_.setVisible(false);
@@ -725,7 +725,7 @@ private void manageToolbarSizes()
          return;
       
       texToolbarButton_.setText(width < 520 ? "" : "Format");
-      runButton_.setText(((width < 480) || isShinyFile() || isTestThatFile()) ? "" : "Run");
+      runButton_.setText(((width < 480) || isShinyFile()) ? "" : "Run");
       compilePdfButton_.setText(width < 450 ? "" : "Compile PDF");
       previewHTMLButton_.setText(width < 450 ? "" : previewCommandText_);
       knitDocumentButton_.setText(width < 450 ? "" : knitCommandText_);

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -69,7 +69,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_SQL = new EditorLanguage(
          "mode/sql", false, true);
    public static final EditorLanguage LANG_SH = new EditorLanguage(
-         "ace/mode/sh", false, false);
+         "mode/sh", false, false);
    public static final EditorLanguage LANG_TOML = new EditorLanguage(
          "ace/mode/toml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -69,7 +69,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_SQL = new EditorLanguage(
          "mode/sql", false, true);
    public static final EditorLanguage LANG_SH = new EditorLanguage(
-         "ace/mode/sh", false, false);
+         "mode/sh", false, false);
    public static final EditorLanguage LANG_TOML = new EditorLanguage(
          "ace/mode/toml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(

File: src/gwt/src/org/rstudio/core/client/StringUtil.java
Patch:
@@ -1224,9 +1224,8 @@ public static final int detectIndent(JsArrayString lines)
                score += indentCount;
          }
          
-         // record if this is the highest scoring indent (penalize small indents
-         // a bit)
-         if (score - potentialIndent >= detectedIndentScore)
+         // record if this is the highest scoring indent
+         if (score >= detectedIndentScore)
          {
             detectedIndentSize = potentialIndent;
             detectedIndentScore = score;

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -155,6 +155,7 @@
 import org.rstudio.studio.client.workbench.views.buildtools.model.BookdownFormats;
 import org.rstudio.studio.client.workbench.views.connections.model.ConnectionId;
 import org.rstudio.studio.client.workbench.views.connections.model.ConnectionObjectSpecifier;
+import org.rstudio.studio.client.workbench.views.connections.model.ConnectionUninstallResult;
 import org.rstudio.studio.client.workbench.views.connections.model.DatabaseObject;
 import org.rstudio.studio.client.workbench.views.connections.model.Field;
 import org.rstudio.studio.client.workbench.views.connections.model.NewConnectionContext;
@@ -5253,7 +5254,7 @@ public void getOdbcConnectionContext(String name,
 
    @Override
    public void uninstallOdbcDriver(String name,
-                                   ServerRequestCallback<Void> callback)
+                                   ServerRequestCallback<ConnectionUninstallResult> callback)
    {
       sendRequest(RPC_SCOPE,
                   UNINSTALL_ODBC_DRIVER,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionsServerOperations.java
Patch:
@@ -66,5 +66,5 @@ void getOdbcConnectionContext(String name,
                                  ServerRequestCallback<NewConnectionInfo> callback);
 
    void uninstallOdbcDriver(String name,
-                            ServerRequestCallback<Void> callback);
+                            ServerRequestCallback<ConnectionUninstallResult> callback);
 }

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -112,7 +112,6 @@ public void initialize(
       logoAnchor_ = new Anchor();
       Style style = logoAnchor_.getElement().getStyle();
       style.setPosition(Position.ABSOLUTE);
-      style.setTop(5, Unit.PX);
       style.setLeft(18, Unit.PX);
       style.setTextDecoration(TextDecoration.NONE);
       style.setOutlineWidth(0, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionPreInstallOdbcHost.java
Patch:
@@ -92,6 +92,7 @@ private Widget createWidget()
 
    public void initializeInfo(NewConnectionInfo info)
    {
+      dirChooser_.setText(info.getOdbcInstallPath());
       license_.setText(info.getOdbcLicense());
       driverLabel_.setText("The " + info.getName() + " driver is currently not installed. ");
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionPreInstallOdbcHost.java
Patch:
@@ -90,7 +90,7 @@ public NewConnectionPreInstallOdbcHost()
 
       mainWidget_ = GWT.<Binder>create(Binder.class).createAndBindUi(this);
 
-      license_.setText("Lorem ipsum");
+      license_.setText(info_.getOdbcLicense());
       driverLabel_.setText("The <driver> driver is currently not installed. ");
  
       initWidget(createWidget());

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/AppNameTextbox.java
Patch:
@@ -109,7 +109,7 @@ public void validateAppName()
          if (validTitle_)
             name_ = app;
          else
-            error_.setText("The title must contain 3 - 64 alphanumeric " + 
+            error_.setText("The title must contain 4 - 64 alphanumeric " + 
                            "characters.");
          return;
       }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -67,7 +67,6 @@
 import org.rstudio.studio.client.common.r.roxygen.RoxygenHelper.SetGenericCall;
 import org.rstudio.studio.client.common.r.roxygen.RoxygenHelper.SetMethodCall;
 import org.rstudio.studio.client.common.r.roxygen.RoxygenHelper.SetRefClassCall;
-import org.rstudio.studio.client.common.rstudioapi.model.AskSecretInfo;
 import org.rstudio.studio.client.common.satellite.Satellite;
 import org.rstudio.studio.client.common.satellite.SatelliteManager;
 import org.rstudio.studio.client.common.shell.ShellInput;

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -84,6 +84,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_GROOVY = new EditorLanguage("ace/mode/groovy", false, true);
    public static final EditorLanguage LANG_HASKELL = new EditorLanguage("ace/mode/haskell", false, true);
    public static final EditorLanguage LANG_HAXE = new EditorLanguage("ace/mode/haxe", false, true);
+   public static final EditorLanguage LANG_INI = new EditorLanguage("ace/mode/ini", false, true);
    public static final EditorLanguage LANG_JAVA = new EditorLanguage("ace/mode/java", false, true);
    public static final EditorLanguage LANG_JULIA = new EditorLanguage("ace/mode/julia", false, true);
    public static final EditorLanguage LANG_LISP = new EditorLanguage("ace/mode/lisp", false, true);

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -84,6 +84,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_GROOVY = new EditorLanguage("ace/mode/groovy", false, true);
    public static final EditorLanguage LANG_HASKELL = new EditorLanguage("ace/mode/haskell", false, true);
    public static final EditorLanguage LANG_HAXE = new EditorLanguage("ace/mode/haxe", false, true);
+   public static final EditorLanguage LANG_INI = new EditorLanguage("ace/mode/ini", false, true);
    public static final EditorLanguage LANG_JAVA = new EditorLanguage("ace/mode/java", false, true);
    public static final EditorLanguage LANG_JULIA = new EditorLanguage("ace/mode/julia", false, true);
    public static final EditorLanguage LANG_LISP = new EditorLanguage("ace/mode/lisp", false, true);

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -1682,11 +1682,12 @@ public void executeRCode(String code,
       sendRequest(RPC_SCOPE, EXECUTE_R_CODE, params, requestCallback);
    }
    
+   @Override
    public void createProject(String projectFile,
                              NewPackageOptions newPackageOptions,
                              NewShinyAppOptions newShinyAppOptions,
                              ProjectTemplateOptions projectTemplateOptions,
-                             ServerRequestCallback<Void> requestCallback)
+                             ServerRequestCallback<String> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(projectFile));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -175,6 +175,7 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
    void setUseSoftTabs(boolean on);
    void setUseWrapMode(boolean on);
    void setTabSize(int tabSize);
+   void autoDetectIndentation(boolean on);
    void setShowPrintMargin(boolean on);
    void setPrintMarginColumn(int column);
    void setShowInvisibles(boolean show);

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -178,7 +178,7 @@ private static final native void maybeDelayLoadApplication(RStudio rstudio)
             // Qt initialization (we don't want to just leave the user with a blank
             // window)
             setTimeout(function() {
-               if ($wnd.rstudioDelayLoadApplication) {
+               if (typeof $wnd.rstudioDelayLoadApplication == "function") {
                   $wnd.rstudioDelayLoadApplication();
                   $wnd.rstudioDelayLoadApplication = null;
                }

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShortcutManager.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -490,7 +490,7 @@ public void execute()
                   // clear the currently hidden console instead
                   event.stopPropagation();
                   commands_.clearTerminalScrollbackBuffer().execute();
-                  return false;
+                  return true;
                }
                else if (binding.getId() == "closeSourceDoc")
                {

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShortcutManager.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -490,7 +490,7 @@ public void execute()
                   // clear the currently hidden console instead
                   event.stopPropagation();
                   commands_.clearTerminalScrollbackBuffer().execute();
-                  return false;
+                  return true;
                }
                else if (binding.getId() == "closeSourceDoc")
                {

File: src/gwt/src/org/rstudio/core/client/dom/DomUtils.java
Patch:
@@ -509,7 +509,7 @@ public static Point getRelativePosition(Element container,
          child = child.getOffsetParent();
       }
 
-      return new Point(left, top);
+      return Point.create(left, top);
    }
 
    public static int ensureVisibleHoriz(Element container,

File: src/gwt/src/org/rstudio/core/client/dom/WindowEx.java
Patch:
@@ -101,7 +101,7 @@ public final native void replaceHistoryState(String url) /*-{
    public final Point getScrollPosition()
    {
       JsArrayInteger pos = getScrollPositionInternal();
-      return new Point(pos.get(0), pos.get(1));
+      return Point.create(pos.get(0), pos.get(1));
    }
 
    public final void setScrollPosition(Point pos)

File: src/gwt/src/org/rstudio/core/client/files/filedialog/DirectoryContentsWidget.java
Patch:
@@ -442,8 +442,9 @@ private int addItem(FileSystemItem item,
 
    public Point getScrollPosition()
    {
-      return new Point(scrollPanel_.getHorizontalScrollPosition(),
-                       scrollPanel_.getVerticalScrollPosition());
+      return Point.create(
+            scrollPanel_.getHorizontalScrollPosition(),
+            scrollPanel_.getVerticalScrollPosition());
    }
 
    public void setScrollPosition(Point p)

File: src/gwt/src/org/rstudio/core/client/widget/DoubleClickState.java
Patch:
@@ -37,7 +37,7 @@ public boolean checkForDoubleClick(NativeEvent event)
 
       if (!isDoubleClick(event, now))
       {
-         lastClickPos_ = new Point(event.getClientX(), event.getClientY());
+         lastClickPos_ = Point.create(event.getClientX(), event.getClientY());
          lastClickTime_ = now;
          return false;
       }

File: src/gwt/src/org/rstudio/core/rebind/JavaScriptPassthroughGenerator.java
Patch:
@@ -138,7 +138,7 @@ private void printParams(SourceWriter w,
                   }
                   else if (simpleName.equals("CommandWithArg"))
                   {
-                     w.print("(Ljava/lang/Object;)(result)");
+                     w.print("(*)(result)");
                   }
                   w.print(";");
                   w.print("}");

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -235,7 +235,7 @@ public void forceReopenSatellite(final String name,
             final WindowEx win = satellite.getWindow();
             Document doc = win.getDocument();
             preferredSize = new Size(doc.getClientWidth(), doc.getClientHeight());
-            preferredPos = new Point(win.getLeft(), win.getTop());
+            preferredPos = Point.create(win.getLeft(), win.getTop());
             callNotifyPendingReactivate(win);
             satellite.close();
             break;

File: src/gwt/src/org/rstudio/studio/client/common/satellite/model/SatelliteWindowGeometry.java
Patch:
@@ -65,7 +65,7 @@ public final boolean equals(SatelliteWindowGeometry other)
    
    public final Point getPosition() 
    {
-      return new Point(getX(), getY());
+      return Point.create(getX(), getY());
    }
    
    public final Size getSize()

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/PDFViewer.java
Patch:
@@ -242,7 +242,7 @@ public void execute()
       {
          width = pdfJsWindow_.getOuterWidth();
          height = pdfJsWindow_.getOuterHeight();
-         pos = new Point(pdfJsWindow_.getLeft(), pdfJsWindow_.getTop());
+         pos = Point.create(pdfJsWindow_.getLeft(), pdfJsWindow_.getTop());
          pdfJsWindow_.close();
          pdfJsWindow_ = null;
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionList.java
Patch:
@@ -59,8 +59,7 @@ public void onMouseMove(MouseMoveEvent event)
                return;
             }
          }
-         lastMouseMoveCoordinates_ = new Point(event.getScreenX(),
-                                               event.getScreenY());
+         lastMouseMoveCoordinates_ = Point.create(event.getScreenX(), event.getScreenY());
 
          if (firstEvent_)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -607,7 +607,7 @@ public void showHelp(String url)
       ensureWidget();
       bringToFront();
       navStack_.navigate(url);
-      setLocation(url, new Point(0, 0));
+      setLocation(url, Point.create(0, 0));
       navigated_ = true;
    }
      
@@ -666,7 +666,7 @@ public void refresh()
    {
       String url = getUrl();
       if (url != null)
-         setLocation(url, new Point(0, 0));
+         setLocation(url, Point.create(0, 0));
    }
 
    private WindowEx getContentWindow()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/model/VirtualHistory.java
Patch:
@@ -30,7 +30,7 @@ public static class Data
       public Data(String url)
       {
          url_ = url;
-         scrollPos_ = new Point(0, 0);
+         scrollPos_ = Point.create(0, 0);
       }
       
       public String getUrl()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/LocatorPanel.java
Patch:
@@ -67,8 +67,9 @@ public void onClick(ClickEvent event)
             int x = event.getNativeEvent().getClientX();
             int y = event.getNativeEvent().getClientY();
 
-            Point p = new Point(
-                  x - el.getAbsoluteLeft(), y - el.getAbsoluteTop());
+            Point p = Point.create(
+                  x - el.getAbsoluteLeft(),
+                  y - el.getAbsoluteTop());
 
             showFeedbackAt(p);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -873,7 +873,7 @@ private void openSourceWindow(String windowId, Point position,
                size = new Size(window.getInnerWidth(), 
                      window.getInnerHeight());
                if (position == null)
-                  position = new Point(
+                  position = Point.create(
                         window.getScreenX() + 50,
                         window.getScreenY() + 50);
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/events/PopoutDocInitiatedEvent.java
Patch:
@@ -54,7 +54,7 @@ public Point getPosition()
    {
       if (posX_ == 0 && posY_ == 0)
          return null;
-      return new Point(posX_, posY_);
+      return Point.create(posX_, posY_);
    }
    
    @Override

File: src/gwt/src/org/rstudio/core/client/dom/DomUtils.java
Patch:
@@ -509,7 +509,7 @@ public static Point getRelativePosition(Element container,
          child = child.getOffsetParent();
       }
 
-      return new Point(left, top);
+      return Point.create(left, top);
    }
 
    public static int ensureVisibleHoriz(Element container,

File: src/gwt/src/org/rstudio/core/client/dom/WindowEx.java
Patch:
@@ -101,7 +101,7 @@ public final native void replaceHistoryState(String url) /*-{
    public final Point getScrollPosition()
    {
       JsArrayInteger pos = getScrollPositionInternal();
-      return new Point(pos.get(0), pos.get(1));
+      return Point.create(pos.get(0), pos.get(1));
    }
 
    public final void setScrollPosition(Point pos)

File: src/gwt/src/org/rstudio/core/client/files/filedialog/DirectoryContentsWidget.java
Patch:
@@ -442,8 +442,9 @@ private int addItem(FileSystemItem item,
 
    public Point getScrollPosition()
    {
-      return new Point(scrollPanel_.getHorizontalScrollPosition(),
-                       scrollPanel_.getVerticalScrollPosition());
+      return Point.create(
+            scrollPanel_.getHorizontalScrollPosition(),
+            scrollPanel_.getVerticalScrollPosition());
    }
 
    public void setScrollPosition(Point p)

File: src/gwt/src/org/rstudio/core/client/widget/DoubleClickState.java
Patch:
@@ -37,7 +37,7 @@ public boolean checkForDoubleClick(NativeEvent event)
 
       if (!isDoubleClick(event, now))
       {
-         lastClickPos_ = new Point(event.getClientX(), event.getClientY());
+         lastClickPos_ = Point.create(event.getClientX(), event.getClientY());
          lastClickTime_ = now;
          return false;
       }

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -235,7 +235,7 @@ public void forceReopenSatellite(final String name,
             final WindowEx win = satellite.getWindow();
             Document doc = win.getDocument();
             preferredSize = new Size(doc.getClientWidth(), doc.getClientHeight());
-            preferredPos = new Point(win.getLeft(), win.getTop());
+            preferredPos = Point.create(win.getLeft(), win.getTop());
             callNotifyPendingReactivate(win);
             satellite.close();
             break;

File: src/gwt/src/org/rstudio/studio/client/common/satellite/model/SatelliteWindowGeometry.java
Patch:
@@ -65,7 +65,7 @@ public final boolean equals(SatelliteWindowGeometry other)
    
    public final Point getPosition() 
    {
-      return new Point(getX(), getY());
+      return Point.create(getX(), getY());
    }
    
    public final Size getSize()

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/PDFViewer.java
Patch:
@@ -242,7 +242,7 @@ public void execute()
       {
          width = pdfJsWindow_.getOuterWidth();
          height = pdfJsWindow_.getOuterHeight();
-         pos = new Point(pdfJsWindow_.getLeft(), pdfJsWindow_.getTop());
+         pos = Point.create(pdfJsWindow_.getLeft(), pdfJsWindow_.getTop());
          pdfJsWindow_.close();
          pdfJsWindow_ = null;
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionList.java
Patch:
@@ -59,8 +59,7 @@ public void onMouseMove(MouseMoveEvent event)
                return;
             }
          }
-         lastMouseMoveCoordinates_ = new Point(event.getScreenX(),
-                                               event.getScreenY());
+         lastMouseMoveCoordinates_ = Point.create(event.getScreenX(), event.getScreenY());
 
          if (firstEvent_)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -607,7 +607,7 @@ public void showHelp(String url)
       ensureWidget();
       bringToFront();
       navStack_.navigate(url);
-      setLocation(url, new Point(0, 0));
+      setLocation(url, Point.create(0, 0));
       navigated_ = true;
    }
      
@@ -666,7 +666,7 @@ public void refresh()
    {
       String url = getUrl();
       if (url != null)
-         setLocation(url, new Point(0, 0));
+         setLocation(url, Point.create(0, 0));
    }
 
    private WindowEx getContentWindow()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/model/VirtualHistory.java
Patch:
@@ -30,7 +30,7 @@ public static class Data
       public Data(String url)
       {
          url_ = url;
-         scrollPos_ = new Point(0, 0);
+         scrollPos_ = Point.create(0, 0);
       }
       
       public String getUrl()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/LocatorPanel.java
Patch:
@@ -67,8 +67,9 @@ public void onClick(ClickEvent event)
             int x = event.getNativeEvent().getClientX();
             int y = event.getNativeEvent().getClientY();
 
-            Point p = new Point(
-                  x - el.getAbsoluteLeft(), y - el.getAbsoluteTop());
+            Point p = Point.create(
+                  x - el.getAbsoluteLeft(),
+                  y - el.getAbsoluteTop());
 
             showFeedbackAt(p);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -873,7 +873,7 @@ private void openSourceWindow(String windowId, Point position,
                size = new Size(window.getInnerWidth(), 
                      window.getInnerHeight());
                if (position == null)
-                  position = new Point(
+                  position = Point.create(
                         window.getScreenX() + 50,
                         window.getScreenY() + 50);
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/events/PopoutDocInitiatedEvent.java
Patch:
@@ -54,7 +54,7 @@ public Point getPosition()
    {
       if (posX_ == 0 && posY_ == 0)
          return null;
-      return new Point(posX_, posY_);
+      return Point.create(posX_, posY_);
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -448,6 +448,7 @@
    public abstract AppCommand updateCredentials();
    public abstract AppCommand diagnosticsReport();
    public abstract AppCommand openDeveloperConsole();
+   public abstract AppCommand reloadUi();
    public abstract AppCommand showLogFiles();
    public abstract AppCommand rstudioSupport();
    public abstract AppCommand rstudioCommunityForum();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalLocalEcho.java
Patch:
@@ -92,7 +92,7 @@ public void write(String output)
          }
 
          String matchedValue = match.getValue();
-         if (Objects.equals(matchedValue, "\b")  && !localEcho_.isEmpty())
+         if (StringUtil.equals(matchedValue, "\b")  && !localEcho_.isEmpty())
          {
             // If the backspace was typed by the user, it will be in the
             // localecho buffer, and already echoed to the screen. If it isn't
@@ -101,7 +101,7 @@ public void write(String output)
             // remove the backspace from the localEcho buffer so matching
             // doesn't break at this point.
             String popped = localEcho_.pop();
-            if (!Objects.equals(popped, "\b"))
+            if (!StringUtil.equals(popped, "\b"))
             {
                // Anything in localEcho at this point represents text written to
                // the local screen that the server doesn't know was written, so a

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -813,7 +813,7 @@ public void onTerminalTitle(TerminalTitleEvent event)
       // Notification from a TerminalSession that it changed its title
       TerminalSession visibleTerm = getSelectedTerminal();
       TerminalSession retitledTerm = event.getTerminalSession();
-      if (visibleTerm != null && Objects.equals(visibleTerm.getHandle(), retitledTerm.getHandle()))
+      if (visibleTerm != null && StringUtil.equals(visibleTerm.getHandle(), retitledTerm.getHandle()))
       {
          // update the toolbar label if currently displayed terminal has changed
          // its title
@@ -876,7 +876,7 @@ private TerminalSession loadedTerminalWithHandle(String handle)
       for (int i = 0; i < total; i++)
       {
          TerminalSession t = getLoadedTerminalAtIndex(i);
-         if (t != null && Objects.equals(t.getHandle(), handle))
+         if (t != null && StringUtil.equals(t.getHandle(), handle))
          {
             return t;
          }
@@ -895,7 +895,7 @@ private TerminalSession loadedTerminalWithCaption(String caption)
       for (int i = 0; i < total; i++)
       {
          TerminalSession t = getLoadedTerminalAtIndex(i);
-         if (t != null && Objects.equals(t.getCaption(), caption))
+         if (t != null && StringUtil.equals(t.getCaption(), caption))
          {
             return t;
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -264,7 +264,7 @@ private String getPreviousTerminalHandle()
          String prevHandle = null;
          for (final String handle : terminals_)
          {
-            if (Objects.equals(activeTerminalHandle_, handle))
+            if (StringUtil.equals(activeTerminalHandle_, handle))
             {
                if (prevHandle == null)
                {
@@ -295,7 +295,7 @@ private String getNextTerminalHandle()
             {
                return handle;
             }
-            if (Objects.equals(activeTerminalHandle_, handle))
+            if (StringUtil.equals(activeTerminalHandle_, handle))
             {
                foundCurrent = true;
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalLocalEcho.java
Patch:
@@ -92,7 +92,7 @@ public void write(String output)
          }
 
          String matchedValue = match.getValue();
-         if (Objects.equals(matchedValue, "\b")  && !localEcho_.isEmpty())
+         if (StringUtil.equals(matchedValue, "\b")  && !localEcho_.isEmpty())
          {
             // If the backspace was typed by the user, it will be in the
             // localecho buffer, and already echoed to the screen. If it isn't
@@ -101,7 +101,7 @@ public void write(String output)
             // remove the backspace from the localEcho buffer so matching
             // doesn't break at this point.
             String popped = localEcho_.pop();
-            if (!Objects.equals(popped, "\b"))
+            if (!StringUtil.equals(popped, "\b"))
             {
                // Anything in localEcho at this point represents text written to
                // the local screen that the server doesn't know was written, so a

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -813,7 +813,7 @@ public void onTerminalTitle(TerminalTitleEvent event)
       // Notification from a TerminalSession that it changed its title
       TerminalSession visibleTerm = getSelectedTerminal();
       TerminalSession retitledTerm = event.getTerminalSession();
-      if (visibleTerm != null && Objects.equals(visibleTerm.getHandle(), retitledTerm.getHandle()))
+      if (visibleTerm != null && StringUtil.equals(visibleTerm.getHandle(), retitledTerm.getHandle()))
       {
          // update the toolbar label if currently displayed terminal has changed
          // its title
@@ -876,7 +876,7 @@ private TerminalSession loadedTerminalWithHandle(String handle)
       for (int i = 0; i < total; i++)
       {
          TerminalSession t = getLoadedTerminalAtIndex(i);
-         if (t != null && Objects.equals(t.getHandle(), handle))
+         if (t != null && StringUtil.equals(t.getHandle(), handle))
          {
             return t;
          }
@@ -895,7 +895,7 @@ private TerminalSession loadedTerminalWithCaption(String caption)
       for (int i = 0; i < total; i++)
       {
          TerminalSession t = getLoadedTerminalAtIndex(i);
-         if (t != null && Objects.equals(t.getCaption(), caption))
+         if (t != null && StringUtil.equals(t.getCaption(), caption))
          {
             return t;
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -264,7 +264,7 @@ private String getPreviousTerminalHandle()
          String prevHandle = null;
          for (final String handle : terminals_)
          {
-            if (Objects.equals(activeTerminalHandle_, handle))
+            if (StringUtil.equals(activeTerminalHandle_, handle))
             {
                if (prevHandle == null)
                {
@@ -295,7 +295,7 @@ private String getNextTerminalHandle()
             {
                return handle;
             }
-            if (Objects.equals(activeTerminalHandle_, handle))
+            if (StringUtil.equals(activeTerminalHandle_, handle))
             {
                foundCurrent = true;
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/r/SignatureToolTipManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SignatureToolTipManager.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -140,7 +140,8 @@ public void execute()
                      if (position != null && anchor_.getRange().contains(position))
                      {
                         // Update the tooltip position if the cursor changes rows.
-                        if (position.getRow() > tooltipPosition_.getRow())
+                        if (tooltipPosition_ != null &&
+                              position.getRow() > tooltipPosition_.getRow())
                         {
                            // Allow tooltip to nudge right (but not left)
                            int newColumn = Math.max(

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -23,6 +23,8 @@
 /**
  * This is an interface straight through to a C++ object that lives
  * in the Qt desktop frame.
+ * 
+ * String arguments must not be null.
  */
 @BaseExpression("$wnd.desktop")
 public interface DesktopFrame extends JavaScriptPassthrough

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SatelliteManager.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -175,7 +175,7 @@ public void openSatellite(String name,
                   if (activate) 
                   {
                      Desktop.getFrame().activateSatelliteWindow(
-                       SatelliteUtils.getSatelliteWindowName(satellite.getName()));
+                       StringUtil.notNull(SatelliteUtils.getSatelliteWindowName(satellite.getName())));
                   }
                   callNotifyReactivated(window, params);
                   return;
@@ -273,7 +273,7 @@ public void activateSatelliteWindow(String name)
       if (Desktop.isDesktop())
       {
          Desktop.getFrame().activateSatelliteWindow(
-               SatelliteUtils.getSatelliteWindowName(name));
+               SatelliteUtils.getSatelliteWindowName(StringUtil.notNull(name)));
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * HTMLPreviewPanel.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -298,7 +298,7 @@ public void focusFind()
    private void navigate(String url)
    {
       if (Desktop.isDesktop())
-         Desktop.getFrame().setViewerUrl(url);
+         Desktop.getFrame().setViewerUrl(StringUtil.notNull(url));
       // use setUrl rather than navigate to deal with same origin policy
       previewFrame_.setUrl(url);
    }

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyGadgetDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ShinyGadgetDialog.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -16,6 +16,7 @@
 package org.rstudio.studio.client.shiny.ui;
 
 import org.rstudio.core.client.Size;
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomMetrics;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
@@ -92,7 +93,7 @@ protected Widget createMainWidget()
       frame_.setSize(size.width + "px", size.height + "px");
       
       if (Desktop.isDesktop())
-         Desktop.getFrame().setShinyDialogUrl(url_);
+         Desktop.getFrame().setShinyDialogUrl(StringUtil.notNull(url_));
       
       frame_.setUrl(url_);
       return frame_;

File: src/gwt/src/org/rstudio/studio/client/workbench/WorkbenchNewSession.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * WorkbenchNewSession.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.workbench;
 
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.model.ApplicationServerOperations;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -37,7 +38,7 @@ public void openNewSession(GlobalDisplay globalDisplay,
       else
       {
          Desktop.getFrame().openSessionInNewWindow(
-               workbenchContext.getCurrentWorkingDir().getPath());
+               StringUtil.notNull(workbenchContext.getCurrentWorkingDir().getPath()));
       }
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AppearancePreferencesPane.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -291,7 +291,7 @@ public boolean onApply(RPrefs rPrefs)
       {
          if (initialFontFace_ != fontFace_.getValue())
          {
-            Desktop.getFrame().setFixedWidthFont(fontFace_.getValue());
+            Desktop.getFrame().setFixedWidthFont(StringUtil.notNull(fontFace_.getValue()));
             restartRequired = true;
          }
          

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionShinyHost.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * NewConnectionShinyHost.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -181,7 +181,7 @@ public void onShinyFrameNavigated(ShinyFrameNavigatedEvent event)
       String url = event.getURL();
       
       if (Desktop.isDesktop())
-         Desktop.getFrame().setShinyDialogUrl(url);
+         Desktop.getFrame().setShinyDialogUrl(StringUtil.notNull(url));
 
       frame_.setUrl(StringUtil.makeAbsoluteUrl(url));
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/Presentation.java
Patch:
@@ -2,7 +2,7 @@
  * Presentation.java
 
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -243,7 +243,7 @@ void onPresentationViewInBrowser()
                @Override
                public void onResponseReceived(String path)
                {
-                  Desktop.getFrame().showFile(path);
+                  Desktop.getFrame().showFile(StringUtil.notNull(path));
                }
             });
       }

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DesktopApplicationHeader.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -327,7 +327,7 @@ private void respondToUpdateCheck(final UpdateCheckResult result,
             @Override
             public void execute()
             {
-               appQuit_.prepareForQuit("Update RStudio", true /*allowCancel*/, new QuitContext()
+               appQuit_.prepareForQuit("Update RStudio", new QuitContext()
                {
                   @Override
                   public void onReadyToQuit(boolean saveChanges)

File: src/gwt/src/org/rstudio/studio/client/server/VoidServerRequestCallback.java
Patch:
@@ -43,7 +43,10 @@ public void onError(ServerError error)
       Debug.logError(error);
 
       if (progress_ != null)
+      {
          progress_.onError(error.getUserMessage());
+         progress_.onCompleted();
+      }
       
       onFailure();
       onCompleted();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -515,12 +515,12 @@ public void execute(String input,
             final FileSystemItem target =
                file.isDirectory() ?
                   FileSystemItem.createDir(path) :
-                  FileSystemItem.createFile(path);
+                  FileSystemItem.create(path, false, file.getLength(), file.getLastModifiedNative());
               
             // clear selection
             view_.selectNone();
             
-            // premptively rename in the UI then fallback to refreshing
+            // pre-emptively rename in the UI then fallback to refreshing
             // the view if there is an error
             view_.renameFile(file, target);
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1090,7 +1090,7 @@ public void onShowProfiler(OpenProfileEvent event)
       for (int idx = 0; idx < editors_.size(); idx++)
       {
          String path = editors_.get(idx).getPath();
-         if (path != null && profilePath.equals(path))
+         if (path != null && path == profilePath)
          {
             ensureVisible(false);
             view_.selectTab(idx);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSessionSocket.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalSessionSocket.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -108,7 +108,7 @@ long duration()
       
       public InputEchoTimeMonitor()
       {
-         pending_ = new LinkedList<InputDatapoint>();
+         pending_ = new LinkedList<>();
       }
       
       public void inputReceived(String input)
@@ -281,7 +281,6 @@ public void onError(ServerError error)
                      callback.onError("Unable to switch back to RPC mode");
                   }
                });
-               return;
             }
          });
          

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/ActivateNamedTerminalEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ActivateNamedTerminalEvent.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -69,5 +69,5 @@ protected void dispatch(Handler activateTerminalHandler)
 
    private String id_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/AddTerminalEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AddTerminalEvent.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -72,5 +72,5 @@ protected void dispatch(Handler handler)
    private final ConsoleProcessInfo processInfo_;
    private final boolean show_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/ClearTerminalEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ClearTerminalEvent.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -69,5 +69,5 @@ protected void dispatch(Handler clearTerminalHandler)
 
    private String id_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/CreateTerminalEvent.java
Patch:
@@ -1,8 +1,7 @@
-
 /*
  * CreateTerminalEvent.java
  *
- * Copyright (C) 2009-14 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -67,5 +66,5 @@ public String getPostCreateText()
    
    private final String postCreateText_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/RemoveTerminalEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RemoveTerminalEvent.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -63,5 +63,5 @@ protected void dispatch(Handler handler)
 
    private final String handle_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/ResizeTerminalEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ResizeTerminalEvent.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -82,5 +82,5 @@ public int getCols()
    private final int rows_;
    private final int cols_;
    
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/SendToTerminalEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SendToTerminalEvent.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -81,5 +81,5 @@ protected void dispatch(Handler sendToTerminalHandler)
    private String text_;
    private boolean setFocus_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/SwitchToTerminalEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SwitchToTerminalEvent.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -86,5 +86,5 @@ public boolean createdByApi()
    private String inputText_;
    private boolean createdByApi_;
    
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalBusyEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalBusyEvent.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -52,5 +52,5 @@ public Type<Handler> getAssociatedType()
 
    private final boolean busy_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalCwdEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalCwdEvent.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -78,5 +78,5 @@ public Type<Handler> getAssociatedType()
 
    private final Data data_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalDataInputEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalDataEvent.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -61,5 +61,5 @@ public String getData()
   
    private final String data_;
    
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalSessionStartedEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalSessionStartedEvent.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -62,5 +62,5 @@ public TerminalSession getTerminalWidget()
   
    private TerminalSession terminalWidget_;
    
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalSessionStoppedEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalSessionStoppedEvent.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -67,5 +67,5 @@ public TerminalSession getTerminalWidget()
   
    private TerminalSession terminalWidget_;
    
-   public static final Type<Handler> TYPE = new Type<Handler>(); 
+   public static final Type<Handler> TYPE = new Type<>();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalSubprocEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalSubprocEvent.java
  *
- * Copyright (C) 2009-17 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -92,5 +92,5 @@ public Type<Handler> getAssociatedType()
 
    private final Data data_;
 
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalTitleEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalTitleEvent.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -60,5 +60,5 @@ public TerminalSession getTerminalSession()
   
    private TerminalSession terminalSession_;
    
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/XTermTitleEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * XTermTitleEvent.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-18 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -70,5 +70,5 @@ public String getTitle()
   
    private final String title_;
    
-   public static final Type<Handler> TYPE = new Type<Handler>();
+   public static final Type<Handler> TYPE = new Type<>();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/r/SignatureToolTipManager.java
Patch:
@@ -449,7 +449,7 @@ public void resolveActiveFunctionAndDisplayToolTip()
       if (!cursor.hasType("identifier"))
          return;
 
-      if (cursor.nextValue() == "(")
+      if (!cursor.nextValue().equals("("))
          return;
       
       String callString = cursor.currentValue();

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -48,8 +48,8 @@ void getExistingDirectory(String caption,
                              String dir,
                              CommandWithArg<String> callback);
    
-   void undo(boolean forAce);
-   void redo(boolean forAce);
+   void undo();
+   void redo();
    
    void clipboardCut();
    void clipboardCopy();

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -208,13 +208,13 @@ private void fireEditEvent(final int type)
    @Handler
    void onUndoDummy()
    {
-      Desktop.getFrame().undo(isFocusInAceInstance());
+      Desktop.getFrame().undo();
    }
 
    @Handler
    void onRedoDummy()
    {
-      Desktop.getFrame().redo(isFocusInAceInstance());
+      Desktop.getFrame().redo();
    }
 
    @Handler

File: src/gwt/src/org/rstudio/core/client/BrowseCap.java
Patch:
@@ -238,8 +238,9 @@ private static final boolean getFixedUbuntuMono()
 
       if (isWindowsDesktop())
       {
-         Desktop.getFrame().getDisplayDpi(dpi ->
+         Desktop.getFrame().getDisplayDpi(dpiString ->
          {
+            Integer dpi = StringUtil.parseInt(dpiString, 96);
             if (dpi >= 192)
             {
                Document.get().getBody().addClassName("windows-highdpi");

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -120,7 +120,7 @@ void promptForText(String title,
    void bringMainFrameToFront();
    void bringMainFrameBehindActive();
    
-   void getDisplayDpi(CommandWithArg<Integer> callback);
+   void getDisplayDpi(CommandWithArg<String> callback);
 
    void cleanClipboard();
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/ConsoleProgressDialog.java
Patch:
@@ -76,6 +76,9 @@ public ConsoleProgressDialog(String title,
          throw new IllegalArgumentException(
                "Invalid combination of arguments to ConsoleProgressDialog");
       }
+
+      // save console process so that we can compute interaction mode below
+      consoleProcess_ = consoleProcess;
       
       if (getInteractionMode() != ConsoleProcessInfo.INTERACTION_NEVER)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -410,6 +410,7 @@ public void onValueChange(ValueChangeEvent<Boolean> event)
          publishButton_ = new RSConnectPublishButton(
                RSConnectPublishButton.HOST_EDITOR,
                RSConnect.CONTENT_TYPE_APP, false, null);
+         publishButton_.onPublishInvoked(() -> target_.save());
          toolbar.addRightWidget(publishButton_);
       }
       

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -384,7 +384,7 @@ public void execute(Boolean succeeded)
    private ArrayList<Dependency> dataImportCsvDependencies()
    {
       ArrayList<Dependency> deps = new ArrayList<Dependency>();
-      deps.add(Dependency.cranPackage("readr", "0.2.2"));
+      deps.add(Dependency.cranPackage("readr", "1.1.0"));
       deps.add(Dependency.cranPackage("Rcpp", "0.11.5"));
       return deps;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -417,7 +417,6 @@ public boolean verifyPrerequisites(String feature,
          else if (fileType.requiresKnit() && 
                   !session_.getSessionInfo().getRMarkdownPackageAvailable())
          {
-   
             showKnitrPreviewWarning(display, feature, "1.2");
             return false;
          }

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -103,7 +103,7 @@ void showMessageBox(int type,
                        String buttons,
                        int defaultButton,
                        int cancelButton,
-                       CommandWithArg<Integer> callback);
+                       CommandWithArg<String> callback);
 
    void promptForText(String title,
                       String label,

File: src/gwt/src/org/rstudio/core/client/widget/GridViewerFrame.java
Patch:
@@ -24,7 +24,7 @@ public class GridViewerFrame extends RStudioFrame
 {
    public GridViewerFrame()
    {
-      super("grid_resource/gridviewer.html?data_source=data");
+      super("grid_resource/dtviewer.html?data_source=data");
    }
    
    public void onAttach()

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxLoader.java
Patch:
@@ -34,7 +34,6 @@ public interface Callback
    
    public MathJaxLoader()
    {
-      ensureMathJaxLoaded();
    }
    
    public static boolean isMathJaxLoaded()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermNative.java
Patch:
@@ -120,7 +120,7 @@ public final native int cursorY() /*-{
  
    // XTERM_IMP
    public final native boolean altBufferActive() /*-{
-      return this.normal != null;
+      return this.buffers.active == this.buffers.alt;
    }-*/;
    
    public final native void showPrimaryBuffer() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermNative.java
Patch:
@@ -120,7 +120,7 @@ public final native int cursorY() /*-{
  
    // XTERM_IMP
    public final native boolean altBufferActive() /*-{
-      return this.normal != null;
+      return this.buffers.active == this.buffers.alt;
    }-*/;
    
    public final native void showPrimaryBuffer() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -397,7 +397,7 @@ public void execute(FileSystemItem targetFile,
             
             server_.copyFile(selectedFiles.get(0),
                  targetFile,
-                 false,
+                 true,
                  new VoidServerRequestCallback(progress) {
                      @Override
                      protected void onSuccess()

File: src/gwt/src/org/rstudio/core/client/command/impl/DesktopMenuCallback.java
Patch:
@@ -29,6 +29,8 @@ public native final void beginMenu(String label) /*-{
       $wnd.desktopMenuCallback.beginMenu(label);
    }-*/;
 
+   // TODO: Rather than adding commands one-at-a-time, we should
+   // see if we could instead add all of the commands in one message.
    public void addCommand(String commandId, AppCommand command)
    {
       addCommand(commandId,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildCommands.java
Patch:
@@ -32,7 +32,7 @@ public static void setBuildCommandState(Commands commands,
       
       // adapt or remove package commands if this isn't a package
       String type = sessionInfo.getBuildToolsType();
-      if (type == SessionInfo.BUILD_TOOLS_PACKAGE)
+      if (type != SessionInfo.BUILD_TOOLS_PACKAGE)
       {
          commands.devtoolsLoadAll().remove();
          commands.buildSourcePackage().remove();

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -358,7 +358,7 @@
    public abstract AppCommand activatePackages();
    public abstract AppCommand layoutZoomPackages();
    
-   // // packrat
+   // packrat
    public abstract AppCommand packratBootstrap();
    public abstract AppCommand packratOptions();
    public abstract AppCommand packratBundle();
@@ -381,6 +381,7 @@
    public abstract AppCommand openProfile();
    public abstract AppCommand profileHelp();
    public abstract AppCommand gotoProfileSource();
+   public abstract AppCommand openProfileInBrowser();
    
    // Tools
    public abstract AppCommand showShellDialog();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -151,6 +151,8 @@ private Toolbar createToolbar(Commands commands, PublishHtmlSource publishHtmlSo
       
       toolbar.addLeftWidget(commands.gotoProfileSource().createToolbarButton());
       toolbar.addLeftWidget(commands.saveProfileAs().createToolbarButton());
+      toolbar.addLeftSeparator();
+      toolbar.addLeftWidget(commands.openProfileInBrowser().createToolbarButton());
       
       toolbar.addRightWidget(
             publishButton_ = new RSConnectPublishButton(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -243,7 +243,7 @@ private void renderNotebookv2WithDialog(final DocUpdateSentinel sourceDoc)
          @Override
          public void execute(CompileNotebookv2Options input)
          { 
-            renderNotebookv2(sourceDoc, null, input.getFormat());
+            renderNotebookv2(sourceDoc, input.getFormat(), null);
             
             // save options for this document
             HashMap<String, String> changedProperties 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/PlotPublishMRUList.java
Patch:
@@ -18,6 +18,7 @@
 
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppCommand;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.rsconnect.ui.RSConnectResources;
@@ -96,7 +97,7 @@ public void addPlotMruEntries(ToolbarPopupMenu menu,
          displayName += " (" + mruEntry.server + ")";
          
          menu.addItem(new MenuItem(AppCommand.formatMenuLabel(
-               RSConnectResources.INSTANCE.republishPlot2x(), 
+               new ImageResource2x(RSConnectResources.INSTANCE.republishPlot2x()), 
                displayName, null), true, 
                new Command() 
          {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/PlotPublishMRUList.java
Patch:
@@ -18,6 +18,7 @@
 
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.AppCommand;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.rsconnect.ui.RSConnectResources;
@@ -96,7 +97,7 @@ public void addPlotMruEntries(ToolbarPopupMenu menu,
          displayName += " (" + mruEntry.server + ")";
          
          menu.addItem(new MenuItem(AppCommand.formatMenuLabel(
-               RSConnectResources.INSTANCE.republishPlot2x(), 
+               new ImageResource2x(RSConnectResources.INSTANCE.republishPlot2x()), 
                displayName, null), true, 
                new Command() 
          {

File: src/gwt/src/org/rstudio/core/client/SafeHtmlUtil.java
Patch:
@@ -142,7 +142,7 @@ public static void highlightSearchMatch(SafeHtmlBuilder sb, String haystack,
       if (StringUtil.isNullOrEmpty(haystack))
          return;
       
-      // if we hqve a needle to search for, and it exists, highlight it
+      // if we have a needle to search for, and it exists, highlight it
       boolean hasMatch = false;
       if (!StringUtil.isNullOrEmpty(needle))
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchTabPanel.java
Patch:
@@ -68,6 +68,7 @@ public WorkbenchTabPanel(WindowFrame owner, LogicalWindow parentWindow)
       panel_.setWidgetRightWidth(utilPanel_,
                                  0, Unit.PX,
                                  UTILITY_AREA_SIZE, Unit.PX);
+      panel_.setWidgetTopHeight(utilPanel_, 0, Unit.PX, 22, Unit.PX);
 
       initWidget(panel_);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchTabPanel.java
Patch:
@@ -68,6 +68,7 @@ public WorkbenchTabPanel(WindowFrame owner, LogicalWindow parentWindow)
       panel_.setWidgetRightWidth(utilPanel_,
                                  0, Unit.PX,
                                  UTILITY_AREA_SIZE, Unit.PX);
+      panel_.setWidgetTopHeight(utilPanel_, 0, Unit.PX, 22, Unit.PX);
 
       initWidget(panel_);
    }

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -145,6 +145,7 @@ public interface ThemeStyles extends CssResource
    String locatorPanel();
 
    String multiPodUtilityArea();
+   String multiPodUtilityTabArea();
 
    String tabOverflowPopup();   
    

File: src/gwt/src/org/rstudio/studio/client/common/r/RTokenizer.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.common.r;
 
+import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.regex.Match;
 import org.rstudio.core.client.regex.Pattern;
 
@@ -86,7 +87,7 @@ public RToken nextToken()
          assert false : "matchNumber() returned a zero-length token" ;
       }
       
-      if (Character.isLetter(c) || c == '.')
+      if (StringUtil.isLetter(c) || c == '.')
       {
          // From Section 10.3.2, identifiers must not start with
          // a period followed by a digit.

File: src/gwt/src/org/rstudio/core/client/StringUtil.java
Patch:
@@ -992,7 +992,7 @@ public static boolean isWhitespace(String string)
    
    public static boolean isComplementOf(String self, String other)
    {
-      return COMPLEMENTS.get(self).equals(other);
+      return COMPLEMENTS.get(self) == other;
    }
    
    private static final HashMap<String, String> makeComplementsMap()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -31,7 +31,6 @@
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.ThemeFonts;
-import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.InfoBar;
 import org.rstudio.core.client.widget.SelectWidget;
 import org.rstudio.studio.client.application.Desktop;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -31,7 +31,6 @@
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
-import org.rstudio.core.client.widget.ToolbarPopupMenuButton;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -17,7 +17,6 @@
 import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.dom.IFrameElementEx;
-import org.rstudio.core.client.widget.RStudioFrame;
 import org.rstudio.core.client.widget.RStudioThemedFrame;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.studio.client.workbench.commands.Commands;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/events/ConsoleWriteErrorEvent.java
Patch:
@@ -30,12 +30,12 @@ public ConsoleWriteErrorEvent(ConsoleText error)
    
    public String getError()
    {
-      return error_.getText();
+      return error_.text;
    }
    
    public String getConsole()
    {
-      return error_.getConsole();
+      return error_.console;
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/events/ConsoleWriteInputEvent.java
Patch:
@@ -29,12 +29,12 @@ public ConsoleWriteInputEvent(ConsoleText text)
 
    public String getInput()
    {
-      return text_.getText();
+      return text_.text;
    }
    
    public String getConsole()
    {
-      return text_.getConsole();
+      return text_.console;
    }
 
    private final ConsoleText text_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/events/ConsoleWriteOutputEvent.java
Patch:
@@ -30,12 +30,12 @@ public ConsoleWriteOutputEvent(ConsoleText output)
    
    public String getOutput()
    {
-      return output_.getText();
+      return output_.text;
    }
 
    public String getConsole()
    {
-      return output_.getConsole();
+      return output_.console;
    }
    
    @Override

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarPopupMenuButton.java
Patch:
@@ -103,7 +103,7 @@ public void setText(String text)
    
    public void setText(String text, boolean fireEvent)
    {
-      boolean changed = !text_.equals(text);
+      boolean changed = text_ == null || !text_.equals(text);
       
       text_ = text;
       if (showText_)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/DocumentOutlineWidget.java
Patch:
@@ -461,7 +461,7 @@ private Scope getCurrentVisibleScope(Scope node)
    
    private boolean isActiveNode(Scope node)
    {
-      return node != null && node.equals(currentVisibleScope_);
+      return node != null && currentVisibleScope_ != null && node.equals(currentVisibleScope_);
    }
    
    private final DockLayoutPanel container_;

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -134,7 +134,8 @@ String promptForText(String title,
    
    void openTerminal(String terminalPath,
                      String workingDirectory,
-                     String extraPathEntries);
+                     String extraPathEntries,
+                     int shellType);
 
    String getFixedWidthFontList();
    String getFixedWidthFont();

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -399,7 +399,8 @@ public void onResponseReceived(TerminalOptions options)
             {
                Desktop.getFrame().openTerminal(options.getTerminalPath(),
                      options.getWorkingDirectory(),
-                     options.getExtraPathEntries());
+                     options.getExtraPathEntries(),
+                     options.getShellType());
             }
          });
       }

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -134,7 +134,8 @@ String promptForText(String title,
    
    void openTerminal(String terminalPath,
                      String workingDirectory,
-                     String extraPathEntries);
+                     String extraPathEntries,
+                     int shellType);
 
    String getFixedWidthFontList();
    String getFixedWidthFont();

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -399,7 +399,8 @@ public void onResponseReceived(TerminalOptions options)
             {
                Desktop.getFrame().openTerminal(options.getTerminalPath(),
                      options.getWorkingDirectory(),
-                     options.getExtraPathEntries());
+                     options.getExtraPathEntries(),
+                     options.getShellType());
             }
          });
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -333,7 +333,7 @@ public void onSuccess(Boolean connected)
                Debug.log("No selected terminal after creation"); 
                return; 
             } 
-            terminal.receivedInput(postCreateText);
+            terminal.receivedSendToTerminal(postCreateText);
          }
          
          @Override
@@ -849,7 +849,7 @@ public void onSuccess(Boolean connected)
                Debug.log("Terminal not found after switching"); 
                return; 
             } 
-            terminal.receivedInput(event.getInputText()); 
+            terminal.receivedSendToTerminal(event.getInputText()); 
          } 
          @Override 
          public void onFailure(String msg) 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -333,7 +333,7 @@ public void onSuccess(Boolean connected)
                Debug.log("No selected terminal after creation"); 
                return; 
             } 
-            terminal.receivedInput(postCreateText);
+            terminal.receivedSendToTerminal(postCreateText);
          }
          
          @Override
@@ -849,7 +849,7 @@ public void onSuccess(Boolean connected)
                Debug.log("Terminal not found after switching"); 
                return; 
             } 
-            terminal.receivedInput(event.getInputText()); 
+            terminal.receivedSendToTerminal(event.getInputText()); 
          } 
          @Override 
          public void onFailure(String msg) 

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -299,7 +299,8 @@ private void navigate(String url)
    {
       if (Desktop.isDesktop())
          Desktop.getFrame().setViewerUrl(url);
-      previewFrame_.navigate(url);
+      // use setUrl rather than navigate to deal with same origin policy
+      previewFrame_.setUrl(url);
    }
    
    private final LayoutPanel layoutPanel_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -174,12 +174,12 @@ public void onError(ServerError error)
       });
    }
    
-   public void setActiveTerminalByCaption(String caption)
+   public void setActiveTerminalByCaption(String caption, boolean createdByApi)
    {
       String handle = terminals_.handleForCaption(caption);
       if (StringUtil.isNullOrEmpty(handle))
          return;
-      eventBus_.fireEvent(new SwitchToTerminalEvent(handle, null));
+      eventBus_.fireEvent(new SwitchToTerminalEvent(handle, null, createdByApi));
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -174,12 +174,12 @@ public void onError(ServerError error)
       });
    }
    
-   public void setActiveTerminalByCaption(String caption)
+   public void setActiveTerminalByCaption(String caption, boolean createdByApi)
    {
       String handle = terminals_.handleForCaption(caption);
       if (StringUtil.isNullOrEmpty(handle))
          return;
-      eventBus_.fireEvent(new SwitchToTerminalEvent(handle, null));
+      eventBus_.fireEvent(new SwitchToTerminalEvent(handle, null, createdByApi));
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermNative.java
Patch:
@@ -211,8 +211,8 @@ public static native XTermNative createTerminal(Element container,
          // https://developer.mozilla.org/en-US/docs/Web/Events/wheel#Listening_to_this_event_across_browser
          self = nativeTerm_;
          nativeTerm_.element.addEventListener('mousewheel', function (ev) {
-         if (self.mouseEvents)
-            return;
+            if (self.mouseEvents)
+               return;
 
             // create a normalized 'wheel' event object
             var event = {

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -322,7 +322,7 @@ private ArrayList<Dependency> shinyDependencies()
       deps.add(Dependency.cranPackage("R6", "2.0"));
       deps.add(Dependency.cranPackage("sourcetools", "0.1.5"));
       deps.add(Dependency.cranPackage("htmltools", "0.3.5"));
-      deps.add(Dependency.cranPackage("shiny", "0.13", true));
+      deps.add(Dependency.cranPackage("shiny", "1.0", true));
       return deps;
          }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/TerminalPreferencesPane.java
Patch:
@@ -165,8 +165,7 @@ public void onChange(ChangeEvent event)
       HelpLink helpLink = new HelpLink("Using the RStudio terminal", "rstudio_terminal", false);
       nudgeRight(helpLink); 
       helpLink.addStyleName(res_.styles().newSection()); 
-      // TODO (gary) -- uncomment once we've published the support article
-      //add(helpLink);
+      add(helpLink);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/TerminalPreferencesPane.java
Patch:
@@ -165,8 +165,7 @@ public void onChange(ChangeEvent event)
       HelpLink helpLink = new HelpLink("Using the RStudio terminal", "rstudio_terminal", false);
       nudgeRight(helpLink); 
       helpLink.addStyleName(res_.styles().newSection()); 
-      // TODO (gary) -- uncomment once we've published the support article
-      //add(helpLink);
+      add(helpLink);
    }
 
    @Override

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -203,4 +203,6 @@ public interface ThemeStyles extends CssResource
    String tabIcon();
    
    String menuCheckable();
+   
+   String noLogo();
 }

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -152,14 +152,14 @@ public void withRSConnect(String userAction,
       if (requiresRmarkdown)
          deps.addAll(rmarkdownDependencies());
       deps.add(Dependency.cranPackage("packrat", "0.4.8-1", true));
-      deps.add(Dependency.embeddedPackage("rsconnect"));
+      deps.add(Dependency.cranPackage("rsconnect", "0.8.5"));
       
       withDependencies(
         "Publishing",
         userAction,
         userPrompt,
         deps.toArray(new Dependency[deps.size()]),
-        true, // we want the embedded rsconnect package to be updated if needed
+        true, // silently update any embedded packages needed (none at present)
         onCompleted
       );
    }

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -152,14 +152,14 @@ public void withRSConnect(String userAction,
       if (requiresRmarkdown)
          deps.addAll(rmarkdownDependencies());
       deps.add(Dependency.cranPackage("packrat", "0.4.8-1", true));
-      deps.add(Dependency.embeddedPackage("rsconnect"));
+      deps.add(Dependency.cranPackage("rsconnect", "0.8.5"));
       
       withDependencies(
         "Publishing",
         userAction,
         userPrompt,
         deps.toArray(new Dependency[deps.size()]),
-        true, // we want the embedded rsconnect package to be updated if needed
+        true, // silently update any embedded packages needed (none at present)
         onCompleted
       );
    }

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -1022,6 +1022,7 @@ private void removeProjectCommands()
       commands_.closeProject().remove();
       commands_.openProjectInNewWindow().remove();
       commands_.clearRecentProjects().remove();
+      commands_.quitSession().remove();
       commands_.projectMru0().remove();
       commands_.projectMru1().remove();
       commands_.projectMru2().remove();

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -203,4 +203,6 @@ public interface ThemeStyles extends CssResource
    String tabIcon();
    
    String menuCheckable();
+   
+   String noLogo();
 }

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -252,7 +252,6 @@ public void showToolbar(boolean showToolbar)
          outerPanel_.add(logoAnchor_);
          MenubarPanel menubarPanel = new MenubarPanel(headerBarPanel_);
          outerPanel_.add(menubarPanel);
-         mainMenu_.getElement().getStyle().setMarginLeft(0, Unit.PX);
          preferredHeight_ = 45;
          showProjectMenu(true);
       }

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/WebApplicationHeader.java
Patch:
@@ -252,7 +252,6 @@ public void showToolbar(boolean showToolbar)
          outerPanel_.add(logoAnchor_);
          MenubarPanel menubarPanel = new MenubarPanel(headerBarPanel_);
          outerPanel_.add(menubarPanel);
-         mainMenu_.getElement().getStyle().setMarginLeft(0, Unit.PX);
          preferredHeight_ = 45;
          showProjectMenu(true);
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/view/ObjectExplorerDataGrid.java
Patch:
@@ -1347,6 +1347,8 @@ private void restoreScrollPosition()
    private static final int DEFAULT_NAME_COLUMN_WIDTH = 180;
    private static final int DEFAULT_TYPE_COLUMN_WIDTH = 180;
    
+   // NOTE: this should be synchronized with '.rs.explorer.defaultRowLimit' in
+   // SessionObjectExplorer.R
    private static final int DEFAULT_ROW_LIMIT = 1000;
    
    private static final String ACTION_OPEN    = "open";

File: src/gwt/src/org/rstudio/studio/client/application/ui/RStudioThemes.java
Patch:
@@ -84,7 +84,7 @@ public static String suggestThemeFromAceTheme(String aceTheme, String rstudioThe
       if (rstudioTheme == "classic") return rstudioTheme;
 
       RegExp keyReg = RegExp.compile(
-         "ambiance|chaos|clouds midnight|cobalt|idle fingers|kr theme|" +
+         "ambiance|chaos|clouds midnight|cobalt|dracula|idle fingers|kr theme|" +
          "material|merbivore soft|merbivore|mono industrial|monokai|" +
          "pastel on dark|solarized dark|tomorrow night blue|tomorrow night bright|" +
          "tomorrow night 80s|tomorrow night|twilight|vibrant ink", "i");

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdTemplateData.java
Patch:
@@ -87,8 +87,8 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             option_type: "choice", 
             option_default: "default",
             option_nullable: true,
-            option_list: [ "default", "cerulean", "journal", "flatly",
-                           "readable", "spacelab", "united", "cosmo"]
+            option_list: [ "default", "cerulean", "journal", "flatly", "readable", "spacelab", 
+                           "united", "cosmo", "lumen", "paper", "sandstone", "simplex", "yeti" ]
             },
             {
             option_name: "highlight",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionShinyPage.java
Patch:
@@ -31,10 +31,10 @@
 public class NewConnectionShinyPage 
    extends WizardPage<NewConnectionContext, ConnectionOptions>
 {
-   public NewConnectionShinyPage(final NewConnectionInfo info)
+   public NewConnectionShinyPage(final NewConnectionInfo info, String subTitle)
    {
       super(info.getName(),
-            "",
+            subTitle,
             info.getName() + " Connection",
             StringUtil.isNullOrEmpty(info.iconData()) ? null
                   : new ImageResourceUrl(new SafeUri()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetPage.java
Patch:
@@ -31,11 +31,11 @@
 public class NewConnectionSnippetPage 
    extends WizardPage<NewConnectionContext, ConnectionOptions>
 {
-   public NewConnectionSnippetPage(final NewConnectionInfo info)
+   public NewConnectionSnippetPage(final NewConnectionInfo info, String subTitle)
    {
       super(
          info.getName(),
-         "",
+         subTitle,
          info.getName() + " Connection",
          StringUtil.isNullOrEmpty(info.iconData()) ? null : new ImageResourceUrl(
             new SafeUri()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HistoryCompletionManager.java
Patch:
@@ -193,7 +193,7 @@ public void onResponseReceived(RpcObjectList<HistoryEntry> resp)
          {
             HistoryMatch[] entries = new HistoryMatch[resp.length()];
             for (int i = 0; i < entries.length; i++)
-               entries[i] = new HistoryMatch(resp.get(i).getCommand(), text_);
+               entries[i] = new HistoryMatch(resp.get(entries.length - i - 1).getCommand(), text_);
             popup_ = new CompletionListPopupPanel<HistoryMatch>(entries);
             mode_ = desiredMode_;
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemeResources.java
Patch:
@@ -45,6 +45,9 @@ public interface AceThemeResources extends ClientBundle
 
    @Source("dawn.css")
    StaticDataResource dawn();
+   
+   @Source("dracula.css")
+   StaticDataResource dracula();
 
    @Source("dreamweaver.css")
    StaticDataResource dreamweaver();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java
Patch:
@@ -42,6 +42,7 @@ public class AceThemes
    public static final String COBALT = "Cobalt";
    public static final String CRIMSON_EDITOR = "Crimson Editor";
    public static final String DAWN = "Dawn";
+   public static final String DRACULA = "Dracula";
    public static final String DREAMWEAVER = "Dreamweaver";
    public static final String ECLIPSE = "Eclipse";
    public static final String IDLE_FINGERS = "Idle Fingers";
@@ -84,6 +85,7 @@ public AceThemes(AceThemeResources res,
       addTheme(COBALT, res.cobalt(), true);
       addTheme(CRIMSON_EDITOR, res.crimson_editor(), false);
       addTheme(DAWN, res.dawn(), false);
+      addTheme(DRACULA, res.dracula(), true);
       addTheme(DREAMWEAVER, res.dreamweaver(), false);
       addTheme(ECLIPSE, res.eclipse(), false);
       addTheme(IDLE_FINGERS, res.idle_fingers(), true);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -301,7 +301,7 @@ private void ensureTerminal(String postCreateText)
       else
       {
          setFocusOnVisible();
-         terminal.receivedInput(postCreateText);
+         terminal.receivedSendToTerminal(postCreateText);
       }
    }
 
@@ -699,7 +699,7 @@ public void onTerminalSessionStarted(TerminalSessionStartedEvent event)
       {
          terminal.writeRestartSequence();
       }
-      terminal.receivedInput(postCreateText_);
+      terminal.receivedSendToTerminal(postCreateText_);
       creatingTerminal_ = false;
       postCreateText_ = null;
       updateTerminalToolbar();
@@ -806,7 +806,7 @@ public void onSwitchToTerminal(SwitchToTerminalEvent event)
          showTerminalWidget(terminal);
          setFocusOnVisible();
          ensureConnected(terminal); // needed after session suspend/resume
-         terminal.receivedInput(event.getInputText());
+         terminal.receivedSendToTerminal(event.getInputText());
          return;
       }
 

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdTemplateData.java
Patch:
@@ -87,8 +87,8 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             option_type: "choice", 
             option_default: "default",
             option_nullable: true,
-            option_list: [ "default", "cerulean", "journal", "flatly",
-                           "readable", "spacelab", "united", "cosmo"]
+            option_list: [ "default", "cerulean", "journal", "flatly", "readable", "spacelab", 
+                           "united", "cosmo", "lumen", "paper", "sandstone", "simplex", "yeti" ]
             },
             {
             option_name: "highlight",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/view/ObjectExplorerDataGrid.java
Patch:
@@ -1347,7 +1347,7 @@ private void restoreScrollPosition()
    private static final int DEFAULT_NAME_COLUMN_WIDTH = 180;
    private static final int DEFAULT_TYPE_COLUMN_WIDTH = 180;
    
-   private static final int DEFAULT_ROW_LIMIT = 200;
+   private static final int DEFAULT_ROW_LIMIT = 1000;
    
    private static final String ACTION_OPEN    = "open";
    private static final String ACTION_CLOSE   = "close";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -301,7 +301,7 @@ private void ensureTerminal(String postCreateText)
       else
       {
          setFocusOnVisible();
-         terminal.receivedInput(postCreateText);
+         terminal.receivedSendToTerminal(postCreateText);
       }
    }
 
@@ -699,7 +699,7 @@ public void onTerminalSessionStarted(TerminalSessionStartedEvent event)
       {
          terminal.writeRestartSequence();
       }
-      terminal.receivedInput(postCreateText_);
+      terminal.receivedSendToTerminal(postCreateText_);
       creatingTerminal_ = false;
       postCreateText_ = null;
       updateTerminalToolbar();
@@ -806,7 +806,7 @@ public void onSwitchToTerminal(SwitchToTerminalEvent event)
          showTerminalWidget(terminal);
          setFocusOnVisible();
          ensureConnected(terminal); // needed after session suspend/resume
-         terminal.receivedInput(event.getInputText());
+         terminal.receivedSendToTerminal(event.getInputText());
          return;
       }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -301,7 +301,7 @@ private void ensureTerminal(String postCreateText)
       else
       {
          setFocusOnVisible();
-         terminal.receivedInput(postCreateText);
+         terminal.receivedSendToTerminal(postCreateText);
       }
    }
 
@@ -699,7 +699,7 @@ public void onTerminalSessionStarted(TerminalSessionStartedEvent event)
       {
          terminal.writeRestartSequence();
       }
-      terminal.receivedInput(postCreateText_);
+      terminal.receivedSendToTerminal(postCreateText_);
       creatingTerminal_ = false;
       postCreateText_ = null;
       updateTerminalToolbar();
@@ -806,7 +806,7 @@ public void onSwitchToTerminal(SwitchToTerminalEvent event)
          showTerminalWidget(terminal);
          setFocusOnVisible();
          ensureConnected(terminal); // needed after session suspend/resume
-         terminal.receivedInput(event.getInputText());
+         terminal.receivedSendToTerminal(event.getInputText());
          return;
       }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HistoryCompletionManager.java
Patch:
@@ -193,7 +193,7 @@ public void onResponseReceived(RpcObjectList<HistoryEntry> resp)
          {
             HistoryMatch[] entries = new HistoryMatch[resp.length()];
             for (int i = 0; i < entries.length; i++)
-               entries[i] = new HistoryMatch(resp.get(i).getCommand(), text_);
+               entries[i] = new HistoryMatch(resp.get(entries.length - i - 1).getCommand(), text_);
             popup_ = new CompletionListPopupPanel<HistoryMatch>(entries);
             mode_ = desiredMode_;
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionShinyPage.java
Patch:
@@ -31,10 +31,10 @@
 public class NewConnectionShinyPage 
    extends WizardPage<NewConnectionContext, ConnectionOptions>
 {
-   public NewConnectionShinyPage(final NewConnectionInfo info)
+   public NewConnectionShinyPage(final NewConnectionInfo info, String subTitle)
    {
       super(info.getName(),
-            "",
+            subTitle,
             info.getName() + " Connection",
             StringUtil.isNullOrEmpty(info.iconData()) ? null
                   : new ImageResourceUrl(new SafeUri()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetPage.java
Patch:
@@ -31,11 +31,11 @@
 public class NewConnectionSnippetPage 
    extends WizardPage<NewConnectionContext, ConnectionOptions>
 {
-   public NewConnectionSnippetPage(final NewConnectionInfo info)
+   public NewConnectionSnippetPage(final NewConnectionInfo info, String subTitle)
    {
       super(
          info.getName(),
-         "",
+         subTitle,
          info.getName() + " Connection",
          StringUtil.isNullOrEmpty(info.iconData()) ? null : new ImageResourceUrl(
             new SafeUri()

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FileTypeRegistry.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -138,7 +138,7 @@ public class FileTypeRegistry
 
    public static final TextFileType PYTHON = new ScriptFileType(
      "python", "Python", EditorLanguage.LANG_PYTHON, ".py",new ImageResource2x(ICONS.iconPython2x()),
-     "python", true);
+     "python", false, true);
 
    public static final TextFileType SQL =
          new TextFileType("sql", "SQL", EditorLanguage.LANG_SQL, ".sql",
@@ -147,7 +147,7 @@ public class FileTypeRegistry
 
    public static final TextFileType SH = new ScriptFileType(
          "sh", "Shell", EditorLanguage.LANG_SH, ".sh", new ImageResource2x(ICONS.iconSh2x()),
-         null, false);
+         null, true, false);
    
    public static final TextFileType TOML =
          new TextFileType("toml", "TOML", EditorLanguage.LANG_TOML, ".toml",

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/model/HTMLPreviewParams.java
Patch:
@@ -26,7 +26,7 @@ public final static native HTMLPreviewParams create(String path,
                                                        String encoding,
                                                        boolean isMarkdown,
                                                        boolean requiresKnit,
-                                                       boolean isNotebook)/*-{
+                                                       boolean isNotebook) /*-{
       var params = new Object();
       params.path = path;
       params.encoding = encoding;

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewApplicationWindow.java
Patch:
@@ -51,7 +51,7 @@ public HTMLPreviewApplicationWindow(Provider<HTMLPreviewPresenter> pPresenter,
    @Override
    protected void onInitialize(LayoutPanel mainPanel, JavaScriptObject params)
    {
-      Window.setTitle("RStudio: Preview HTML");
+      Window.setTitle("RStudio");
       
       // create the presenter and activate it with the passed params
       HTMLPreviewParams htmlPreviewParams = params.<HTMLPreviewParams>cast();

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -171,6 +171,7 @@ class ClientEvent extends JavaScriptObject
    public static final String RequestDocumentSave = "request_document_save";
    public static final String RequestOpenProject = "request_open_project";
    public static final String OpenFileDialog = "open_file_dialog";
+   public static final String ShowPageViewer = "show_page_viewer";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * Commands.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -397,6 +397,7 @@
    public abstract AppCommand showTerminalInfo();
    public abstract AppCommand interruptTerminal();
    public abstract AppCommand sendTerminalToEditor();
+   public abstract AppCommand sendToTerminal();
     
    // Help
    public abstract AppCommand helpBack();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -315,6 +315,9 @@ public void onUiPrefsChanged(UiPrefsChangedEvent e)
       
          // theme
          theme().setGlobalValue(newUiPrefs.theme().getGlobalValue());
+
+         // flat theme
+         getFlatTheme().setGlobalValue(newUiPrefs.getFlatTheme().getGlobalValue());
       
          // default encoding
          defaultEncoding().setGlobalValue(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsPresenter.java
Patch:
@@ -99,7 +99,7 @@ HandlerRegistration addExecuteConnectionActionHandler(
       String getConnectVia();
       String getConnectCode();
       
-      void showConnectionProgress();
+      void showConnectionProgress(String message);
    }
    
    public interface Binder extends CommandBinder<Commands, ConnectionsPresenter> {}
@@ -324,7 +324,7 @@ else if (connectVia.equals(ConnectionOptions.CONNECT_R_CONSOLE))
          eventBus_.fireEvent(
                new SendToConsoleEvent(connectCode, true));
          
-         display_.showConnectionProgress();
+         display_.showConnectionProgress("Connecting");
       }
       else if (connectVia.equals(ConnectionOptions.CONNECT_NEW_R_SCRIPT) ||
                connectVia.equals(ConnectionOptions.CONNECT_NEW_R_NOTEBOOK))
@@ -359,7 +359,7 @@ else if (connectVia.equals(ConnectionOptions.CONNECT_NEW_R_SCRIPT) ||
          eventBus_.fireEvent(
             new NewDocumentWithCodeEvent(type, code, cursorPosition, true));
          
-         display_.showConnectionProgress();
+         display_.showConnectionProgress("Connecting");
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionExplorer.java
Patch:
@@ -94,9 +94,9 @@ public void initialize(EventBus eventBus)
       eventBus_ = eventBus;
    }
    
-   public void showConnectionProgress()
+   public void showConnectionProgress(String message)
    {
-      containerPanel_.showProgress(50); 
+      containerPanel_.showProgress(50, message); 
    }
    
    public void setConnection(Connection connection, String connectVia)
@@ -139,7 +139,6 @@ public void onResize()
    {
       containerPanel_.onResize();
       codePanel_.onResize();
-      
    }
    
    private void showActivePanel()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -345,9 +345,9 @@ public String getConnectCode()
    }
    
    @Override
-   public void showConnectionProgress()
+   public void showConnectionProgress(String message)
    {
-      connectionExplorer_.showConnectionProgress();
+      connectionExplorer_.showConnectionProgress(message);
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionNavigationPage.java
Patch:
@@ -52,7 +52,7 @@ public NewConnectionNavigationPage(String title,
    {
       super(title, 
             subTitle,
-            "Create Connection",
+            "Connect to Existing Data Sources",
             icon,
             null, 
             createPages(context),

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetHost.java
Patch:
@@ -206,6 +206,7 @@ private Grid createParameterizedUI(final NewConnectionInfo info)
       boolean showAdvancedButton = visibleRows > maxRows_;
       visibleRows = Math.min(visibleRows, maxRows_);
 
+      visibleParams = Math.min(visibleParams, snippetParts.size());
       final ArrayList<NewConnectionSnippetParts> secondarySnippetParts = 
             new ArrayList<NewConnectionSnippetParts>(snippetParts.subList(visibleParams, snippetParts.size()));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -107,12 +107,12 @@ protected Widget createMainWidget()
    {
       frame_ = new RStudioThemedFrame(
          null,
+         ".rstudio-themes-flat.editor_dark div#TOC,\n" +
          ".rstudio-themes-flat.editor_dark h1,\n" +
          ".rstudio-themes-flat.editor_dark h2,\n" +
          ".rstudio-themes-flat.editor_dark h3,\n" +
          ".rstudio-themes-flat.editor_dark h4,\n" +
-         ".rstudio-themes-flat.editor_dark table,\n" +
-         ".rstudio-themes-flat.editor_dark pre {\n" +
+         ".rstudio-themes-flat.editor_dark table {\n" +
          "  background: none !important;\n" +
          "  color: white !important;\n" +
          "}\n",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -129,7 +129,9 @@ public ChunkOutputWidget(String documentId, String chunkId,
       ChunkDataWidget.injectPagedTableResources();
 
       clear_.addStyleName("rstudio-themes-inverts");
+      clear_.addStyleName("rstudio-classic-inverts");
       expand_.addStyleName("rstudio-themes-inverts");
+      expand_.addStyleName("rstudio-classic-inverts");
       
       if (chunkOutputSize_ == ChunkOutputSize.Default)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/RemoveTerminalEvent.java
Patch:
@@ -20,6 +20,9 @@
 
 import org.rstudio.studio.client.workbench.views.terminal.events.RemoveTerminalEvent.Handler;
 
+/**
+ * Eliminate a terminal that was killed via rstudioapi::terminalKill.
+ */
 public class RemoveTerminalEvent extends GwtEvent<Handler>
 {
    public static class Data extends JavaScriptObject

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -107,12 +107,12 @@ protected Widget createMainWidget()
    {
       frame_ = new RStudioThemedFrame(
          null,
+         ".rstudio-themes-flat.editor_dark div#TOC,\n" +
          ".rstudio-themes-flat.editor_dark h1,\n" +
          ".rstudio-themes-flat.editor_dark h2,\n" +
          ".rstudio-themes-flat.editor_dark h3,\n" +
          ".rstudio-themes-flat.editor_dark h4,\n" +
-         ".rstudio-themes-flat.editor_dark table,\n" +
-         ".rstudio-themes-flat.editor_dark pre {\n" +
+         ".rstudio-themes-flat.editor_dark table {\n" +
          "  background: none !important;\n" +
          "  color: white !important;\n" +
          "}\n",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionNavigationPage.java
Patch:
@@ -52,7 +52,7 @@ public NewConnectionNavigationPage(String title,
    {
       super(title, 
             subTitle,
-            "Create Connection",
+            "Connect to Existing Data Sources",
             icon,
             null, 
             createPages(context),

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewApplicationWindow.java
Patch:
@@ -51,7 +51,7 @@ public HTMLPreviewApplicationWindow(Provider<HTMLPreviewPresenter> pPresenter,
    @Override
    protected void onInitialize(LayoutPanel mainPanel, JavaScriptObject params)
    {
-      Window.setTitle("RStudio Viewer");
+      Window.setTitle("RStudio");
       
       // create the presenter and activate it with the passed params
       HTMLPreviewParams htmlPreviewParams = params.<HTMLPreviewParams>cast();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5186,7 +5186,6 @@ public HTMLPreviewParams get()
                                             docUpdateSentinel_.getEncoding(),
                                             fileType_.isMarkdown(),
                                             fileType_.requiresKnit(),
-                                            false,
                                             false);
          }
       });
@@ -5367,8 +5366,7 @@ public HTMLPreviewParams get()
                                                docUpdateSentinel_.getEncoding(),
                                                true,
                                                true,
-                                               true,
-                                               false);
+                                               true);
             }
          });
       }

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreview.java
Patch:
@@ -38,7 +38,7 @@ public void onShowHTMLPreview(ShowHTMLPreviewEvent event)
             // open the window 
             satelliteManager.openSatellite(HTMLPreviewApplication.NAME,     
                                             event.getParams(),
-                                            new Size(850,1100));   
+                                            new Size(1100,1200));   
             
          }  
       });

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewApplicationWindow.java
Patch:
@@ -51,7 +51,7 @@ public HTMLPreviewApplicationWindow(Provider<HTMLPreviewPresenter> pPresenter,
    @Override
    protected void onInitialize(LayoutPanel mainPanel, JavaScriptObject params)
    {
-      Window.setTitle("RStudio: Preview HTML");
+      Window.setTitle("RStudio Viewer");
       
       // create the presenter and activate it with the passed params
       HTMLPreviewParams htmlPreviewParams = params.<HTMLPreviewParams>cast();

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -171,6 +171,7 @@ class ClientEvent extends JavaScriptObject
    public static final String RequestDocumentSave = "request_document_save";
    public static final String RequestOpenProject = "request_open_project";
    public static final String OpenFileDialog = "open_file_dialog";
+   public static final String ShowPageViewer = "show_page_viewer";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -315,6 +315,9 @@ public void onUiPrefsChanged(UiPrefsChangedEvent e)
       
          // theme
          theme().setGlobalValue(newUiPrefs.theme().getGlobalValue());
+
+         // flat theme
+         getFlatTheme().setGlobalValue(newUiPrefs.getFlatTheme().getGlobalValue());
       
          // default encoding
          defaultEncoding().setGlobalValue(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5186,6 +5186,7 @@ public HTMLPreviewParams get()
                                             docUpdateSentinel_.getEncoding(),
                                             fileType_.isMarkdown(),
                                             fileType_.requiresKnit(),
+                                            false,
                                             false);
          }
       });
@@ -5366,7 +5367,8 @@ public HTMLPreviewParams get()
                                                docUpdateSentinel_.getEncoding(),
                                                true,
                                                true,
-                                               true);
+                                               true,
+                                               false);
             }
          });
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTabPresenter.java
Patch:
@@ -103,7 +103,7 @@ public interface Display extends WorkbenchView
       void addTerminal(ConsoleProcessInfo cpi, boolean hasSession);
       
       /**
-       * Remove a terminal from the list.
+       * Remove a terminal that was killed via rstudioapi::terminalKill.
        * @param handle terminal to remove
        * caption
        */

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/RemoveTerminalEvent.java
Patch:
@@ -20,6 +20,9 @@
 
 import org.rstudio.studio.client.workbench.views.terminal.events.RemoveTerminalEvent.Handler;
 
+/**
+ * Eliminate a terminal that was killed via rstudioapi::terminalKill.
+ */
 public class RemoveTerminalEvent extends GwtEvent<Handler>
 {
    public static class Data extends JavaScriptObject

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTabPresenter.java
Patch:
@@ -103,7 +103,7 @@ public interface Display extends WorkbenchView
       void addTerminal(ConsoleProcessInfo cpi, boolean hasSession);
       
       /**
-       * Remove a terminal from the list.
+       * Remove a terminal that was killed via rstudioapi::terminalKill.
        * @param handle terminal to remove
        * caption
        */

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/RemoveTerminalEvent.java
Patch:
@@ -20,6 +20,9 @@
 
 import org.rstudio.studio.client.workbench.views.terminal.events.RemoveTerminalEvent.Handler;
 
+/**
+ * Eliminate a terminal that was killed via rstudioapi::terminalKill.
+ */
 public class RemoveTerminalEvent extends GwtEvent<Handler>
 {
    public static class Data extends JavaScriptObject

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreview.java
Patch:
@@ -38,7 +38,7 @@ public void onShowHTMLPreview(ShowHTMLPreviewEvent event)
             // open the window 
             satelliteManager.openSatellite(HTMLPreviewApplication.NAME,     
                                             event.getParams(),
-                                            new Size(850,1100));   
+                                            new Size(1100,1200));   
             
          }  
       });

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewApplicationWindow.java
Patch:
@@ -51,7 +51,7 @@ public HTMLPreviewApplicationWindow(Provider<HTMLPreviewPresenter> pPresenter,
    @Override
    protected void onInitialize(LayoutPanel mainPanel, JavaScriptObject params)
    {
-      Window.setTitle("RStudio: Preview HTML");
+      Window.setTitle("RStudio Viewer");
       
       // create the presenter and activate it with the passed params
       HTMLPreviewParams htmlPreviewParams = params.<HTMLPreviewParams>cast();

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -171,6 +171,7 @@ class ClientEvent extends JavaScriptObject
    public static final String RequestDocumentSave = "request_document_save";
    public static final String RequestOpenProject = "request_open_project";
    public static final String OpenFileDialog = "open_file_dialog";
+   public static final String ShowPageViewer = "show_page_viewer";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -315,6 +315,9 @@ public void onUiPrefsChanged(UiPrefsChangedEvent e)
       
          // theme
          theme().setGlobalValue(newUiPrefs.theme().getGlobalValue());
+
+         // flat theme
+         getFlatTheme().setGlobalValue(newUiPrefs.getFlatTheme().getGlobalValue());
       
          // default encoding
          defaultEncoding().setGlobalValue(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5186,6 +5186,7 @@ public HTMLPreviewParams get()
                                             docUpdateSentinel_.getEncoding(),
                                             fileType_.isMarkdown(),
                                             fileType_.requiresKnit(),
+                                            false,
                                             false);
          }
       });
@@ -5366,7 +5367,8 @@ public HTMLPreviewParams get()
                                                docUpdateSentinel_.getEncoding(),
                                                true,
                                                true,
-                                               true);
+                                               true,
+                                               false);
             }
          });
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTabPresenter.java
Patch:
@@ -103,7 +103,7 @@ public interface Display extends WorkbenchView
       void addTerminal(ConsoleProcessInfo cpi, boolean hasSession);
       
       /**
-       * Remove a terminal from the list.
+       * Remove a terminal that was killed via rstudioapi::terminalKill.
        * @param handle terminal to remove
        * caption
        */

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/RemoveTerminalEvent.java
Patch:
@@ -20,6 +20,9 @@
 
 import org.rstudio.studio.client.workbench.views.terminal.events.RemoveTerminalEvent.Handler;
 
+/**
+ * Eliminate a terminal that was killed via rstudioapi::terminalKill.
+ */
 public class RemoveTerminalEvent extends GwtEvent<Handler>
 {
    public static class Data extends JavaScriptObject

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -315,6 +315,9 @@ public void onUiPrefsChanged(UiPrefsChangedEvent e)
       
          // theme
          theme().setGlobalValue(newUiPrefs.theme().getGlobalValue());
+
+         // flat theme
+         getFlatTheme().setGlobalValue(newUiPrefs.getFlatTheme().getGlobalValue());
       
          // default encoding
          defaultEncoding().setGlobalValue(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -261,7 +261,7 @@ void onExecuteLastCode()
    @Handler 
    void onSendToTerminal() 
    { 
-      codeExecution_.sendSelectionToTerminal();
+      codeExecution_.sendSelectionToTerminal(false);
    } 
 
    @Handler

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -129,7 +129,9 @@ public ChunkOutputWidget(String documentId, String chunkId,
       ChunkDataWidget.injectPagedTableResources();
 
       clear_.addStyleName("rstudio-themes-inverts");
+      clear_.addStyleName("rstudio-classic-inverts");
       expand_.addStyleName("rstudio-themes-inverts");
+      expand_.addStyleName("rstudio-classic-inverts");
       
       if (chunkOutputSize_ == ChunkOutputSize.Default)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4035,7 +4035,7 @@ else if (view_.isAttached())
    void onExecuteCode()
    {
       if (fileType_.isScript())
-         onSendToTerminal();
+         codeExecution_.sendSelectionToTerminal(true);
       else
          codeExecution_.executeSelection(true);
    }
@@ -4061,7 +4061,7 @@ void onExecuteCurrentParagraph()
    @Handler
    void onSendToTerminal()
    {
-      codeExecution_.sendSelectionToTerminal();
+      codeExecution_.sendSelectionToTerminal(false);
    }
  
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -129,7 +129,9 @@ public ChunkOutputWidget(String documentId, String chunkId,
       ChunkDataWidget.injectPagedTableResources();
 
       clear_.addStyleName("rstudio-themes-inverts");
+      clear_.addStyleName("rstudio-classic-inverts");
       expand_.addStyleName("rstudio-themes-inverts");
+      expand_.addStyleName("rstudio-classic-inverts");
       
       if (chunkOutputSize_ == ChunkOutputSize.Default)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -129,7 +129,9 @@ public ChunkOutputWidget(String documentId, String chunkId,
       ChunkDataWidget.injectPagedTableResources();
 
       clear_.addStyleName("rstudio-themes-inverts");
+      clear_.addStyleName("rstudio-classic-inverts");
       expand_.addStyleName("rstudio-themes-inverts");
+      expand_.addStyleName("rstudio-classic-inverts");
       
       if (chunkOutputSize_ == ChunkOutputSize.Default)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -261,7 +261,7 @@ void onExecuteLastCode()
    @Handler 
    void onSendToTerminal() 
    { 
-      codeExecution_.sendSelectionToTerminal();
+      codeExecution_.sendSelectionToTerminal(false);
    } 
 
    @Handler

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4035,7 +4035,7 @@ else if (view_.isAttached())
    void onExecuteCode()
    {
       if (fileType_.isScript())
-         onSendToTerminal();
+         codeExecution_.sendSelectionToTerminal(true);
       else
          codeExecution_.executeSelection(true);
    }
@@ -4061,7 +4061,7 @@ void onExecuteCurrentParagraph()
    @Handler
    void onSendToTerminal()
    {
-      codeExecution_.sendSelectionToTerminal();
+      codeExecution_.sendSelectionToTerminal(false);
    }
  
    @Override

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -994,6 +994,7 @@ private void removeTerminalCommands()
       commands_.showTerminalInfo().remove();
       commands_.interruptTerminal().remove();
       commands_.sendTerminalToEditor().remove();
+      commands_.sendToTerminal().remove();
    }
 
    private final ApplicationView view_ ;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FileTypeRegistry.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -138,7 +138,7 @@ public class FileTypeRegistry
 
    public static final TextFileType PYTHON = new ScriptFileType(
      "python", "Python", EditorLanguage.LANG_PYTHON, ".py",new ImageResource2x(ICONS.iconPython2x()),
-     "python", true);
+     "python", false, true);
 
    public static final TextFileType SQL =
          new TextFileType("sql", "SQL", EditorLanguage.LANG_SQL, ".sql",
@@ -147,7 +147,7 @@ public class FileTypeRegistry
 
    public static final TextFileType SH = new ScriptFileType(
          "sh", "Shell", EditorLanguage.LANG_SH, ".sh", new ImageResource2x(ICONS.iconSh2x()),
-         null, false);
+         null, true, false);
    
    public static final TextFileType TOML =
          new TextFileType("toml", "TOML", EditorLanguage.LANG_TOML, ".toml",

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ScriptFileType.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ScriptFileType.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -31,10 +31,11 @@ public ScriptFileType(String id,
                          String ext, 
                          ImageResource icon,
                          String interpreter,
+                         boolean canExecuteCode,
                          boolean windowsCompatible)
    {
       super(id, label, language, ext, icon,
-            false, false, false, false, false, false, 
+            false, false, canExecuteCode, false, false, false, 
             false, false, false, false, false, false, false);
       interpreter_ = interpreter;
       windowsCompatible_ = windowsCompatible;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * Commands.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -397,6 +397,7 @@
    public abstract AppCommand showTerminalInfo();
    public abstract AppCommand interruptTerminal();
    public abstract AppCommand sendTerminalToEditor();
+   public abstract AppCommand sendToTerminal();
     
    // Help
    public abstract AppCommand helpBack();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/TerminalPreferencesPane.java
Patch:
@@ -129,7 +129,7 @@ public void onChange(ChangeEvent event)
 
       if (haveCaptureEnvPref())
       {
-         CheckBox chkCaptureEnv = checkboxPref("Save and Restore Environment Variables",
+         CheckBox chkCaptureEnv = checkboxPref("Save and restore environment variables",
                prefs_.terminalTrackEnvironment(),
                "Terminal occasionally runs a hidden command to capture state of environment variables.");
          add(chkCaptureEnv);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsPresenter.java
Patch:
@@ -99,7 +99,7 @@ HandlerRegistration addExecuteConnectionActionHandler(
       String getConnectVia();
       String getConnectCode();
       
-      void showConnectionProgress();
+      void showConnectionProgress(String message);
    }
    
    public interface Binder extends CommandBinder<Commands, ConnectionsPresenter> {}
@@ -324,7 +324,7 @@ else if (connectVia.equals(ConnectionOptions.CONNECT_R_CONSOLE))
          eventBus_.fireEvent(
                new SendToConsoleEvent(connectCode, true));
          
-         display_.showConnectionProgress();
+         display_.showConnectionProgress("Connecting");
       }
       else if (connectVia.equals(ConnectionOptions.CONNECT_NEW_R_SCRIPT) ||
                connectVia.equals(ConnectionOptions.CONNECT_NEW_R_NOTEBOOK))
@@ -359,7 +359,7 @@ else if (connectVia.equals(ConnectionOptions.CONNECT_NEW_R_SCRIPT) ||
          eventBus_.fireEvent(
             new NewDocumentWithCodeEvent(type, code, cursorPosition, true));
          
-         display_.showConnectionProgress();
+         display_.showConnectionProgress("Connecting");
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionExplorer.java
Patch:
@@ -94,9 +94,9 @@ public void initialize(EventBus eventBus)
       eventBus_ = eventBus;
    }
    
-   public void showConnectionProgress()
+   public void showConnectionProgress(String message)
    {
-      containerPanel_.showProgress(50); 
+      containerPanel_.showProgress(50, message); 
    }
    
    public void setConnection(Connection connection, String connectVia)
@@ -139,7 +139,6 @@ public void onResize()
    {
       containerPanel_.onResize();
       codePanel_.onResize();
-      
    }
    
    private void showActivePanel()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -345,9 +345,9 @@ public String getConnectCode()
    }
    
    @Override
-   public void showConnectionProgress()
+   public void showConnectionProgress(String message)
    {
-      connectionExplorer_.showConnectionProgress();
+      connectionExplorer_.showConnectionProgress(message);
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetHost.java
Patch:
@@ -206,6 +206,7 @@ private Grid createParameterizedUI(final NewConnectionInfo info)
       boolean showAdvancedButton = visibleRows > maxRows_;
       visibleRows = Math.min(visibleRows, maxRows_);
 
+      visibleParams = Math.min(visibleParams, snippetParts.size());
       final ArrayList<NewConnectionSnippetParts> secondarySnippetParts = 
             new ArrayList<NewConnectionSnippetParts>(snippetParts.subList(visibleParams, snippetParts.size()));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermWidget.java
Patch:
@@ -139,7 +139,6 @@ public void write(String str)
    public void clear()
    {
       terminal_.clear();
-      setFocus(true);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTabPresenter.java
Patch:
@@ -87,7 +87,7 @@ public interface Display extends WorkbenchView
       void previousTerminal();
       void nextTerminal();
       void showTerminalInfo();
-      void sendToTerminal(String text);
+      void sendToTerminal(String text, boolean setFocus);
       
       /**
        * Send SIGINT to child process of the terminal shell.
@@ -202,7 +202,7 @@ public void onCreateTerminal(CreateTerminalEvent event)
    @Override
    public void onSendToTerminal(SendToTerminalEvent event)
    {
-      view_.sendToTerminal(event.getText());
+      view_.sendToTerminal(event.getText(), event.getSetFocus());
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermWidget.java
Patch:
@@ -139,7 +139,6 @@ public void write(String str)
    public void clear()
    {
       terminal_.clear();
-      setFocus(true);
    }
 
    /**

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsPresenter.java
Patch:
@@ -99,7 +99,7 @@ HandlerRegistration addExecuteConnectionActionHandler(
       String getConnectVia();
       String getConnectCode();
       
-      void showConnectionProgress();
+      void showConnectionProgress(String message);
    }
    
    public interface Binder extends CommandBinder<Commands, ConnectionsPresenter> {}
@@ -324,7 +324,7 @@ else if (connectVia.equals(ConnectionOptions.CONNECT_R_CONSOLE))
          eventBus_.fireEvent(
                new SendToConsoleEvent(connectCode, true));
          
-         display_.showConnectionProgress();
+         display_.showConnectionProgress("Connecting");
       }
       else if (connectVia.equals(ConnectionOptions.CONNECT_NEW_R_SCRIPT) ||
                connectVia.equals(ConnectionOptions.CONNECT_NEW_R_NOTEBOOK))
@@ -359,7 +359,7 @@ else if (connectVia.equals(ConnectionOptions.CONNECT_NEW_R_SCRIPT) ||
          eventBus_.fireEvent(
             new NewDocumentWithCodeEvent(type, code, cursorPosition, true));
          
-         display_.showConnectionProgress();
+         display_.showConnectionProgress("Connecting");
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionExplorer.java
Patch:
@@ -94,9 +94,9 @@ public void initialize(EventBus eventBus)
       eventBus_ = eventBus;
    }
    
-   public void showConnectionProgress()
+   public void showConnectionProgress(String message)
    {
-      containerPanel_.showProgress(50); 
+      containerPanel_.showProgress(50, message); 
    }
    
    public void setConnection(Connection connection, String connectVia)
@@ -139,7 +139,6 @@ public void onResize()
    {
       containerPanel_.onResize();
       codePanel_.onResize();
-      
    }
    
    private void showActivePanel()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -345,9 +345,9 @@ public String getConnectCode()
    }
    
    @Override
-   public void showConnectionProgress()
+   public void showConnectionProgress(String message)
    {
-      connectionExplorer_.showConnectionProgress();
+      connectionExplorer_.showConnectionProgress(message);
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetHost.java
Patch:
@@ -206,6 +206,7 @@ private Grid createParameterizedUI(final NewConnectionInfo info)
       boolean showAdvancedButton = visibleRows > maxRows_;
       visibleRows = Math.min(visibleRows, maxRows_);
 
+      visibleParams = Math.min(visibleParams, snippetParts.size());
       final ArrayList<NewConnectionSnippetParts> secondarySnippetParts = 
             new ArrayList<NewConnectionSnippetParts>(snippetParts.subList(visibleParams, snippetParts.size()));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetHost.java
Patch:
@@ -206,6 +206,7 @@ private Grid createParameterizedUI(final NewConnectionInfo info)
       boolean showAdvancedButton = visibleRows > maxRows_;
       visibleRows = Math.min(visibleRows, maxRows_);
 
+      visibleParams = Math.min(visibleParams, snippetParts.size());
       final ArrayList<NewConnectionSnippetParts> secondarySnippetParts = 
             new ArrayList<NewConnectionSnippetParts>(snippetParts.subList(visibleParams, snippetParts.size()));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetHost.java
Patch:
@@ -206,6 +206,7 @@ private Grid createParameterizedUI(final NewConnectionInfo info)
       boolean showAdvancedButton = visibleRows > maxRows_;
       visibleRows = Math.min(visibleRows, maxRows_);
 
+      visibleParams = Math.min(visibleParams, snippetParts.size());
       final ArrayList<NewConnectionSnippetParts> secondarySnippetParts = 
             new ArrayList<NewConnectionSnippetParts>(snippetParts.subList(visibleParams, snippetParts.size()));
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermNative.java
Patch:
@@ -105,11 +105,11 @@ public final native void addClass(String classStr) /*-{
    }-*/;
    
    public final native int cursorX() /*-{
-      return this.x;
+      return this.buffer.x;
    }-*/;
    
    public final native int cursorY() /*-{
-      return this.y;
+      return this.buffer.y;
    }-*/;
  
    public final native boolean altBufferActive() /*-{
@@ -127,7 +127,7 @@ public final native void showAltBuffer() /*-{
    }-*/;
     
    public final native String currentLine() /*-{
-      lineBuf = this.buffer.lines.get(this.y + this.ybase);
+      lineBuf = this.buffer.lines.get(this.buffer.y + this.buffer.ybase);
       if (!lineBuf) // resize may be in progress
          return null;
       current = "";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ObjectBrowser.java
Patch:
@@ -18,7 +18,6 @@
 import java.util.HashSet;
 import java.util.Set;
 
-import org.rstudio.core.client.widget.ProgressPanel;
 import org.rstudio.core.client.widget.SimplePanelWithProgress;
 import org.rstudio.studio.client.workbench.views.connections.model.Connection;
 import org.rstudio.studio.client.workbench.views.connections.model.DatabaseObject;
@@ -46,6 +45,7 @@ public ObjectBrowser()
       scrollPanel_ = new ScrollPanel();
       scrollPanel_.setSize("100%", "100%");
       hostPanel_.setWidget(scrollPanel_);
+      hostPanel_.setSize("100%", "100%");
       connection_ = null;
        
       // init widget

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -994,6 +994,7 @@ private void removeTerminalCommands()
       commands_.showTerminalInfo().remove();
       commands_.interruptTerminal().remove();
       commands_.sendTerminalToEditor().remove();
+      commands_.sendToTerminal().remove();
    }
 
    private final ApplicationView view_ ;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * FileTypeRegistry.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -138,7 +138,7 @@ public class FileTypeRegistry
 
    public static final TextFileType PYTHON = new ScriptFileType(
      "python", "Python", EditorLanguage.LANG_PYTHON, ".py",new ImageResource2x(ICONS.iconPython2x()),
-     "python", true);
+     "python", false, true);
 
    public static final TextFileType SQL =
          new TextFileType("sql", "SQL", EditorLanguage.LANG_SQL, ".sql",
@@ -147,7 +147,7 @@ public class FileTypeRegistry
 
    public static final TextFileType SH = new ScriptFileType(
          "sh", "Shell", EditorLanguage.LANG_SH, ".sh", new ImageResource2x(ICONS.iconSh2x()),
-         null, false);
+         null, true, false);
    
    public static final TextFileType TOML =
          new TextFileType("toml", "TOML", EditorLanguage.LANG_TOML, ".toml",

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ScriptFileType.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ScriptFileType.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -31,10 +31,11 @@ public ScriptFileType(String id,
                          String ext, 
                          ImageResource icon,
                          String interpreter,
+                         boolean canExecuteCode,
                          boolean windowsCompatible)
    {
       super(id, label, language, ext, icon,
-            false, false, false, false, false, false, 
+            false, false, canExecuteCode, false, false, false, 
             false, false, false, false, false, false, false);
       interpreter_ = interpreter;
       windowsCompatible_ = windowsCompatible;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * Commands.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -397,6 +397,7 @@
    public abstract AppCommand showTerminalInfo();
    public abstract AppCommand interruptTerminal();
    public abstract AppCommand sendTerminalToEditor();
+   public abstract AppCommand sendToTerminal();
     
    // Help
    public abstract AppCommand helpBack();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTargetCodeExecution.java
Patch:
@@ -196,7 +196,7 @@ public void sendSelectionToTerminal(boolean terminalExecuteWhenNotFocused)
       String code = codeExtractor_.extractCode(docDisplay_, selectionRange);
       if (!code.isEmpty() && !(code.endsWith("\n") || code.endsWith("\r")))
          code = code + "\n";
-      events_.fireEvent(new SendToTerminalEvent(code, null));
+      events_.fireEvent(new SendToTerminalEvent(code));
  }
    
    public void profileSelection()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTabPresenter.java
Patch:
@@ -87,7 +87,7 @@ public interface Display extends WorkbenchView
       void previousTerminal();
       void nextTerminal();
       void showTerminalInfo();
-      void sendToTerminal(String text, String caption);
+      void sendToTerminal(String text);
       
       /**
        * Send SIGINT to child process of the terminal shell.
@@ -202,7 +202,7 @@ public void onCreateTerminal(CreateTerminalEvent event)
    @Override
    public void onSendToTerminal(SendToTerminalEvent event)
    {
-      view_.sendToTerminal(event.getText(), event.getId());
+      view_.sendToTerminal(event.getText());
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -138,7 +138,7 @@ public class FileTypeRegistry
 
    public static final TextFileType PYTHON = new ScriptFileType(
      "python", "Python", EditorLanguage.LANG_PYTHON, ".py",new ImageResource2x(ICONS.iconPython2x()),
-     "python", true);
+     "python", false, true);
 
    public static final TextFileType SQL =
          new TextFileType("sql", "SQL", EditorLanguage.LANG_SQL, ".sql",
@@ -147,7 +147,7 @@ public class FileTypeRegistry
 
    public static final TextFileType SH = new ScriptFileType(
          "sh", "Shell", EditorLanguage.LANG_SH, ".sh", new ImageResource2x(ICONS.iconSh2x()),
-         null, false);
+         null, true, false);
    
    public static final TextFileType TOML =
          new TextFileType("toml", "TOML", EditorLanguage.LANG_TOML, ".toml",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -3753,7 +3753,8 @@ private void manageSaveAllCommand()
    
    private void manageTerminalCommands()
    {
-      commands_.sendToTerminal().setVisible(session_.getSessionInfo().getAllowShell());
+      if (!session_.getSessionInfo().getAllowShell())
+         commands_.sendToTerminal().setVisible(false);
    }
    
    private boolean verifyNoUnsupportedCommands(HashSet<AppCommand> commands)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTargetCodeExecution.java
Patch:
@@ -194,6 +194,8 @@ public void sendSelectionToTerminal(boolean terminalExecuteWhenNotFocused)
             return;
       }
       String code = codeExtractor_.extractCode(docDisplay_, selectionRange);
+      if (!code.isEmpty() && !(code.endsWith("\n") || code.endsWith("\r")))
+         code = code + "\n";
       events_.fireEvent(new SendToTerminalEvent(code, null));
  }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -560,7 +560,7 @@ public void adaptToFileType(TextFileType fileType)
       // don't show the run buttons for cpp files, or R files in Shiny
       runButton_.setVisible(canExecuteCode && !canExecuteChunks && !isCpp && 
             !isShinyFile());
-      runLastButton_.setVisible(runButton_.isVisible() && !canExecuteChunks);
+      runLastButton_.setVisible(runButton_.isVisible() && !canExecuteChunks && !isScript);
       
       // show insertion options for various knitr engines in rmarkdown v2
       insertChunkMenu_.setVisible(isRMarkdown2);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/TerminalPreferencesPane.java
Patch:
@@ -129,7 +129,7 @@ public void onChange(ChangeEvent event)
 
       if (haveCaptureEnvPref())
       {
-         CheckBox chkCaptureEnv = checkboxPref("Save and Restore Environment Variables",
+         CheckBox chkCaptureEnv = checkboxPref("Save and restore environment variables",
                prefs_.terminalTrackEnvironment(),
                "Terminal occasionally runs a hidden command to capture state of environment variables.");
          add(chkCaptureEnv);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/TerminalPreferencesPane.java
Patch:
@@ -129,7 +129,7 @@ public void onChange(ChangeEvent event)
 
       if (haveCaptureEnvPref())
       {
-         CheckBox chkCaptureEnv = checkboxPref("Save and Restore Environment Variables",
+         CheckBox chkCaptureEnv = checkboxPref("Save and restore environment variables",
                prefs_.terminalTrackEnvironment(),
                "Terminal occasionally runs a hidden command to capture state of environment variables.");
          add(chkCaptureEnv);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/TerminalPreferencesPane.java
Patch:
@@ -129,7 +129,7 @@ public void onChange(ChangeEvent event)
 
       if (haveCaptureEnvPref())
       {
-         CheckBox chkCaptureEnv = checkboxPref("Save and Restore Environment Variables",
+         CheckBox chkCaptureEnv = checkboxPref("Save and restore environment variables",
                prefs_.terminalTrackEnvironment(),
                "Terminal occasionally runs a hidden command to capture state of environment variables.");
          add(chkCaptureEnv);

File: src/gwt/src/org/rstudio/core/client/command/AppMenuBar.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.gwt.user.client.ui.MenuBar;
 import com.google.gwt.user.client.ui.MenuItem;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.dom.DomUtils;
 
 import java.util.List;
@@ -64,7 +65,8 @@ public MenuItem addItem(String text, boolean asHTML, MenuBar popup)
          if (vertical_)
             text = AppCommand.formatMenuLabel(null, text, null);
          else
-            text = DomUtils.textToHtml(text);
+            text = "<span id=\"" + ElementIds.idFromLabel(text) + "_menu" + "\">" +
+                   DomUtils.textToHtml(text) + "</span>";
       }
 
       return super.addItem(text,

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -489,8 +489,9 @@ else if (binding.getId() == "closeSourceDoc")
                   // the word behind the cursor; so we'll ignore this command 
                   // when focus is in the terminal and let terminal see keys
                   return false;
-               } 
-               if (binding.getContext() != AppCommand.Context.Workbench &&
+               }
+               if (binding.getId() != "executeCode" &&
+                     binding.getContext() != AppCommand.Context.Workbench &&
                      binding.getContext() != AppCommand.Context.Addin &&
                      binding.getContext() != AppCommand.Context.PackageDevelopment)
                {

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogBase.java
Patch:
@@ -24,6 +24,8 @@
 import com.google.gwt.user.client.ui.DockLayoutPanel;
 import com.google.gwt.user.client.ui.FlowPanel;
 import com.google.gwt.user.client.ui.Widget;
+
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.events.EnsureVisibleEvent;
 import org.rstudio.core.client.events.EnsureVisibleHandler;
 import org.rstudio.core.client.widget.ModalDialogBase;
@@ -61,6 +63,7 @@ public void execute()
             });        
          }
       });
+      ElementIds.assignElementId(okButton.getElement(), ElementIds.PREFERENCES_CONFIRM);
       addOkButton(okButton);
       addCancelButton();
       

File: src/gwt/src/org/rstudio/core/client/prefs/SectionChooser.java
Patch:
@@ -14,6 +14,8 @@
  */
 package org.rstudio.core.client.prefs;
 
+import org.rstudio.core.client.ElementIds;
+
 import com.google.gwt.event.dom.client.ClickEvent;
 import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.dom.client.HasClickHandlers;
@@ -65,6 +67,7 @@ public void addSection(ImageResource icon, String name)
       innerPanel.add(nudgeRightPlus(label));
       panel.add(innerPanel);
       panel.setStyleName(res_.styles().section());
+      panel.getElement().setId(ElementIds.idFromLabel(name) + "_options");
 
       panel.addClickHandler(new ClickHandler()
       {

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -72,6 +72,7 @@ public interface ThemeStyles extends CssResource
    String toolbarButtonPushed();
    String emptyProjectMenu();
    String menuSubheader();
+   String menuItemSubtitle();
 
    String menuRightImage();
    

File: src/gwt/src/org/rstudio/core/client/widget/ProgressPanel.java
Patch:
@@ -81,7 +81,7 @@ public void endProgressOperation()
    {
       clearTimer();
       progressImage_.setVisible(false);
-      progressSpinner_.setVisible(true);
+      progressSpinner_.setVisible(false);
    }
 
    private int getSpinnerColor()

File: src/gwt/src/org/rstudio/core/client/widget/ProgressSpinner.java
Patch:
@@ -78,7 +78,7 @@ public ProgressSpinner(int color)
          public boolean execute()
          {
             frame_++;
-            redraw();
+            if (isVisible()) redraw();
             return !complete_;
          }
       }, FRAME_RATE_MS);

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -17,6 +17,7 @@
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.user.client.ui.*;
 import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 
 public class TextEntryModalDialog extends ModalDialog<String>
 {
@@ -42,6 +43,7 @@ public TextEntryModalDialog(String title,
                  numbersOnly ? new NumericTextBox() :
                  new TextBox();
       textBox_.setWidth("100%");
+      DomUtils.disableAutoBehavior(textBox_);
       captionLabel_ = new Label(caption);
 
       extraOption_ = new CheckBox(StringUtil.notNull(extraOptionPrompt));

File: src/gwt/src/org/rstudio/core/client/widget/Wizard.java
Patch:
@@ -19,6 +19,7 @@
 
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Debug;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
 
@@ -116,6 +117,7 @@ public void execute(Boolean valid)
          }
       });
       nextButton_.setVisible(false);
+      nextButton_.getElement().setId(ElementIds.idFromLabel(caption) + "_wizard_next");
       addActionButton(nextButton_);
    }
 
@@ -518,6 +520,7 @@ protected ArrayList<String> getWizardBodyStyles()
    private void resetOkButtonCaption()
    {
       setOkButtonCaption(okCaption_);
+      setOkButtonId(ElementIds.idFromLabel(okCaption_) + "_wizard_confirm");
    }
  
    private boolean pageIsFinal(WizardPage<I, T> page)

File: src/gwt/src/org/rstudio/core/client/widget/WizardPageSelector.java
Patch:
@@ -17,6 +17,7 @@
 import java.util.ArrayList;
 
 import org.rstudio.core.client.CommandWithArg;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 
 import com.google.gwt.dom.client.Style.Unit;
@@ -88,6 +89,8 @@ private class PageSelectorItem extends Composite
          
          LayoutPanel layoutPanel = new LayoutPanel();
          layoutPanel.addStyleName(styles.wizardPageSelectorItem());
+         layoutPanel.getElement().setId(
+               ElementIds.idFromLabel(pageInfo.getTitle() + "_wizard_page"));
          
          ImageResource pageImageResource = pageInfo.getImage();
          Image image = null;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -112,6 +112,7 @@
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.prefs.model.PrefsServerOperations;
 import org.rstudio.studio.client.workbench.snippets.SnippetServerOperations;
+import org.rstudio.studio.client.workbench.ui.PaneManager;
 import org.rstudio.studio.client.workbench.ui.WorkbenchScreen;
 import org.rstudio.studio.client.workbench.ui.WorkbenchTab;
 import org.rstudio.studio.client.workbench.views.buildtools.BuildPresenter;
@@ -243,6 +244,7 @@ protected void configure()
       bind(ProfilerPresenter.class).in(Singleton.class);
       bind(ObjectExplorerPresenter.class).asEagerSingleton();
       bind(WorkbenchContext.class).asEagerSingleton();
+      bind(PaneManager.class).in(Singleton.class);
       bind(DependencyManager.class).asEagerSingleton();
       bind(WorkbenchListManager.class).asEagerSingleton();
       bind(ApplicationQuit.class).asEagerSingleton();

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ObjectExplorerFileType.java
Patch:
@@ -22,7 +22,7 @@ public class ObjectExplorerFileType extends EditableFileType
 {
    public ObjectExplorerFileType()
    {
-      super("object_explorer",
+      super(ID,
             "Object Explorer",
             new ImageResource2x(FileIconResources.INSTANCE.iconObjectExplorer2x()));
    }
@@ -33,4 +33,6 @@ protected void openFile(FileSystemItem file, EventBus eventBus)
       assert false :
          "Object explorer doesn't operate on filesystem files";
    }
+   
+   public static final String ID = "object_explorer";
 }

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -52,6 +52,8 @@ public class EditorLanguage
          "mode/c_cpp", true);
    public static final EditorLanguage LANG_STAN = new EditorLanguage(
          "mode/stan", false, true);
+   public static final EditorLanguage LANG_YAML = new EditorLanguage(
+         "mode/yaml", false, true);
    
    // Modes borrowed from Ace
    public static final EditorLanguage LANG_PLAIN = new EditorLanguage(
@@ -70,8 +72,6 @@ public class EditorLanguage
          "ace/mode/sh", false, false);
    public static final EditorLanguage LANG_TOML = new EditorLanguage(
          "ace/mode/toml", false, true);
-   public static final EditorLanguage LANG_YAML = new EditorLanguage(
-         "ace/mode/yaml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(
          "ace/mode/xml", false, false);
    

File: src/gwt/src/org/rstudio/studio/client/common/viewfile/ViewFilePanel.java
Patch:
@@ -97,7 +97,8 @@ public ViewFilePanel(GlobalDisplay globalDisplay,
       docDisplay_.setReadOnly(true);
       
       TextEditingTarget.registerPrefs(releaseOnDismiss_, 
-            uiPrefs, 
+            uiPrefs,
+            null,
             docDisplay_,
             new TextEditingTarget.PrefsContext()
             {

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -109,6 +109,7 @@ private Toolbar createToolbar(Commands commands)
       publishButtonSeparator_ = toolbar.addLeftSeparator();
       toolbar.addLeftWidget(
                publishButton_ = new RSConnectPublishButton(
+                     RSConnectPublishButton.HOST_HTML_PREVIEW,
                      RSConnect.CONTENT_TYPE_DOCUMENT, true, null));
       
       findTextBox_ = new FindTextBox("Find");

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdEditorOptions.java
Patch:
@@ -58,8 +58,6 @@ public static String set(String yaml, String option, String value)
    
    private static String EDITOR_OPTION_KEY = "editor_options";
    
-   public static String PUBLISH_OUTPUT    = "publish_output";
-
    public static String PREVIEW_IN        = "preview";
    public static String PREVIEW_IN_WINDOW = "window";
    public static String PREVIEW_IN_VIEWER = "viewer";

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -215,6 +215,7 @@ private void findInTopic(String term, CanFocus findInputSource)
       
       
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_RMD_OUTPUT,
             RSConnect.CONTENT_TYPE_DOCUMENT, true, null);
       toolbar.addRightWidget(publishButton_);
       

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -742,7 +742,7 @@ public void fireRSConnectPublishEvent(RSConnectPublishResult result,
                result.getSettings().getAsStatic(),
                launchBrowser, 
                RSConnectDeploymentRecord.create(result.getAppName(), 
-                     result.getAppTitle(), result.getAccount(), ""));
+                     result.getAppTitle(), result.getAppId(), result.getAccount(), ""));
 
          // we can't raise the main window if we aren't in desktop mode, so show
          // a dialog to guide the user there
@@ -762,7 +762,7 @@ public void fireRSConnectPublishEvent(RSConnectPublishResult result,
                result.getSettings(),
                launchBrowser,
                RSConnectDeploymentRecord.create(result.getAppName(), 
-                     result.getAppTitle(), result.getAccount(), "")));
+                     result.getAppTitle(), result.getAppId(), result.getAccount(), "")));
       }
    }
    
@@ -817,6 +817,7 @@ private void doDeployment(final RSConnectDeployInitiatedEvent event)
                              event.getRecord().getServer(),
                              event.getRecord().getName(), 
                              event.getRecord().getTitle(),
+                             event.getRecord().getAppId(),
                              event.getSettings(),
       new ServerRequestCallback<Boolean>()
       {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectServerOperations.java
Patch:
@@ -35,8 +35,8 @@ void connectRSConnectAccount(String command,
    void getRSConnectAppList(String accountName, String server,
                ServerRequestCallback<JsArray<RSConnectApplicationInfo>> requestCallback);
 
-   void getRSConnectApp(String appId, String accountName, String server,
-               ServerRequestCallback<RSConnectApplicationInfo> requestCallback);
+   void getRSConnectApp(String appId, String accountName, String server, String hostUrl,
+               ServerRequestCallback<RSConnectApplicationResult> requestCallback);
    
    void getRSConnectDeployments(String sourceFile, String outputFile,
                ServerRequestCallback<JsArray<RSConnectDeploymentRecord>> requestCallback); 
@@ -46,7 +46,7 @@ void getDeploymentFiles (String target,
                ServerRequestCallback<RSConnectDeploymentFiles> requestCallback);
    
    void publishContent(RSConnectPublishSource source, 
-               String account, String server, String appName, String appTitle,
+               String account, String server, String appName, String appTitle, String appId,
                RSConnectPublishSettings settings,
                ServerRequestCallback<Boolean> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeployDialog.java
Patch:
@@ -17,6 +17,7 @@
 import java.util.HashMap;
 import java.util.Map;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ThemedButton;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -49,6 +50,7 @@ public RSConnectDeployDialog(int contentType,
       setText("Publish to Server");
       setWidth("350px");
       deployButton_ = new ThemedButton("Publish");
+      ElementIds.assignElementId(deployButton_.getElement(), ElementIds.DEPLOY_CONTENT);
       addOkButton(deployButton_);
       addCancelButton();
       connect_ = connect;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectLocalAccount.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.rsconnect.ui;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.TextBoxWithCue;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.HelpLink;
@@ -41,6 +42,7 @@ public RSConnectLocalAccount()
       
       // apply the default server if one is registered
       Session session = RStudioGinjector.INSTANCE.getSession();
+      ElementIds.assignElementId(serverUrl_.getElement(), ElementIds.RSC_SERVER_URL);
       if (session != null && session.getSessionInfo() != null)
       {
          serverUrl_.setText(session.getSessionInfo().getDefaultRSConnectServer());

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -164,6 +164,7 @@ class ClientEvent extends JavaScriptObject
    public static final String SendToTerminal = "send_to_terminal";
    public static final String ClearTerminal = "clear_terminal";
    public static final String AddTerminal = "add_terminal";
+   public static final String RemoveTerminal = "remove_terminal";
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
    public static final String AdminNotification = "admin_notification";

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyApplicationPanel.java
Patch:
@@ -66,6 +66,7 @@ protected void initToolbar(Toolbar toolbar, Commands commands)
       toolbar.addLeftWidget(refreshButton);
       
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_SHINY_APP,
             RSConnect.CONTENT_TYPE_NONE, true, null);
       toolbar.addRightWidget(publishButton_);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -67,6 +67,7 @@
 import org.rstudio.studio.client.workbench.views.choosefile.ChooseFile;
 import org.rstudio.studio.client.workbench.views.files.events.DirectoryNavigateEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.profiler.ProfilerPresenter;
+import org.rstudio.studio.client.workbench.views.terminal.events.ActivateNamedTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.CreateTerminalEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshHandler;
@@ -398,7 +399,7 @@ public void onResponseReceived(TerminalOptions options)
       }
       else
       {
-         onNewTerminal();
+         eventBus_.fireEvent(new ActivateNamedTerminalEvent());
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -167,6 +167,8 @@
    public abstract AppCommand pasteLastYank();
    public abstract AppCommand insertAssignmentOperator();
    public abstract AppCommand insertPipeOperator();
+   public abstract AppCommand openNextFileOnFilesystem();
+   public abstract AppCommand openPreviousFileOnFilesystem();
  
    // Projects
    public abstract AppCommand newProject();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -375,7 +375,8 @@ public void onError(ServerError error)
                }
             }, caption);
          }
-      }, caption, "Terminal jobs will be terminated. Are you sure?");
+      }, caption, "Terminal jobs will be terminated. Are you sure?", 
+            uiPrefs_.terminalBusyMode().getValue());
    }
    
    void onStopBuild()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -62,7 +62,7 @@ public PlotsPane(Commands commands, PlotsServerOperations server,
    @Override
    protected Toolbar createMainToolbar()
    {
-      publishButton_ = new RSConnectPublishButton(
+      publishButton_ = new RSConnectPublishButton(RSConnectPublishButton.HOST_PLOTS,
             RSConnect.CONTENT_TYPE_PLOT, true, commands_.savePlotAsImage());
       publishButton_.setPublishHtmlSource(new PublishHtmlSource()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationPane.java
Patch:
@@ -106,6 +106,7 @@ protected Toolbar createMainToolbar()
 
          // Create the publish button and wire it to our HTML generator
          publishButton_ = new RSConnectPublishButton(
+               RSConnectPublishButton.HOST_PRESENTATION,
                RSConnect.CONTENT_TYPE_PRES, false, null);
          publishButton_.setPublishHtmlSource(new PublishHtmlSource()
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -54,6 +54,7 @@ public interface EditingTarget extends IsWidget,
    ImageResource getIcon();
    String getTabTooltip();
    
+   FileType getFileType();
    TextFileType getTextFileType();
 
    void adaptToExtendedFileType(String extendedType);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -154,6 +154,7 @@ private Toolbar createToolbar(Commands commands, PublishHtmlSource publishHtmlSo
       
       toolbar.addRightWidget(
             publishButton_ = new RSConnectPublishButton(
+                  RSConnectPublishButton.HOST_PROFILER,
                   RSConnect.CONTENT_TYPE_DOCUMENT, true, null));
       
       publishButton_.setPublishHtmlSource(publishHtmlSource);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -606,7 +606,7 @@ public void setOutputFormat(String yaml, final String format,
       // introduce unwanted mutations)
       YamlTree tree = new YamlTree(yaml);
       List<String> formats = getOutputFormats(tree);
-      if (formats.contains(format))
+      if (formats != null && formats.contains(format))
       {
          tree.reorder(Arrays.asList(format));
          onCompleted.execute(tree.toString());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.dom.IFrameElementEx;
 import org.rstudio.core.client.widget.RStudioFrame;
+import org.rstudio.core.client.widget.RStudioThemedFrame;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.PanelWithToolbars;
@@ -30,7 +31,7 @@ public UrlContentEditingTargetWidget(Commands commands, String url)
    {
       commands_ = commands;
 
-      frame_ = new RStudioFrame(url, true, "");
+      frame_ = new RStudioThemedFrame(url, true, "allow-same-origin", null, null, false);
       frame_.setSize("100%", "100%");
 
       PanelWithToolbars panel = new PanelWithToolbars(createToolbar(),
@@ -58,5 +59,5 @@ public Widget asWidget()
    }
 
    private final Commands commands_;
-   private RStudioFrame frame_;
+   private RStudioThemedFrame frame_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -109,7 +109,6 @@ public void execute()
          addSeparator();
          addItem(commands_.renameTerminal().createMenuItem(false));
          addItem(commands_.sendTerminalToEditor().createMenuItem(false));
-         addItem(commands_.showTerminalInfo().createMenuItem(false));
          addSeparator();
          addItem(commands_.previousTerminal().createMenuItem(false));
          addItem(commands_.nextTerminal().createMenuItem(false));
@@ -159,7 +158,6 @@ public void setActiveTerminal(String caption, String handle)
       commands_.closeTerminal().setEnabled(haveActiveTerminal);
       commands_.renameTerminal().setEnabled(haveActiveTerminal);
       commands_.clearTerminalScrollbackBuffer().setEnabled(haveActiveTerminal);
-      commands_.showTerminalInfo().setEnabled(haveActiveTerminal);
       commands_.interruptTerminal().setEnabled(haveActiveTerminal);
       commands_.previousTerminal().setEnabled(getPreviousTerminalHandle() != null);
       commands_.nextTerminal().setEnabled(getNextTerminalHandle() != null);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalShellInfo.java
Patch:
@@ -36,6 +36,7 @@ public class TerminalShellInfo extends JavaScriptObject
    
    public static final int SHELL_POSIX_BASH = 7;
    public static final int SHELL_CUSTOM = 8;
+   public static final int SHELL_NONE = 9;
 
    protected TerminalShellInfo() {}
 
@@ -69,6 +70,8 @@ public static String getShellName(int shell)
          return "Bash";
       case SHELL_CUSTOM:
          return "Custom";
+      case SHELL_NONE:
+         return "User command";
       default:
          return "Unknown";
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTab.java
Patch:
@@ -35,6 +35,7 @@
 import org.rstudio.studio.client.workbench.views.terminal.events.AddTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.ClearTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.CreateTerminalEvent;
+import org.rstudio.studio.client.workbench.views.terminal.events.RemoveTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.SendToTerminalEvent;
 
 import com.google.gwt.core.client.JsArray;
@@ -54,6 +55,7 @@ public abstract static class Shim
                  SendToTerminalEvent.Handler,
                  ClearTerminalEvent.Handler,
                  AddTerminalEvent.Handler,
+                 RemoveTerminalEvent.Handler,
                  ActivateNamedTerminalEvent.Handler
    {
       @Handler
@@ -109,6 +111,7 @@ public TerminalTab(Shim shim,
       events.addHandler(SendToTerminalEvent.TYPE, shim_);
       events.addHandler(ClearTerminalEvent.TYPE, shim_);
       events.addHandler(AddTerminalEvent.TYPE, shim_);
+      events.addHandler(RemoveTerminalEvent.TYPE, shim_);
       events.addHandler(ActivateNamedTerminalEvent.TYPE, shim_);
 
       events.addHandler(SessionInitEvent.TYPE, new SessionInitHandler()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -93,6 +93,7 @@ protected Toolbar createMainToolbar()
      
       // add publish button 
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_VIEWER,
             RSConnect.CONTENT_TYPE_DOCUMENT, true, null);
       toolbar_.addRightWidget(publishButton_);
       

File: src/gwt/src/org/rstudio/core/client/command/AppMenuBar.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.gwt.user.client.ui.MenuBar;
 import com.google.gwt.user.client.ui.MenuItem;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.dom.DomUtils;
 
 import java.util.List;
@@ -64,7 +65,8 @@ public MenuItem addItem(String text, boolean asHTML, MenuBar popup)
          if (vertical_)
             text = AppCommand.formatMenuLabel(null, text, null);
          else
-            text = DomUtils.textToHtml(text);
+            text = "<span id=\"" + ElementIds.idFromLabel(text) + "_menu" + "\">" +
+                   DomUtils.textToHtml(text) + "</span>";
       }
 
       return super.addItem(text,

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -489,8 +489,9 @@ else if (binding.getId() == "closeSourceDoc")
                   // the word behind the cursor; so we'll ignore this command 
                   // when focus is in the terminal and let terminal see keys
                   return false;
-               } 
-               if (binding.getContext() != AppCommand.Context.Workbench &&
+               }
+               if (binding.getId() != "executeCode" &&
+                     binding.getContext() != AppCommand.Context.Workbench &&
                      binding.getContext() != AppCommand.Context.Addin &&
                      binding.getContext() != AppCommand.Context.PackageDevelopment)
                {

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogBase.java
Patch:
@@ -24,6 +24,8 @@
 import com.google.gwt.user.client.ui.DockLayoutPanel;
 import com.google.gwt.user.client.ui.FlowPanel;
 import com.google.gwt.user.client.ui.Widget;
+
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.events.EnsureVisibleEvent;
 import org.rstudio.core.client.events.EnsureVisibleHandler;
 import org.rstudio.core.client.widget.ModalDialogBase;
@@ -61,6 +63,7 @@ public void execute()
             });        
          }
       });
+      ElementIds.assignElementId(okButton.getElement(), ElementIds.PREFERENCES_CONFIRM);
       addOkButton(okButton);
       addCancelButton();
       

File: src/gwt/src/org/rstudio/core/client/prefs/SectionChooser.java
Patch:
@@ -14,6 +14,8 @@
  */
 package org.rstudio.core.client.prefs;
 
+import org.rstudio.core.client.ElementIds;
+
 import com.google.gwt.event.dom.client.ClickEvent;
 import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.dom.client.HasClickHandlers;
@@ -65,6 +67,7 @@ public void addSection(ImageResource icon, String name)
       innerPanel.add(nudgeRightPlus(label));
       panel.add(innerPanel);
       panel.setStyleName(res_.styles().section());
+      panel.getElement().setId(ElementIds.idFromLabel(name) + "_options");
 
       panel.addClickHandler(new ClickHandler()
       {

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -72,6 +72,7 @@ public interface ThemeStyles extends CssResource
    String toolbarButtonPushed();
    String emptyProjectMenu();
    String menuSubheader();
+   String menuItemSubtitle();
 
    String menuRightImage();
    

File: src/gwt/src/org/rstudio/core/client/widget/ProgressPanel.java
Patch:
@@ -81,7 +81,7 @@ public void endProgressOperation()
    {
       clearTimer();
       progressImage_.setVisible(false);
-      progressSpinner_.setVisible(true);
+      progressSpinner_.setVisible(false);
    }
 
    private int getSpinnerColor()

File: src/gwt/src/org/rstudio/core/client/widget/ProgressSpinner.java
Patch:
@@ -78,7 +78,7 @@ public ProgressSpinner(int color)
          public boolean execute()
          {
             frame_++;
-            redraw();
+            if (isVisible()) redraw();
             return !complete_;
          }
       }, FRAME_RATE_MS);

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -17,6 +17,7 @@
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.user.client.ui.*;
 import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 
 public class TextEntryModalDialog extends ModalDialog<String>
 {
@@ -42,6 +43,7 @@ public TextEntryModalDialog(String title,
                  numbersOnly ? new NumericTextBox() :
                  new TextBox();
       textBox_.setWidth("100%");
+      DomUtils.disableAutoBehavior(textBox_);
       captionLabel_ = new Label(caption);
 
       extraOption_ = new CheckBox(StringUtil.notNull(extraOptionPrompt));

File: src/gwt/src/org/rstudio/core/client/widget/Wizard.java
Patch:
@@ -19,6 +19,7 @@
 
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Debug;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
 
@@ -116,6 +117,7 @@ public void execute(Boolean valid)
          }
       });
       nextButton_.setVisible(false);
+      nextButton_.getElement().setId(ElementIds.idFromLabel(caption) + "_wizard_next");
       addActionButton(nextButton_);
    }
 
@@ -518,6 +520,7 @@ protected ArrayList<String> getWizardBodyStyles()
    private void resetOkButtonCaption()
    {
       setOkButtonCaption(okCaption_);
+      setOkButtonId(ElementIds.idFromLabel(okCaption_) + "_wizard_confirm");
    }
  
    private boolean pageIsFinal(WizardPage<I, T> page)

File: src/gwt/src/org/rstudio/core/client/widget/WizardPageSelector.java
Patch:
@@ -17,6 +17,7 @@
 import java.util.ArrayList;
 
 import org.rstudio.core.client.CommandWithArg;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 
 import com.google.gwt.dom.client.Style.Unit;
@@ -88,6 +89,8 @@ private class PageSelectorItem extends Composite
          
          LayoutPanel layoutPanel = new LayoutPanel();
          layoutPanel.addStyleName(styles.wizardPageSelectorItem());
+         layoutPanel.getElement().setId(
+               ElementIds.idFromLabel(pageInfo.getTitle() + "_wizard_page"));
          
          ImageResource pageImageResource = pageInfo.getImage();
          Image image = null;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -112,6 +112,7 @@
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.prefs.model.PrefsServerOperations;
 import org.rstudio.studio.client.workbench.snippets.SnippetServerOperations;
+import org.rstudio.studio.client.workbench.ui.PaneManager;
 import org.rstudio.studio.client.workbench.ui.WorkbenchScreen;
 import org.rstudio.studio.client.workbench.ui.WorkbenchTab;
 import org.rstudio.studio.client.workbench.views.buildtools.BuildPresenter;
@@ -243,6 +244,7 @@ protected void configure()
       bind(ProfilerPresenter.class).in(Singleton.class);
       bind(ObjectExplorerPresenter.class).asEagerSingleton();
       bind(WorkbenchContext.class).asEagerSingleton();
+      bind(PaneManager.class).in(Singleton.class);
       bind(DependencyManager.class).asEagerSingleton();
       bind(WorkbenchListManager.class).asEagerSingleton();
       bind(ApplicationQuit.class).asEagerSingleton();

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ObjectExplorerFileType.java
Patch:
@@ -22,7 +22,7 @@ public class ObjectExplorerFileType extends EditableFileType
 {
    public ObjectExplorerFileType()
    {
-      super("object_explorer",
+      super(ID,
             "Object Explorer",
             new ImageResource2x(FileIconResources.INSTANCE.iconObjectExplorer2x()));
    }
@@ -33,4 +33,6 @@ protected void openFile(FileSystemItem file, EventBus eventBus)
       assert false :
          "Object explorer doesn't operate on filesystem files";
    }
+   
+   public static final String ID = "object_explorer";
 }

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -52,6 +52,8 @@ public class EditorLanguage
          "mode/c_cpp", true);
    public static final EditorLanguage LANG_STAN = new EditorLanguage(
          "mode/stan", false, true);
+   public static final EditorLanguage LANG_YAML = new EditorLanguage(
+         "mode/yaml", false, true);
    
    // Modes borrowed from Ace
    public static final EditorLanguage LANG_PLAIN = new EditorLanguage(
@@ -70,8 +72,6 @@ public class EditorLanguage
          "ace/mode/sh", false, false);
    public static final EditorLanguage LANG_TOML = new EditorLanguage(
          "ace/mode/toml", false, true);
-   public static final EditorLanguage LANG_YAML = new EditorLanguage(
-         "ace/mode/yaml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(
          "ace/mode/xml", false, false);
    

File: src/gwt/src/org/rstudio/studio/client/common/viewfile/ViewFilePanel.java
Patch:
@@ -97,7 +97,8 @@ public ViewFilePanel(GlobalDisplay globalDisplay,
       docDisplay_.setReadOnly(true);
       
       TextEditingTarget.registerPrefs(releaseOnDismiss_, 
-            uiPrefs, 
+            uiPrefs,
+            null,
             docDisplay_,
             new TextEditingTarget.PrefsContext()
             {

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -109,6 +109,7 @@ private Toolbar createToolbar(Commands commands)
       publishButtonSeparator_ = toolbar.addLeftSeparator();
       toolbar.addLeftWidget(
                publishButton_ = new RSConnectPublishButton(
+                     RSConnectPublishButton.HOST_HTML_PREVIEW,
                      RSConnect.CONTENT_TYPE_DOCUMENT, true, null));
       
       findTextBox_ = new FindTextBox("Find");

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdEditorOptions.java
Patch:
@@ -58,8 +58,6 @@ public static String set(String yaml, String option, String value)
    
    private static String EDITOR_OPTION_KEY = "editor_options";
    
-   public static String PUBLISH_OUTPUT    = "publish_output";
-
    public static String PREVIEW_IN        = "preview";
    public static String PREVIEW_IN_WINDOW = "window";
    public static String PREVIEW_IN_VIEWER = "viewer";

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -215,6 +215,7 @@ private void findInTopic(String term, CanFocus findInputSource)
       
       
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_RMD_OUTPUT,
             RSConnect.CONTENT_TYPE_DOCUMENT, true, null);
       toolbar.addRightWidget(publishButton_);
       

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -742,7 +742,7 @@ public void fireRSConnectPublishEvent(RSConnectPublishResult result,
                result.getSettings().getAsStatic(),
                launchBrowser, 
                RSConnectDeploymentRecord.create(result.getAppName(), 
-                     result.getAppTitle(), result.getAccount(), ""));
+                     result.getAppTitle(), result.getAppId(), result.getAccount(), ""));
 
          // we can't raise the main window if we aren't in desktop mode, so show
          // a dialog to guide the user there
@@ -762,7 +762,7 @@ public void fireRSConnectPublishEvent(RSConnectPublishResult result,
                result.getSettings(),
                launchBrowser,
                RSConnectDeploymentRecord.create(result.getAppName(), 
-                     result.getAppTitle(), result.getAccount(), "")));
+                     result.getAppTitle(), result.getAppId(), result.getAccount(), "")));
       }
    }
    
@@ -817,6 +817,7 @@ private void doDeployment(final RSConnectDeployInitiatedEvent event)
                              event.getRecord().getServer(),
                              event.getRecord().getName(), 
                              event.getRecord().getTitle(),
+                             event.getRecord().getAppId(),
                              event.getSettings(),
       new ServerRequestCallback<Boolean>()
       {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectServerOperations.java
Patch:
@@ -35,8 +35,8 @@ void connectRSConnectAccount(String command,
    void getRSConnectAppList(String accountName, String server,
                ServerRequestCallback<JsArray<RSConnectApplicationInfo>> requestCallback);
 
-   void getRSConnectApp(String appId, String accountName, String server,
-               ServerRequestCallback<RSConnectApplicationInfo> requestCallback);
+   void getRSConnectApp(String appId, String accountName, String server, String hostUrl,
+               ServerRequestCallback<RSConnectApplicationResult> requestCallback);
    
    void getRSConnectDeployments(String sourceFile, String outputFile,
                ServerRequestCallback<JsArray<RSConnectDeploymentRecord>> requestCallback); 
@@ -46,7 +46,7 @@ void getDeploymentFiles (String target,
                ServerRequestCallback<RSConnectDeploymentFiles> requestCallback);
    
    void publishContent(RSConnectPublishSource source, 
-               String account, String server, String appName, String appTitle,
+               String account, String server, String appName, String appTitle, String appId,
                RSConnectPublishSettings settings,
                ServerRequestCallback<Boolean> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeployDialog.java
Patch:
@@ -17,6 +17,7 @@
 import java.util.HashMap;
 import java.util.Map;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ThemedButton;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -49,6 +50,7 @@ public RSConnectDeployDialog(int contentType,
       setText("Publish to Server");
       setWidth("350px");
       deployButton_ = new ThemedButton("Publish");
+      ElementIds.assignElementId(deployButton_.getElement(), ElementIds.DEPLOY_CONTENT);
       addOkButton(deployButton_);
       addCancelButton();
       connect_ = connect;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectLocalAccount.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.rsconnect.ui;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.TextBoxWithCue;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.HelpLink;
@@ -41,6 +42,7 @@ public RSConnectLocalAccount()
       
       // apply the default server if one is registered
       Session session = RStudioGinjector.INSTANCE.getSession();
+      ElementIds.assignElementId(serverUrl_.getElement(), ElementIds.RSC_SERVER_URL);
       if (session != null && session.getSessionInfo() != null)
       {
          serverUrl_.setText(session.getSessionInfo().getDefaultRSConnectServer());

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -164,6 +164,7 @@ class ClientEvent extends JavaScriptObject
    public static final String SendToTerminal = "send_to_terminal";
    public static final String ClearTerminal = "clear_terminal";
    public static final String AddTerminal = "add_terminal";
+   public static final String RemoveTerminal = "remove_terminal";
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
    public static final String AdminNotification = "admin_notification";

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyApplicationPanel.java
Patch:
@@ -66,6 +66,7 @@ protected void initToolbar(Toolbar toolbar, Commands commands)
       toolbar.addLeftWidget(refreshButton);
       
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_SHINY_APP,
             RSConnect.CONTENT_TYPE_NONE, true, null);
       toolbar.addRightWidget(publishButton_);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -67,6 +67,7 @@
 import org.rstudio.studio.client.workbench.views.choosefile.ChooseFile;
 import org.rstudio.studio.client.workbench.views.files.events.DirectoryNavigateEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.profiler.ProfilerPresenter;
+import org.rstudio.studio.client.workbench.views.terminal.events.ActivateNamedTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.CreateTerminalEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshHandler;
@@ -398,7 +399,7 @@ public void onResponseReceived(TerminalOptions options)
       }
       else
       {
-         onNewTerminal();
+         eventBus_.fireEvent(new ActivateNamedTerminalEvent());
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -167,6 +167,8 @@
    public abstract AppCommand pasteLastYank();
    public abstract AppCommand insertAssignmentOperator();
    public abstract AppCommand insertPipeOperator();
+   public abstract AppCommand openNextFileOnFilesystem();
+   public abstract AppCommand openPreviousFileOnFilesystem();
  
    // Projects
    public abstract AppCommand newProject();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -375,7 +375,8 @@ public void onError(ServerError error)
                }
             }, caption);
          }
-      }, caption, "Terminal jobs will be terminated. Are you sure?");
+      }, caption, "Terminal jobs will be terminated. Are you sure?", 
+            uiPrefs_.terminalBusyMode().getValue());
    }
    
    void onStopBuild()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -62,7 +62,7 @@ public PlotsPane(Commands commands, PlotsServerOperations server,
    @Override
    protected Toolbar createMainToolbar()
    {
-      publishButton_ = new RSConnectPublishButton(
+      publishButton_ = new RSConnectPublishButton(RSConnectPublishButton.HOST_PLOTS,
             RSConnect.CONTENT_TYPE_PLOT, true, commands_.savePlotAsImage());
       publishButton_.setPublishHtmlSource(new PublishHtmlSource()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationPane.java
Patch:
@@ -106,6 +106,7 @@ protected Toolbar createMainToolbar()
 
          // Create the publish button and wire it to our HTML generator
          publishButton_ = new RSConnectPublishButton(
+               RSConnectPublishButton.HOST_PRESENTATION,
                RSConnect.CONTENT_TYPE_PRES, false, null);
          publishButton_.setPublishHtmlSource(new PublishHtmlSource()
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -54,6 +54,7 @@ public interface EditingTarget extends IsWidget,
    ImageResource getIcon();
    String getTabTooltip();
    
+   FileType getFileType();
    TextFileType getTextFileType();
 
    void adaptToExtendedFileType(String extendedType);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -154,6 +154,7 @@ private Toolbar createToolbar(Commands commands, PublishHtmlSource publishHtmlSo
       
       toolbar.addRightWidget(
             publishButton_ = new RSConnectPublishButton(
+                  RSConnectPublishButton.HOST_PROFILER,
                   RSConnect.CONTENT_TYPE_DOCUMENT, true, null));
       
       publishButton_.setPublishHtmlSource(publishHtmlSource);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -606,7 +606,7 @@ public void setOutputFormat(String yaml, final String format,
       // introduce unwanted mutations)
       YamlTree tree = new YamlTree(yaml);
       List<String> formats = getOutputFormats(tree);
-      if (formats.contains(format))
+      if (formats != null && formats.contains(format))
       {
          tree.reorder(Arrays.asList(format));
          onCompleted.execute(tree.toString());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.dom.IFrameElementEx;
 import org.rstudio.core.client.widget.RStudioFrame;
+import org.rstudio.core.client.widget.RStudioThemedFrame;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.PanelWithToolbars;
@@ -30,7 +31,7 @@ public UrlContentEditingTargetWidget(Commands commands, String url)
    {
       commands_ = commands;
 
-      frame_ = new RStudioFrame(url, true, "");
+      frame_ = new RStudioThemedFrame(url, true, "allow-same-origin", null, null, false);
       frame_.setSize("100%", "100%");
 
       PanelWithToolbars panel = new PanelWithToolbars(createToolbar(),
@@ -58,5 +59,5 @@ public Widget asWidget()
    }
 
    private final Commands commands_;
-   private RStudioFrame frame_;
+   private RStudioThemedFrame frame_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -109,7 +109,6 @@ public void execute()
          addSeparator();
          addItem(commands_.renameTerminal().createMenuItem(false));
          addItem(commands_.sendTerminalToEditor().createMenuItem(false));
-         addItem(commands_.showTerminalInfo().createMenuItem(false));
          addSeparator();
          addItem(commands_.previousTerminal().createMenuItem(false));
          addItem(commands_.nextTerminal().createMenuItem(false));
@@ -159,7 +158,6 @@ public void setActiveTerminal(String caption, String handle)
       commands_.closeTerminal().setEnabled(haveActiveTerminal);
       commands_.renameTerminal().setEnabled(haveActiveTerminal);
       commands_.clearTerminalScrollbackBuffer().setEnabled(haveActiveTerminal);
-      commands_.showTerminalInfo().setEnabled(haveActiveTerminal);
       commands_.interruptTerminal().setEnabled(haveActiveTerminal);
       commands_.previousTerminal().setEnabled(getPreviousTerminalHandle() != null);
       commands_.nextTerminal().setEnabled(getNextTerminalHandle() != null);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalShellInfo.java
Patch:
@@ -36,6 +36,7 @@ public class TerminalShellInfo extends JavaScriptObject
    
    public static final int SHELL_POSIX_BASH = 7;
    public static final int SHELL_CUSTOM = 8;
+   public static final int SHELL_NONE = 9;
 
    protected TerminalShellInfo() {}
 
@@ -69,6 +70,8 @@ public static String getShellName(int shell)
          return "Bash";
       case SHELL_CUSTOM:
          return "Custom";
+      case SHELL_NONE:
+         return "User command";
       default:
          return "Unknown";
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTab.java
Patch:
@@ -35,6 +35,7 @@
 import org.rstudio.studio.client.workbench.views.terminal.events.AddTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.ClearTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.CreateTerminalEvent;
+import org.rstudio.studio.client.workbench.views.terminal.events.RemoveTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.SendToTerminalEvent;
 
 import com.google.gwt.core.client.JsArray;
@@ -54,6 +55,7 @@ public abstract static class Shim
                  SendToTerminalEvent.Handler,
                  ClearTerminalEvent.Handler,
                  AddTerminalEvent.Handler,
+                 RemoveTerminalEvent.Handler,
                  ActivateNamedTerminalEvent.Handler
    {
       @Handler
@@ -109,6 +111,7 @@ public TerminalTab(Shim shim,
       events.addHandler(SendToTerminalEvent.TYPE, shim_);
       events.addHandler(ClearTerminalEvent.TYPE, shim_);
       events.addHandler(AddTerminalEvent.TYPE, shim_);
+      events.addHandler(RemoveTerminalEvent.TYPE, shim_);
       events.addHandler(ActivateNamedTerminalEvent.TYPE, shim_);
 
       events.addHandler(SessionInitEvent.TYPE, new SessionInitHandler()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -93,6 +93,7 @@ protected Toolbar createMainToolbar()
      
       // add publish button 
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_VIEWER,
             RSConnect.CONTENT_TYPE_DOCUMENT, true, null);
       toolbar_.addRightWidget(publishButton_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -224,6 +224,7 @@ public void onError(ServerError error)
    public void disconnect(boolean permanent)
    {
       inputQueue_.setLength(0);
+      inputSequence_ = ShellInput.IGNORE_SEQUENCE;
       socket_.disconnect(permanent);
       registrations_.removeHandler();
       consoleProcess_ = null;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ObjectExplorerFileType.java
Patch:
@@ -22,7 +22,7 @@ public class ObjectExplorerFileType extends EditableFileType
 {
    public ObjectExplorerFileType()
    {
-      super("object_explorer",
+      super(ID,
             "Object Explorer",
             new ImageResource2x(FileIconResources.INSTANCE.iconObjectExplorer2x()));
    }
@@ -33,4 +33,6 @@ protected void openFile(FileSystemItem file, EventBus eventBus)
       assert false :
          "Object explorer doesn't operate on filesystem files";
    }
+   
+   public static final String ID = "object_explorer";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -167,6 +167,8 @@
    public abstract AppCommand pasteLastYank();
    public abstract AppCommand insertAssignmentOperator();
    public abstract AppCommand insertPipeOperator();
+   public abstract AppCommand openNextFileOnFilesystem();
+   public abstract AppCommand openPreviousFileOnFilesystem();
  
    // Projects
    public abstract AppCommand newProject();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -54,6 +54,7 @@ public interface EditingTarget extends IsWidget,
    ImageResource getIcon();
    String getTabTooltip();
    
+   FileType getFileType();
    TextFileType getTextFileType();
 
    void adaptToExtendedFileType(String extendedType);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -224,6 +224,7 @@ public void onError(ServerError error)
    public void disconnect(boolean permanent)
    {
       inputQueue_.setLength(0);
+      inputSequence_ = ShellInput.IGNORE_SEQUENCE;
       socket_.disconnect(permanent);
       registrations_.removeHandler();
       consoleProcess_ = null;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ObjectExplorerFileType.java
Patch:
@@ -22,7 +22,7 @@ public class ObjectExplorerFileType extends EditableFileType
 {
    public ObjectExplorerFileType()
    {
-      super("object_explorer",
+      super(ID,
             "Object Explorer",
             new ImageResource2x(FileIconResources.INSTANCE.iconObjectExplorer2x()));
    }
@@ -33,4 +33,6 @@ protected void openFile(FileSystemItem file, EventBus eventBus)
       assert false :
          "Object explorer doesn't operate on filesystem files";
    }
+   
+   public static final String ID = "object_explorer";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -54,6 +54,7 @@ public interface EditingTarget extends IsWidget,
    ImageResource getIcon();
    String getTabTooltip();
    
+   FileType getFileType();
    TextFileType getTextFileType();
 
    void adaptToExtendedFileType(String extendedType);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.core.client.ResultCallback;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.studio.client.RStudioGinjector;
+import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.SessionSerializationEvent;
 import org.rstudio.studio.client.application.events.SessionSerializationHandler;
@@ -323,10 +324,10 @@ private void sendUserInput()
          inputQueue_.setLength(0);
       }
 
-      // On Windows, rapid typing sometimes causes RPC messages for writeStandardInput
+      // On desktop, rapid typing sometimes causes RPC messages for writeStandardInput
       // to arrive out of sequence in the terminal; send a sequence number with each
       // message so server can put messages back in order
-      if (BrowseCap.isWindowsDesktop() && 
+      if (Desktop.isDesktop() && 
             consoleProcess_.getChannelMode() == ConsoleProcessInfo.CHANNEL_RPC)
       {
          if (inputSequence_ == ShellInput.IGNORE_SEQUENCE)

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -67,6 +67,7 @@
 import org.rstudio.studio.client.workbench.views.choosefile.ChooseFile;
 import org.rstudio.studio.client.workbench.views.files.events.DirectoryNavigateEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.profiler.ProfilerPresenter;
+import org.rstudio.studio.client.workbench.views.terminal.events.ActivateNamedTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.CreateTerminalEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshHandler;
@@ -398,7 +399,7 @@ public void onResponseReceived(TerminalOptions options)
       }
       else
       {
-         onNewTerminal();
+         eventBus_.fireEvent(new ActivateNamedTerminalEvent());
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -67,6 +67,7 @@
 import org.rstudio.studio.client.workbench.views.choosefile.ChooseFile;
 import org.rstudio.studio.client.workbench.views.files.events.DirectoryNavigateEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.profiler.ProfilerPresenter;
+import org.rstudio.studio.client.workbench.views.terminal.events.ActivateNamedTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.CreateTerminalEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshHandler;
@@ -398,7 +399,7 @@ public void onResponseReceived(TerminalOptions options)
       }
       else
       {
-         onNewTerminal();
+         eventBus_.fireEvent(new ActivateNamedTerminalEvent());
       }
    }
    

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -489,8 +489,9 @@ else if (binding.getId() == "closeSourceDoc")
                   // the word behind the cursor; so we'll ignore this command 
                   // when focus is in the terminal and let terminal see keys
                   return false;
-               } 
-               if (binding.getContext() != AppCommand.Context.Workbench &&
+               }
+               if (binding.getId() != "executeCode" &&
+                     binding.getContext() != AppCommand.Context.Workbench &&
                      binding.getContext() != AppCommand.Context.Addin &&
                      binding.getContext() != AppCommand.Context.PackageDevelopment)
                {

File: src/gwt/src/org/rstudio/core/client/command/AppMenuBar.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.gwt.user.client.ui.MenuBar;
 import com.google.gwt.user.client.ui.MenuItem;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.dom.DomUtils;
 
 import java.util.List;
@@ -64,7 +65,8 @@ public MenuItem addItem(String text, boolean asHTML, MenuBar popup)
          if (vertical_)
             text = AppCommand.formatMenuLabel(null, text, null);
          else
-            text = DomUtils.textToHtml(text);
+            text = "<span id=\"" + ElementIds.idFromLabel(text) + "_menu" + "\">" +
+                   DomUtils.textToHtml(text) + "</span>";
       }
 
       return super.addItem(text,

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogBase.java
Patch:
@@ -24,6 +24,8 @@
 import com.google.gwt.user.client.ui.DockLayoutPanel;
 import com.google.gwt.user.client.ui.FlowPanel;
 import com.google.gwt.user.client.ui.Widget;
+
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.events.EnsureVisibleEvent;
 import org.rstudio.core.client.events.EnsureVisibleHandler;
 import org.rstudio.core.client.widget.ModalDialogBase;
@@ -61,6 +63,7 @@ public void execute()
             });        
          }
       });
+      ElementIds.assignElementId(okButton.getElement(), ElementIds.PREFERENCES_CONFIRM);
       addOkButton(okButton);
       addCancelButton();
       

File: src/gwt/src/org/rstudio/core/client/prefs/SectionChooser.java
Patch:
@@ -14,6 +14,8 @@
  */
 package org.rstudio.core.client.prefs;
 
+import org.rstudio.core.client.ElementIds;
+
 import com.google.gwt.event.dom.client.ClickEvent;
 import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.dom.client.HasClickHandlers;
@@ -65,6 +67,7 @@ public void addSection(ImageResource icon, String name)
       innerPanel.add(nudgeRightPlus(label));
       panel.add(innerPanel);
       panel.setStyleName(res_.styles().section());
+      panel.getElement().setId(ElementIds.idFromLabel(name) + "_options");
 
       panel.addClickHandler(new ClickHandler()
       {

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -72,6 +72,7 @@ public interface ThemeStyles extends CssResource
    String toolbarButtonPushed();
    String emptyProjectMenu();
    String menuSubheader();
+   String menuItemSubtitle();
 
    String menuRightImage();
    

File: src/gwt/src/org/rstudio/core/client/widget/ProgressPanel.java
Patch:
@@ -81,7 +81,7 @@ public void endProgressOperation()
    {
       clearTimer();
       progressImage_.setVisible(false);
-      progressSpinner_.setVisible(true);
+      progressSpinner_.setVisible(false);
    }
 
    private int getSpinnerColor()

File: src/gwt/src/org/rstudio/core/client/widget/ProgressSpinner.java
Patch:
@@ -78,7 +78,7 @@ public ProgressSpinner(int color)
          public boolean execute()
          {
             frame_++;
-            redraw();
+            if (isVisible()) redraw();
             return !complete_;
          }
       }, FRAME_RATE_MS);

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -17,6 +17,7 @@
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.user.client.ui.*;
 import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 
 public class TextEntryModalDialog extends ModalDialog<String>
 {
@@ -42,6 +43,7 @@ public TextEntryModalDialog(String title,
                  numbersOnly ? new NumericTextBox() :
                  new TextBox();
       textBox_.setWidth("100%");
+      DomUtils.disableAutoBehavior(textBox_);
       captionLabel_ = new Label(caption);
 
       extraOption_ = new CheckBox(StringUtil.notNull(extraOptionPrompt));

File: src/gwt/src/org/rstudio/core/client/widget/Wizard.java
Patch:
@@ -19,6 +19,7 @@
 
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Debug;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
 
@@ -116,6 +117,7 @@ public void execute(Boolean valid)
          }
       });
       nextButton_.setVisible(false);
+      nextButton_.getElement().setId(ElementIds.idFromLabel(caption) + "_wizard_next");
       addActionButton(nextButton_);
    }
 
@@ -518,6 +520,7 @@ protected ArrayList<String> getWizardBodyStyles()
    private void resetOkButtonCaption()
    {
       setOkButtonCaption(okCaption_);
+      setOkButtonId(ElementIds.idFromLabel(okCaption_) + "_wizard_confirm");
    }
  
    private boolean pageIsFinal(WizardPage<I, T> page)

File: src/gwt/src/org/rstudio/core/client/widget/WizardPageSelector.java
Patch:
@@ -17,6 +17,7 @@
 import java.util.ArrayList;
 
 import org.rstudio.core.client.CommandWithArg;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 
 import com.google.gwt.dom.client.Style.Unit;
@@ -88,6 +89,8 @@ private class PageSelectorItem extends Composite
          
          LayoutPanel layoutPanel = new LayoutPanel();
          layoutPanel.addStyleName(styles.wizardPageSelectorItem());
+         layoutPanel.getElement().setId(
+               ElementIds.idFromLabel(pageInfo.getTitle() + "_wizard_page"));
          
          ImageResource pageImageResource = pageInfo.getImage();
          Image image = null;

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -52,6 +52,8 @@ public class EditorLanguage
          "mode/c_cpp", true);
    public static final EditorLanguage LANG_STAN = new EditorLanguage(
          "mode/stan", false, true);
+   public static final EditorLanguage LANG_YAML = new EditorLanguage(
+         "mode/yaml", false, true);
    
    // Modes borrowed from Ace
    public static final EditorLanguage LANG_PLAIN = new EditorLanguage(
@@ -70,8 +72,6 @@ public class EditorLanguage
          "ace/mode/sh", false, false);
    public static final EditorLanguage LANG_TOML = new EditorLanguage(
          "ace/mode/toml", false, true);
-   public static final EditorLanguage LANG_YAML = new EditorLanguage(
-         "ace/mode/yaml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(
          "ace/mode/xml", false, false);
    

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -109,6 +109,7 @@ private Toolbar createToolbar(Commands commands)
       publishButtonSeparator_ = toolbar.addLeftSeparator();
       toolbar.addLeftWidget(
                publishButton_ = new RSConnectPublishButton(
+                     RSConnectPublishButton.HOST_HTML_PREVIEW,
                      RSConnect.CONTENT_TYPE_DOCUMENT, true, null));
       
       findTextBox_ = new FindTextBox("Find");

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdEditorOptions.java
Patch:
@@ -58,8 +58,6 @@ public static String set(String yaml, String option, String value)
    
    private static String EDITOR_OPTION_KEY = "editor_options";
    
-   public static String PUBLISH_OUTPUT    = "publish_output";
-
    public static String PREVIEW_IN        = "preview";
    public static String PREVIEW_IN_WINDOW = "window";
    public static String PREVIEW_IN_VIEWER = "viewer";

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -215,6 +215,7 @@ private void findInTopic(String term, CanFocus findInputSource)
       
       
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_RMD_OUTPUT,
             RSConnect.CONTENT_TYPE_DOCUMENT, true, null);
       toolbar.addRightWidget(publishButton_);
       

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -742,7 +742,7 @@ public void fireRSConnectPublishEvent(RSConnectPublishResult result,
                result.getSettings().getAsStatic(),
                launchBrowser, 
                RSConnectDeploymentRecord.create(result.getAppName(), 
-                     result.getAppTitle(), result.getAccount(), ""));
+                     result.getAppTitle(), result.getAppId(), result.getAccount(), ""));
 
          // we can't raise the main window if we aren't in desktop mode, so show
          // a dialog to guide the user there
@@ -762,7 +762,7 @@ public void fireRSConnectPublishEvent(RSConnectPublishResult result,
                result.getSettings(),
                launchBrowser,
                RSConnectDeploymentRecord.create(result.getAppName(), 
-                     result.getAppTitle(), result.getAccount(), "")));
+                     result.getAppTitle(), result.getAppId(), result.getAccount(), "")));
       }
    }
    
@@ -817,6 +817,7 @@ private void doDeployment(final RSConnectDeployInitiatedEvent event)
                              event.getRecord().getServer(),
                              event.getRecord().getName(), 
                              event.getRecord().getTitle(),
+                             event.getRecord().getAppId(),
                              event.getSettings(),
       new ServerRequestCallback<Boolean>()
       {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectServerOperations.java
Patch:
@@ -35,8 +35,8 @@ void connectRSConnectAccount(String command,
    void getRSConnectAppList(String accountName, String server,
                ServerRequestCallback<JsArray<RSConnectApplicationInfo>> requestCallback);
 
-   void getRSConnectApp(String appId, String accountName, String server,
-               ServerRequestCallback<RSConnectApplicationInfo> requestCallback);
+   void getRSConnectApp(String appId, String accountName, String server, String hostUrl,
+               ServerRequestCallback<RSConnectApplicationResult> requestCallback);
    
    void getRSConnectDeployments(String sourceFile, String outputFile,
                ServerRequestCallback<JsArray<RSConnectDeploymentRecord>> requestCallback); 
@@ -46,7 +46,7 @@ void getDeploymentFiles (String target,
                ServerRequestCallback<RSConnectDeploymentFiles> requestCallback);
    
    void publishContent(RSConnectPublishSource source, 
-               String account, String server, String appName, String appTitle,
+               String account, String server, String appName, String appTitle, String appId,
                RSConnectPublishSettings settings,
                ServerRequestCallback<Boolean> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeployDialog.java
Patch:
@@ -17,6 +17,7 @@
 import java.util.HashMap;
 import java.util.Map;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ThemedButton;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -49,6 +50,7 @@ public RSConnectDeployDialog(int contentType,
       setText("Publish to Server");
       setWidth("350px");
       deployButton_ = new ThemedButton("Publish");
+      ElementIds.assignElementId(deployButton_.getElement(), ElementIds.DEPLOY_CONTENT);
       addOkButton(deployButton_);
       addCancelButton();
       connect_ = connect;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectLocalAccount.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.rsconnect.ui;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.TextBoxWithCue;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.HelpLink;
@@ -41,6 +42,7 @@ public RSConnectLocalAccount()
       
       // apply the default server if one is registered
       Session session = RStudioGinjector.INSTANCE.getSession();
+      ElementIds.assignElementId(serverUrl_.getElement(), ElementIds.RSC_SERVER_URL);
       if (session != null && session.getSessionInfo() != null)
       {
          serverUrl_.setText(session.getSessionInfo().getDefaultRSConnectServer());

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyApplicationPanel.java
Patch:
@@ -66,6 +66,7 @@ protected void initToolbar(Toolbar toolbar, Commands commands)
       toolbar.addLeftWidget(refreshButton);
       
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_SHINY_APP,
             RSConnect.CONTENT_TYPE_NONE, true, null);
       toolbar.addRightWidget(publishButton_);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -375,7 +375,8 @@ public void onError(ServerError error)
                }
             }, caption);
          }
-      }, caption, "Terminal jobs will be terminated. Are you sure?");
+      }, caption, "Terminal jobs will be terminated. Are you sure?", 
+            uiPrefs_.terminalBusyMode().getValue());
    }
    
    void onStopBuild()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -62,7 +62,7 @@ public PlotsPane(Commands commands, PlotsServerOperations server,
    @Override
    protected Toolbar createMainToolbar()
    {
-      publishButton_ = new RSConnectPublishButton(
+      publishButton_ = new RSConnectPublishButton(RSConnectPublishButton.HOST_PLOTS,
             RSConnect.CONTENT_TYPE_PLOT, true, commands_.savePlotAsImage());
       publishButton_.setPublishHtmlSource(new PublishHtmlSource()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationPane.java
Patch:
@@ -106,6 +106,7 @@ protected Toolbar createMainToolbar()
 
          // Create the publish button and wire it to our HTML generator
          publishButton_ = new RSConnectPublishButton(
+               RSConnectPublishButton.HOST_PRESENTATION,
                RSConnect.CONTENT_TYPE_PRES, false, null);
          publishButton_.setPublishHtmlSource(new PublishHtmlSource()
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -154,6 +154,7 @@ private Toolbar createToolbar(Commands commands, PublishHtmlSource publishHtmlSo
       
       toolbar.addRightWidget(
             publishButton_ = new RSConnectPublishButton(
+                  RSConnectPublishButton.HOST_PROFILER,
                   RSConnect.CONTENT_TYPE_DOCUMENT, true, null));
       
       publishButton_.setPublishHtmlSource(publishHtmlSource);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -606,7 +606,7 @@ public void setOutputFormat(String yaml, final String format,
       // introduce unwanted mutations)
       YamlTree tree = new YamlTree(yaml);
       List<String> formats = getOutputFormats(tree);
-      if (formats.contains(format))
+      if (formats != null && formats.contains(format))
       {
          tree.reorder(Arrays.asList(format));
          onCompleted.execute(tree.toString());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.dom.IFrameElementEx;
 import org.rstudio.core.client.widget.RStudioFrame;
+import org.rstudio.core.client.widget.RStudioThemedFrame;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.PanelWithToolbars;
@@ -30,7 +31,7 @@ public UrlContentEditingTargetWidget(Commands commands, String url)
    {
       commands_ = commands;
 
-      frame_ = new RStudioFrame(url, true, "");
+      frame_ = new RStudioThemedFrame(url, true, "allow-same-origin", null, null, false);
       frame_.setSize("100%", "100%");
 
       PanelWithToolbars panel = new PanelWithToolbars(createToolbar(),
@@ -58,5 +59,5 @@ public Widget asWidget()
    }
 
    private final Commands commands_;
-   private RStudioFrame frame_;
+   private RStudioThemedFrame frame_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermNative.java
Patch:
@@ -119,6 +119,7 @@ public final native boolean altBufferActive() /*-{
    public final native void showPrimaryBuffer() /*-{
       this.write("\x1b[?1047l"); // show primary buffer
       this.write("\x1b[m"); // reset all visual attributes
+      this.write("\x1b[?9l"); // reset mouse mode
    }-*/;
 
    public final native void showAltBuffer() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -93,6 +93,7 @@ protected Toolbar createMainToolbar()
      
       // add publish button 
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_VIEWER,
             RSConnect.CONTENT_TYPE_DOCUMENT, true, null);
       toolbar_.addRightWidget(publishButton_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.dom.IFrameElementEx;
 import org.rstudio.core.client.widget.RStudioFrame;
+import org.rstudio.core.client.widget.RStudioThemedFrame;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.PanelWithToolbars;
@@ -30,7 +31,7 @@ public UrlContentEditingTargetWidget(Commands commands, String url)
    {
       commands_ = commands;
 
-      frame_ = new RStudioFrame(url, true, "");
+      frame_ = new RStudioThemedFrame(url, true, "allow-same-origin", null, null, false);
       frame_.setSize("100%", "100%");
 
       PanelWithToolbars panel = new PanelWithToolbars(createToolbar(),
@@ -58,5 +59,5 @@ public Widget asWidget()
    }
 
    private final Commands commands_;
-   private RStudioFrame frame_;
+   private RStudioThemedFrame frame_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.dom.IFrameElementEx;
 import org.rstudio.core.client.widget.RStudioFrame;
+import org.rstudio.core.client.widget.RStudioThemedFrame;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.PanelWithToolbars;
@@ -30,7 +31,7 @@ public UrlContentEditingTargetWidget(Commands commands, String url)
    {
       commands_ = commands;
 
-      frame_ = new RStudioFrame(url, true, "");
+      frame_ = new RStudioThemedFrame(url, true, "allow-same-origin", null, null, false);
       frame_.setSize("100%", "100%");
 
       PanelWithToolbars panel = new PanelWithToolbars(createToolbar(),
@@ -58,5 +59,5 @@ public Widget asWidget()
    }
 
    private final Commands commands_;
-   private RStudioFrame frame_;
+   private RStudioThemedFrame frame_;
 }

File: src/gwt/src/org/rstudio/core/client/widget/ProgressPanel.java
Patch:
@@ -81,7 +81,7 @@ public void endProgressOperation()
    {
       clearTimer();
       progressImage_.setVisible(false);
-      progressSpinner_.setVisible(true);
+      progressSpinner_.setVisible(false);
    }
 
    private int getSpinnerColor()

File: src/gwt/src/org/rstudio/core/client/widget/ProgressSpinner.java
Patch:
@@ -78,7 +78,7 @@ public ProgressSpinner(int color)
          public boolean execute()
          {
             frame_++;
-            redraw();
+            if (isVisible()) redraw();
             return !complete_;
          }
       }, FRAME_RATE_MS);

File: src/gwt/src/org/rstudio/core/client/widget/ProgressPanel.java
Patch:
@@ -81,7 +81,7 @@ public void endProgressOperation()
    {
       clearTimer();
       progressImage_.setVisible(false);
-      progressSpinner_.setVisible(true);
+      progressSpinner_.setVisible(false);
    }
 
    private int getSpinnerColor()

File: src/gwt/src/org/rstudio/core/client/widget/ProgressSpinner.java
Patch:
@@ -78,7 +78,7 @@ public ProgressSpinner(int color)
          public boolean execute()
          {
             frame_++;
-            redraw();
+            if (isVisible()) redraw();
             return !complete_;
          }
       }, FRAME_RATE_MS);

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -52,6 +52,8 @@ public class EditorLanguage
          "mode/c_cpp", true);
    public static final EditorLanguage LANG_STAN = new EditorLanguage(
          "mode/stan", false, true);
+   public static final EditorLanguage LANG_YAML = new EditorLanguage(
+         "mode/yaml", false, true);
    
    // Modes borrowed from Ace
    public static final EditorLanguage LANG_PLAIN = new EditorLanguage(
@@ -70,8 +72,6 @@ public class EditorLanguage
          "ace/mode/sh", false, false);
    public static final EditorLanguage LANG_TOML = new EditorLanguage(
          "ace/mode/toml", false, true);
-   public static final EditorLanguage LANG_YAML = new EditorLanguage(
-         "ace/mode/yaml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(
          "ace/mode/xml", false, false);
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -606,7 +606,7 @@ public void setOutputFormat(String yaml, final String format,
       // introduce unwanted mutations)
       YamlTree tree = new YamlTree(yaml);
       List<String> formats = getOutputFormats(tree);
-      if (formats.contains(format))
+      if (formats != null && formats.contains(format))
       {
          tree.reorder(Arrays.asList(format));
          onCompleted.execute(tree.toString());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -375,7 +375,8 @@ public void onError(ServerError error)
                }
             }, caption);
          }
-      }, caption, "Terminal jobs will be terminated. Are you sure?");
+      }, caption, "Terminal jobs will be terminated. Are you sure?", 
+            uiPrefs_.terminalBusyMode().getValue());
    }
    
    void onStopBuild()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermNative.java
Patch:
@@ -119,6 +119,7 @@ public final native boolean altBufferActive() /*-{
    public final native void showPrimaryBuffer() /*-{
       this.write("\x1b[?1047l"); // show primary buffer
       this.write("\x1b[m"); // reset all visual attributes
+      this.write("\x1b[?9l"); // reset mouse mode
    }-*/;
 
    public final native void showAltBuffer() /*-{

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -17,6 +17,7 @@
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.user.client.ui.*;
 import org.rstudio.core.client.StringUtil;
+import org.rstudio.core.client.dom.DomUtils;
 
 public class TextEntryModalDialog extends ModalDialog<String>
 {
@@ -42,6 +43,7 @@ public TextEntryModalDialog(String title,
                  numbersOnly ? new NumericTextBox() :
                  new TextBox();
       textBox_.setWidth("100%");
+      DomUtils.disableAutoBehavior(textBox_);
       captionLabel_ = new Label(caption);
 
       extraOption_ = new CheckBox(StringUtil.notNull(extraOptionPrompt));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermNative.java
Patch:
@@ -119,6 +119,7 @@ public final native boolean altBufferActive() /*-{
    public final native void showPrimaryBuffer() /*-{
       this.write("\x1b[?1047l"); // show primary buffer
       this.write("\x1b[m"); // reset all visual attributes
+      this.write("\x1b[?9l"); // reset mouse mode
    }-*/;
 
    public final native void showAltBuffer() /*-{

File: src/gwt/src/org/rstudio/core/client/command/AppMenuBar.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.gwt.user.client.ui.MenuBar;
 import com.google.gwt.user.client.ui.MenuItem;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.dom.DomUtils;
 
 import java.util.List;
@@ -64,7 +65,8 @@ public MenuItem addItem(String text, boolean asHTML, MenuBar popup)
          if (vertical_)
             text = AppCommand.formatMenuLabel(null, text, null);
          else
-            text = DomUtils.textToHtml(text);
+            text = "<span id=\"" + ElementIds.idFromLabel(text) + "_menu" + "\">" +
+                   DomUtils.textToHtml(text) + "</span>";
       }
 
       return super.addItem(text,

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogBase.java
Patch:
@@ -24,6 +24,8 @@
 import com.google.gwt.user.client.ui.DockLayoutPanel;
 import com.google.gwt.user.client.ui.FlowPanel;
 import com.google.gwt.user.client.ui.Widget;
+
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.events.EnsureVisibleEvent;
 import org.rstudio.core.client.events.EnsureVisibleHandler;
 import org.rstudio.core.client.widget.ModalDialogBase;
@@ -61,6 +63,7 @@ public void execute()
             });        
          }
       });
+      ElementIds.assignElementId(okButton.getElement(), ElementIds.PREFERENCES_CONFIRM);
       addOkButton(okButton);
       addCancelButton();
       

File: src/gwt/src/org/rstudio/core/client/prefs/SectionChooser.java
Patch:
@@ -14,6 +14,8 @@
  */
 package org.rstudio.core.client.prefs;
 
+import org.rstudio.core.client.ElementIds;
+
 import com.google.gwt.event.dom.client.ClickEvent;
 import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.dom.client.HasClickHandlers;
@@ -65,6 +67,7 @@ public void addSection(ImageResource icon, String name)
       innerPanel.add(nudgeRightPlus(label));
       panel.add(innerPanel);
       panel.setStyleName(res_.styles().section());
+      panel.getElement().setId(ElementIds.idFromLabel(name) + "_options");
 
       panel.addClickHandler(new ClickHandler()
       {

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -72,6 +72,7 @@ public interface ThemeStyles extends CssResource
    String toolbarButtonPushed();
    String emptyProjectMenu();
    String menuSubheader();
+   String menuItemSubtitle();
 
    String menuRightImage();
    

File: src/gwt/src/org/rstudio/core/client/widget/Wizard.java
Patch:
@@ -19,6 +19,7 @@
 
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.Debug;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
 
@@ -116,6 +117,7 @@ public void execute(Boolean valid)
          }
       });
       nextButton_.setVisible(false);
+      nextButton_.getElement().setId(ElementIds.idFromLabel(caption) + "_wizard_next");
       addActionButton(nextButton_);
    }
 
@@ -518,6 +520,7 @@ protected ArrayList<String> getWizardBodyStyles()
    private void resetOkButtonCaption()
    {
       setOkButtonCaption(okCaption_);
+      setOkButtonId(ElementIds.idFromLabel(okCaption_) + "_wizard_confirm");
    }
  
    private boolean pageIsFinal(WizardPage<I, T> page)

File: src/gwt/src/org/rstudio/core/client/widget/WizardPageSelector.java
Patch:
@@ -17,6 +17,7 @@
 import java.util.ArrayList;
 
 import org.rstudio.core.client.CommandWithArg;
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.resources.ImageResource2x;
 
 import com.google.gwt.dom.client.Style.Unit;
@@ -88,6 +89,8 @@ private class PageSelectorItem extends Composite
          
          LayoutPanel layoutPanel = new LayoutPanel();
          layoutPanel.addStyleName(styles.wizardPageSelectorItem());
+         layoutPanel.getElement().setId(
+               ElementIds.idFromLabel(pageInfo.getTitle() + "_wizard_page"));
          
          ImageResource pageImageResource = pageInfo.getImage();
          Image image = null;

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -109,6 +109,7 @@ private Toolbar createToolbar(Commands commands)
       publishButtonSeparator_ = toolbar.addLeftSeparator();
       toolbar.addLeftWidget(
                publishButton_ = new RSConnectPublishButton(
+                     RSConnectPublishButton.HOST_HTML_PREVIEW,
                      RSConnect.CONTENT_TYPE_DOCUMENT, true, null));
       
       findTextBox_ = new FindTextBox("Find");

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdEditorOptions.java
Patch:
@@ -58,8 +58,6 @@ public static String set(String yaml, String option, String value)
    
    private static String EDITOR_OPTION_KEY = "editor_options";
    
-   public static String PUBLISH_OUTPUT    = "publish_output";
-
    public static String PREVIEW_IN        = "preview";
    public static String PREVIEW_IN_WINDOW = "window";
    public static String PREVIEW_IN_VIEWER = "viewer";

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -215,6 +215,7 @@ private void findInTopic(String term, CanFocus findInputSource)
       
       
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_RMD_OUTPUT,
             RSConnect.CONTENT_TYPE_DOCUMENT, true, null);
       toolbar.addRightWidget(publishButton_);
       

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -742,7 +742,7 @@ public void fireRSConnectPublishEvent(RSConnectPublishResult result,
                result.getSettings().getAsStatic(),
                launchBrowser, 
                RSConnectDeploymentRecord.create(result.getAppName(), 
-                     result.getAppTitle(), result.getAccount(), ""));
+                     result.getAppTitle(), result.getAppId(), result.getAccount(), ""));
 
          // we can't raise the main window if we aren't in desktop mode, so show
          // a dialog to guide the user there
@@ -762,7 +762,7 @@ public void fireRSConnectPublishEvent(RSConnectPublishResult result,
                result.getSettings(),
                launchBrowser,
                RSConnectDeploymentRecord.create(result.getAppName(), 
-                     result.getAppTitle(), result.getAccount(), "")));
+                     result.getAppTitle(), result.getAppId(), result.getAccount(), "")));
       }
    }
    
@@ -817,6 +817,7 @@ private void doDeployment(final RSConnectDeployInitiatedEvent event)
                              event.getRecord().getServer(),
                              event.getRecord().getName(), 
                              event.getRecord().getTitle(),
+                             event.getRecord().getAppId(),
                              event.getSettings(),
       new ServerRequestCallback<Boolean>()
       {

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectServerOperations.java
Patch:
@@ -35,8 +35,8 @@ void connectRSConnectAccount(String command,
    void getRSConnectAppList(String accountName, String server,
                ServerRequestCallback<JsArray<RSConnectApplicationInfo>> requestCallback);
 
-   void getRSConnectApp(String appId, String accountName, String server,
-               ServerRequestCallback<RSConnectApplicationInfo> requestCallback);
+   void getRSConnectApp(String appId, String accountName, String server, String hostUrl,
+               ServerRequestCallback<RSConnectApplicationResult> requestCallback);
    
    void getRSConnectDeployments(String sourceFile, String outputFile,
                ServerRequestCallback<JsArray<RSConnectDeploymentRecord>> requestCallback); 
@@ -46,7 +46,7 @@ void getDeploymentFiles (String target,
                ServerRequestCallback<RSConnectDeploymentFiles> requestCallback);
    
    void publishContent(RSConnectPublishSource source, 
-               String account, String server, String appName, String appTitle,
+               String account, String server, String appName, String appTitle, String appId,
                RSConnectPublishSettings settings,
                ServerRequestCallback<Boolean> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectDeployDialog.java
Patch:
@@ -17,6 +17,7 @@
 import java.util.HashMap;
 import java.util.Map;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.ThemedButton;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -49,6 +50,7 @@ public RSConnectDeployDialog(int contentType,
       setText("Publish to Server");
       setWidth("350px");
       deployButton_ = new ThemedButton("Publish");
+      ElementIds.assignElementId(deployButton_.getElement(), ElementIds.DEPLOY_CONTENT);
       addOkButton(deployButton_);
       addCancelButton();
       connect_ = connect;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectLocalAccount.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.rsconnect.ui;
 
+import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.widget.TextBoxWithCue;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.common.HelpLink;
@@ -41,6 +42,7 @@ public RSConnectLocalAccount()
       
       // apply the default server if one is registered
       Session session = RStudioGinjector.INSTANCE.getSession();
+      ElementIds.assignElementId(serverUrl_.getElement(), ElementIds.RSC_SERVER_URL);
       if (session != null && session.getSessionInfo() != null)
       {
          serverUrl_.setText(session.getSessionInfo().getDefaultRSConnectServer());

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyApplicationPanel.java
Patch:
@@ -66,6 +66,7 @@ protected void initToolbar(Toolbar toolbar, Commands commands)
       toolbar.addLeftWidget(refreshButton);
       
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_SHINY_APP,
             RSConnect.CONTENT_TYPE_NONE, true, null);
       toolbar.addRightWidget(publishButton_);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -62,7 +62,7 @@ public PlotsPane(Commands commands, PlotsServerOperations server,
    @Override
    protected Toolbar createMainToolbar()
    {
-      publishButton_ = new RSConnectPublishButton(
+      publishButton_ = new RSConnectPublishButton(RSConnectPublishButton.HOST_PLOTS,
             RSConnect.CONTENT_TYPE_PLOT, true, commands_.savePlotAsImage());
       publishButton_.setPublishHtmlSource(new PublishHtmlSource()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationPane.java
Patch:
@@ -106,6 +106,7 @@ protected Toolbar createMainToolbar()
 
          // Create the publish button and wire it to our HTML generator
          publishButton_ = new RSConnectPublishButton(
+               RSConnectPublishButton.HOST_PRESENTATION,
                RSConnect.CONTENT_TYPE_PRES, false, null);
          publishButton_.setPublishHtmlSource(new PublishHtmlSource()
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -154,6 +154,7 @@ private Toolbar createToolbar(Commands commands, PublishHtmlSource publishHtmlSo
       
       toolbar.addRightWidget(
             publishButton_ = new RSConnectPublishButton(
+                  RSConnectPublishButton.HOST_PROFILER,
                   RSConnect.CONTENT_TYPE_DOCUMENT, true, null));
       
       publishButton_.setPublishHtmlSource(publishHtmlSource);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -93,6 +93,7 @@ protected Toolbar createMainToolbar()
      
       // add publish button 
       publishButton_ = new RSConnectPublishButton(
+            RSConnectPublishButton.HOST_VIEWER,
             RSConnect.CONTENT_TYPE_DOCUMENT, true, null);
       toolbar_.addRightWidget(publishButton_);
       

File: src/gwt/src/org/rstudio/core/client/files/filedialog/ChooseFolderDialog2.java
Patch:
@@ -25,11 +25,12 @@
 public class ChooseFolderDialog2 extends FileSystemDialog
 {
    public ChooseFolderDialog2(String title,
+                              String label,
                               FileSystemContext context,
                               boolean allowFolderCreation,
                               ProgressOperationWithInput<FileSystemItem> operation)
    {
-      super(title, null, "Choose", context, "", allowFolderCreation, operation);
+      super(title, null, label, context, "", allowFolderCreation, operation);
    }
 
    @Override

File: src/gwt/src/org/rstudio/core/client/files/filedialog/OpenFileDialog.java
Patch:
@@ -23,14 +23,13 @@
 public class OpenFileDialog extends FileDialog
 {
    public OpenFileDialog(String title,
+                         String label,
                          FileSystemContext context,
                          String filter,
                          boolean canChooseDirectories,
                          ProgressOperationWithInput<FileSystemItem> operation)
    {
-      super(title, null, "Open", false, false, false, context, filter, 
-            operation);
-      
+      super(title, null, label, false, false, false, context, filter, operation);
       canChooseDirectories_ = canChooseDirectories;
    }
    

File: src/gwt/src/org/rstudio/core/client/files/filedialog/SaveFileDialog.java
Patch:
@@ -24,12 +24,13 @@
 public class SaveFileDialog extends FileDialog
 {
    public SaveFileDialog(String title,
+                         String buttonLabel,
                          FileSystemContext context,
                          String defaultExtension,
                          boolean forceDefaultExtension,
                          ProgressOperationWithInput<FileSystemItem> operation)
    {
-      super(title, null, "Save", true, true, true, context, "", operation);
+      super(title, null, buttonLabel, true, true, true, context, "", operation);
       defaultExtension_ = defaultExtension;
       forceDefaultExtension_ = forceDefaultExtension;
    }

File: src/gwt/src/org/rstudio/core/client/theme/ThemeColors.java
Patch:
@@ -53,4 +53,5 @@ public class ThemeColors
    public static String darkRowSelected                            = "rgba(255, 255, 255, 0.15)";
    public static String darkRowFocused                             = "rgba(255, 255, 255, 0.20)";
    public static String darkRowHovered                             = "rgba(255, 255, 255, 0.05)";
+   public static String darkSearchResultBackground                 = "#6d787f";
 }

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -84,7 +84,6 @@
 import org.rstudio.studio.client.workbench.views.packages.ui.CheckForUpdatesDialog;
 import org.rstudio.studio.client.workbench.views.packages.ui.InstallPackageDialog;
 import org.rstudio.studio.client.workbench.views.packages.ui.PackagesCellTableResources;
-import org.rstudio.studio.client.workbench.views.packages.ui.actions.ActionCenter;
 import org.rstudio.studio.client.workbench.views.plots.ui.manipulator.ManipulatorResources;
 import org.rstudio.studio.client.workbench.views.source.SourceSatellite;
 import org.rstudio.studio.client.workbench.views.source.editors.codebrowser.CodeBrowserEditingTargetWidget;
@@ -286,7 +285,6 @@ private void ensureStylesInjected()
       NewProjectResources.INSTANCE.styles().ensureInjected();
       AboutDialogContents.ensureStylesInjected();
       CompileNotebookv2OptionsDialog.ensureStylesInjected();
-      ActionCenter.ensureStylesInjected();
       PackratResolveConflictDialog.ensureStylesInjected();
       PackratActionDialog.ensureStylesInjected();
       LocalRepositoriesWidget.ensureStylesInjected();

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -112,6 +112,7 @@
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.prefs.model.PrefsServerOperations;
 import org.rstudio.studio.client.workbench.snippets.SnippetServerOperations;
+import org.rstudio.studio.client.workbench.ui.PaneManager;
 import org.rstudio.studio.client.workbench.ui.WorkbenchScreen;
 import org.rstudio.studio.client.workbench.ui.WorkbenchTab;
 import org.rstudio.studio.client.workbench.views.buildtools.BuildPresenter;
@@ -243,6 +244,7 @@ protected void configure()
       bind(ProfilerPresenter.class).in(Singleton.class);
       bind(ObjectExplorerPresenter.class).asEagerSingleton();
       bind(WorkbenchContext.class).asEagerSingleton();
+      bind(PaneManager.class).in(Singleton.class);
       bind(DependencyManager.class).asEagerSingleton();
       bind(WorkbenchListManager.class).asEagerSingleton();
       bind(ApplicationQuit.class).asEagerSingleton();

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RStudioGinjector.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -129,7 +129,6 @@
 import org.rstudio.studio.client.workbench.views.terminal.TerminalList;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalPopupMenu;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalSession;
-import org.rstudio.studio.client.workbench.views.terminal.TerminalSessionSocket;
 import org.rstudio.studio.client.workbench.views.source.editors.text.r.SignatureToolTipManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.TextEditingTargetNotebook;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.display.ChunkOptionsPopupPanel;
@@ -231,7 +230,6 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(NewConnectionSnippetHost newConnectionSnippetHost);
    void injectMembers(NewConnectionSnippetDialog newConnectionSnippetDialog);
    void injectMembers(NewPackagePage page);
-   void injectMembers(TerminalSessionSocket socket);
    void injectMembers(NewConnectionInstallPackagePage newConnectionInstallPackagePage);
    void injectMembers(ObjectExplorerEditingTargetWidget widget);
    void injectMembers(ObjectExplorerDataGrid widget);

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -993,6 +993,7 @@ private void removeTerminalCommands()
       commands_.nextTerminal().remove();
       commands_.showTerminalInfo().remove();
       commands_.interruptTerminal().remove();
+      commands_.sendTerminalToEditor().remove();
    }
 
    private final ApplicationView view_ ;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -73,6 +73,9 @@ public interface FileIconResources extends ClientBundle
 
    @Source("iconYaml_2x.png")
    ImageResource iconYaml2x();
+   
+   @Source("iconToml_2x.png")
+   ImageResource iconToml2x();
 
    @Source("iconXml_2x.png")
    ImageResource iconXml2x();

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -68,8 +68,10 @@ public class EditorLanguage
          "mode/sql", false, true);
    public static final EditorLanguage LANG_SH = new EditorLanguage(
          "ace/mode/sh", false, false);
+   public static final EditorLanguage LANG_TOML = new EditorLanguage(
+         "ace/mode/toml", false, true);
    public static final EditorLanguage LANG_YAML = new EditorLanguage(
-         "ace/mode/yaml", false, false);
+         "ace/mode/yaml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(
          "ace/mode/xml", false, false);
    

File: src/gwt/src/org/rstudio/studio/client/common/viewfile/ViewFilePanel.java
Patch:
@@ -97,7 +97,8 @@ public ViewFilePanel(GlobalDisplay globalDisplay,
       docDisplay_.setReadOnly(true);
       
       TextEditingTarget.registerPrefs(releaseOnDismiss_, 
-            uiPrefs, 
+            uiPrefs,
+            null,
             docDisplay_,
             new TextEditingTarget.PrefsContext()
             {

File: src/gwt/src/org/rstudio/studio/client/packrat/model/PackratServerOperations.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildServerOperations;
+import org.rstudio.studio.client.workbench.views.packages.model.PackratActions;
 
 import com.google.gwt.core.client.JsArray;
 
@@ -41,4 +42,6 @@ void packratBootstrap(String dir,
    void getPendingActions(String action, 
                           String dir,
                           ServerRequestCallback<JsArray<PackratPackageAction>> requestCallback);
+   
+   void getPackratActions(ServerRequestCallback<PackratActions> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryPage.java
Patch:
@@ -121,7 +121,6 @@ protected void onAddWidgets()
       
       // Initialize project with packrat
       chkPackratInit_ = new CheckBox("Use packrat with this project");
-      chkPackratInit_.setValue(uiPrefs.newProjUsePackrat().getValue());
       if (!sessionInfo.getPackratAvailable())
       {
          chkPackratInit_.setValue(false);

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -163,12 +163,14 @@ class ClientEvent extends JavaScriptObject
    public static final String ObjectExplorerEvent = "object_explorer_event";
    public static final String SendToTerminal = "send_to_terminal";
    public static final String ClearTerminal = "clear_terminal";
-   public static final String CreateNamedTerminal = "create_named_terminal";
+   public static final String AddTerminal = "add_terminal";
+   public static final String RemoveTerminal = "remove_terminal";
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
    public static final String AdminNotification = "admin_notification";
    public static final String RequestDocumentSave = "request_document_save";
    public static final String RequestOpenProject = "request_open_project";
+   public static final String OpenFileDialog = "open_file_dialog";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -360,6 +360,7 @@
    public abstract AppCommand packratBundle();
    public abstract AppCommand packratHelp();
    public abstract AppCommand packratClean();
+   public abstract AppCommand packratCheckStatus();
 
    // Version control
    public abstract AppCommand versionControlHelp();
@@ -393,6 +394,7 @@
    public abstract AppCommand nextTerminal();
    public abstract AppCommand showTerminalInfo();
    public abstract AppCommand interruptTerminal();
+   public abstract AppCommand sendTerminalToEditor();
     
    // Help
    public abstract AppCommand helpBack();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AppearancePreferencesPane.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -33,7 +33,6 @@
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.ThemeChangedEvent;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.workbench.prefs.model.RPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionsServerOperations.java
Patch:
@@ -58,4 +58,7 @@ void launchEmbeddedShinyConnectionUI(String packageName,
 
    void connectionTest(String code, 
                        ServerRequestCallback<String> callback);
+
+   void connectionAddPackage(String packageName, 
+                             ServerRequestCallback<Void> callback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -91,6 +91,7 @@ public void onClick(ClickEvent event)
       callFramePanelHeader.addStyleName(globalStyles.windowframe());
       callFramePanelHeader.add(tracebackTitle);
       CheckBox showInternals = new CheckBox("Show internals");
+      showInternals.addStyleName(style.showInternalsCheckbox());
       showInternals.setValue(panelHost_.getShowInternalFunctions());
       showInternals.addValueChangeHandler(
             new ValueChangeHandler<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanelStyle.java
Patch:
@@ -21,4 +21,5 @@ public interface CallFramePanelStyle extends CssResource
 {
    String tracebackHeader();
    String toggleHide();
+   String showInternalsCheckbox();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -168,6 +168,7 @@ public void initialize(SourceDocument document,
       
       TextEditingTarget.registerPrefs(releaseOnDismiss_, 
                                       prefs_, 
+                                      document.getProjectConfig(),
                                       docDisplay_,
                                       document);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorCommandEvent.java
Patch:
@@ -33,6 +33,7 @@ public class AceEditorCommandEvent extends CrossWindowEvent<AceEditorCommandEven
    public static final int EXPAND_TO_MATCHING         =  9;
    public static final int ADD_CURSOR_ABOVE           = 10;
    public static final int ADD_CURSOR_BELOW           = 11;
+   public static final int INSERT_SNIPPET             = 12;
    
    public static final int EXECUTION_POLICY_FOCUSED = 1;
    public static final int EXECUTION_POLICY_ALWAYS  = 2;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -108,7 +108,7 @@ public void execute()
          }
          addSeparator();
          addItem(commands_.renameTerminal().createMenuItem(false));
-         addItem(commands_.showTerminalInfo().createMenuItem(false));
+         addItem(commands_.sendTerminalToEditor().createMenuItem(false));
          addSeparator();
          addItem(commands_.previousTerminal().createMenuItem(false));
          addItem(commands_.nextTerminal().createMenuItem(false));
@@ -158,10 +158,10 @@ public void setActiveTerminal(String caption, String handle)
       commands_.closeTerminal().setEnabled(haveActiveTerminal);
       commands_.renameTerminal().setEnabled(haveActiveTerminal);
       commands_.clearTerminalScrollbackBuffer().setEnabled(haveActiveTerminal);
-      commands_.showTerminalInfo().setEnabled(haveActiveTerminal);
       commands_.interruptTerminal().setEnabled(haveActiveTerminal);
       commands_.previousTerminal().setEnabled(getPreviousTerminalHandle() != null);
       commands_.nextTerminal().setEnabled(getNextTerminalHandle() != null);
+      commands_.sendTerminalToEditor().setEnabled(haveActiveTerminal);
       
       // inform server of the selection
       server_.processNotifyVisible(activeTerminalHandle_, new ServerRequestCallback<Void>() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalShellInfo.java
Patch:
@@ -36,6 +36,7 @@ public class TerminalShellInfo extends JavaScriptObject
    
    public static final int SHELL_POSIX_BASH = 7;
    public static final int SHELL_CUSTOM = 8;
+   public static final int SHELL_NONE = 9;
 
    protected TerminalShellInfo() {}
 
@@ -69,6 +70,8 @@ public static String getShellName(int shell)
          return "Bash";
       case SHELL_CUSTOM:
          return "Custom";
+      case SHELL_NONE:
+         return "User command";
       default:
          return "Unknown";
       }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectServerOperations.java
Patch:
@@ -36,7 +36,7 @@ void getRSConnectAppList(String accountName, String server,
                ServerRequestCallback<JsArray<RSConnectApplicationInfo>> requestCallback);
 
    void getRSConnectApp(String appId, String accountName, String server, String hostUrl,
-               ServerRequestCallback<RSConnectApplicationInfo> requestCallback);
+               ServerRequestCallback<RSConnectApplicationResult> requestCallback);
    
    void getRSConnectDeployments(String sourceFile, String outputFile,
                ServerRequestCallback<JsArray<RSConnectDeploymentRecord>> requestCallback); 

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -117,6 +117,7 @@
 import org.rstudio.studio.client.rsconnect.model.RSConnectAccount;
 import org.rstudio.studio.client.rsconnect.model.RSConnectAppName;
 import org.rstudio.studio.client.rsconnect.model.RSConnectApplicationInfo;
+import org.rstudio.studio.client.rsconnect.model.RSConnectApplicationResult;
 import org.rstudio.studio.client.rsconnect.model.RSConnectAuthUser;
 import org.rstudio.studio.client.rsconnect.model.RSConnectDeploymentFiles;
 import org.rstudio.studio.client.rsconnect.model.RSConnectDeploymentRecord;
@@ -4223,7 +4224,7 @@ public void getRSConnectAppList(
 
    @Override
    public void getRSConnectApp(String appId, String accountName, String server, String hostUrl,
-         ServerRequestCallback<RSConnectApplicationInfo> requestCallback)
+         ServerRequestCallback<RSConnectApplicationResult> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(appId));

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -164,6 +164,7 @@ class ClientEvent extends JavaScriptObject
    public static final String SendToTerminal = "send_to_terminal";
    public static final String ClearTerminal = "clear_terminal";
    public static final String AddTerminal = "add_terminal";
+   public static final String RemoveTerminal = "remove_terminal";
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
    public static final String AdminNotification = "admin_notification";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -109,7 +109,6 @@ public void execute()
          addSeparator();
          addItem(commands_.renameTerminal().createMenuItem(false));
          addItem(commands_.sendTerminalToEditor().createMenuItem(false));
-         addItem(commands_.showTerminalInfo().createMenuItem(false));
          addSeparator();
          addItem(commands_.previousTerminal().createMenuItem(false));
          addItem(commands_.nextTerminal().createMenuItem(false));
@@ -159,7 +158,6 @@ public void setActiveTerminal(String caption, String handle)
       commands_.closeTerminal().setEnabled(haveActiveTerminal);
       commands_.renameTerminal().setEnabled(haveActiveTerminal);
       commands_.clearTerminalScrollbackBuffer().setEnabled(haveActiveTerminal);
-      commands_.showTerminalInfo().setEnabled(haveActiveTerminal);
       commands_.interruptTerminal().setEnabled(haveActiveTerminal);
       commands_.previousTerminal().setEnabled(getPreviousTerminalHandle() != null);
       commands_.nextTerminal().setEnabled(getNextTerminalHandle() != null);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalShellInfo.java
Patch:
@@ -36,6 +36,7 @@ public class TerminalShellInfo extends JavaScriptObject
    
    public static final int SHELL_POSIX_BASH = 7;
    public static final int SHELL_CUSTOM = 8;
+   public static final int SHELL_NONE = 9;
 
    protected TerminalShellInfo() {}
 
@@ -69,6 +70,8 @@ public static String getShellName(int shell)
          return "Bash";
       case SHELL_CUSTOM:
          return "Custom";
+      case SHELL_NONE:
+         return "User command";
       default:
          return "Unknown";
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTab.java
Patch:
@@ -35,6 +35,7 @@
 import org.rstudio.studio.client.workbench.views.terminal.events.AddTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.ClearTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.CreateTerminalEvent;
+import org.rstudio.studio.client.workbench.views.terminal.events.RemoveTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.SendToTerminalEvent;
 
 import com.google.gwt.core.client.JsArray;
@@ -54,6 +55,7 @@ public abstract static class Shim
                  SendToTerminalEvent.Handler,
                  ClearTerminalEvent.Handler,
                  AddTerminalEvent.Handler,
+                 RemoveTerminalEvent.Handler,
                  ActivateNamedTerminalEvent.Handler
    {
       @Handler
@@ -109,6 +111,7 @@ public TerminalTab(Shim shim,
       events.addHandler(SendToTerminalEvent.TYPE, shim_);
       events.addHandler(ClearTerminalEvent.TYPE, shim_);
       events.addHandler(AddTerminalEvent.TYPE, shim_);
+      events.addHandler(RemoveTerminalEvent.TYPE, shim_);
       events.addHandler(ActivateNamedTerminalEvent.TYPE, shim_);
 
       events.addHandler(SessionInitEvent.TYPE, new SessionInitHandler()

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -112,6 +112,7 @@
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.prefs.model.PrefsServerOperations;
 import org.rstudio.studio.client.workbench.snippets.SnippetServerOperations;
+import org.rstudio.studio.client.workbench.ui.PaneManager;
 import org.rstudio.studio.client.workbench.ui.WorkbenchScreen;
 import org.rstudio.studio.client.workbench.ui.WorkbenchTab;
 import org.rstudio.studio.client.workbench.views.buildtools.BuildPresenter;
@@ -243,6 +244,7 @@ protected void configure()
       bind(ProfilerPresenter.class).in(Singleton.class);
       bind(ObjectExplorerPresenter.class).asEagerSingleton();
       bind(WorkbenchContext.class).asEagerSingleton();
+      bind(PaneManager.class).in(Singleton.class);
       bind(DependencyManager.class).asEagerSingleton();
       bind(WorkbenchListManager.class).asEagerSingleton();
       bind(ApplicationQuit.class).asEagerSingleton();

File: src/gwt/src/org/rstudio/studio/client/common/viewfile/ViewFilePanel.java
Patch:
@@ -97,7 +97,8 @@ public ViewFilePanel(GlobalDisplay globalDisplay,
       docDisplay_.setReadOnly(true);
       
       TextEditingTarget.registerPrefs(releaseOnDismiss_, 
-            uiPrefs, 
+            uiPrefs,
+            null,
             docDisplay_,
             new TextEditingTarget.PrefsContext()
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -168,6 +168,7 @@ public void initialize(SourceDocument document,
       
       TextEditingTarget.registerPrefs(releaseOnDismiss_, 
                                       prefs_, 
+                                      document.getProjectConfig(),
                                       docDisplay_,
                                       document);
       

File: src/gwt/src/org/rstudio/core/client/theme/ThemeColors.java
Patch:
@@ -53,4 +53,5 @@ public class ThemeColors
    public static String darkRowSelected                            = "rgba(255, 255, 255, 0.15)";
    public static String darkRowFocused                             = "rgba(255, 255, 255, 0.20)";
    public static String darkRowHovered                             = "rgba(255, 255, 255, 0.05)";
+   public static String darkSearchResultBackground                 = "#6d787f";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -91,6 +91,7 @@ public void onClick(ClickEvent event)
       callFramePanelHeader.addStyleName(globalStyles.windowframe());
       callFramePanelHeader.add(tracebackTitle);
       CheckBox showInternals = new CheckBox("Show internals");
+      showInternals.addStyleName(style.showInternalsCheckbox());
       showInternals.setValue(panelHost_.getShowInternalFunctions());
       showInternals.addValueChangeHandler(
             new ValueChangeHandler<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanelStyle.java
Patch:
@@ -21,4 +21,5 @@ public interface CallFramePanelStyle extends CssResource
 {
    String tracebackHeader();
    String toggleHide();
+   String showInternalsCheckbox();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -641,8 +641,8 @@ private void cleanupAfterTerminate(String handle, boolean processExited)
             {
                terminal.showZombieMessage();
                terminal.disconnect(true /*permanent*/);
-               server_.processSetZombie(handle,  new VoidServerRequestCallback());
             }
+            terminals_.setZombie(handle, true);
             return;
          }
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -641,8 +641,8 @@ private void cleanupAfterTerminate(String handle, boolean processExited)
             {
                terminal.showZombieMessage();
                terminal.disconnect(true /*permanent*/);
-               server_.processSetZombie(handle,  new VoidServerRequestCallback());
             }
+            terminals_.setZombie(handle, true);
             return;
          }
       }

File: src/gwt/src/org/rstudio/core/client/theme/ThemeColors.java
Patch:
@@ -53,4 +53,5 @@ public class ThemeColors
    public static String darkRowSelected                            = "rgba(255, 255, 255, 0.15)";
    public static String darkRowFocused                             = "rgba(255, 255, 255, 0.20)";
    public static String darkRowHovered                             = "rgba(255, 255, 255, 0.05)";
+   public static String darkSearchResultBackground                 = "#6d787f";
 }

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -993,6 +993,7 @@ private void removeTerminalCommands()
       commands_.nextTerminal().remove();
       commands_.showTerminalInfo().remove();
       commands_.interruptTerminal().remove();
+      commands_.sendTerminalToEditor().remove();
    }
 
    private final ApplicationView view_ ;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -73,6 +73,9 @@ public interface FileIconResources extends ClientBundle
 
    @Source("iconYaml_2x.png")
    ImageResource iconYaml2x();
+   
+   @Source("iconToml_2x.png")
+   ImageResource iconToml2x();
 
    @Source("iconXml_2x.png")
    ImageResource iconXml2x();

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -68,8 +68,10 @@ public class EditorLanguage
          "mode/sql", false, true);
    public static final EditorLanguage LANG_SH = new EditorLanguage(
          "ace/mode/sh", false, false);
+   public static final EditorLanguage LANG_TOML = new EditorLanguage(
+         "ace/mode/toml", false, true);
    public static final EditorLanguage LANG_YAML = new EditorLanguage(
-         "ace/mode/yaml", false, false);
+         "ace/mode/yaml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(
          "ace/mode/xml", false, false);
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -163,7 +163,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ObjectExplorerEvent = "object_explorer_event";
    public static final String SendToTerminal = "send_to_terminal";
    public static final String ClearTerminal = "clear_terminal";
-   public static final String CreateNamedTerminal = "create_named_terminal";
+   public static final String AddTerminal = "add_terminal";
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
    public static final String AdminNotification = "admin_notification";

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -20,7 +20,6 @@
 import com.google.inject.Provider;
 
 import org.rstudio.core.client.BrowseCap;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.Size;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.TimeBufferedCommand;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -394,6 +394,7 @@
    public abstract AppCommand nextTerminal();
    public abstract AppCommand showTerminalInfo();
    public abstract AppCommand interruptTerminal();
+   public abstract AppCommand sendTerminalToEditor();
     
    // Help
    public abstract AppCommand helpBack();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionsServerOperations.java
Patch:
@@ -58,4 +58,7 @@ void launchEmbeddedShinyConnectionUI(String packageName,
 
    void connectionTest(String code, 
                        ServerRequestCallback<String> callback);
+
+   void connectionAddPackage(String packageName, 
+                             ServerRequestCallback<Void> callback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -91,6 +91,7 @@ public void onClick(ClickEvent event)
       callFramePanelHeader.addStyleName(globalStyles.windowframe());
       callFramePanelHeader.add(tracebackTitle);
       CheckBox showInternals = new CheckBox("Show internals");
+      showInternals.addStyleName(style.showInternalsCheckbox());
       showInternals.setValue(panelHost_.getShowInternalFunctions());
       showInternals.addValueChangeHandler(
             new ValueChangeHandler<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanelStyle.java
Patch:
@@ -21,4 +21,5 @@ public interface CallFramePanelStyle extends CssResource
 {
    String tracebackHeader();
    String toggleHide();
+   String showInternalsCheckbox();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -35,7 +35,6 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
-import org.rstudio.studio.client.workbench.views.packages.events.RaisePackagePaneEvent;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageInfo;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageInstallContext;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageInstallOptions;
@@ -64,7 +63,6 @@
 import com.google.gwt.user.cellview.client.HasKeyboardSelectionPolicy.KeyboardSelectionPolicy;
 import com.google.gwt.user.cellview.client.TextColumn;
 import com.google.gwt.user.cellview.client.TextHeader;
-import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.Timer;
 import com.google.gwt.user.client.ui.LayoutPanel;
 import com.google.gwt.user.client.ui.SuggestOracle;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/model/PackageState.java
Patch:
@@ -15,7 +15,6 @@
 package org.rstudio.studio.client.workbench.views.packages.model;
 
 import org.rstudio.studio.client.packrat.model.PackratContext;
-import org.rstudio.studio.client.packrat.model.PackratPackageAction;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorCommandEvent.java
Patch:
@@ -33,6 +33,7 @@ public class AceEditorCommandEvent extends CrossWindowEvent<AceEditorCommandEven
    public static final int EXPAND_TO_MATCHING         =  9;
    public static final int ADD_CURSOR_ABOVE           = 10;
    public static final int ADD_CURSOR_BELOW           = 11;
+   public static final int INSERT_SNIPPET             = 12;
    
    public static final int EXECUTION_POLICY_FOCUSED = 1;
    public static final int EXECUTION_POLICY_ALWAYS  = 2;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -108,6 +108,7 @@ public void execute()
          }
          addSeparator();
          addItem(commands_.renameTerminal().createMenuItem(false));
+         addItem(commands_.sendTerminalToEditor().createMenuItem(false));
          addItem(commands_.showTerminalInfo().createMenuItem(false));
          addSeparator();
          addItem(commands_.previousTerminal().createMenuItem(false));
@@ -162,6 +163,7 @@ public void setActiveTerminal(String caption, String handle)
       commands_.interruptTerminal().setEnabled(haveActiveTerminal);
       commands_.previousTerminal().setEnabled(getPreviousTerminalHandle() != null);
       commands_.nextTerminal().setEnabled(getNextTerminalHandle() != null);
+      commands_.sendTerminalToEditor().setEnabled(haveActiveTerminal);
       
       // inform server of the selection
       server_.processNotifyVisible(activeTerminalHandle_, new ServerRequestCallback<Void>() {

File: src/gwt/src/org/rstudio/core/client/theme/ThemeColors.java
Patch:
@@ -53,4 +53,5 @@ public class ThemeColors
    public static String darkRowSelected                            = "rgba(255, 255, 255, 0.15)";
    public static String darkRowFocused                             = "rgba(255, 255, 255, 0.20)";
    public static String darkRowHovered                             = "rgba(255, 255, 255, 0.05)";
+   public static String darkSearchResultBackground                 = "#6d787f";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -91,6 +91,7 @@ public void onClick(ClickEvent event)
       callFramePanelHeader.addStyleName(globalStyles.windowframe());
       callFramePanelHeader.add(tracebackTitle);
       CheckBox showInternals = new CheckBox("Show internals");
+      showInternals.addStyleName(style.showInternalsCheckbox());
       showInternals.setValue(panelHost_.getShowInternalFunctions());
       showInternals.addValueChangeHandler(
             new ValueChangeHandler<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanelStyle.java
Patch:
@@ -21,4 +21,5 @@ public interface CallFramePanelStyle extends CssResource
 {
    String tracebackHeader();
    String toggleHide();
+   String showInternalsCheckbox();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -91,6 +91,7 @@ public void onClick(ClickEvent event)
       callFramePanelHeader.addStyleName(globalStyles.windowframe());
       callFramePanelHeader.add(tracebackTitle);
       CheckBox showInternals = new CheckBox("Show internals");
+      showInternals.addStyleName(style.showInternalsCheckbox());
       showInternals.setValue(panelHost_.getShowInternalFunctions());
       showInternals.addValueChangeHandler(
             new ValueChangeHandler<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanelStyle.java
Patch:
@@ -21,4 +21,5 @@ public interface CallFramePanelStyle extends CssResource
 {
    String tracebackHeader();
    String toggleHide();
+   String showInternalsCheckbox();
 }

File: src/gwt/src/org/rstudio/core/client/theme/ThemeColors.java
Patch:
@@ -53,4 +53,5 @@ public class ThemeColors
    public static String darkRowSelected                            = "rgba(255, 255, 255, 0.15)";
    public static String darkRowFocused                             = "rgba(255, 255, 255, 0.20)";
    public static String darkRowHovered                             = "rgba(255, 255, 255, 0.05)";
+   public static String darkSearchResultBackground                 = "#6d787f";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -91,6 +91,7 @@ public void onClick(ClickEvent event)
       callFramePanelHeader.addStyleName(globalStyles.windowframe());
       callFramePanelHeader.add(tracebackTitle);
       CheckBox showInternals = new CheckBox("Show internals");
+      showInternals.addStyleName(style.showInternalsCheckbox());
       showInternals.setValue(panelHost_.getShowInternalFunctions());
       showInternals.addValueChangeHandler(
             new ValueChangeHandler<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanelStyle.java
Patch:
@@ -21,4 +21,5 @@ public interface CallFramePanelStyle extends CssResource
 {
    String tracebackHeader();
    String toggleHide();
+   String showInternalsCheckbox();
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -163,7 +163,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ObjectExplorerEvent = "object_explorer_event";
    public static final String SendToTerminal = "send_to_terminal";
    public static final String ClearTerminal = "clear_terminal";
-   public static final String CreateNamedTerminal = "create_named_terminal";
+   public static final String AddTerminal = "add_terminal";
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
    public static final String AdminNotification = "admin_notification";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTab.java
Patch:
@@ -32,8 +32,8 @@
 import org.rstudio.studio.client.workbench.ui.DelayLoadTabShim;
 import org.rstudio.studio.client.workbench.ui.DelayLoadWorkbenchTab;
 import org.rstudio.studio.client.workbench.views.terminal.events.ActivateNamedTerminalEvent;
+import org.rstudio.studio.client.workbench.views.terminal.events.AddTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.ClearTerminalEvent;
-import org.rstudio.studio.client.workbench.views.terminal.events.CreateNamedTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.CreateTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.SendToTerminalEvent;
 
@@ -53,7 +53,7 @@ public abstract static class Shim
                  CreateTerminalEvent.Handler,
                  SendToTerminalEvent.Handler,
                  ClearTerminalEvent.Handler,
-                 CreateNamedTerminalEvent.Handler,
+                 AddTerminalEvent.Handler,
                  ActivateNamedTerminalEvent.Handler
    {
       @Handler
@@ -108,7 +108,7 @@ public TerminalTab(Shim shim,
       events.addHandler(CreateTerminalEvent.TYPE, shim_);
       events.addHandler(SendToTerminalEvent.TYPE, shim_);
       events.addHandler(ClearTerminalEvent.TYPE, shim_);
-      events.addHandler(CreateNamedTerminalEvent.TYPE, shim_);
+      events.addHandler(AddTerminalEvent.TYPE, shim_);
       events.addHandler(ActivateNamedTerminalEvent.TYPE, shim_);
 
       events.addHandler(SessionInitEvent.TYPE, new SessionInitHandler()

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -73,6 +73,9 @@ public interface FileIconResources extends ClientBundle
 
    @Source("iconYaml_2x.png")
    ImageResource iconYaml2x();
+   
+   @Source("iconToml_2x.png")
+   ImageResource iconToml2x();
 
    @Source("iconXml_2x.png")
    ImageResource iconXml2x();

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -68,8 +68,10 @@ public class EditorLanguage
          "mode/sql", false, true);
    public static final EditorLanguage LANG_SH = new EditorLanguage(
          "ace/mode/sh", false, false);
+   public static final EditorLanguage LANG_TOML = new EditorLanguage(
+         "ace/mode/toml", false, true);
    public static final EditorLanguage LANG_YAML = new EditorLanguage(
-         "ace/mode/yaml", false, false);
+         "ace/mode/yaml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(
          "ace/mode/xml", false, false);
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorCommandEvent.java
Patch:
@@ -33,6 +33,7 @@ public class AceEditorCommandEvent extends CrossWindowEvent<AceEditorCommandEven
    public static final int EXPAND_TO_MATCHING         =  9;
    public static final int ADD_CURSOR_ABOVE           = 10;
    public static final int ADD_CURSOR_BELOW           = 11;
+   public static final int INSERT_SNIPPET             = 12;
    
    public static final int EXECUTION_POLICY_FOCUSED = 1;
    public static final int EXECUTION_POLICY_ALWAYS  = 2;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorCommandEvent.java
Patch:
@@ -33,6 +33,7 @@ public class AceEditorCommandEvent extends CrossWindowEvent<AceEditorCommandEven
    public static final int EXPAND_TO_MATCHING         =  9;
    public static final int ADD_CURSOR_ABOVE           = 10;
    public static final int ADD_CURSOR_BELOW           = 11;
+   public static final int INSERT_SNIPPET             = 12;
    
    public static final int EXECUTION_POLICY_FOCUSED = 1;
    public static final int EXECUTION_POLICY_ALWAYS  = 2;

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -993,6 +993,7 @@ private void removeTerminalCommands()
       commands_.nextTerminal().remove();
       commands_.showTerminalInfo().remove();
       commands_.interruptTerminal().remove();
+      commands_.sendTerminalToEditor().remove();
    }
 
    private final ApplicationView view_ ;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -394,6 +394,7 @@
    public abstract AppCommand nextTerminal();
    public abstract AppCommand showTerminalInfo();
    public abstract AppCommand interruptTerminal();
+   public abstract AppCommand sendTerminalToEditor();
     
    // Help
    public abstract AppCommand helpBack();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -108,6 +108,7 @@ public void execute()
          }
          addSeparator();
          addItem(commands_.renameTerminal().createMenuItem(false));
+         addItem(commands_.sendTerminalToEditor().createMenuItem(false));
          addItem(commands_.showTerminalInfo().createMenuItem(false));
          addSeparator();
          addItem(commands_.previousTerminal().createMenuItem(false));
@@ -162,6 +163,7 @@ public void setActiveTerminal(String caption, String handle)
       commands_.interruptTerminal().setEnabled(haveActiveTerminal);
       commands_.previousTerminal().setEnabled(getPreviousTerminalHandle() != null);
       commands_.nextTerminal().setEnabled(getNextTerminalHandle() != null);
+      commands_.sendTerminalToEditor().setEnabled(haveActiveTerminal);
       
       // inform server of the selection
       server_.processNotifyVisible(activeTerminalHandle_, new ServerRequestCallback<Void>() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTab.java
Patch:
@@ -74,6 +74,9 @@ public abstract static class Shim
       @Handler
       public abstract void onInterruptTerminal();
 
+      @Handler
+      public abstract void onSendTerminalToEditor();
+
       abstract void initialize();
       abstract void confirmClose(Command onConfirmed);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -57,7 +57,8 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Sequence:    '" + session.getSequence() + "'\n");
       diagnostics.append("Restarted:   '" + session.getRestarted() + "\n");
       diagnostics.append("Busy:        '" + session.getHasChildProcs() + "'\n");
-      diagnostics.append("Alt-Buffer:  '" + session.altBufferActive() + "'\n");
+      diagnostics.append("Full screen: 'client=" + session.xtermAltBufferActive() +  
+            "/server=" + session.getAltBufferActive() + "'\n"); 
       diagnostics.append("Zombie:      '" + session.getZombie() + "'\n");
       diagnostics.append("Track Env    '" + session.getTrackEnv() + "'\n");
       diagnostics.append("Local-echo:  '" + localEchoEnabled + "'\n"); 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -191,7 +191,7 @@ public void execute()
                }
                else
                {
-                  if (!visibleTerminal.altBufferActive())
+                  if (!visibleTerminal.xtermAltBufferActive())
                   {
                      // not running a full-screen program
                      interruptable = true;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -57,7 +57,7 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Sequence:    '" + session.getSequence() + "'\n");
       diagnostics.append("Restarted:   '" + session.getRestarted() + "\n");
       diagnostics.append("Busy:        '" + session.getHasChildProcs() + "'\n");
-      diagnostics.append("Full screen: 'client=" + session.altBufferActive() +  
+      diagnostics.append("Full screen: 'client=" + session.xtermAltBufferActive() +  
             "/server=" + session.getAltBufferActive() + "'\n"); 
       diagnostics.append("Zombie:      '" + session.getZombie() + "'\n");
       diagnostics.append("Track Env    '" + session.getTrackEnv() + "'\n");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -191,7 +191,7 @@ public void execute()
                }
                else
                {
-                  if (!visibleTerminal.altBufferActive())
+                  if (!visibleTerminal.xtermAltBufferActive())
                   {
                      // not running a full-screen program
                      interruptable = true;

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -20,7 +20,6 @@
 import com.google.inject.Provider;
 
 import org.rstudio.core.client.BrowseCap;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.Size;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.TimeBufferedCommand;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -35,7 +35,6 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
-import org.rstudio.studio.client.workbench.views.packages.events.RaisePackagePaneEvent;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageInfo;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageInstallContext;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageInstallOptions;
@@ -64,7 +63,6 @@
 import com.google.gwt.user.cellview.client.HasKeyboardSelectionPolicy.KeyboardSelectionPolicy;
 import com.google.gwt.user.cellview.client.TextColumn;
 import com.google.gwt.user.cellview.client.TextHeader;
-import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.Timer;
 import com.google.gwt.user.client.ui.LayoutPanel;
 import com.google.gwt.user.client.ui.SuggestOracle;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/model/PackageState.java
Patch:
@@ -15,7 +15,6 @@
 package org.rstudio.studio.client.workbench.views.packages.model;
 
 import org.rstudio.studio.client.packrat.model.PackratContext;
-import org.rstudio.studio.client.packrat.model.PackratPackageAction;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -57,7 +57,8 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Sequence:    '" + session.getSequence() + "'\n");
       diagnostics.append("Restarted:   '" + session.getRestarted() + "\n");
       diagnostics.append("Busy:        '" + session.getHasChildProcs() + "'\n");
-      diagnostics.append("Alt-Buffer:  '" + session.altBufferActive() + "'\n");
+      diagnostics.append("Full screen: 'client=" + session.altBufferActive() +  
+            "/server=" + session.getAltBufferActive() + "'\n"); 
       diagnostics.append("Zombie:      '" + session.getZombie() + "'\n");
       diagnostics.append("Track Env    '" + session.getTrackEnv() + "'\n");
       diagnostics.append("Local-echo:  '" + localEchoEnabled + "'\n"); 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionsServerOperations.java
Patch:
@@ -58,4 +58,7 @@ void launchEmbeddedShinyConnectionUI(String packageName,
 
    void connectionTest(String code, 
                        ServerRequestCallback<String> callback);
+
+   void connectionAddPackage(String packageName, 
+                             ServerRequestCallback<Void> callback);
 }

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -84,7 +84,6 @@
 import org.rstudio.studio.client.workbench.views.packages.ui.CheckForUpdatesDialog;
 import org.rstudio.studio.client.workbench.views.packages.ui.InstallPackageDialog;
 import org.rstudio.studio.client.workbench.views.packages.ui.PackagesCellTableResources;
-import org.rstudio.studio.client.workbench.views.packages.ui.actions.ActionCenter;
 import org.rstudio.studio.client.workbench.views.plots.ui.manipulator.ManipulatorResources;
 import org.rstudio.studio.client.workbench.views.source.SourceSatellite;
 import org.rstudio.studio.client.workbench.views.source.editors.codebrowser.CodeBrowserEditingTargetWidget;
@@ -286,7 +285,6 @@ private void ensureStylesInjected()
       NewProjectResources.INSTANCE.styles().ensureInjected();
       AboutDialogContents.ensureStylesInjected();
       CompileNotebookv2OptionsDialog.ensureStylesInjected();
-      ActionCenter.ensureStylesInjected();
       PackratResolveConflictDialog.ensureStylesInjected();
       PackratActionDialog.ensureStylesInjected();
       LocalRepositoriesWidget.ensureStylesInjected();

File: src/gwt/src/org/rstudio/studio/client/packrat/model/PackratServerOperations.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildServerOperations;
+import org.rstudio.studio.client.workbench.views.packages.model.PackratActions;
 
 import com.google.gwt.core.client.JsArray;
 
@@ -41,4 +42,6 @@ void packratBootstrap(String dir,
    void getPendingActions(String action, 
                           String dir,
                           ServerRequestCallback<JsArray<PackratPackageAction>> requestCallback);
+   
+   void getPackratActions(ServerRequestCallback<PackratActions> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryPage.java
Patch:
@@ -121,7 +121,6 @@ protected void onAddWidgets()
       
       // Initialize project with packrat
       chkPackratInit_ = new CheckBox("Use packrat with this project");
-      chkPackratInit_.setValue(uiPrefs.newProjUsePackrat().getValue());
       if (!sessionInfo.getPackratAvailable())
       {
          chkPackratInit_.setValue(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -360,6 +360,7 @@
    public abstract AppCommand packratBundle();
    public abstract AppCommand packratHelp();
    public abstract AppCommand packratClean();
+   public abstract AppCommand packratCheckStatus();
 
    // Version control
    public abstract AppCommand versionControlHelp();

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -84,7 +84,6 @@
 import org.rstudio.studio.client.workbench.views.packages.ui.CheckForUpdatesDialog;
 import org.rstudio.studio.client.workbench.views.packages.ui.InstallPackageDialog;
 import org.rstudio.studio.client.workbench.views.packages.ui.PackagesCellTableResources;
-import org.rstudio.studio.client.workbench.views.packages.ui.actions.ActionCenter;
 import org.rstudio.studio.client.workbench.views.plots.ui.manipulator.ManipulatorResources;
 import org.rstudio.studio.client.workbench.views.source.SourceSatellite;
 import org.rstudio.studio.client.workbench.views.source.editors.codebrowser.CodeBrowserEditingTargetWidget;
@@ -286,7 +285,6 @@ private void ensureStylesInjected()
       NewProjectResources.INSTANCE.styles().ensureInjected();
       AboutDialogContents.ensureStylesInjected();
       CompileNotebookv2OptionsDialog.ensureStylesInjected();
-      ActionCenter.ensureStylesInjected();
       PackratResolveConflictDialog.ensureStylesInjected();
       PackratActionDialog.ensureStylesInjected();
       LocalRepositoriesWidget.ensureStylesInjected();

File: src/gwt/src/org/rstudio/studio/client/packrat/model/PackratServerOperations.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildServerOperations;
+import org.rstudio.studio.client.workbench.views.packages.model.PackratActions;
 
 import com.google.gwt.core.client.JsArray;
 
@@ -41,4 +42,6 @@ void packratBootstrap(String dir,
    void getPendingActions(String action, 
                           String dir,
                           ServerRequestCallback<JsArray<PackratPackageAction>> requestCallback);
+   
+   void getPackratActions(ServerRequestCallback<PackratActions> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryPage.java
Patch:
@@ -121,7 +121,6 @@ protected void onAddWidgets()
       
       // Initialize project with packrat
       chkPackratInit_ = new CheckBox("Use packrat with this project");
-      chkPackratInit_.setValue(uiPrefs.newProjUsePackrat().getValue());
       if (!sessionInfo.getPackratAvailable())
       {
          chkPackratInit_.setValue(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -360,6 +360,7 @@
    public abstract AppCommand packratBundle();
    public abstract AppCommand packratHelp();
    public abstract AppCommand packratClean();
+   public abstract AppCommand packratCheckStatus();
 
    // Version control
    public abstract AppCommand versionControlHelp();

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -152,11 +152,12 @@ void getTerminalShells(
     * @param altBufferActive terminal showing alt-buffer (full-screen ncurses)
     * @param cwd current working directory
     * @param zombie if true, terminal buffer reloaded but no process created
+    * @param trackEnv if true, server runs a hidden command to capture environment variables
     * @param requestCallback callback from server upon completion
     */
    void startTerminal(int shellType, int cols, int rows, String handle, 
                       String caption, String title, int sequence, 
-                      boolean altBufferActive, String cwd, boolean zombie,
+                      boolean altBufferActive, String cwd, boolean zombie, boolean trackEnv,
                       ServerRequestCallback<ConsoleProcess> requestCallback);
    
    void executeCode(String code, ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -128,7 +128,7 @@ public void connect()
       server_.startTerminal(getShellType(),
             getCols(), getRows(), getHandle(), getCaption(), 
             getTitle(), getSequence(), getAltBufferActive(), getCwd(), 
-            getZombie(),
+            getZombie(), uiPrefs_.terminalTrackEnvironment().getValue(),
             new ServerRequestCallback<ConsoleProcess>()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -506,6 +506,7 @@ public void startTerminal(
                      boolean altBufferActive,
                      String cwd,
                      boolean zombie,
+                     boolean trackEnv,
                      ServerRequestCallback<ConsoleProcess> requestCallback)
    {
       JSONArray params = new JSONArray();
@@ -519,6 +520,7 @@ public void startTerminal(
       params.set(7, JSONBoolean.getInstance(altBufferActive));
       params.set(8, new JSONString(StringUtil.notNull(cwd)));
       params.set(9, JSONBoolean.getInstance(zombie));
+      params.set(10, JSONBoolean.getInstance(trackEnv));
 
       sendRequest(RPC_SCOPE,
                   START_TERMINAL,

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -152,11 +152,12 @@ void getTerminalShells(
     * @param altBufferActive terminal showing alt-buffer (full-screen ncurses)
     * @param cwd current working directory
     * @param zombie if true, terminal buffer reloaded but no process created
+    * @param trackEnv if true, server runs a hidden command to capture environment variables
     * @param requestCallback callback from server upon completion
     */
    void startTerminal(int shellType, int cols, int rows, String handle, 
                       String caption, String title, int sequence, 
-                      boolean altBufferActive, String cwd, boolean zombie,
+                      boolean altBufferActive, String cwd, boolean zombie, boolean trackEnv,
                       ServerRequestCallback<ConsoleProcess> requestCallback);
    
    void executeCode(String code, ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -128,7 +128,7 @@ public void connect()
       server_.startTerminal(getShellType(),
             getCols(), getRows(), getHandle(), getCaption(), 
             getTitle(), getSequence(), getAltBufferActive(), getCwd(), 
-            getZombie(),
+            getZombie(), uiPrefs_.terminalTrackEnvironment().getValue(),
             new ServerRequestCallback<ConsoleProcess>()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.inject.Provider;
 
 import org.rstudio.core.client.BrowseCap;
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.Size;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.TimeBufferedCommand;

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.inject.Provider;
 
 import org.rstudio.core.client.BrowseCap;
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.Size;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.TimeBufferedCommand;

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.inject.Provider;
 
 import org.rstudio.core.client.BrowseCap;
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.Size;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.TimeBufferedCommand;

File: src/gwt/src/org/rstudio/core/client/files/filedialog/ChooseFolderDialog2.java
Patch:
@@ -25,11 +25,12 @@
 public class ChooseFolderDialog2 extends FileSystemDialog
 {
    public ChooseFolderDialog2(String title,
+                              String label,
                               FileSystemContext context,
                               boolean allowFolderCreation,
                               ProgressOperationWithInput<FileSystemItem> operation)
    {
-      super(title, null, "Choose", context, "", allowFolderCreation, operation);
+      super(title, null, label, context, "", allowFolderCreation, operation);
    }
 
    @Override

File: src/gwt/src/org/rstudio/core/client/files/filedialog/OpenFileDialog.java
Patch:
@@ -23,14 +23,13 @@
 public class OpenFileDialog extends FileDialog
 {
    public OpenFileDialog(String title,
+                         String label,
                          FileSystemContext context,
                          String filter,
                          boolean canChooseDirectories,
                          ProgressOperationWithInput<FileSystemItem> operation)
    {
-      super(title, null, "Open", false, false, false, context, filter, 
-            operation);
-      
+      super(title, null, label, false, false, false, context, filter, operation);
       canChooseDirectories_ = canChooseDirectories;
    }
    

File: src/gwt/src/org/rstudio/core/client/files/filedialog/SaveFileDialog.java
Patch:
@@ -24,12 +24,13 @@
 public class SaveFileDialog extends FileDialog
 {
    public SaveFileDialog(String title,
+                         String buttonLabel,
                          FileSystemContext context,
                          String defaultExtension,
                          boolean forceDefaultExtension,
                          ProgressOperationWithInput<FileSystemItem> operation)
    {
-      super(title, null, "Save", true, true, true, context, "", operation);
+      super(title, null, buttonLabel, true, true, true, context, "", operation);
       defaultExtension_ = defaultExtension;
       forceDefaultExtension_ = forceDefaultExtension;
    }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RStudioGinjector.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -129,7 +129,6 @@
 import org.rstudio.studio.client.workbench.views.terminal.TerminalList;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalPopupMenu;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalSession;
-import org.rstudio.studio.client.workbench.views.terminal.TerminalSessionSocket;
 import org.rstudio.studio.client.workbench.views.source.editors.text.r.SignatureToolTipManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.TextEditingTargetNotebook;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.display.ChunkOptionsPopupPanel;
@@ -231,7 +230,6 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(NewConnectionSnippetHost newConnectionSnippetHost);
    void injectMembers(NewConnectionSnippetDialog newConnectionSnippetDialog);
    void injectMembers(NewPackagePage page);
-   void injectMembers(TerminalSessionSocket socket);
    void injectMembers(NewConnectionInstallPackagePage newConnectionInstallPackagePage);
    void injectMembers(ObjectExplorerEditingTargetWidget widget);
    void injectMembers(ObjectExplorerDataGrid widget);

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -167,6 +167,9 @@ class ClientEvent extends JavaScriptObject
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
    public static final String AdminNotification = "admin_notification";
+   public static final String RequestDocumentSave = "request_document_save";
+   public static final String RequestOpenProject = "request_open_project";
+   public static final String OpenFileDialog = "open_file_dialog";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -121,6 +121,8 @@ void userPromptCompleted(int response,
    
    void adminNotificationAcknowledged(String id, ServerRequestCallback<Void> requestCallback);
    
+   void openFileDialogCompleted(String path, ServerRequestCallback<Void> requestCallback);
+   
    void getTerminalOptions(
                      ServerRequestCallback<TerminalOptions> requestCallback);
   

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AppearancePreferencesPane.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -33,7 +33,6 @@
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.ThemeChangedEvent;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.workbench.prefs.model.RPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceBuildHelper.java
Patch:
@@ -57,7 +57,7 @@ private void withSaveFilesBeforeCommand(final Command command,
    {     
       if (uiPrefs_.saveAllBeforeBuild().getValue())
       {
-         sourceShim_.saveAllUnsaved(command);
+         sourceShim_.saveUnsavedDocuments(command);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -240,4 +240,7 @@ public void extractRmdFromNotebook(String inputPath,
          ServerRequestCallback<SourceDocumentResult> requestCallback);
 
    public void defaultSqlConnectionName(ServerRequestCallback<String> requestCallback);
+   
+   public void requestDocumentSaveCompleted(boolean isSuccessfulSave,
+                                            ServerRequestCallback<Void> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -55,13 +55,15 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Shell:       '" + TerminalShellInfo.getShellName(session.getShellType()) + "'\n");
       diagnostics.append("Handle:      '" + session.getHandle() + "'\n");
       diagnostics.append("Sequence:    '" + session.getSequence() + "'\n");
+      diagnostics.append("Restarted:   '" + session.getRestarted() + "\n");
       diagnostics.append("Busy:        '" + session.getHasChildProcs() + "'\n");
       diagnostics.append("Alt-Buffer:  '" + session.altBufferActive() + "'\n");
       diagnostics.append("Zombie:      '" + session.getZombie() + "'\n");
+      diagnostics.append("Track Env    '" + session.getTrackEnv() + "'\n");
       diagnostics.append("Local-echo:  '" + localEchoEnabled + "'\n"); 
       diagnostics.append("Working Dir: '" + cwd + "'\n"); 
       diagnostics.append("WebSockets:  '" + uiPrefs_.terminalUseWebsockets().getValue() + "'\n");
-      diagnostics.append("Report lag:  '" + uiPrefs_.enableReportTerminalLag().getValue() + "'\n");
+      diagnostics.append("Typing lag:  '" + socket.getTypingLagMsg() + "'\n");
 
       diagnostics.append("\nSystem Information\n------------------\n");
       diagnostics.append("Desktop:    '" + Desktop.isDesktop() + "'\n");

File: src/gwt/src/org/rstudio/core/client/files/filedialog/ChooseFolderDialog2.java
Patch:
@@ -25,11 +25,12 @@
 public class ChooseFolderDialog2 extends FileSystemDialog
 {
    public ChooseFolderDialog2(String title,
+                              String label,
                               FileSystemContext context,
                               boolean allowFolderCreation,
                               ProgressOperationWithInput<FileSystemItem> operation)
    {
-      super(title, null, "Choose", context, "", allowFolderCreation, operation);
+      super(title, null, label, context, "", allowFolderCreation, operation);
    }
 
    @Override

File: src/gwt/src/org/rstudio/core/client/files/filedialog/OpenFileDialog.java
Patch:
@@ -23,14 +23,13 @@
 public class OpenFileDialog extends FileDialog
 {
    public OpenFileDialog(String title,
+                         String label,
                          FileSystemContext context,
                          String filter,
                          boolean canChooseDirectories,
                          ProgressOperationWithInput<FileSystemItem> operation)
    {
-      super(title, null, "Open", false, false, false, context, filter, 
-            operation);
-      
+      super(title, null, label, false, false, false, context, filter, operation);
       canChooseDirectories_ = canChooseDirectories;
    }
    

File: src/gwt/src/org/rstudio/core/client/files/filedialog/SaveFileDialog.java
Patch:
@@ -24,12 +24,13 @@
 public class SaveFileDialog extends FileDialog
 {
    public SaveFileDialog(String title,
+                         String buttonLabel,
                          FileSystemContext context,
                          String defaultExtension,
                          boolean forceDefaultExtension,
                          ProgressOperationWithInput<FileSystemItem> operation)
    {
-      super(title, null, "Save", true, true, true, context, "", operation);
+      super(title, null, buttonLabel, true, true, true, context, "", operation);
       defaultExtension_ = defaultExtension;
       forceDefaultExtension_ = forceDefaultExtension;
    }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -169,6 +169,7 @@ class ClientEvent extends JavaScriptObject
    public static final String AdminNotification = "admin_notification";
    public static final String RequestDocumentSave = "request_document_save";
    public static final String RequestOpenProject = "request_open_project";
+   public static final String OpenFileDialog = "open_file_dialog";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -121,6 +121,8 @@ void userPromptCompleted(int response,
    
    void adminNotificationAcknowledged(String id, ServerRequestCallback<Void> requestCallback);
    
+   void openFileDialogCompleted(String path, ServerRequestCallback<Void> requestCallback);
+   
    void getTerminalOptions(
                      ServerRequestCallback<TerminalOptions> requestCallback);
   

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -55,6 +55,7 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Shell:       '" + TerminalShellInfo.getShellName(session.getShellType()) + "'\n");
       diagnostics.append("Handle:      '" + session.getHandle() + "'\n");
       diagnostics.append("Sequence:    '" + session.getSequence() + "'\n");
+      diagnostics.append("Restarted:   '" + session.getRestarted() + "\n");
       diagnostics.append("Busy:        '" + session.getHasChildProcs() + "'\n");
       diagnostics.append("Alt-Buffer:  '" + session.altBufferActive() + "'\n");
       diagnostics.append("Zombie:      '" + session.getZombie() + "'\n");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -55,6 +55,7 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Shell:       '" + TerminalShellInfo.getShellName(session.getShellType()) + "'\n");
       diagnostics.append("Handle:      '" + session.getHandle() + "'\n");
       diagnostics.append("Sequence:    '" + session.getSequence() + "'\n");
+      diagnostics.append("Restarted:   '" + session.getRestarted() + "\n");
       diagnostics.append("Busy:        '" + session.getHasChildProcs() + "'\n");
       diagnostics.append("Alt-Buffer:  '" + session.altBufferActive() + "'\n");
       diagnostics.append("Zombie:      '" + session.getZombie() + "'\n");

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RStudioGinjector.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -129,7 +129,6 @@
 import org.rstudio.studio.client.workbench.views.terminal.TerminalList;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalPopupMenu;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalSession;
-import org.rstudio.studio.client.workbench.views.terminal.TerminalSessionSocket;
 import org.rstudio.studio.client.workbench.views.source.editors.text.r.SignatureToolTipManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.TextEditingTargetNotebook;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.display.ChunkOptionsPopupPanel;
@@ -231,7 +230,6 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(NewConnectionSnippetHost newConnectionSnippetHost);
    void injectMembers(NewConnectionSnippetDialog newConnectionSnippetDialog);
    void injectMembers(NewPackagePage page);
-   void injectMembers(TerminalSessionSocket socket);
    void injectMembers(NewConnectionInstallPackagePage newConnectionInstallPackagePage);
    void injectMembers(ObjectExplorerEditingTargetWidget widget);
    void injectMembers(ObjectExplorerDataGrid widget);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AppearancePreferencesPane.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -33,7 +33,6 @@
 import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.ThemeChangedEvent;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.workbench.prefs.model.RPrefs;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -62,7 +62,7 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Local-echo:  '" + localEchoEnabled + "'\n"); 
       diagnostics.append("Working Dir: '" + cwd + "'\n"); 
       diagnostics.append("WebSockets:  '" + uiPrefs_.terminalUseWebsockets().getValue() + "'\n");
-      diagnostics.append("Report lag:  '" + uiPrefs_.enableReportTerminalLag().getValue() + "'\n");
+      diagnostics.append("Typing lag:  '" + socket.getTypingLagMsg() + "'\n");
 
       diagnostics.append("\nSystem Information\n------------------\n");
       diagnostics.append("Desktop:    '" + Desktop.isDesktop() + "'\n");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -58,6 +58,7 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Busy:        '" + session.getHasChildProcs() + "'\n");
       diagnostics.append("Alt-Buffer:  '" + session.altBufferActive() + "'\n");
       diagnostics.append("Zombie:      '" + session.getZombie() + "'\n");
+      diagnostics.append("Track Env    '" + session.getTrackEnv() + "'\n");
       diagnostics.append("Local-echo:  '" + localEchoEnabled + "'\n"); 
       diagnostics.append("Working Dir: '" + cwd + "'\n"); 
       diagnostics.append("WebSockets:  '" + uiPrefs_.terminalUseWebsockets().getValue() + "'\n");

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -167,6 +167,8 @@ class ClientEvent extends JavaScriptObject
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
    public static final String AdminNotification = "admin_notification";
+   public static final String RequestDocumentSave = "request_document_save";
+   public static final String RequestOpenProject = "request_open_project";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceBuildHelper.java
Patch:
@@ -57,7 +57,7 @@ private void withSaveFilesBeforeCommand(final Command command,
    {     
       if (uiPrefs_.saveAllBeforeBuild().getValue())
       {
-         sourceShim_.saveAllUnsaved(command);
+         sourceShim_.saveUnsavedDocuments(command);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -240,4 +240,7 @@ public void extractRmdFromNotebook(String inputPath,
          ServerRequestCallback<SourceDocumentResult> requestCallback);
 
    public void defaultSqlConnectionName(ServerRequestCallback<String> requestCallback);
+   
+   public void requestDocumentSaveCompleted(boolean isSuccessfulSave,
+                                            ServerRequestCallback<Void> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -167,6 +167,8 @@ class ClientEvent extends JavaScriptObject
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
    public static final String AdminNotification = "admin_notification";
+   public static final String RequestDocumentSave = "request_document_save";
+   public static final String RequestOpenProject = "request_open_project";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceBuildHelper.java
Patch:
@@ -57,7 +57,7 @@ private void withSaveFilesBeforeCommand(final Command command,
    {     
       if (uiPrefs_.saveAllBeforeBuild().getValue())
       {
-         sourceShim_.saveAllUnsaved(command);
+         sourceShim_.saveUnsavedDocuments(command);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -240,4 +240,7 @@ public void extractRmdFromNotebook(String inputPath,
          ServerRequestCallback<SourceDocumentResult> requestCallback);
 
    public void defaultSqlConnectionName(ServerRequestCallback<String> requestCallback);
+   
+   public void requestDocumentSaveCompleted(boolean isSuccessfulSave,
+                                            ServerRequestCallback<Void> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/projects/events/RequestOpenProjectEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * RequestOpenProjectActionEvent.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcessInfo.java
Patch:
@@ -65,7 +65,7 @@ public static final native ConsoleProcessInfo createNamedTerminalInfo(
       procInfo.cols = @org.rstudio.studio.client.common.console.ConsoleProcessInfo::DEFAULT_COLS;
       procInfo.rows = @org.rstudio.studio.client.common.console.ConsoleProcessInfo::DEFAULT_ROWS;
       procInfo.restarted = false;
-      procInfo.autoclose = AUTOCLOSE_DEFAULT;
+      procInfo.autoclose = @org.rstudio.studio.client.common.console.ConsoleProcessInfo::AUTOCLOSE_DEFAULT;
       procInfo.zombie = false;
 
       return procInfo;

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcessInfo.java
Patch:
@@ -65,7 +65,7 @@ public static final native ConsoleProcessInfo createNamedTerminalInfo(
       procInfo.cols = @org.rstudio.studio.client.common.console.ConsoleProcessInfo::DEFAULT_COLS;
       procInfo.rows = @org.rstudio.studio.client.common.console.ConsoleProcessInfo::DEFAULT_ROWS;
       procInfo.restarted = false;
-      procInfo.autoclose = AUTOCLOSE_DEFAULT;
+      procInfo.autoclose = @org.rstudio.studio.client.common.console.ConsoleProcessInfo::AUTOCLOSE_DEFAULT;
       procInfo.zombie = false;
 
       return procInfo;

File: src/gwt/src/org/rstudio/core/client/widget/RStudioThemedFrame.java
Patch:
@@ -113,8 +113,9 @@ private void addThemesStyle(String customStyle, String urlStyle, boolean removeB
          {
             if (removeBodyStyle) body.removeAttribute("style");
             
-            String themeName = RStudioGinjector.INSTANCE.getUIPrefs().getFlatTheme().getValue();
-            RStudioThemes.initializeThemes(themeName, document, document.getBody());
+            RStudioThemes.initializeThemes(
+              RStudioGinjector.INSTANCE.getUIPrefs(),
+              document, document.getBody());
             
             body.addClassName("ace_editor_theme");
          }

File: src/gwt/src/org/rstudio/core/client/widget/ScrollableToolbarPopupMenu.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.gwt.event.logical.shared.SelectionHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.user.client.ui.*;
+
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
@@ -62,9 +63,9 @@ public int getSelectedIndex()
    }
 
    @Override
-   protected Widget wrapMenuBar(ToolbarMenuBar menuBar)
+   protected Widget createMainWidget()
    {
-      scrollPanel_ = new ScrollPanel(menuBar);
+      scrollPanel_ = new ScrollPanel(menuBar_);
       scrollPanel_.addStyleName(ThemeStyles.INSTANCE.scrollableMenuBar());
       scrollPanel_.getElement().getStyle().setOverflowY(Overflow.AUTO);
       scrollPanel_.getElement().getStyle().setOverflowX(Overflow.HIDDEN);

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -97,7 +97,6 @@
 import org.rstudio.studio.client.shiny.ui.ShinyApplicationWindow;
 import org.rstudio.studio.client.vcs.VCSApplicationView;
 import org.rstudio.studio.client.vcs.ui.VCSApplicationWindow;
-import org.rstudio.studio.client.workbench.AddinsMRUList;
 import org.rstudio.studio.client.workbench.ClientStateUpdater;
 import org.rstudio.studio.client.workbench.WorkbenchContext;
 import org.rstudio.studio.client.workbench.WorkbenchListManager;
@@ -276,7 +275,6 @@ protected void configure()
       bind(UserCommandManager.class).in(Singleton.class);
       bind(ApplicationCommandManager.class).in(Singleton.class);
       bind(CodeSearchLauncher.class).in(Singleton.class);
-      bind(AddinsMRUList.class).asEagerSingleton();
       bind(AceEditorCommandDispatcher.class).asEagerSingleton();
       bind(DataImportPresenter.class).in(Singleton.class);
       bind(MathJaxLoader.class).asEagerSingleton();

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -36,6 +36,7 @@
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.ThemeChangedEvent;
+import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;
 import org.rstudio.studio.client.common.satellite.events.AllSatellitesClosingEvent;
 import org.rstudio.studio.client.common.satellite.events.SatelliteClosedEvent;
@@ -474,7 +475,7 @@ private void registerAsSatellite(final String name, JavaScriptObject wnd)
 
       // set themes
       events_.fireEventToSatellite(new ThemeChangedEvent(
-         pUIPrefs_.get().getFlatTheme().getGlobalValue()),
+         RStudioThemes.getThemeFromUiPrefs(pUIPrefs_.get())),
          satelliteWnd);
    }
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -166,6 +166,7 @@ class ClientEvent extends JavaScriptObject
    public static final String CreateNamedTerminal = "create_named_terminal";
    public static final String ActivateTerminal = "activate_terminal";
    public static final String TerminalCwd = "terminal_cwd";
+   public static final String AdminNotification = "admin_notification";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ObjectBrowser.java
Patch:
@@ -171,7 +171,7 @@ public interface Resources extends CellTree.Resources {
       @Source("CollapseIcon_2x.png")
       ImageResource cellTreeOpenItem();
       
-      @Source({CellTree.Style.DEFAULT_CSS, "TableBrowser.css"})
+      @Source({CellTree.Style.DEFAULT_CSS, "ObjectBrowser.css"})
       public Style cellTreeStyle();   
       
       public interface Style extends CellTree.Style

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/History.java
Patch:
@@ -54,7 +54,6 @@
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleResetHistoryEvent;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleResetHistoryHandler;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
-import org.rstudio.studio.client.workbench.views.history.History.Display.Mode;
 import org.rstudio.studio.client.workbench.views.history.events.FetchCommandsEvent;
 import org.rstudio.studio.client.workbench.views.history.events.FetchCommandsHandler;
 import org.rstudio.studio.client.workbench.views.history.events.HistoryEntriesAddedEvent;
@@ -416,8 +415,6 @@ public void onSelected()
    {
       super.onSelected();
       view_.focusSearch();
-      if (view_.getMode() == Mode.Recent)
-         view_.scrollToBottom();
    }
 
    private String getSelectedCommands()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/view/ObjectExplorerDataGrid.java
Patch:
@@ -571,7 +571,7 @@ public ObjectExplorerDataGrid(ObjectExplorerHandle handle,
       addColumn(typeColumn_, new ResizableHeader(this, "Type"));
       
       valueColumn_ = new IdentityColumn<Data>(new ValueCell());
-      addColumn(valueColumn_, new ResizableHeader(this, "Column"));
+      addColumn(valueColumn_, new ResizableHeader(this, "Value"));
       
       initializeColumnWidths();
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1678,7 +1678,7 @@ public boolean moveSelectionToBlankLine()
 
       while (curRow < getSession().getLength())
       {
-         String line = getSession().getLine(curRow);
+         String line = getSession().getLine(curRow).trim();
          if (line.length() == 0)
          {
             getSession().getSelection().moveCursorTo(curRow, 0, false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3964,6 +3964,9 @@ else if (content.trim().startsWith("@"))
          finalOutput.deleteCharAt(finalOutput.length()-1);
 
       String reflowed = finalOutput.toString();
+      
+      // Remove trailing whitespace that might have leaked in earlier
+      reflowed = reflowed.replaceAll("\\s+\\n", "\n");
 
       docDisplay_.setSelection(selection);
       if (!reflowed.equals(code))

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextUi.java
Patch:
@@ -229,9 +229,9 @@ private ChunkOptionsPopupPanel createPopupPanel()
       
       String engine = getEngine(row);
       if (!engine.toLowerCase().equals("r"))
-         return new CustomEngineChunkOptionsPopupPanel();
+         return new CustomEngineChunkOptionsPopupPanel(engine_);
       
-      return new DefaultChunkOptionsPopupPanel();
+      return new DefaultChunkOptionsPopupPanel(engine_);
    }
 
    private final TextEditingTarget target_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/NotebookHtmlRenderer.java
Patch:
@@ -156,7 +156,7 @@ private void createNotebookDeferred(final String rmdPath,
                                        final String outputPath)
    {
       dependencyManager_.withUnsatisfiedDependencies(
-            Dependency.embeddedPackage("rmarkdown"),
+            Dependency.cranPackage("rmarkdown", "1.6"),
             new ServerRequestCallback<JsArray<Dependency>>()
             {
                @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/ChunkOptionsPopupPanel.java
Patch:
@@ -245,6 +245,7 @@ else if (value.equals(OUTPUT_SKIP_THIS_CHUNK))
             "Use paged tables",
             "paged.print");
       panel_.add(printTableAsTextCb_);
+      printTableAsTextCb_.setVisible(false);
       
       useCustomFigureCheckbox_ = new ThemedCheckBox("Use custom figure size");
       useCustomFigureCheckbox_.addStyleName(RES.styles().checkBox());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/CustomEngineChunkOptionsPopupPanel.java
Patch:
@@ -16,9 +16,9 @@
 
 public class CustomEngineChunkOptionsPopupPanel extends DefaultChunkOptionsPopupPanel
 {
-   public CustomEngineChunkOptionsPopupPanel()
+   public CustomEngineChunkOptionsPopupPanel(String engine)
    {
-      super();
+      super(engine);
       
       showWarningsInOutputCb_.setVisible(false);
       showMessagesInOutputCb_.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -57,6 +57,7 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Sequence:    '" + session.getSequence() + "'\n");
       diagnostics.append("Busy:        '" + session.getHasChildProcs() + "'\n");
       diagnostics.append("Alt-Buffer:  '" + session.altBufferActive() + "'\n");
+      diagnostics.append("Zombie:      '" + session.getZombie() + "'\n");
       diagnostics.append("Local-echo:  '" + localEchoEnabled + "'\n"); 
       diagnostics.append("Working Dir: '" + cwd + "'\n"); 
       diagnostics.append("WebSockets:  '" + uiPrefs_.terminalUseWebsockets().getValue() + "'\n");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -113,6 +113,7 @@ public void execute()
          addItem(commands_.previousTerminal().createMenuItem(false));
          addItem(commands_.nextTerminal().createMenuItem(false));
          addSeparator();
+         addItem(commands_.interruptTerminal().createMenuItem(false));
          addItem(commands_.clearTerminalScrollbackBuffer().createMenuItem(false));
          addItem(commands_.closeTerminal().createMenuItem(false));
       }
@@ -158,7 +159,7 @@ public void setActiveTerminal(String caption, String handle)
       commands_.renameTerminal().setEnabled(haveActiveTerminal);
       commands_.clearTerminalScrollbackBuffer().setEnabled(haveActiveTerminal);
       commands_.showTerminalInfo().setEnabled(haveActiveTerminal);
-
+      commands_.interruptTerminal().setEnabled(haveActiveTerminal);
       commands_.previousTerminal().setEnabled(getPreviousTerminalHandle() != null);
       commands_.nextTerminal().setEnabled(getNextTerminalHandle() != null);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalShellInfo.java
Patch:
@@ -35,6 +35,7 @@ public class TerminalShellInfo extends JavaScriptObject
    // -- End Windows-only	
    
    public static final int SHELL_POSIX_BASH = 7;
+   public static final int SHELL_CUSTOM = 8;
 
    protected TerminalShellInfo() {}
 
@@ -66,9 +67,10 @@ public static String getShellName(int shell)
          return "PowerShell (64-bit)";
       case SHELL_POSIX_BASH:
          return "Bash";
+      case SHELL_CUSTOM:
+         return "Custom";
       default:
          return "Unknown";
       }
    }
-   
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTab.java
Patch:
@@ -70,6 +70,9 @@ public abstract static class Shim
 
       @Handler
       public abstract void onShowTerminalInfo();
+      
+      @Handler
+      public abstract void onInterruptTerminal();
 
       abstract void initialize();
       abstract void confirmClose(Command onConfirmed);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/HistoryBranchToolbarButton.java
Patch:
@@ -46,6 +46,8 @@ public void onVcsRefresh(VcsRefreshEvent event)
    @Override
    protected void onBeforePopulateMenu(ToolbarPopupMenu rootMenu)
    {
+      super.onBeforePopulateMenu(rootMenu);
+      
       String label = "(all branches)";
       rootMenu.addItem(
             new MenuItem(label, new SwitchBranchCommand(label, "--all")));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPane.java
Patch:
@@ -87,6 +87,7 @@ protected Toolbar createMainToolbar()
       toolbar.addRightSeparator();
       
       toolbar.addRightWidget(switchBranchToolbarButton_);
+      switchBranchToolbarButton_.setRightAlignMenu(true);
       
       toolbar.addRightSeparator();
       

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -213,11 +213,11 @@ public static List<Dependency> rmarkdownDependencies()
       deps.add(Dependency.cranPackage("htmltools", "0.3.5"));
       deps.add(Dependency.cranPackage("caTools", "1.14"));
       deps.add(Dependency.cranPackage("bitops", "1.0-6"));
-      deps.add(Dependency.cranPackage("knitr", "1.14", true));
+      deps.add(Dependency.cranPackage("knitr", "1.14"));
       deps.add(Dependency.cranPackage("jsonlite", "0.9.19"));
       deps.add(Dependency.cranPackage("base64enc", "0.1-3"));
       deps.add(Dependency.cranPackage("rprojroot", "1.0"));
-      deps.add(Dependency.embeddedPackage("rmarkdown"));
+      deps.add(Dependency.cranPackage("rmarkdown", "1.6"));
       return deps;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/NotebookHtmlRenderer.java
Patch:
@@ -156,7 +156,7 @@ private void createNotebookDeferred(final String rmdPath,
                                        final String outputPath)
    {
       dependencyManager_.withUnsatisfiedDependencies(
-            Dependency.embeddedPackage("rmarkdown"),
+            Dependency.cranPackage("rmarkdown", "1.6"),
             new ServerRequestCallback<JsArray<Dependency>>()
             {
                @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextUi.java
Patch:
@@ -229,9 +229,9 @@ private ChunkOptionsPopupPanel createPopupPanel()
       
       String engine = getEngine(row);
       if (!engine.toLowerCase().equals("r"))
-         return new CustomEngineChunkOptionsPopupPanel();
+         return new CustomEngineChunkOptionsPopupPanel(engine_);
       
-      return new DefaultChunkOptionsPopupPanel();
+      return new DefaultChunkOptionsPopupPanel(engine_);
    }
 
    private final TextEditingTarget target_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/ChunkOptionsPopupPanel.java
Patch:
@@ -245,6 +245,7 @@ else if (value.equals(OUTPUT_SKIP_THIS_CHUNK))
             "Use paged tables",
             "paged.print");
       panel_.add(printTableAsTextCb_);
+      printTableAsTextCb_.setVisible(false);
       
       useCustomFigureCheckbox_ = new ThemedCheckBox("Use custom figure size");
       useCustomFigureCheckbox_.addStyleName(RES.styles().checkBox());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/CustomEngineChunkOptionsPopupPanel.java
Patch:
@@ -16,9 +16,9 @@
 
 public class CustomEngineChunkOptionsPopupPanel extends DefaultChunkOptionsPopupPanel
 {
-   public CustomEngineChunkOptionsPopupPanel()
+   public CustomEngineChunkOptionsPopupPanel(String engine)
    {
-      super();
+      super(engine);
       
       showWarningsInOutputCb_.setVisible(false);
       showMessagesInOutputCb_.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextUi.java
Patch:
@@ -229,9 +229,9 @@ private ChunkOptionsPopupPanel createPopupPanel()
       
       String engine = getEngine(row);
       if (!engine.toLowerCase().equals("r"))
-         return new CustomEngineChunkOptionsPopupPanel();
+         return new CustomEngineChunkOptionsPopupPanel(engine_);
       
-      return new DefaultChunkOptionsPopupPanel();
+      return new DefaultChunkOptionsPopupPanel(engine_);
    }
 
    private final TextEditingTarget target_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/ChunkOptionsPopupPanel.java
Patch:
@@ -245,6 +245,7 @@ else if (value.equals(OUTPUT_SKIP_THIS_CHUNK))
             "Use paged tables",
             "paged.print");
       panel_.add(printTableAsTextCb_);
+      printTableAsTextCb_.setVisible(false);
       
       useCustomFigureCheckbox_ = new ThemedCheckBox("Use custom figure size");
       useCustomFigureCheckbox_.addStyleName(RES.styles().checkBox());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/display/CustomEngineChunkOptionsPopupPanel.java
Patch:
@@ -16,9 +16,9 @@
 
 public class CustomEngineChunkOptionsPopupPanel extends DefaultChunkOptionsPopupPanel
 {
-   public CustomEngineChunkOptionsPopupPanel()
+   public CustomEngineChunkOptionsPopupPanel(String engine)
    {
-      super();
+      super(engine);
       
       showWarningsInOutputCb_.setVisible(false);
       showMessagesInOutputCb_.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdTemplateData.java
Patch:
@@ -111,7 +111,7 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             },
             {
             option_name: "df_print",
-            option_ui_name: "Print dataframes as:",
+            option_ui_name: "Print dataframes as",
             option_format: "html_document",
             option_type: "choice", 
             option_nullable: false,

File: src/gwt/src/org/rstudio/studio/client/application/ui/RStudioThemes.java
Patch:
@@ -96,7 +96,7 @@ public static String getThemeFromUiPrefs(UIPrefs prefs) {
       );
    }
    
-   private static boolean usesScrollbars() {
+   public static boolean usesScrollbars() {
       if (usesScrollbars_ != null) return usesScrollbars_;
       
       if (!BrowseCap.isMacintosh()) {

File: src/gwt/src/org/rstudio/studio/client/application/ui/RStudioThemes.java
Patch:
@@ -96,7 +96,7 @@ public static String getThemeFromUiPrefs(UIPrefs prefs) {
       );
    }
    
-   private static boolean usesScrollbars() {
+   public static boolean usesScrollbars() {
       if (usesScrollbars_ != null) return usesScrollbars_;
       
       if (!BrowseCap.isMacintosh()) {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -135,6 +135,7 @@ protected Toolbar createMainToolbar()
       toolbar.addRightWidget(interruptButton_);
 
       closeButton_ = commands_.closeTerminal().createToolbarButton();
+      closeButton_.addStyleName("rstudio-themes-inverts");
       toolbar.addRightWidget(closeButton_);
 
       updateTerminalToolbar();

File: src/gwt/src/org/rstudio/studio/client/application/ui/RStudioThemes.java
Patch:
@@ -77,6 +77,8 @@ public static boolean isEditorDark() {
    }
 
    public static String suggestThemeFromAceTheme(String aceTheme, String rstudioTheme) {
+      if (rstudioTheme == "classic") return rstudioTheme;
+
       RegExp keyReg = RegExp.compile(
          "ambiance|chaos|clouds midnight|cobalt|idle fingers|kr theme|" +
          "material|merbivore soft|merbivore|mono industrial|monokai|" +

File: src/gwt/src/org/rstudio/studio/client/application/ui/RStudioThemes.java
Patch:
@@ -77,6 +77,8 @@ public static boolean isEditorDark() {
    }
 
    public static String suggestThemeFromAceTheme(String aceTheme, String rstudioTheme) {
+      if (rstudioTheme == "classic") return rstudioTheme;
+
       RegExp keyReg = RegExp.compile(
          "ambiance|chaos|clouds midnight|cobalt|idle fingers|kr theme|" +
          "material|merbivore soft|merbivore|mono industrial|monokai|" +

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/HistoryBranchToolbarButton.java
Patch:
@@ -46,6 +46,8 @@ public void onVcsRefresh(VcsRefreshEvent event)
    @Override
    protected void onBeforePopulateMenu(ToolbarPopupMenu rootMenu)
    {
+      super.onBeforePopulateMenu(rootMenu);
+      
       String label = "(all branches)";
       rootMenu.addItem(
             new MenuItem(label, new SwitchBranchCommand(label, "--all")));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPane.java
Patch:
@@ -87,6 +87,7 @@ protected Toolbar createMainToolbar()
       toolbar.addRightSeparator();
       
       toolbar.addRightWidget(switchBranchToolbarButton_);
+      switchBranchToolbarButton_.setRightAlignMenu(true);
       
       toolbar.addRightSeparator();
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/HistoryBranchToolbarButton.java
Patch:
@@ -46,6 +46,8 @@ public void onVcsRefresh(VcsRefreshEvent event)
    @Override
    protected void onBeforePopulateMenu(ToolbarPopupMenu rootMenu)
    {
+      super.onBeforePopulateMenu(rootMenu);
+      
       String label = "(all branches)";
       rootMenu.addItem(
             new MenuItem(label, new SwitchBranchCommand(label, "--all")));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPane.java
Patch:
@@ -87,6 +87,7 @@ protected Toolbar createMainToolbar()
       toolbar.addRightSeparator();
       
       toolbar.addRightWidget(switchBranchToolbarButton_);
+      switchBranchToolbarButton_.setRightAlignMenu(true);
       
       toolbar.addRightSeparator();
       

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -480,7 +480,7 @@ public void execute(EditorKeyBindings bindings)
          @Override
          public void execute(EditorKeyBindings bindings)
          {
-            events_.fireEvent(new AddinsKeyBindingsChangedEvent(bindings));
+            events_.fireEventToAllSatellites(new AddinsKeyBindingsChangedEvent(bindings));
          }
       });
       

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -77,6 +77,7 @@
 import org.rstudio.studio.client.vcs.VCSApplication;
 import org.rstudio.studio.client.workbench.BrowseAddinsDialog;
 import org.rstudio.studio.client.workbench.addins.Addins.AddinExecutor;
+import org.rstudio.studio.client.workbench.addins.AddinsCommandManager;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.RemoteFileSystemContext;
 import org.rstudio.studio.client.workbench.model.Session;
@@ -272,4 +273,5 @@ public interface RStudioGinjector extends Ginjector
    ChunkWindowManager getChunkWindowManager();
    ProjectTemplateRegistryProvider getProjectTemplateRegistryProvider();
    AceThemes getAceThemes();
+   AddinsCommandManager getAddinsCommandManager();
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -505,6 +505,7 @@ public void startTerminal(
                      int sequence,
                      boolean altBufferActive,
                      String cwd,
+                     boolean zombie,
                      ServerRequestCallback<ConsoleProcess> requestCallback)
    {
       JSONArray params = new JSONArray();
@@ -517,6 +518,7 @@ public void startTerminal(
       params.set(6, new JSONNumber(sequence));
       params.set(7, JSONBoolean.getInstance(altBufferActive));
       params.set(8, new JSONString(StringUtil.notNull(cwd)));
+      params.set(9, JSONBoolean.getInstance(zombie));
 
       sendRequest(RPC_SCOPE,
                   START_TERMINAL,

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -149,11 +149,12 @@ void getTerminalShells(
     * @param sequence relative order of terminal creation (1-based)
     * @param altBufferActive terminal showing alt-buffer (full-screen ncurses)
     * @param cwd current working directory
+    * @param zombie if true, terminal buffer reloaded but no process created
     * @param requestCallback callback from server upon completion
     */
    void startTerminal(int shellType, int cols, int rows, String handle, 
                       String caption, String title, int sequence, 
-                      boolean altBufferActive, String cwd,
+                      boolean altBufferActive, String cwd, boolean zombie,
                       ServerRequestCallback<ConsoleProcess> requestCallback);
    
    void executeCode(String code, ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -57,6 +57,7 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("Sequence:    '" + session.getSequence() + "'\n");
       diagnostics.append("Busy:        '" + session.getHasChildProcs() + "'\n");
       diagnostics.append("Alt-Buffer:  '" + session.altBufferActive() + "'\n");
+      diagnostics.append("Zombie:      '" + session.getZombie() + "'\n");
       diagnostics.append("Local-echo:  '" + localEchoEnabled + "'\n"); 
       diagnostics.append("Working Dir: '" + cwd + "'\n"); 
       diagnostics.append("WebSockets:  '" + uiPrefs_.terminalUseWebsockets().getValue() + "'\n");

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcessInfo.java
Patch:
@@ -32,7 +32,7 @@ public class ConsoleProcessInfo extends JavaScriptObject
    
    public static final int AUTOCLOSE_DEFAULT = 0;
    public static final int AUTOCLOSE_ALWAYS = 1;
-   public static final int AUTOCLOSE_NEVER = 0;
+   public static final int AUTOCLOSE_NEVER = 2;
    
    protected ConsoleProcessInfo() {}
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSessionSocket.java
Patch:
@@ -391,7 +391,8 @@ public void unregisterHandlers()
    public void disconnect(boolean permanent)
    {
       diagnostic(permanent ? "Permanently Disconnected" : "Disconnected");
-      socket_.close();
+      if (socket_ != null)
+         socket_.close();
       socket_ = null;
       registrations_.removeHandler();
       if (permanent)

File: src/gwt/src/org/rstudio/core/client/widget/RStudioThemedFrame.java
Patch:
@@ -113,8 +113,9 @@ private void addThemesStyle(String customStyle, String urlStyle, boolean removeB
          {
             if (removeBodyStyle) body.removeAttribute("style");
             
-            String themeName = RStudioGinjector.INSTANCE.getUIPrefs().getFlatTheme().getValue();
-            RStudioThemes.initializeThemes(themeName, document, document.getBody());
+            RStudioThemes.initializeThemes(
+              RStudioGinjector.INSTANCE.getUIPrefs(),
+              document, document.getBody());
             
             body.addClassName("ace_editor_theme");
          }

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -620,7 +620,7 @@ public void onSessionAbendWarning(SessionAbendWarningEvent event)
    @Override
    public void onThemeChanged(ThemeChangedEvent event)
    {
-      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getValue(),
+      RStudioThemes.initializeThemes(uiPrefs_.get(),
                                      Document.get(),
                                      rootPanel_.getElement());
    }
@@ -717,7 +717,7 @@ private String absoluteUrl(String relativeUrl, boolean includeContext)
    
    private void initializeWorkbench()
    {
-      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getValue(),
+      RStudioThemes.initializeThemes(uiPrefs_.get(),
                                      Document.get(),
                                      rootPanel_.getElement());
 

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -36,6 +36,7 @@
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.ThemeChangedEvent;
+import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;
 import org.rstudio.studio.client.common.satellite.events.AllSatellitesClosingEvent;
 import org.rstudio.studio.client.common.satellite.events.SatelliteClosedEvent;
@@ -474,7 +475,7 @@ private void registerAsSatellite(final String name, JavaScriptObject wnd)
 
       // set themes
       events_.fireEventToSatellite(new ThemeChangedEvent(
-         pUIPrefs_.get().getFlatTheme().getGlobalValue()),
+         RStudioThemes.getThemeFromUiPrefs(pUIPrefs_.get())),
          satelliteWnd);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -655,8 +655,7 @@ public PrefValue<Boolean> wrapTabNavigation()
 
    public PrefValue<String> getFlatTheme()
    {
-      String flatTheme = RStudioThemes.suggestThemeFromAceTheme(theme().getValue());
-      return string("flat_theme", flatTheme);
+      return string("flat_theme", "default");
    }
    
    public PrefValue<Boolean> gitDiffIgnoreWhitespace()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3964,6 +3964,9 @@ else if (content.trim().startsWith("@"))
          finalOutput.deleteCharAt(finalOutput.length()-1);
 
       String reflowed = finalOutput.toString();
+      
+      // Remove trailing whitespace that might have leaked in earlier
+      reflowed = reflowed.replaceAll("\\s+\\n", "\n");
 
       docDisplay_.setSelection(selection);
       if (!reflowed.equals(code))

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/BranchToolbarButton.java
Patch:
@@ -95,7 +95,8 @@ public BranchToolbarButton(final Provider<GitState> pVcsState)
    {
       super("",
             StandardIcons.INSTANCE.empty_command(),
-            new ScrollableToolbarPopupMenu());
+            new ScrollableToolbarPopupMenu(),
+            true);
       pVcsState_ = pVcsState;
 
       setTitle("Switch branch");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalLocalEcho.java
Patch:
@@ -99,7 +99,6 @@ public void write(String output)
             // server as some sort of output optimization. In both cases we
             // remove the backspace from the localEcho buffer so matching
             // doesn't break at this point.
-            // handling here.
             String popped = localEcho_.pop();
             if (!popped.equals("\b"))
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/History.java
Patch:
@@ -54,7 +54,6 @@
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleResetHistoryEvent;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleResetHistoryHandler;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
-import org.rstudio.studio.client.workbench.views.history.History.Display.Mode;
 import org.rstudio.studio.client.workbench.views.history.events.FetchCommandsEvent;
 import org.rstudio.studio.client.workbench.views.history.events.FetchCommandsHandler;
 import org.rstudio.studio.client.workbench.views.history.events.HistoryEntriesAddedEvent;
@@ -416,8 +415,6 @@ public void onSelected()
    {
       super.onSelected();
       view_.focusSearch();
-      if (view_.getMode() == Mode.Recent)
-         view_.scrollToBottom();
    }
 
    private String getSelectedCommands()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/History.java
Patch:
@@ -54,7 +54,6 @@
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleResetHistoryEvent;
 import org.rstudio.studio.client.workbench.views.console.events.ConsoleResetHistoryHandler;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
-import org.rstudio.studio.client.workbench.views.history.History.Display.Mode;
 import org.rstudio.studio.client.workbench.views.history.events.FetchCommandsEvent;
 import org.rstudio.studio.client.workbench.views.history.events.FetchCommandsHandler;
 import org.rstudio.studio.client.workbench.views.history.events.HistoryEntriesAddedEvent;
@@ -416,8 +415,6 @@ public void onSelected()
    {
       super.onSelected();
       view_.focusSearch();
-      if (view_.getMode() == Mode.Recent)
-         view_.scrollToBottom();
    }
 
    private String getSelectedCommands()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalShellInfo.java
Patch:
@@ -35,6 +35,7 @@ public class TerminalShellInfo extends JavaScriptObject
    // -- End Windows-only	
    
    public static final int SHELL_POSIX_BASH = 7;
+   public static final int SHELL_CUSTOM = 8;
 
    protected TerminalShellInfo() {}
 
@@ -66,9 +67,10 @@ public static String getShellName(int shell)
          return "PowerShell (64-bit)";
       case SHELL_POSIX_BASH:
          return "Bash";
+      case SHELL_CUSTOM:
+         return "Custom";
       default:
          return "Unknown";
       }
    }
-   
 }

File: src/gwt/src/org/rstudio/core/client/widget/ScrollableToolbarPopupMenu.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.gwt.event.logical.shared.SelectionHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.user.client.ui.*;
+
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
@@ -62,9 +63,9 @@ public int getSelectedIndex()
    }
 
    @Override
-   protected Widget wrapMenuBar(ToolbarMenuBar menuBar)
+   protected Widget createMainWidget()
    {
-      scrollPanel_ = new ScrollPanel(menuBar);
+      scrollPanel_ = new ScrollPanel(menuBar_);
       scrollPanel_.addStyleName(ThemeStyles.INSTANCE.scrollableMenuBar());
       scrollPanel_.getElement().getStyle().setOverflowY(Overflow.AUTO);
       scrollPanel_.getElement().getStyle().setOverflowX(Overflow.HIDDEN);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1678,7 +1678,7 @@ public boolean moveSelectionToBlankLine()
 
       while (curRow < getSession().getLength())
       {
-         String line = getSession().getLine(curRow);
+         String line = getSession().getLine(curRow).trim();
          if (line.length() == 0)
          {
             getSession().getSelection().moveCursorTo(curRow, 0, false);

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -392,6 +392,7 @@
    public abstract AppCommand previousTerminal();
    public abstract AppCommand nextTerminal();
    public abstract AppCommand showTerminalInfo();
+   public abstract AppCommand interruptTerminal();
     
    // Help
    public abstract AppCommand helpBack();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPopupMenu.java
Patch:
@@ -113,6 +113,7 @@ public void execute()
          addItem(commands_.previousTerminal().createMenuItem(false));
          addItem(commands_.nextTerminal().createMenuItem(false));
          addSeparator();
+         addItem(commands_.interruptTerminal().createMenuItem(false));
          addItem(commands_.clearTerminalScrollbackBuffer().createMenuItem(false));
          addItem(commands_.closeTerminal().createMenuItem(false));
       }
@@ -158,7 +159,7 @@ public void setActiveTerminal(String caption, String handle)
       commands_.renameTerminal().setEnabled(haveActiveTerminal);
       commands_.clearTerminalScrollbackBuffer().setEnabled(haveActiveTerminal);
       commands_.showTerminalInfo().setEnabled(haveActiveTerminal);
-
+      commands_.interruptTerminal().setEnabled(haveActiveTerminal);
       commands_.previousTerminal().setEnabled(getPreviousTerminalHandle() != null);
       commands_.nextTerminal().setEnabled(getNextTerminalHandle() != null);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTab.java
Patch:
@@ -70,6 +70,9 @@ public abstract static class Shim
 
       @Handler
       public abstract void onShowTerminalInfo();
+      
+      @Handler
+      public abstract void onInterruptTerminal();
 
       abstract void initialize();
       abstract void confirmClose(Command onConfirmed);

File: src/gwt/src/org/rstudio/core/client/widget/ScrollableToolbarPopupMenu.java
Patch:
@@ -62,9 +62,9 @@ public int getSelectedIndex()
    }
 
    @Override
-   protected Widget createMainWidget(Widget widget)
+   protected Widget createMainWidget()
    {
-      scrollPanel_ = new ScrollPanel(widget);
+      scrollPanel_ = new ScrollPanel(menuBar_);
       scrollPanel_.addStyleName(ThemeStyles.INSTANCE.scrollableMenuBar());
       scrollPanel_.getElement().getStyle().setOverflowY(Overflow.AUTO);
       scrollPanel_.getElement().getStyle().setOverflowX(Overflow.HIDDEN);

File: src/gwt/src/org/rstudio/core/client/widget/CheckableMenuItem.java
Patch:
@@ -3,6 +3,7 @@
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
+import org.rstudio.core.client.theme.res.ThemeStyles;
 
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.ScheduledCommand;
@@ -43,11 +44,11 @@ public void onStateChanged()
    
    private String getHTMLContent()
    {
-      return AppCommand.formatMenuLabel(
+      return AppCommand.formatMenuLabelWithStyle(
             isChecked() ? 
                   new ImageResource2x(ThemeResources.INSTANCE.menuCheck2x()) :
                   null,
-            getLabel(), "");
+            getLabel(), "", ThemeStyles.INSTANCE.menuCheckable());
       
    }
 }

File: src/gwt/src/org/rstudio/studio/client/application/ui/RStudioThemes.java
Patch:
@@ -39,7 +39,7 @@ public static void initializeThemes(String themeName,
       element.removeClassName("rstudio-themes-dark-grey");
       element.removeClassName("rstudio-themes-alternate");
       element.removeClassName("rstudio-themes-scrollbars");
-      element.removeClassName("rstudio-themes-dark-menus");
+      document.getBody().removeClassName("rstudio-themes-dark-menus");
       
       if (themeName == "default" || themeName == "dark-grey" || themeName == "alternate") {         
          document.getBody().addClassName("rstudio-themes-flat");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -2009,7 +2009,8 @@ public void setShowIndentGuides(boolean show)
 
    public void setBlinkingCursor(boolean blinking)
    {
-      widget_.getEditor().getRenderer().setBlinkingCursor(blinking);
+      String style = blinking ? "ace" : "wide";
+      widget_.getEditor().setCursorStyle(style);
    }
 
    public void setShowPrintMargin(boolean on)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * AceEditorWidget.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -42,7 +42,6 @@
 import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.widget.FontSizer;
-import org.rstudio.core.client.widget.events.SelectionChangedEvent;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.Value;

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -489,7 +489,7 @@ public boolean execute()
                      break;
                   case ConsoleAction.ERROR:
                      canContinue = output(action.getData(),
-                                          styles_.error(),
+                                          getErrorClass(),
                                           true);
                      break;
                   case ConsoleAction.PROMPT:

File: src/gwt/src/org/rstudio/studio/client/projects/model/RProjectConfig.java
Patch:
@@ -77,7 +77,7 @@ public native final int getQuitChildProcessesOnExit() /*-{
       return this.quit_child_processes_on_exit;
    }-*/;  
    
-   public native final int setQuitChildProcessesOnExit(int quitChildProcessesOnExit) /*-{
+   public native final void setQuitChildProcessesOnExit(int quitChildProcessesOnExit) /*-{
       this.quit_child_processes_on_exit = quitChildProcessesOnExit;
    }-*/;  
    

File: src/gwt/src/org/rstudio/core/client/theme/ThemeColors.java
Patch:
@@ -48,4 +48,5 @@ public class ThemeColors
 
    public static String darkRowSelected                            = "rgba(255, 255, 255, 0.15)";
    public static String darkRowFocused                             = "rgba(255, 255, 255, 0.20)";
+   public static String darkRowHovered                             = "rgba(255, 255, 255, 0.05)";
 }

File: src/gwt/src/org/rstudio/core/client/layout/AnimationHelper.java
Patch:
@@ -53,12 +53,12 @@ else if (bottom.getState() == WindowState.HIDE)
       }
       else if (top.getState() == WindowState.MINIMIZE)
       {
-         splitterPos = top.getMinimized().getDesiredHeight();
+         splitterPos = top.getMinimized().getDesiredHeight() - splitterHeight / 2;
          splitterPosFromTop = true;
       }
       else if (bottom.getState() == WindowState.MINIMIZE)
       {
-         splitterPos = bottom.getMinimized().getDesiredHeight();
+         splitterPos = bottom.getMinimized().getDesiredHeight() - splitterHeight / 2;
          splitterPosFromTop = false;
       }
       else

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -620,7 +620,7 @@ public void onSessionAbendWarning(SessionAbendWarningEvent event)
    @Override
    public void onThemeChanged(ThemeChangedEvent event)
    {
-      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getGlobalValue(),
+      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getValue(),
                                      Document.get(),
                                      rootPanel_.getElement());
    }
@@ -717,7 +717,7 @@ private String absoluteUrl(String relativeUrl, boolean includeContext)
    
    private void initializeWorkbench()
    {
-      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getGlobalValue(),
+      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getValue(),
                                      Document.get(),
                                      rootPanel_.getElement());
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.core.client.VirtualConsole;
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.studio.client.application.Desktop;
+import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.notebook.CompileNotebookPrefs;
 import org.rstudio.studio.client.notebookv2.CompileNotebookv2Prefs;
 import org.rstudio.studio.client.rmarkdown.RmdOutput;
@@ -649,7 +650,8 @@ public PrefValue<Boolean> wrapTabNavigation()
 
    public PrefValue<String> getFlatTheme()
    {
-      return string("flat_theme", "classic");
+      String flatTheme = RStudioThemes.suggestThemeFromAceTheme(theme().getValue());
+      return string("flat_theme", flatTheme);
    }
    
    private String getDefaultPdfPreview()

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -165,7 +165,8 @@ class ClientEvent extends JavaScriptObject
    public static final String ClearTerminal = "clear_terminal";
    public static final String CreateNamedTerminal = "create_named_terminal";
    public static final String ActivateTerminal = "activate_terminal";
-
+   public static final String TerminalCwd = "terminal_cwd";
+   
    protected ClientEvent()
    {
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -26,6 +26,7 @@
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.OperationWithInput;
+import org.rstudio.studio.client.ResizableHeader;
 import org.rstudio.studio.client.common.filetypes.FileIconResources;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.workbench.views.files.Files;
@@ -223,7 +224,7 @@ public String getValue(FileSystemItem file)
          } 
       };  
       sizeColumn.setSortable(true);
-      filesDataGrid_.addColumn(sizeColumn, "Size");
+      filesDataGrid_.addColumn(sizeColumn, new ResizableHeader(filesDataGrid_, "Size"));
       filesDataGrid_.setColumnWidth(sizeColumn, SIZE_COLUMN_WIDTH_PIXELS, Unit.PX);
       
       sortHandler_.setComparator(sizeColumn, new FoldersOnBottomComparator() {
@@ -251,7 +252,7 @@ public String getValue(FileSystemItem file)
          } 
       };  
       modColumn.setSortable(true);
-      filesDataGrid_.addColumn(modColumn, "Modified");
+      filesDataGrid_.addColumn(modColumn, new ResizableHeader(filesDataGrid_, "Modified"));
       filesDataGrid_.setColumnWidth(modColumn, MODIFIED_COLUMN_WIDTH_PIXELS, Unit.PX); 
       
       sortHandler_.setComparator(modColumn, new FoldersOnBottomComparator() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -152,17 +152,18 @@ public void removeFindReplace(FindReplaceBar findReplaceBar)
                double initialWidth_ = 0;
                
                @Override
-               public void beginDrag(MouseDownEvent event)
+               public boolean beginDrag(MouseDownEvent event)
                {
                   initialWidth_ = editorPanel_.getWidgetSize(docOutlineWidget_);
+                  return true;
                }
                
                @Override
                public void onDrag(MouseDragEvent event)
                {
                   double initialWidth = initialWidth_;
                   double xDiff = event.getTotalDelta().getMouseX();
-                  double newSize = initialWidth + xDiff;
+                  double newSize = initialWidth - xDiff;
                   
                   // We allow an extra pixel here just to 'hide' the border
                   // if the outline is maximized, since the 'separator'

File: src/gwt/src/org/rstudio/core/client/layout/DualWindowLayoutPanel.java
Patch:
@@ -366,15 +366,16 @@ public DualWindowLayoutPanel(final EventBus eventBus,
                                 Session session,
                                 String clientStateKeyName,
                                 final WindowState topWindowDefaultState,
-                                final int defaultSplitterPos)
+                                final int defaultSplitterPos,
+                                final int splitterSize)
    {
       windowA_ = windowA;
       windowB_ = windowB;
       session_ = session;
       setSize("100%", "100%");
       layout_ = new BinarySplitLayoutPanel(new Widget[] {
             windowA.getNormal(), windowA.getMinimized(),
-            windowB.getNormal(), windowB.getMinimized()}, 3);
+            windowB.getNormal(), windowB.getMinimized()}, splitterSize);
       layout_.setSize("100%", "100%");
 
       topWindowStateChangeManager_ = new WindowStateChangeManager(session);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialogResources.java
Patch:
@@ -29,6 +29,8 @@ public interface Styles extends CssResource
       String usingVcsHelp();
       String newSection();
       String alwaysCompletePanel();
+      String themeInfobar();
+      String themeInfobarShowing();
    }
 
    @Source("PreferencesDialog.css")

File: src/gwt/src/org/rstudio/studio/client/workbench/BrowseAddinsDialog.java
Patch:
@@ -351,7 +351,7 @@ private Label emptyTableLabel(String caption)
    // Resources, etc ----
    public interface Resources extends RStudioDataGridResources
    {
-      @Source({RStudioDataGridStyle.RSTUDIO_DEFAULT_CSS})
+      @Source({RStudioDataGridStyle.RSTUDIO_DEFAULT_CSS, "BrowseAddinsDialog.css"})
       Styles dataGridStyle();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectGrid.java
Patch:
@@ -296,7 +296,8 @@ private void setColumnWidths()
       int start = 0;
       if (selectionEnabled())
       {
-         setColumnWidth(start++, "5%");
+         // Set the column width for the selection (checkbox) column.
+         setColumnWidth(start++, "20px");
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalInfoDialog.java
Patch:
@@ -65,7 +65,8 @@ public TerminalInfoDialog(TerminalSession session, TerminalSessionSocket socket)
       diagnostics.append("\nSystem Information\n------------------\n");
       diagnostics.append("Desktop:    '" + Desktop.isDesktop() + "'\n");
       diagnostics.append("Platform:   '" + BrowseCap.getPlatformName() + "'\n");
-      diagnostics.append("Browser:    '" + BrowseCap.getBrowserName() + "'\n");
+      if (!Desktop.isDesktop())
+         diagnostics.append("Browser:    '" + BrowseCap.getBrowserName() + "'\n");
 
       diagnostics.append("\nConnection Information\n----------------------\n");
       diagnostics.append(socket.getConnectionDiagnostics());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectGrid.java
Patch:
@@ -296,7 +296,8 @@ private void setColumnWidths()
       int start = 0;
       if (selectionEnabled())
       {
-         setColumnWidth(start++, "5%");
+         // Set the column width for the selection (checkbox) column.
+         setColumnWidth(start++, "20px");
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -620,7 +620,7 @@ public void onSessionAbendWarning(SessionAbendWarningEvent event)
    @Override
    public void onThemeChanged(ThemeChangedEvent event)
    {
-      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getGlobalValue(),
+      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getValue(),
                                      Document.get(),
                                      rootPanel_.getElement());
    }
@@ -717,7 +717,7 @@ private String absoluteUrl(String relativeUrl, boolean includeContext)
    
    private void initializeWorkbench()
    {
-      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getGlobalValue(),
+      RStudioThemes.initializeThemes(uiPrefs_.get().getFlatTheme().getValue(),
                                      Document.get(),
                                      rootPanel_.getElement());
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.core.client.VirtualConsole;
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.studio.client.application.Desktop;
+import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.notebook.CompileNotebookPrefs;
 import org.rstudio.studio.client.notebookv2.CompileNotebookv2Prefs;
 import org.rstudio.studio.client.rmarkdown.RmdOutput;
@@ -649,7 +650,8 @@ public PrefValue<Boolean> wrapTabNavigation()
 
    public PrefValue<String> getFlatTheme()
    {
-      return string("flat_theme", "classic");
+      String flatTheme = RStudioThemes.suggestThemeFromAceTheme(theme().getValue());
+      return string("flat_theme", flatTheme);
    }
    
    private String getDefaultPdfPreview()

File: src/gwt/src/org/rstudio/studio/client/ResizableHeader.java
Patch:
@@ -17,7 +17,6 @@
 import java.util.ArrayList;
 import java.util.List;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.SafeHtmlUtil;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
@@ -93,8 +92,6 @@ public ResizableHeader(AbstractCellTable<?> table, String text)
       text_ = text;
       index_ = table.getColumnCount();
       
-      Debug.logToRConsole("Index: " + index_);
-      
       MouseDragHandler.addHandler(table_, new MouseDragHandler()
       {
          List<Integer> columnWidths_ = new ArrayList<Integer>();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -37,7 +37,6 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
-import org.rstudio.studio.client.workbench.views.console.ConsoleResources;
 import org.rstudio.studio.client.workbench.views.terminal.events.SwitchToTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStartedEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStoppedEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -37,7 +37,6 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
-import org.rstudio.studio.client.workbench.views.console.ConsoleResources;
 import org.rstudio.studio.client.workbench.views.terminal.events.SwitchToTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStartedEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStoppedEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -379,7 +379,7 @@ void onCopyFileTo()
       view_.showFilePicker(
                         "Choose Destination", 
                         fileSystemContext_,
-                        currentPath_,
+                        selectedFiles.get(0),
                         new ProgressOperationWithInput<FileSystemItem>() {
 
          public void execute(FileSystemItem targetFile,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -96,16 +96,19 @@ private String getCustomStyle()
          "}\n" +
          "\n" +
          ".rstudio-themes-flat.rstudio-themes-default .profvis-footer,\n" +
+         ".rstudio-themes-flat.rstudio-themes-default .profvis-treetable th,\n" +
          ".rstudio-themes-flat.rstudio-themes-default .profvis-status-bar {\n" +
          "   background-color: " + ThemeColors.defaultBackground + ";\n" +
          "}\n" +
          "\n" +
          ".rstudio-themes-flat.rstudio-themes-dark-grey .profvis-footer,\n" +
+         ".rstudio-themes-flat.rstudio-themes-dark-grey .profvis-treetable th,\n" +
          ".rstudio-themes-flat.rstudio-themes-dark-grey .profvis-status-bar {\n" +
          "   background-color: " + ThemeColors.darkGreyBackground + ";\n" +
          "}\n" +
          "\n" +
          ".rstudio-themes-flat.rstudio-themes-alternate .profvis-footer,\n" +
+         ".rstudio-themes-flat.rstudio-themes-alternate .profvis-treetable th,\n" +
          ".rstudio-themes-flat.rstudio-themes-alternate .profvis-status-bar {\n" +
          "   background-color: " + ThemeColors.alternateBackground + ";\n" +
          "}\n" +

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -96,16 +96,19 @@ private String getCustomStyle()
          "}\n" +
          "\n" +
          ".rstudio-themes-flat.rstudio-themes-default .profvis-footer,\n" +
+         ".rstudio-themes-flat.rstudio-themes-default .profvis-treetable th,\n" +
          ".rstudio-themes-flat.rstudio-themes-default .profvis-status-bar {\n" +
          "   background-color: " + ThemeColors.defaultBackground + ";\n" +
          "}\n" +
          "\n" +
          ".rstudio-themes-flat.rstudio-themes-dark-grey .profvis-footer,\n" +
+         ".rstudio-themes-flat.rstudio-themes-dark-grey .profvis-treetable th,\n" +
          ".rstudio-themes-flat.rstudio-themes-dark-grey .profvis-status-bar {\n" +
          "   background-color: " + ThemeColors.darkGreyBackground + ";\n" +
          "}\n" +
          "\n" +
          ".rstudio-themes-flat.rstudio-themes-alternate .profvis-footer,\n" +
+         ".rstudio-themes-flat.rstudio-themes-alternate .profvis-treetable th,\n" +
          ".rstudio-themes-flat.rstudio-themes-alternate .profvis-status-bar {\n" +
          "   background-color: " + ThemeColors.alternateBackground + ";\n" +
          "}\n" +

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -379,7 +379,7 @@ void onCopyFileTo()
       view_.showFilePicker(
                         "Choose Destination", 
                         fileSystemContext_,
-                        currentPath_,
+                        selectedFiles.get(0),
                         new ProgressOperationWithInput<FileSystemItem>() {
 
          public void execute(FileSystemItem targetFile,

File: src/gwt/src/org/rstudio/core/client/theme/ThemeColors.java
Patch:
@@ -45,4 +45,7 @@ public class ThemeColors
 
    public static String darkControlBackground                      = "rgb(108,121,131)";
    public static String darkControlBorder                          = "rgb(45,60,75)";
+
+   public static String darkRowSelected                            = "rgba(255, 255, 255, 0.15)";
+   public static String darkRowFocused                             = "rgba(255, 255, 255, 0.20)";
 }

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeResources.java
Patch:
@@ -274,6 +274,9 @@ public interface ThemeResources extends ClientBundle
    @Source("radioButtonOn_2x.png")
    DataResource radioButtonOn2x();
 
+   @Source("handCursor.png")
+   DataResource handCursor();
+
    @Source("handCursor_2x.png")
    DataResource handCursor2x();
    

File: src/gwt/src/org/rstudio/core/client/widget/Toolbar.java
Patch:
@@ -341,6 +341,7 @@ private Widget addPopupMenu(final MenuLabel menuLabel,
       image.getElement().getStyle().setMarginLeft(5, Unit.PX);
       image.getElement().getStyle().setMarginRight(8, Unit.PX);
       image.getElement().getStyle().setMarginBottom(2, Unit.PX);
+      image.addStyleName("rstudio-themes-inverts");
       if (left)
          addLeftWidget(image);
       else

File: src/gwt/src/org/rstudio/studio/client/application/ui/RStudioThemes.java
Patch:
@@ -45,7 +45,7 @@ public static void initializeThemes(String themeName,
             element.addClassName("rstudio-themes-dark");
             
             if (usesScrollbars()) {
-               document.getBody().addClassName("rstudio-themes-scrollbars");
+               element.addClassName("rstudio-themes-scrollbars");
             }
          }
          element.addClassName("rstudio-themes-" + themeName);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ObjectBrowser.java
Patch:
@@ -164,7 +164,7 @@ public interface Resources extends CellTree.Resources {
        * An image indicating that a node is loading.
        */
       @ImageOptions(flipRtl = true)
-      @Source("progress.gif")
+      @Source("ExpandingIcon_2x.png")
       ImageResource cellTreeLoading();
     
       @ImageOptions(flipRtl = true)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -127,6 +127,9 @@ public ChunkOutputWidget(String documentId, String chunkId,
          setCollapsedStyles();
 
       ChunkDataWidget.injectPagedTableResources();
+
+      clear_.addStyleName("rstudio-themes-inverts");
+      expand_.addStyleName("rstudio-themes-inverts");
       
       if (chunkOutputSize_ == ChunkOutputSize.Default)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -462,6 +462,8 @@ protected void onComplete()
                }
             });
       
+      toggleDocOutlineButton_.addStyleName("rstudio-themes-inverts");
+
       // Time-out setting the latch just to ensure the document outline
       // has actually been appropriately rendered.
       new Timer()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextToolbar.java
Patch:
@@ -113,6 +113,8 @@ private void initOptions(boolean dark)
       options_.setResource(new ImageResource2x(
          dark ? RES.chunkOptionsDark2x() :
          RES.chunkOptionsLight2x()));
+
+      options_.addStyleName("rstudio-themes-darkens");
       
       DOM.sinkEvents(options_.getElement(), Event.ONCLICK);
       DOM.setEventListener(options_.getElement(), new EventListener()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/status/StatusBarElementWidget.java
Patch:
@@ -115,6 +115,7 @@ public void setShowArrows(boolean showArrows)
          {
             Resources res = GWT.create(Resources.class);
             arrows_ = new Image(new ImageResource2x(res.upDownArrow2x()));
+            arrows_.addStyleName("rstudio-themes-inverts");
             add(arrows_);
          }
          else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -99,7 +99,6 @@ protected TerminalPane(EventBus events,
    protected Widget createMainWidget()
    {
       terminalSessionsPanel_ = new DeckLayoutPanel();
-      terminalSessionsPanel_.setStyleName(ConsoleResources.INSTANCE.consoleStyles().console());
       terminalSessionsPanel_.getElement().addClassName("ace_editor");
       return terminalSessionsPanel_;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -99,7 +99,6 @@ protected TerminalPane(EventBus events,
    protected Widget createMainWidget()
    {
       terminalSessionsPanel_ = new DeckLayoutPanel();
-      terminalSessionsPanel_.setStyleName(ConsoleResources.INSTANCE.consoleStyles().console());
       terminalSessionsPanel_.getElement().addClassName("ace_editor");
       return terminalSessionsPanel_;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -145,10 +145,13 @@ void getTerminalShells(
     * @param caption caption associated with the terminal
     * @param title title associated with the terminal
     * @param sequence relative order of terminal creation (1-based)
+    * @param altBufferActive terminal showing alt-buffer (full-screen ncurses)
+    * @param cwd current working directory
     * @param requestCallback callback from server upon completion
     */
    void startTerminal(int shellType, int cols, int rows, String handle, 
                       String caption, String title, int sequence, 
+                      boolean altBufferActive, String cwd,
                       ServerRequestCallback<ConsoleProcess> requestCallback);
    
    void executeCode(String code, ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/model/ConsoleServerOperations.java
Patch:
@@ -52,6 +52,7 @@ void processSetShellSize(String handle,
                             ServerRequestCallback<Void> requestCallback);
 
    void processEraseBuffer(String handle,
+                           boolean lastLineOnly,
                            ServerRequestCallback<Void> requestCallback);
 
    void processGetBufferChunk(String handle,

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -1062,6 +1062,9 @@ public void onDragStart(DragStartEvent evt)
          if (icon != null) {
             Image tabImage = imageForIcon(icon);
             tabImage.addStyleName(ThemeStyles.INSTANCE.tabIcon());
+            // Trivia: setDraggable(Element.DRAGGABLE_FALSE) sets
+            // "draggable" to "true".
+            tabImage.getElement().setAttribute("draggable", "false");
             contentPanel_.add(tabImage);
          }
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RWebContentFileType.java
Patch:
@@ -72,6 +72,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       result.add(commands.jumpToMatching());
       result.add(commands.goToHelp());
       result.add(commands.goToFunctionDefinition());
+      result.add(commands.insertRoxygenSkeleton());
       return result;
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/SweaveFileType.java
Patch:
@@ -59,6 +59,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       result.add(commands.jumpToMatching());
       result.add(commands.goToHelp());
       result.add(commands.goToFunctionDefinition());
+      result.add(commands.insertRoxygenSkeleton());
       return result;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/RObjectEntry.java
Patch:
@@ -142,7 +142,8 @@ private boolean rObjectHasDataClass()
       
       HIERARCHICAL_CLASSES.addAll(ListUtil.create(
             "list",
-            "environment"
+            "environment",
+            "S4"
       ));
       
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -145,10 +145,13 @@ void getTerminalShells(
     * @param caption caption associated with the terminal
     * @param title title associated with the terminal
     * @param sequence relative order of terminal creation (1-based)
+    * @param altBufferActive terminal showing alt-buffer (full-screen ncurses)
+    * @param cwd current working directory
     * @param requestCallback callback from server upon completion
     */
    void startTerminal(int shellType, int cols, int rows, String handle, 
                       String caption, String title, int sequence, 
+                      boolean altBufferActive, String cwd,
                       ServerRequestCallback<ConsoleProcess> requestCallback);
    
    void executeCode(String code, ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -83,7 +83,7 @@ public void onClick(ClickEvent event)
       
       initWidget(GWT.<Binder>create(Binder.class).createAndBindUi(this));
 
-      addStyleName("ace_editor");
+      addStyleName("ace_editor_theme");
 
       Label tracebackTitle = new Label("Traceback");
       tracebackTitle.addStyleName(style.tracebackHeader());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryPane.java
Patch:
@@ -129,7 +129,7 @@ protected Widget createMainWidget()
    {
       mainPanel_ = new LayoutPanel();
 
-      mainPanel_.addStyleName("ace_editor");
+      mainPanel_.addStyleName("ace_editor_theme");
 
       VerticalPanel vpanel = new VerticalPanel();
       vpanel.setSize("100%", "100%");

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -118,6 +118,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetCppHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetPresentationHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetRMarkdownHelper;
+import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceBackgroundHighlighter;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceEditorBackgroundLinkHighlighter;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionRequest;
@@ -235,6 +236,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(TerminalInfoDialog infoDialog);
    void injectMembers(AceEditorMixins mixins);
    void injectMembers(RStudioThemedFrame frame);
+   void injectMembers(AceBackgroundHighlighter highlighter);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -83,7 +83,7 @@ public void onClick(ClickEvent event)
       
       initWidget(GWT.<Binder>create(Binder.class).createAndBindUi(this));
 
-      addStyleName("ace_editor");
+      addStyleName("ace_editor_theme");
 
       Label tracebackTitle = new Label("Traceback");
       tracebackTitle.addStyleName(style.tracebackHeader());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryPane.java
Patch:
@@ -129,7 +129,7 @@ protected Widget createMainWidget()
    {
       mainPanel_ = new LayoutPanel();
 
-      mainPanel_.addStyleName("ace_editor");
+      mainPanel_.addStyleName("ace_editor_theme");
 
       VerticalPanel vpanel = new VerticalPanel();
       vpanel.setSize("100%", "100%");

File: src/gwt/src/org/rstudio/studio/client/application/ui/RStudioThemes.java
Patch:
@@ -68,7 +68,7 @@ private static boolean usesScrollbars() {
          parent.getStyle().setHeight(100, Unit.PX);
          parent.getStyle().setOverflow(Overflow.AUTO);
          parent.getStyle().setVisibility(Visibility.HIDDEN);
-         parent.getStyle().setPosition(Position.ABSOLUTE);
+         parent.getStyle().setPosition(Position.FIXED);
          parent.getStyle().setLeft(-300, Unit.PX);
          parent.getStyle().setTop(-300, Unit.PX);
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -37,6 +37,7 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
+import org.rstudio.studio.client.workbench.views.console.ConsoleResources;
 import org.rstudio.studio.client.workbench.views.terminal.events.SwitchToTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStartedEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStoppedEvent;
@@ -98,6 +99,8 @@ protected TerminalPane(EventBus events,
    protected Widget createMainWidget()
    {
       terminalSessionsPanel_ = new DeckLayoutPanel();
+      terminalSessionsPanel_.setStyleName(ConsoleResources.INSTANCE.consoleStyles().console());
+      terminalSessionsPanel_.getElement().addClassName("ace_editor");
       return terminalSessionsPanel_;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -37,6 +37,7 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.WorkbenchServerOperations;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
+import org.rstudio.studio.client.workbench.views.console.ConsoleResources;
 import org.rstudio.studio.client.workbench.views.terminal.events.SwitchToTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStartedEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalSessionStoppedEvent;
@@ -98,6 +99,8 @@ protected TerminalPane(EventBus events,
    protected Widget createMainWidget()
    {
       terminalSessionsPanel_ = new DeckLayoutPanel();
+      terminalSessionsPanel_.setStyleName(ConsoleResources.INSTANCE.consoleStyles().console());
+      terminalSessionsPanel_.getElement().addClassName("ace_editor");
       return terminalSessionsPanel_;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalList.java
Patch:
@@ -489,7 +489,7 @@ private void startTerminal(int sequence,
    {
       TerminalSession newSession = new TerminalSession(
             sequence, terminalHandle, caption, title, hasChildProcs, 
-            cols, rows, uiPrefs_.blinkingCursor().getValue(), shellType);
+            cols, rows, uiPrefs_.blinkingCursor().getValue(), true /*focus*/, shellType);
       newSession.connect();
       updateTerminalBusyStatus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermNative.java
Patch:
@@ -157,12 +157,13 @@ public final native void onTitleData(CommandWithArg<String> command) /*-{
     *  
     * @param container HTML element to attach to
     * @param blink <code>true</code> for a blinking cursor, otherwise solid cursor
+    * @param focus <code>true</code> to give terminal focus by default
     * 
     * @return Native Javascript Terminal object wrapped in a <code>JavaScriptObject</code>.
     */
-   public static native XTermNative createTerminal(Element container, boolean blink) /*-{
+   public static native XTermNative createTerminal(Element container, boolean blink, boolean focus) /*-{
       var nativeTerm_ = new $wnd.Terminal({cursorBlink: blink});
-      nativeTerm_.open(container);
+      nativeTerm_.open(container, focus);
       return nativeTerm_;
    }-*/;
 } 
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermWidget.java
Patch:
@@ -69,7 +69,7 @@ public class XTermWidget extends Widget implements RequiresResize,
   /**
     *  Creates an XTermWidget.
     */
-   public XTermWidget(boolean cursorBlink)
+   public XTermWidget(boolean cursorBlink, boolean focus)
    {
       // Create an element to hold the terminal widget
       setElement(Document.get().createDivElement());
@@ -82,7 +82,7 @@ public XTermWidget(boolean cursorBlink)
 
       // Create and attach the native terminal object to this Widget
       attachTheme(XTermThemeResources.INSTANCE.xtermcss());
-      terminal_ = XTermNative.createTerminal(getElement(), cursorBlink);
+      terminal_ = XTermNative.createTerminal(getElement(), cursorBlink, focus);
       terminal_.addClass("ace_editor");
       terminal_.addClass(FontSizer.getNormalFontSizeClass());
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalList.java
Patch:
@@ -489,7 +489,7 @@ private void startTerminal(int sequence,
    {
       TerminalSession newSession = new TerminalSession(
             sequence, terminalHandle, caption, title, hasChildProcs, 
-            cols, rows, uiPrefs_.blinkingCursor().getValue(), shellType);
+            cols, rows, uiPrefs_.blinkingCursor().getValue(), true /*focus*/, shellType);
       newSession.connect();
       updateTerminalBusyStatus();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermNative.java
Patch:
@@ -157,12 +157,13 @@ public final native void onTitleData(CommandWithArg<String> command) /*-{
     *  
     * @param container HTML element to attach to
     * @param blink <code>true</code> for a blinking cursor, otherwise solid cursor
+    * @param focus <code>true</code> to give terminal focus by default
     * 
     * @return Native Javascript Terminal object wrapped in a <code>JavaScriptObject</code>.
     */
-   public static native XTermNative createTerminal(Element container, boolean blink) /*-{
+   public static native XTermNative createTerminal(Element container, boolean blink, boolean focus) /*-{
       var nativeTerm_ = new $wnd.Terminal({cursorBlink: blink});
-      nativeTerm_.open(container);
+      nativeTerm_.open(container, focus);
       return nativeTerm_;
    }-*/;
 } 
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermWidget.java
Patch:
@@ -69,7 +69,7 @@ public class XTermWidget extends Widget implements RequiresResize,
   /**
     *  Creates an XTermWidget.
     */
-   public XTermWidget(boolean cursorBlink)
+   public XTermWidget(boolean cursorBlink, boolean focus)
    {
       // Create an element to hold the terminal widget
       setElement(Document.get().createDivElement());
@@ -82,7 +82,7 @@ public XTermWidget(boolean cursorBlink)
 
       // Create and attach the native terminal object to this Widget
       attachTheme(XTermThemeResources.INSTANCE.xtermcss());
-      terminal_ = XTermNative.createTerminal(getElement(), cursorBlink);
+      terminal_ = XTermNative.createTerminal(getElement(), cursorBlink, focus);
       terminal_.addClass("ace_editor");
       terminal_.addClass(FontSizer.getNormalFontSizeClass());
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -497,7 +497,6 @@ public void startTerminal(
                      String terminalHandle,
                      String caption,
                      String title,
-                     boolean websocket,
                      int sequence,
                      ServerRequestCallback<ConsoleProcess> requestCallback)
    {
@@ -508,8 +507,7 @@ public void startTerminal(
       params.set(3, new JSONString(StringUtil.notNull(terminalHandle)));
       params.set(4, new JSONString(StringUtil.notNull(caption)));
       params.set(5, new JSONString(StringUtil.notNull(title)));
-      params.set(6, JSONBoolean.getInstance(websocket));
-      params.set(7, new JSONNumber(sequence));
+      params.set(6, new JSONNumber(sequence));
 
       sendRequest(RPC_SCOPE,
                   START_TERMINAL,

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -144,12 +144,11 @@ void getTerminalShells(
     * @param handle initial terminal handle (pass empty or null string for new terminal)
     * @param caption caption associated with the terminal
     * @param title title associated with the terminal
-    * @param websocket try to connect via WebSocket
     * @param sequence relative order of terminal creation (1-based)
     * @param requestCallback callback from server upon completion
     */
    void startTerminal(int shellType, int cols, int rows, String handle, 
-                      String caption, String title, boolean websocket, int sequence, 
+                      String caption, String title, int sequence, 
                       ServerRequestCallback<ConsoleProcess> requestCallback);
    
    void executeCode(String code, ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -497,7 +497,6 @@ public void startTerminal(
                      String terminalHandle,
                      String caption,
                      String title,
-                     boolean websocket,
                      int sequence,
                      ServerRequestCallback<ConsoleProcess> requestCallback)
    {
@@ -508,8 +507,7 @@ public void startTerminal(
       params.set(3, new JSONString(StringUtil.notNull(terminalHandle)));
       params.set(4, new JSONString(StringUtil.notNull(caption)));
       params.set(5, new JSONString(StringUtil.notNull(title)));
-      params.set(6, JSONBoolean.getInstance(websocket));
-      params.set(7, new JSONNumber(sequence));
+      params.set(6, new JSONNumber(sequence));
 
       sendRequest(RPC_SCOPE,
                   START_TERMINAL,

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -144,12 +144,11 @@ void getTerminalShells(
     * @param handle initial terminal handle (pass empty or null string for new terminal)
     * @param caption caption associated with the terminal
     * @param title title associated with the terminal
-    * @param websocket try to connect via WebSocket
     * @param sequence relative order of terminal creation (1-based)
     * @param requestCallback callback from server upon completion
     */
    void startTerminal(int shellType, int cols, int rows, String handle, 
-                      String caption, String title, boolean websocket, int sequence, 
+                      String caption, String title, int sequence, 
                       ServerRequestCallback<ConsoleProcess> requestCallback);
    
    void executeCode(String code, ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/JavaScriptEventHistory.java
Patch:
@@ -41,8 +41,8 @@ protected EventData()
       public static final native EventData create(NativeEvent event)
       /*-{
          return {
-            "type"   : event.type,
-            "button" : event.button
+            "type"   : event.type   || "",
+            "button" : event.button || 0
          };
       }-*/;
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -2810,10 +2810,7 @@ private void openFile(final FileSystemItem file,
       
       // begin queue processing if it's the only work in the queue
       if (openFileQueue_.size() == 1)
-      {
-         Debug.devlog("initiate queue process");
          processOpenFileQueue();
-      }
    }
    
    private void processOpenFileQueue()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -83,6 +83,8 @@ public void onClick(ClickEvent event)
       
       initWidget(GWT.<Binder>create(Binder.class).createAndBindUi(this));
 
+      addStyleName("ace_editor");
+
       Label tracebackTitle = new Label("Traceback");
       tracebackTitle.addStyleName(style.tracebackHeader());
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -122,6 +122,7 @@ protected Toolbar createMainToolbar()
    protected SecondaryToolbar createSecondaryToolbar()
    {
       secondaryToolbar_ = new SecondaryToolbar(true);
+      secondaryToolbar_.getWrapper().addStyleName(ThemeStyles.INSTANCE.tallerToolbarWrapper());
        
       return secondaryToolbar_;
    }

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileDialogStyles.java
Patch:
@@ -39,4 +39,6 @@ public interface FileDialogStyles extends CssResource
    String columnName();
    String columnSize();
    String columnDate();
+
+   String fadeWrapper();
 }

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -191,4 +191,5 @@ public interface ThemeStyles extends CssResource
    String tallerToolbarWrapper();
    String toolbarWrapper();
    String webGlobalToolbarWrapper();
+   String desktopGlobalToolbarWrapper();
 }

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -180,6 +180,7 @@ public void onShowFolder(ShowFolderEvent event)
                                    events, 
                                    pCodeSearch);
       ThemeStyles styles = ThemeResources.INSTANCE.themeStyles(); 
+      toolbar_.getWrapper().addStyleName(styles.desktopGlobalToolbarWrapper());
       toolbar_.addStyleName(styles.desktopGlobalToolbar());
    }
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ClientEvent.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -161,6 +161,8 @@ class ClientEvent extends JavaScriptObject
    public static final String RStudioAPIShowDialog = "rstudioapi_show_dialog";
    public static final String RStudioAPIShowDialogCompleted = "rstudioapi_show_dialog_completed";
    public static final String ObjectExplorerEvent = "object_explorer_event";
+   public static final String SendToTerminal = "send_to_terminal";
+   public static final String ClearTerminal = "clear_terminal";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceSatelliteWindow.java
Patch:
@@ -133,7 +133,7 @@ public Widget getWidget()
    }
 
    @Override
-   public boolean suportsThemes()
+   public boolean supportsThemes()
    {
       return true;
    }

File: src/gwt/src/org/rstudio/studio/client/application/events/ThemeChangedEvent.java
Patch:
@@ -17,7 +17,6 @@
 import org.rstudio.core.client.js.JavaScriptSerializable;
 
 import com.google.gwt.event.shared.EventHandler;
-import com.google.gwt.event.shared.GwtEvent;
 
 @JavaScriptSerializable
 public class ThemeChangedEvent extends CrossWindowEvent<ThemeChangedEvent.Handler>

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SatelliteManager.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -36,7 +36,6 @@
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.ThemeChangedEvent;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;
 import org.rstudio.studio.client.common.satellite.events.AllSatellitesClosingEvent;
 import org.rstudio.studio.client.common.satellite.events.SatelliteClosedEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DataImportDialog.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -19,7 +19,6 @@
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.studio.client.RStudioGinjector;
-import org.rstudio.studio.client.common.HelpLink;
 
 import com.google.gwt.user.client.ui.Widget;
 

File: src/gwt/src/org/rstudio/studio/client/application/events/ThemeChangedEvent.java
Patch:
@@ -17,7 +17,6 @@
 import org.rstudio.core.client.js.JavaScriptSerializable;
 
 import com.google.gwt.event.shared.EventHandler;
-import com.google.gwt.event.shared.GwtEvent;
 
 @JavaScriptSerializable
 public class ThemeChangedEvent extends CrossWindowEvent<ThemeChangedEvent.Handler>

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * SatelliteManager.java
  *
- * Copyright (C) 2009-15 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -36,7 +36,6 @@
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.ThemeChangedEvent;
-import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;
 import org.rstudio.studio.client.common.satellite.events.AllSatellitesClosingEvent;
 import org.rstudio.studio.client.common.satellite.events.SatelliteClosedEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportDialog.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * DataImportDialog.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -19,7 +19,6 @@
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.studio.client.RStudioGinjector;
-import org.rstudio.studio.client.common.HelpLink;
 
 import com.google.gwt.user.client.ui.Widget;
 

File: src/gwt/src/org/rstudio/core/client/theme/WindowFrame.java
Patch:
@@ -198,6 +198,9 @@ public void setMainWidget(Widget widget)
             ensureHeightRegistration_ =
                ((HasEnsureHeightHandlers)main_).addEnsureHeightHandler(this);
          }
+         
+         final ThemeStyles styles = ThemeResources.INSTANCE.themeStyles();
+         main_.addStyleName(styles.windowFrameWidget());
 
          frame_.add(main_);
          frame_.setWidgetLeftRight(

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -129,6 +129,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.TextEditingTargetNotebook;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.display.ChunkOptionsPopupPanel;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.display.SetupChunkOptionsPopupPanel;
+import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;
 import org.rstudio.studio.client.workbench.views.vcs.svn.SVNCommandHandler;
 import org.rstudio.studio.client.workbench.views.environment.ClearAllDialog;
 import org.rstudio.studio.client.workbench.views.environment.dataimport.DataImport;
@@ -262,4 +263,5 @@ public interface RStudioGinjector extends Ginjector
    Server getServer();
    ChunkWindowManager getChunkWindowManager();
    ProjectTemplateRegistryProvider getProjectTemplateRegistryProvider();
+   AceThemes getAceThemes();
 }

File: src/gwt/src/org/rstudio/studio/client/application/events/ApplicationEventHandlers.java
Patch:
@@ -27,6 +27,7 @@ public interface ApplicationEventHandlers extends LogoutRequestedHandler,
                                                   ClientDisconnectedHandler,
                                                   InvalidClientVersionHandler,
                                                   ServerOfflineHandler,
-                                                  InvalidSessionEvent.Handler
+                                                  InvalidSessionEvent.Handler,
+                                                  ThemeChangedEvent.Handler
 {
 }

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -35,6 +35,7 @@
 import org.rstudio.studio.client.application.model.UpdateCheckResult;
 import org.rstudio.studio.client.application.ui.ApplicationHeader;
 import org.rstudio.studio.client.application.ui.GlobalToolbar;
+import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.debugging.ErrorManager;
 import org.rstudio.studio.client.events.EditEvent;
@@ -116,7 +117,7 @@ public void onSessionInit(SessionInitEvent sie)
          {
             final SessionInfo sessionInfo = session.getSessionInfo();
             
-            isFlatTheme_ = pUIPrefs_.get().getUseFlatThemes().getValue(); 
+            isFlatTheme_ = RStudioThemes.isFlat(pUIPrefs_.get()); 
             toolbar_.completeInitialization(sessionInfo);
             
             new JSObjectStateValue(

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -197,4 +197,7 @@ public interface FileIconResources extends ClientBundle
    
    @Source("iconStan_2x.png")
    ImageResource iconStan2x();
+   
+   @Source("iconObjectExplorer_2x.png")
+   ImageResource iconObjectExplorer2x();
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ObjectExplorerFileType.java
Patch:
@@ -22,10 +22,9 @@ public class ObjectExplorerFileType extends EditableFileType
 {
    public ObjectExplorerFileType()
    {
-      // TODO: need image icon for explorer
       super("object_explorer",
             "Object Explorer",
-            new ImageResource2x(FileIconResources.INSTANCE.iconMermaid2x()));
+            new ImageResource2x(FileIconResources.INSTANCE.iconObjectExplorer2x()));
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -924,7 +924,7 @@ private DualWindowLayoutPanel createSplitWindow(LogicalWindow top,
    private LogicalWindow createConsole()
    {
       PrimaryWindowFrame frame = new PrimaryWindowFrame("Console", null);
-
+      
       ToolbarButton goToWorkingDirButton =
             commands_.goToWorkingDir().createToolbarButton();
       goToWorkingDirButton.addStyleName(
@@ -947,6 +947,8 @@ private LogicalWindow createConsole()
             eventBus_,
             goToWorkingDirButton);
       
+      consoleTabPanel_.addLayoutStyles(frame.getElement());
+      
       return logicalWindow;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -92,6 +92,7 @@ public ConnectionsPane(Commands commands, EventBus eventBus)
       
       // create main panel
       mainPanel_ = new LayoutPanel();
+      mainPanel_.addStyleName("ace_editor_theme");
       
       // create data grid
       keyProvider_ = new ProvidesKey<Connection>() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -28,6 +28,7 @@
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
 import org.rstudio.studio.client.application.events.EventBus;
+import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.ImageMenuItem;
 import org.rstudio.studio.client.common.icons.StandardIcons;
@@ -154,7 +155,7 @@ public void onValueChange(ValueChangeEvent<String> event)
          }
       });
 
-      if (!prefs_.getUseFlatThemes().getValue()) {
+      if (!RStudioThemes.isFlat(prefs_)) {
          searchWidget.getElement().getStyle().setMarginTop(1, Unit.PX);
       }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesPane.java
Patch:
@@ -291,6 +291,7 @@ protected Widget createMainWidget()
       DockLayoutPanel dockPanel = new DockLayoutPanel(Unit.PX);
       dockPanel.addNorth(filePathToolbar_, filePathToolbar_.getHeight());
       dockPanel.add(filesList_);
+      dockPanel.addStyleName("ace_editor_theme");
       
       // return container
       return dockPanel;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilePathToolbar.java
Patch:
@@ -29,6 +29,7 @@
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.studio.client.RStudioGinjector;
+import org.rstudio.studio.client.application.ui.RStudioThemes;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 import org.rstudio.studio.client.workbench.views.files.Files;
 
@@ -70,7 +71,7 @@ public FilePathToolbar(Files.Display.NavigationObserver navigationObserver)
       UIPrefs uiPrefs = RStudioGinjector.INSTANCE.getUIPrefs();
       
       LayoutPanel layout = new LayoutPanel();
-      String layoutPanelHeight = uiPrefs.getUseFlatThemes().getValue() ? "20px" : "21px";
+      String layoutPanelHeight = RStudioThemes.isFlat(uiPrefs) ? "20px" : "21px";
       layout.setSize("100%", layoutPanelHeight);
 
       initWidget(layout);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -101,8 +101,10 @@ public void onResize(ResizeEvent event)
    protected Widget createMainWidget()
    {
       frame_ = new RStudioFrame();
+      frame_.setAceTheme();
       frame_.setSize("100%", "100%");
       frame_.setStylePrimaryName("rstudio-HelpFrame");
+      frame_.addStyleName("ace_editor_theme");
       ElementIds.assignElementId(frame_.getElement(), ElementIds.HELP_FRAME);
 
       return new AutoGlassPanel(frame_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryPane.java
Patch:
@@ -129,6 +129,8 @@ protected Widget createMainWidget()
    {
       mainPanel_ = new LayoutPanel();
 
+      mainPanel_.addStyleName("ace_editor");
+
       VerticalPanel vpanel = new VerticalPanel();
       vpanel.setSize("100%", "100%");
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -322,6 +322,7 @@ protected Widget createMainWidget()
    {
       packagesDataProvider_ = new ListDataProvider<PackageInfo>();
       packagesTableContainer_ = new LayoutPanel();
+      packagesTableContainer_.addStyleName("ace_editor_theme");
       return packagesTableContainer_;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -110,6 +110,7 @@ public void onResponseReceived(String rpubsHtmlFile)
    protected Widget createMainWidget()
    {
       panel_ = new LayoutPanel();
+      panel_.addStyleName("ace_editor_theme");
       panel_.setSize("100%", "100%");
 
       frame_ = new ImageFrame();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/ObjectExplorerEditingTarget.java
Patch:
@@ -91,7 +91,7 @@ public String getPath()
    @Override
    public ImageResource getIcon()
    {
-      return new ImageResource2x(FileIconResources.INSTANCE.iconCsv2x());
+      return new ImageResource2x(FileIconResources.INSTANCE.iconObjectExplorer2x());
    }
 
    private ObjectExplorerHandle getHandle()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/explorer/ObjectExplorerServerOperations.java
Patch:
@@ -27,7 +27,7 @@ void explorerInspectObject(
          String objectName,
          String objectAccess,
          JsArrayString tags,
-         int recursionDepth,
+         int fromIndex,
          ServerRequestCallback<ObjectExplorerInspectionResult> requestCallback);
    
    void explorerBeginInspect(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkSatelliteWindow.java
Patch:
@@ -119,7 +119,7 @@ public void onOutputHeightChanged(ChunkOutputWidget widget,
 
       chunkOutputWidget_.getElement().getStyle().setHeight(100, Unit.PCT);
 
-      mainPanel.addStyleName("ace_editor");
+      mainPanel.addStyleName("ace_editor_theme");
 
       pEventBus_.get().addHandler(ChunkSatelliteCodeExecutingEvent.TYPE, this);
       pEventBus_.get().addHandler(ChunkSatelliteCacheEditorStyleEvent.TYPE, this);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -455,6 +455,7 @@ protected void onUpdate(double progress)
                      @Override
                      protected void onComplete()
                      {
+                        if (destination == 0) editorPanel_.setWidgetSize(docOutlineWidget_, 0);
                         target_.setPreferredOutlineWidgetVisibility(destination != 0);
                      }
                   }.run(500);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/findreplace/FindReplaceBar.java
Patch:
@@ -64,6 +64,7 @@ public FindReplaceBar(boolean showReplace, final boolean defaultForward)
       
       Shelf shelf = new Shelf(true);
       shelf.setWidth("100%");
+      shelf.addStyleName("rstudio-themes-background"); 
 
       VerticalPanel panel = new VerticalPanel();
       ElementIds.assignElementId(panel.getElement(), 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -140,8 +140,10 @@ public String getTitle()
    @Override 
    protected Widget createMainWidget()
    {
-      frame_ = new RStudioFrame() ;
+      frame_ = new RStudioFrame();
+      frame_.setAceTheme();
       frame_.setSize("100%", "100%");
+      frame_.addStyleName("ace_editor_theme");
       navigate(ABOUT_BLANK, false);
       return new AutoGlassPanel(frame_);
    }

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -40,8 +40,8 @@
  */
 public class VirtualConsole
 {
-   // don't do any processing of ANSI escape codes
-    private final static int ANSI_COLOR_UNSET = -1;
+   // use preference to determine ANSI color behavior
+   private final static int ANSI_COLOR_UNSET = -1;
 
    // don't do any processing of ANSI escape codes
    public final static int ANSI_COLOR_OFF = 0;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -983,7 +983,6 @@ public void onOpenObjectExplorerEvent(OpenObjectExplorerEvent event)
       if (!SourceWindowManager.isMainSourceWindow())
          return;
     
-      Debug.logToRConsole("Opening object explorer");
       ObjectExplorerHandle handle = event.getHandle();
       
       // attempt to open pre-existing tab

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedWindowFrame.java
Patch:
@@ -54,6 +54,7 @@ public MinimizedWindowFrame(String title, Widget extraWidget)
 
       layout_ = new ClickDockLayoutPanel(Style.Unit.PX);
       layout_.setStylePrimaryName(themeStyles.minimizedWindow());
+      layout_.addStyleName(themeStyles.minimizedWindowObject());
 
       int leftPadding = title != null ? 8 : 4;
       layout_.addWest(createDiv(themeStyles.left()), leftPadding);

File: src/gwt/src/org/rstudio/core/client/theme/WindowFrame.java
Patch:
@@ -84,6 +84,7 @@ public void onClick(ClickEvent event)
 
       frame_ = new LayoutPanel();
       frame_.setStylePrimaryName(styles.windowframe());
+      frame_.addStyleName(styles.windowFrameObject());
 
       frame_.add(borderPositioner_);
       frame_.setWidgetTopBottom(borderPositioner_, 0, Style.Unit.PX,

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -176,4 +176,7 @@ public interface ThemeStyles extends CssResource
    
    String displayNone();
    String logoAnchor();
+
+   String windowFrameObject();
+   String minimizedWindowObject();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -242,7 +242,7 @@ public void onError(ServerError error)
    @Override
    public void receivedOutput(String output)
    {
-      socket_.dispatchOutput(output, uiPrefs_.terminalLocalEcho().getValue()); 
+      socket_.dispatchOutput(output, doLocalEcho());
    }
 
    @Override

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.StringUtilTests;
 import org.rstudio.core.client.dom.DomUtilsTests;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalLocalEchoTests;
+import org.rstudio.studio.client.workbench.views.terminal.TerminalSessionSocketTests;
 
 import com.google.gwt.junit.tools.GWTTestSuite;
 
@@ -35,6 +36,7 @@ public static Test suite()
         suite.addTestSuite(DomUtilsTests.class);
         suite.addTestSuite(AnsiCodeTests.class);
         suite.addTestSuite(TerminalLocalEchoTests.class);
+        suite.addTestSuite(TerminalSessionSocketTests.class);
         return suite;
     }
 }

File: src/gwt/src/org/rstudio/core/client/theme/MinimizedWindowFrame.java
Patch:
@@ -54,6 +54,7 @@ public MinimizedWindowFrame(String title, Widget extraWidget)
 
       layout_ = new ClickDockLayoutPanel(Style.Unit.PX);
       layout_.setStylePrimaryName(themeStyles.minimizedWindow());
+      layout_.addStyleName(themeStyles.minimizedWindowObject());
 
       int leftPadding = title != null ? 8 : 4;
       layout_.addWest(createDiv(themeStyles.left()), leftPadding);

File: src/gwt/src/org/rstudio/core/client/theme/WindowFrame.java
Patch:
@@ -84,6 +84,7 @@ public void onClick(ClickEvent event)
 
       frame_ = new LayoutPanel();
       frame_.setStylePrimaryName(styles.windowframe());
+      frame_.addStyleName(styles.windowFrameObject());
 
       frame_.add(borderPositioner_);
       frame_.setWidgetTopBottom(borderPositioner_, 0, Style.Unit.PX,

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -176,4 +176,7 @@ public interface ThemeStyles extends CssResource
    
    String displayNone();
    String logoAnchor();
+
+   String windowFrameObject();
+   String minimizedWindowObject();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionsServerOperations.java
Patch:
@@ -55,4 +55,7 @@ void installSpark(String sparkVersion,
    void launchEmbeddedShinyConnectionUI(String packageName,
                                         String connectionName,
                                         ServerRequestCallback<RResult<Void>> serverRequestCallback);
+
+   void connectionTest(String code, 
+                       ServerRequestCallback<String> callback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -76,8 +76,11 @@ public TerminalSession(int sequence,
                           boolean hasChildProcs,
                           int cols,
                           int rows,
+                          boolean cursorBlink,
                           int shellType)
    {
+      super(cursorBlink);
+      
       RStudioGinjector.INSTANCE.injectMembers(this);
       sequence_ = sequence;
       terminalHandle_ = handle;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermWidget.java
Patch:
@@ -69,7 +69,7 @@ public class XTermWidget extends Widget implements RequiresResize,
   /**
     *  Creates an XTermWidget.
     */
-   public XTermWidget()
+   public XTermWidget(boolean cursorBlink)
    {
       // Create an element to hold the terminal widget
       setElement(Document.get().createDivElement());
@@ -82,7 +82,7 @@ public XTermWidget()
 
       // Create and attach the native terminal object to this Widget
       attachTheme(XTermThemeResources.INSTANCE.xtermcss());
-      terminal_ = XTermNative.createTerminal(getElement(), true);
+      terminal_ = XTermNative.createTerminal(getElement(), cursorBlink);
       terminal_.addClass("ace_editor");
       terminal_.addClass(FontSizer.getNormalFontSizeClass());
 

File: src/gwt/src/org/rstudio/core/client/AnsiCode.java
Patch:
@@ -565,7 +565,7 @@ private void resetBackground()
 
    // RegEx to match ansi escape codes copied from https://github.com/chalk/ansi-regex
    public static final String ANSI_REGEX = 
-         "[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-PRZcf-nqry=><]";
+         "[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-PRZcf-nqry=><@]";
    
    // Match both console-supported control characters and ansi escape sequences
    public static final Pattern ESC_CONTROL_PATTERN =

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSessionSocket.java
Patch:
@@ -299,6 +299,8 @@ public void dispatchInput(int inputSequence,
    {
       if (localEcho)
          localEcho_.echo(input);
+      else
+         localEcho_.clear();
 
       switch (consoleProcess_.getChannelMode())
       {

File: src/gwt/src/org/rstudio/core/client/AnsiCode.java
Patch:
@@ -13,13 +13,12 @@
  *
  */
 
-package org.rstudio.studio.client.workbench.views.terminal;
+package org.rstudio.core.client;
 
 import java.util.Iterator;
 import java.util.LinkedHashSet;
 import java.util.Set;
 
-import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.regex.Pattern;
 
 /**

File: src/gwt/src/org/rstudio/core/client/VirtualConsole.java
Patch:
@@ -26,7 +26,6 @@
 import org.rstudio.core.client.regex.Match;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
-import org.rstudio.studio.client.workbench.views.terminal.AnsiCode;
 
 import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.dom.client.Document;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalLocalEcho.java
Patch:
@@ -16,6 +16,7 @@
 
 import java.util.LinkedList;
 
+import org.rstudio.core.client.AnsiCode;
 import org.rstudio.core.client.StringSink;
 import org.rstudio.core.client.regex.Match;
 import org.rstudio.core.client.regex.Pattern;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.workbench.views.terminal;
 
+import org.rstudio.core.client.AnsiCode;
 import org.rstudio.core.client.BrowseCap;
 import org.rstudio.core.client.HandlerRegistrations;
 import org.rstudio.core.client.StringUtil;

File: src/gwt/test/org/rstudio/core/client/AnsiCodeTests.java
Patch:
@@ -12,8 +12,9 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
-package org.rstudio.studio.client.workbench.views.terminal;
+package org.rstudio.core.client;
 
+import org.rstudio.core.client.AnsiCode;
 import org.rstudio.core.client.regex.Match;
 import org.rstudio.core.client.regex.Pattern;
 

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -15,9 +15,9 @@
 package org.rstudio.studio.client;
 
 import org.rstudio.studio.client.common.r.RTokenizerTests;
+import org.rstudio.core.client.AnsiCodeTests;
 import org.rstudio.core.client.StringUtilTests;
 import org.rstudio.core.client.dom.DomUtilsTests;
-import org.rstudio.studio.client.workbench.views.terminal.AnsiCodeTests;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalLocalEchoTests;
 
 import com.google.gwt.junit.tools.GWTTestSuite;

File: src/gwt/test/org/rstudio/studio/client/VirtualConsoleTests.java
Patch:
@@ -14,8 +14,8 @@
  */
 package org.rstudio.studio.client;
 
+import org.rstudio.core.client.AnsiCode;
 import org.rstudio.core.client.VirtualConsole;
-import org.rstudio.studio.client.workbench.views.terminal.AnsiCode;
 
 import com.google.gwt.dom.client.Document;
 import com.google.gwt.dom.client.PreElement;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/AnsiCode.java
Patch:
@@ -562,13 +562,13 @@ private void resetBackground()
    }
 
    // Control characters handled by R console
-   private static final String CONTROL_REGEX = "[\r\b\f\n]";
+   public static final String CONTROL_REGEX = "[\r\b\f\n]";
 
    // RegEx to match ansi escape codes copied from https://github.com/chalk/ansi-regex
-   private static final String ANSI_REGEX = 
+   public static final String ANSI_REGEX = 
          "[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-PRZcf-nqry=><]";
    
-   // Match both console control characters and ansi escape sequences
+   // Match both console-supported control characters and ansi escape sequences
    public static final Pattern ESC_CONTROL_PATTERN =
          Pattern.create("(?:" + CONTROL_REGEX + ")|(?:" + ANSI_REGEX + ")");
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalLocalEcho.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * TerminalSessionSocket.java
+ * TerminalLocalEcho.java
  *
  * Copyright (C) 2009-17 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/AnsiCode.java
Patch:
@@ -354,7 +354,7 @@ else if (codeVal == HIDDEN)
          }
          else if (codeVal == HIDDEN_OFF)
          {
-            clazzes_.remove(HIDDEN_OFF);
+            clazzes_.remove(HIDDEN_STYLE);
          }
          else if (codeVal == STRIKETHROUGH)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetHost.java
Patch:
@@ -183,6 +183,7 @@ private Grid createParameterizedUI(final NewConnectionInfo info)
             TextArea textarea = new TextArea();
             textarea.setVisibleLines(7);
             textarea.addStyleName(RES.styles().textarea());
+            textarea.setText(snippetParts.get(idxParams).getValue());
             connGrid.setWidget(idxRow, 1, textarea);
             textboxBase = textarea;
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -299,6 +299,7 @@ public AceEditor()
       backgroundTokenizer_ = new BackgroundTokenizer(this);
       vim_ = new Vim(this);
       bgLinkHighlighter_ = new AceEditorBackgroundLinkHighlighter(this);
+      bgChunkHighlighter_ = new AceBackgroundHighlighter(this);
       
       widget_.addValueChangeHandler(new ValueChangeHandler<Void>()
       {
@@ -3862,6 +3863,7 @@ public void execute(double timestamp)
    private boolean showChunkOutputInline_ = false;
    private BackgroundTokenizer backgroundTokenizer_;
    private final Vim vim_;
+   private final AceBackgroundHighlighter bgChunkHighlighter_;
    private final AceEditorBackgroundLinkHighlighter bgLinkHighlighter_;
    private int scrollTarget_ = 0;
    private HandlerRegistration scrollCompleteReg_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceBackgroundHighlighter.java
Patch:
@@ -203,7 +203,7 @@ public void onDocumentChanged(DocumentChangedEvent event)
          int newlineCount = endRow - startRow;
          for (int i = 0; i < newlineCount; i++)
          {
-            rowStates_.insert(startRow, null);
+            rowStates_.insert(startRow, -1);
             rowPatterns_.insert(startRow, (HighlightPattern) null);
          }
       }

File: src/gwt/src/org/rstudio/core/client/cellview/TriStateCheckboxCell.java
Patch:
@@ -119,16 +119,15 @@ else if ("mouseout".equals(event.getType()))
    @Override
    public void render(Context context, Boolean value, SafeHtmlBuilder sb)
    {
-      ImageResource img;
+      ImageResource2x img;
       if (value == null)
          img = new ImageResource2x(RES.checkboxIndeterminate2x());
       else if (value)
          img = new ImageResource2x(RES.checkboxOn2x());
       else
          img = new ImageResource2x(RES.checkboxOff2x());
 
-      sb.append(SafeHtmlUtils.fromTrustedString(
-            AbstractImagePrototype.create(img).getHTML()));
+      sb.append(img.getSafeHtml());
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -106,7 +106,7 @@ protected Toolbar createMainToolbar()
       toolbar.addLeftWidget(commands_.goToWorkingDir().createToolbarButton());
       consoleInterruptButton_ = commands_.interruptR().createToolbarButton();
       consoleClearButton_ = commands_.consoleClear().createToolbarButton();
-      consoleClearButton_.setVisible(false);
+      consoleClearButton_.setVisible(true);
       
       profilerInterruptButton_ = ConsoleInterruptProfilerButton.CreateProfilerButton();
       profilerInterruptButton_.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -243,7 +243,7 @@ private void renderNotebookv2WithDialog(final DocUpdateSentinel sourceDoc)
          @Override
          public void execute(CompileNotebookv2Options input)
          { 
-            renderNotebookv2(sourceDoc, input.getFormat());
+            renderNotebookv2(sourceDoc, null, input.getFormat());
             
             // save options for this document
             HashMap<String, String> changedProperties 

File: src/gwt/src/org/rstudio/core/client/files/filedialog/PathBreadcrumbWidget.java
Patch:
@@ -103,7 +103,7 @@ public void onClick(ClickEvent event)
       frame_ = new DockLayoutPanel(Unit.PX);
       eastFrame_ = new FlowPanel();
 
-      Image browse = new Image(RES.browse());
+      Image browse = new Image(new ImageResource2x(RES.browse2x()));
       browse.setStyleName(STYLES.browse());
       browse.addStyleName(ThemeResources.INSTANCE.themeStyles().handCursor());
       browse.addClickHandler(new ClickHandler()

File: src/gwt/src/org/rstudio/core/client/widget/TriStateCheckBox.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.core.client.widget;
 
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
 
 import com.google.gwt.core.client.GWT;
@@ -79,7 +80,8 @@ public void onClick(ClickEvent event)
    public void setState(State state)
    {
       if (state == STATE_INDETERMINATE)
-         checkboxInner_.setResource(ThemeResources.INSTANCE.checkboxTri());
+         checkboxInner_.setResource(new ImageResource2x(
+            ThemeResources.INSTANCE.checkboxTri2x()));
       else if (state == STATE_OFF)
          checkboxInner_.setResource(ThemeResources.INSTANCE.checkboxOff());
       else if (state == STATE_ON)

File: src/gwt/src/org/rstudio/studio/client/common/icons/StandardIcons.java
Patch:
@@ -31,7 +31,8 @@ public interface StandardIcons extends ClientBundle
    @Source("go_up_2x.png")
    ImageResource go_up2x();
 
-   ImageResource right_arrow();
+   @Source("right_arrow_2x.png")
+   ImageResource right_arrow2x();
 
    @Source("click_feedback_2x.png")
    ImageResource click_feedback2x();

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/NewRSConnectCloudPage.java
Patch:
@@ -32,7 +32,7 @@ public NewRSConnectCloudPage()
             "A cloud service run by RStudio. Publish Shiny applications " +
             "and interactive documents to the Internet.",
             "Connect ShinyApps.io Account",
-            RSConnectResources.INSTANCE.cloudAccountIcon(), 
+            new ImageResource2x(RSConnectResources.INSTANCE.cloudAccountIcon2x()), 
             new ImageResource2x(RSConnectResources.INSTANCE.cloudAccountIconLarge2x()));
    }
 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishReportSourcePage.java
Patch:
@@ -16,6 +16,7 @@
 
 import java.util.ArrayList;
 
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.WizardNavigationPage;
 import org.rstudio.core.client.widget.WizardPage;
 import org.rstudio.studio.client.rsconnect.model.RSConnectPublishInput;
@@ -58,13 +59,13 @@ public PublishReportSourcePage(
             "Choose this option if you want to create " + 
             (asMultiple ? "scheduled reports" : "a scheduled report") + " or " +
             "rebuild your " + descriptor + " on the server.", 
-            RSConnectResources.INSTANCE.publishDocWithSource(), 
+            new ImageResource2x(RSConnectResources.INSTANCE.publishDocWithSource2x()), 
             input, asMultiple, false));
       String staticTitle = "Publish finished " + descriptor + " only";
       String staticSubtitle = "Choose this option to publish the content as " +
              "it appears in RStudio.";
       pages.add(new PublishFilesPage(staticTitle, staticSubtitle, 
-            RSConnectResources.INSTANCE.publishDocWithoutSource(), 
+            new ImageResource2x(RSConnectResources.INSTANCE.publishDocWithoutSource2x()), 
             input, asMultiple, true));
       return pages;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -166,8 +166,8 @@ public interface Resources extends ClientBundle
       @Source("MarkdownDocumentIcon_2x.png")
       ImageResource documentIcon2x();
 
-      @Source("MarkdownOptionsIcon.png")
-      ImageResource optionsIcon();
+      @Source("MarkdownOptionsIcon_2x.png")
+      ImageResource optionsIcon2x();
       
       @Source("MarkdownTemplateIcon_2x.png")
       ImageResource templateIcon2x();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionSnippetHost.java
Patch:
@@ -387,5 +387,5 @@ public static void ensureStylesInjected()
    ArrayList<NewConnectionSnippetParts> snippetParts_;
    HashMap<String, String> partsKeyValues_ = new HashMap<String, String>();
 
-   static final String pattern_ = "\\$\\{([0-9]+):([^:=}]+)(=([^:}]+))?(:([^}]+))?\\}";
+   static final String pattern_ = "\\$\\{([0-9]+):([^:=}]+)(=([^:}]*))?(:([^}]+))?\\}";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionExplorer.java
Patch:
@@ -81,7 +81,7 @@ public void onConsoleBusy(ConsoleBusyEvent event)
             if (!event.isBusy() && containerPanel_.isProgressShowing())
             {
                showActivePanel();
-               updateTableBrowser();
+               updateObjectBrowser();
             }
          }
       });
@@ -102,7 +102,7 @@ public void setConnection(Connection connection, String connectVia)
    {
       connection_ = connection;
       codePanel_.setCode(connection.getConnectCode(), connectVia);
-      updateTableBrowser();
+      updateObjectBrowser();
    }
    
    public void setConnected(boolean connected)
@@ -123,7 +123,7 @@ public String getConnectVia()
       return codePanel_.getConnectVia();
    }
    
-   public void updateTableBrowser()
+   public void updateObjectBrowser()
    {
       updateObjectBrowser("");
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionsPane.java
Patch:
@@ -304,7 +304,7 @@ private void setConnection(Connection connection, String connectVia)
    @Override
    public void updateExploredConnection(String hint)
    {
-      connectionExplorer_.updateTableBrowser(hint);
+      connectionExplorer_.updateObjectBrowser(hint);
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcess.java
Patch:
@@ -281,8 +281,7 @@ public void onServerConsoleOutput(
                                              ServerConsoleOutputEvent event)
                {
                   if (event.getProcessHandle().equals(procInfo.getHandle()))
-                     fireEvent(new ConsoleOutputEvent(event.getOutput(),
-                                                      event.getError()));
+                     fireEvent(new ConsoleOutputEvent(event.getOutput()));
                }
             }));
       registrations_.add(eventBus.addHandler(

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ClientEventDispatcher.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -363,8 +363,7 @@ else if (type.equals(ClientEvent.ConsoleProcessOutput))
          {
             ServerConsoleOutputEvent.Data data = event.getData();
             eventBus_.fireEvent(new ServerConsoleOutputEvent(data.getHandle(),
-                                                            data.getOutput(),
-                                                            data.isError()));
+                                                            data.getOutput()));
          }
          else if (type.equals(ClientEvent.ConsoleProcessPrompt))
          {

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcess.java
Patch:
@@ -281,8 +281,7 @@ public void onServerConsoleOutput(
                                              ServerConsoleOutputEvent event)
                {
                   if (event.getProcessHandle().equals(procInfo.getHandle()))
-                     fireEvent(new ConsoleOutputEvent(event.getOutput(),
-                                                      event.getError()));
+                     fireEvent(new ConsoleOutputEvent(event.getOutput()));
                }
             }));
       registrations_.add(eventBus.addHandler(

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ClientEventDispatcher.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -363,8 +363,7 @@ else if (type.equals(ClientEvent.ConsoleProcessOutput))
          {
             ServerConsoleOutputEvent.Data data = event.getData();
             eventBus_.fireEvent(new ServerConsoleOutputEvent(data.getHandle(),
-                                                            data.getOutput(),
-                                                            data.isError()));
+                                                            data.getOutput()));
          }
          else if (type.equals(ClientEvent.ConsoleProcessPrompt))
          {

File: src/gwt/src/org/rstudio/core/client/Stopwatch.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * Stopwatch.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -26,10 +26,11 @@ public void reset()
       startTime_ = System.currentTimeMillis();
    }
 
-   public void mark(String label)
+   public long mark(String label)
    {
       long stopTime = System.currentTimeMillis();
       Debug.log("[Stopwatch] " + label + ": " + (stopTime - startTime_) + " ms");
+      return stopTime - startTime_;
    }
 
    private long startTime_;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -120,6 +120,7 @@
 import org.rstudio.studio.client.workbench.views.terminal.TerminalList;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalPopupMenu;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalSession;
+import org.rstudio.studio.client.workbench.views.terminal.TerminalSessionSocket;
 import org.rstudio.studio.client.workbench.views.source.editors.text.r.SignatureToolTipManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.TextEditingTargetNotebook;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.display.ChunkOptionsPopupPanel;
@@ -220,6 +221,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(NewConnectionSnippetHost newConnectionSnippetHost);
    void injectMembers(NewConnectionSnippetDialog newConnectionSnippetDialog);
    void injectMembers(NewPackagePage page);
+   void injectMembers(TerminalSessionSocket socket);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/core/client/Stopwatch.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * Stopwatch.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -26,10 +26,11 @@ public void reset()
       startTime_ = System.currentTimeMillis();
    }
 
-   public void mark(String label)
+   public long mark(String label)
    {
       long stopTime = System.currentTimeMillis();
       Debug.log("[Stopwatch] " + label + ": " + (stopTime - startTime_) + " ms");
+      return stopTime - startTime_;
    }
 
    private long startTime_;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -120,6 +120,7 @@
 import org.rstudio.studio.client.workbench.views.terminal.TerminalList;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalPopupMenu;
 import org.rstudio.studio.client.workbench.views.terminal.TerminalSession;
+import org.rstudio.studio.client.workbench.views.terminal.TerminalSessionSocket;
 import org.rstudio.studio.client.workbench.views.source.editors.text.r.SignatureToolTipManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.TextEditingTargetNotebook;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.display.ChunkOptionsPopupPanel;
@@ -220,6 +221,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(NewConnectionSnippetHost newConnectionSnippetHost);
    void injectMembers(NewConnectionSnippetDialog newConnectionSnippetDialog);
    void injectMembers(NewPackagePage page);
+   void injectMembers(TerminalSessionSocket socket);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -153,6 +153,7 @@
 import org.rstudio.studio.client.workbench.views.buildtools.model.BookdownFormats;
 import org.rstudio.studio.client.workbench.views.connections.model.ConnectionId;
 import org.rstudio.studio.client.workbench.views.connections.model.ConnectionObjectSpecifier;
+import org.rstudio.studio.client.workbench.views.connections.model.DatabaseObject;
 import org.rstudio.studio.client.workbench.views.connections.model.Field;
 import org.rstudio.studio.client.workbench.views.connections.model.NewConnectionContext;
 import org.rstudio.studio.client.workbench.views.console.model.ProcessBufferChunk;
@@ -4969,7 +4970,7 @@ public void connectionExecuteAction(ConnectionId connection,
    public void connectionListObjects(
                               ConnectionId connectionId,
                               ConnectionObjectSpecifier container,
-                              ServerRequestCallback<JsArrayString> callback)
+                              ServerRequestCallback<JsArray<DatabaseObject>> callback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONObject(connectionId));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionsServerOperations.java
Patch:
@@ -21,7 +21,6 @@
 import org.rstudio.studio.client.server.remote.RResult;
 
 import com.google.gwt.core.client.JsArray;
-import com.google.gwt.core.client.JsArrayString;
 
 public interface ConnectionsServerOperations extends CryptoServerOperations
 {
@@ -36,7 +35,7 @@ void connectionExecuteAction(ConnectionId connectionId,
    
    void connectionListObjects(ConnectionId connectionId,
                               ConnectionObjectSpecifier object,
-                              ServerRequestCallback<JsArrayString> callback);
+                              ServerRequestCallback<JsArray<DatabaseObject>> callback);
    
    void connectionListFields(ConnectionId connectionId,
                              ConnectionObjectSpecifier object,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -163,7 +163,7 @@ public interface Resources extends ClientBundle
       @Source("MarkdownPresentationIcon_2x.png")
       ImageResource presentationIcon2x();
 
-      @Source("MarkdownDocumentIcon.png")
+      @Source("MarkdownDocumentIcon_2x.png")
       ImageResource documentIcon2x();
 
       @Source("MarkdownOptionsIcon.png")

File: src/gwt/src/org/rstudio/core/client/resources/ImageResource2x.java
Patch:
@@ -74,6 +74,7 @@ public int getTop()
       return getResource().getTop();
    }
 
+   @SuppressWarnings("deprecation")
    @Override
    public String getURL()
    {

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectTemplateIconImageResource.java
Patch:
@@ -49,6 +49,7 @@ public int getTop()
       return 0;
    }
 
+   @SuppressWarnings("deprecation")
    @Override
    public String getURL()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/PlotsToolbar.java
Patch:
@@ -14,6 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.plots.ui;
 
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.HasCustomizableToolbar;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
@@ -61,7 +62,7 @@ private void installStandardUI()
       exportMenu.addSeparator();
       exportMenu.addItem(commands_.copyPlotToClipboard().createMenuItem(false));
       ToolbarButton exportButton = new ToolbarButton(
-            "Export", StandardIcons.INSTANCE.export_menu(),
+            "Export", new ImageResource2x(StandardIcons.INSTANCE.export_menu2x()),
             exportMenu);
       addLeftWidget(exportButton);
       addLeftSeparator();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/actions/ActionCenter.java
Patch:
@@ -16,6 +16,7 @@
 
 import java.util.ArrayList;
 
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.workbench.views.packages.Packages;
 
 import com.google.gwt.core.client.GWT;

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -519,7 +519,7 @@ public static String formatMenuLabel(ImageResource icon,
                                          String rightImageDesc)
    {
       StringBuilder text = new StringBuilder();
-      int topOffset = -10;
+      int topOffset = -7;
       if (iconOffsetY != null)
          topOffset += iconOffsetY;
       text.append("<table border=0 cellpadding=0 cellspacing=0 width='100%'><tr>");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -560,7 +560,7 @@ public void execute()
                {
                   setObjectDisplayType(type);
                }
-            }, 2);
+            }, -1);
    }
    
    // An extension of the toolbar popup menu that gets environment names from

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcessInfo.java
Patch:
@@ -74,7 +74,7 @@ public final native boolean getHasChildProcs() /*-{
       return this.child_procs;
    }-*/;
    
-   public final native boolean getShellType() /*-{
+   public final native int getShellType() /*-{
       return this.shell_type;
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -110,7 +110,8 @@ public void connect()
       connecting_ = true;
       setNewTerminal(getHandle() == null);
 
-      server_.startTerminal(getCols(), getRows(), getHandle(), getCaption(), 
+      server_.startTerminal(TerminalShellInfo.SHELL_DEFAULT,
+            getCols(), getRows(), getHandle(), getCaption(), 
             getTitle(), getSequence(), new ServerRequestCallback<ConsoleProcess>()
       {
          @Override

File: src/gwt/src/org/rstudio/core/client/files/filedialog/DirectoryContentsWidget.java
Patch:
@@ -37,6 +37,7 @@
 import org.rstudio.core.client.events.SelectionCommitHandler;
 import org.rstudio.core.client.files.FileSystemContext;
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.CanFocus;
 import org.rstudio.core.client.widget.DoubleClickState;
 import org.rstudio.core.client.widget.ScrollPanelWithClick;
@@ -381,7 +382,7 @@ public void setContents(FileSystemItem[] contents,
       if (parentDirectory != null)
          addItem(parentDirectory,
                  "..",
-                 FileIconResources.INSTANCE.iconUpFolder());
+                 new ImageResource2x(FileIconResources.INSTANCE.iconUpFolder2x()));
 
       for (FileSystemItem fsi : contents)
          addItem(fsi, null, null);

File: src/gwt/src/org/rstudio/core/client/files/filedialog/PathBreadcrumbWidget.java
Patch:
@@ -29,6 +29,7 @@
 import org.rstudio.core.client.events.SelectionCommitHandler;
 import org.rstudio.core.client.files.FileSystemContext;
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.OperationWithInput;
@@ -60,7 +61,7 @@ public PathBreadcrumbWidget(FileSystemContext context)
          linkUp_.setVisible(false);
          linkUp_.setStylePrimaryName(RES.styles().goUp());
          linkUp_.addStyleName(ThemeStyles.INSTANCE.handCursor());
-         Image image = new Image(FileIconResources.INSTANCE.iconUpFolder());
+         Image image = new Image(new ImageResource2x(FileIconResources.INSTANCE.iconUpFolder2x()));
          linkUp_.getElement().appendChild(image.getElement());
       }
       else

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.core.client.events.BarrierReleasedEvent;
 import org.rstudio.core.client.events.BarrierReleasedHandler;
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.MessageDialog;
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.OperationWithInput;
@@ -633,7 +634,7 @@ public String getId()
       @Override
       public ImageResource getIcon()
       {
-         return FileIconResources.INSTANCE.iconRdata(); 
+         return new ImageResource2x(FileIconResources.INSTANCE.iconRdata2x()); 
       }
 
       @Override

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/CodeBrowserType.java
Patch:
@@ -15,14 +15,15 @@
 package org.rstudio.studio.client.common.filetypes;
 
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.application.events.EventBus;
 
 public class CodeBrowserType extends EditableFileType
 {
    public CodeBrowserType()
    {
       super("r_code_browser", "R Code Browser",
-            FileIconResources.INSTANCE.iconRdoc());
+            new ImageResource2x(FileIconResources.INSTANCE.iconRdoc2x()));
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/DataFrameType.java
Patch:
@@ -15,14 +15,15 @@
 package org.rstudio.studio.client.common.filetypes;
 
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.application.events.EventBus;
 
 public class DataFrameType extends EditableFileType
 {
    public DataFrameType()
    {
       super("r_dataframe", "R Data Frame",
-            FileIconResources.INSTANCE.iconRdata());
+            new ImageResource2x(FileIconResources.INSTANCE.iconRdata2x()));
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/GraphvizFileType.java
Patch:
@@ -15,13 +15,14 @@
 
 package org.rstudio.studio.client.common.filetypes;
 
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.common.reditor.EditorLanguage;
 
 public class GraphvizFileType extends PreviewableFromRFileType
 {
    public GraphvizFileType()
    {
       super("graphviz", "GraphViz", EditorLanguage.LANG_GRAPHVIZ, ".gv",
-            FileIconResources.INSTANCE.iconGraphviz(), "DiagrammeR::grViz");
+            new ImageResource2x(FileIconResources.INSTANCE.iconGraphviz2x()), "DiagrammeR::grViz");
    }
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/MermaidFileType.java
Patch:
@@ -15,13 +15,14 @@
 
 package org.rstudio.studio.client.common.filetypes;
 
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.common.reditor.EditorLanguage;
 
 public class MermaidFileType extends PreviewableFromRFileType
 {
    public MermaidFileType()
    {
       super("mermaid", "Mermaid", EditorLanguage.LANG_MERMAID, ".mmd",
-            FileIconResources.INSTANCE.iconMermaid(), "DiagrammeR::mermaid");
+            new ImageResource2x(FileIconResources.INSTANCE.iconMermaid2x()), "DiagrammeR::mermaid");
    }
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ProfilerType.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.filetypes.model.NavigationMethods;
 import org.rstudio.studio.client.workbench.commands.Commands;
@@ -29,7 +30,7 @@ public class ProfilerType extends EditableFileType
    public ProfilerType()
    {
       super("r_prof", "R Profiler",
-            FileIconResources.INSTANCE.iconRdoc());
+            new ImageResource2x(FileIconResources.INSTANCE.iconRdoc2x()));
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/UrlContentType.java
Patch:
@@ -15,14 +15,15 @@
 package org.rstudio.studio.client.common.filetypes;
 
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.application.events.EventBus;
 
 public class UrlContentType extends EditableFileType
 {
    public UrlContentType()
    {
       super("urlcontent", "Generic Content",
-            FileIconResources.INSTANCE.iconText());
+            new ImageResource2x(FileIconResources.INSTANCE.iconText2x()));
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FileUploadDialog.java
Patch:
@@ -23,6 +23,7 @@
 import org.rstudio.core.client.files.filedialog.FileDialogResources;
 import org.rstudio.core.client.jsonrpc.RpcError;
 import org.rstudio.core.client.jsonrpc.RpcResponse;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.HtmlFormModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
@@ -222,7 +223,7 @@ public void setDirectory(FileSystemItem directoryItem)
          }
          else
          {
-            image_.setResource(FileIconResources.INSTANCE.iconFolder());
+            image_.setResource(new ImageResource2x(FileIconResources.INSTANCE.iconFolder2x()));
             name_.setHTML("&nbsp;" + directoryItem.getPath());
          }
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/ui/FilesList.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.core.client.cellview.ColumnSortInfo;
 import org.rstudio.core.client.cellview.LinkColumn;
 import org.rstudio.core.client.files.FileSystemItem;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.studio.client.common.filetypes.FileIconResources;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
@@ -148,7 +149,7 @@ private Column<FileSystemItem, ImageResource> addIconColumn(
             public ImageResource getValue(FileSystemItem object)
             {
                if (object == parentPath_)
-                  return FileIconResources.INSTANCE.iconUpFolder();
+                  return new ImageResource2x(FileIconResources.INSTANCE.iconUpFolder2x());
                else
                   return fileTypeRegistry.getIconForFile(object);
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTarget.java
Patch:
@@ -19,6 +19,7 @@
 import com.google.inject.Inject;
 
 import org.rstudio.core.client.Debug;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.core.client.widget.SimplePanelWithProgress;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.GlobalDisplay;
@@ -160,7 +161,7 @@ public String getPath()
    @Override
    public ImageResource getIcon()
    {
-      return FileIconResources.INSTANCE.iconCsv();
+      return new ImageResource2x(FileIconResources.INSTANCE.iconCsv2x());
    }
 
    private DataItem getDataItem()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTarget.java
Patch:
@@ -33,6 +33,7 @@
 import org.rstudio.core.client.events.EnsureHeightHandler;
 import org.rstudio.core.client.events.EnsureVisibleHandler;
 import org.rstudio.core.client.files.FileSystemContext;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.ReadOnlyValue;
@@ -119,7 +120,7 @@ public String getContext()
 
    public ImageResource getIcon()
    {
-      return FileIconResources.INSTANCE.iconText();
+      return new ImageResource2x(FileIconResources.INSTANCE.iconText2x());
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/StanFileType.java
Patch:
@@ -18,6 +18,7 @@
 import java.util.HashSet;
 
 import org.rstudio.core.client.command.AppCommand;
+import org.rstudio.core.client.resources.ImageResource2x;
 import org.rstudio.studio.client.common.reditor.EditorLanguage;
 import org.rstudio.studio.client.workbench.commands.Commands;
 
@@ -26,7 +27,7 @@ public class StanFileType extends PreviewableFromRFileType
    public StanFileType()
    {
       super("stan", "Stan", EditorLanguage.LANG_STAN, ".stan",
-            FileIconResources.INSTANCE.iconStan(), "rstan:::rstudio_stanc");
+            new ImageResource2x(FileIconResources.INSTANCE.iconStan2x()), "rstan:::rstudio_stanc");
    }
    
    public String getPreviewButtonText()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -439,7 +439,7 @@ private Widget createImportMenu()
       
       dataImportButton_ = new ToolbarButton(
               "Import Dataset",
-              StandardIcons.INSTANCE.import_dataset(),
+              new ImageResource2x(StandardIcons.INSTANCE.import_dataset2x()),
               menu);
       return dataImportButton_;
 

File: src/gwt/test/org/rstudio/studio/client/RStudioUnitTestSuite.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.rstudio.studio.client.common.r.RTokenizerTests;
 import org.rstudio.core.client.StringUtilTests;
+import org.rstudio.core.client.dom.DomUtilsTests;
 
 import com.google.gwt.junit.tools.GWTTestSuite;
 
@@ -29,6 +30,7 @@ public static Test suite()
         suite.addTestSuite(RTokenizerTests.class);
         suite.addTestSuite(VirtualConsoleTests.class);
         suite.addTestSuite(StringUtilTests.class);
+        suite.addTestSuite(DomUtilsTests.class);
         return suite;
     }
 }

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -258,6 +258,7 @@ else if (view != null &&
       rpcRequest.send(new RpcRequestCallback() {
          public void onError(RpcRequest request, RpcError error)
          {
+            Debug.log(error.getMessage());
             GWT.runAsync(runCallback);
          }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -628,7 +628,7 @@ public PrefValue<Boolean> wrapTabNavigation()
    
    public PrefValue<Boolean> useRetinaIcons()
    {
-      return bool("use_retina_icons", true);
+      return bool("use_retina_icons", false);
    }
    
    private String getDefaultPdfPreview()

File: src/gwt/src/org/rstudio/core/rebind/command/CommandBundleGenerator.java
Patch:
@@ -433,7 +433,7 @@ private ImageResourceInfo generateImageBundle()
             iri.addImage(commandId);
          }
 
-         if (resourceNames.contains(key + "2x.png"))
+         if (resourceNames.contains(key + "@2x.png"))
          {
             writer.println("@Source(\"" + commandId + "@2x.png\")");
             writer.println("ImageResource " + commandId + "2x();");

File: src/gwt/src/org/rstudio/core/rebind/command/CommandBundleGenerator.java
Patch:
@@ -435,6 +435,7 @@ private ImageResourceInfo generateImageBundle()
 
          if (resourceNames.contains(key + "2x.png"))
          {
+            writer.println("@Source(\"" + commandId + "@2x.png\")");
             writer.println("ImageResource " + commandId + "2x();");
             iri.addImage(commandId + "2x");
          }

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -24,7 +24,6 @@
 import com.google.gwt.dom.client.StyleInjector;
 import com.google.gwt.thirdparty.json.JSONArray;
 import com.google.gwt.user.client.Command;
-import com.google.gwt.json.client.JSONArray;
 import com.google.gwt.user.client.Window;
 import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.RootLayoutPanel;

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -4952,8 +4952,8 @@ public void removeConnection(ConnectionId id,
       sendRequest(RPC_SCOPE, REMOVE_CONNECTION, id, callback);
    }
    
-   public void getDisconnectCode(ConnectionId connectionId, 
-                                 ServerRequestCallback<String> callback)
+   public void connectionDisconnect(ConnectionId connectionId, 
+                                    ServerRequestCallback<Void> callback)
    {
       sendRequest(RPC_SCOPE, GET_DISCONNECT_CODE, connectionId, callback);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionsServerOperations.java
Patch:
@@ -27,8 +27,8 @@ public interface ConnectionsServerOperations extends CryptoServerOperations
 {
    void removeConnection(ConnectionId id, ServerRequestCallback<Void> callback);
  
-   void getDisconnectCode(ConnectionId connectionId, 
-                          ServerRequestCallback<String> callback);
+   void connectionDisconnect(ConnectionId connectionId, 
+                             ServerRequestCallback<Void> callback);
    
    void connectionExecuteAction(ConnectionId connectionId, 
                                 String action,

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -57,7 +57,6 @@
 import org.rstudio.studio.client.common.spelling.ui.SpellingCustomDictionariesWidget;
 import org.rstudio.studio.client.htmlpreview.HTMLPreviewApplication;
 import org.rstudio.studio.client.notebook.CompileNotebookOptionsDialog;
-import org.rstudio.studio.client.projects.ProjectOpener;
 import org.rstudio.studio.client.projects.model.ProjectTemplateRegistryProvider;
 import org.rstudio.studio.client.projects.ui.newproject.CodeFilesList;
 import org.rstudio.studio.client.projects.ui.newproject.NewPackagePage;
@@ -221,7 +220,6 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(NewConnectionSnippetHost newConnectionSnippetHost);
    void injectMembers(NewConnectionSnippetDialog newConnectionSnippetDialog);
    void injectMembers(NewPackagePage page);
-   void injectMembers(ProjectOpener opener);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -177,6 +177,7 @@
 import org.rstudio.studio.client.workbench.views.packages.Packages;
 import org.rstudio.studio.client.workbench.views.packages.PackagesPane;
 import org.rstudio.studio.client.workbench.views.packages.PackagesTab;
+import org.rstudio.studio.client.workbench.views.packages.model.PackageProvidedExtensions;
 import org.rstudio.studio.client.workbench.views.packages.model.PackagesServerOperations;
 import org.rstudio.studio.client.workbench.views.plots.Plots;
 import org.rstudio.studio.client.workbench.views.plots.PlotsPane;
@@ -277,6 +278,7 @@ protected void configure()
       bind(DataImportPresenter.class).in(Singleton.class);
       bind(MathJaxLoader.class).asEagerSingleton();
       bind(ProjectTemplateRegistryProvider.class).in(Singleton.class);
+      bind(PackageProvidedExtensions.class).asEagerSingleton();
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -56,9 +56,9 @@
 import org.rstudio.studio.client.htmlpreview.events.HTMLPreviewOutputEvent;
 import org.rstudio.studio.client.htmlpreview.events.HTMLPreviewStartedEvent;
 import org.rstudio.studio.client.htmlpreview.model.HTMLPreviewResult;
+import org.rstudio.studio.client.packages.events.PackageExtensionIndexingCompletedEvent;
 import org.rstudio.studio.client.projects.events.FollowUserEvent;
 import org.rstudio.studio.client.projects.events.OpenProjectErrorEvent;
-import org.rstudio.studio.client.projects.events.PackageExtensionIndexingCompletedEvent;
 import org.rstudio.studio.client.projects.events.ProjectAccessRevokedEvent;
 import org.rstudio.studio.client.projects.events.ProjectTemplateRegistryUpdatedEvent;
 import org.rstudio.studio.client.projects.events.ProjectUserChangedEvent;
@@ -138,6 +138,7 @@
 import org.rstudio.studio.client.workbench.views.packages.events.PackageStateChangedEvent;
 import org.rstudio.studio.client.workbench.views.packages.events.LoadedPackageUpdatesEvent;
 import org.rstudio.studio.client.workbench.views.packages.events.PackageStatusChangedEvent;
+import org.rstudio.studio.client.workbench.views.packages.model.PackageProvidedExtensions;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageState;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageStatus;
 import org.rstudio.studio.client.workbench.views.plots.events.LocatorEvent;
@@ -863,7 +864,7 @@ else if (type.equals(ClientEvent.TerminalSubProcs))
          }
          else if (type.equals(ClientEvent.PackageExtensionIndexingCompleted))
          {
-            PackageExtensionIndexingCompletedEvent.Data data = event.getData();
+            PackageProvidedExtensions.Data data = event.getData();
             eventBus_.fireEvent(new PackageExtensionIndexingCompletedEvent(data));
          }
          else if (type.equals(ClientEvent.RStudioAPIShowDialog))

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -999,7 +999,6 @@ public void chooseFileCompleted(String file,
       sendRequest(RPC_SCOPE, CHOOSE_FILE_COMPLETED, file, requestCallback);
    }
 
-
    public void getPackageState(
          boolean manual,
          ServerRequestCallback<PackageState> requestCallback)

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -63,7 +63,6 @@
 import org.rstudio.studio.client.projects.events.ProjectTemplateRegistryUpdatedEvent;
 import org.rstudio.studio.client.projects.events.ProjectUserChangedEvent;
 import org.rstudio.studio.client.projects.model.OpenProjectError;
-import org.rstudio.studio.client.projects.model.PackageProvidedExtensions;
 import org.rstudio.studio.client.projects.model.ProjectTemplateRegistry;
 import org.rstudio.studio.client.projects.model.ProjectUser;
 import org.rstudio.studio.client.rmarkdown.events.ChunkExecStateChangedEvent;
@@ -864,7 +863,7 @@ else if (type.equals(ClientEvent.TerminalSubProcs))
          }
          else if (type.equals(ClientEvent.PackageExtensionIndexingCompleted))
          {
-            PackageProvidedExtensions data = event.getData();
+            PackageExtensionIndexingCompletedEvent.Data data = event.getData();
             eventBus_.fireEvent(new PackageExtensionIndexingCompletedEvent(data));
          }
          else if (type.equals(ClientEvent.RStudioAPIShowDialog))

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewConnectionNavigationPage.java
Patch:
@@ -100,6 +100,7 @@ public Selector(final ArrayList<WizardPage<NewConnectionContext, ConnectionOptio
          
          ScrollPanel scrollPanel = new ScrollPanel();
          scrollPanel.setSize("100%", "100%");
+         scrollPanel.addStyleName(RES.styles().wizardPageSelector());
          scrollPanel.addStyleName(styles.wizardPageSelector());
 
          VerticalPanel verticalPanel = new VerticalPanel();
@@ -171,6 +172,7 @@ public SelectorItem(WizardPage<NewConnectionContext, ConnectionOptions> page,
 
    public interface Styles extends CssResource
    {
+      String wizardPageSelector();
    }
    
    public interface Resources extends ClientBundle

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -63,6 +63,7 @@
 import org.rstudio.studio.client.projects.events.ProjectTemplateRegistryUpdatedEvent;
 import org.rstudio.studio.client.projects.events.ProjectUserChangedEvent;
 import org.rstudio.studio.client.projects.model.OpenProjectError;
+import org.rstudio.studio.client.projects.model.PackageProvidedExtensions;
 import org.rstudio.studio.client.projects.model.ProjectTemplateRegistry;
 import org.rstudio.studio.client.projects.model.ProjectUser;
 import org.rstudio.studio.client.rmarkdown.events.ChunkExecStateChangedEvent;
@@ -863,7 +864,7 @@ else if (type.equals(ClientEvent.TerminalSubProcs))
          }
          else if (type.equals(ClientEvent.PackageExtensionIndexingCompleted))
          {
-            PackageExtensionIndexingCompletedEvent.Data data = event.getData();
+            PackageProvidedExtensions data = event.getData();
             eventBus_.fireEvent(new PackageExtensionIndexingCompletedEvent(data));
          }
          else if (type.equals(ClientEvent.RStudioAPIShowDialog))

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -278,6 +278,7 @@ private Toolbar createToolbar(TextFileType fileType)
       runDocumentMenuButton_.addSeparator();
       runDocumentMenuButton_.addMenuItem(commands_.clearPrerenderedOutput().createMenuItem(false), "");     
       toolbar.addLeftWidget(runDocumentMenuButton_);
+      runDocumentMenuButton_.setVisible(false);
       
       ToolbarPopupMenu rmdOptionsMenu = new ToolbarPopupMenu();
       rmdOptionsMenu.addItem(commands_.editRmdFormatOptions().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -278,6 +278,7 @@ private Toolbar createToolbar(TextFileType fileType)
       runDocumentMenuButton_.addSeparator();
       runDocumentMenuButton_.addMenuItem(commands_.clearPrerenderedOutput().createMenuItem(false), "");     
       toolbar.addLeftWidget(runDocumentMenuButton_);
+      runDocumentMenuButton_.setVisible(false);
       
       ToolbarPopupMenu rmdOptionsMenu = new ToolbarPopupMenu();
       rmdOptionsMenu.addItem(commands_.editRmdFormatOptions().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcessInfo.java
Patch:
@@ -23,6 +23,9 @@ public class ConsoleProcessInfo extends JavaScriptObject
    public static final int INTERACTION_POSSIBLE = 1;
    public static final int INTERACTION_ALWAYS = 2;
    
+   public static final int DEFAULT_COLS = 80;
+   public static final int DEFAULT_ROWS = 25;
+   
    protected ConsoleProcessInfo() {}
 
    public final native String getHandle() /*-{

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcessInfo.java
Patch:
@@ -23,6 +23,9 @@ public class ConsoleProcessInfo extends JavaScriptObject
    public static final int INTERACTION_POSSIBLE = 1;
    public static final int INTERACTION_ALWAYS = 2;
    
+   public static final int DEFAULT_COLS = 80;
+   public static final int DEFAULT_ROWS = 25;
+   
    protected ConsoleProcessInfo() {}
 
    public final native String getHandle() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/spelling/CheckSpelling.java
Patch:
@@ -199,8 +199,7 @@ private void cancel()
    private void doReplacement(String replacement)
    {
       docDisplay_.replaceSelection(replacement);
-      // Spell check what we just replaced
-      currentPos_ = docDisplay_.getSelectionStart();
+      currentPos_ = docDisplay_.getSelectionEnd();
    }
 
    private void findNextMisspelling()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -422,9 +422,9 @@ private Widget createImportMenu()
       importCsvMenu.addItem(commands_.importDatasetFromCsvUsingBase().createMenuItem(false));
       importCsvMenu.addItem(commands_.importDatasetFromCsvUsingReadr().createMenuItem(false));
    
-      menu.addItem(commands_.importDatasetFromCsv(), importCsvMenu);
       menu.addItem(commands_.importDatasetFromFile().createMenuItem(false));
       menu.addItem(commands_.importDatasetFromURL().createMenuItem(false));
+      menu.addItem(commands_.importDatasetFromCsv(), importCsvMenu);
       menu.addSeparator();
       menu.addItem(commands_.importDatasetFromXLS().createMenuItem(false));
       menu.addSeparator();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4980,7 +4980,8 @@ public void execute()
          @Override
          public void execute()
          {
-            saveThenExecute(null, renderCommand);}
+            saveThenExecute(null, renderCommand);
+         }
       };
       
       // save before rendering if the document is dirty; otherwise render

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalList.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalList.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -35,7 +35,6 @@
  */
 public class TerminalList implements Iterable<String>,
                                      TerminalSubprocEvent.Handler
-
 {
    private static class TerminalMetadata
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalSubprocEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalSubprocEvent.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalList.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalList.java
  *
- * Copyright (C) 2009-16 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -35,7 +35,6 @@
  */
 public class TerminalList implements Iterable<String>,
                                      TerminalSubprocEvent.Handler
-
 {
    private static class TerminalMetadata
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/events/TerminalSubprocEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * TerminalSubprocEvent.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-17 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcess.java
Patch:
@@ -89,7 +89,6 @@ public void onSessionInit(SessionInitEvent sie)
                            public void onResponseReceived(
                                  final ConsoleProcess cproc)
                            {
-                              assert(proc.isDialog());
                               // first determine whether to create and/or
                               // show the dialog immediately
                               boolean createDialog = false;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPane.java
Patch:
@@ -59,7 +59,6 @@ protected Toolbar createMainToolbar()
       moreMenu.addItem(commands_.vcsIgnore().createMenuItem(false));
       moreMenu.addSeparator();
       moreMenu.addItem(commands_.showShellDialog().createMenuItem(false));
-      moreMenu.addItem(commands_.newTerminal().createMenuItem(false));
 
       Toolbar toolbar = new Toolbar();
       toolbar.addLeftWidget(commands_.vcsDiff().createToolbarButton());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/SVNPane.java
Patch:
@@ -81,7 +81,6 @@ protected Toolbar createMainToolbar()
       moreMenu.addItem(commands_.vcsShowHistory().createMenuItem(false));
       moreMenu.addSeparator();
       moreMenu.addItem(commands_.showShellDialog().createMenuItem(false));
-      moreMenu.addItem(commands_.newTerminal().createMenuItem(false));
 
       toolbar.addLeftWidget(new ToolbarButton(
           "More",

File: src/gwt/src/org/rstudio/studio/client/common/console/ConsoleProcess.java
Patch:
@@ -61,7 +61,6 @@ public ConsoleProcessFactory(ConsoleServerOperations server,
                                    final SatelliteManager satelliteManager)
       {
          server_ = server;
-         cryptoServer_ = cryptoServer;
          eventBus_ = eventBus;
 
          eventBus_.addHandler(SessionInitEvent.TYPE, new SessionInitHandler()
@@ -264,7 +263,6 @@ public void reap(final String handle, ServerRequestCallback<Void> requestCallbac
       }
       
       private final ConsoleServerOperations server_;
-      private final CryptoServerOperations cryptoServer_;
       private final EventBus eventBus_;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -40,7 +40,6 @@
 import org.rstudio.studio.client.common.GlobalDisplay.NewWindowOptions;
 import org.rstudio.studio.client.common.GlobalProgressDelayer;
 import org.rstudio.studio.client.common.SimpleRequestCallback;
-import org.rstudio.studio.client.common.console.ConsoleProcess;
 import org.rstudio.studio.client.common.dependencies.DependencyManager;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.common.vcs.AskPassManager;
@@ -68,7 +67,6 @@
 import org.rstudio.studio.client.workbench.views.files.events.DirectoryNavigateEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.profiler.ProfilerPresenter;
 import org.rstudio.studio.client.workbench.views.terminal.events.CreateTerminalEvent;
-import org.rstudio.studio.client.workbench.views.vcs.common.ConsoleProgressDialog;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshEvent;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.VcsRefreshHandler;
 import org.rstudio.studio.client.workbench.views.vcs.git.model.GitState;

File: src/gwt/src/org/rstudio/core/client/widget/ShortcutInfoPanel.java
Patch:
@@ -83,7 +83,7 @@ protected Widget getShortcutContent()
             new String[] { "Tabs", "Panes", "Files" },
             new String[] { "Source Navigation", "Execute" },
             new String[] { "Source Editor", "Debug" }, 
-            new String[] { "Source Control", "Build", "Console", "Other" }
+            new String[] { "Source Control", "Build", "Console", "Terminal", "Other" }
       };
       int pctWidth = 100 / groupNames.length;
       sb.appendHtmlConstant("<table width='100%'><tr>");

File: src/gwt/src/org/rstudio/studio/client/common/rstudioapi/RStudioAPI.java
Patch:
@@ -159,7 +159,7 @@ public void onRStudioAPIShowDialogEvent(RStudioAPIShowDialogEvent event)
          showPrompt(
             event.getTitle(), 
             event.getMessage(),
-            "");
+            event.getPromptDefault());
       } else {
          showDialog(
             event.getTitle(), 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -210,7 +210,7 @@ public void terminateCurrentTerminal()
          globalDisplay_.showYesNoMessage(GlobalDisplay.MSG_QUESTION,
                "Close " + visibleTerminal.getTitle(),
                "Are you sure you want to exit the terminal named \"" +
-               visibleTerminal.getTitle() + "\"? Any running jobs will be terminated.",
+               visibleTerminal.getCaption() + "\"? Any running jobs will be terminated.",
                false,
                new Operation()
                {

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -212,7 +212,6 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(ShellSecureInput userInputEncryption);
    void injectMembers(TerminalPopupMenu menu);
    void injectMembers(TerminalList terminalList);
-   void injectMembers(NewConnectionWizard newConnectionDialog);
    void injectMembers(NewConnectionWizard newConnectionWizard);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -339,6 +339,7 @@ public void onError(ServerError error)
                            {
                               // failed, put back original caption on client
                               renameVisibleTerminalInClient(origCaption);
+                              Debug.logError(error);
                            }
                         });
                }
@@ -486,6 +487,7 @@ public void onError(ServerError error)
                   {
                      // failed; this might mean we show the wrong title after
                      // a reset, but it will update itself fairly quickly
+                     Debug.logError(error);
                   }
                });
       }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -4883,7 +4883,7 @@ public void defaultSqlConnectionName(ServerRequestCallback<String> requestCallba
 
    @Override
    public void launchEmbeddedShinyConnectionUI(String packageName, 
-                                               ServerRequestCallback<Void> callback)
+                                               ServerRequestCallback<RResult<Void>> callback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(packageName));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionsServerOperations.java
Patch:
@@ -18,6 +18,7 @@
 import org.rstudio.studio.client.common.crypto.CryptoServerOperations;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.Void;
+import org.rstudio.studio.client.server.remote.RResult;
 
 import com.google.gwt.core.client.JsArray;
 import com.google.gwt.core.client.JsArrayString;
@@ -54,5 +55,5 @@ void installSpark(String sparkVersion,
                      ServerRequestCallback<ConsoleProcess> callback);
 
    void launchEmbeddedShinyConnectionUI(String packageName,
-                                        ServerRequestCallback<Void> callback);
+                                        ServerRequestCallback<RResult<Void>> serverRequestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -84,7 +84,6 @@
 import org.rstudio.studio.client.workbench.views.connections.ui.ConnectionCodePanel;
 import org.rstudio.studio.client.workbench.views.connections.ui.ConnectionExplorer;
 import org.rstudio.studio.client.workbench.views.connections.ui.NewConnectionDialog;
-import org.rstudio.studio.client.workbench.views.connections.ui.SparkMasterChooser;
 import org.rstudio.studio.client.workbench.views.connections.ui.TableBrowser;
 import org.rstudio.studio.client.workbench.views.connections.ui.TableBrowserModel;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.CompletionRequester;
@@ -195,8 +194,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(CppCompletion completion);
    void injectMembers(ConsoleTabPanel consoleTabPanel);
    void injectMembers(VirtualConsole console);
-   void injectMembers(NewConnectionDialog newSparkConnectionDialog);
-   void injectMembers(SparkMasterChooser sparkMasterChooser);
+   void injectMembers(NewConnectionDialog newConnectionDialog);
    void injectMembers(ConnectionCodePanel connectionCodePanel);
    void injectMembers(ConnectionExplorer connectionExplorer);
    void injectMembers(TableBrowser tableBrowser);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/ConnectionOptions.java
Patch:
@@ -9,7 +9,7 @@ protected ConnectionOptions() {}
    
    public static final ConnectionOptions create()
    {
-      return create(null, false, null, null, null);
+      return create(null, null);
    }
    
    public static final native ConnectionOptions create(

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -729,6 +729,7 @@ private void initializeWorkbench()
       if (!uiPrefs_.get().enableXTerm().getValue())
       {
          commands_.newTerminal().remove();
+         commands_.activateTerminal().remove();
       }
       if (!sessionInfo.getAllowPackageInstallation())
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -144,7 +144,6 @@ public void onProcessExit(ProcessExitEvent event)
          consoleProcess_.reap(new VoidServerRequestCallback());
       }
      
-      consoleProcess_ = null;
       eventBus_.fireEvent(new TerminalSessionStoppedEvent(this));
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTabPresenter.java
Patch:
@@ -60,7 +60,6 @@ public TerminalTabPresenter(Display view,
    public void onActivateTerminal()
    {
       view_.activateTerminal();
-      view_.ensureTerminal();
    }
    
    public void initialize()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalSession.java
Patch:
@@ -144,7 +144,6 @@ public void onProcessExit(ProcessExitEvent event)
          consoleProcess_.reap(new VoidServerRequestCallback());
       }
      
-      consoleProcess_ = null;
       eventBus_.fireEvent(new TerminalSessionStoppedEvent(this));
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalTabPresenter.java
Patch:
@@ -60,7 +60,6 @@ public TerminalTabPresenter(Display view,
    public void onActivateTerminal()
    {
       view_.activateTerminal();
-      view_.ensureTerminal();
    }
    
    public void initialize()

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectTemplateWidgetDescription.java
Patch:
@@ -26,5 +26,6 @@ protected ProjectTemplateWidgetDescription()
    public final native String getParameter()     /*-{ return this["parameter"]; }-*/;
    public final native String getType()          /*-{ return this["type"]; }-*/;
    public final native String getLabel()         /*-{ return this["label"]; }-*/;
+   public final native String getDefault()       /*-{ return this["default"]; }-*/;
    public final native JsArrayString getFields() /*-{ return this["fields"]; }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/xterm/XTermWidget.java
Patch:
@@ -21,7 +21,6 @@
 import org.rstudio.core.client.ExternalJavaScriptLoader.Callback;
 import org.rstudio.core.client.resources.StaticDataResource;
 import org.rstudio.studio.client.common.SuperDevMode;
-import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.ChunkOutputUi;
 import org.rstudio.studio.client.workbench.views.terminal.events.ResizeTerminalEvent;
 import org.rstudio.studio.client.workbench.views.terminal.events.TerminalDataInputEvent;
 import org.rstudio.studio.client.workbench.views.terminal.xterm.XTermDimensions;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/TerminalPane.java
Patch:
@@ -121,7 +121,6 @@ public void onTerminalSessionStarted(TerminalSessionStartedEvent event)
    {
       terminalSessionsPanel_.add(event.getTerminalWidget());
       terminalSessionsPanel_.showWidget(event.getTerminalWidget());
-      terminalSessionsPanel_.forceLayout();
       
       // TODO (gary) update dropdown
    } 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4108,10 +4108,8 @@ private void onInsertChunk(String chunkPlaceholder, int rowOffset, int colOffset
       InsertChunkInfo insertChunkInfo = docDisplay_.getInsertChunkInfo();
       if (insertChunkInfo != null)
       {
-         insertChunkInfo.setValue(chunkPlaceholder);
-         
          // inject the chunk skeleton
-         docDisplay_.insertCode(insertChunkInfo.getValue(), false);
+         docDisplay_.insertCode(chunkPlaceholder, false);
 
          // if we had text selected, inject it into the chunk
          if (!StringUtil.isNullOrEmpty(sel))

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4108,10 +4108,8 @@ private void onInsertChunk(String chunkPlaceholder, int rowOffset, int colOffset
       InsertChunkInfo insertChunkInfo = docDisplay_.getInsertChunkInfo();
       if (insertChunkInfo != null)
       {
-         insertChunkInfo.setValue(chunkPlaceholder);
-         
          // inject the chunk skeleton
-         docDisplay_.insertCode(insertChunkInfo.getValue(), false);
+         docDisplay_.insertCode(chunkPlaceholder, false);
 
          // if we had text selected, inject it into the chunk
          if (!StringUtil.isNullOrEmpty(sel))

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -217,7 +217,6 @@ public static List<Dependency> rmarkdownDependencies()
       deps.add(Dependency.cranPackage("knitr", "1.14", true));
       deps.add(Dependency.cranPackage("jsonlite", "0.9.19"));
       deps.add(Dependency.cranPackage("base64enc", "0.1-3"));
-      deps.add(Dependency.cranPackage("tibble", "1.1"));
       deps.add(Dependency.cranPackage("rprojroot", "1.0"));
       deps.add(Dependency.embeddedPackage("rmarkdown"));
       return deps;

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -529,6 +529,9 @@ private void flushPendingEvents(String name)
    // export the global function required for satellites to register
    private native void exportSatelliteRegistrationCallback() /*-{
       var manager = this;     
+      
+      $wnd.$RStudio = {};
+      
       $wnd.registerAsRStudioSatellite = $entry(
          function(name, satelliteWnd) {
             manager.@org.rstudio.studio.client.common.satellite.SatelliteManager::registerAsSatellite(Ljava/lang/String;Lcom/google/gwt/core/client/JavaScriptObject;)(name, satelliteWnd);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3291,7 +3291,7 @@ private void doCommentUncomment(String commentStart,
                isCommentAction = true;
          }
          
-         if (docDisplay_.getFileType().isRmd())
+         if (docDisplay_.getFileType().isR())
          {
             if (!looksLikeRoxygen)
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTargetCodeExecution.java
Patch:
@@ -90,7 +90,7 @@ public void executeSelection(boolean consoleExecuteWhenNotFocused,
          boolean onlyUseConsole)
    {
       // when executing LaTeX in R Markdown, show a popup preview
-      if (executeLatex())
+      if (executeLatex(false))
          return;
       
       // when executing inline R code, show a popup preview
@@ -343,7 +343,7 @@ private boolean isRoxygenLine(String line)
       return (trimmedLine.length() == 0) || trimmedLine.startsWith("#'");
    }
    
-   private boolean executeLatex()
+   private boolean executeLatex(boolean background)
    {
       // need a suitable editing target to render LaTeX chunks
       if (target_ == null)
@@ -352,7 +352,7 @@ private boolean executeLatex()
       Range range = MathJaxUtil.getLatexRange(docDisplay_);
       if (range == null)
          return false;
-      target_.renderLatex(range);
+      target_.renderLatex(range, background);
       return true;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorIdleCommands.java
Patch:
@@ -73,7 +73,7 @@ private void onPreviewLatex(TextEditingTarget target,
             TextEditingTargetNotebook.CONTENT_PREVIEW_ENABLED,
             pref != UIPrefsAccessor.LATEX_PREVIEW_SHOW_NEVER))
       {
-         target.renderLatex(range);
+         target.renderLatex(range, true);
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4453,10 +4453,10 @@ public void renderLatex()
          mathjax_.renderLatex();
    }
    
-   public void renderLatex(Range range)
+   public void renderLatex(Range range, boolean background)
    {
       if (mathjax_ != null)
-         mathjax_.renderLatex(range);
+         mathjax_.renderLatex(range, background);
    }
 
    public String getDefaultNamePrefix()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkDataWidget.java
Patch:
@@ -125,7 +125,7 @@ private final native boolean pagedTableExists() /*-{
    private final native JavaScriptObject showDataOutputNative(JavaScriptObject data, 
          Element parent, boolean fullSize) /*-{
       var pagedTable = $doc.createElement("div");
-      pagedTable.setAttribute("data-pagedtable", "");
+      pagedTable.setAttribute("data-pagedtable", "false");
 
       if (fullSize) {
          pagedTable.setAttribute("class", "pagedtable-expand");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkInlineOutput.java
Patch:
@@ -52,6 +52,7 @@ public ChunkInlineOutput(String chunkId, final AnchoredSelection selection)
       chunkId_ = chunkId;
       selection_ = selection;
       state_ = State.Queued;
+      
       addStyleName(RES.styles().panel());
       
       // detach anchored selection when closing so we don't accumulate 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -408,7 +408,7 @@ public void onEditorThemeChanged(EditorThemeListener.Colors colors)
             ChunkOutputFrame frame = (ChunkOutputFrame)w;
             frame.runAfterRender(afterRender_);
          }
-         if (w instanceof FixedRatioWidget)
+         else if (w instanceof FixedRatioWidget)
          {
             FixedRatioWidget fixedRatioWidget = (FixedRatioWidget)w;
             Widget innerWidget = fixedRatioWidget.getWidget();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputFrame.java
Patch:
@@ -96,7 +96,7 @@ public void run()
          {
             Element body = getDocument().getBody();
 
-            if (body.getChildCount() > 0) {
+            if (body != null && body.getChildCount() > 0) {
                command.execute();
             } else if (retryCount_ < 50) {
                retryCount_++;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -408,7 +408,7 @@ public void onEditorThemeChanged(EditorThemeListener.Colors colors)
             ChunkOutputFrame frame = (ChunkOutputFrame)w;
             frame.runAfterRender(afterRender_);
          }
-         if (w instanceof FixedRatioWidget)
+         else if (w instanceof FixedRatioWidget)
          {
             FixedRatioWidget fixedRatioWidget = (FixedRatioWidget)w;
             Widget innerWidget = fixedRatioWidget.getWidget();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/YamlTree.java
Patch:
@@ -123,7 +123,7 @@ private String getKey(String line)
          if (result == null)
             return "";
           else
-            return result.getGroup(1);
+            return result.getGroup(1).trim();
       }
 
       private int getIndentLevel()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/findreplace/FindReplace.java
Patch:
@@ -163,6 +163,7 @@ public void activate(String searchText,
                         boolean inSelection)
    {
       defaultForward_ = defaultForward;
+      incrementalSearchPosition_ = null;
       display_.activate(searchText, defaultForward, inSelection);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/findreplace/FindReplace.java
Patch:
@@ -163,6 +163,7 @@ public void activate(String searchText,
                         boolean inSelection)
    {
       defaultForward_ = defaultForward;
+      incrementalSearchPosition_ = null;
       display_.activate(searchText, defaultForward, inSelection);
    }
    

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/YamlTree.java
Patch:
@@ -123,7 +123,7 @@ private String getKey(String line)
          if (result == null)
             return "";
           else
-            return result.getGroup(1);
+            return result.getGroup(1).trim();
       }
 
       private int getIndentLevel()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -250,10 +250,11 @@ public void execute()
             onRenderComplete.execute();
             
             if (!knitrFigure) {
-               frame.getWindow().getDocument().getBody().getStyle().setOverflow(Overflow.SCROLL);
-               
                int contentHeight = frame.getWindow().getDocument().getBody().getOffsetHeight();
                frame.getElement().getStyle().setHeight(contentHeight, Unit.PX);
+
+               frame.getElement().getStyle().setOverflow(Overflow.HIDDEN);
+               frame.getWindow().getDocument().getBody().getStyle().setOverflow(Overflow.HIDDEN);
             }
             
             onHeightChanged();

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -259,7 +259,7 @@ public void execute()
           userPrompt,
           shinyDependenciesArray(
               "0.11.0", // shiny version
-              "0.2.6"), // htmltools version
+              "0.3.5"), // htmltools version
           true,
           new CommandWithArg<Boolean>()
           {
@@ -278,7 +278,7 @@ public void withShinyAddins(final Command command)
       // define dependencies
       ArrayList<Dependency> deps = shinyDependencies(
                                     "0.13", // shiny version
-                                    "0.3"); // htmltools version
+                                    "0.3.5"); // htmltools version
       deps.add(Dependency.cranPackage("miniUI", "0.1.1", true));
       deps.add(Dependency.cranPackage("rstudioapi", "0.5", true));
       
@@ -318,6 +318,7 @@ private ArrayList<Dependency> shinyDependencies(String shinyVersion,
       deps.add(Dependency.cranPackage("xtable", "1.7"));
       deps.add(Dependency.cranPackage("digest", "0.6"));
       deps.add(Dependency.cranPackage("R6", "2.0"));
+      deps.add(Dependency.cranPackage("sourcetools", "0.1.5"));
       deps.add(Dependency.cranPackage("htmltools", htmltoolsVersion));
       deps.add(Dependency.cranPackage("shiny", shinyVersion, true));
       return deps;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdRenderResult.java
Patch:
@@ -40,6 +40,7 @@ public static native final RmdRenderResult createFromShinyDoc(
         is_shiny_document: true,
         preview_slide: doc.preview_slide,
         slide_navigation: doc.slide_navigation,
+        runtime: doc.runtime,
         viewed: false
      };
    }-*/;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/terminal/XTermTerminal.java
Patch:
@@ -67,6 +67,4 @@ private static final ExternalJavaScriptLoader getLoader(StaticDataResource relea
    private static final ExternalJavaScriptLoader xtermLoader_ =
          getLoader(XTermResources.INSTANCE.xtermjs(), XTermResources.INSTANCE.xtermjs() /*TODO uncompressed flavor */);
    
-   private static final ExternalJavaScriptLoader xtermSupportLoader_ =
-         getLoader(XTermResources.INSTANCE.xtermsupportjs()); 
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -521,7 +521,7 @@ public boolean isRuntimeShiny(String yaml)
             return false;
          
          return tree.getKeyValue(
-             RmdFrontMatter.RUNTIME_KEY).equals(RmdFrontMatter.SHINY_RUNTIME);
+             RmdFrontMatter.RUNTIME_KEY).startsWith(RmdFrontMatter.SHINY_RUNTIME);
       }
       catch (Exception e)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkOutputUi.java
Patch:
@@ -263,7 +263,8 @@ public boolean hasErrors()
    public final static int CHUNK_COLLAPSED_HEIGHT = 15;
    public final static int MAX_CHUNK_HEIGHT = 650;
    
-   public final static int MAX_PLOT_WIDTH = 650;
+   public final static int MIN_PLOT_WIDTH = 400;
+   public final static int MAX_PLOT_WIDTH = 700;
    public final static int MAX_HTMLWIDGET_WIDTH = 800;
    
    public final static double OUTPUT_ASPECT = 1.618;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -1226,7 +1226,8 @@ public int getPlotWidth()
       // space outside the element (here, 2 * (10px margin + 1px border)); since
       // we stretch the plot to fit the space it will scale in unpredictable
       // ways if it doesn't fit exactly
-      return Math.min(docDisplay_.getPixelWidth() - 22,
+      return Math.min(Math.max(docDisplay_.getPixelWidth() - 22, 
+                               ChunkOutputUi.MIN_PLOT_WIDTH),
                       ChunkOutputUi.MAX_PLOT_WIDTH);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetIdleMonitor.java
Patch:
@@ -113,7 +113,7 @@ private static void executeIdleCommands(TextEditingTarget editingTarget,
       }
    }
    
-   private void beginMonitoring()
+   public void beginMonitoring()
    {
       endMonitoring();
       monitors_.add(display_.addEditorModeChangedHandler(
@@ -154,7 +154,7 @@ public void onAttachOrDetach(AttachEvent event)
       }));
    }
    
-   private void endMonitoring()
+   public void endMonitoring()
    {
       for (HandlerRegistration monitor : monitors_)
          monitor.removeHandler();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetIdleMonitor.java
Patch:
@@ -113,7 +113,7 @@ private static void executeIdleCommands(TextEditingTarget editingTarget,
       }
    }
    
-   private void beginMonitoring()
+   public void beginMonitoring()
    {
       endMonitoring();
       monitors_.add(display_.addEditorModeChangedHandler(
@@ -154,7 +154,7 @@ public void onAttachOrDetach(AttachEvent event)
       }));
    }
    
-   private void endMonitoring()
+   public void endMonitoring()
    {
       for (HandlerRegistration monitor : monitors_)
          monitor.removeHandler();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -673,7 +673,7 @@ private void showBusyState()
 
    private void showReadyState()
    {
-      if (getElement() != null && getElement().getStyle() != null)
+      if (getElement() != null && getElement().getStyle() != null && s_colors != null)
       {
          getElement().getStyle().setBackgroundColor(s_colors.background);
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -673,7 +673,7 @@ private void showBusyState()
 
    private void showReadyState()
    {
-      if (getElement() != null && getElement().getStyle() != null)
+      if (getElement() != null && getElement().getStyle() != null && s_colors != null)
       {
          getElement().getStyle().setBackgroundColor(s_colors.background);
       }

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxLoader.java
Patch:
@@ -111,7 +111,7 @@ private static final native void initializeMathJaxConfig() /*-{
             minScaleAdjust: 125,
             availableFonts: []
          },
-         showProcessingMessage: false,
+         showProcessingMessages: false,
          showMathMenu: false,
          messageStyle: "none",
          skipStartupTypeset: true,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -404,6 +404,7 @@ void highlightDebugLocation(
    void removeAllLineWidgets();
    void onLineWidgetChanged(LineWidget widget); 
    
+   boolean hasLineWidgets();
    JsArray<LineWidget> getLineWidgets();
    LineWidget getLineWidgetForRow(int row);
    

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectPublishSource.java
Patch:
@@ -105,7 +105,7 @@ public RSConnectPublishSource(String sourceFile, String deployDir,
       isShiny_ = isShiny;
       isSingleFileShiny_ = false;
       description_ = description;
-      contentCategory_ = StringUtil.isNullOrEmpty(websiteDir) ? 
+      contentCategory_ = !StringUtil.isNullOrEmpty(websiteDir) ? 
             RSConnect.CONTENT_CATEGORY_SITE : null;
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -149,7 +149,7 @@ public class FileTypeRegistry
          null, false);
    
    public static final TextFileType YAML =
-         new TextFileType("yaml", "YAML", EditorLanguage.LANG_YAML, ".yaml",
+         new TextFileType("yaml", "YAML", EditorLanguage.LANG_YAML, ".yml",
                           ICONS.iconYaml(), false, false, false, false, false,
                           false, false, false, false, false, false, false, false);
 

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJax.java
Patch:
@@ -195,8 +195,7 @@ public void execute(ChunkOutputWidget cow, PinnedLineWidget plw)
    
    public void renderLatex()
    {
-      final List<Range> ranges = MathJaxUtil.findLatexChunks(
-            docDisplay_.getFirstVisibleRow(), docDisplay_);
+      final List<Range> ranges = MathJaxUtil.findLatexChunks(docDisplay_);
       renderQueue_.enqueueAndRender(ranges);
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJaxUtil.java
Patch:
@@ -104,14 +104,13 @@ public static boolean isSelectionWithinLatexChunk(DocDisplay docDisplay)
       return true;
    }
    
-   public static List<Range> findLatexChunks(int startRow, 
-         DocDisplay docDisplay)
+   public static List<Range> findLatexChunks(DocDisplay docDisplay)
    {
       docDisplay.tokenizeDocument();
       List<Range> ranges = new ArrayList<Range>();
       
       Position startPos = null;
-      for (int i = startRow, n = docDisplay.getRowCount(); i < n; i++)
+      for (int i = 0, n = docDisplay.getRowCount(); i < n; i++)
       {
          Position pos = Position.create(i, 0);
          Token token = docDisplay.getTokenAt(Position.create(i, 0));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ImagePreviewer.java
Patch:
@@ -112,8 +112,7 @@ public void onValueChange(ValueChangeEvent<String> val)
    
    private void previewAllLinks()
    {
-      for (int i = display_.getFirstVisibleRow(), n = display_.getRowCount(); 
-           i < n; i++)
+      for (int i = 0, n = display_.getRowCount(); i < n; i++)
       {
          String line = display_.getLine(i);
          if (isStandaloneMarkdownLink(line))

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4394,7 +4394,8 @@ else if (which == TextEditingTargetScopeHelper.FOLLOWING_CHUNKS)
       for (Scope scope : previousScopes)
       {
          if (isExecutableChunk(scope))
-            chunks.add(new ChunkExecUnit(scope));
+            chunks.add(
+                  new ChunkExecUnit(scope, NotebookQueueUnit.EXEC_MODE_BATCH));
       }
       
       if (!chunks.isEmpty())

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4394,7 +4394,8 @@ else if (which == TextEditingTargetScopeHelper.FOLLOWING_CHUNKS)
       for (Scope scope : previousScopes)
       {
          if (isExecutableChunk(scope))
-            chunks.add(new ChunkExecUnit(scope));
+            chunks.add(
+                  new ChunkExecUnit(scope, NotebookQueueUnit.EXEC_MODE_BATCH));
       }
       
       if (!chunks.isEmpty())

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -173,4 +173,6 @@ public interface ThemeStyles extends CssResource
    String borderedIFrame();
    
    String toolbarInfoLabel();
+   
+   String displayNone();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorBackgroundLinkHighlighter.java
Patch:
@@ -403,9 +403,8 @@ private void highlight(final AceEditor editor,
       final String title = BrowseCap.isMacintosh()
             ? "Open Link (Command+Click)"
             : "Open Link (Shift+Click)";
-      MarkerRenderer renderer = MarkerRenderer.create(styles, title);
       
-      int markerId = editor.getSession().addMarker(anchoredRange, styles, renderer, true);
+      int markerId = editor.getSession().addMarker(anchoredRange, styles, "text", true);
       registerActiveMarker(row, id, markerId, anchoredRange);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/NewSparkConnectionContext.java
Patch:
@@ -139,8 +139,6 @@ private final ArrayList<String> getDefaultClusterConnections()
          String option = connectionsOption.get(i);
          if (!MASTER_LOCAL.equals(option) && !MASTER_CLUSTER.equals(option))
          {
-            if (!option.startsWith("spark://"))
-               option = "spark://" + option;
             connections.add(option);
          }
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/SparkMasterChooser.java
Patch:
@@ -112,10 +112,8 @@ public void execute(PromptWithOptionResult input,
                      {
                         indicator.onCompleted();
                         
-                        // get master (prepend spark:// if necessary)
+                        // get master
                         String master = input.input;
-                        if (!master.startsWith("spark://"))
-                           master = "spark://" + master;
                         
                         // add the item to the list if necessary
                         int targetItem = -1;

File: src/gwt/src/org/rstudio/studio/client/common/mathjax/MathJax.java
Patch:
@@ -118,7 +118,7 @@ public void run()
                // re-render latex in a visible mathjax popup
                if (popup_.isShowing() && anchor_ != null)
                {
-                  renderLatex(anchor_.getRange(), true);
+                  renderLatex(anchor_.getRange(), false);
                   return;
                }
                
@@ -128,7 +128,7 @@ public void run()
                {
                   Range range = MathJaxUtil.getLatexRange(docDisplay_);
                   if (range != null)
-                     renderLatex(range, true);
+                     renderLatex(range, false);
                }
             }
          };

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewSparkConnectionDialog.java
Patch:
@@ -122,7 +122,7 @@ protected Widget createMainWidget()
          @Override
          public void execute()
          {
-            versionGrid.setVisible(master_.isLocalMasterSelected());
+            versionGrid.setVisible(master_.isLocalMasterSelected() && context_.getSparkHome() == null);
          }
       };
       onMasterChanged.execute();
@@ -215,7 +215,7 @@ public void execute()
          {   
             SparkVersion sparkVersion = getSelectedSparkVersion();
             
-            if (sparkVersion != null)
+            if (sparkVersion != null && context_.getSparkHome() == null)
             {
                boolean remote = !master_.isLocalMaster(master_.getSelection());
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewSparkConnectionDialog.java
Patch:
@@ -278,7 +278,7 @@ public void execute()
             builder.append("sc <- spark_connect(master = \"");
             builder.append(masterComponents[0]);
             builder.append("\"");
-            if (masterComponents.length > 0)
+            if (masterComponents.length > 1)
             {
                builder.append(", app_name = \"");
                builder.append(masterComponents[1]);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/PinnedLineWidget.java
Patch:
@@ -41,6 +41,7 @@ public class PinnedLineWidget
 {
    public interface Host
    {
+      void onLineWidgetAdded(LineWidget widget);
       void onLineWidgetRemoved(LineWidget widget);
    }
 
@@ -134,6 +135,8 @@ public void onRenderFinished(RenderFinishedEvent event)
    {
       // add the widget to the document and notify the host
       display_.addLineWidget(lineWidget_);
+      if (host_ != null)
+         host_.onLineWidgetAdded(lineWidget_);
 
       // remove the handler (single shot)
       renderFinishedReg_.removeHandler();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkSatelliteWindow.java
Patch:
@@ -253,14 +253,14 @@ public void onRmdChunkOutputFinished(RmdChunkOutputFinishedEvent event)
 
       if (event.getData().getChunkId() != chunkWindowParams_.getChunkId())
          return;
+
+      resizePlotsRemote_.schedule(10);
       
       RmdChunkOutputFinishedEvent.Data data = event.getData();
 
       chunkOutputWidget_.onOutputFinished(
          false,
          data.getScope());
-
-      resizePlotsRemote_.schedule(1);
    }
 
    @Override
@@ -293,7 +293,7 @@ public void run()
          // avoid reentrancy
          if (currentPlotsReplayId_ != null)
             return;
-         
+
          server_.replayNotebookChunkPlots(
             chunkWindowParams_.getDocId(), 
             chunkWindowParams_.getChunkId(),

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -173,4 +173,6 @@ public interface ThemeStyles extends CssResource
    String borderedIFrame();
    
    String toolbarInfoLabel();
+   
+   String displayNone();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1235,7 +1235,7 @@ public void initialize(final SourceDocument document,
       chunks_ = new TextEditingTargetChunks(this);
       notebook_ = new TextEditingTargetNotebook(this, chunks_, view_, 
             docDisplay_, dirtyState_, docUpdateSentinel_, document, 
-            releaseOnDismiss_);
+            releaseOnDismiss_, dependencyManager_);
       view_.addResizeHandler(notebook_);
       
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -317,7 +317,7 @@ private void promptForFactorString(
    {
       globalDisplay_.promptForText(
          title,
-         "Please a comma separated list of factors",
+         "Please insert a comma separated list of factors",
          "",
          new OperationWithInput<String>()
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3123,7 +3123,8 @@ public void execute()
                {
                   if (docs.get(i).getId() == getId())
                   {
-                     docs.get(i).setChunkDefs(docDisplay_.getChunkDefs());
+                     docs.get(i).getNotebookDoc().setChunkDefs(
+                           docDisplay_.getChunkDefs());
                      docs.get(i).setContents(docDisplay_.getCode());
                      docs.get(i).setDirty(dirtyState_.getValue());
                      break;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DocUpdateSentinel.java
Patch:
@@ -460,7 +460,7 @@ public void onResponseReceived(String newHash)
                         // can use them for change detection the next
                         // time around
                         sourceDoc_.setFoldSpec(foldSpec);
-                        sourceDoc_.setChunkDefs(newChunkDefs);
+                        sourceDoc_.getNotebookDoc().setChunkDefs(newChunkDefs);
                         
                         onSuccessfulUpdate(newContents,
                                            newHash,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkWindowManager.java
Patch:
@@ -34,13 +34,12 @@ public ChunkWindowManager(
 
    public void openChunkWindow(String docId, String chunkId, Size sourceSize)
    {
-      Size size = ZoomUtils.getZoomWindowSize(sourceSize, new Size(850,1100));
-      Point position = new Point(0, 0);
+      Size size = ZoomUtils.getZoomWindowSize(sourceSize, null);
       
       pSatelliteManager_.get().openSatellite(
          getName(docId, chunkId), 
          ChunkWindowParams.create(docId, chunkId), 
-         size, false, position);
+         size);
    }
    
    public String getName(String docId, String chunkId)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkWindowManager.java
Patch:
@@ -34,13 +34,12 @@ public ChunkWindowManager(
 
    public void openChunkWindow(String docId, String chunkId, Size sourceSize)
    {
-      Size size = ZoomUtils.getZoomWindowSize(sourceSize, new Size(850,1100));
-      Point position = new Point(0, 0);
+      Size size = ZoomUtils.getZoomWindowSize(sourceSize, null);
       
       pSatelliteManager_.get().openSatellite(
          getName(docId, chunkId), 
          ChunkWindowParams.create(docId, chunkId), 
-         size, false, position);
+         size);
    }
    
    public String getName(String docId, String chunkId)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorIdleCommands.java
Patch:
@@ -405,8 +405,8 @@ public void onOutputHeightChanged(ChunkOutputWidget widget,
       };
       
       cow.set(new ChunkOutputWidget(
-            StringUtil.makeRandomId(8),
-            StringUtil.makeRandomId(8),
+            "",
+            "md-image-preview-" + StringUtil.makeRandomId(8),
             RmdChunkOptions.create(),
             ChunkOutputWidget.EXPANDED,
             host));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -842,8 +842,7 @@ else if (state_ == CHUNK_POST_OUTPUT &&
                presenter_ instanceof ChunkOutputStream &&
                (type == RmdChunkOutputUnit.TYPE_HTML || 
                 type == RmdChunkOutputUnit.TYPE_PLOT ||
-                type == RmdChunkOutputUnit.TYPE_DATA ||
-                chunkOutputSize_ == ChunkOutputSize.Full))
+                type == RmdChunkOutputUnit.TYPE_DATA))
       {
          // if we're adding a block widget into an existing chunk, we 
          // need to switch to gallery mode 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorIdleCommands.java
Patch:
@@ -292,6 +292,7 @@ public void onBrowserEvent(Event event)
             else if (DOM.eventGetType(event) == Event.ONERROR)
             {
                container.setWidget(noImageLabel);
+               onResize.execute(50);
             }
          }
       });
@@ -338,6 +339,7 @@ public void run()
                   return;
                
                // set new src location (load handler will replace label as needed)
+               container.setWidget(new SimplePanel());
                noImageLabel.setText("(No image at path " + href_ + ")");
                image.getElement().setAttribute("src", imgSrcPathFromHref(href_));
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkPlotPage.java
Patch:
@@ -65,7 +65,7 @@ public void execute()
                thumbnail.setUrl(url);
                onRenderComplete.execute();
             }
-         });
+         }, chunkOutputSize);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkPlotWidget.java
Patch:
@@ -79,10 +79,12 @@ public void onBrowserEvent(Event event)
       
       if (isFixedSizePlotUrl(url))
       {
+         boolean hide = chunkOutputSize_ != ChunkOutputSize.Default;
+
          // if the plot is of fixed size, emit it directly, but make it
          // initially invisible until we get sizing information (as we may 
          // have to downsample)
-         plot_.setVisible(false);
+         plot_.setVisible(hide);
       }
       else if (chunkOutputSize_ == ChunkOutputSize.Full)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceClickEvent.java
Patch:
@@ -22,7 +22,7 @@ public class AceClickEvent extends GwtEvent<AceClickEvent.Handler>
 {
    public interface Handler extends EventHandler
    {
-      void onClick(AceClickEvent event);
+      void onAceClick(AceClickEvent event);
    }
 
    public AceClickEvent(AceMouseEventNative event)
@@ -59,7 +59,7 @@ public Type<Handler> getAssociatedType()
    @Override
    protected void dispatch(Handler handler)
    {
-      handler.onClick(this);
+      handler.onAceClick(this);
    }
 
    private final AceMouseEventNative event_;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishButton.java
Patch:
@@ -205,8 +205,8 @@ public void setRmdPreview(RmdPreviewParams params)
              params.getResult().getFormat() != null))
       {
          setContentType(params.isWebsiteRmd() ? 
-               RSConnect.CONTENT_TYPE_DOCUMENT :
-               RSConnect.CONTENT_TYPE_WEBSITE);
+               RSConnect.CONTENT_TYPE_WEBSITE :
+               RSConnect.CONTENT_TYPE_DOCUMENT);
          docPreview_ = new RenderedDocPreview(params);
          setContentPath(params.getResult().getTargetFile(),
                params.getOutputFile());

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -214,11 +214,13 @@ else if (type.equals(ClientEvent.ConsoleOutput))
          {
             ConsoleText output = event.getData();
             eventBus_.fireEvent(new ConsoleWriteOutputEvent(output));
+            eventBus_.fireEventToAllSatellites(new ConsoleWriteOutputEvent(output));
          }
          else if (type.equals(ClientEvent.ConsoleError))
          {
             ConsoleText error = event.getData();
             eventBus_.fireEvent(new ConsoleWriteErrorEvent(error));
+            eventBus_.fireEventToAllSatellites(new ConsoleWriteErrorEvent(error));
          }
          else if (type.equals(ClientEvent.ConsoleWritePrompt))
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceSatellite.java
Patch:
@@ -38,7 +38,7 @@ public SourceSatellite(String name)
    }
 
    @Inject
-   public void initialize(ChunkSatelliteView view,
+   public void initialize(SourceSatelliteView view,
                           Satellite satellite,
                           Provider<AceThemes> pAceThemes,
                           ApplicationUncaughtExceptionHandler exHandler)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkSatelliteWindow.java
Patch:
@@ -80,6 +80,8 @@ public void onOutputHeightChanged(ChunkOutputWidget widget,
       mainPanel.add(chunkOutputWidget_);
       mainPanel.setWidgetLeftRight(chunkOutputWidget_, 0, Unit.PX, 0, Unit.PX);
       mainPanel.setWidgetTopBottom(chunkOutputWidget_, 0, Unit.PX, 0, Unit.PX);
+      
+      mainPanel.getElement().getStyle().setBackgroundColor("#FFF");
 
       pEventBus_.get().fireEventToMainWindow(new ChunkSatelliteWindowOpenedEvent(
          chunkWindowParams_.getDocId(),

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkDefinition.java
Patch:
@@ -71,7 +71,7 @@ public native final int getExpansionState() /*-{
    }-*/;
    
    public native final String getDocumentId() /*-{
-      return this.docuemnt_id;
+      return this.document_id;
    }-*/;
    
    public native final String getChunkId() /*-{

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectActionEvent.java
Patch:
@@ -45,10 +45,10 @@ public static RSConnectActionEvent DeployAppEvent(String path,
    }
    
    public static RSConnectActionEvent DeployDocEvent(RenderedDocPreview params,
-         RSConnectDeploymentRecord fromPrevious)
+         int type, RSConnectDeploymentRecord fromPrevious)
    {
       return new RSConnectActionEvent(ACTION_TYPE_DEPLOY,
-            RSConnect.CONTENT_TYPE_DOCUMENT, 
+            type,
             params.getSourceFile(),
             params.getOutputFile(), 
             null,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextToolbar.java
Patch:
@@ -73,7 +73,6 @@ public ChunkContextToolbar(Host host, boolean dark, boolean runPrevious,
 
       initRunPrevious(dark);
       setRunPrevious(runPrevious);
-      initChangeChunkEngine(engine);
       
       initRun();
       setRun(run);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -236,4 +236,6 @@ public void setSourceDocumentDirty(String docId, boolean dirty,
    
    public void extractRmdFromNotebook(String inputPath,
          ServerRequestCallback<SourceDocumentResult> requestCallback);
+
+   public void defaultSqlConnectionName(ServerRequestCallback<String> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextToolbar.java
Patch:
@@ -73,7 +73,6 @@ public ChunkContextToolbar(Host host, boolean dark, boolean runPrevious,
 
       initRunPrevious(dark);
       setRunPrevious(runPrevious);
-      initChangeChunkEngine(engine);
       
       initRun();
       setRun(run);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkContextUi.java
Patch:
@@ -186,6 +186,8 @@ public void switchChunk(String chunkType)
             
             String newFirstLine = firstLine.replaceFirst("{[a-zA-Z]+", "{" + chunkType);
             docDisplay.replaceRange(Range.fromPoints(start, linedEnd), newFirstLine);
+            
+            target_.getNotebook().clearChunkOutput(chunk_);
          }
       }
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java
Patch:
@@ -435,7 +435,7 @@ public List<ChunkOutputPage> extractPages()
          {
             ChunkDataWidget widget = (ChunkDataWidget)w;
             ChunkDataPage data = new ChunkDataPage(widget, 
-                  (NotebookFrameMetadata)metadata.cast());
+                  (NotebookFrameMetadata)metadata.cast(), ordinal);
             pages.add(data);
             remove(w);
             continue;
@@ -450,15 +450,15 @@ public List<ChunkOutputPage> extractPages()
          if (inner instanceof Image)
          {
             Image image = (Image)inner;
-            ChunkPlotPage plot = new ChunkPlotPage(image.getUrl());
+            ChunkPlotPage plot = new ChunkPlotPage(image.getUrl(), ordinal);
             pages.add(plot);
             remove(w);
          }
          else if (inner instanceof ChunkOutputFrame)
          {
             ChunkOutputFrame frame = (ChunkOutputFrame)inner;
             ChunkHtmlPage html = new ChunkHtmlPage(frame.getUrl(), 
-                  (NotebookHtmlMetadata)metadata.cast(), null);
+                  (NotebookHtmlMetadata)metadata.cast(), ordinal, null);
             pages.add(html);
             remove(w);
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkPlotPage.java
Patch:
@@ -28,10 +28,11 @@
 import com.google.gwt.user.client.ui.SimplePanel;
 import com.google.gwt.user.client.ui.Widget;
 
-public class ChunkPlotPage implements ChunkOutputPage
+public class ChunkPlotPage extends ChunkOutputPage
 {
-   public ChunkPlotPage(final String url)
+   public ChunkPlotPage(final String url, int ordinal)
    {
+      super(ordinal);
       if (isFixedSizePlotUrl(url))
       {
          final Image thumbnail = new Image();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputPage.java
Patch:
@@ -20,4 +20,5 @@ public interface ChunkOutputPage
 {
    Widget thumbnailWidget();
    Widget contentWidget();
+   void onSelected();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputPresenter.java
Patch:
@@ -56,5 +56,6 @@ void showDataOutput(JavaScriptObject data, NotebookFrameMetadata metadata,
    // query state
    boolean hasOutput();
    boolean hasPlots();
+   boolean hasErrors();
 }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputThumbnail.java
Patch:
@@ -41,7 +41,7 @@ public ChunkOutputThumbnail(String title, String subtitle, Widget backdrop)
       if (backdrop != null)
          backdrop_.add(backdrop);
    }
-
+   
    @UiField Label title_;
    @UiField Label subtitle_;
    @UiField SimplePanel backdrop_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -45,18 +45,15 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.ChunkOutputHost;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.ChunkOutputUi;
 
-import com.gargoylesoftware.htmlunit.javascript.host.Document;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
 import com.google.gwt.core.client.ScriptInjector;
 import com.google.gwt.dom.client.Element;
-import com.google.gwt.dom.client.LinkElement;
 import com.google.gwt.dom.client.Style;
 import com.google.gwt.dom.client.Style.Display;
 import com.google.gwt.dom.client.Style.Overflow;
 import com.google.gwt.dom.client.Style.Unit;
-import com.google.gwt.dom.client.StyleInjector;
 import com.google.gwt.event.logical.shared.ValueChangeHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ClientBundle;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -4044,9 +4044,10 @@ private void onInsertChunk(String chunkPlaceholder)
       
       Position pos = moveCursorToNextInsertLocation();
       InsertChunkInfo insertChunkInfo = docDisplay_.getInsertChunkInfo();
-      insertChunkInfo.setValue(chunkPlaceholder);
       if (insertChunkInfo != null)
       {
+         insertChunkInfo.setValue(chunkPlaceholder);
+         
          // inject the chunk skeleton
          docDisplay_.insertCode(insertChunkInfo.getValue(), false);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -537,7 +537,7 @@ public PrefValue<Boolean> showPublishUi()
 
    public PrefValue<Boolean> enableRStudioConnect()
    {
-      return bool("enable_rstudio_connect", false);
+      return bool("enable_rsconnect_publish_ui", true);
    }
    
    public PrefValue<RSConnectAccount> preferredPublishAccount()

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -120,7 +120,7 @@ public void withRSConnect(String userAction,
       if (requiresRmarkdown)
          deps.addAll(rmarkdownDependencies());
       deps.add(Dependency.cranPackage("packrat", "0.4.7", true));
-      deps.add(Dependency.cranPackage("rsconnect", "0.4.3", true));
+      deps.add(Dependency.embeddedPackage("rsconnect"));
       
       withDependencies(
         "Publishing",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -101,6 +101,7 @@ public AceEditorWidget(boolean applyNormalFontSize)
       editor_.setPrintMarginColumn(0);
       editor_.setHighlightActiveLine(false);
       editor_.setHighlightGutterLine(false);
+      editor_.setFixedWidthGutter(true);
       editor_.delegateEventsTo(AceEditorWidget.this);
       editor_.onChange(new CommandWithArg<AceDocumentChangeEventNative>()
       {

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -4304,7 +4304,7 @@ public void updateNotebookExecQueue(NotebookQueueUnit unit, int op,
       sendRequest(RPC_SCOPE, "update_notebook_exec_queue", params, 
             requestCallback);
    }
-   
+
    @Override
    public void interruptChunk(String docId,
                               String chunkId,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/DocUpdateSentinel.java
Patch:
@@ -368,7 +368,8 @@ private boolean doSaveImpl(final String path,
       String oldFoldSpec = sourceDoc_.getFoldSpec();
       
       final JsArray<ChunkDefinition> newChunkDefs = docDisplay_.getChunkDefs();
-      JsArray<ChunkDefinition> oldChunkDefs = sourceDoc_.getChunkDefs();
+      JsArray<ChunkDefinition> oldChunkDefs = 
+            sourceDoc_.getNotebookDoc().getChunkDefs();
       
       //String patch = DiffMatchPatch.diff(oldContents, newContents);
       SubstringDiff diff = new SubstringDiff(oldContents, newContents);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceDocument.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.core.client.JsArray;
 
 import org.rstudio.core.client.js.JsObject;
+import org.rstudio.studio.client.rmarkdown.model.NotebookDoc;
 import org.rstudio.studio.client.workbench.views.source.SourceWindowManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.ChunkDefinition;
 import org.rstudio.studio.client.workbench.views.source.events.CollabEditStartParams;
@@ -128,8 +129,8 @@ public native final void setFoldSpec(String foldSpec) /*-{
       this.folds = foldSpec;
    }-*/;
    
-   public native final JsArray<ChunkDefinition> getChunkDefs() /*-{
-      return this.chunk_definitions || [];
+   public native final NotebookDoc getNotebookDoc() /*-{
+      return this.notebook || {};
    }-*/;
    
    public native final void setChunkDefs(JsArray<ChunkDefinition> chunkDefs) /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/DocumentOutlineWidget.java
Patch:
@@ -405,9 +405,9 @@ private boolean shouldDisplayNode(Scope node)
       if (node.isNamespace())
          return false;
       
-      // don't show R functions or R sections in non-R files
+      // don't show R functions or R sections in non-R files (unless opted-in by the user)
       TextFileType fileType = target_.getDocDisplay().getFileType();
-      if (!fileType.isR())
+      if (!shownSectionsPref.equals(UIPrefsAccessor.DOC_OUTLINE_SHOW_ALL) && !fileType.isR())
       {
          if (node.isFunction())
             return false;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -135,6 +135,7 @@
 import org.rstudio.studio.client.workbench.views.environment.EnvironmentPane;
 import org.rstudio.studio.client.workbench.views.environment.EnvironmentPresenter;
 import org.rstudio.studio.client.workbench.views.environment.EnvironmentTab;
+import org.rstudio.studio.client.workbench.views.environment.dataimport.DataImportPresenter;
 import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentServerOperations;
 import org.rstudio.studio.client.workbench.views.files.Files;
 import org.rstudio.studio.client.workbench.views.files.FilesPane;
@@ -262,6 +263,7 @@ protected void configure()
       bind(CodeSearchLauncher.class).in(Singleton.class);
       bind(AddinsMRUList.class).asEagerSingleton();
       bind(AceEditorCommandDispatcher.class).asEagerSingleton();
+      bind(DataImportPresenter.class).in(Singleton.class);
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/model/Connection.java
Patch:
@@ -32,7 +32,7 @@ public final native String getHost() /*-{
    }-*/;
    
    public final String getHostDisplay() {
-      return getHost();
+      return getHost().replaceAll(" - sparklyr", "");
    }
    
    public final native String getFinder() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportDialog.java
Patch:
@@ -28,11 +28,12 @@ public class DataImportDialog extends ModalDialog<String>
    
    public DataImportDialog(DataImportModes dataImportMode,
                            String caption,
+                           String path,
                            OperationWithInput<String> operation)
    {
       super(caption, operation);
       
-      dataImport_ = new DataImport(dataImportMode, addProgressIndicator(false));
+      dataImport_ = new DataImport(dataImportMode, addProgressIndicator(false), path);
       RStudioGinjector.INSTANCE.injectMembers(this);
       
       setOkButtonCaption("Import");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportFileChooser.java
Patch:
@@ -165,7 +165,7 @@ private void preventModeChange()
       lastTextBoxValue_ = locationTextBox_.getText();
    }
    
-   private void switchToUpdateMode(Boolean updateMode)
+   public void switchToUpdateMode(Boolean updateMode)
    {
       if (updateMode_ != updateMode)
       {

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RMarkdownServerOperations.java
Patch:
@@ -80,7 +80,8 @@ void setChunkConsole(String docId, String chunkId, int commitMode,
                         int pixelWidth, int characterWidth, 
                         ServerRequestCallback<RmdChunkOptions> requestCallback);
    
-   void createNotebookFromCache(String rmdPath, String outputPath, ServerRequestCallback<Void> requestCallback);
+   void createNotebookFromCache(String rmdPath, String outputPath, 
+         ServerRequestCallback<NotebookCreateResult> requestCallback);
    
    void replayNotebookPlots(String docId, String initialChunkId, int pixelWidth, 
          ServerRequestCallback<Boolean> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -95,6 +95,7 @@
 import org.rstudio.studio.client.projects.model.SharedProjectDetails;
 import org.rstudio.studio.client.projects.model.SharingConfigResult;
 import org.rstudio.studio.client.projects.model.SharingResult;
+import org.rstudio.studio.client.rmarkdown.model.NotebookCreateResult;
 import org.rstudio.studio.client.rmarkdown.model.NotebookDocQueue;
 import org.rstudio.studio.client.rmarkdown.model.NotebookQueueUnit;
 import org.rstudio.studio.client.rmarkdown.model.RMarkdownContext;
@@ -4245,8 +4246,8 @@ public void setChunkConsole(String docId, String chunkId, int commitMode,
    
    @Override
    public void createNotebookFromCache(String rmdPath,
-                                       String outputPath,
-                                       ServerRequestCallback<Void> requestCallback)
+               String outputPath,
+               ServerRequestCallback<NotebookCreateResult> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(rmdPath));

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -574,7 +574,7 @@ public PrefValue<Boolean> hideConsoleOnChunkExecute()
    
    public PrefValue<Boolean> executeMultiLineStatements()
    {
-      return bool("execute_multi_line_statements", false);
+      return bool("execute_multi_line_statements", true);
    }
    
    public static final String DOC_OUTLINE_SHOW_SECTIONS_ONLY = "show_sections_only";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/SparkMasterChooser.java
Patch:
@@ -68,7 +68,7 @@ public SparkMasterChooser(final NewSparkConnectionContext context)
             {
                // if list box is empty then add the default cluster URL
                if (listBox_.getItemCount() == 0)
-                  listBox_.addItem(DEFAULT_SPARK_MASTER);
+                  listBox_.addItem(context.getDefaultClusterUrl());
             }
          }
       }   
@@ -100,7 +100,7 @@ else if (context.getClusterConnectionsSupported())
                   globalDisplay_.promptForTextWithOption(
                    "Connect to Cluster", 
                    "Spark master:", 
-                   DEFAULT_SPARK_MASTER, 
+                   context.getDefaultClusterUrl(), 
                    false, 
                    null, 
                    false, 
@@ -222,5 +222,4 @@ public void focus()
    private final static String LOCAL = "local";
    private final static String LOCAL_VALUE = "local";
    private final static String CLUSTER = "Cluster...";
-   private final static String DEFAULT_SPARK_MASTER = "spark://local:7077";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/TableBrowserModel.java
Patch:
@@ -357,10 +357,10 @@ public void render(Cell.Context context, Field value, SafeHtmlBuilder sb)
       {
          SafeHtmlUtil.appendSpan(sb, 
                                  RES.cellTreeStyle().fieldName(), 
-                                 value.getName());
+                                 value.getName() + " : ");
          SafeHtmlUtil.appendSpan(sb, 
                                  RES.cellTreeStyle().fieldType(), 
-                                 "(" + value.getType() + ")");
+                                 value.getType());
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/TableBrowser.java
Patch:
@@ -151,6 +151,7 @@ public interface Resources extends CellTree.Resources {
       public interface Style extends CellTree.Style
       {
          String fieldName();
+         String fieldType();
          String tableViewDataset();
       }
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/TableBrowserModel.java
Patch:
@@ -358,7 +358,9 @@ public void render(Cell.Context context, Field value, SafeHtmlBuilder sb)
          SafeHtmlUtil.appendSpan(sb, 
                                  RES.cellTreeStyle().fieldName(), 
                                  value.getName());
-         sb.appendEscaped(value.getType());
+         SafeHtmlUtil.appendSpan(sb, 
+                                 RES.cellTreeStyle().fieldType(), 
+                                 "(" + value.getType() + ")");
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/NotebookQueueState.java
Patch:
@@ -325,8 +325,9 @@ public void onChunkExecStateChanged(ChunkExecStateChangedEvent event)
          notebook_.setOutputOptions(event.getChunkId(), 
                event.getOptions());
 
-         notebook_.setChunkExecuting(event.getChunkId(), 
-               executingUnit_.getExecMode());
+         if (executingUnit_ != null)
+            notebook_.setChunkExecuting(event.getChunkId(), 
+                  executingUnit_.getExecMode());
 
          break;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -1516,7 +1516,8 @@ private void setAllExpansionStates(int state)
    
    private void clearChunkExecQueue()
    {
-      queue_.clear();
+      if (queue_ != null)
+         queue_.clear();
    }
    
    private Timer cleanErrorGutter_ = new Timer()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/NotebookQueueState.java
Patch:
@@ -121,7 +121,6 @@ public void clear()
          notebook_.cleanChunkExecState(queue_.getUnits().get(i).getChunkId());
       }
       
-      // TODO: clean on server, too
       editingTarget_.getStatusBar().hideNotebookProgress(true);
    }
    

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/events/ChunkExecStateChangedEvent.java
Patch:
@@ -15,8 +15,6 @@
 
 package org.rstudio.studio.client.rmarkdown.events;
 
-import org.rstudio.studio.client.rmarkdown.model.NotebookExecRange;
-
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.event.shared.EventHandler;
 import com.google.gwt.event.shared.GwtEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -368,7 +368,7 @@ else if (execScope == TextEditingTargetNotebook.SCOPE_CHUNK)
       showReadyState();
    }
 
-   public void setCodeExecuting(boolean entireChunk, int mode)
+   public void setCodeExecuting(int mode)
    {
       // expand if currently collapsed
       if (expansionState_.getValue() == COLLAPSED)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ConnectionsPresenter.java
Patch:
@@ -404,8 +404,7 @@ public void onConnectConnection()
          return;
 
       String connectVia = display_.getConnectVia();
-      String connectCode = display_.getConnectCode();
-      performConnection(connectVia, connectCode);
+      performConnection(connectVia, exploredConnection_.getConnectCode());
       
       uiPrefs_.connectionsConnectVia().setGlobalValue(connectVia);
       uiPrefs_.writeUIPrefs();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/ConnectionCodePanel.java
Patch:
@@ -105,7 +105,7 @@ public void onChange(ChangeEvent event)
             EditorLanguage.LANG_R.getParserName(), false);
       codeViewer_.getEditor().getSession().setUseWrapMode(true);
       codeViewer_.getEditor().getRenderer().setShowGutter(false);
-      codeViewer_.getEditor().setReadOnly(false);
+      codeViewer_.getEditor().setReadOnly(true);
       codeViewer_.addCursorChangedHandler(new CursorChangedHandler() {
          @Override
          public void onCursorChanged(CursorChangedEvent event)

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -811,8 +811,8 @@ else if (type.equals(ClientEvent.ReloadWithLastChanceSave))
          }
          else if (type.equals(ClientEvent.ConnectionUpdated))
          {
-            ConnectionId connectionId = event.getData();
-            eventBus_.fireEvent(new ConnectionUpdatedEvent(connectionId));
+            ConnectionUpdatedEvent.Data data = event.getData();
+            eventBus_.fireEvent(new ConnectionUpdatedEvent(data));
          }
          else if (type.equals(ClientEvent.EnableConnections))
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/connections/ui/NewSparkConnectionDialog.java
Patch:
@@ -277,6 +277,7 @@ public void execute()
          }  
       };
       updateInfoPanel.execute();
+      master_.addSelectionChangeHandler(commandSelectionChangeHandler(updateInfoPanel));
       sparkVersion_.addChangeHandler(commandChangeHandler(updateInfoPanel));
       hadoopVersion_.addChangeHandler(commandChangeHandler(updateInfoPanel));
       
@@ -370,6 +371,7 @@ public void execute()
             {
                builder.append(", hadoop_version = \"");
                builder.append(hadoopVersion_.getSelectedValue());
+               builder.append("\"");
             }
             
             // cores if not default

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -373,6 +373,9 @@ public void setCodeExecuting(boolean entireChunk, int mode)
          return;
       }
 
+      // clean error state
+      hasErrors_ = false;
+
       registerConsoleEvents();
       state_ = CHUNK_PRE_OUTPUT;
       execMode_ = mode;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptionsUiCsv.java
Patch:
@@ -229,9 +229,6 @@ void updateEnabled()
       }
    }
    
-   @UiField
-   TextBox nameTextBox_;
-   
    @UiField
    TextBox skipTextBox_;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptionsUiSav.java
Patch:
@@ -100,6 +100,8 @@ public void clearOptions()
    @Override
    public void setImportLocation(String importLocation)
    {
+      nameTextBox_.setText("");
+      
       String[] components = importLocation.split("\\.");
       if (components.length > 0)
       {
@@ -170,9 +172,6 @@ void updateEnabled()
       }
    }
    
-   @UiField
-   TextBox nameTextBox_;
-   
    @UiField
    ListBox formatListBox_;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptionsUiXls.java
Patch:
@@ -145,9 +145,6 @@ public void onValueChange(ValueChangeEvent<Boolean> arg0)
       skipTextBox_.addValueChangeHandler(valueChangeHandler);
    }
    
-   @UiField
-   TextBox nameTextBox_;
-   
    @UiField
    ListBox sheetListBox_;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -754,7 +754,7 @@ public void onResponseReceived(String response)
                            FileSystemItem.createFile(navigationTarget.getFile()),
                            filePosition);
                   }
-                  else
+                  else if (selectedPath_.indexOf("<expr>") == -1)
                   {
                      globalDisplay_.showMessage(GlobalDisplay.MSG_ERROR,
                            "Error while opening profiler source",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -754,7 +754,7 @@ public void onResponseReceived(String response)
                            FileSystemItem.createFile(navigationTarget.getFile()),
                            filePosition);
                   }
-                  else
+                  else if (selectedPath_.indexOf("<expr>") == -1)
                   {
                      globalDisplay_.showMessage(GlobalDisplay.MSG_ERROR,
                            "Error while opening profiler source",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/status/StatusBar.java
Patch:
@@ -48,7 +48,7 @@ public static interface HideMessageHandler
    void hideMessage();
    
    void showNotebookProgress(String label);
-   void updateNotebookProgress(int percent);
+   void updateNotebookProgress(String chunkName, int percent);
    void hideNotebookProgress();
    HandlerRegistration addProgressClickHandler(ClickHandler handler);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/status/StatusBarWidget.java
Patch:
@@ -238,14 +238,14 @@ public void showNotebookProgress(String label)
       }
       
       progress_.setLabel(label);
-      progress_.setPercent(0);
+      progress_.setPercent("", 0);
    }
 
    @Override
-   public void updateNotebookProgress(int percent)
+   public void updateNotebookProgress(String chunkName, int percent)
    {
       // just update the status bar
-      progress_.setPercent(percent);
+      progress_.setPercent(chunkName, percent);
    }
 
    @Override

File: src/gwt/src/org/rstudio/core/client/cellview/LinkColumn.java
Patch:
@@ -62,7 +62,7 @@ protected void render(Context context,
               div.append(ThemeResources.INSTANCE.themeStyles().handCursor());
               if (alwaysUnderline)
                  div.append(" " + styles.linkUnderlined());
-              div.append("\">");
+              div.append("\" title=\"" + value.asString() + "\">");
               
               sb.appendHtmlConstant(div.toString());
               sb.append(value);

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -89,6 +89,9 @@ public final String getStem()
    public static String getExtensionFromPath(String path)
    {
       String filename = getNameFromPath(path);
+      if (filename.endsWith(".nb.html"))
+         return ".nb.html";
+      
       int lastDotIndex = filename.lastIndexOf('.');
       if (lastDotIndex != -1)
          return filename.substring(lastDotIndex);

File: src/gwt/src/org/rstudio/core/client/js/JsObject.java
Patch:
@@ -167,7 +167,7 @@ public final native JsObject clone() /*-{
             for (var i = 0; i < obj.length; i++) {
                cloned[i] = cloneObj(obj[i]);
             }
-         } else if (obj instanceof Object) {
+         } else if (Object.prototype.toString.call(obj) == "[object Object]") {
             cloned = {};
             for (var attrib in obj)
                if (obj.hasOwnProperty(attrib))

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -169,8 +169,5 @@ public interface ThemeStyles extends CssResource
    
    String handCursor();
    
-   String inlineChunkToolbar();
-   String highlightIcon();
-   
    String borderedIFrame();
 }

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -75,7 +75,7 @@
 import org.rstudio.studio.client.workbench.ui.unsaved.UnsavedChangesDialog;
 import org.rstudio.studio.client.workbench.views.buildtools.ui.BuildPaneResources;
 import org.rstudio.studio.client.workbench.views.console.ConsoleResources;
-import org.rstudio.studio.client.workbench.views.files.ui.FilesListCellTableResources;
+import org.rstudio.studio.client.workbench.views.files.ui.FilesListDataGridResources;
 import org.rstudio.studio.client.workbench.views.history.view.HistoryPane;
 import org.rstudio.studio.client.workbench.views.history.view.Shelf;
 import org.rstudio.studio.client.workbench.views.packages.ui.CheckForUpdatesDialog;
@@ -221,7 +221,7 @@ private void ensureStylesInjected()
       FileDialogResources.INSTANCE.styles().ensureInjected();
       ManipulatorResources.INSTANCE.manipulatorStyles().ensureInjected();
       PackagesCellTableResources.INSTANCE.cellTableStyle().ensureInjected();
-      FilesListCellTableResources.INSTANCE.cellTableStyle().ensureInjected();
+      FilesListDataGridResources.INSTANCE.dataGridStyle().ensureInjected();
       ExportPlotResources.INSTANCE.styles().ensureInjected();
       CodeSearchResources.INSTANCE.styles().ensureInjected();
       SourceMarkerListResources.INSTANCE.styles().ensureInjected();

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -187,7 +187,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.profiler.model.ProfilerServerOperations;
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditor;
 import org.rstudio.studio.client.workbench.views.source.editors.text.DocDisplay;
-import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.ChunkIconsManager;
+import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceEditorCommandDispatcher;
 import org.rstudio.studio.client.workbench.views.source.model.CppServerOperations;
 import org.rstudio.studio.client.workbench.views.source.model.SourceServerOperations;
 import org.rstudio.studio.client.workbench.views.source.model.TexServerOperations;
@@ -257,6 +257,7 @@ protected void configure()
       bind(ApplicationCommandManager.class).in(Singleton.class);
       bind(CodeSearchLauncher.class).in(Singleton.class);
       bind(AddinsMRUList.class).asEagerSingleton();
+      bind(AceEditorCommandDispatcher.class).asEagerSingleton();
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;
@@ -383,8 +384,6 @@ protected void configure()
 
       bind(DocDisplay.class).to(AceEditor.class);
       
-      bind(ChunkIconsManager.class).in(Singleton.class);
-      
       install(new GinFactoryModuleBuilder()
          .implement(CompileOutputPaneDisplay.class, CompileOutputPane.class)
          .build(CompileOutputPaneFactory.class));

File: src/gwt/src/org/rstudio/studio/client/application/ui/GlobalToolbar.java
Patch:
@@ -53,6 +53,7 @@ public GlobalToolbar(Commands commands,
       // add new source doc commands
       newMenu_ = new ToolbarPopupMenu();
       newMenu_.addItem(commands.newSourceDoc().createMenuItem(false));
+      newMenu_.addItem(commands.newRNotebook().createMenuItem(false));
       newMenu_.addSeparator();
       newMenu_.addItem(commands.newRMarkdownDoc().createMenuItem(false));
       newMenu_.addItem(commands.newRShinyApp().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -242,7 +242,7 @@ void onShowLogFiles()
    void onDiagnosticsReport()
    {
       eventBus_.fireEvent(
-         new SendToConsoleEvent("rstudio::diagnosticsReport()", true));
+         new SendToConsoleEvent("rstudioDiagnosticsReport()", true));
       
       new Timer() {
          @Override

File: src/gwt/src/org/rstudio/studio/client/common/FilePathUtils.java
Patch:
@@ -106,6 +106,8 @@ private static int getExtensionIndex(String path,
    {
       if (path.endsWith(".tar.gz"))
          return path.length() - 7;
+      else if (path.endsWith(".nb.html"))
+         return path.length() - 8;
       
       int lastDotIndex = path.lastIndexOf('.');
       if (lastDotIndex == -1 || lastDotIndex < fromIndex)

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewDirectoryPage.java
Patch:
@@ -77,6 +77,7 @@ protected void onAddWidgets()
       namePanel.add(dirNameLabel_);
       txtProjectName_ = new TextBox();
       txtProjectName_.setWidth("100%");
+      txtProjectName_.getElement().setAttribute("spellcheck", "false");
       namePanel.add(txtProjectName_);
       panel.add(namePanel);
       addWidget(panel);

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectSharingPreferencesPane.java
Patch:
@@ -41,6 +41,6 @@ protected void initialize(RProjectOptions prefs)
    @Override
    public boolean onApply(RProjectOptions prefs)
    {
-      return true;
+      return false;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsPanel.java
Patch:
@@ -84,6 +84,8 @@ public DirectorySelector(String label)
       {
          super(label, "(Project Root)");
          
+         addStyleName(RES.styles().directorySelector());
+         
          // allow user to clear out a value
          setReadOnly(false);
          

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -78,7 +78,7 @@ public final Size getPreferredSize()
           format.equals(RmdOutputFormat.OUTPUT_SLIDY_PRESENTATION))
          return new Size(1100, 900 + chromeHeight);
       if (format.endsWith(RmdOutputFormat.OUTPUT_REVEALJS_PRESENTATION))
-         return new Size(960, 700 + chromeHeight);
+         return new Size(1100, 900 + chromeHeight);
       
       // default size (html_document and others)
       return new Size(1100, 1000 + chromeHeight);

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputFrame.java
Patch:
@@ -24,7 +24,7 @@ public interface RmdOutputFrame
 {
    public void closeOutputFrame(boolean forReopen);
    public WindowEx getWindowObject();
-   public void showRmdPreview(RmdPreviewParams params);
+   public void showRmdPreview(RmdPreviewParams params, boolean activate);
    public int getViewerType();
    RmdPreviewParams getPreviewParams();
    public int getScrollPosition();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputFramePane.java
Patch:
@@ -61,7 +61,7 @@ public WindowEx getWindowObject()
    }
 
    @Override
-   public void showRmdPreview(RmdPreviewParams params)
+   public void showRmdPreview(RmdPreviewParams params, boolean activate)
    {
       super.showRmdPreview(params);
       isShiny_ = params.isShinyDocument();

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -128,8 +128,6 @@ class ClientEvent extends JavaScriptObject
    public static final String ShinyGadgetDialog = "shiny_gadget_dialog";
    public static final String RmdParamsReady = "rmd_params_ready";
    public static final String RegisterUserCommand = "register_user_command";
-   public static final String ReplaceRanges = "replace_ranges";
-   public static final String GetActiveDocumentContext = "get_active_document_context";
    public static final String SendToConsole = "send_to_console";
    public static final String UserFollowStarted = "user_follow_started";
    public static final String UserFollowEnded = "user_follow_ended";
@@ -141,6 +139,9 @@ class ClientEvent extends JavaScriptObject
    public static final String RprofStarted = "rprof_started";
    public static final String RprofStopped = "rprof_stopped";
    public static final String RprofCreated = "rprof_created";
+   public static final String EditorCommand = "editor_command";
+   public static final String PreviewRmd = "preview_rmd";
+   public static final String WebsiteFileSaved = "website_file_saved";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplication.java
Patch:
@@ -447,7 +447,8 @@ else if (isChrome)
       {
          // we have a window and we're Chrome, so force a close and reopen
          satelliteManager_.forceReopenSatellite(ShinyApplicationSatellite.NAME, 
-                                                params_);
+                                                params_,
+                                                true);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/addins/Addins.java
Patch:
@@ -88,6 +88,7 @@ public final static RAddin decode(String decoded)
    public static class RAddins extends JsMap<RAddin>
    {
       protected RAddins() {}
+      public static final native RAddins createDefault() /*-{ return {}; }-*/;
    }
    
    public static class AddinExecutor

File: src/gwt/src/org/rstudio/studio/client/workbench/snippets/ui/EditSnippetsDialog.java
Patch:
@@ -280,7 +280,7 @@ private void updateEditor(EditableSnippets snippets)
       docDisplay_.setCode(snippets.getSnippetText(), false);
       activeSnippets_ = snippets;
       editorDirty_ = false;
-      docDisplay_.scrollToY(activeSnippets_.getScrollPosition());
+      docDisplay_.scrollToY(activeSnippets_.getScrollPosition(), 0);
    }
    
    private void recordEditorState()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -582,7 +582,7 @@ private void navigateToDirectory(FileSystemItem directoryEntry)
    private void navigateToFile(final FileSystemItem file)
    {
       String ext = file.getExtension().toLowerCase();
-      if (ext.equals(".htm") || ext.equals(".html"))
+      if (ext.equals(".htm") || ext.equals(".html") || ext.equals(".nb.html"))
       {
          view_.showHtmlFileChoice(
             file,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/PlotsPane.java
Patch:
@@ -84,7 +84,7 @@ public void execute()
                  final Size size = ZoomUtils.getZoomedSize(
                        getPlotFrameSize(), 
                        new Size(400, 350), 
-                       new Size(750, 600));
+                       new Size(800, 700));
                   server_.plotsCreateRPubsHtml(
                      "Plot", 
                      "", 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewShinyWebApplication.java
Patch:
@@ -194,6 +194,7 @@ public NewShinyWebApplication(String caption,
       appNameLabel_.addStyleName(RES.styles().label());
       
       appNameTextBox_ = new TextBox();
+      appNameTextBox_.getElement().setAttribute("spellcheck", "false");
       appNameTextBox_.addStyleName(RES.styles().textBox());
       appNameTextBox_.addStyleName(RES.styles().appNameTextBox());
       appNameTextBox_.getElement().setAttribute("placeholder", "Name");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceShim.java
Patch:
@@ -69,6 +69,8 @@ public abstract static class AsyncSource extends AsyncShim<Source>
       @Handler
       public abstract void onNewSourceDoc();
       @Handler
+      public abstract void onNewRNotebook();
+      @Handler
       public abstract void onNewTextDoc();
       @Handler
       public abstract void onNewCppDoc();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -134,7 +134,7 @@ public native final void addKeyboardHandler(KeyboardHandler keyboardHandler) /*-
    public native final boolean isVimInInsertMode() /*-{
       return this.state.cm.state.vim.insertMode;
    }-*/;
-
+   
    public native final void onChange(CommandWithArg<AceDocumentChangeEventNative> command) /*-{
       this.getSession().on("change",
         $entry(function (arg) {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -882,7 +882,6 @@ public void setIsNotebookFormat()
             commands_.previewHTML().getImageResource());
       setRmdFormatButtonVisible(false);
       showRmdViewerMenuItems(true, false, true, RmdOutput.TYPE_NOTEBOOK);
-     
    }
    
    private void setRmdFormatButtonVisible(boolean visible)

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdTemplateData.java
Patch:
@@ -306,7 +306,7 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             },
             {
             option_name: "fig_height",
-            option_ui_name: "Default figure width (in inches)", 
+            option_ui_name: "Default figure height (in inches)",
             option_category: "Figures",
             option_type: "float", 
             option_default: "4.5"
@@ -322,7 +322,7 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             {
             option_name: "fig_height",
             option_format: "beamer_presentation",
-            option_ui_name: "Default figure width (in inches)", 
+            option_ui_name: "Default figure height (in inches)",
             option_category: "Figures",
             option_type: "float", 
             option_default: "7"

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdTemplateData.java
Patch:
@@ -306,7 +306,7 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             },
             {
             option_name: "fig_height",
-            option_ui_name: "Default figure width (in inches)", 
+            option_ui_name: "Default figure height (in inches)",
             option_category: "Figures",
             option_type: "float", 
             option_default: "4.5"
@@ -322,7 +322,7 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             {
             option_name: "fig_height",
             option_format: "beamer_presentation",
-            option_ui_name: "Default figure width (in inches)", 
+            option_ui_name: "Default figure height (in inches)",
             option_category: "Figures",
             option_type: "float", 
             option_default: "7"

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleErrorFrame.java
Patch:
@@ -53,7 +53,7 @@ public ConsoleErrorFrame(int number, ErrorFrame frame)
       
       boolean hasSource = !frame.getFileName().isEmpty();
       functionName.setText(frame.getFunctionName() + (hasSource ? " at" : ""));
-      frameNumber.setText((new Integer(number)).toString());
+      frameNumber.setText((new Integer(number)).toString() + ".");
       if (hasSource)
       {
          sourceLink.setText(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -856,8 +856,7 @@ public void onResponseReceived(RmdChunkOptions options)
                   }
                   else 
                   {
-                     if (outputs_.containsKey(unit.chunkId) &&
-                         unit.chunkId != SETUP_CHUNK_ID)
+                     if (outputs_.containsKey(unit.chunkId))
                      {
                         outputs_.get(unit.chunkId).getOutputWidget()
                                 .setOptions(options);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkOutputUi.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.core.client.Rectangle;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.studio.client.RStudioGinjector;
+import org.rstudio.studio.client.rmarkdown.model.RmdChunkOptions;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ChunkOutputWidget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.DocDisplay;
 import org.rstudio.studio.client.workbench.views.source.editors.text.PinnedLineWidget;
@@ -45,7 +46,7 @@ public ChunkOutputUi(String docId, DocDisplay display, ChunkDefinition def,
       def_ = def;
 
       outputWidget_ = new ChunkOutputWidget(def.getChunkId(), 
-            def.getExpansionState(), include, this);
+            RmdChunkOptions.create(), def.getExpansionState(), this);
       
       // sync the widget's expanded/collapsed state to the underlying chunk
       // definition (which is persisted)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -376,6 +376,8 @@ void highlightDebugLocation(
    
    void forceImmediateRender();
    boolean isPositionVisible(Position position);
+
+   int getFirstVisibleRow();
    int getLastVisibleRow();
    
    void showInfoBar(String message);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkOutputUi.java
Patch:
@@ -37,15 +37,15 @@ public class ChunkOutputUi
                         RenderFinishedEvent.Handler
 {
    public ChunkOutputUi(String docId, DocDisplay display, ChunkDefinition def,
-         PinnedLineWidget.Host lineWidgetHost)
+         boolean include, PinnedLineWidget.Host lineWidgetHost)
    {
       display_ = display;
       chunkId_ = def.getChunkId();
       docId_ = docId;
       def_ = def;
 
       outputWidget_ = new ChunkOutputWidget(def.getChunkId(), 
-            def.getExpansionState(), this);
+            def.getExpansionState(), include, this);
       
       // sync the widget's expanded/collapsed state to the underlying chunk
       // definition (which is persisted)

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleError.java
Patch:
@@ -15,7 +15,6 @@
 
 package org.rstudio.studio.client.common.debugging.ui;
 
-import org.rstudio.studio.client.common.debugging.model.ErrorFrame;
 import org.rstudio.studio.client.common.debugging.model.UnhandledError;
 
 import com.google.gwt.core.client.GWT;
@@ -42,7 +41,6 @@ interface ConsoleErrorUiBinder extends UiBinder<Widget, ConsoleError>
    public interface Observer
    {
       void onErrorBoxResize();
-      void showSourceForFrame(ErrorFrame frame);
       void runCommandWithDebug(String command);
    }
 
@@ -80,13 +78,15 @@ public void onClick(ClickEvent event)
       
       showTracebackText.addClickHandler(showHideTraceback);
       showTracebackImage.addClickHandler(showHideTraceback);
+      rerunText.setVisible(command_ != null);
+      rerunImage.setVisible(command_ != null);
       rerunText.addClickHandler(rerunWithDebug);
       rerunImage.addClickHandler(rerunWithDebug);
       
       for (int i = err.getErrorFrames().length() - 1; i >= 0; i--)
       {
          ConsoleErrorFrame frame = new ConsoleErrorFrame(i + 1, 
-               err.getErrorFrames().get(i), observer_);
+               err.getErrorFrames().get(i));
          framePanel.add(frame);
       }
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -555,9 +555,6 @@ public void onRmdChunkOutput(RmdChunkOutputEvent event)
           event.getOutput().getUnit().getType() == 
              RmdChunkOutputUnit.TYPE_ERROR)
       {
-         Debug.devlog("drawing error from " + 
-               executingChunk_.executingRowStart + ", " +
-               executingChunk_.executingRowEnd);
          docDisplay_.setChunkLineExecState(
                executingChunk_.executingRowStart,
                executingChunk_.executingRowEnd,

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -261,7 +261,7 @@ void onShowLogFiles()
    void onDiagnosticsReport()
    {
       eventBus_.fireEvent(
-         new SendToConsoleEvent("rstudio::diagnosticsReport()", true));
+         new SendToConsoleEvent("rstudioDiagnosticsReport()", true));
       
       new Timer() {
          @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3805,7 +3805,7 @@ void onProfileCodeWithoutFocus()
          @Override
          public void execute()
          {
-            codeExecution_.executeSelection(false, false, "profvis::profvis");
+            codeExecution_.executeSelection(false, false, "profvis::profvis", true);
          }
       });
    }
@@ -4365,7 +4365,7 @@ void onSourceActiveDocumentWithEcho()
    @Handler
    void onProfileCode()
    {
-      codeExecution_.executeSelection(true, true, "profvis::profvis");
+      codeExecution_.executeSelection(true, true, "profvis::profvis", true);
    }
   
    private void sourceActiveDocument(final boolean echo)

File: src/gwt/src/org/rstudio/studio/client/workbench/addins/Addins.java
Patch:
@@ -88,6 +88,7 @@ public final static RAddin decode(String decoded)
    public static class RAddins extends JsMap<RAddin>
    {
       protected RAddins() {}
+      public static final native RAddins createDefault() /*-{ return {}; }-*/;
    }
    
    public static class AddinExecutor

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -656,7 +656,7 @@ else if (uiPrefs_.enableEmacsKeybindings().getGlobalValue())
    
    private boolean consoleEditorHadFocusLast()
    {
-      String id = MainWindowObject.get(MainWindowObject.LAST_FOCUSED_EDITOR);
+      String id = MainWindowObject.lastFocusedEditor().get();
       return "rstudio_console_input".equals(id);
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -432,9 +432,8 @@ public void onAttachOrDetach(AttachEvent event)
          @Override
          public void onFocus(FocusEvent event)
          {
-            MainWindowObject.set(
-                  MainWindowObject.LAST_FOCUSED_EDITOR,
-                  AceEditor.this.getWidget().getElement().getId());
+            String id = AceEditor.this.getWidget().getElement().getId();
+            MainWindowObject.lastFocusedEditor().set(id);
          }
       });
    }

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -550,7 +550,7 @@ public void withProfvis(String userAction, final Command command)
            Dependency.embeddedPackage("profvis")
           
         }, 
-        false,
+        true, // update profvis if needed
         new CommandWithArg<Boolean>()
         {
            @Override

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -78,7 +78,7 @@ public final Size getPreferredSize()
           format.equals(RmdOutputFormat.OUTPUT_SLIDY_PRESENTATION))
          return new Size(1100, 900 + chromeHeight);
       if (format.endsWith(RmdOutputFormat.OUTPUT_REVEALJS_PRESENTATION))
-         return new Size(960, 700 + chromeHeight);
+         return new Size(1100, 900 + chromeHeight);
       
       // default size (html_document and others)
       return new Size(1100, 1000 + chromeHeight);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildCommands.java
Patch:
@@ -54,7 +54,8 @@ public static void setBuildCommandState(Commands commands,
          commands.rebuildAll().remove();
       }
       
-      if (!type.equals(SessionInfo.BUILD_TOOLS_MAKEFILE))
+      if (type.equals(SessionInfo.BUILD_TOOLS_CUSTOM) ||
+          type.equals(SessionInfo.BUILD_TOOLS_PACKAGE))
       {
          commands.cleanAll().remove();
       }

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -89,6 +89,9 @@ public final String getStem()
    public static String getExtensionFromPath(String path)
    {
       String filename = getNameFromPath(path);
+      if (filename.endsWith(".nb.html"))
+         return ".nb.html";
+      
       int lastDotIndex = filename.lastIndexOf('.');
       if (lastDotIndex != -1)
          return filename.substring(lastDotIndex);

File: src/gwt/src/org/rstudio/studio/client/common/FilePathUtils.java
Patch:
@@ -106,6 +106,8 @@ private static int getExtensionIndex(String path,
    {
       if (path.endsWith(".tar.gz"))
          return path.length() - 7;
+      else if (path.endsWith(".nb.html"))
+         return path.length() - 8;
       
       int lastDotIndex = path.lastIndexOf('.');
       if (lastDotIndex == -1 || lastDotIndex < fromIndex)

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -99,7 +99,7 @@ public class FileTypeRegistry
    
    public static final RWebContentFileType RNOTEBOOK =
          new RWebContentFileType("r_notebook", "R Notebook", EditorLanguage.LANG_RMARKDOWN,
-                                 ".Rnb", ICONS.iconRnotebook(), true);
+                                 ".nb.html", ICONS.iconRnotebook(), true);
 
    public static final RWebContentFileType RPRESENTATION = new RPresentationFileType();
 
@@ -346,7 +346,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.json", JSON, icons.iconJavascript());
       register("*.rmd", RMARKDOWN, icons.iconRmarkdown());
       register("*.rmarkdown", RMARKDOWN, icons.iconRmarkdown());
-      register("*.rnb", RNOTEBOOK, icons.iconRnotebook());
+      register("*.nb.html", RNOTEBOOK, icons.iconRnotebook());
       register("*.rpres", RPRESENTATION, icons.iconRpresentation());
       register("*.md", MARKDOWN, icons.iconMarkdown());
       register("*.mdtxt", MARKDOWN, icons.iconMarkdown());

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -89,6 +89,9 @@ public final String getStem()
    public static String getExtensionFromPath(String path)
    {
       String filename = getNameFromPath(path);
+      if (filename.endsWith(".nb.html"))
+         return ".nb.html";
+      
       int lastDotIndex = filename.lastIndexOf('.');
       if (lastDotIndex != -1)
          return filename.substring(lastDotIndex);

File: src/gwt/src/org/rstudio/studio/client/common/FilePathUtils.java
Patch:
@@ -106,6 +106,8 @@ private static int getExtensionIndex(String path,
    {
       if (path.endsWith(".tar.gz"))
          return path.length() - 7;
+      else if (path.endsWith(".nb.html"))
+         return path.length() - 8;
       
       int lastDotIndex = path.lastIndexOf('.');
       if (lastDotIndex == -1 || lastDotIndex < fromIndex)

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -99,7 +99,7 @@ public class FileTypeRegistry
    
    public static final RWebContentFileType RNOTEBOOK =
          new RWebContentFileType("r_notebook", "R Notebook", EditorLanguage.LANG_RMARKDOWN,
-                                 ".Rnb", ICONS.iconRnotebook(), true);
+                                 ".nb.html", ICONS.iconRnotebook(), true);
 
    public static final RWebContentFileType RPRESENTATION = new RPresentationFileType();
 
@@ -346,7 +346,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.json", JSON, icons.iconJavascript());
       register("*.rmd", RMARKDOWN, icons.iconRmarkdown());
       register("*.rmarkdown", RMARKDOWN, icons.iconRmarkdown());
-      register("*.rnb", RNOTEBOOK, icons.iconRnotebook());
+      register("*.nb.html", RNOTEBOOK, icons.iconRnotebook());
       register("*.rpres", RPRESENTATION, icons.iconRpresentation());
       register("*.md", MARKDOWN, icons.iconMarkdown());
       register("*.mdtxt", MARKDOWN, icons.iconMarkdown());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1044,6 +1044,7 @@ public void onResponseReceived(SourceDocument response)
             public void onError(ServerError error)
             {
                Debug.logError(error);
+               globalDisplay_.showErrorMessage("Source Document Error", error.getUserMessage());
             }
          });
       }
@@ -1069,6 +1070,7 @@ public void onResponseReceived(SourceDocument response)
                public void onError(ServerError error)
                {
                   Debug.logError(error);
+                  globalDisplay_.showErrorMessage("Source Document Error", error.getUserMessage());
                }
             });
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -277,6 +277,7 @@ public void onResponseReceived(JavaScriptObject response)
                      public void onError(ServerError error)
                      {
                         Debug.logError(error);
+                        commands_.closeSourceDoc().execute();
                      }
                   });
                }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -761,7 +761,7 @@ private native static void initializeEvents() /*-{
       var handler = $entry(function(e) {
          if (typeof e.data != 'object')
             return;
-         if (!e.origin.startsWith($wnd.location.origin))
+         if (e.origin.substr(0, e.origin.length) != $wnd.location.origin)
             return;
          if (e.data.source != "profvis")
             return;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildCommands.java
Patch:
@@ -48,7 +48,8 @@ public static void setBuildCommandState(Commands commands,
       }
       
       // remove makefile commands if this isn't a makefile
-      if (type.equals(SessionInfo.BUILD_TOOLS_CUSTOM))
+      if (type.equals(SessionInfo.BUILD_TOOLS_CUSTOM) ||
+          type.equals(SessionInfo.BUILD_TOOLS_WEBSITE))
       {
          commands.rebuildAll().remove();
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorFocusTracker.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * AceEditor.java
+ * AceEditorFocusTracker.java
  *
  * Copyright (C) 2009-16 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/core/client/events/EnsureHeightEvent.java
Patch:
@@ -22,6 +22,7 @@ public class EnsureHeightEvent extends GwtEvent<EnsureHeightHandler>
          = new Type<EnsureHeightHandler>();
 
    public static final int MAXIMIZED = -1;
+   public static final int NORMAL = -2;
    
    public EnsureHeightEvent(int height)
    {

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -388,7 +388,7 @@ public final native boolean exists() /*-{
       MIME_TYPES.put( "gitignore",   "text/plain");
       MIME_TYPES.put( "rbuildignore","text/plain");
       MIME_TYPES.put( "rprofile", "text/x-r-source");
-      MIME_TYPES.put( "rprof", "text/x-r-profile");
+      MIME_TYPES.put( "rprofvis", "text/x-r-profile");
 
       MIME_TYPES.put( "tif",   "image/tiff" );
       MIME_TYPES.put( "tiff",  "image/tiff" );

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileBrowserWidget.java
Patch:
@@ -109,6 +109,7 @@ public void onNavigated()
       directory_.setContents(
             host_.ls(),
             parsedDir.length > 1 ? parsedDir[parsedDir.length-2] : null);
+      setDirectoryFocus(true);
    }
 
    public void cd(String path)

File: src/gwt/src/org/rstudio/core/client/prefs/SectionChooser.java
Patch:
@@ -50,7 +50,7 @@ public SectionChooser()
    public void addSection(ImageResource icon, String name)
    {
       Image img = new Image(icon.getSafeUri());
-      img.setSize("36px", "25px");
+      img.setSize("29px", "20px");
       Label label = new Label(name, false);
       final ClickableVerticalPanel panel = new ClickableVerticalPanel();
       panel.setHorizontalAlignment(VerticalPanel.ALIGN_CENTER);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -318,8 +318,10 @@ public FileTypeRegistry(EventBus eventBus,
       register("cleanup", SH, icons.iconSh());
       register("cleanup.win", SH, icons.iconSh());
       register("Makefile", MAKEFILE, icons.iconMakefile());
+      register("Makefile.in", MAKEFILE, icons.iconMakefile());
       register("Makefile.win", MAKEFILE, icons.iconMakefile());
       register("Makevars", MAKEFILE, icons.iconMakefile());
+      register("Makevars.in", MAKEFILE, icons.iconMakefile());
       register("Makevars.win", MAKEFILE, icons.iconMakefile());
       register("TUTORIAL", DCF, icons.iconDCF());
       register("NAMESPACE", NAMESPACE, icons.iconText());
@@ -394,7 +396,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.rs", RUST, icons.iconRust());
       register("*.scala", SCALA, icons.iconScala());
       register("*.snippets", SNIPPETS, icons.iconSnippets());
-      register("*.rprof", PROFILER, icons.iconRprofile());
+      register("*.Rprofvis", PROFILER, icons.iconRprofile());
 
       registerIcon(".jpg", icons.iconPng());
       registerIcon(".jpeg", icons.iconPng());

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdOutputFormat.java
Patch:
@@ -37,6 +37,7 @@ public native final boolean isSelfContained() /*-{
    public final static String OUTPUT_IOSLIDES_PRESENTATION = "ioslides_presentation";
    public final static String OUTPUT_SLIDY_PRESENTATION = "slidy_presentation";
    public final static String OUTPUT_PRESENTATION_SUFFIX = "_presentation";
+   public final static String OUTPUT_DASHBOARD_SUFFIX = "_dashboard";
    public final static String OUTPUT_WORD_DOCUMENT = "word_document";
    public final static String OUTPUT_PDF_DOCUMENT = "pdf_document";
 }

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -81,6 +81,6 @@ public final Size getPreferredSize()
          return new Size(960, 700 + chromeHeight);
       
       // default size (html_document and others)
-      return new Size(1020, 1000 + chromeHeight);
+      return new Size(1100, 1000 + chromeHeight);
    }
 }

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/YamlTree.java
Patch:
@@ -118,7 +118,7 @@ public void setValue(String value)
       
       private String getKey(String line)
       {
-         RegExp keyReg = RegExp.compile("^\\s*([^:]+):");
+         RegExp keyReg = RegExp.compile("^\\s*([^:]+(?:::[^:]+)?):");
          MatchResult result = keyReg.exec(line);
          if (result == null)
             return "";

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -140,6 +140,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ChunkOutputFinished = "chunk_output_finished";
    public static final String RprofStarted = "rprof_started";
    public static final String RprofStopped = "rprof_stopped";
+   public static final String RprofCreated = "rprof_created";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialog.java
Patch:
@@ -38,6 +38,7 @@ public PreferencesDialog(WorkbenchServerOperations server,
                             PreferencesDialogResources res,
                             Provider<GeneralPreferencesPane> pR,
                             EditingPreferencesPane source,
+                            RMarkdownPreferencesPane rmarkdown,
                             CompilePdfPreferencesPane compilePdf,
                             AppearancePreferencesPane appearance,
                             PaneLayoutPreferencesPane paneLayout,
@@ -55,6 +56,7 @@ public PreferencesDialog(WorkbenchServerOperations server,
                                    appearance, 
                                    paneLayout,
                                    packages,
+                                   rmarkdown,
                                    compilePdf,
                                    spelling,
                                    sourceControl, 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PreferencesDialogResources.java
Patch:
@@ -37,4 +37,5 @@ public interface Styles extends CssResource
    ImageResource iconAppearance();
    ImageResource iconPanes();
    ImageResource iconPackages();
+   ImageResource iconRMarkdown();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -399,7 +399,7 @@ public void onExecutePendingInput(ConsoleExecutePendingInputEvent event)
       // call a method on the SourceShim
       else
       {
-         commands_.executeCodeWithoutFocus().execute();
+         commands_.getCommandById(event.getCommandId()).execute();
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManager.java
Patch:
@@ -35,5 +35,7 @@ interface InitCompletionFilter
    void close();
    
    void onPaste(PasteEvent event);
+   
+   void detach();
 
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpTab.java
Patch:
@@ -47,6 +47,7 @@ public abstract static class Shim extends DelayLoadTabShim<Help, HelpTab>
       @Handler public abstract void onOpenRMarkdownReferenceGuide();
       @Handler public abstract void onOpenShinyCheatSheet();
       @Handler public abstract void onOpenRoxygenQuickReference();
+      @Handler public abstract void onProfileHelp();
       
       public abstract void bringToFront();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -60,6 +60,7 @@ public interface EditingTarget extends IsWidget,
    String getExtendedFileType();
    
    HashSet<AppCommand> getSupportedCommands();
+   void manageCommands();
    boolean canCompilePdf();
    
    void verifyCppPrerequisites();
@@ -138,6 +139,8 @@ void initialize(SourceDocument document,
     */
    long getLargeFileSize();
    
+   String getDefaultNamePrefix();
+   
    public final static int DISMISS_TYPE_CLOSE = 0;
    public final static int DISMISS_TYPE_MOVE = 1;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -93,7 +93,6 @@ public AceEditorWidget()
       editor_ = AceEditorNative.createEditor(getElement());
       editor_.manageDefaultKeybindings();
       editor_.getRenderer().setHScrollBarAlwaysVisible(false);
-      editor_.getRenderer().setScrollPastEnd(true);
       editor_.setShowPrintMargin(false);
       editor_.setPrintMarginColumn(0);
       editor_.setHighlightActiveLine(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CompletionPosition.java
Patch:
@@ -20,7 +20,7 @@
 
 public class CompletionPosition
 {
-   public enum Scope { Global, Namespace, Member }
+   public enum Scope { Global, Namespace, Member, File }
     
    public CompletionPosition(Position position, String userText, Scope scope)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionContext.java
Patch:
@@ -15,12 +15,12 @@
 
 package org.rstudio.studio.client.workbench.views.source.editors.text.cpp;
 
-import org.rstudio.core.client.CommandWithArg;
+import org.rstudio.core.client.CommandWith2Args;
 
 public interface CppCompletionContext
 {
    boolean isCompletionEnabled();
-   void withUpdatedDoc(CommandWithArg<String> onUpdated);
+   void withUpdatedDoc(CommandWith2Args<String, String> onUpdated);
    void cppCompletionOperation(CppCompletionOperation operation);
    String getDocPath();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -42,9 +42,7 @@ public UrlContentEditingTargetWidget(Commands commands, String url)
 
    private Toolbar createToolbar()
    {
-      Toolbar toolbar = new EditingTargetToolbar(commands_);
-      toolbar.addLeftWidget(commands_.popoutDoc().createToolbarButton());
-      toolbar.addLeftWidget(commands_.returnDocToMain().createToolbarButton());
+      Toolbar toolbar = new EditingTargetToolbar(commands_, true);
       return toolbar;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/CppServerOperations.java
Patch:
@@ -35,8 +35,10 @@ void findCppUsages(
                 ServerRequestCallback<Void> requestCallback);
    
    void getCppCompletions(
+                String line,
                 String docPath, 
-                int line, 
+                String docId,
+                int row, 
                 int column,
                 String userText,
                 ServerRequestCallback<CppCompletionResult> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -328,6 +328,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.rhistory", RHISTORY, icons.iconRhistory());
       register("*.rproj", RPROJECT, icons.iconRproject());
       register("*.rnw", SWEAVE, icons.iconRsweave());
+      register("*.rtex", SWEAVE, icons.iconRsweave());
       register("*.snw", SWEAVE, icons.iconRsweave());
       register("*.nw", SWEAVE, icons.iconRsweave());
       register("*.tex", TEX, icons.iconTex());

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -81,6 +81,6 @@ public final Size getPreferredSize()
          return new Size(960, 700 + chromeHeight);
       
       // default size (html_document and others)
-      return new Size(1020, 1000 + chromeHeight);
+      return new Size(1100, 1000 + chromeHeight);
    }
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -347,6 +347,8 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       {
          results.add(commands.editRmdFormatOptions());
          results.add(commands.knitWithParameters());
+         results.add(commands.restartRClearOutput());
+         results.add(commands.restartRRunAllChunks());
       }
       if (canKnitToHTML() || canCompileNotebook())
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -161,6 +161,8 @@
    public abstract AppCommand consoleClear();
    public abstract AppCommand interruptR();
    public abstract AppCommand restartR();
+   public abstract AppCommand restartRClearOutput();
+   public abstract AppCommand restartRRunAllChunks();
    public abstract AppCommand terminateR();
    public abstract AppCommand activateConsole();
    public abstract AppCommand layoutZoomConsole();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -60,6 +60,7 @@ public interface EditingTarget extends IsWidget,
    String getExtendedFileType();
    
    HashSet<AppCommand> getSupportedCommands();
+   void manageCommands();
    boolean canCompilePdf();
    
    void verifyCppPrerequisites();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -689,9 +689,9 @@ private void onMessage(final String message,
             @Override
             public void onResponseReceived(String response)
             {
-               selectedPath_ = file;
                selectedLine_ = line;
                hasValidPath_ = !StringUtil.isNullOrEmpty(response);
+               selectedPath_ = hasValidPath_ ? response : file;
                
                commands_.gotoProfileSource().setEnabled(hasValidPath_);
                

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -4569,11 +4569,12 @@ public void clearProfile(String path,
       sendRequest(RPC_SCOPE, CLEAR_PROFILE, params, requestCallback);
    }
 
-   public void profileSources(String path,
+   public void profileSources(String path, String normPath,
                               ServerRequestCallback<String> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(path));
+      params.set(1, new JSONString(normPath));
       sendRequest(RPC_SCOPE, PROFILE_SOURCES, params, requestCallback);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/model/ProfilerServerOperations.java
Patch:
@@ -37,6 +37,6 @@ void copyProfile(String fromPath,
    void clearProfile(String path,
                      ServerRequestCallback<JavaScriptObject> requestCallback);
 
-   void profileSources(String path,
+   void profileSources(String path, String normPath,
                        ServerRequestCallback<String> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -546,7 +546,7 @@ public PrefValue<Boolean> showDocumentOutlineRmd()
    
    public PrefValue<String> shownSectionsInDocumentOutline()
    {
-      return string("shown_sections_in_document_outline", DOC_OUTLINE_SHOW_ALL);
+      return string("doc_outline_show", DOC_OUTLINE_SHOW_SECTIONS_ONLY);
    }
 
    public PrefValue<Boolean> showProfiler()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -205,7 +205,7 @@ public void onClick(ClickEvent event)
             new String[] {
                   "Sections Only",
                   "Sections and Named Chunks",
-                  "Sections and Chunks"
+                  "Sections and All Chunks"
             },
             new String[] {
                   UIPrefsAccessor.DOC_OUTLINE_SHOW_SECTIONS_ONLY,

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -324,6 +324,7 @@
    public abstract AppCommand saveProfileAs();
    public abstract AppCommand openProfile();
    public abstract AppCommand profileHelp();
+   public abstract AppCommand gotoProfileSource();
    
    // Tools
    public abstract AppCommand showShellDialog();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1079,7 +1079,7 @@ public void onShowProfiler(OpenProfileEvent event)
       for (int idx = 0; idx < editors_.size(); idx++)
       {
          String path = editors_.get(idx).getPath();
-         if (profilePath.equals(path))
+         if (path != null && profilePath.equals(path))
          {
             ensureVisible(false);
             view_.selectTab(idx);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -65,6 +65,7 @@ private Toolbar createToolbar(Commands commands, PublishHtmlSource publishHtmlSo
    {
       Toolbar toolbar = new EditingTargetToolbar(commands, true);
       
+      toolbar.addLeftWidget(commands.gotoProfileSource().createToolbarButton());
       toolbar.addLeftWidget(commands.saveProfileAs().createToolbarButton());
       
       toolbar.addRightWidget(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerPresenter.java
Patch:
@@ -215,7 +215,7 @@ public void onOpenProfile()
          "Open File",
          fileContext_,
          workbenchContext_.getDefaultFileDialogDir(),
-         ".Rprofvis",
+         "Profvis Profiles (*.Rprofvis)",
          new ProgressOperationWithInput<FileSystemItem>()
          {
             public void execute(final FileSystemItem input,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/model/ProfilerContents.java
Patch:
@@ -32,7 +32,8 @@ public static final native ProfilerContents create(
       contents.path = path;
       contents.htmlPath = htmlPath;
       contents.htmlLocalPath = htmlLocalPath;
-
+      
+      contents.isUserSaved = createProfile ? null : "saved";
       contents.createProfile = createProfile;
       return contents;
    }-*/;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/model/ProfilerServerOperations.java
Patch:
@@ -36,4 +36,7 @@ void copyProfile(String fromPath,
 
    void clearProfile(String path,
                      ServerRequestCallback<JavaScriptObject> requestCallback);
+
+   void profileSources(String path,
+                       ServerRequestCallback<String> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -729,7 +729,7 @@ public void onResponseReceived(String response)
                   {
                      globalDisplay_.showMessage(GlobalDisplay.MSG_ERROR,
                            "Error while opening profiler source",
-                           "Could not find reference to: " + selectedPath_);
+                           "The source file " + selectedPath_ + " does not exist.");
                   }
                }
             }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerPresenter.java
Patch:
@@ -215,7 +215,7 @@ public void onOpenProfile()
          "Open File",
          fileContext_,
          workbenchContext_.getDefaultFileDialogDir(),
-         ".Rprofvis",
+         "Profvis Profiles (*.Rprofvis)",
          new ProgressOperationWithInput<FileSystemItem>()
          {
             public void execute(final FileSystemItem input,

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -388,7 +388,7 @@ public final native boolean exists() /*-{
       MIME_TYPES.put( "gitignore",   "text/plain");
       MIME_TYPES.put( "rbuildignore","text/plain");
       MIME_TYPES.put( "rprofile", "text/x-r-source");
-      MIME_TYPES.put( "rprof", "text/x-r-profile");
+      MIME_TYPES.put( "rprofvis", "text/x-r-profile");
 
       MIME_TYPES.put( "tif",   "image/tiff" );
       MIME_TYPES.put( "tiff",  "image/tiff" );

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -396,7 +396,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.rs", RUST, icons.iconRust());
       register("*.scala", SCALA, icons.iconScala());
       register("*.snippets", SNIPPETS, icons.iconSnippets());
-      register("*.Rprof", PROFILER, icons.iconRprofile());
+      register("*.Rprofvis", PROFILER, icons.iconRprofile());
 
       registerIcon(".jpg", icons.iconPng());
       registerIcon(".jpeg", icons.iconPng());

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ProfilerType.java
Patch:
@@ -38,7 +38,8 @@ public void openFile(FileSystemItem file,
                         int navMethod,
                         EventBus eventBus)
    {
-      eventBus.fireEvent(new OpenProfileEvent(file.getPath(), false));
+      eventBus.fireEvent(new OpenProfileEvent(
+            file.getPath(), null, null, false));
    }
 
    @Override
@@ -59,6 +60,6 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
    
    public String getDefaultExtension()
    {
-      return ".Rprof";
+      return ".Rprofvis";
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/model/ProfilerServerOperations.java
Patch:
@@ -33,4 +33,7 @@ void openProfile(ProfileOperationRequest profilerRequest,
    void copyProfile(String fromPath,
                     String toPath,
                     ServerRequestCallback<JavaScriptObject> requestCallback);
+
+   void clearProfile(String path,
+                     ServerRequestCallback<JavaScriptObject> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -321,7 +321,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
          results.add(commands.commentUncomment());
          results.add(commands.reflowComment());
          results.add(commands.reformatCode());
-         results.add(commands.renameInFile());
+         results.add(commands.renameInScope());
          results.add(commands.profileCode());
          results.add(commands.profileCodeWithoutFocus());
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -126,7 +126,7 @@
    public abstract AppCommand findUsages();
    public abstract AppCommand editRmdFormatOptions();
    public abstract AppCommand knitWithParameters();
-   public abstract AppCommand renameInFile();
+   public abstract AppCommand renameInScope();
    public abstract AppCommand insertRoxygenSkeleton();
    public abstract AppCommand insertSnippet();
  

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -336,7 +336,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.editRmdFormatOptions());
       dynamicCommands_.add(commands.reformatCode());
       dynamicCommands_.add(commands.showDiagnosticsActiveDocument());
-      dynamicCommands_.add(commands.renameInFile());
+      dynamicCommands_.add(commands.renameInScope());
       dynamicCommands_.add(commands.insertRoxygenSkeleton());
       dynamicCommands_.add(commands.expandSelection());
       dynamicCommands_.add(commands.shrinkSelection());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -168,6 +168,9 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
    void setBlinkingCursor(boolean blinking);
    void setHighlightRFunctionCalls(boolean highlight);
    
+   void enableSearchHighlight();
+   void disableSearchHighlight();
+   
    void setUseEmacsKeybindings(boolean use);
    boolean isEmacsModeOn();
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -453,7 +453,7 @@ private Widget createCodeTransformMenuButton()
          menu.addSeparator();
          menu.addItem(commands_.extractFunction().createMenuItem(false));
          menu.addItem(commands_.extractLocalVariable().createMenuItem(false));
-         menu.addItem(commands_.renameInFile().createMenuItem(false));
+         menu.addItem(commands_.renameInScope().createMenuItem(false));
          menu.addSeparator();
          menu.addItem(commands_.reflowComment().createMenuItem(false));
          menu.addItem(commands_.commentUncomment().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -321,7 +321,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
          results.add(commands.commentUncomment());
          results.add(commands.reflowComment());
          results.add(commands.reformatCode());
-         results.add(commands.renameInFile());
+         results.add(commands.renameInScope());
          results.add(commands.profileCode());
          results.add(commands.profileCodeWithoutFocus());
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -126,7 +126,7 @@
    public abstract AppCommand findUsages();
    public abstract AppCommand editRmdFormatOptions();
    public abstract AppCommand knitWithParameters();
-   public abstract AppCommand renameInFile();
+   public abstract AppCommand renameInScope();
    public abstract AppCommand insertRoxygenSkeleton();
    public abstract AppCommand insertSnippet();
  

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -336,7 +336,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.editRmdFormatOptions());
       dynamicCommands_.add(commands.reformatCode());
       dynamicCommands_.add(commands.showDiagnosticsActiveDocument());
-      dynamicCommands_.add(commands.renameInFile());
+      dynamicCommands_.add(commands.renameInScope());
       dynamicCommands_.add(commands.insertRoxygenSkeleton());
       dynamicCommands_.add(commands.expandSelection());
       dynamicCommands_.add(commands.shrinkSelection());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -168,6 +168,9 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
    void setBlinkingCursor(boolean blinking);
    void setHighlightRFunctionCalls(boolean highlight);
    
+   void enableSearchHighlight();
+   void disableSearchHighlight();
+   
    void setUseEmacsKeybindings(boolean use);
    boolean isEmacsModeOn();
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -453,7 +453,7 @@ private Widget createCodeTransformMenuButton()
          menu.addSeparator();
          menu.addItem(commands_.extractFunction().createMenuItem(false));
          menu.addItem(commands_.extractLocalVariable().createMenuItem(false));
-         menu.addItem(commands_.renameInFile().createMenuItem(false));
+         menu.addItem(commands_.renameInScope().createMenuItem(false));
          menu.addSeparator();
          menu.addItem(commands_.reflowComment().createMenuItem(false));
          menu.addItem(commands_.commentUncomment().createMenuItem(false));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -255,7 +255,7 @@ public void onBrowserEvent(Event event)
    private void showHtmlOutput(String url)
    {
       final ChunkOutputFrame frame = new ChunkOutputFrame();
-      frame.getElement().getStyle().setHeight(100, Unit.PCT);
+      frame.getElement().getStyle().setHeight(500, Unit.PX);
       frame.getElement().getStyle().setWidth(100, Unit.PCT);
       root_.add(frame);
 
@@ -265,6 +265,8 @@ private void showHtmlOutput(String url)
          public void execute()
          {
             Style bodyStyle = frame.getDocument().getBody().getStyle();
+            bodyStyle.setPadding(0, Unit.PX);
+            bodyStyle.setMargin(0, Unit.PX);
             bodyStyle.setColor(s_color);
             completeUnitRender();
          };

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleInterruptProfilerButton.java
Patch:
@@ -38,6 +38,7 @@ public static Image CreateProfilerButton()
       Image button = new Image(icon);
       button.addStyleName(ThemeResources.INSTANCE.themeStyles().toolbarButtonLeftImage());
       button.getElement().getStyle().setMarginRight(4,Unit.PX);
+      button.setTitle("Profiling Code");
       
       return button;
    }
@@ -55,7 +56,7 @@ public ConsoleInterruptProfilerButton(final EventBus events,
       
       ImageResource icon = FileIconResources.INSTANCE.iconProfiler();
       Image button = CreateProfilerButton();
-      
+
       width_ = icon.getWidth() + 6;
       height_ = icon.getHeight();
       panel.setWidget(button);

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -473,6 +473,7 @@
    public abstract AppCommand layoutConsoleOnRight();
    public abstract AppCommand paneLayout();
    public abstract AppCommand maximizeConsole();
+   public abstract AppCommand toggleEditorTokenInfo();
    
    public static final String KEYBINDINGS_PATH =
          "~/.R/keybindings/rstudio_commands.json";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1102,7 +1102,6 @@ public void onResponseReceived(SourceDocument response)
             });
    }
    
-
    @Handler
    public void onNewSourceDoc()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -380,4 +380,6 @@ void highlightDebugLocation(
    
    void goToLineStart();
    void goToLineEnd();
+   
+   void toggleTokenInfo();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -3036,7 +3036,6 @@ public boolean isReady(int row)
       private static final int DELAY_MS = 5;
       private static final int ROWS_TOKENIZED_PER_ITERATION = 200;
    }
->>>>>>> origin/master
    
    private static final int DEBUG_CONTEXT_LINES = 2;
    private final HandlerManager handlers_ = new HandlerManager(this);

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -437,6 +437,7 @@
    public abstract AppCommand layoutConsoleOnRight();
    public abstract AppCommand paneLayout();
    public abstract AppCommand maximizeConsole();
+   public abstract AppCommand toggleEditorTokenInfo();
    
    public static final String KEYBINDINGS_PATH =
          "~/.R/keybindings/rstudio_commands.json";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -940,7 +940,6 @@ public void onResponseReceived(SourceDocument response)
             });
    }
    
-
    @Handler
    public void onNewSourceDoc()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -345,4 +345,6 @@ void highlightDebugLocation(
    
    void goToLineStart();
    void goToLineEnd();
+   
+   void toggleTokenInfo();
 }

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -542,7 +542,9 @@ public void withProfvis(String userAction, final Command command)
         "Preparing Profiler",
         userAction, 
         new Dependency[] {
-           Dependency.embeddedPackage("profvis")
+           Dependency.embeddedPackage("profvis"),
+           Dependency.cranPackage("htmlwidgets", "0.6"),
+           Dependency.cranPackage("stringr", "0.6")
         }, 
         false,
         new CommandWithArg<Boolean>()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -129,7 +129,7 @@ public PrefValue<Boolean> allowTabMultilineCompletion()
    
    public PrefValue<Boolean> showFunctionTooltipOnIdle()
    {
-      return bool("show_function_tooltip_on_idle", true);
+      return bool("show_help_tooltip_on_idle", false);
    }
    
    public static final String EDITOR_SURROUND_SELECTION_NEVER               = "never";

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -327,7 +327,7 @@ public void onChange(ChangeEvent event)
       completionPanel.add(insertParensAfterFunctionCompletionsCheckbox);
       completionPanel.add(showSignatureTooltipsCheckbox);
 
-      completionPanel.add(checkboxPref("Show help tooltip on idle", prefs.showFunctionTooltipOnIdle()));
+      completionPanel.add(checkboxPref("Show help tooltip on cursor idle", prefs.showFunctionTooltipOnIdle()));
       completionPanel.add(checkboxPref("Insert spaces around equals for argument completions", prefs.insertSpacesAroundEquals()));
       completionPanel.add(checkboxPref("Use tab for multiline autocompletions", prefs.allowTabMultilineCompletion()));
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -830,7 +830,7 @@ public void execute()
             if (token.matches("^(library|require|requireNamespace|data)\\s*$"))
                canAutoPopup = true;
             
-            sigTipManager_.resolveActiveFunctionAndDisplayToolTip(false);
+            sigTipManager_.resolveActiveFunctionAndDisplayToolTip();
          }
          
          if (

File: src/gwt/src/org/rstudio/core/client/events/EnsureHeightEvent.java
Patch:
@@ -22,6 +22,7 @@ public class EnsureHeightEvent extends GwtEvent<EnsureHeightHandler>
          = new Type<EnsureHeightHandler>();
 
    public static final int MAXIMIZED = -1;
+   public static final int NORMAL = -2;
    
    public EnsureHeightEvent(int height)
    {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -394,7 +394,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.rs", RUST, icons.iconRust());
       register("*.scala", SCALA, icons.iconScala());
       register("*.snippets", SNIPPETS, icons.iconSnippets());
-      register("*.rprof", PROFILER, icons.iconRprofile());
+      register("*.Rprof", PROFILER, icons.iconRprofile());
 
       registerIcon(".jpg", icons.iconPng());
       registerIcon(".jpeg", icons.iconPng());

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ProfilerType.java
Patch:
@@ -38,7 +38,7 @@ public void openFile(FileSystemItem file,
                         int navMethod,
                         EventBus eventBus)
    {
-      eventBus.fireEvent(new OpenProfileEvent(file.getPath()));
+      eventBus.fireEvent(new OpenProfileEvent(file.getPath(), false));
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -140,6 +140,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ChunkOutputFinished = "chunk_output_finished";
    public static final String RprofStarted = "rprof_started";
    public static final String RprofStopped = "rprof_stopped";
+   public static final String RprofCreated = "rprof_created";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -321,6 +321,9 @@
    public abstract AppCommand stopProfiler();
    public abstract AppCommand profileCode();
    public abstract AppCommand profileCodeWithoutFocus();
+   public abstract AppCommand saveProfileAs();
+   public abstract AppCommand openProfile();
+   public abstract AppCommand profileHelp();
    
    // Tools
    public abstract AppCommand showShellDialog();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpTab.java
Patch:
@@ -47,6 +47,7 @@ public abstract static class Shim extends DelayLoadTabShim<Help, HelpTab>
       @Handler public abstract void onOpenRMarkdownReferenceGuide();
       @Handler public abstract void onOpenShinyCheatSheet();
       @Handler public abstract void onOpenRoxygenQuickReference();
+      @Handler public abstract void onProfileHelp();
       
       public abstract void bringToFront();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1089,7 +1089,9 @@ public void onShowProfiler(OpenProfileEvent event)
       server_.newDocument(
             FileTypeRegistry.PROFILER.getTypeId(),
             null,
-            (JsObject) ProfilerContents.create(profilePath).cast(),
+            (JsObject) ProfilerContents.create(
+                  profilePath,
+                  event.getCreateProfile()).cast(),
             new SimpleRequestCallback<SourceDocument>("Show Profiler")
             {
                @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTargetCodeExecution.java
Patch:
@@ -171,7 +171,7 @@ private void executeRange(Range range, String functionWrapper)
       
       if (functionWrapper != null)
       {
-         code = functionWrapper + "(" + code + ")";
+         code = functionWrapper + "({" + code + "})";
       }
       
       // send to console

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -129,7 +129,7 @@ public PrefValue<Boolean> allowTabMultilineCompletion()
    
    public PrefValue<Boolean> showFunctionTooltipOnIdle()
    {
-      return bool("show_function_tooltip_on_idle", true);
+      return bool("show_help_tooltip_on_idle", false);
    }
    
    public static final String EDITOR_SURROUND_SELECTION_NEVER               = "never";

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -394,7 +394,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.rs", RUST, icons.iconRust());
       register("*.scala", SCALA, icons.iconScala());
       register("*.snippets", SNIPPETS, icons.iconSnippets());
-      register("*.rprof", PROFILER, icons.iconRprofile());
+      register("*.Rprof", PROFILER, icons.iconRprofile());
 
       registerIcon(".jpg", icons.iconPng());
       registerIcon(".jpeg", icons.iconPng());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -98,12 +98,13 @@ protected Toolbar createMainToolbar()
       toolbar.addLeftWidget(workingDir_);
       toolbar.addLeftWidget(commands_.goToWorkingDir().createToolbarButton());
       consoleInterruptButton_ = commands_.interruptR().createToolbarButton();
-      toolbar.addRightWidget(consoleInterruptButton_);
       
       ImageResource profilerIcon = FileIconResources.INSTANCE.iconProfiler();
-      profilerInterruptButton_= new ToolbarButton(profilerIcon, commands_.stopProfiler());
+      profilerInterruptButton_ = new ToolbarButton(profilerIcon, commands_.stopProfiler());
+      profilerInterruptButton_.setVisible(false);
 
       toolbar.addRightWidget(profilerInterruptButton_);
+      toolbar.addRightWidget(consoleInterruptButton_);
       
       return toolbar;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTargetWidget.java
Patch:
@@ -53,9 +53,6 @@ public ProfilerEditingTargetWidget(Commands commands)
    private Toolbar createToolbar(Commands commands)
    {
       Toolbar toolbar = new EditingTargetToolbar(commands);
-      toolbar.addLeftSeparator();
-      toolbar.addLeftWidget(commands.startProfiler().createToolbarButton());
-      toolbar.addLeftWidget(commands.stopProfiler().createToolbarButton());
       return toolbar;
    }
    

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -98,7 +98,6 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetRMarkdownHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionRequest;
-import org.rstudio.studio.client.workbench.views.source.editors.text.r.RCompletionToolTip;
 import org.rstudio.studio.client.workbench.views.source.model.CppCompletion;
 import org.rstudio.studio.client.workbench.views.source.editors.text.r.SignatureToolTipManager;
 import org.rstudio.studio.client.workbench.views.source.editors.text.rmd.ChunkIconsManager;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManager.java
Patch:
@@ -35,5 +35,7 @@ interface InitCompletionFilter
    void close();
    
    void onPaste(PasteEvent event);
+   
+   void detach();
 
 }

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -388,6 +388,7 @@ public final native boolean exists() /*-{
       MIME_TYPES.put( "gitignore",   "text/plain");
       MIME_TYPES.put( "rbuildignore","text/plain");
       MIME_TYPES.put( "rprofile", "text/x-r-source");
+      MIME_TYPES.put( "rprof", "text/x-r-profile");
 
       MIME_TYPES.put( "tif",   "image/tiff" );
       MIME_TYPES.put( "tiff",  "image/tiff" );

File: src/gwt/src/org/rstudio/core/client/widget/ProgressIndicator.java
Patch:
@@ -17,6 +17,7 @@
 public interface ProgressIndicator
 {
    void onProgress(String message);
+   void onProgress(String message, Operation onCancel);
    void onCompleted();
    void onError(String message);
    void clearProgress();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RMarkdownServerOperations.java
Patch:
@@ -67,7 +67,8 @@ void executeInlineChunk(String docPath, String docId, String chunkId,
                            String options, String content, 
                            ServerRequestCallback<Void> requestCallback);
    
-   void refreshChunkOutput(String docPath, String docId, String requestId, 
+   void refreshChunkOutput(String docPath, String docId, String contextId,
+                           String requestId, 
                            ServerRequestCallback<Void> requestCallback);
    
    void setChunkConsole(String docId, String chunkId, 

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -138,7 +138,9 @@ class ClientEvent extends JavaScriptObject
    public static final String AddinRegistryUpdated = "addin_registry_updated";
    public static final String ChunkOutput = "chunk_output";
    public static final String ChunkOutputFinished = "chunk_output_finished";
-   
+   public static final String RprofStarted = "rprof_started";
+   public static final String RprofStopped = "rprof_stopped";
+
    protected ClientEvent()
    {
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -245,8 +245,8 @@ public final native boolean projectSupportsSharing() /*-{
       return !!this.project_supports_sharing;
    }-*/;
    
-   public final native boolean isProjectOwner() /*-{
-      return !!this.project_owned_by_user;
+   public final native boolean projectParentBrowseable() /*-{
+      return !!this.project_parent_browseable;
    }-*/;
    
    public final native String getProjectUserDataDir() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -85,7 +85,6 @@ public AppearancePreferencesPane(PreferencesDialogResources res,
                public void onChange(ChangeEvent event)
                {
                   updatePreviewZoomLevel();
-                  preview_.reload();
                }
             });
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportDataActiveColumn.java
Patch:
@@ -41,6 +41,6 @@ public final native int getIndex() /*-{
    }-*/;
    
    public final native String getName() /*-{
-      return this.name;
+      return this.name.toString();
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/FilesPane.java
Patch:
@@ -129,7 +129,7 @@ public void onResponseReceived(DirectoryListing response)
                // if we're in someone else's project, disable paths above
                // the project
                SessionInfo si = session_.getSessionInfo();
-               if (si.getActiveProjectDir() != null && !si.isProjectOwner())
+               if (si.getActiveProjectDir() != null && !si.projectParentBrowseable())
                   lastBrowseable = si.getActiveProjectDir().getPath();
             }
                

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceShim.java
Patch:
@@ -121,8 +121,6 @@ public abstract static class AsyncSource extends AsyncShim<Source>
       public abstract void onSourceNavigateBack();
       @Handler
       public abstract void onSourceNavigateForward();
-      @Handler
-      public abstract void onShowProfiler();
       
       @Override
       protected void preInstantiationHook(Command continuation)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceVimCommands.java
Patch:
@@ -38,7 +38,7 @@ public native final void selectTabIndex(Source source) /*-{
       }
       
       var nextTab = $entry(function(cm, args, vim) {
-         source.@org.rstudio.studio.client.workbench.views.source.Source::onNextTab()();
+         source.@org.rstudio.studio.client.workbench.views.source.Source::nextTabWithWrap()();
       });
      
       Vim.defineAction("selectNextTab", nextTab);
@@ -51,7 +51,7 @@ public native final void selectTabIndex(Source source) /*-{
       });
 
       var prevTab = $entry(function(cm, args, vim) {
-         source.@org.rstudio.studio.client.workbench.views.source.Source::onPreviousTab()();
+         source.@org.rstudio.studio.client.workbench.views.source.Source::prevTabWithWrap()();
       });
      
       Vim.defineAction("selectPreviousTab", prevTab);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTargetCodeExecution.java
Patch:
@@ -120,7 +120,7 @@ public void executeRange(Range range)
       }
       
       // if we're in a chunk with in-line output, execute it there instead
-      if (prefs_.showRmdChunkOutputInline().getValue())
+      if (docDisplay_.showChunkOutputInline())
       {
          Scope scope = docDisplay_.getCurrentChunk(range.getStart());
          if (scope != null)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/model/DataImportServerOperations.java
Patch:
@@ -37,4 +37,6 @@ void previewDataImportAsync(DataImportOptions dataImportOptions,
    void interrupt(ServerRequestCallback<Void> requestCallback);
    
    void previewDataImportAsyncAbort(ServerRequestCallback<Void> requestCallback);
+   
+   void previewDataImportClean(DataImportOptions dataImportOptions, ServerRequestCallback<Void> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -85,7 +85,6 @@ public AppearancePreferencesPane(PreferencesDialogResources res,
                public void onChange(ChangeEvent event)
                {
                   updatePreviewZoomLevel();
-                  preview_.reload();
                }
             });
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -237,6 +237,7 @@ InputEditorSelection search(String needle,
    void alignCursor(Position position, double ratio);
    void centerSelection();
    
+   int getSuggestedScopeUpdateDelay();
    Scope getCurrentScope();
    Scope getCurrentChunk();
    Scope getCurrentChunk(Position position);

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -387,7 +387,7 @@ public final native boolean exists() /*-{
       MIME_TYPES.put( "pot",   "text/plain");
       MIME_TYPES.put( "gitignore",   "text/plain");
       MIME_TYPES.put( "rbuildignore","text/plain");
-      MIME_TYPES.put( "rprofile", "text/x-r-source");
+      MIME_TYPES.put( "rprof", "text/x-r-profile");
 
       MIME_TYPES.put( "tif",   "image/tiff" );
       MIME_TYPES.put( "tiff",  "image/tiff" );

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -297,8 +297,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.r", R, icons.iconRdoc());
       register("*.q", R, icons.iconRdoc());
       register("*.s", R, icons.iconRdoc());
-      register(".rprofile", R, icons.iconRprofile());
-      register("Rprofile.site", R, icons.iconRprofile());
+      register(".rprof", R, icons.iconRprofile());
       register("DESCRIPTION", DCF, icons.iconDCF());
       register("INDEX", TEXT, icons.iconText());
       register("LICENCE", TEXT, icons.iconText());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -42,7 +42,6 @@
 import com.google.inject.Inject;
 
 import org.rstudio.core.client.CommandWithArg;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.ExternalJavaScriptLoader;
 import org.rstudio.core.client.MathUtil;
@@ -2930,7 +2929,6 @@ public ScopeTimer(final AceEditor editor)
             @Override
             public void run()
             {
-               Debug.logToConsole("Tokenizing up to row: " + row_);
                if (row_ >= editor.getRowCount())
                   return;
                

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -219,10 +219,12 @@ DataImportFileChooser makeFileOrUrlChooserTextBox() {
                @Override
                public void execute()
                {
+                  // Invalidate cached files, click update to refresh stale files
+                  localFiles_ = null;
+                  
                   if (dataImportFileChooser_.getText() != importOptions_.getImportLocation())
                   {
                      lastSuccessfulResponse_ = null;
-                     localFiles_ = null;
                      resetColumnDefinitions();
                   }
                   

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -134,7 +134,7 @@ private native final void addNativeEditHandlers() /*-{
    
    private void onNativeEditEvent(Object object)
    {
-	   keyBuffer_.clear();
+      keyBuffer_.clear();
    }
    
    @Inject

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/TextEditingTargetNotebook.java
Patch:
@@ -317,6 +317,8 @@ private void maximizeSourcePaneIfNecessary()
       {
          // see if the Source and Console are paired
          PaneConfig paneConfig = uiPrefs_.paneConfig().getValue();
+         if (paneConfig == null)
+            paneConfig = PaneConfig.createDefault();
          if (hasSourceAndConsolePaired(paneConfig.getPanes()))
          {
             events_.fireEvent(new MaximizeSourceWindowEvent());

File: src/gwt/src/org/rstudio/core/client/widget/ProgressIndicator.java
Patch:
@@ -17,6 +17,7 @@
 public interface ProgressIndicator
 {
    void onProgress(String message);
+   void onProgress(String message, Operation onCancel);
    void onCompleted();
    void onError(String message);
    void clearProgress();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportDataActiveColumn.java
Patch:
@@ -41,6 +41,6 @@ public final native int getIndex() /*-{
    }-*/;
    
    public final native String getName() /*-{
-      return this.name;
+      return this.name.toString();
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptionsUiCsv.java
Patch:
@@ -126,7 +126,7 @@ void initDefaults()
       delimiterListBox_.addItem("Comma", ",");
       delimiterListBox_.addItem("Semicolon", ";");
       delimiterListBox_.addItem("Tab", "\t");
-      delimiterListBox_.addItem("Whitespace", "");
+      delimiterListBox_.addItem("Whitespace", " ");
       
       quotesListBox_.addItem("Default", "");
       quotesListBox_.addItem("Single (')", "'");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/model/DataImportPreviewResponse.java
Patch:
@@ -24,7 +24,7 @@ protected DataImportPreviewResponse()
    }
    
    public final native String getErrorMessage() /*-{
-      return this.error ? this.error.message.join(' ') : null;
+      return (this.error && this.error.message) ? this.error.message.join(' ') : null;
    }-*/;
    
    public final native int getParsingErrors() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptions.java
Patch:
@@ -142,7 +142,8 @@ public final native void setBaseColumnDefinitions(DataImportPreviewResponse resp
             this_.columnDefinitions[response.columns[key].col_name] = {
                index: index,
                name: response.columns[key].col_name,
-               assignedType: null
+               assignedType: null,
+               rType: response.columns[key].col_type_r
             };
          }
       });

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -316,6 +316,7 @@ public void applyCachedEditorStyle()
          Style bodyStyle = frame_.getDocument().getBody().getStyle();
          bodyStyle.setColor(s_color);
       }
+      getElement().getStyle().setBackgroundColor(s_backgroundColor);
    }
    
    public void showConsoleCode(String code)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputWidget.java
Patch:
@@ -175,9 +175,10 @@ private void showConsoleOutput(JsArray<JsArrayEx> output)
                      output.get(i).getString(1)), 
                classOfOutput(output.get(i).getInt(0)));
       }
+      if (state_ == CHUNK_EXECUTING)
+         showReadyState();
       vconsole_.redraw(console_.getElement());
       onRenderCompleted_.execute(console_.getElement().getOffsetHeight());
-      
       state_ = CONSOLE_READY;
    }
    
@@ -317,6 +318,7 @@ private void initConsole()
       if (console_ == null)
       {
          console_ = new PreWidget();
+         console_.getElement().removeAttribute("tabIndex");
          console_.getElement().getStyle().setMarginTop(0, Unit.PX);
       }
       else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -431,7 +431,7 @@ public void onKeyDown(KeyDownEvent event)
             NativeEvent ne = event.getNativeEvent();
             int mod = KeyboardShortcut.getModifierValue(ne);
             
-            if ((mod == KeyboardShortcut.META || (mod == KeyboardShortcut.CTRL && !BrowseCap.hasMetaKey()))
+            if ((mod == KeyboardShortcut.META || (mod == KeyboardShortcut.CTRL && !BrowseCap.hasMetaKey() && !docDisplay_.isEmacsModeOn()))
                 && ne.getKeyCode() == 'F')
             {
                event.preventDefault();

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationUtils.java
Patch:
@@ -36,8 +36,8 @@ public static String getHostPageBaseURLWithoutContext(boolean includeSlash)
    // > 0 if version1 is later than version 2
    public static int compareVersions(String version1, String version2)
    {
-      String[] v1parts = version1.split(".");
-      String[] v2parts = version2.split(".");
+      String[] v1parts = version1.split("\\.");
+      String[] v2parts = version2.split("\\.");
       int numParts = Math.min(v1parts.length, v2parts.length);
       for (int i = 0; i < numParts; i++)
       {

File: src/gwt/src/org/rstudio/core/client/files/filedialog/FileSystemDialog.java
Patch:
@@ -190,6 +190,7 @@ protected void accept()
    public void showModal()
    {
       super.showModal();
+      
       Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          public void execute()

File: src/gwt/src/org/rstudio/core/client/widget/FileOrUrlChooserTextBox.java
Patch:
@@ -18,6 +18,7 @@
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.studio.client.RStudioGinjector;
 
+import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.dom.client.ClickEvent;
 import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.logical.shared.ValueChangeEvent;
@@ -40,6 +41,8 @@ public FileOrUrlChooserTextBox(String label, Operation updateOperation, final Fo
       
       updateOperation_ = updateOperation;
       
+      getTextBox().getElement().getStyle().setHeight(22, Unit.PX);
+      
       super.addValueChangeHandler(new ValueChangeHandler<String>()
       {
          @Override

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -104,6 +104,7 @@
 import org.rstudio.studio.client.workbench.views.environment.ClearAllDialog;
 import org.rstudio.studio.client.workbench.views.environment.dataimport.DataImport;
 import org.rstudio.studio.client.workbench.views.environment.dataimport.DataImportDialog;
+import org.rstudio.studio.client.workbench.views.environment.dataimport.DataImportOptionsUiCsv;
 
 @GinModules(RStudioGinModuleOverlay.class)
 public interface RStudioGinjector extends Ginjector
@@ -166,6 +167,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(AddinExecutor addinExecutor);
    void injectMembers(DataImportDialog dataImportDialog);
    void injectMembers(DataImport dataImport);
+   void injectMembers(DataImportOptionsUiCsv dataImport);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -373,7 +373,9 @@ public void onResponseReceived(DataImportPreviewResponse response)
             
             gridViewer_.setOption("nullsAsNAs", "true");
             gridViewer_.setOption("status",
-                  "Previewing first " + toLocaleString(maxRows_) + " entries");
+                  "Previewing first " + toLocaleString(maxRows_) + 
+                  " entries. " + Integer.toString(response.getParsingErrors()) +
+                  " parsing errors.");
             gridViewer_.setOption("ordering", "false");
             gridViewer_.setOption("rowNumbers", "false");
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -201,14 +201,14 @@ private void previewDataImport()
       }
       importOptions_ = previewImportOptions;
       
+      assembleDataImport();
+      
       if (fileOrUrlChooserTextBox_.getText() == "")
       {
          gridViewer_.setData(null);
          return;
       }
       
-      assembleDataImport();
-      
       previewImportOptions.setMaxRows(maxRows_);
       
       progressIndicator_.onProgress("Retrieving preview data");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptions.java
Patch:
@@ -36,7 +36,8 @@ public final native void setImportLocation(String importLocation) /*-{
    }-*/;
    
    public final String getImportLocation() {
-      return new String(getImportLocationNative().toString());
+      JavaScriptObject locaiton = getImportLocationNative();
+      return locaiton != null ? new String(locaiton.toString()) : null;
    }
    
    private final native JavaScriptObject getImportLocationNative() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -218,14 +218,16 @@ public void onResponseReceived(DataImportPreviewResponse response)
             gridViewer_.setOption("ordering", "false");
             gridViewer_.setOption("rowNumbers", "false");
             
+            response.assignColumnTypes(columnDefinitions_);
+            
             gridViewer_.setData(response);
             gridViewer_.setColumnDefinitionsUIVisible(true, new Operation()
             {
                @Override
                public void execute()
                {
                   columnDefinitions_ = gridViewer_.getColumnDefinitions();
-                  assembleDataImport();
+                  previewDataImport();
                }
             });
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -214,6 +214,7 @@ public void onResponseReceived(DataImportPreviewResponse response)
             gridViewer_.setOption("rowNumbers", "false");
             
             gridViewer_.setData(response);
+            gridViewer_.setColumnTypeUIVisible(true);
             
             progressIndicator_.onCompleted();
          }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -4437,7 +4437,7 @@ public void previewDataImport(DataImportOptions dataImportOptions,
                                  ServerRequestCallback<DataImportPreviewResponse> requestCallback)
    {
       JSONArray params = new JSONArray();
-      params.set(0, dataImportOptions.toJSONObject());
+      params.set(0, new JSONObject(dataImportOptions));
       params.set(1, new JSONNumber(maxCols));
       params.set(2, new JSONNumber(maxFactors));
       sendRequest(RPC_SCOPE, PREVIEW_DATA_IMPORT, params, requestCallback);
@@ -4448,7 +4448,7 @@ public void assembleDataImport(DataImportOptions dataImportOptions,
                                   ServerRequestCallback<DataImportAssembleResponse> requestCallback)
    {
       JSONArray params = new JSONArray();
-      params.set(0, dataImportOptions.toJSONObject());
+      params.set(0, new JSONObject(dataImportOptions));
       sendRequest(RPC_SCOPE, ASSEMBLE_DATA_IMPORT, params, requestCallback);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptionsUi.java
Patch:
@@ -26,7 +26,7 @@ public class DataImportOptionsUi extends Composite implements HasValueChangeHand
 {
    public DataImportOptions getOptions()
    {
-      return new DataImportOptions();
+      return DataImportOptions.create();
    }
 
    public HandlerRegistration addValueChangeHandler(ValueChangeHandler<DataImportOptions> handler)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -196,6 +196,7 @@ public void onResponseReceived(DataImportPreviewResponse response)
          {
             if (response.getErrorMessage() != null)
             {
+               gridViewer_.setData(null);
                progressIndicator_.onError(response.getErrorMessage());
                return;
             }
@@ -210,6 +211,7 @@ public void onResponseReceived(DataImportPreviewResponse response)
          @Override
          public void onError(ServerError error)
          {
+            gridViewer_.setData(null);
             progressIndicator_.onError(error.getMessage());
          }
       });

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImportOptionsCsv.java
Patch:
@@ -111,7 +111,7 @@ public JSONObject toJSONObject()
       json.put("locale", locale_ != null ? new JSONString(locale_) : null);
       json.put("na", na_ != null ? new JSONString(na_) : null);
       json.put("comments", comments_ != null ? new JSONString(comments_) : null);
-      json.put("skip", comments_ != null ? new JSONNumber(skip_) : null);
+      json.put("skip", new JSONNumber(skip_));
       
       return json;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/dataimport/DataImport.java
Patch:
@@ -93,6 +93,9 @@ public void onValueChange(ValueChangeEvent<String> arg0)
    @UiField
    GridViewerFrame gridViewer_;
    
+   @UiField
+   DataImportOptionsBase dataImportOptionsBase_;
+   
    public DataImportOptions getOptions()
    {
       DataImportOptions options = new DataImportOptions();

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarButton.java
Patch:
@@ -173,7 +173,10 @@ public void onMouseDown(MouseDownEvent event)
                public void onPopupMenu(final ToolbarPopupMenu menu)
                {
                   if (menuShowing[0])
+                  {
+                     removeStyleName(styles_.toolbarButtonPushed());
                      menu.hide();
+                  }
                   else
                   {
                      if (rightAlign)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -475,7 +475,7 @@ public void onError(ServerError error)
    void onImportDatasetFromCSV()
    {
       view_.bringToFront();
-      DataImportDialog dataImportDialog = new DataImportDialog("CSV Import", new OperationWithInput<String>()
+      DataImportDialog dataImportDialog = new DataImportDialog("Import CSV", new OperationWithInput<String>()
       {
          @Override
          public void execute(String input)

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -407,6 +407,7 @@ public void execute()
                                        public void execute()
                                        {
                                           indicator.onCompleted();
+                                          ShortcutManager.INSTANCE.resetAppCommandBindings();
                                           resetState();
                                        }
                                     });

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/model/GitHubViewRequest.java
Patch:
@@ -67,5 +67,5 @@ public int getEndLine()
    private int endLine_;
    
    public final static int VCS_VIEW = 0;
-   public final static int VCS_BLAME = 0;
+   public final static int VCS_BLAME = 1;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/AddinsMRUList.java
Patch:
@@ -140,7 +140,7 @@ public int compare(RAddin o1, RAddin o2)
             
             // Recently used commands come first.
             if (r1 != r2)
-               return r1 ? 1 : -1;
+               return r1 ? -1 : 1;
             
             // Otherwise, compare on IDs.
             return o1.getId().compareTo(o2.getId());

File: src/gwt/src/org/rstudio/studio/client/workbench/AddinsMRUList.java
Patch:
@@ -160,8 +160,6 @@ public void updateShortcuts()
          List<KeySequence> bindings = keyMap.getBindings(id);
          if (bindings != null && !bindings.isEmpty())
             commands[i].setShortcut(new KeyboardShortcut(bindings.get(0)));
-         else
-            Debug.logToRConsole("Failed to find binding for id '" + id + "'");
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -59,6 +59,7 @@ public interface FileIconResources extends ClientBundle
    ImageResource iconSourceViewer();
    ImageResource iconProfiler();
    ImageResource iconWord();
+   ImageResource iconDCF();
    
    // Ace modes
    ImageResource iconClojure();

File: src/gwt/src/org/rstudio/core/client/command/ApplicationCommandManager.java
Patch:
@@ -131,9 +131,11 @@ private void loadBindings(EditorKeyBindings bindings,
       KeyMap map = ShortcutManager.INSTANCE.getKeyMap(KeyMapType.APPLICATION);
       for (int i = 0; i < resolvedBindings.size(); i++)
       {
+         // TODO: We should make it possible for users to define a command
+         // binding that is disabled for certain modes.
          map.setBindings(
                resolvedBindings.get(i).first,
-               new AppCommandBinding(resolvedBindings.get(i).second, ""));
+               new AppCommandBinding(resolvedBindings.get(i).second, "", true));
       }
       
       // TODO: Set the bindings in the AppCommand keymap, removing any

File: src/gwt/src/org/rstudio/core/client/command/KeyMap.java
Patch:
@@ -32,11 +32,13 @@ public class KeyMap
    public static enum KeyMapType {
       ADDIN, EDITOR, APPLICATION;
    }
+   
    public interface CommandBinding
    {
       public String getId();
       public void execute();
       public boolean isEnabled();
+      public boolean isUserDefinedBinding();
    }
    
    public KeyMap()

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -221,7 +221,7 @@ public void register(KeySequence keys,
          // Add the command into the keymap, ensuring it can be executed on the associated
          // keypress.
          KeyMap appKeyMap = keyMaps_.get(KeyMapType.APPLICATION);
-         appKeyMap.addBinding(keys, new AppCommandBinding(command, disableModes));
+         appKeyMap.addBinding(keys, new AppCommandBinding(command, disableModes, false));
       }
    }
    

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -210,7 +210,7 @@ public void register(KeySequence keys,
       KeyboardShortcut shortcut = new KeyboardShortcut(keys, groupName, title, disableModes);
       shortcutInfo_.add(new ShortcutInfo(shortcut, command));
       
-      // Bind the command in the application keymap.
+      // Bind the command in the application key map.
       if (command != null)
       {
          // Setting the shortcut on the command just registers this binding as the

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -132,7 +132,8 @@ else if (versionsInfo.isMultiVersion())
                  "never"
             },
             false,
-            true);
+            true,
+            false);
       if (session_.getSessionInfo().getShowUserHomePage())
       {
          spaced(showServerHomePage_);

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -4395,7 +4395,7 @@ public void setFollowingUser(String sessionId,
    }
 
    private String clientId_;
-   private double clientVersion_ = 0;
+   private String clientVersion_ = "";
    private boolean listeningForEvents_;
    private boolean disconnected_;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -44,8 +44,8 @@ public final native String getClientId() /*-{
       return this.clientId;
    }-*/;
    
-   public final native double getClientVersion() /*-{
-      return this.version;
+   public final native String getClientVersion() /*-{
+      return this.client_version;
    }-*/;
 
    public final native String getUserIdentity() /*-{

File: src/gwt/src/org/rstudio/core/client/command/KeyMap.java
Patch:
@@ -17,9 +17,8 @@
 // A KeyMap provides a two-way lookup between a KeySequence, and a BindableCommand:
 // - Given a key sequence, one can discover commands bound to that key sequence,
 // - Given a command, one can discover what key sequences it is bound to.
-import com.google.gwt.dev.util.collect.HashMap;
-
 import java.util.ArrayList;
+import java.util.HashMap;
 import java.util.List;
 import java.util.Map;
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -733,6 +733,7 @@ else if (type.equals(ClientEvent.SendToConsole))
          {
             SendToConsoleEvent.Data data = event.getData();
             eventBus_.fireEvent(new SendToConsoleEvent(data));
+         }
          else if (type.equals(ClientEvent.UserFollowStarted))
          {
             ProjectUser user = event.getData();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -95,7 +95,7 @@ public class SourceWindowManager implements PopoutDocEvent.Handler,
                                             CollabEditEndedEvent.Handler,
                                             ReplaceSelectionDispatchEvent.Handler,
                                             ReplaceRangesDispatchEvent.Handler,
-                                            GetActiveDocumentContextDispatchEvent.Handler
+                                            GetActiveDocumentContextDispatchEvent.Handler,
                                             DocFocusedEvent.Handler
 {
    @Inject

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -18,12 +18,12 @@
 
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.studio.client.common.codetools.CodeToolsServerOperations;
+import org.rstudio.studio.client.events.GetActiveDocumentContextEvent;
 import org.rstudio.studio.client.htmlpreview.model.HTMLPreviewServerOperations;
 import org.rstudio.studio.client.notebook.CompileNotebookOptions;
 import org.rstudio.studio.client.notebook.CompileNotebookResult;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.Void;
-import org.rstudio.studio.client.server.VoidServerRequestCallback;
 import org.rstudio.studio.client.workbench.codesearch.model.CodeSearchServerOperations;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildServerOperations;
 import org.rstudio.studio.client.workbench.views.files.model.FilesServerOperations;
@@ -226,6 +226,6 @@ public void createShinyApp(String appName,
                               String appDir,
                               ServerRequestCallback<JsArrayString> requestCallback);
    
-   public void getActiveDocumentContextCompleted(JsObject context,
-                                                 VoidServerRequestCallback requestCallback);
+   public void getActiveDocumentContextCompleted(GetActiveDocumentContextEvent.Data data,
+                                                 ServerRequestCallback<Void> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/NewShinyWebApplication.java
Patch:
@@ -200,9 +200,7 @@ public NewShinyWebApplication(String caption,
       addTextFieldValidator(appNameTextBox_);
       
       String cachedAppName = result_.getAppName();
-      String appName = StringUtil.isNullOrEmpty(cachedAppName)
-            ? "shiny"
-            : cachedAppName;
+      String appName = StringUtil.isNullOrEmpty(cachedAppName) ? "" : cachedAppName;
       appNameTextBox_.setText(appName);
       
       appTypeLabel_ = new Label("Application type:");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1132,7 +1132,6 @@ public void execute()
          {
             NewShinyWebApplication widget = new NewShinyWebApplication(
                   "New Shiny Web Application",
-                  workbenchContext_.getCurrentWorkingDir(),
                   new OperationWithInput<NewShinyWebApplication.Result>()
                   {
                      @Override

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -380,10 +380,7 @@ private boolean handleKeyDown(NativeEvent e)
       
       // If this matches a prefix key, return false early.
       if (prefixes_.contains(shortcut.getKeySequence()))
-      {
-         e.preventDefault();
          return false;
-      }
       
       // Clear the key buffer (we've reached a 'leaf' for the
       // key sequence chain; there may or may not be a command)

File: src/gwt/src/org/rstudio/studio/client/application/ui/RVersionSelectWidget.java
Patch:
@@ -27,7 +27,7 @@ public class RVersionSelectWidget extends SelectWidget
 {
    public RVersionSelectWidget(JsArray<RVersionSpec> rVersions)
    {
-      this("R version for new sessions:", rVersions, true, true);
+      this("Default version of R:", rVersions, true, true);
    }
    
    public RVersionSelectWidget(String caption,

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewProjectWizard.java
Patch:
@@ -58,8 +58,9 @@ public NewProjectWizard(
            rVersions.getAvailableRVersions(),
            false,
            false);
-         RVersionSpec rVersion = RVersionSpec.create(rVersions.getRVersion(),
-                                                     rVersions.getRVersionHome());
+         RVersionSpec rVersion = RVersionSpec.create(
+               rVersions.getDefaultRVersion(),
+               rVersions.getDefaultRVersionHome());
          rVersionSelector_.setRVersion(rVersion);
          addLeftWidget(rVersionSelector_);
          rVersionSelector_.getElement().getStyle().setMarginRight(8, Unit.PX);

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -380,7 +380,10 @@ private boolean handleKeyDown(NativeEvent e)
       
       // If this matches a prefix key, return false early.
       if (prefixes_.contains(shortcut.getKeySequence()))
+      {
+         e.preventDefault();
          return false;
+      }
       
       // Clear the key buffer (we've reached a 'leaf' for the
       // key sequence chain; there may or may not be a command)

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdParamsEditDialog.java
Patch:
@@ -73,6 +73,8 @@ protected void onDialogShown()
    private native void initializeEvents() /*-{  
       var thiz = this;   
       var handler = $entry(function(e) {
+         if (typeof e.data != 'string')
+            return;
          thiz.@org.rstudio.studio.client.rmarkdown.ui.RmdParamsEditDialog::onMessage(Ljava/lang/String;Ljava/lang/String;)(e.data, e.origin);
          $wnd.removeEventListener('message', handler, false);
       });

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyDisconnectNotifier.java
Patch:
@@ -33,6 +33,8 @@ private native void initializeEvents() /*-{
       $wnd.addEventListener(
             "message",
             $entry(function(e) {
+               if (typeof e.data != 'string')
+                  return;
                thiz.@org.rstudio.studio.client.shiny.ShinyDisconnectNotifier::onMessage(Ljava/lang/String;Ljava/lang/String;)(e.data, e.origin);
             }),
             true);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPresenter.java
Patch:
@@ -512,6 +512,8 @@ private native void initializeEvents() /*-{
       $wnd.addEventListener(
             "message",
             $entry(function(e) {
+               if (typeof e.data != 'string')
+                  return;
                thiz.@org.rstudio.studio.client.workbench.views.viewer.ViewerPresenter::onMessage(Ljava/lang/String;Ljava/lang/String;)(e.data, e.origin);
             }),
             true);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationDispatcher.java
Patch:
@@ -100,7 +100,7 @@ public void dispatchCommand(JavaScriptObject jsCommand)
       
       if (cmdName.equals("source"))
          performSourceCommand(param1, param2);
-      else if (!Desktop.isDesktop()) // support other commands in server mode
+      else if (session_.getSessionInfo().getPresentationCommands()) 
          performOtherCommand(cmdName, params, param1, param2);
    }
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -1,7 +1,7 @@
 /*
  * ClientEvent.java
  *
- * Copyright (C) 2009-12 by RStudio, Inc.
+ * Copyright (C) 2009-15 by RStudio, Inc.
  *
  * Unless you have received this program directly from RStudio pursuant
  * to the terms of a commercial license agreement with RStudio, then
@@ -107,6 +107,7 @@ class ClientEvent extends JavaScriptObject
    public static final String RmdShinyDocStarted = "rmd_shiny_doc_started";
    public static final String RSConnectDeploymentOutput = "rsconnect_deployment_output";
    public static final String RSConnectDeploymentCompleted = "rsconnect_deployment_completed";
+   public static final String RSConnectDeploymentFailed = "rsconnect_deployment_failed";
    public static final String UserPrompt = "user_prompt";
    public static final String InstallRtools = "install_r_tools";
    public static final String InstallShiny = "install_shiny";

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -437,7 +437,6 @@
    public abstract AppCommand layoutConsoleOnRight();
    public abstract AppCommand paneLayout();
    public abstract AppCommand maximizeConsole();
-   public abstract AppCommand toggleEditorTokenInfo();
    
    public static final String KEYBINDINGS_PATH =
          "~/.R/keybindings/rstudio_commands.json";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -940,6 +940,7 @@ public void onResponseReceived(SourceDocument response)
             });
    }
    
+
    @Handler
    public void onNewSourceDoc()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -345,6 +345,4 @@ void highlightDebugLocation(
    
    void goToLineStart();
    void goToLineEnd();
-   
-   void toggleTokenInfo();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -437,7 +437,6 @@
    public abstract AppCommand layoutConsoleOnRight();
    public abstract AppCommand paneLayout();
    public abstract AppCommand maximizeConsole();
-   public abstract AppCommand toggleEditorTokenInfo();
    
    public static final String KEYBINDINGS_PATH =
          "~/.R/keybindings/rstudio_commands.json";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -940,6 +940,7 @@ public void onResponseReceived(SourceDocument response)
             });
    }
    
+
    @Handler
    public void onNewSourceDoc()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -345,6 +345,4 @@ void highlightDebugLocation(
    
    void goToLineStart();
    void goToLineEnd();
-   
-   void toggleTokenInfo();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -437,6 +437,7 @@
    public abstract AppCommand layoutConsoleOnRight();
    public abstract AppCommand paneLayout();
    public abstract AppCommand maximizeConsole();
+   public abstract AppCommand toggleEditorTokenInfo();
    
    public static final String KEYBINDINGS_PATH =
          "~/.R/keybindings/rstudio_commands.json";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -940,7 +940,6 @@ public void onResponseReceived(SourceDocument response)
             });
    }
    
-
    @Handler
    public void onNewSourceDoc()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -345,4 +345,6 @@ void highlightDebugLocation(
    
    void goToLineStart();
    void goToLineEnd();
+   
+   void toggleTokenInfo();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -437,6 +437,7 @@
    public abstract AppCommand layoutConsoleOnRight();
    public abstract AppCommand paneLayout();
    public abstract AppCommand maximizeConsole();
+   public abstract AppCommand toggleEditorTokenInfo();
    
    public static final String KEYBINDINGS_PATH =
          "~/.R/keybindings/rstudio_commands.json";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -940,7 +940,6 @@ public void onResponseReceived(SourceDocument response)
             });
    }
    
-
    @Handler
    public void onNewSourceDoc()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -345,4 +345,6 @@ void highlightDebugLocation(
    
    void goToLineStart();
    void goToLineEnd();
+   
+   void toggleTokenInfo();
 }

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -151,6 +151,7 @@ void externalSynctexView(String pdfFile,
    void setShinyDialogUrl(String url);
    
    boolean isOSXMavericks();
+   boolean isCentOS();
 
    String getScrollingCompensationType();
    

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/NewRSConnectLocalPage.java
Patch:
@@ -29,9 +29,8 @@ public class NewRSConnectLocalPage
 
    public NewRSConnectLocalPage()
    {
-      super("RStudio Connect", 
-            "A local service running inside your organization. Publish and " +
-            "collaborate privately and securely.",
+      super(RSConnectAccountWizard.SERVICE_NAME, 
+            RSConnectAccountWizard.SERVICE_DESCRIPTION,
             "RStudio Connect Account",
             RSConnectResources.INSTANCE.localAccountIcon(), 
             RSConnectResources.INSTANCE.localAccountIconLarge(),

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/DocumentOutlineWidget.java
Patch:
@@ -15,6 +15,7 @@
 package org.rstudio.studio.client.workbench.views.source;
 
 import org.rstudio.core.client.Counter;
+import org.rstudio.core.client.JsArrayUtil;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.theme.res.ThemeStyles;
@@ -382,7 +383,7 @@ private void setActiveWidget(Widget widget)
    
    private void rebuildScopeTree()
    {
-      scopeTree_ = target_.getDocDisplay().getScopeTree();
+      scopeTree_ = JsArrayUtil.copy(target_.getDocDisplay().getScopeTree());
       
       if (scopeTree_.length() == 0)
       {

File: src/gwt/src/org/rstudio/core/client/command/KeyboardHelper.java
Patch:
@@ -187,4 +187,6 @@ private static final native JavaScriptObject makeKeyNameToKeyCodeMap(JavaScriptO
    
    private static final JavaScriptObject KEY_NAME_TO_KEY_CODE_MAP =
          makeKeyNameToKeyCodeMap(KEY_CODE_TO_KEY_NAME_MAP);
+   
+   public static final int KEY_HYPHEN = BrowseCap.isFirefox() ? 173 : 189;
 }

File: src/gwt/src/org/rstudio/core/client/command/KeyboardShortcut.java
Patch:
@@ -181,11 +181,11 @@ public static KeySequence fromShortcutString(String shortcut)
             int keyCode = 0;
             if (sc.endsWith("-"))
             {
-               keyCode = '-';
+               keyCode = KeyboardHelper.KEY_HYPHEN;
             }
             else if (sc.endsWith("+"))
             {
-               keyCode = '+';
+               keyCode = 187;
             }
             else
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -460,8 +460,7 @@ public void onExecuteChunks(ExecuteChunksEvent event)
             
             TextEditingTarget target = (TextEditingTarget) activeEditor_;
             Position position =
-                  target.screenCoordinatesToDocumentPosition(
-                        event.getPageX(), event.getPageY());
+                  target.screenCoordinatesToDocumentPosition(0, event.getPageY());
             
             if (event.getScope() == ExecuteChunksEvent.Scope.Current)
                target.executeChunk(position);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceKeyboardActivityEvent.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * AceAfterCommandExecutedEvent.java
+ * AceKeyboardActivityEvent.java
  *
  * Copyright (C) 2009-12 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/core/client/command/KeyboardHelper.java
Patch:
@@ -15,7 +15,6 @@
 package org.rstudio.core.client.command;
 
 import org.rstudio.core.client.BrowseCap;
-
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.dom.client.NativeEvent;
 import com.google.gwt.event.dom.client.KeyCodes;
@@ -70,6 +69,7 @@ public static boolean isModifierKey(int keyCode)
       case KeyCodes.KEY_WIN_KEY_FF_LINUX:
       case KeyCodes.KEY_WIN_KEY_RIGHT:
       case KeyCodes.KEY_WIN_KEY_LEFT_META:
+      case 93: // Right meta key
          return true;
       default:
          return false;

File: src/gwt/src/org/rstudio/core/rebind/command/CommandBundleGenerator.java
Patch:
@@ -326,7 +326,6 @@ private void emitCommandInitializers(SourceWriter writer,
 
       setPropertyBool(writer, name, props.get(name), "visible");
       setPropertyBool(writer, name, props.get(name), "enabled");
-      setPropertyBool(writer, name, props.get(name), "preventShortcutWhenDisabled");
       setPropertyBool(writer, name, props.get(name), "checkable");
       setPropertyBool(writer, name, props.get(name), "checked");
       setPropertyBool(writer, name, props.get(name), "rebindable");

File: src/gwt/src/org/rstudio/core/rebind/command/ShortcutsEmitter.java
Patch:
@@ -262,7 +262,7 @@ private String toKey(String val)
          return "190";
       if (val.equals("="))
          return "187";
-      if (val.equals("<"))
+      if (val.equals(","))
          return "188";
       if (val.equals("-"))
          return "189";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -199,6 +199,9 @@ public final native void manageDefaultKeybindings() /*-{
       // We bind 'Ctrl + Shift + P' to run previous code on Windows
       delete this.commands.commandKeyBinding["ctrl-shift-p"];
       
+      // Don't bind 'Cmd+,'
+      delete this.commands.commandKeyBinding["cmd-,"];
+      
       // We bind 'Ctrl + Alt + A' to 'split into lines'
       if (this.commands.platform !== "mac")
          delete this.commands.commandKeyBinding["ctrl-alt-a"];

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -636,8 +636,7 @@ public void onBarrierReleased(BarrierReleasedEvent event)
                if (Desktop.isDesktop())
                {
                   if (Desktop.getFrame().isCocoa() && 
-                      switchToProject_ != null &&
-                      switchToProject_ != "none")
+                      switchToProject_ != null)
                   {
                      // on Cocoa there's an ugly intermittent crash that occurs 
                      // when we reload, so exit this instance and start a new

File: src/gwt/src/org/rstudio/studio/client/application/ApplicationQuit.java
Patch:
@@ -636,8 +636,7 @@ public void onBarrierReleased(BarrierReleasedEvent event)
                if (Desktop.isDesktop())
                {
                   if (Desktop.getFrame().isCocoa() && 
-                      switchToProject_ != null &&
-                      switchToProject_ != "none")
+                      switchToProject_ != null)
                   {
                      // on Cocoa there's an ugly intermittent crash that occurs 
                      // when we reload, so exit this instance and start a new

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -2752,7 +2752,8 @@ private void closeTabIndex(int idx, boolean closeDocument)
          }
       }
 
-      target.onDismiss();
+      target.onDismiss(closeDocument ? EditingTarget.DISMISS_TYPE_CLOSE :
+         EditingTarget.DISMISS_TYPE_MOVE);
       if (activeEditor_ == target)
       {
          activeEditor_.onDeactivate();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -581,7 +581,7 @@ public boolean onBeforeDismiss()
    }
 
    @Override
-   public void onDismiss()
+   public void onDismiss(int dismissType)
    {
       while (releaseOnDismiss_.size() > 0)
          releaseOnDismiss_.remove(0).removeHandler();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/profiler/ProfilerEditingTarget.java
Patch:
@@ -287,7 +287,7 @@ public void initialize(SourceDocument document,
       presenter_.attatch(doc_,  view_);
    }
    
-   public void onDismiss()
+   public void onDismiss(int dismissType)
    {  
       presenter_.detach();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2346,7 +2346,7 @@ else if ((fileType_.isRnw() || fileType_.isRmd()) &&
 
 
 
-   public void onDismiss()
+   public void onDismiss(int dismissType)
    {
       docUpdateSentinel_.stop();
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTarget.java
Patch:
@@ -311,7 +311,7 @@ public boolean onBeforeDismiss()
       return true;
    }
 
-   public void onDismiss()
+   public void onDismiss(int dismissType)
    {
       server_.removeContentUrl(getContentUrl(),
                                new ServerRequestCallback<org.rstudio.studio.client.server.Void>()

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -107,6 +107,7 @@ String promptForText(String title,
    public static final int PENDING_QUIT_RESTART_AND_RELOAD = 3;
    
    void setPendingQuit(int pendingQuit);
+   void setPendingProject(String projectFilePath);
    void launchSession(boolean reload);
    
    void openProjectInNewWindow(String projectFilePath);

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -125,9 +125,6 @@
    public abstract AppCommand renameInFile();
    public abstract AppCommand insertRoxygenSkeleton();
    public abstract AppCommand insertSnippet();
-   public abstract AppCommand yankBeforeCursor();
-   public abstract AppCommand yankAfterCursor();
-   public abstract AppCommand pasteLastYank();
  
    // Projects
    public abstract AppCommand newProject();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -21,6 +21,7 @@
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
 import com.google.inject.Provider;
+
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.core.client.widget.CanFocus;
 import org.rstudio.core.client.widget.SecondaryToolbar;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdTemplateData.java
Patch:
@@ -27,7 +27,7 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             format_name: "html_document",
             format_ui_name: "HTML",
             format_extension: "html",
-            format_options: [ "toc", "highlight", "theme", "css", "fig_width", 
+            format_options: [ "toc", "toc_depth", "highlight", "theme", "css", "fig_width", 
                               "fig_height", "fig_caption", "number_sections",
                               "smart", "self_contained", "keep_md" ],
             format_notes: "Recommended format for authoring (you can switch to PDF or Word output anytime)."
@@ -62,7 +62,8 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             option_name: "toc_depth",
             option_ui_name: "Depth of headers for table of contents", 
             option_type: "integer", 
-            option_default: "2"
+            option_transferable: true,
+            option_default: "3"
             },
             {
             option_name: "self_contained",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -2702,7 +2702,7 @@ public BackgroundTokenizer()
             @Override
             public void run()
             {
-              widget_.getEditor().retokenizeDocument(row_);
+              widget_.getEditor().tokenizeUpToRow(row_);
             }
          };
       }

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -1146,7 +1146,7 @@ private void showToolTip(Object object, String text)
       Element el = (Element) object;
       
       int index = StringUtil.parseInt(el.getAttribute("__rstudio_masked_index"), -1);
-      CommandBinding conflictBinding = dataProvider_.getList().get(index);
+      CommandBinding conflictBinding = originalBindings_.get(index);
       
       Element divEl = DOM.createDiv();
       Element spanEl = DOM.createSpan();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -2144,7 +2144,7 @@ String getCurrentCompletionToken()
          return "";
       
       // Exclude non-string and non-identifier tokens.
-      if (currentToken.hasType("operator", "comment", "numeric", "text"))
+      if (currentToken.hasType("operator", "comment", "numeric", "text", "punctuation"))
          return "";
       
       String tokenValue = currentToken.getValue();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -2144,7 +2144,7 @@ String getCurrentCompletionToken()
          return "";
       
       // Exclude non-string and non-identifier tokens.
-      if (currentToken.hasType("operator", "comment", "numeric"))
+      if (currentToken.hasType("operator", "comment", "numeric", "text"))
          return "";
       
       String tokenValue = currentToken.getValue();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -507,7 +507,7 @@ public PrefValue<Integer> preferredDocumentOutlineWidth()
    
    public PrefValue<Boolean> showDocumentOutlineRmd()
    {
-      return bool("show_document_outline_rmd", true);
+      return bool("show_doc_outline_rmd", false);
    }
    
    public PrefValue<Boolean> showUnnamedEntriesInDocumentOutline()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/Help.java
Patch:
@@ -258,13 +258,11 @@ void onOpenRoxygenQuickReference()
       events_.fireEvent(new ShowHelpEvent("help/doc/roxygen_help.html"));
    }
    
-   @Handler
    void onDebugHelp()
    {
       globalDisplay_.openRStudioLink("visual_debugger");
    }
    
-   @Handler
    void onMarkdownHelp()
    {
       events_.fireEvent(new ShowHelpEvent("help/doc/markdown_help.html")) ;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpTab.java
Patch:
@@ -37,6 +37,8 @@ public abstract static class Shim extends DelayLoadTabShim<Help, HelpTab>
                                                 ActivateHelpHandler
    {
       @Handler public abstract void onHelpHome();
+      @Handler public abstract void onDebugHelp();
+      @Handler public abstract void onMarkdownHelp();
       @Handler public abstract void onOpenDataVisualizationCheatSheet();
       @Handler public abstract void onOpenPackageDevelopmentCheatSheet();
       @Handler public abstract void onOpenDataWranglingCheatSheet();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkIconsManager.java
Patch:
@@ -129,8 +129,7 @@ private void manageChunkIcons(AceEditorNative editor)
       if (!shouldDisplayIcons(editor))
          return;
       
-      Element[] chunkStarts = DomUtils.getElementsByClassName(
-            "rstudio_chunk_start ace_start");
+      Element[] chunkStarts = DomUtils.getElementsByClassName("rstudio_chunk_start");
       
       for (int i = 0; i < chunkStarts.length; i++)
       {

File: src/gwt/src/org/rstudio/core/client/widget/ModifyKeyboardShortcutsWidget.java
Patch:
@@ -1047,8 +1047,8 @@ private void updateData(List<CommandBinding> bindings)
             
             boolean hasConflict =
                   ks1.equals(ks2) ||
-                  ks1.startsWith(ks2) ||
-                  ks2.startsWith(ks1);
+                  ks1.startsWith(ks2, true) ||
+                  ks2.startsWith(ks1, true);
             
             if (hasConflict)
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/EditSession.java
Patch:
@@ -214,8 +214,8 @@ public native final Marker getMarker(int id) /*-{
       return this.getMarkers(true)[id];
    }-*/;
    
-   public final native Range createAnchoredRange(Position start,
-                                                 Position end) /*-{
+   public final native AnchoredRange createAnchoredRange(Position start,
+                                                         Position end) /*-{
       var Range = $wnd.require("ace/range").Range;
       var result = new Range();
       result.start = this.doc.createAnchor(start.row, start.column);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionSignatureTip.java
Patch:
@@ -40,7 +40,7 @@ public CppCompletionSignatureTip(CppCompletion completion,
       start = Position.create(start.getRow(), start.getColumn() - 1);
       Position end = docDisplay_.getSelectionEnd();
       end = Position.create(end.getRow(), end.getColumn() + 1);
-      anchor_ = docDisplay_.createAnchoredSelection(start, end);
+      anchor_ = docDisplay_.createAnchoredSelection(this, start, end);
      
       // set the max width
       setMaxWidth(Window.getClientWidth() - 200);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -159,7 +159,6 @@ public void initialize(SourceDocument document,
       view_ = new CodeBrowserEditingTargetWidget(commands_,
                                                  globalDisplay_,
                                                  events_,
-                                                 prefs_, 
                                                  server_, 
                                                  docDisplay_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5299,7 +5299,7 @@ public boolean getPreferredOutlineWidgetVisibility()
    private final LintManager lintManager_;
    private final TextEditingTargetRenameHelper renameHelper_;
    private CollabEditStartParams queuedCollabParams_;
-
+   
    // Allows external edit checks to supercede one another
    private final Invalidation externalEditCheckInvalidation_ =
          new Invalidation();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/events/CodeBrowserFinishedEvent.java
Patch:
@@ -16,11 +16,13 @@
 package org.rstudio.studio.client.workbench.views.source.events;
 
 
+import org.rstudio.core.client.js.JavaScriptSerializable;
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
 import org.rstudio.studio.client.workbench.codesearch.model.SearchPathFunctionDefinition;
 
 import com.google.gwt.event.shared.GwtEvent;
 
+@JavaScriptSerializable
 public class CodeBrowserFinishedEvent extends 
              CrossWindowEvent<CodeBrowserFinishedHandler>
 {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -466,7 +466,9 @@ public void adaptToExtendedFileType(String extendedType)
 
    public void adaptToFileType(TextFileType fileType)
    {
-      editor_.clearMarkerLayer();
+      if (!fileType.equals(editor_.getFileType()))
+         editor_.clearMarkerLayer();
+      
       editor_.setFileType(fileType);
       boolean canCompilePdf = fileType.canCompilePDF();
       boolean canKnitToHTML = fileType.canKnitToHTML();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -287,6 +287,8 @@ void highlightDebugLocation(
    void toggleBreakpointAtCursor();
    boolean hasBreakpoints();
    
+   void clearMarkerLayer();
+   
    void setAnnotations(JsArray<AceAnnotation> annotations);
    void showLint(JsArray<LintItem> lint);
    void clearLint();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -466,6 +466,7 @@ public void adaptToExtendedFileType(String extendedType)
 
    public void adaptToFileType(TextFileType fileType)
    {
+      editor_.clearMarkerLayer();
       editor_.setFileType(fileType);
       boolean canCompilePdf = fileType.canCompilePDF();
       boolean canKnitToHTML = fileType.canKnitToHTML();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -216,7 +216,7 @@ public void setEnvironmentName(String environmentName, boolean local)
       environmentButton_.setLeftImage(imageOfEnvironment(environmentName, 
                                                          local));
       objects_.setEnvironmentName(friendlyEnvironmentName());
-      if (environmentName.equals("R_GlobalEnv"))
+      if (environmentName.equals(".GlobalEnv"))
          commands_.clearWorkspace().setEnabled(true); 
       else
          commands_.clearWorkspace().setEnabled(false);
@@ -430,7 +430,7 @@ private String friendlyEnvironmentName()
    
    private String friendlyNameOfEnvironment(String name)
    {
-      if (name.equals("R_GlobalEnv"))
+      if (name.equals(".GlobalEnv") || name.equals("R_GlobalEnv"))
          return GLOBAL_ENVIRONMENT_NAME;
       else if (name.equals("base"))
          return "package:base";
@@ -442,7 +442,7 @@ private ImageResource imageOfEnvironment(String name, boolean local)
    {
       if (name.endsWith("()"))
          return EnvironmentResources.INSTANCE.functionEnvironment();
-      else if (name.equals("R_GlobalEnv"))
+      else if (name.equals(".GlobalEnv") || name.equals("R_GlobalEnv"))
          return EnvironmentResources.INSTANCE.globalEnvironment();
       else if (name.startsWith("package:") ||
                name.equals("base") || 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -502,7 +502,7 @@ public PrefValue<RSConnectAccount> preferredPublishAccount()
    
    public PrefValue<Integer> preferredDocumentOutlineWidth()
    {
-      return integer("preferred_document_outline_width", 125);
+      return integer("preferred_document_outline_width", 110);
    }
    
    public PrefValue<Boolean> showDocumentOutlineRmd()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -154,6 +154,7 @@ public void onClick(ClickEvent event)
       rMarkdownLabel.getElement().getStyle().setPaddingTop(14, Unit.PX);
       displayPanel.add(rMarkdownLabel);
       displayPanel.add(checkboxPref("Show inline toolbar for R code chunks", prefs_.showInlineToolbarForRCodeChunks()));
+      displayPanel.add(checkboxPref("Show document outline by default", prefs_.showDocumentOutlineRmd()));
       displayPanel.add(checkboxPref("Show unnamed entries in document outline", prefs_.showUnnamedEntriesInDocumentOutline()));
       rmdViewerMode_ = new SelectWidget(
             "Show output preview in: ",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5254,7 +5254,7 @@ public boolean getPreferredOutlineWidgetVisibility()
    {
       String property = docUpdateSentinel_.getProperty("docOutlineVisible");
       return StringUtil.isNullOrEmpty(property)
-            ? false
+            ? (getTextFileType().isRmd() && prefs_.showDocumentOutlineRmd().getGlobalValue())
             : Integer.parseInt(property) > 0;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -154,7 +154,6 @@ public void onClick(ClickEvent event)
       rMarkdownLabel.getElement().getStyle().setPaddingTop(14, Unit.PX);
       displayPanel.add(rMarkdownLabel);
       displayPanel.add(checkboxPref("Show inline toolbar for R code chunks", prefs_.showInlineToolbarForRCodeChunks()));
-      displayPanel.add(checkboxPref("Show document outline by default", prefs_.showDocumentOutlineRmd()));
       displayPanel.add(checkboxPref("Show unnamed entries in document outline", prefs_.showUnnamedEntriesInDocumentOutline()));
       rmdViewerMode_ = new SelectWidget(
             "Show output preview in: ",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -5254,7 +5254,7 @@ public boolean getPreferredOutlineWidgetVisibility()
    {
       String property = docUpdateSentinel_.getProperty("docOutlineVisible");
       return StringUtil.isNullOrEmpty(property)
-            ? (getTextFileType().isRmd() && prefs_.showDocumentOutlineRmd().getGlobalValue())
+            ? false
             : Integer.parseInt(property) > 0;
    }
    

File: src/gwt/src/org/rstudio/core/client/command/KeyboardShortcut.java
Patch:
@@ -88,7 +88,7 @@ public String toString(boolean pretty)
             return ((modifiers_ & CTRL) == CTRL ? "Ctrl+" : "")
                   + ((modifiers_ & SHIFT) == SHIFT ? "Shift+" : "")
                   + ((modifiers_ & ALT) == ALT ? "Alt+" : "")
-                  + ((modifiers_ & META) == META ? "Cmd+" : "")
+                  + ((modifiers_ & META) == META ? "Meta+" : "")
                   + getKeyName(pretty);
          }
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/rmd/ChunkOutput.java
Patch:
@@ -18,6 +18,8 @@
 
 public class ChunkOutput extends JavaScriptObject
 {
+   public static final String LINE_WIDGET_TYPE = "ChunkOutput";
+   
    protected ChunkOutput()
    {
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindow.java
Patch:
@@ -62,7 +62,7 @@ public SourceWindow(
       
       // this class is for satellite source windows only; if an instance gets
       // created in the main window, don't hook up any of its behaviors
-      if (satellite.isCurrentWindowSatellite())
+      if (!satellite.isCurrentWindowSatellite())
          return;
       
       // add event handlers

File: src/gwt/src/org/rstudio/core/client/command/UserCommandManager.java
Patch:
@@ -143,5 +143,7 @@ public void loadBindings()
    
    // Injected ----
    private EventBus events_;
+   
+   @SuppressWarnings("unused")
    private FilesServerOperations files_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -2581,7 +2581,6 @@ private static final ExternalJavaScriptLoader getExtLanguageToolsLoader()
 
    private boolean popupVisible_;
 
-   @SuppressWarnings("unused")
    private final DiagnosticsBackgroundPopup diagnosticsBgPopup_;
 
    private long lastCursorChangedTime_;

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -40,6 +40,7 @@
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.satellite.Satellite;
+import org.rstudio.studio.client.workbench.views.source.SourceWindowManager;
 import org.rstudio.studio.client.workbench.views.source.events.DocTabDragStartedEvent;
 import org.rstudio.studio.client.workbench.views.source.events.DocTabDragStateChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.events.DocWindowChangedEvent;
@@ -965,8 +966,7 @@ public void onDragStart(DragStartEvent evt)
             {
                evt.getDataTransfer().setData(
                      getDataTransferFormat(), docId_ + "|" + 
-                  RStudioGinjector.INSTANCE.getSourceWindowManager()
-                                           .getSourceWindowId());
+                  SourceWindowManager.getSourceWindowId());
                JsObject dt = evt.getDataTransfer().cast();
                dt.setString("effectAllowed", "move");
                events_.fireEvent(new DocTabDragStartedEvent(docId_, 

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -40,7 +40,6 @@
 import org.rstudio.core.client.theme.WindowFrame;
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.widget.ToolbarButton;
-import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.ClientState;
@@ -53,6 +52,7 @@
 import org.rstudio.studio.client.workbench.views.output.find.FindOutputTab;
 import org.rstudio.studio.client.workbench.views.output.markers.MarkersOutputTab;
 import org.rstudio.studio.client.workbench.views.source.SourceShim;
+import org.rstudio.studio.client.workbench.views.source.SourceWindowManager;
 import org.rstudio.studio.client.workbench.views.source.model.SourceDocument;
 
 import java.util.ArrayList;
@@ -161,8 +161,7 @@ public PaneManager(Provider<MainSplitPanel> pSplitPanel,
       // count the number of source docs assigned to this window
       JsArray<SourceDocument> docs = 
             session_.getSessionInfo().getSourceDocuments();
-      String windowId = RStudioGinjector.INSTANCE.getSourceWindowManager()
-                                                 .getSourceWindowId();
+      String windowId = SourceWindowManager.getSourceWindowId();
       int numDocs = 0;
       for (int i = 0; i < docs.length(); i++)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -746,7 +746,7 @@ private void restoreDocuments(final Session session)
                      SourceWindowManager.SOURCE_WINDOW_ID);
          if (docWindowId == null)
             docWindowId = "";
-         String currentSourceWindowId = windowManager_.getSourceWindowId();
+         String currentSourceWindowId = SourceWindowManager.getSourceWindowId();
          
          // it belongs in this window if (a) it's assigned to it, or (b) this
          // is the main window, and the window it's assigned to isn't open.
@@ -1488,7 +1488,7 @@ public void execute()
    @Override
    public void onDocWindowChanged(final DocWindowChangedEvent e)
    {
-      if (e.getNewWindowId() == windowManager_.getSourceWindowId())
+      if (e.getNewWindowId() == SourceWindowManager.getSourceWindowId())
       {
          // if we're the adopting window, add the doc
          server_.getSourceDocument(e.getDocId(),
@@ -1509,7 +1509,7 @@ public void onError(ServerError error)
             }
          });
       }
-      else if (e.getOldWindowId() == windowManager_.getSourceWindowId())
+      else if (e.getOldWindowId() == SourceWindowManager.getSourceWindowId())
       {
          // cancel tab drag if it was occurring
          view_.cancelTabDrag();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindow.java
Patch:
@@ -52,7 +52,6 @@ public class SourceWindow implements LastSourceDocClosedHandler,
    public SourceWindow(
          Provider<DesktopHooks> pDesktopHooks,
          Satellite satellite,
-         SourceWindowManager windowManager,
          EventBus events,
          MacZoomHandler zoomHandler,
          SourceShim shim)
@@ -63,7 +62,7 @@ public SourceWindow(
       
       // this class is for satellite source windows only; if an instance gets
       // created in the main window, don't hook up any of its behaviors
-      if (windowManager.isMainSourceWindow())
+      if (satellite.isCurrentWindowSatellite())
          return;
       
       // add event handlers

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindowManager.java
Patch:
@@ -213,7 +213,7 @@ public String getDocId()
 
    // Public methods ----------------------------------------------------------
    
-   public String getSourceWindowId()
+   public static String getSourceWindowId()
    {
       return sourceWindowId(Window.Location.getParameter("view"));
    }
@@ -669,7 +669,7 @@ private String createSourceWindowId()
       return id;
    }
    
-   private String sourceWindowId(String input)
+   private static String sourceWindowId(String input)
    {
       if (input != null && input.startsWith(SourceSatellite.NAME_PREFIX))
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/events/DocWindowChangedEvent.java
Patch:
@@ -16,8 +16,8 @@
 package org.rstudio.studio.client.workbench.views.source.events;
 
 import org.rstudio.core.client.js.JavaScriptSerializable;
-import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
+import org.rstudio.studio.client.workbench.views.source.SourceWindowManager;
 
 import com.google.gwt.event.shared.EventHandler;
 import com.google.gwt.event.shared.GwtEvent;
@@ -45,8 +45,7 @@ public DocWindowChangedEvent(String docId, String oldWindowId, int pos)
    {
       docId_ = docId;
       oldWindowId_ = oldWindowId;
-      newWindowId_ = RStudioGinjector.INSTANCE.getSourceWindowManager()
-            .getSourceWindowId();
+      newWindowId_ = SourceWindowManager.getSourceWindowId();
       pos_ = pos;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/events/SourceDocAddedEvent.java
Patch:
@@ -15,8 +15,8 @@
 package org.rstudio.studio.client.workbench.views.source.events;
 
 import org.rstudio.core.client.js.JavaScriptSerializable;
-import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.CrossWindowEvent;
+import org.rstudio.studio.client.workbench.views.source.SourceWindowManager;
 import org.rstudio.studio.client.workbench.views.source.model.SourceDocument;
 
 import com.google.gwt.event.shared.EventHandler;
@@ -37,8 +37,7 @@ public SourceDocAddedEvent()
    public SourceDocAddedEvent(SourceDocument doc)
    {
       doc_ = doc;
-      windowId_ = RStudioGinjector.INSTANCE.getSourceWindowManager()
-                                           .getSourceWindowId();
+      windowId_ = SourceWindowManager.getSourceWindowId();
    }
 
    public SourceDocument getDoc()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1099,7 +1099,7 @@ private boolean beginSuggest(boolean flushCache,
          if (cursor.moveToPosition(input_.getCursorPosition()))
          {
             String token = "";
-            if (cursor.currentType() == "identifier")
+            if (cursor.hasType("identifier"))
                token = cursor.currentValue();
             
             String cursorPos = "left";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceWindow.java
Patch:
@@ -132,6 +132,7 @@ public void onLastSourceDocClosed(LastSourceDocClosedEvent event)
    {
       // if this is a source document window and its last document closed,
       // close the window itself
+      markReadyToClose();
       WindowEx.get().close();
    }
    
@@ -217,7 +218,6 @@ private JsArray<UnsavedChangesItem> getUnsavedChanges()
    
    private void closeSourceWindow()
    {
-      
       ApplicationQuit.QuitContext quitContext = 
             new ApplicationQuit.QuitContext()
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/snippets/SnippetHelper.java
Patch:
@@ -66,7 +66,8 @@ public SnippetHelper(AceEditor editor, String path)
          @Override
          public void onEditorLoaded(EditorLoadedEvent event)
          {
-            ensureSnippetsLoaded();
+            if (editor_.getFileType() != null)
+               ensureSnippetsLoaded();
          }
       });
    }

File: src/gwt/src/org/rstudio/core/client/command/ApplicationCommandManager.java
Patch:
@@ -37,6 +37,7 @@ public ApplicationCommandManager()
       
       bindings_ = new FileBacked<EditorKeyBindings>(
             KEYBINDINGS_PATH,
+            false,
             EditorKeyBindings.create());
       
       events_.addHandler(

File: src/gwt/src/org/rstudio/core/client/command/EditorCommandManager.java
Patch:
@@ -78,6 +78,7 @@ public EditorCommandManager()
       
       bindings_ = new FileBacked<EditorKeyBindings>(
             KEYBINDINGS_PATH,
+            false,
             EditorKeyBindings.create());
       
       events_.addHandler(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/model/FilesServerOperations.java
Patch:
@@ -90,5 +90,6 @@ void writeJSON(String path,
                   ServerRequestCallback<Boolean> requestCallback);
    
    void readJSON(String path,
+                 boolean logErrorIfNotFound,
                  ServerRequestCallback<JavaScriptObject> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/snippets/SnippetHelper.java
Patch:
@@ -88,7 +88,6 @@ private static final native SnippetManager getSnippetManager() /*-{
    
    public ArrayList<String> getAvailableSnippets()
    {
-      ensureSnippetsLoaded();
       return JsArrayUtil.fromJsArrayString(
             getAvailableSnippetsImpl(manager_, getActiveMode()));
    }
@@ -178,7 +177,8 @@ private static final native void ensureSnippetsLoadedImpl(
             
          manager.files[id] = m;
          if (!m.snippets && m.snippetText)
-         m.snippets = manager.parseSnippetFile(m.snippetText);
+            m.snippets = manager.parseSnippetFile(m.snippetText);
+            
          manager.register(m.snippets || [], m.scope);
       }
       

File: src/gwt/src/org/rstudio/core/client/command/ApplicationCommandManager.java
Patch:
@@ -15,7 +15,6 @@
 package org.rstudio.core.client.command;
 
 import org.rstudio.core.client.CommandWithArg;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.command.EditorCommandManager.EditorKeyBindings;
 import org.rstudio.core.client.command.KeyboardShortcut.KeySequence;
 import org.rstudio.core.client.files.FileBacked;
@@ -91,7 +90,7 @@ public void execute(EditorKeyBindings bindings)
                AppCommand command = commands_.getCommandById(commandId);
                if (command == null)
                {
-                  Debug.log("Failed to locate command with id '" + commandId + "'");
+                  // TODO: How should mis-named commands be reported?
                   continue;
                }
                

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -126,6 +126,7 @@ class ClientEvent extends JavaScriptObject
    public static final String RVersionsChanged = "r_versions_changed";
    public static final String RmdParamsEdit = "rmd_params_edit";
    public static final String RmdParamsReady = "rmd_params_ready";
+   public static final String RegisterUserCommand = "register_user_command";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdParamsEditDialog.java
Patch:
@@ -38,7 +38,7 @@ protected Widget createMainWidget()
       frame_ = new RStudioFrame();
       
       // compute the widget size and set it
-      Size size = new Size(500, 400);
+      Size size = new Size(400, 300);
       Size minimumSize = new Size(300, 250);
       size = DomMetrics.adjustedElementSize(size, 
                                             minimumSize, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceSatellite.java
Patch:
@@ -26,6 +26,8 @@
 
 public class SourceSatellite extends SatelliteApplication
 {
+   // note that there's special behavior attached to this name in the desktop
+   // frame 
    public static final String NAME_PREFIX = "source_window_";
    
    public SourceSatellite(String name)

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/CppFileType.java
Patch:
@@ -70,7 +70,6 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
          result.add(commands.reflowComment());
          result.add(commands.sourceActiveDocument());
          result.add(commands.sourceActiveDocumentWithEcho());
-         result.add(commands.rcppHelp());
       }
       result.add(commands.goToFunctionDefinition());
       result.add(commands.codeCompletion());

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -322,7 +322,6 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       }
       if (canKnitToHTML())
       {
-         results.add(commands.usingRMarkdownHelp());
          results.add(commands.editRmdFormatOptions());
       }
       if (canKnitToHTML() || canCompileNotebook())

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -63,7 +63,6 @@
    public abstract AppCommand executeCurrentChunk();
    public abstract AppCommand executeNextChunk();
    public abstract AppCommand goToHelp();
-   public abstract AppCommand rcppHelp();
    public abstract AppCommand goToFunctionDefinition();
    public abstract AppCommand sourceNavigateBack();
    public abstract AppCommand sourceNavigateForward();
@@ -75,8 +74,6 @@
    public abstract AppCommand openRMarkdownReferenceGuide();
    public abstract AppCommand openShinyCheatSheet();
    public abstract AppCommand openRoxygenQuickReference();
-   public abstract AppCommand usingRMarkdownHelp();
-   public abstract AppCommand authoringRPresentationsHelp();
    public abstract AppCommand knitDocument();
    public abstract AppCommand previewHTML();
    public abstract AppCommand publishHTML();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpTab.java
Patch:
@@ -44,8 +44,6 @@ public abstract static class Shim extends DelayLoadTabShim<Help, HelpTab>
       @Handler public abstract void onOpenRMarkdownReferenceGuide();
       @Handler public abstract void onOpenShinyCheatSheet();
       @Handler public abstract void onOpenRoxygenQuickReference();
-      @Handler public abstract void onAuthoringRPresentationsHelp();
-      @Handler public abstract void onMarkdownHelp();
       
       public abstract void bringToFront();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -264,8 +264,6 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.executeNextChunk());
       dynamicCommands_.add(commands.sourceActiveDocument());
       dynamicCommands_.add(commands.sourceActiveDocumentWithEcho());
-      dynamicCommands_.add(commands.usingRMarkdownHelp());
-      dynamicCommands_.add(commands.authoringRPresentationsHelp());
       dynamicCommands_.add(commands.knitDocument());
       dynamicCommands_.add(commands.previewHTML());
       dynamicCommands_.add(commands.compilePDF());
@@ -293,7 +291,6 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.checkSpelling());
       dynamicCommands_.add(commands.codeCompletion());
       dynamicCommands_.add(commands.findUsages());
-      dynamicCommands_.add(commands.rcppHelp());
       dynamicCommands_.add(commands.debugBreakpoint());
       dynamicCommands_.add(commands.vcsViewOnGitHub());
       dynamicCommands_.add(commands.vcsBlameOnGitHub());

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -498,7 +498,7 @@ public PrefValue<Boolean> showDocumentOutlineRmd()
    
    public PrefValue<Boolean> showUnnamedEntriesInDocumentOutline()
    {
-      return bool("show_unnamed_entries_in_document_outline", false);
+      return bool("show_unnamed_chunks_in_document_outline", true);
    }
    
    public PrefValue<Boolean> enableSourceWindows()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -498,7 +498,7 @@ public PrefValue<Boolean> showDocumentOutlineRmd()
    
    public PrefValue<Boolean> showUnnamedEntriesInDocumentOutline()
    {
-      return bool("show_unnamed_entries_in_document_outline", false);
+      return bool("show_unnamed_chunks_in_document_outline", true);
    }
    
    public PrefValue<Boolean> enableSourceWindows()

File: src/gwt/src/org/rstudio/core/client/StringUtil.java
Patch:
@@ -31,7 +31,6 @@
 import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
-import java.util.Set;
 
 public class StringUtil
 {

File: src/gwt/src/org/rstudio/studio/client/common/codetools/CodeToolsServerOperations.java
Patch:
@@ -22,7 +22,6 @@
 import org.rstudio.studio.client.workbench.views.help.model.HelpServerOperations;
 import org.rstudio.studio.client.workbench.views.source.model.CppServerOperations;
 
-import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArrayString;
 
 public interface CodeToolsServerOperations extends HelpServerOperations,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/SetupChunkOptionsPopupPanel.java
Patch:
@@ -16,7 +16,6 @@
 
 import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.ui.HTML;
 import com.google.gwt.user.client.ui.TextBox;
 import com.google.inject.Inject;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3679,7 +3679,7 @@ public void onResponseReceived(Void response)
                         "UTF-8",
                         activeCodeIsAscii(),
                         forceEcho ? true : echo,
-                        true,
+                        prefs_.focusConsoleAfterExec().getValue(),
                         docDisplay_.hasBreakpoints()); 
                }
             });
@@ -3700,7 +3700,7 @@ public void execute()
                            docUpdateSentinel_.getEncoding(),
                            activeCodeIsAscii(),
                            forceEcho ? true : echo,
-                           true,
+                           prefs_.focusConsoleAfterExec().getValue(),
                            docDisplay_.hasBreakpoints());   
                   }
                };

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -539,6 +539,8 @@ public void adaptToFileType(TextFileType fileType)
       
       // set the content type based on the extended type
       setPublishPath(extendedType_, publishPath_);
+      toggleDocOutlineButton_.setVisible(
+            target_.getDocDisplay().hasScopeTree());
       
       toolbar_.invalidateSeparators();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkIconsManager.java
Patch:
@@ -14,7 +14,6 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.theme.res.ThemeStyles;
@@ -114,7 +113,6 @@ private boolean isSetupChunk(Element el, AceEditorNative editor)
             editor.getRenderer().screenToTextCoordinates(pageX, pageY);
       
       String line = editor.getSession().getLine(position.getRow());
-      Debug.logObject(line);
       
       return line.contains("r setup");
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -2333,8 +2333,6 @@ public boolean isPositionVisible(Position position)
       return widget_.getEditor().isRowFullyVisible(position.getRow());
    }
 
-   public void beginCollabSession(String serverUrl)
-   
    @Override
    public void beginCollabSession(CollabEditStartParams params, 
          DirtyState dirtyState)

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishButton.java
Patch:
@@ -107,6 +107,7 @@ public void onClick(ClickEvent arg0)
       // compute initial visible state
       applyVisiblity();
       applyCaption("Publish");
+      setPreviousDeployments(null);
    }
    
    private void onPublishButtonClick()

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -658,7 +658,7 @@ else if (type.equals(ClientEvent.CollabEditStarted))
          }
          else if (type.equals(ClientEvent.SessionCountChanged))
          {
-            int count = event.getData();
+            Integer count = event.getData();
             eventBus_.fireEvent(new SessionCountChangedEvent(count));
          }
          else

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcError.java
Patch:
@@ -57,6 +57,7 @@ protected RpcError()
    public final static int METHOD_UNEXEPECTED = 11 ;
    public final static int INVALID_CLIENT_VERSION = 12;
    public final static int SERVER_OFFLINE = 13;
+   public final static int INVALID_SESSION = 14;
    
    // execution error (method was executed and returned known error state)
    public final static int EXECUTION_ERROR = 100;

File: src/gwt/src/org/rstudio/studio/client/application/events/ApplicationEventHandlers.java
Patch:
@@ -24,6 +24,7 @@ public interface ApplicationEventHandlers extends LogoutRequestedHandler,
                                                   ServerUnavailableHandler,
                                                   ClientDisconnectedHandler,
                                                   InvalidClientVersionHandler,
-                                                  ServerOfflineHandler
+                                                  ServerOfflineHandler,
+                                                  InvalidSessionEvent.Handler
 {
 }

File: src/gwt/src/org/rstudio/core/client/widget/TriStateCheckBox.java
Patch:
@@ -93,11 +93,11 @@ else if (state == STATE_ON)
    private void toggleState()
    {
       if (state_ == STATE_OFF)
-         setState(STATE_INDETERMINATE);
-      else if (state_ == STATE_INDETERMINATE)
          setState(STATE_ON);
-      else if (state_ == STATE_ON)
+      else if (state_ == STATE_INDETERMINATE)
          setState(STATE_OFF);
+      else if (state_ == STATE_ON)
+         setState(STATE_INDETERMINATE);
       
       ValueChangeEvent.fire(this, state_);
    }

File: src/gwt/src/org/rstudio/core/client/RegexUtil.java
Patch:
@@ -72,7 +72,7 @@ private static final String constructSyntacticRIdentifierRegex()
          Pattern.create("^\\s*```\\s*$", "");
    
    public static final Pattern RE_RHTML_CHUNK_BEGIN =
-         Pattern.create("^\\s*<!-{2,}\\s*begin\\.rcode\\s+(.*?)\\s*$", "");
+         Pattern.create("^\\s*<!-{2,}\\s*(.*?)\\s*$", "");
    
    public static final Pattern RE_RHTML_CHUNK_END =
          Pattern.create("end\\.rcode\\s*-{2,}\\>", "");

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -418,7 +418,7 @@ public boolean previewKeyDown(NativeEvent event)
          else if (event.getKeyCode() == KeyCodes.KEY_TAB &&
                   modifier == KeyboardShortcut.SHIFT)
          {
-            return snippets_.attemptSnippetInsertion();
+            return snippets_.attemptSnippetInsertion(true);
          }
          else if (keycode == 112 // F1
                   && modifier == KeyboardShortcut.NONE)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionManager.java
Patch:
@@ -200,7 +200,7 @@ public boolean previewKeyDown(NativeEvent event)
          else if (event.getKeyCode() == KeyCodes.KEY_TAB &&
                   modifier == KeyboardShortcut.SHIFT)
          {
-            return snippets_.attemptSnippetInsertion();
+            return snippets_.attemptSnippetInsertion(true);
          }
          else if (event.getKeyCode() == 112 // F1
                   && modifier == KeyboardShortcut.NONE)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -418,7 +418,7 @@ public boolean previewKeyDown(NativeEvent event)
          else if (event.getKeyCode() == KeyCodes.KEY_TAB &&
                   modifier == KeyboardShortcut.SHIFT)
          {
-            return snippets_.attemptSnippetInsertion();
+            return snippets_.attemptSnippetInsertion(true);
          }
          else if (keycode == 112 // F1
                   && modifier == KeyboardShortcut.NONE)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionManager.java
Patch:
@@ -200,7 +200,7 @@ public boolean previewKeyDown(NativeEvent event)
          else if (event.getKeyCode() == KeyCodes.KEY_TAB &&
                   modifier == KeyboardShortcut.SHIFT)
          {
-            return snippets_.attemptSnippetInsertion();
+            return snippets_.attemptSnippetInsertion(true);
          }
          else if (event.getKeyCode() == 112 // F1
                   && modifier == KeyboardShortcut.NONE)

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompileOutputBufferWithHighlight.java
Patch:
@@ -82,9 +82,7 @@ public void clear()
    
    private void write(String output, String className)
    {
-      console_.submit(output, className);
-      output_.getElement().setInnerSafeHtml(console_.toSafeHtml());
-
+      console_.submitAndRender(output, className, output_.getElement());
       scrollPanel_.onContentSizeChanged();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/Packages.java
Patch:
@@ -350,6 +350,8 @@ public void execute(PackageInstallRequest request)
                   // append type if needed
                   if (path.endsWith(".tar.gz"))
                      command.append(", type = \"source\"");
+                  else if (path.endsWith(".zip"))
+                     command.append(", type = \"win.binary\"");
                   else if (path.endsWith(".tgz"))
                      command.append(", type = .Platform$pkgType");
                }

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyApplicationPanel.java
Patch:
@@ -66,7 +66,7 @@ protected void initToolbar(Toolbar toolbar, Commands commands)
       toolbar.addLeftWidget(refreshButton);
       
       publishButton_ = new RSConnectPublishButton(
-            RSConnect.CONTENT_TYPE_APP, true, null);
+            RSConnect.CONTENT_TYPE_NONE, true, null);
       toolbar.addRightWidget(publishButton_);
    }
    
@@ -75,6 +75,7 @@ public void showApp(ShinyApplicationParams params)
    {
       appParams_ = params;
       publishButton_.setContentPath(params.getPath(), "");
+      publishButton_.setContentType(RSConnect.CONTENT_TYPE_APP);
          
       String url = params.getUrl();
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/Packages.java
Patch:
@@ -347,9 +347,11 @@ public void execute(PackageInstallRequest request)
                   // append command
                   command.append("\"" + path + "\", repos = NULL");
                   
-                  // append type = source if needed
+                  // append type if needed
                   if (path.endsWith(".tar.gz"))
                      command.append(", type = \"source\"");
+                  else if (path.endsWith(".tgz"))
+                     command.append(", type = .Platform$pkgType");
                }
                
                if (!usingDefaultLibrary)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionToolTip.java
Patch:
@@ -46,7 +46,6 @@ public CppCompletionToolTip(CppCompletionText text)
    public CppCompletionToolTip(String text, String comment)
    {
       super(true);
-      
       CppCompletionResources.Styles styles = 
                               CppCompletionResources.INSTANCE.styles();
       

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -350,6 +350,7 @@ public final native boolean exists() /*-{
       MIME_TYPES.put( "sh",        "text/x-shell" );
       MIME_TYPES.put( "sql",       "text/x-sql" );
       MIME_TYPES.put( "stan",      "text/x-stan" );
+      MIME_TYPES.put( "clj",       "text/x-clojure");
 
       // other types we are likely to serve
       MIME_TYPES.put( "xml",   "text/xml" );

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -159,7 +159,7 @@ public class FileTypeRegistry
    public static final TextFileType CPP = new CppFileType("cpp", ".cpp", ICONS.iconCpp(), true, true);
    
    public static final TextFileType CLOJURE = 
-         new TextFileType("clojure", "Clojure", EditorLanguage.LANG_CLOJURE, ".clojure", ICONS.iconClojure(),
+         new TextFileType("clojure", "Clojure", EditorLanguage.LANG_CLOJURE, ".clj", ICONS.iconClojure(),
                false, false, false, false, false,
                false, false, false, false, false, false, false, false);
    
@@ -359,6 +359,8 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.xml", XML, icons.iconXml());
       register("*.stan", STAN, icons.iconStan());
       
+      register("*.clj", CLOJURE, icons.iconClojure());
+      register("*.cloj", CLOJURE, icons.iconClojure());
       register("*.clojure", CLOJURE, icons.iconClojure());
       register("*.coffee", COFFEE, icons.iconCoffee());
       register("*.cs", CSHARP, icons.iconCsharp());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -3491,7 +3491,7 @@ private void sourceActiveDocument(final boolean echo)
          // then you don't see any of the output
          
          boolean saveWhenSourcing = fileType_.isCpp() || 
-               docDisplay_.hasBreakpoints() || (prefs_.saveBeforeSourcing().getValue() && (getPath() != null));
+               docDisplay_.hasBreakpoints() || (prefs_.saveBeforeSourcing().getValue() && (getPath() != null) && !sweave);
          
          if ((dirtyState_.getValue() || sweave) && !saveWhenSourcing)
          {

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -95,6 +95,7 @@ String promptForText(String title,
    boolean canChooseRVersion();
 
    double devicePixelRatio();
+   int getDisplayDpi();
    
    void cleanClipboard();
    

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -204,17 +204,17 @@ public PrefValue<Boolean> diagnosticsInRFunctionCalls()
    
    public PrefValue<Boolean> checkArgumentsToRFunctionCalls()
    {
-      return bool("check_arguments_to_r_function_calls", true);
+      return bool("check_arguments_to_r_function_calls", false);
    }
    
    public PrefValue<Boolean> warnIfNoSuchVariableInScope()
    {
-      return bool("warn_if_no_such_variable_in_scope", true);
+      return bool("warn_if_no_such_variable_in_scope", false);
    }
    
    public PrefValue<Boolean> warnIfVariableDefinedButNotUsed()
    {
-      return bool("warn_if_variable_defined_but_not_used", true);
+      return bool("warn_if_variable_defined_but_not_used", false);
    }
    
    public PrefValue<Boolean> autoAppendNewline()

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishButton.java
Patch:
@@ -352,6 +352,7 @@ private void setPreviousDeployments(JsArray<RSConnectDeploymentRecord> recs)
    {
       // clear existing deployment menu, if any
       publishMenu_.clearItems();
+      defaultRec_ = null;
 
       // if there are existing deployments, make the UI reflect that this is a
       // republish

File: src/gwt/src/org/rstudio/core/client/widget/Wizard.java
Patch:
@@ -339,7 +339,7 @@ public void execute()
             
             // let wizard and page know that the new page is active
             onPageActivated(page, okButtonVisible);
-            page.onActivate();
+            page.onActivate(getProgressIndicator());
             
             // set focus
             FocusHelper.setFocusDeferred(page);

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -613,9 +613,6 @@ private void initializeWorkbench()
       if (!SessionUtils.showExternalPublishUi(session_, uiPrefs_.get()))
       {
          commands_.publishHTML().remove();
-         commands_.publishPlotToRPubs().remove();
-         commands_.presentationPublishToRpubs().remove();
-         commands_.viewerPublishToRPubs().remove();
       } 
       
       // hide the agreement menu item if we don't have one

File: src/gwt/src/org/rstudio/studio/client/common/rpubs/model/RPubsServerOperations.java
Patch:
@@ -24,7 +24,9 @@ void rpubsIsPublished(String htmlFile,
 
    void rpubsUpload(String contextId,
                     String title, 
+                    String rmdFile,
                     String htmlFile,
+                    String uploadId,
                     boolean isUpdate,
                     ServerRequestCallback<Boolean> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentCompletedEvent.java
Patch:
@@ -12,7 +12,7 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
-package org.rstudio.studio.client.shiny.events;
+package org.rstudio.studio.client.rsconnect.events;
 
 import com.google.gwt.event.shared.EventHandler;
 import com.google.gwt.event.shared.GwtEvent;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/events/RSConnectDeploymentOutputEvent.java
Patch:
@@ -12,7 +12,7 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
-package org.rstudio.studio.client.shiny.events;
+package org.rstudio.studio.client.rsconnect.events;
 
 import org.rstudio.studio.client.common.compile.CompileOutput;
 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectAccount.java
Patch:
@@ -47,7 +47,9 @@ public final boolean isCloudAccount()
 
    public final boolean equals(RSConnectAccount other)
    {
-      return getName().equals(other.getName()) && 
+      if (other == null)
+         return false;
+      else return getName().equals(other.getName()) && 
              getServer().equals(other.getServer());
    }
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/NewRSConnectCloudPage.java
Patch:
@@ -31,8 +31,8 @@ public NewRSConnectCloudPage()
             "A cloud service run by RStudio. Publish Shiny applications " +
             "and interactive documents to the Internet.",
             "Connect ShinyApps.io Account",
-            RSConnectAccountResources.INSTANCE.cloudAccountIcon(), 
-            RSConnectAccountResources.INSTANCE.cloudAccountIconLarge());
+            RSConnectResources.INSTANCE.cloudAccountIcon(), 
+            RSConnectResources.INSTANCE.cloudAccountIconLarge());
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/NewRSConnectLocalPage.java
Patch:
@@ -39,8 +39,8 @@ public NewRSConnectLocalPage()
             "A local service running inside your organization. Publish and " +
             "collaborate privately and securely.",
             "RStudio Connect Account",
-            RSConnectAccountResources.INSTANCE.localAccountIcon(), 
-            RSConnectAccountResources.INSTANCE.localAccountIconLarge(),
+            RSConnectResources.INSTANCE.localAccountIcon(), 
+            RSConnectResources.INSTANCE.localAccountIconLarge(),
             new NewRSConnectAuthPage());
    }
 

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectAccountWizard.java
Patch:
@@ -50,8 +50,8 @@ NewRSConnectAccountResult> createIntroPage(
    {
       return new NewRSConnectAccountPage("Connect Publishing Account", 
             "Pick an account", "Connect Publishing Account", 
-            RSConnectAccountResources.INSTANCE.publishIcon(),
-            RSConnectAccountResources.INSTANCE.publishIconLarge(),
+            RSConnectResources.INSTANCE.publishIcon(),
+            RSConnectResources.INSTANCE.publishIconLarge(),
             createSelectorPage(showCloudPage));
    }
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -64,10 +64,10 @@
 import org.rstudio.studio.client.rmarkdown.model.RmdRenderResult;
 import org.rstudio.studio.client.rmarkdown.model.RmdShinyDocInfo;
 import org.rstudio.studio.client.rsconnect.events.EnableRStudioConnectUIEvent;
+import org.rstudio.studio.client.rsconnect.events.RSConnectDeploymentCompletedEvent;
+import org.rstudio.studio.client.rsconnect.events.RSConnectDeploymentOutputEvent;
 import org.rstudio.studio.client.server.Bool;
 import org.rstudio.studio.client.shiny.events.ShinyApplicationStatusEvent;
-import org.rstudio.studio.client.shiny.events.RSConnectDeploymentCompletedEvent;
-import org.rstudio.studio.client.shiny.events.RSConnectDeploymentOutputEvent;
 import org.rstudio.studio.client.shiny.model.ShinyApplicationParams;
 import org.rstudio.studio.client.workbench.codesearch.model.SearchPathFunctionDefinition;
 import org.rstudio.studio.client.workbench.events.*;

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplicationPresenter.java
Patch:
@@ -23,7 +23,6 @@
 import org.rstudio.studio.client.shiny.events.ShinyApplicationStatusEvent;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.Session;
-import org.rstudio.studio.client.workbench.model.SessionUtils;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 
 import com.google.gwt.core.client.JavaScriptObject;
@@ -45,7 +44,7 @@ public interface Display extends IsWidget
       String getDocumentTitle();
       String getUrl();
       String getAbsoluteUrl();
-      void showApp(ShinyApplicationParams params, boolean showDeploy);
+      void showApp(ShinyApplicationParams params);
       void reloadApp();
    }
    
@@ -115,7 +114,7 @@ public void onViewerPopout()
    public void loadApp(ShinyApplicationParams params) 
    {
       params_ = params;
-      view_.showApp(params, SessionUtils.showPublishUi(session_, prefs_));
+      view_.showApp(params);
    }
    
    private native void initializeEvents() /*-{  

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -187,7 +187,6 @@
    public abstract AppCommand presentationEdit();
    public abstract AppCommand presentationViewInBrowser();
    public abstract AppCommand presentationSaveAsStandalone();
-   public abstract AppCommand presentationPublishToRpubs();
    public abstract AppCommand activatePresentation();
    public abstract AppCommand tutorialFeedback();
    public abstract AppCommand clearPresentationCache();
@@ -239,7 +238,6 @@
    public abstract AppCommand savePlotAsImage();
    public abstract AppCommand savePlotAsPdf();
    public abstract AppCommand copyPlotToClipboard();
-   public abstract AppCommand publishPlotToRPubs();
    public abstract AppCommand zoomPlot();
    public abstract AppCommand removePlot();
    public abstract AppCommand clearPlots();
@@ -310,7 +308,6 @@
    public abstract AppCommand viewerSaveAsImage();
    public abstract AppCommand viewerSaveAsWebPage();
    public abstract AppCommand viewerCopyToClipboard();
-   public abstract AppCommand viewerPublishToRPubs();
 
    // Application
    public abstract AppCommand quitSession();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PublishingPreferencesPane.java
Patch:
@@ -66,7 +66,8 @@ public PublishingPreferencesPane(GlobalDisplay globalDisplay,
       
       accountPanel.add(accountLabel);
       
-      accountList_ = new RSConnectAccountList(server, globalDisplay, true);
+      accountList_ = new RSConnectAccountList(server, globalDisplay, true, 
+            true);
       accountList_.setHeight("200px");
       accountList_.setWidth("300px");
       accountList_.getElement().getStyle().setMarginBottom(15, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/rsconnectdeploy/RSConnectDeployOutputTab.java
Patch:
@@ -21,9 +21,9 @@
 import org.rstudio.core.client.widget.model.ProvidesBusy;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.RestartStatusEvent;
+import org.rstudio.studio.client.rsconnect.events.RSConnectDeploymentCompletedEvent;
+import org.rstudio.studio.client.rsconnect.events.RSConnectDeploymentOutputEvent;
 import org.rstudio.studio.client.rsconnect.events.RSConnectDeploymentStartedEvent;
-import org.rstudio.studio.client.shiny.events.RSConnectDeploymentCompletedEvent;
-import org.rstudio.studio.client.shiny.events.RSConnectDeploymentOutputEvent;
 import org.rstudio.studio.client.workbench.events.BusyHandler;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.ui.DelayLoadTabShim;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationTab.java
Patch:
@@ -67,7 +67,6 @@ public void onSessionInit(SessionInitEvent sie)
                commands.clearPresentationCache().remove();
                commands.presentationViewInBrowser().remove();
                commands.presentationSaveAsStandalone().remove();
-               commands.presentationPublishToRpubs().remove();
             }
             else
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerTab.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.ui.DelayLoadTabShim;
 import org.rstudio.studio.client.workbench.ui.DelayLoadWorkbenchTab;
+import org.rstudio.studio.client.workbench.views.viewer.events.ViewerClearedEvent;
 import org.rstudio.studio.client.workbench.views.viewer.events.ViewerNavigateEvent;
 import org.rstudio.studio.client.workbench.views.viewer.events.ViewerPreviewRmdEvent;
 
@@ -28,6 +29,7 @@ public abstract static class Shim
         extends DelayLoadTabShim<ViewerPresenter, ViewerTab>
         implements ViewerNavigateEvent.Handler,
                    ViewerPreviewRmdEvent.Handler,
+                   ViewerClearedEvent.Handler,
                    ShinyApplicationStatusEvent.Handler {}
 
    @Inject
@@ -38,6 +40,7 @@ public ViewerTab(Shim shim, Session session, EventBus eventBus)
       
       eventBus.addHandler(ViewerNavigateEvent.TYPE, shim);
       eventBus.addHandler(ViewerPreviewRmdEvent.TYPE, shim);
+      eventBus.addHandler(ViewerClearedEvent.TYPE, shim);
       eventBus.addHandler(ShinyApplicationStatusEvent.TYPE, shim);
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -338,6 +338,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.bib", TEXT, icons.iconText());
       register("*.c", C, icons.iconC());
       register("*.cpp", CPP, icons.iconCpp());
+      register("*.cc", CPP, icons.iconCpp());
       register("*.h", H, icons.iconH());
       register("*.hpp", HPP, icons.iconHpp());
       register("*.f", TEXT, icons.iconText());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -94,8 +94,7 @@ protected Toolbar createMainToolbar()
      
       // add publish button 
       publishButton_ = new RSConnectPublishButton(
-            RSConnect.CONTENT_TYPE_DOCUMENT, true, 
-            commands_.viewerSaveAsWebPage());
+            RSConnect.CONTENT_TYPE_DOCUMENT, true, null);
       toolbar_.addRightWidget(publishButton_);
 
       // create an HTML generator 
@@ -163,6 +162,7 @@ public void navigate(String url)
    public void previewRmd(RmdPreviewParams params)
    {
       navigate(params.getOutputUrl(), true);
+      publishButton_.setManuallyHidden(false);
       publishButton_.setContentType(RSConnect.CONTENT_TYPE_DOCUMENT);
       publishButton_.setRmdPreview(params);
       rmdPreviewParams_ = params;
@@ -174,6 +174,7 @@ public void setExportEnabled(boolean exportEnabled)
    {
       exportButton_.setVisible(exportEnabled);
       exportButtonSeparator_.setVisible(exportEnabled);
+      publishButton_.setManuallyHidden(!exportEnabled);
       toolbar_.invalidateSeparators();
    }
    

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -324,6 +324,7 @@ private void publishAsFiles(RSConnectActionEvent event,
    {
       RSConnectDeployDialog dialog = 
             new RSConnectDeployDialog(
+                      event.getContentType(),
                       server_, this, display_, 
                       source,
                       event.getFromPrevious());

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectPublishSource.java
Patch:
@@ -79,7 +79,7 @@ public boolean isSourceExt(String ext)
    public boolean isDocument()
    {
       return isSourceExt("rmd") || isSourceExt("md") || isSourceExt("html") ||
-             isSourceExt("htm");
+             isSourceExt("htm") || isSourceExt("rpres");
    }
    
    public String getDeployKey()

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -3666,7 +3666,7 @@ public void publishContent(
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(source.getDeployDir()));
       params.set(1, JSONUtils.toJSONStringArray(settings.getDeployFiles()));
-      params.set(2, new JSONString(source.getDeployFileName()));
+      params.set(2, new JSONString(source.isDocument() ? source.getDeployFileName() : ""));
       params.set(3, new JSONString(source.isDocument() ? source.getSourceFile() : ""));
       params.set(4, new JSONString(account));
       params.set(5, new JSONString(server));

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -198,7 +198,7 @@ public PrefValue<Integer> backgroundDiagnosticsDelayMs()
    
    public PrefValue<Boolean> diagnosticsInRFunctionCalls()
    {
-      return bool("diagnostics_in_function_calls", false);
+      return bool("diagnostics_in_function_calls", true);
    }
    
    public PrefValue<Boolean> checkForMissingArgumentsInFunctionCalls()
@@ -218,7 +218,7 @@ public PrefValue<Boolean> warnIfVariableDefinedButNotUsed()
    
    public PrefValue<Boolean> validateFunctionCalls()
    {
-      return bool("validate_function_calls", true);
+      return bool("validate_function_calls", false);
    }
    
    public PrefValue<Boolean> autoAppendNewline()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -163,7 +163,7 @@ public PrefValue<Boolean> showSignatureTooltips()
    
    public PrefValue<Boolean> showDiagnosticsR()
    {
-      return bool("show_diagnostics_r", true);
+      return bool("show_r_diagnostics", false);
    }
    
    public PrefValue<Boolean> showDiagnosticsCpp()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -198,7 +198,7 @@ public PrefValue<Integer> backgroundDiagnosticsDelayMs()
    
    public PrefValue<Boolean> diagnosticsInRFunctionCalls()
    {
-      return bool("show_diagnostics_in_r_function_calls", true);
+      return bool("diagnostics_in_function_calls", false);
    }
    
    public PrefValue<Boolean> autoAppendNewline()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -181,7 +181,7 @@ public void onUiPrefsChanged(UiPrefsChangedEvent e)
          // Configure R Linter
          
          enableStyleDiagnostics().setGlobalValue(
-               newUiPrefs.enableBackgroundDiagnostics().getGlobalValue());
+               newUiPrefs.enableStyleDiagnostics().getGlobalValue());
          
          diagnosticsInRFunctionCalls().setGlobalValue(
                newUiPrefs.diagnosticsInRFunctionCalls().getGlobalValue());

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -738,7 +738,7 @@ private final native void exportNativeCallbacks() /*-{
       var thiz = this;     
       $wnd.deployToRSConnect = $entry(
          function(sourceFile, deployDir, deployFile, deployFiles, additionalFiles, ignoredFiles, asMultiple, asStatic, launch, record) {
-            thiz.@org.rstudio.studio.client.rsconnect.RSConnect::deployToRSConnect(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Lcom/google/gwt/core/client/JsArrayString;Lcom/google/gwt/core/client/JsArrayString;Lcom/google/gwt/core/client/JsArrayString;ZZZLcom/google/gwt/core/client/JavaScriptObject;)(sourceFile, deployDir, deployFiles, additionalFiles, ignoredFiles, asMultiple, asStatic, launch, record);
+            thiz.@org.rstudio.studio.client.rsconnect.RSConnect::deployToRSConnect(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Lcom/google/gwt/core/client/JsArrayString;Lcom/google/gwt/core/client/JsArrayString;Lcom/google/gwt/core/client/JsArrayString;ZZZLcom/google/gwt/core/client/JavaScriptObject;)(sourceFile, deployDir, deployFile, deployFiles, additionalFiles, ignoredFiles, asMultiple, asStatic, launch, record);
          }
       ); 
    }-*/;

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishButton.java
Patch:
@@ -244,6 +244,7 @@ private void onPublishClick(RSConnectDeploymentRecord previous)
    {
       switch (contentType_)
       {
+      case RSConnect.CONTENT_TYPE_HTML:
       case RSConnect.CONTENT_TYPE_PLOT:
          // for plots, we need to generate the hosting HTML prior to publishing
          if (htmlGenerator_ != null)

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/RSConnectPublishWizard.java
Patch:
@@ -35,7 +35,8 @@ public RSConnectPublishWizard(RSConnectPublishInput input,
       // Select the first page of the wizard based on the kind of content we're
       // dealing with (all other content type situations don't require a 
       // wizard to resolve)
-      if (input.getContentType() == RSConnect.CONTENT_TYPE_PLOT)
+      if (input.getContentType() == RSConnect.CONTENT_TYPE_PLOT ||
+          input.getContentType() == RSConnect.CONTENT_TYPE_HTML)
       {
          return new PublishStaticDestPage("Publish", "Publish", input, false);
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -131,7 +131,7 @@ public void navigate(String url)
    {
       navigate(url, false);
       rmdPreviewParams_ = null;
-      publishButton_.setContentType(RSConnect.CONTENT_TYPE_PLOT);
+      publishButton_.setContentType(RSConnect.CONTENT_TYPE_HTML);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/rsconnect/RSConnect.java
Patch:
@@ -131,7 +131,6 @@ public void onRSConnectAction(final RSConnectActionEvent event)
       // see if we have the requisite R packages
       dependencyManager_.withRSConnect(
          "Publishing content", null, new Command() {
-
             @Override
             public void execute()
             {
@@ -164,6 +163,7 @@ private void showPublishUI(final RSConnectActionEvent event)
          case CONTENT_TYPE_APP:
             publishAsCode(event);
             break;
+         case CONTENT_TYPE_PLOT:
          case CONTENT_TYPE_DOCUMENT:
             if (event.getFromPrevious().getServer().equals("rpubs.com"))
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -131,12 +131,14 @@ public void navigate(String url)
    {
       navigate(url, false);
       rmdPreviewParams_ = null;
+      publishButton_.setContentType(RSConnect.CONTENT_TYPE_PLOT);
    }
 
    @Override
    public void previewRmd(RmdPreviewParams params)
    {
       navigate(params.getOutputUrl(), true);
+      publishButton_.setContentType(RSConnect.CONTENT_TYPE_DOCUMENT);
       publishButton_.setVisible(true);
       publishButton_.setRmdPreview(params);
       rmdPreviewParams_ = params;

File: src/gwt/src/org/rstudio/studio/client/common/ConsoleDispatcher.java
Patch:
@@ -154,8 +154,8 @@ public void executeSourceCommand(String path,
                      "(" + escapedPath);
          else
          {
-            code.append((debug ? "debugSource" : "source.with.encoding") + 
-                  "(" + escapedPath + ", encoding='" +
+            code.append((debug ? "debugSource" : "source") + 
+                  "(" + escapedPath + ", encoding = '" +
                   (!StringUtil.isNullOrEmpty(encoding) ? encoding : "UTF-8") +
                   "'");
          }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/model/RSConnectServerOperations.java
Patch:
@@ -40,8 +40,9 @@ void getDeploymentFiles (String target,
                boolean asMultipleRmd,
                ServerRequestCallback<RSConnectDeploymentFiles> requestCallback);
    
-   void publishContent(String dir, String file, String account, String server, 
-               String appName, RSConnectPublishSettings settings,
+   void publishContent(RSConnectPublishSource source, 
+               String account, String server, String appName, 
+               RSConnectPublishSettings settings,
                ServerRequestCallback<Boolean> requestCallback);
 
    void validateServerUrl (String url, 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -198,7 +198,7 @@ public PrefValue<Integer> backgroundDiagnosticsDelayMs()
    
    public PrefValue<Boolean> diagnosticsInRFunctionCalls()
    {
-      return bool("diagnostics_in_r_function_calls", false);
+      return bool("show_diagnostics_in_r_function_calls", true);
    }
    
    public PrefValue<Boolean> autoAppendNewline()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -175,9 +175,9 @@ InputEditorSelection search(String needle,
    Scope getCurrentScope();
    Scope getCurrentChunk();
    Scope getCurrentChunk(Position position);
-   Scope getCurrentFunction();
+   ScopeFunction getCurrentFunction(boolean allowAnonymous);
    Scope getCurrentSection();
-   ScopeFunction getFunctionAtPosition(Position position);
+   ScopeFunction getFunctionAtPosition(Position position, boolean allowAnonymous);
    Scope getSectionAtPosition(Position position);
    boolean hasScopeTree();
    JsArray<Scope> getScopeTree();

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishCodePage.java
Patch:
@@ -38,7 +38,7 @@ public PublishCodePage(String title, String subTitle,
    @Override
    public void focus()
    {
-      
+      contents_.focus();
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishStaticDestPage.java
Patch:
@@ -41,7 +41,7 @@ public PublishStaticDestPage(String title, String subTitle,
          "RStudio for sharing documents on the web."));
       pages.add(new PublishStaticPage("A server in your organization", 
          "RStudio Connect enables members of your organization to share and " + 
-         "collaborate privately and securely."));
+         "collaborate privately and securely.", true));
       return pages;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/rsconnect/ui/PublishStaticPage.java
Patch:
@@ -25,10 +25,11 @@ public class PublishStaticPage
 {
    // Public methods ---------------------------------------------------------
 
-   public PublishStaticPage(String title, String subTitle)
+   public PublishStaticPage(String title, String subTitle, boolean showIcon)
    {
       super(title, subTitle, "Publish", 
-            RSConnectAccountResources.INSTANCE.localAccountIcon(), 
+            showIcon ? RSConnectAccountResources.INSTANCE.localAccountIcon() :
+               null, 
             RSConnectAccountResources.INSTANCE.localAccountIconLarge());
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -257,5 +257,7 @@ void highlightDebugLocation(
    void selectAll(String needle);
    
    int getTabSize();
+   
    long getLastModifiedTime();
+   long getLastCursorChangedTime();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/Markers.java
Patch:
@@ -14,6 +14,7 @@
  */package org.rstudio.studio.client.workbench.views.source.editors.text.ace;
 
 import com.google.gwt.core.client.JavaScriptObject;
+import com.google.gwt.core.client.JsArray;
 
 public class Markers extends JavaScriptObject
 {
@@ -23,4 +24,5 @@ protected Markers() {}
    public final native int[] getIds() /*-{ return Object.keys(this); }-*/;
    public final native Marker get(int id) /*-{ return this[id]; }-*/;
    public final native int size() /*-{ return Object.keys(this).length || 0; }-*/;
+   
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -78,6 +78,7 @@ public interface FileIconResources extends ClientBundle
    ImageResource iconRuby();
    ImageResource iconRust();
    ImageResource iconScala();
+   ImageResource iconSnippets();
    
    ImageResource iconStan();
    

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -72,8 +72,8 @@ public class EditorLanguage
          "ace/mode/yaml", false, true);
    public static final EditorLanguage LANG_XML = new EditorLanguage(
          "ace/mode/xml", false, true);
-   public static final EditorLanguage LANG_GRAPHVIZ = new EditorLanguage("ace/mode/dot", false, true);
    
+   public static final EditorLanguage LANG_GRAPHVIZ = new EditorLanguage("ace/mode/dot", false, true);
    public static final EditorLanguage LANG_CLOJURE = new EditorLanguage("ace/mode/clojure", false, true);
    public static final EditorLanguage LANG_COFFEE = new EditorLanguage("ace/mode/coffee", false, true);
    public static final EditorLanguage LANG_CSHARP = new EditorLanguage("ace/mode/csharp", false, true);
@@ -91,6 +91,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_RUBY = new EditorLanguage("ace/mode/ruby", false, true);
    public static final EditorLanguage LANG_RUST = new EditorLanguage("ace/mode/rust", false, true);
    public static final EditorLanguage LANG_SCALA = new EditorLanguage("ace/mode/scala", false, true);
+   public static final EditorLanguage LANG_SNIPPETS = new EditorLanguage("ace/mode/snippets", false, true);
    
    /**
     *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -743,7 +743,8 @@ public void onResponseReceived(EnvironmentContextData data)
          @Override
          public void onError(ServerError error)
          {
-            if (!workbenchContext_.isRestartInProgress())
+            if (!workbenchContext_.isRestartInProgress() &&
+                (error.getCode() != ServerError.TRANSMISSION))
             {
                globalDisplay_.showErrorMessage("Error Listing Objects",
                                                error.getUserMessage());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/Plots.java
Patch:
@@ -506,8 +506,7 @@ void onRefreshPlot()
    @Override
    public void onDeferredInitCompleted(DeferredInitCompletedEvent event)
    {
-      boolean showErrors = !workbenchContext_.isRestartInProgress();
-      server_.refreshPlot(new PlotRequestCallback(showErrors));
+      server_.refreshPlot(new PlotRequestCallback(false));
    }
    
    void onShowManipulator()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPane.java
Patch:
@@ -105,8 +105,6 @@ protected Widget createMainWidget()
    public void navigate(String url)
    {
       navigate(url, false);
-      // TODO: use isExportEnabled to toggle publish UI
-      publishButton_.setVisible(false);
       rmdPreviewParams_ = null;
    }
 
@@ -126,6 +124,7 @@ public void setExportEnabled(boolean exportEnabled)
       isExportEnabled_ = exportEnabled;
       exportButton_.setVisible(exportEnabled);
       exportButtonSeparator_.setVisible(exportEnabled);
+      publishButton_.setVisible(exportEnabled);
       toolbar_.invalidateSeparators();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPresenter.java
Patch:
@@ -372,7 +372,6 @@ public void onResponseReceived(String rpubsHtmlFile)
       });
    }
    
-   
    @Handler
    public void onViewerSaveAllAndRefresh()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -521,7 +521,7 @@ public void syncDiagnosticsPrefs()
 
       getSession().setUseWorker(useWorker);
       getSession().setWorkerTimeout(
-            uiPrefs_.backgroundLintDelayMs().getValue());
+            uiPrefs_.backgroundDiagnosticsDelayMs().getValue());
    }
    
    private void syncWrapLimit()

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeResources.java
Patch:
@@ -171,10 +171,10 @@ public interface ThemeResources extends ClientBundle
 
    ImageResource help();
    
-   ImageResource warningSmall();
    ImageResource infoSmall();
+   ImageResource warningSmall();
    ImageResource errorSmall();
-
+   
    ImageResource codeTransform();
 
    ImageResource closeChevron();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTarget.java
Patch:
@@ -200,7 +200,8 @@ public void onActivate()
 
    public void onDeactivate()
    {
-      commandReg_.removeHandler();
+      if (commandReg_ != null)
+         commandReg_.removeHandler();
       commandReg_ = null;
       
       recordCurrentNavigationPosition();

File: src/gwt/src/org/rstudio/core/client/command/KeyboardShortcut.java
Patch:
@@ -147,14 +147,13 @@ else if (keycode_ == 187)
          return "=";
       else if (keycode_ == 188)
          return "<";
-      else if (keycode_ == 189)
+      else if (KeyboardHelper.isHyphenKeycode(keycode_))
          return "-";
       else if (keycode_ >= 112 && keycode_ <= 123)
          return "F" + (keycode_ - 111);
       else if (keycode_ == 8)
          return macStyle ? "&#9003;" : "Backspace";
 
-
       return Character.toUpperCase((char)keycode_) + "";
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -41,6 +41,7 @@
 import org.rstudio.core.client.command.AppCommand;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.command.Handler;
+import org.rstudio.core.client.command.KeyboardHelper;
 import org.rstudio.core.client.command.KeyboardShortcut;
 import org.rstudio.core.client.events.EnsureHeightHandler;
 import org.rstudio.core.client.events.EnsureVisibleHandler;
@@ -412,8 +413,8 @@ else if (BrowseCap.hasMetaKey() &&
                event.stopPropagation();
                commands_.findFromSelection().execute();
             }
-            else if (mod == KeyboardShortcut.ALT
-                     && ne.getKeyCode() == 189) // hyphen
+            else if (mod == KeyboardShortcut.ALT &&
+                     KeyboardHelper.isHyphenKeycode(ne.getKeyCode()))
             {
                event.preventDefault();
                event.stopPropagation();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionUtils.java
Patch:
@@ -15,6 +15,7 @@
 
 package org.rstudio.studio.client.workbench.views.source.editors.text.cpp;
 
+import org.rstudio.core.client.command.KeyboardHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.DocDisplay;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Position;
 
@@ -32,7 +33,7 @@ public static boolean isCppIdentifierKey(NativeEvent event)
          return true ;
       if (keyCode >= 'A' && keyCode <= 'Z')
          return true ;
-      if (keyCode == 189 && event.getShiftKey()) // underscore
+      if (KeyboardHelper.isUnderscore(event))
          return true ;
      
       if (event.getShiftKey())

File: src/gwt/src/org/rstudio/studio/client/common/dependencies/DependencyManager.java
Patch:
@@ -246,7 +246,7 @@ public void onResponseReceived(
                globalDisplay_.showErrorMessage(userAction, 
                      "Required package versions could not be found:\n\n" +
                      unsatisfiedVersions + "\n" +
-                     "Check that getOptions(\"repos\") refers to a CRAN " + 
+                     "Check that getOption(\"repos\") refers to a CRAN " + 
                      "repository that contains the needed package versions.");
             }
             else

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -33,7 +33,7 @@ public class EditorLanguage
    public static final EditorLanguage LANG_R = new EditorLanguage(
          "mode/r", true);
    public static final EditorLanguage LANG_RDOC = new EditorLanguage(
-         "mode/rdoc", false);
+         "mode/rdoc", false, false);
    public static final EditorLanguage LANG_TEX = new EditorLanguage(
          "mode/tex", false);
    public static final EditorLanguage LANG_SWEAVE = new EditorLanguage(

File: src/gwt/src/org/rstudio/core/client/widget/DynamicIFrame.java
Patch:
@@ -32,7 +32,7 @@ public DynamicIFrame()
          @Override
          public boolean execute()
          {
-            if (getIFrame() == null || getWindow() == null)
+            if (getIFrame() == null || getWindow() == null || getDocument() == null)
                return true;
             onFrameLoaded();
             return false;

File: src/gwt/src/org/rstudio/core/client/widget/DynamicIFrame.java
Patch:
@@ -32,7 +32,7 @@ public DynamicIFrame()
          @Override
          public boolean execute()
          {
-            if (getIFrame() == null || getWindow() == null)
+            if (getIFrame() == null || getWindow() == null || getDocument() == null)
                return true;
             onFrameLoaded();
             return false;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -208,7 +208,7 @@ public boolean validate()
    {
       return (!spacesForTab_.getValue() || tabWidth_.validatePositive("Tab width")) && 
              (!showMargin_.getValue() || marginCol_.validate("Margin column")) &&
-             alwaysCompleteChars_.validateRange("Characters entered", 3, 100) &&
+             alwaysCompleteChars_.validateRange("Characters entered", 1, 100) &&
              alwaysCompleteDelayMs_.validateRange("Keyboard idle (ms)", 0, 10000);
    }
 

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -349,6 +349,7 @@ public final native boolean exists() /*-{
       MIME_TYPES.put( "py",        "text/x-python" );
       MIME_TYPES.put( "sh",        "text/x-shell" );
       MIME_TYPES.put( "sql",       "text/x-sql" );
+      MIME_TYPES.put( "stan",      "text/x-stan" );
 
       // other types we are likely to serve
       MIME_TYPES.put( "xml",   "text/xml" );

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -128,7 +128,7 @@ public PrefValue<Boolean> alwaysCompleteInConsole()
    
    public PrefValue<Integer> alwaysCompleteDelayMs()
    {
-      return integer("always_complete_delay", 200);
+      return integer("always_complete_delay", 250);
    }
    
    public PrefValue<Integer> alwaysCompleteCharacters()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -69,6 +69,7 @@ public AceEditorWidget()
       addStyleName("loading");
 
       editor_ = AceEditorNative.createEditor(getElement());
+      editor_.manageDefaultKeybindings();
       editor_.getRenderer().setHScrollBarAlwaysVisible(false);
       editor_.setShowPrintMargin(false);
       editor_.setPrintMarginColumn(0);

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -312,7 +312,7 @@ public void onExecute(final Command continuation)
                VcsCloneOptions cloneOptions = newProject.getVcsCloneOptions();
                
                if (cloneOptions.getVcsName().equals((VCSConstants.GIT_ID)))
-                  indicator.onProgress("Cloning Git repoistory...");
+                  indicator.onProgress("Cloning Git repository...");
                else
                   indicator.onProgress("Checking out SVN repository...");
                

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -312,7 +312,7 @@ public void onExecute(final Command continuation)
                VcsCloneOptions cloneOptions = newProject.getVcsCloneOptions();
                
                if (cloneOptions.getVcsName().equals((VCSConstants.GIT_ID)))
-                  indicator.onProgress("Cloning Git repoistory...");
+                  indicator.onProgress("Cloning Git repository...");
                else
                   indicator.onProgress("Checking out SVN repository...");
                

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewProjectWizard.java
Patch:
@@ -35,6 +35,7 @@ public NewProjectWizard(
    {
       super("New Project", 
             "Create project from:", 
+            "Create Project",
             input, 
             operation);
     

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -37,7 +37,6 @@
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.ElementIds;
 import org.rstudio.core.client.ExternalJavaScriptLoader;
 import org.rstudio.core.client.ExternalJavaScriptLoader.Callback;
@@ -2073,7 +2072,7 @@ private void clearLintMarkers()
    }
    
    public Range createAnchoredRange(Position start,
-                                    Position end) 
+                                    Position end)
    {
       return widget_.getEditor().getSession().createAnchoredRange(start, end);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/Markers.java
Patch:
@@ -20,6 +20,7 @@ public class Markers extends JavaScriptObject
    protected Markers() {}
    
    // NOTE: no constructor as these are generated internally by Ace
+   public final native int[] getIds() /*-{ return Object.keys(this); }-*/;
    public final native Marker get(int id) /*-{ return this[id]; }-*/;
    public final native int size() /*-{ return Object.keys(this).length || 0; }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -23,6 +23,7 @@
 import org.rstudio.studio.client.workbench.views.console.shell.editor.InputEditorPosition;
 import org.rstudio.studio.client.workbench.views.console.shell.editor.InputEditorSelection;
 import org.rstudio.studio.client.workbench.views.output.lint.model.AceAnnotation;
+import org.rstudio.studio.client.workbench.views.output.lint.model.LintItem;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceFold;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Anchor;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Mode.InsertChunkInfo;
@@ -239,6 +240,7 @@ void highlightDebugLocation(
    boolean hasBreakpoints();
    
    void setAnnotations(JsArray<AceAnnotation> annotations);
+   void showLint(JsArray<LintItem> lint);
    
    void setPopupVisible(boolean visible);
    boolean isPopupVisible();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -408,7 +408,6 @@ public void onSynctexStatusChanged(SynctexStatusChangedEvent event)
          @Override
          public void onLintEvent(LintEvent event)
          {
-            Debug.logObject(event);
             String documentId = event.getDocumentId();
             final EditingTarget target = getEditingTargetForId(documentId);
             if (target != null && target instanceof TextEditingTarget)

File: src/gwt/src/org/rstudio/studio/client/dataviewer/DataViewerPanel.java
Patch:
@@ -70,7 +70,7 @@ public void onDataViewChanged(DataViewChangedEvent event)
       if (item_ != null && 
           event.getData().getCacheKey().equals(item_.getCacheKey()))
       {
-         table_.refreshData(event.getData().structureChanged());
+         table_.refreshData(event.getData().structureChanged(), false);
       }
    } 
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2445,8 +2445,6 @@ public void ensureWhitespaceFollows()
              value.equals("<-") ||
              value.equals("<<-");
          
-         Debug.logToConsole("" + getCurrentLineLength());
-         
          if (mightWantNewline && 
              getCurrentLineLength() >= 70)
          {

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -49,9 +49,9 @@
 import org.rstudio.studio.client.application.ui.serializationprogress.ApplicationSerializationProgress;
 import org.rstudio.studio.client.application.ui.support.SupportPopupMenu;
 import org.rstudio.studio.client.common.StudioResources;
-import org.rstudio.studio.client.common.compile.errorlist.CompileErrorListResources;
 import org.rstudio.studio.client.common.mirrors.ChooseMirrorDialog;
 import org.rstudio.studio.client.common.rpubs.ui.RPubsUploadDialog;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarkerListResources;
 import org.rstudio.studio.client.common.spelling.ui.SpellingCustomDictionariesWidget;
 import org.rstudio.studio.client.common.vcs.CreateKeyDialog;
 import org.rstudio.studio.client.common.vcs.ShowPublicKeyDialog;
@@ -217,7 +217,7 @@ private void ensureStylesInjected()
       FilesListCellTableResources.INSTANCE.cellTableStyle().ensureInjected();
       ExportPlotResources.INSTANCE.styles().ensureInjected();
       CodeSearchResources.INSTANCE.styles().ensureInjected();
-      CompileErrorListResources.INSTANCE.styles().ensureInjected();
+      SourceMarkerListResources.INSTANCE.styles().ensureInjected();
       BuildPaneResources.INSTANCE.styles().ensureInjected();
       
       ProgressDialog.ensureStylesInjected();

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/model/CompilePdfState.java
Patch:
@@ -15,7 +15,7 @@
 
 package org.rstudio.studio.client.common.compilepdf.model;
 
-import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
@@ -42,7 +42,7 @@ public final native String getOutput() /*-{
       return this.output;
    }-*/;
 
-   public final native JsArray<CompileError> getErrors() /*-{
+   public final native JsArray<SourceMarker> getErrors() /*-{
       return this.errors;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdRenderResult.java
Patch:
@@ -14,7 +14,7 @@
  */
 package org.rstudio.studio.client.rmarkdown.model;
 
-import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JsArray;
 
@@ -83,7 +83,7 @@ public final String getFormatName()
       return getFormat().getFormatName();
    }
    
-   public final native JsArray<CompileError> getKnitrErrors() /*-{
+   public final native JsArray<SourceMarker> getKnitrErrors() /*-{
       return this.knitr_errors;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -114,6 +114,7 @@ class ClientEvent extends JavaScriptObject
    public static final String PackratRestoreNeeded = "packrat_restore_needed";
    public static final String DataViewChanged = "data_view_changed";
    public static final String ViewFunction = "view_function";
+   public static final String ShowMarkers = "show_markers";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -41,6 +41,7 @@
 import org.rstudio.studio.client.workbench.views.edit.model.EditServerOperations;
 import org.rstudio.studio.client.workbench.views.files.model.FilesServerOperations;
 import org.rstudio.studio.client.workbench.views.output.find.model.FindInFilesServerOperations;
+import org.rstudio.studio.client.workbench.views.output.markers.model.MarkersServerOperations;
 import org.rstudio.studio.client.workbench.views.help.model.HelpServerOperations;
 import org.rstudio.studio.client.workbench.views.history.model.HistoryServerOperations;
 import org.rstudio.studio.client.workbench.views.packages.model.PackagesServerOperations;
@@ -82,7 +83,8 @@ public interface WorkbenchServerOperations extends ConsoleServerOperations,
                                                    ProfilerServerOperations,
                                                    RMarkdownServerOperations,
                                                    DependencyServerOperations,
-                                                   PackratServerOperations
+                                                   PackratServerOperations,
+                                                   MarkersServerOperations
 {   
    void initializeForMainWorkbench();
    void disconnect();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -24,11 +24,11 @@
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompileOutput;
 import org.rstudio.studio.client.common.compile.CompileOutputBufferWithHighlight;
 import org.rstudio.studio.client.common.compile.CompilePanel;
 import org.rstudio.studio.client.common.icons.StandardIcons;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.SessionInfo;
@@ -125,13 +125,13 @@ public void showOutput(CompileOutput output)
    
    @Override
    public void showErrors(String basePath,
-                          JsArray<CompileError> errors, 
+                          JsArray<SourceMarker> errors, 
                           boolean ensureVisible,
                           int autoSelect)
    {
       compilePanel_.showErrors(basePath, errors, autoSelect);
       
-      if (ensureVisible && CompileError.showErrorList(errors))
+      if (ensureVisible && SourceMarker.showErrorList(errors))
          ensureVisible();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/events/BuildErrorsEvent.java
Patch:
@@ -14,7 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.buildtools.events;
 
-import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
@@ -33,7 +33,7 @@ public final native String getBaseDirectory() /*-{
          return this.base_dir;
       }-*/;
       
-      public final native JsArray<CompileError> getErrors() /*-{
+      public final native JsArray<SourceMarker> getErrors() /*-{
          return this.errors;
       }-*/;
    }
@@ -54,7 +54,7 @@ public String getBaseDirectory()
       return data_.getBaseDirectory();
    }
    
-   public JsArray<CompileError> getErrors()
+   public JsArray<SourceMarker> getErrors()
    {
       return data_.getErrors();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/model/BuildState.java
Patch:
@@ -15,8 +15,8 @@
 
 package org.rstudio.studio.client.workbench.views.buildtools.model;
 
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompileOutput;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
@@ -35,7 +35,7 @@ public final native String getErrorsBaseDir() /*-{
       return this.errors_base_dir;
    }-*/;
    
-   public final native JsArray<CompileError> getErrors() /*-{
+   public final native JsArray<SourceMarker> getErrors() /*-{
       return this.errors;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/common/CompileOutputPaneDisplay.java
Patch:
@@ -17,8 +17,8 @@
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.events.HasEnsureHiddenHandlers;
 import org.rstudio.core.client.events.HasSelectionCommitHandlers;
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompileOutput;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 import org.rstudio.studio.client.workbench.WorkbenchView;
 
 import com.google.gwt.core.client.JsArray;
@@ -29,7 +29,7 @@ public interface CompileOutputPaneDisplay extends WorkbenchView, HasEnsureHidden
    void ensureVisible(boolean activate);
    void compileStarted(String text);
    void showOutput(CompileOutput output);
-   void showErrors(JsArray<CompileError> errors);
+   void showErrors(JsArray<SourceMarker> errors);
    void clearAll();
    void compileCompleted();
    HasClickHandlers stopButton();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -130,6 +130,8 @@ public void onFindResult(FindResultEvent event)
             if (!event.getHandle().equals(currentFindHandle_))
                return;
             view_.addMatches(event.getResults());
+            
+            view_.ensureVisible(true);
          }
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/renderrmd/RenderRmdOutputPresenter.java
Patch:
@@ -29,7 +29,7 @@
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.RestartStatusEvent;
 import org.rstudio.studio.client.common.GlobalDisplay;
-import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 import org.rstudio.studio.client.rmarkdown.events.RmdRenderCompletedEvent;
 import org.rstudio.studio.client.rmarkdown.events.RmdRenderOutputEvent;
 import org.rstudio.studio.client.rmarkdown.events.RmdRenderStartedEvent;
@@ -147,7 +147,7 @@ else if (!event.getResult().getSucceeded())
          view_.ensureVisible(true);
       }
       if (!event.getResult().getSucceeded() && 
-          CompileError.showErrorList(event.getResult().getKnitrErrors()))
+          SourceMarker.showErrorList(event.getResult().getKnitrErrors()))
       {
          view_.showErrors(event.getResult().getKnitrErrors());
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/SourceCppOutputPane.java
Patch:
@@ -17,14 +17,15 @@
 import com.google.gwt.core.client.JsArray;
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
+
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.events.EnsureVisibleEvent;
 import org.rstudio.core.client.events.HasSelectionCommitHandlers;
 import org.rstudio.core.client.widget.*;
 import org.rstudio.studio.client.common.compile.CompileOutput;
 import org.rstudio.studio.client.common.compile.CompileOutputBufferWithHighlight;
 import org.rstudio.studio.client.common.compile.CompilePanel;
-import org.rstudio.studio.client.common.compile.errorlist.CompileErrorList;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarkerList;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
 import org.rstudio.studio.client.workbench.views.output.sourcecpp.model.SourceCppState;
 
@@ -79,7 +80,7 @@ public void showResults(SourceCppState state)
       {
          compilePanel_.showErrors(null, 
                                   state.getErrors(), 
-                                  CompileErrorList.AUTO_SELECT_FIRST,
+                                  SourceMarkerList.AUTO_SELECT_FIRST,
                                   true);
       }
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/SourceCppOutputPresenter.java
Patch:
@@ -17,12 +17,13 @@
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.user.client.Command;
 import com.google.inject.Inject;
+
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.events.*;
 import org.rstudio.core.client.files.FileSystemItem;
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 import org.rstudio.studio.client.workbench.WorkbenchView;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 import org.rstudio.studio.client.workbench.views.BasePresenter;
@@ -105,7 +106,7 @@ private void updateView(SourceCppState state, boolean activate)
       // navigate to the first error
       if (uiPrefs_.navigateToBuildError().getValue())
       {
-         CompileError error = CompileError.getFirstError(state.getErrors());
+         SourceMarker error = SourceMarker.getFirstError(state.getErrors());
          if (error != null)
          {
             fileTypeRegistry_.editFile(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/model/SourceCppState.java
Patch:
@@ -15,8 +15,8 @@
 
 package org.rstudio.studio.client.workbench.views.output.sourcecpp.model;
 
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompileOutput;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
@@ -35,7 +35,7 @@ public final native JsArray<CompileOutput> getOutputs() /*-{
       return this.outputs;
    }-*/;
    
-   public final native JsArray<CompileError> getErrors() /*-{
+   public final native JsArray<SourceMarker> getErrors() /*-{
       return this.errors;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -49,9 +49,9 @@
 import org.rstudio.studio.client.application.ui.serializationprogress.ApplicationSerializationProgress;
 import org.rstudio.studio.client.application.ui.support.SupportPopupMenu;
 import org.rstudio.studio.client.common.StudioResources;
-import org.rstudio.studio.client.common.compile.errorlist.CompileErrorListResources;
 import org.rstudio.studio.client.common.mirrors.ChooseMirrorDialog;
 import org.rstudio.studio.client.common.rpubs.ui.RPubsUploadDialog;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarkerListResources;
 import org.rstudio.studio.client.common.spelling.ui.SpellingCustomDictionariesWidget;
 import org.rstudio.studio.client.common.vcs.CreateKeyDialog;
 import org.rstudio.studio.client.common.vcs.ShowPublicKeyDialog;
@@ -217,7 +217,7 @@ private void ensureStylesInjected()
       FilesListCellTableResources.INSTANCE.cellTableStyle().ensureInjected();
       ExportPlotResources.INSTANCE.styles().ensureInjected();
       CodeSearchResources.INSTANCE.styles().ensureInjected();
-      CompileErrorListResources.INSTANCE.styles().ensureInjected();
+      SourceMarkerListResources.INSTANCE.styles().ensureInjected();
       BuildPaneResources.INSTANCE.styles().ensureInjected();
       
       ProgressDialog.ensureStylesInjected();

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/model/CompilePdfState.java
Patch:
@@ -15,7 +15,7 @@
 
 package org.rstudio.studio.client.common.compilepdf.model;
 
-import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
@@ -42,7 +42,7 @@ public final native String getOutput() /*-{
       return this.output;
    }-*/;
 
-   public final native JsArray<CompileError> getErrors() /*-{
+   public final native JsArray<SourceMarker> getErrors() /*-{
       return this.errors;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdRenderResult.java
Patch:
@@ -14,7 +14,7 @@
  */
 package org.rstudio.studio.client.rmarkdown.model;
 
-import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JsArray;
 
@@ -83,7 +83,7 @@ public final String getFormatName()
       return getFormat().getFormatName();
    }
    
-   public final native JsArray<CompileError> getKnitrErrors() /*-{
+   public final native JsArray<SourceMarker> getKnitrErrors() /*-{
       return this.knitr_errors;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -27,7 +27,6 @@
 import org.rstudio.studio.client.application.events.*;
 import org.rstudio.studio.client.application.model.SaveAction;
 import org.rstudio.studio.client.application.model.SessionSerializationAction;
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompileOutput;
 import org.rstudio.studio.client.common.compilepdf.events.CompilePdfCompletedEvent;
 import org.rstudio.studio.client.common.compilepdf.events.CompilePdfErrorsEvent;
@@ -46,6 +45,7 @@
 import org.rstudio.studio.client.common.debugging.model.UnhandledError;
 import org.rstudio.studio.client.common.dependencies.events.InstallShinyEvent;
 import org.rstudio.studio.client.common.rpubs.events.RPubsUploadStatusEvent;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 import org.rstudio.studio.client.common.synctex.events.SynctexEditFileEvent;
 import org.rstudio.studio.client.common.synctex.model.SourceLocation;
 import org.rstudio.studio.client.htmlpreview.events.HTMLPreviewCompletedEvent;
@@ -368,7 +368,7 @@ else if (type.equals(ClientEvent.CompilePdfOutputEvent))
          }
          else if (type.equals(ClientEvent.CompilePdfErrorsEvent))
          {
-            JsArray<CompileError> data = event.getData();
+            JsArray<SourceMarker> data = event.getData();
             eventBus_.fireEvent(new CompilePdfErrorsEvent(data));
          }
          else if (type.equals(ClientEvent.CompilePdfCompletedEvent))

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -24,11 +24,11 @@
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.core.client.widget.ToolbarPopupMenu;
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompileOutput;
 import org.rstudio.studio.client.common.compile.CompileOutputBufferWithHighlight;
 import org.rstudio.studio.client.common.compile.CompilePanel;
 import org.rstudio.studio.client.common.icons.StandardIcons;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.SessionInfo;
@@ -125,13 +125,13 @@ public void showOutput(CompileOutput output)
    
    @Override
    public void showErrors(String basePath,
-                          JsArray<CompileError> errors, 
+                          JsArray<SourceMarker> errors, 
                           boolean ensureVisible,
                           int autoSelect)
    {
       compilePanel_.showErrors(basePath, errors, autoSelect);
       
-      if (ensureVisible && CompileError.showErrorList(errors))
+      if (ensureVisible && SourceMarker.showErrorList(errors))
          ensureVisible();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/events/BuildErrorsEvent.java
Patch:
@@ -14,7 +14,7 @@
  */
 package org.rstudio.studio.client.workbench.views.buildtools.events;
 
-import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
@@ -33,7 +33,7 @@ public final native String getBaseDirectory() /*-{
          return this.base_dir;
       }-*/;
       
-      public final native JsArray<CompileError> getErrors() /*-{
+      public final native JsArray<SourceMarker> getErrors() /*-{
          return this.errors;
       }-*/;
    }
@@ -54,7 +54,7 @@ public String getBaseDirectory()
       return data_.getBaseDirectory();
    }
    
-   public JsArray<CompileError> getErrors()
+   public JsArray<SourceMarker> getErrors()
    {
       return data_.getErrors();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/model/BuildState.java
Patch:
@@ -15,8 +15,8 @@
 
 package org.rstudio.studio.client.workbench.views.buildtools.model;
 
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompileOutput;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
@@ -35,7 +35,7 @@ public final native String getErrorsBaseDir() /*-{
       return this.errors_base_dir;
    }-*/;
    
-   public final native JsArray<CompileError> getErrors() /*-{
+   public final native JsArray<SourceMarker> getErrors() /*-{
       return this.errors;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/common/CompileOutputPaneDisplay.java
Patch:
@@ -17,8 +17,8 @@
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.events.HasEnsureHiddenHandlers;
 import org.rstudio.core.client.events.HasSelectionCommitHandlers;
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompileOutput;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 import org.rstudio.studio.client.workbench.WorkbenchView;
 
 import com.google.gwt.core.client.JsArray;
@@ -29,7 +29,7 @@ public interface CompileOutputPaneDisplay extends WorkbenchView, HasEnsureHidden
    void ensureVisible(boolean activate);
    void compileStarted(String text);
    void showOutput(CompileOutput output);
-   void showErrors(JsArray<CompileError> errors);
+   void showErrors(JsArray<SourceMarker> errors);
    void clearAll();
    void compileCompleted();
    HasClickHandlers stopButton();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/renderrmd/RenderRmdOutputPresenter.java
Patch:
@@ -29,7 +29,7 @@
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.events.RestartStatusEvent;
 import org.rstudio.studio.client.common.GlobalDisplay;
-import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 import org.rstudio.studio.client.rmarkdown.events.RmdRenderCompletedEvent;
 import org.rstudio.studio.client.rmarkdown.events.RmdRenderOutputEvent;
 import org.rstudio.studio.client.rmarkdown.events.RmdRenderStartedEvent;
@@ -147,7 +147,7 @@ else if (!event.getResult().getSucceeded())
          view_.ensureVisible(true);
       }
       if (!event.getResult().getSucceeded() && 
-          CompileError.showErrorList(event.getResult().getKnitrErrors()))
+          SourceMarker.showErrorList(event.getResult().getKnitrErrors()))
       {
          view_.showErrors(event.getResult().getKnitrErrors());
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/SourceCppOutputPane.java
Patch:
@@ -17,14 +17,15 @@
 import com.google.gwt.core.client.JsArray;
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
+
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.events.EnsureVisibleEvent;
 import org.rstudio.core.client.events.HasSelectionCommitHandlers;
 import org.rstudio.core.client.widget.*;
 import org.rstudio.studio.client.common.compile.CompileOutput;
 import org.rstudio.studio.client.common.compile.CompileOutputBufferWithHighlight;
 import org.rstudio.studio.client.common.compile.CompilePanel;
-import org.rstudio.studio.client.common.compile.errorlist.CompileErrorList;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarkerList;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
 import org.rstudio.studio.client.workbench.views.output.sourcecpp.model.SourceCppState;
 
@@ -79,7 +80,7 @@ public void showResults(SourceCppState state)
       {
          compilePanel_.showErrors(null, 
                                   state.getErrors(), 
-                                  CompileErrorList.AUTO_SELECT_FIRST,
+                                  SourceMarkerList.AUTO_SELECT_FIRST,
                                   true);
       }
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/SourceCppOutputPresenter.java
Patch:
@@ -17,12 +17,13 @@
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.user.client.Command;
 import com.google.inject.Inject;
+
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.events.*;
 import org.rstudio.core.client.files.FileSystemItem;
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 import org.rstudio.studio.client.workbench.WorkbenchView;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 import org.rstudio.studio.client.workbench.views.BasePresenter;
@@ -105,7 +106,7 @@ private void updateView(SourceCppState state, boolean activate)
       // navigate to the first error
       if (uiPrefs_.navigateToBuildError().getValue())
       {
-         CompileError error = CompileError.getFirstError(state.getErrors());
+         SourceMarker error = SourceMarker.getFirstError(state.getErrors());
          if (error != null)
          {
             fileTypeRegistry_.editFile(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/model/SourceCppState.java
Patch:
@@ -15,8 +15,8 @@
 
 package org.rstudio.studio.client.workbench.views.output.sourcecpp.model;
 
-import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompileOutput;
+import org.rstudio.studio.client.common.sourcemarkers.SourceMarker;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
@@ -35,7 +35,7 @@ public final native JsArray<CompileOutput> getOutputs() /*-{
       return this.outputs;
    }-*/;
    
-   public final native JsArray<CompileError> getErrors() /*-{
+   public final native JsArray<SourceMarker> getErrors() /*-{
       return this.errors;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionManager.java
Patch:
@@ -17,6 +17,7 @@
 import com.google.gwt.dom.client.NativeEvent;
 import org.rstudio.studio.client.workbench.views.console.shell.KeyDownPreviewHandler;
 import org.rstudio.studio.client.workbench.views.console.shell.KeyPressPreviewHandler;
+import org.rstudio.studio.client.workbench.views.source.editors.text.events.PasteEvent;
 
 public interface CompletionManager extends KeyDownPreviewHandler,
                                            KeyPressPreviewHandler
@@ -32,5 +33,7 @@ interface InitCompletionFilter
    void codeCompletion();
    
    void close();
+   
+   void onPaste(PasteEvent event);
 
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionPopupPanel.java
Patch:
@@ -83,7 +83,7 @@ public void onPreviewNativeEvent(NativePreviewEvent previewEvent)
                }
             }
          }
-      }; 
+      };
    }
    
    private void hideAll()

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -43,6 +43,7 @@ public interface FileIconResources extends ClientBundle
    ImageResource iconXml();
    ImageResource iconMarkdown();
    ImageResource iconMermaid();
+   ImageResource iconGraphviz();
    ImageResource iconH();
    ImageResource iconC();
    ImageResource iconHpp();

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/MermaidFileType.java
Patch:
@@ -22,6 +22,6 @@ public class MermaidFileType extends PreviewableFromRFileType
    public MermaidFileType()
    {
       super("mermaid", "Mermaid", EditorLanguage.LANG_MERMAID, ".mmd",
-            FileIconResources.INSTANCE.iconMermaid(), "DiagrammeR::DiagrammeR");
+            FileIconResources.INSTANCE.iconMermaid(), "DiagrammeR::mermaid");
    }
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/CppFileType.java
Patch:
@@ -28,7 +28,7 @@ public class CppFileType extends TextFileType
    {
       super(id, "C/C++", EditorLanguage.LANG_CPP, ext, icon,
             false, false, isCpp, false, false, false, 
-            false, false, false, true, false, true);
+            false, false, false, true, false, true, false);
       
       isCpp_ = isCpp;
    }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/PlainTextFileType.java
Patch:
@@ -41,6 +41,7 @@ public class PlainTextFileType extends TextFileType
             false,
             false,
             true,
+            false,
             false);
       
    }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RFileType.java
Patch:
@@ -36,7 +36,7 @@ public class RFileType extends TextFileType
             defaultExtension,
             defaultIcon,
             false, true, true, true, true, false, 
-            false, false, false, true, false, true);
+            false, false, false, true, false, true, false);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RWebContentFileType.java
Patch:
@@ -58,7 +58,8 @@ public class RWebContentFileType extends TextFileType
             true,
             false,
             true,
-            true);
+            true,
+            false);
       
       isMarkdown_ = isMarkdown;
    }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/ScriptFileType.java
Patch:
@@ -35,7 +35,7 @@ public ScriptFileType(String id,
    {
       super(id, label, language, ext, icon,
             false, false, false, false, false, false, 
-            false, false, false, false, false, false);
+            false, false, false, false, false, false, false);
       interpreter_ = interpreter;
       windowsCompatible_ = windowsCompatible;
    }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/SweaveFileType.java
Patch:
@@ -46,7 +46,8 @@ public class SweaveFileType extends TextFileType
             true,
             false,
             true,
-            true);
+            true,
+            false);
    }
 
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TexFileType.java
Patch:
@@ -45,6 +45,7 @@ public class TexFileType extends TextFileType
             false,
             false,
             true,
+            false,
             false);
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/WebContentFileType.java
Patch:
@@ -47,6 +47,7 @@ public class WebContentFileType extends TextFileType
             false,
             false,
             true,
+            false,
             false);
       
       isMarkdown_ = isMarkdown;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -263,8 +263,9 @@ public final native int findAll(String needle) /*-{
    }-*/;
    
    public final native void insert(String text) /*-{
+      var that = this;
       this.forEachSelection(function() {
-         this.replace(this.getSelectionRange(), text);
+         that.insert(text);
       });
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/Plots.java
Patch:
@@ -412,7 +412,7 @@ public void execute()
              // show the dialog
              RPubsUploadDialog dlg = new RPubsUploadDialog(
                 "Plots",
-                "",
+                "Plot",
                 new RPubsHtmlGenerator() {
 
                    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ViewerPresenter.java
Patch:
@@ -347,7 +347,7 @@ public void execute()
          {
             RPubsUploadDialog dlg = new RPubsUploadDialog(
                "Viewer",
-               "",
+               "Plot",
                new RPubsHtmlGenerator() {
 
                   @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java
Patch:
@@ -50,7 +50,7 @@ public class AceThemes
    public static final String PASTEL_ON_DARK = "Pastel On Dark";
    public static final String SOLARIZED_DARK = "Solarized Dark";
    public static final String SOLARIZED_LIGHT = "Solarized Light";
-   public static final String TEXTMATE = "Textmate";
+   public static final String TEXTMATE = "TextMate";
    public static final String TOMORROW_NIGHT_BLUE = "Tomorrow Night Blue";
    public static final String TOMORROW_NIGHT_BRIGHT = "Tomorrow Night Bright";
    public static final String TOMORROW_NIGHT_EIGHTIES = "Tomorrow Night 80s";
@@ -146,7 +146,7 @@ public String getEffectiveThemeName(String themeName)
 
    private final ArrayList<String> themes_;
    private final HashMap<String, String> themesByName_;
-   private final String defaultThemeName_ = "TextMate";
+   private final String defaultThemeName_ = TEXTMATE;
 
    private LinkElement currentStyleEl_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -189,6 +189,8 @@ private static native <T> JavaScriptObject addEventListenerInternal(
          String eventName,
          CommandWithArg<T> command) /*-{
       var callback = $entry(function(arg) {
+         if (arg && arg.text)
+            arg = arg.text;
          command.@org.rstudio.core.client.CommandWithArg::execute(Ljava/lang/Object;)(arg);
       });
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/TokenCursor.java
Patch:
@@ -21,7 +21,7 @@ public class TokenCursor extends JavaScriptObject
    protected TokenCursor() {}
    
    public static native final TokenCursor create(CodeModel codeModel) /*-{
-      return new TokenCursor(codeModel.$tokens);
+      return codeModel.getTokenCursor();
    }-*/;
    
    public native final TokenCursor cloneCursor() /*-{

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectsServerOperations.java
Patch:
@@ -34,10 +34,10 @@ void createProject(String projectFile,
    
    void packageSkeleton(String packageName,
                         String packageDirectory,
-                        JsArrayString codeFilePaths,
+                        JsArrayString sourceFiles,
                         boolean usingRcpp,
                         ServerRequestCallback<RResult<Void>> callback);
-    
+   
    void readProjectOptions(ServerRequestCallback<RProjectOptions> callback);
    
    void writeProjectOptions(RProjectOptions options,

File: src/gwt/src/org/rstudio/studio/client/server/remote/RResult.java
Patch:
@@ -13,7 +13,7 @@ public final native boolean failed() /*-{
    }-*/;
    
    public final native String errorMessage() /*-{
-      return this.message;
+      return "" + this.message;
    }-*/;
    
    public final native T get() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1262,8 +1262,9 @@ private AutocompletionContext getAutocompletionContext()
          return new AutocompletionContext(
                token, AutocompletionContext.TYPE_ROXYGEN);
       
-      // If the token has '$' or '@', escape early as we'll be completing
-      // either from names or an overloaded `$` method
+      // If the token has '$' or '@', add in the autocompletion context --
+      // note that we still need parent contexts to give more information
+      // about the appropriate completion
       if (token.contains("$") || token.contains("@"))
          addAutocompletionContextForDollar(context);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/TokenCursor.java
Patch:
@@ -21,7 +21,7 @@ public class TokenCursor extends JavaScriptObject
    protected TokenCursor() {}
    
    public static native final TokenCursor create(CodeModel codeModel) /*-{
-      return new TokenCursor(codeModel.$tokens);
+      return codeModel.getTokenCursor();
    }-*/;
    
    public native final TokenCursor cloneCursor() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/TokenCursor.java
Patch:
@@ -21,7 +21,7 @@ public class TokenCursor extends JavaScriptObject
    protected TokenCursor() {}
    
    public static native final TokenCursor create(CodeModel codeModel) /*-{
-      return new TokenCursor(codeModel.$tokens);
+      return codeModel.getTokenCursor();
    }-*/;
    
    public native final TokenCursor cloneCursor() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/TokenCursor.java
Patch:
@@ -21,7 +21,7 @@ public class TokenCursor extends JavaScriptObject
    protected TokenCursor() {}
    
    public static native final TokenCursor create(CodeModel codeModel) /*-{
-      return new TokenCursor(codeModel.$tokens);
+      return codeModel.getTokenCursor();
    }-*/;
    
    public native final TokenCursor cloneCursor() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1262,8 +1262,9 @@ private AutocompletionContext getAutocompletionContext()
          return new AutocompletionContext(
                token, AutocompletionContext.TYPE_ROXYGEN);
       
-      // If the token has '$' or '@', escape early as we'll be completing
-      // either from names or an overloaded `$` method
+      // If the token has '$' or '@', add in the autocompletion context --
+      // note that we still need parent contexts to give more information
+      // about the appropriate completion
       if (token.contains("$") || token.contains("@"))
          addAutocompletionContextForDollar(context);
       

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectsServerOperations.java
Patch:
@@ -34,10 +34,10 @@ void createProject(String projectFile,
    
    void packageSkeleton(String packageName,
                         String packageDirectory,
-                        JsArrayString codeFilePaths,
+                        JsArrayString sourceFiles,
                         boolean usingRcpp,
                         ServerRequestCallback<RResult<Void>> callback);
-    
+   
    void readProjectOptions(ServerRequestCallback<RProjectOptions> callback);
    
    void writeProjectOptions(RProjectOptions options,

File: src/gwt/src/org/rstudio/studio/client/server/remote/RResult.java
Patch:
@@ -13,7 +13,7 @@ public final native boolean failed() /*-{
    }-*/;
    
    public final native String errorMessage() /*-{
-      return this.message;
+      return "" + this.message;
    }-*/;
    
    public final native T get() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1262,8 +1262,9 @@ private AutocompletionContext getAutocompletionContext()
          return new AutocompletionContext(
                token, AutocompletionContext.TYPE_ROXYGEN);
       
-      // If the token has '$' or '@', escape early as we'll be completing
-      // either from names or an overloaded `$` method
+      // If the token has '$' or '@', add in the autocompletion context --
+      // note that we still need parent contexts to give more information
+      // about the appropriate completion
       if (token.contains("$") || token.contains("@"))
          addAutocompletionContextForDollar(context);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -354,7 +354,7 @@ private void addScopedArgumentCompletions(
       {
          Position cursorPosition =
                editor.getSession().getSelection().getCursor();
-         CodeModel codeModel = editor.getSession().getMode().getCodeModel();
+         CodeModel codeModel = editor.getSession().getMode().getRCodeModel();
          JsArray<RFunction> scopedFunctions =
                codeModel.getFunctionsInScope(cursorPosition);
          
@@ -410,7 +410,7 @@ private void addScopedCompletions(
       {
          Position cursorPosition =
                editor.getSession().getSelection().getCursor();
-         CodeModel codeModel = editor.getSession().getMode().getCodeModel();
+         CodeModel codeModel = editor.getSession().getMode().getRCodeModel();
       
          JsArray<RScopeObject> scopeVariables =
                codeModel.getVariablesInScope(cursorPosition);
@@ -441,7 +441,7 @@ private void addFunctionArgumentCompletions(
       {
          Position cursorPosition =
                editor.getSession().getSelection().getCursor();
-         CodeModel codeModel = editor.getSession().getMode().getCodeModel();
+         CodeModel codeModel = editor.getSession().getMode().getRCodeModel();
          
          // Try to see if we can find a function name
          TokenCursor cursor = codeModel.getTokenCursor();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -360,7 +360,7 @@ private void addScopedArgumentCompletions(
       {
          Position cursorPosition =
                editor.getSession().getSelection().getCursor();
-         CodeModel codeModel = editor.getSession().getMode().getCodeModel();
+         CodeModel codeModel = editor.getSession().getMode().getRCodeModel();
          JsArray<RFunction> scopedFunctions =
                codeModel.getFunctionsInScope(cursorPosition);
          
@@ -416,7 +416,7 @@ private void addScopedCompletions(
       {
          Position cursorPosition =
                editor.getSession().getSelection().getCursor();
-         CodeModel codeModel = editor.getSession().getMode().getCodeModel();
+         CodeModel codeModel = editor.getSession().getMode().getRCodeModel();
       
          JsArray<RScopeObject> scopeVariables =
                codeModel.getVariablesInScope(cursorPosition);
@@ -447,7 +447,7 @@ private void addFunctionArgumentCompletions(
       {
          Position cursorPosition =
                editor.getSession().getSelection().getCursor();
-         CodeModel codeModel = editor.getSession().getMode().getCodeModel();
+         CodeModel codeModel = editor.getSession().getMode().getRCodeModel();
          
          // Try to see if we can find a function name
          TokenCursor cursor = codeModel.getTokenCursor();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionPopupDisplay.java
Patch:
@@ -75,4 +75,6 @@ void showCompletionValues(QualifiedName[] results,
    
    boolean hasCompletions();
    int numAvailableCompletions();
+   
+   QualifiedName[] getItems();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1478,7 +1478,7 @@ public void onResponseReceived(CompletionResult completions)
                // Show an empty popup message offscreen -- this is a hack to
                // ensure that we can get completion results on backspace after a
                // failed completion, e.g. 'stats::rna' -> 'stats::rn'
-               Rectangle offScreen = new Rectangle(-100, -100, 0, 0);
+               Rectangle offScreen = new Rectangle(-1000, -1000, 0, 0);
                popup_.showErrorMessage(
                      "",
                      new PopupPositioner(offScreen, popup_));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1478,7 +1478,7 @@ public void onResponseReceived(CompletionResult completions)
                // Show an empty popup message offscreen -- this is a hack to
                // ensure that we can get completion results on backspace after a
                // failed completion, e.g. 'stats::rna' -> 'stats::rn'
-               Rectangle offScreen = new Rectangle(-100, -100, 0, 0);
+               Rectangle offScreen = new Rectangle(-1000, -1000, 0, 0);
                popup_.showErrorMessage(
                      "",
                      new PopupPositioner(offScreen, popup_));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -602,7 +602,7 @@ public void execute()
                input_.getCursorPosition().getColumn() - 1); 
          
          // Automatically popup completions after certain function calls
-         if (c == '(')
+         if (c == '(' && !isLineInComment(docDisplay_.getCurrentLine()))
          {
             String token = StringUtil.getToken(
                   docDisplay_.getCurrentLine(),

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectGeneralPreferencesPane.java
Patch:
@@ -64,7 +64,7 @@ public ImageResource getIcon()
    @Override
    public String getName()
    {
-      return "General2";
+      return "General";
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionManager.java
Patch:
@@ -276,7 +276,7 @@ else if (!CppCompletionUtils.isCppIdentifierKey(event))
    public boolean previewKeyPress(char c)
    {
       // delegate to R mode if necessary
-     if (DocumentMode.isCursorInRMode(docDisplay_) || 
+      if (DocumentMode.isCursorInRMode(docDisplay_) || 
             DocumentMode.isCursorInMarkdownMode(docDisplay_))
       {
          return rCompletionManager_.previewKeyPress(c);

File: src/gwt/src/org/rstudio/core/client/theme/DocTabLayoutPanel.java
Patch:
@@ -184,7 +184,7 @@ public boolean test(Node n)
 
       // When tabs are closed, the overall width shrinks, and this can lead
       // to cases where there's too much empty space on the screen
-      Node lastTab = getLastChildElement(tabBarParent);
+      Node lastTab = getLastChildElement(tabBar);
       if (lastTab == null || lastTab.getNodeType() != Node.ELEMENT_NODE)
          return;
       int edge = DomUtils.getRelativePosition(tabBarParent, Element.as(lastTab)).x 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionPopupDisplay.java
Patch:
@@ -33,6 +33,7 @@ public interface CompletionPopupDisplay
                              HasCloseHandlers<PopupPanel>,
                              HasMouseDownHandlers
 {
+   void clearCompletions();
    void showCompletionValues(QualifiedName[] results,
                              PositionCallback callback) ;
    void showErrorMessage(String userMessage, PositionCallback callback) ;
@@ -64,4 +65,5 @@ void showCompletionValues(QualifiedName[] results,
     *    Implementations may choose to show a progress indicator in this case.
     */
    void clearHelp(boolean downloadOperationPending) ;
+   boolean hasCompletions();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -229,4 +229,7 @@ void highlightDebugLocation(
    void removeAllBreakpoints();
    void toggleBreakpointAtCursor();
    boolean hasBreakpoints();
+   
+   void setPopupVisible(boolean visible);
+   boolean isPopupVisible();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -471,6 +471,7 @@ else if (ne.getKeyCode() == KeyCodes.KEY_M && (
             }
             else if (
                   prefs_.continueCommentsOnNewline().getValue() && 
+                  !docDisplay_.isPopupVisible() &&
                   ne.getKeyCode() == KeyCodes.KEY_ENTER && mod == 0 &&
                     (fileType_.isC() || isCursorInRMode() || isCursorInTexMode()))
             {
@@ -501,6 +502,7 @@ else if (fileType_.isC())
             }
             else if (
                   prefs_.continueCommentsOnNewline().getValue() &&
+                  !docDisplay_.isPopupVisible() &&
                   ne.getKeyCode() == KeyCodes.KEY_ENTER &&
                   mod == KeyboardShortcut.SHIFT)
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionManager.java
Patch:
@@ -228,6 +228,9 @@ else if (event.getKeyCode() == 113 // F2
          if ((popup == null) || !popup.isVisible())
             return false;
          
+         // let the document know that a popup is showing
+         docDisplay_.setPopupVisible(true);
+         
          // backspace triggers completion if the popup is visible
          if (keyCode == KeyCodes.KEY_BACKSPACE)
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -327,8 +327,7 @@ public void onResponseReceived(Completions response)
                cachedCompletions_.put("", result);
             }
 
-            if (!implicit || result.completions.size() != 0)
-               callback.onResponseReceived(result);
+            callback.onResponseReceived(result);
          }
       }) ;
    }
@@ -547,6 +546,7 @@ public void onResponseReceived(RnwChunkOptions options)
             {
                response.setSuggestOnAccept(true);
             }
+            
             requestCallback.onResponseReceived(response);
          }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -631,7 +631,7 @@ public String toString()
                name);
          
          // Get the associated package for functions
-         if (type == RCompletionType.FUNCTION)
+         if (RCompletionType.isFunctionType(type))
          {
             SafeHtmlUtil.appendSpan(
                   sb,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HelpStrategy.java
Patch:
@@ -57,7 +57,7 @@ public void showHelp(final QualifiedName item,
          case RCompletionType.PACKAGE:
             showPackageHelp(item, display);
             break;
-         case RCompletionType.ARGUMENTS:
+         case RCompletionType.ARGUMENT:
             showParameterHelp(item, display);
             break;
          default:

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1001,7 +1001,7 @@ private boolean addAutocompletionContextForDollar(AutocompletionContext context)
       // (the completion is still occurring in a '$' context, so we do want
       // to exclude completions from other scopes)
       String data = "";
-      if (cursor.findStartOfEvaluationContext())
+      if (cursor.moveToPreviousToken() && cursor.findStartOfEvaluationContext())
       {
          data = editor.getTextForRange(Range.fromPoints(
                cursor.currentPosition(),

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1026,7 +1026,7 @@ private AutocompletionContext getAutocompletionContext()
          return new AutocompletionContext(token, AutocompletionContext.TYPE_HELP);
       
       // escape early for roxygen
-      if (firstLine.matches("\\s*#+'.*"))
+      if (firstLine.matches("\\s*#+'.*@.*"))
          return new AutocompletionContext(
                token, AutocompletionContext.TYPE_ROXYGEN);
       

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -109,6 +109,7 @@
 import org.rstudio.studio.client.workbench.views.console.model.ConsoleServerOperations;
 import org.rstudio.studio.client.workbench.views.console.shell.Shell;
 import org.rstudio.studio.client.workbench.views.console.shell.ShellPane;
+import org.rstudio.studio.client.workbench.views.console.shell.assist.HelpStrategy;
 import org.rstudio.studio.client.workbench.views.data.Data;
 import org.rstudio.studio.client.workbench.views.data.DataPane;
 import org.rstudio.studio.client.workbench.views.data.DataTab;
@@ -224,6 +225,7 @@ protected void configure()
       bind(ShortcutViewer.class).asEagerSingleton();
       bind(ShinyApps.class).asEagerSingleton();
       bind(RmdOutput.class).in(Singleton.class);
+      bind(HelpStrategy.class).in(Singleton.class);
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -55,6 +55,7 @@
 import org.rstudio.studio.client.workbench.model.RemoteFileSystemContext;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
+import org.rstudio.studio.client.workbench.views.console.shell.assist.HelpStrategy;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.RCompletionManager;
 import org.rstudio.studio.client.workbench.views.source.DocsMenu;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTargetCodeExecution;
@@ -121,4 +122,5 @@ public interface RStudioGinjector extends Ginjector
    Commands getCommands();
    UIPrefs getUIPrefs();
    Session getSession();
+   HelpStrategy getHelpStrategy();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsoleResources.java
Patch:
@@ -43,6 +43,8 @@ public interface ConsoleStyles extends CssResource
       String error();
       String selected();
       String paddedOutput();
+      String packageName();
+      String packageDescription();
    }
    
    public static final String KEYWORD_CLASS_NAME = " ace_keyword";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -30,6 +30,7 @@
 import org.rstudio.core.client.command.Handler;
 import org.rstudio.core.client.command.KeyboardShortcut;
 import org.rstudio.core.client.jsonrpc.RpcObjectList;
+import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.CommandLineHistory;
 import org.rstudio.studio.client.common.debugging.ErrorManager;
@@ -145,6 +146,7 @@ public Shell(ConsoleServerOperations server,
                                           null,
                                           null,
                                           (DocDisplay) view_.getInputEditorDisplay(),
+                                          RStudioGinjector.INSTANCE.getHelpStrategy(),
                                           false);
       addKeyDownPreviewHandler(completionManager) ;
       addKeyPressPreviewHandler(completionManager) ;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -426,6 +426,7 @@ private void updateLanguage(boolean suppressCompletion)
                   rContext_,
                   fileType_.canExecuteChunks() ? rnwContext_ : null,
                   this,
+                  RStudioGinjector.INSTANCE.getHelpStrategy(),
                   true);
             
             // if this is cpp then we use our own completion manager

File: src/gwt/src/org/rstudio/studio/client/common/icons/code/CodeIcons.java
Patch:
@@ -33,4 +33,5 @@ public interface CodeIcons extends ClientBundle
    ImageResource help();
    ImageResource rPackage();
    ImageResource file();
+   ImageResource macro();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/CppCompletion.java
Patch:
@@ -46,6 +46,7 @@ public static native final CppCompletion create(String typedText) /*-{
    public static final int ENUM = 8;
    public static final int ENUM_VALUE = 9;
    public static final int KEYWORD = 10;
+   public static final int MACRO = 11;
    
    public native final int getType() /*-{
        return this.type;
@@ -75,6 +76,8 @@ public final ImageResource getIcon()
          return icons.enumValue();
       case KEYWORD:
          return icons.keyword();
+      case MACRO:
+         return icons.macro();
       default:
          return icons.keyword();
       }

File: src/gwt/src/org/rstudio/studio/client/common/icons/StandardIcons.java
Patch:
@@ -37,6 +37,8 @@ public interface StandardIcons extends ClientBundle
    ImageResource lambda();
    ImageResource clazz();
    ImageResource anon();
+   ImageResource struct();
+   ImageResource enumeratedType();
    ImageResource git();
    ImageResource svn();
    ImageResource viewer_window();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/CompletionRequester.java
Patch:
@@ -517,7 +517,7 @@ private CompletionResult narrow(String diff)
       return new CompletionResult(
             token,
             newCompletions,
-            null,
+            "",
             cachedResult_.suggestOnAccept,
             cachedResult_.dontInsertParens) ;
    }

File: src/gwt/src/org/rstudio/studio/client/common/codetools/CodeToolsServerOperations.java
Patch:
@@ -41,6 +41,7 @@ void getCompletions(
          String functionCallString,
          JsArrayString chainAdditionalArgs,
          JsArrayString chainExcludeArgs,
+         boolean chainExcludeArgsFromObject,
          ServerRequestCallback<Completions> completions);
    
    void getDplyrJoinCompletions(

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -644,6 +644,7 @@ public void getCompletions(
          String functionCallString,
          JsArrayString additionalArgs,
          JsArrayString excludeArgs,
+         boolean excludeArgsFromObject,
          ServerRequestCallback<Completions> requestCallback)
    {
       JSONArray params = new JSONArray();
@@ -655,6 +656,7 @@ public void getCompletions(
       params.set(5, new JSONString(functionCallString));
       setArrayString(params, 6, additionalArgs);
       setArrayString(params, 7, excludeArgs);
+      params.set(8, JSONBoolean.getInstance(excludeArgsFromObject));
       
       sendRequest(RPC_SCOPE,
                   GET_COMPLETIONS,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -925,7 +925,7 @@ private AutoCompletionContext getAutocompletionContext()
       
       
       // Get the token at the cursor position
-      token = firstLine.replaceAll(".*[\\s\\(\\[\\{,]", "");
+      token = firstLine.replaceAll(".*[^a-zA-Z0-9._:]", "");
       
       // Default case for failure modes
       AutoCompletionContext defaultContext = new AutoCompletionContext(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -1129,7 +1129,7 @@ public void onResponseReceived(CompletionResult completions)
          if (results.length == 0)
          {
             boolean lastInputWasTab =
-                  (nativeEvent_ != null && nativeEvent_.getKeyCode() != KeyCodes.KEY_TAB);
+                  (nativeEvent_ != null && nativeEvent_.getKeyCode() == KeyCodes.KEY_TAB);
             
             boolean lineIsWhitespace = docDisplay_.getCurrentLine().matches("^\\s*$");
             

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -628,12 +628,12 @@ private AutoCompletionContext getAutocompletionContext()
       String firstLine = input_.getText();
       int row = input_.getCursorPosition().getRow();
       
-      // Default case for failure modes
-      AutoCompletionContext defaultContext = new AutoCompletionContext(firstLine, false);
-      
       // trim to cursor position
       firstLine = firstLine.substring(0, input_.getCursorPosition().getColumn());
       
+      // Default case for failure modes
+      AutoCompletionContext defaultContext = new AutoCompletionContext(firstLine, false);
+      
       // if we're on the first row, don't bother looking back
       if (row == 0)
          return defaultContext;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionPopupMenu.java
Patch:
@@ -64,7 +64,7 @@ public void setCompletions(JsArray<CppCompletion> completions,
       for (int i = 0; i<completions.length(); i++)
       {
          final CppCompletion completion = completions.get(i);
-         MenuItem menuItem = new MenuItem(completion.getText(), 
+         MenuItem menuItem = new MenuItem(completion.getTypedText(), 
                new ScheduledCommand() {
             @Override
             public void execute()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/cpp/CppCompletionRequest.java
Patch:
@@ -92,7 +92,7 @@ public void updateUI(boolean autoAccept)
          JsArray<CppCompletion> filtered = JsArray.createArray().cast();
          for (int i = 0; i < completions_.length(); i++)
          {
-            String completion = completions_.get(i).getText();
+            String completion = completions_.get(i).getTypedText();
             if ((entered.length() == 0) || completion.startsWith(entered))
                filtered.push(completions_.get(i));
          }
@@ -104,7 +104,7 @@ public void updateUI(boolean autoAccept)
          }
          // check for one completion that's already present
          else if (filtered.length() == 1 && 
-                  filtered.get(0).getText() == getReplacementToken())
+                  filtered.get(0).getTypedText() == getReplacementToken())
          {
             terminate();
          }
@@ -219,7 +219,7 @@ private void applyValue(CppCompletion completion)
      
       docDisplay_.setFocus(true); 
       docDisplay_.setSelection(getReplacementSelection());
-      docDisplay_.replaceSelection(completion.getText(), true) ; 
+      docDisplay_.replaceSelection(completion.getTypedText(), true) ; 
    }
    
    private InputEditorSelection getReplacementSelection()

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeResources.java
Patch:
@@ -192,5 +192,8 @@ public interface ThemeResources extends ClientBundle
    @Source("executingLine.png")
    DataResource executingLine();
    
+   @Source("macCheck.png")
+   DataResource macCheck();
+   
    ImageResource menuCheck();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchOracle.java
Patch:
@@ -18,7 +18,6 @@
 import java.util.Comparator;
 
 import org.rstudio.core.client.CodeNavigationTarget;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.DuplicateHelper;
 import org.rstudio.core.client.Invalidation;
 import org.rstudio.core.client.StringUtil;
@@ -97,7 +96,7 @@ private int scoreMatch(CodeSearchSuggestion suggestion, String query)
       if (suggestion.isFileTarget())
          result++;
       
-      Debug.logToConsole("Score for string '" + string + "' against query '" + query + "': " + result);
+      // Debug.logToConsole("Score for string '" + string + "' against query '" + query + "': " + result);
       return result;
    }
    

File: src/gwt/src/org/rstudio/studio/client/application/ui/ProjectPopupMenu.java
Patch:
@@ -37,6 +37,7 @@ public ProjectPopupMenu(SessionInfo sessionInfo, Commands commands)
       addSeparator();
       addItem(commands.openProject().createMenuItem(false));
       addItem(commands.openProjectInNewWindow().createMenuItem(false));
+      addItem(commands.closeProject().createMenuItem(false));
       addSeparator();
       addItem(commands.projectMru0().createMenuItem(false));
       addItem(commands.projectMru1().createMenuItem(false));
@@ -49,7 +50,7 @@ public ProjectPopupMenu(SessionInfo sessionInfo, Commands commands)
       addItem(commands.projectMru8().createMenuItem(false));
       addItem(commands.projectMru9().createMenuItem(false));
       addSeparator();
-      addItem(commands.closeProject().createMenuItem(false));
+      addItem(commands.clearRecentProjects().createMenuItem(false));
       addSeparator();
       addItem(commands.projectOptions().createMenuItem(false));
       

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/CppFileType.java
Patch:
@@ -28,7 +28,7 @@ public class CppFileType extends TextFileType
    {
       super(id, "C/C++", EditorLanguage.LANG_CPP, ext, icon,
             false, false, isCpp, false, false, false, 
-            false, false, false, false, false, false);
+            false, false, false, true, false, true);
       
       isCpp_ = isCpp;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/Packages.java
Patch:
@@ -651,7 +651,7 @@ public void loadPackage(final String packageName, final String libName)
       command.append(packageName);
       command.append("\"");
       command.append(", lib.loc=\"");
-      command.append(libName);
+      command.append(libName.replaceAll("\\\\", "\\\\\\\\"));
       command.append("\"");
       command.append(")");
       events_.fireEvent(new SendToConsoleEvent(command.toString(), true));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/Packages.java
Patch:
@@ -651,7 +651,7 @@ public void loadPackage(final String packageName, final String libName)
       command.append(packageName);
       command.append("\"");
       command.append(", lib.loc=\"");
-      command.append(libName);
+      command.append(libName.replaceAll("\\\\", "\\\\\\\\"));
       command.append("\"");
       command.append(")");
       events_.fireEvent(new SendToConsoleEvent(command.toString(), true));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/RCompletionManager.java
Patch:
@@ -731,7 +731,8 @@ public void onResponseReceived(CompletionResult completions)
          
          if (results.length == 0)
          {
-            if (nativeEvent_ != null && nativeEvent_.getKeyCode() != KeyCodes.KEY_TAB) {
+            if (docDisplay_ == null ||
+                  (nativeEvent_ != null && nativeEvent_.getKeyCode() != KeyCodes.KEY_TAB)) {
                popup_.showErrorMessage(
                      "(No matches)", 
                      new PopupPositioner(input_.getCursorBounds(), popup_));

File: src/gwt/src/org/rstudio/core/client/widget/ProgressDialog.java
Patch:
@@ -35,6 +35,7 @@
 import org.rstudio.core.client.Size;
 import org.rstudio.core.client.command.KeyboardShortcut;
 import org.rstudio.core.client.dom.DomMetrics;
+import org.rstudio.studio.client.application.Desktop;
 
 public abstract class ProgressDialog extends ModalDialogBase
 {
@@ -146,7 +147,7 @@ protected void unregisterHandlers()
    
    protected void setLabel(String text)
    {
-      if (BrowseCap.isChrome() || BrowseCap.isCocoaDesktop())
+      if (BrowseCap.isChrome() || Desktop.isDesktop())
       {
          Size labelSize = DomMetrics.measureHTML(text);
          labelCell_.getStyle().setWidth(labelSize.width + 10, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/PDFViewer.java
Patch:
@@ -214,7 +214,6 @@ private void openPdfUrl(final String url, final boolean synctex,
       int width = 1070;
       int height = 1200;
       Point pos = null;
-      final String pdfUrl = url.startsWith("/") ? url : "/" + url;
       
       // if there's a window open, restore the position when we're done
       if (restorePosition && 
@@ -234,7 +233,7 @@ private void openPdfUrl(final String url, final boolean synctex,
          @Override
          public void execute()
          {
-            pdfJsWindow_.openPdf(pdfUrl, 0, synctex);
+            pdfJsWindow_.openPdf(server_.getApplicationURL(url), 0, synctex);
             lastSuccessfulPdfUrl_ = url;
          }
       };

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -166,6 +166,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.profiler.model.ProfilerServerOperations;
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditor;
 import org.rstudio.studio.client.workbench.views.source.editors.text.DocDisplay;
+import org.rstudio.studio.client.workbench.views.source.model.CppServerOperations;
 import org.rstudio.studio.client.workbench.views.source.model.SourceServerOperations;
 import org.rstudio.studio.client.workbench.views.source.model.TexServerOperations;
 import org.rstudio.studio.client.workbench.views.vcs.VCSTab;
@@ -335,6 +336,7 @@ protected void configure()
       bind(RMarkdownServerOperations.class).to(RemoteServer.class);
       bind(DependencyServerOperations.class).to(RemoteServer.class);
       bind(PackratServerOperations.class).to(RemoteServer.class);
+      bind(CppServerOperations.class).to(RemoteServer.class);
 
       bind(WorkbenchMainView.class).to(WorkbenchScreen.class) ;
 

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -62,6 +62,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetCompilePdfHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetPresentationHelper;
 import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTargetRMarkdownHelper;
+import org.rstudio.studio.client.workbench.views.source.editors.text.cpp.CppCompletionRequest;
 import org.rstudio.studio.client.workbench.views.vcs.svn.SVNCommandHandler;
 import org.rstudio.studio.client.workbench.views.environment.ClearAllDialog;
 
@@ -94,6 +95,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(TextEditingTargetRMarkdownHelper rmarkdownHelper);
    void injectMembers(EditingTargetCodeExecution codeExecution);
    void injectMembers(LocalRepositoriesWidget localRepositoriesWidget);
+   void injectMembers(CppCompletionRequest request);
    
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -200,6 +200,8 @@ InputEditorSelection search(String needle,
    
    // HACK: InputEditorPosition should just become AceInputEditorPosition
    Position selectionToPosition(InputEditorPosition pos);
+   
+   InputEditorPosition createInputEditorPosition(Position pos);
 
    Iterable<Range> getWords(TokenPredicate tokenPredicate,
                             CharClassifier charClassifier,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2271,7 +2271,7 @@ private void doCommentUncomment(String c)
          // to comment out that line. This enables Shift+DownArrow to select
          // one line at a time.
          if (selection.endsWith("\n" + c + " "))
-            selection = selection.substring(0, selection.length() - 2);
+            selection = selection.substring(0, selection.length() - 1 - c.length());
       }
 
       docDisplay_.replaceSelection(selection);

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -61,6 +61,7 @@
    public abstract AppCommand executeNextChunk();
    public abstract AppCommand goToHelp();
    public abstract AppCommand rcppHelp();
+   public abstract AppCommand printCppCompletions();
    public abstract AppCommand goToFunctionDefinition();
    public abstract AppCommand sourceNavigateBack();
    public abstract AppCommand sourceNavigateForward();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -269,6 +269,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.checkSpelling());
       dynamicCommands_.add(commands.codeCompletion());
       dynamicCommands_.add(commands.rcppHelp());
+      dynamicCommands_.add(commands.printCppCompletions());
       dynamicCommands_.add(commands.debugBreakpoint());
       dynamicCommands_.add(commands.vcsViewOnGitHub());
       dynamicCommands_.add(commands.vcsBlameOnGitHub());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -40,6 +40,7 @@
 public interface SourceServerOperations extends FilesServerOperations, 
                                                 CodeToolsServerOperations,
                                                 CodeSearchServerOperations,
+                                                CppServerOperations,
                                                 TexServerOperations,
                                                 HTMLPreviewServerOperations,
                                                 BuildServerOperations,

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -77,7 +77,7 @@ public final Size getPreferredSize()
       if (format.equals(RmdOutputFormat.OUTPUT_IOSLIDES_PRESENTATION) ||
           format.equals(RmdOutputFormat.OUTPUT_SLIDY_PRESENTATION))
          return new Size(1100, 900 + chromeHeight);
-      if (format.equals(RmdOutputFormat.OUTPUT_REVEALJS_PRESENTATION))
+      if (format.endsWith(RmdOutputFormat.OUTPUT_REVEALJS_PRESENTATION))
          return new Size(960, 700 + chromeHeight);
       
       // default size (html_document and others)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/export/SaveViewerPlotAsImageDesktopDialog.java
Patch:
@@ -33,7 +33,7 @@ public SaveViewerPlotAsImageDesktopDialog(
                      OperationWithInput<ExportPlotOptions> onClose)
    {
       super(globalDisplay, 
-            new ViewerPaneSaveAsImageDesktopOperation(globalDisplay), 
+            new ViewerPaneSaveAsImageDesktopOperation(), 
             new ViewerPanePreviewer(viewerUrl), 
             context, 
             options, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -432,11 +432,11 @@ else if ((ne.getKeyCode() == KeyCodes.KEY_ESCAPE) &&
                event.stopPropagation();
                commands_.interruptR().execute();
             }
-            else if (ne.getKeyCode() == KeyCodes.KEY_M &&
+            else if (ne.getKeyCode() == KeyCodes.KEY_M && (
                   (BrowseCap.hasMetaKey() &&
                    mod == (KeyboardShortcut.META + KeyboardShortcut.SHIFT)) ||
                   (!BrowseCap.hasMetaKey() &&
-                   mod == (KeyboardShortcut.CTRL + KeyboardShortcut.SHIFT)))
+                   mod == (KeyboardShortcut.CTRL + KeyboardShortcut.SHIFT))))
             {
                event.preventDefault();
                event.stopPropagation();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -432,11 +432,11 @@ else if ((ne.getKeyCode() == KeyCodes.KEY_ESCAPE) &&
                event.stopPropagation();
                commands_.interruptR().execute();
             }
-            else if (ne.getKeyCode() == KeyCodes.KEY_M &&
+            else if (ne.getKeyCode() == KeyCodes.KEY_M && (
                   (BrowseCap.hasMetaKey() &&
                    mod == (KeyboardShortcut.META + KeyboardShortcut.SHIFT)) ||
                   (!BrowseCap.hasMetaKey() &&
-                   mod == (KeyboardShortcut.CTRL + KeyboardShortcut.SHIFT)))
+                   mod == (KeyboardShortcut.CTRL + KeyboardShortcut.SHIFT))))
             {
                event.preventDefault();
                event.stopPropagation();

File: src/gwt/src/org/rstudio/core/client/widget/FixedTextArea.java
Patch:
@@ -12,6 +12,7 @@ public FixedTextArea(int numVisibleLines, int charWidth) {
       setVisibleLines(numVisibleLines);
       setCharacterWidth(charWidth);
       addStyleName(ThemeStyles.INSTANCE.notResizable());
+      getElement().setAttribute("spellcheck", "false");
    }
    
 }

File: src/gwt/src/org/rstudio/studio/client/projects/model/RProjectPackratOptions.java
Patch:
@@ -28,8 +28,8 @@ public native static final RProjectPackratOptions createEmpty() /*-{
       options.vcs_ignore_lib = true;
       options.vcs_ignore_src = false;
       options.use_cache = false;
-      options.external_packages = [];
-      options.local_repos = [];
+      options.external_packages = "";
+      options.local_repos = "";
       return options;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/RmdOutput.java
Patch:
@@ -17,7 +17,6 @@
 import java.util.Map;
 import java.util.HashMap;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.dom.WindowEx;
 import org.rstudio.core.client.files.FileSystemItem;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdRenderResult.java
Patch:
@@ -97,7 +97,7 @@ public final native boolean hasShinyContent() /*-{
 
    public final boolean isHtmlPresentation()
    {
-      return isHtml() && getFormatName().endsWith(
+      return (isShinyDocument() || isHtml()) && getFormatName().endsWith(
                   RmdOutputFormat.OUTPUT_PRESENTATION_SUFFIX);
    }
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -73,7 +73,6 @@
 import org.rstudio.studio.client.notebook.CompileNotebookResult;
 import org.rstudio.studio.client.packrat.model.PackratContext;
 import org.rstudio.studio.client.packrat.model.PackratPrerequisites;
-import org.rstudio.studio.client.packrat.model.PackratPackageAction;
 import org.rstudio.studio.client.packrat.model.PackratStatus;
 import org.rstudio.studio.client.projects.model.NewPackageOptions;
 import org.rstudio.studio.client.projects.model.NewProjectContext;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -56,7 +56,6 @@
 import com.google.gwt.event.logical.shared.ValueChangeHandler;
 import com.google.gwt.safehtml.shared.SafeHtmlBuilder;
 import com.google.gwt.user.cellview.client.AbstractCellTable;
-import com.google.gwt.user.cellview.client.AbstractHeaderOrFooterBuilder;
 import com.google.gwt.user.cellview.client.Column;
 import com.google.gwt.user.cellview.client.DataGrid;
 import com.google.gwt.user.cellview.client.DefaultCellTableBuilder;

File: src/gwt/src/org/rstudio/studio/client/packrat/ui/PackratActionDialog.java
Patch:
@@ -58,7 +58,7 @@ public static void ensureStylesInjected()
       try
       {
          JsArray<PackratPackageAction> actions = JsArray.createArray().cast();
-         new PackratActionDialogContents(actions);
+         new PackratActionDialogContents("", actions);
       }
       catch(Exception e)
       { 

File: src/gwt/src/org/rstudio/studio/client/packrat/model/PackratServerOperations.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.server.ServerRequestCallback;
+import org.rstudio.studio.client.workbench.views.packages.model.PackageInfo;
 
 import com.google.gwt.core.client.JsArray;
 
@@ -28,11 +29,10 @@ void getPackratStatus(String dir,
    
    void packratBootstrap(String dir,
                          ServerRequestCallback<Void> requestCallback);
-                         ServerRequestCallback<PackratContext> requestCallback);
    
    void getPackratRestoreActions(String dir,
                                  ServerRequestCallback<JsArray<PackratRestoreActions>> requestCallback);
 
    void listPackagesPackrat(String dir,
-                            ServerRequestCallback<JsArray<PackratPackageInfo>> requestCallback);
+                            ServerRequestCallback<JsArray<PackageInfo>> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -116,6 +116,7 @@
 import org.rstudio.studio.client.workbench.views.files.model.FileUploadToken;
 import org.rstudio.studio.client.workbench.views.help.model.HelpInfo;
 import org.rstudio.studio.client.workbench.views.history.model.HistoryEntry;
+import org.rstudio.studio.client.workbench.views.packages.model.PackageInfo;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageInstallContext;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageState;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageUpdate;
@@ -3496,7 +3497,7 @@ public void getPackratRestoreActions(String dir,
 
    @Override
    public void listPackagesPackrat(String dir,
-           ServerRequestCallback<JsArray<PackratPackageInfo>> requestCallback)
+           ServerRequestCallback<JsArray<PackageInfo>> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(dir));
@@ -3807,4 +3808,5 @@ public void listPackagesPackrat(String dir,
    private static final String GET_PACKRAT_STATUS = "get_packrat_status";
    private static final String GET_PACKRAT_RESTORE_ACTIONS="get_packrat_restore_actions";
    private static final String PACKRAT_BOOTSTRAP = "packrat_bootstrap";
+   private static final String LIST_PACKAGES_PACKRAT = "list_packages_packrat";
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -40,6 +40,7 @@
 import org.rstudio.studio.client.workbench.views.packages.model.PackageInstallOptions;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageInstallRequest;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageLibraryUtils;
+import org.rstudio.studio.client.workbench.views.packages.model.PackageLibraryUtils.PackageLibraryType;
 import org.rstudio.studio.client.workbench.views.packages.model.PackageStatus;
 import org.rstudio.studio.client.workbench.views.packages.model.PackagesServerOperations;
 import org.rstudio.studio.client.workbench.views.packages.ui.InstallPackageDialog;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/PackagesPane.java
Patch:
@@ -66,7 +66,6 @@
 import com.google.gwt.user.client.Timer;
 import com.google.gwt.user.client.ui.AbstractImagePrototype;
 import com.google.gwt.user.client.ui.ResizeLayoutPanel;
-import com.google.gwt.user.client.ui.SimplePanel;
 import com.google.gwt.user.client.ui.SuggestOracle;
 import com.google.gwt.user.client.ui.Widget;
 import com.google.gwt.view.client.ListDataProvider;

File: src/gwt/src/org/rstudio/studio/client/packrat/model/PackratServerOperations.java
Patch:
@@ -16,7 +16,6 @@
 
 import org.rstudio.studio.client.common.packrat.model.PackratContext;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.Void;
 
 import com.google.gwt.core.client.JsArray;
 

File: src/gwt/src/org/rstudio/studio/client/packrat/ui/IGetValue.java
Patch:
@@ -1,5 +1,6 @@
 package org.rstudio.studio.client.packrat.ui;
 
-public interface IGetValue {
+public interface IGetValue 
+{
    String getValue(String key);
 }

File: src/gwt/src/org/rstudio/studio/client/projects/model/NewProjectResult.java
Patch:
@@ -45,7 +45,8 @@ public boolean getCreateGitRepo()
       return createGitRepo_;
    }
    
-   public boolean getUsePackrat() {
+   public boolean getUsePackrat() 
+   {
       return usePackrat_;
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/PackagesCellTableResources.java
Patch:
@@ -27,6 +27,7 @@ public interface PackagesCellTableResources extends CellTable.Resources
    interface PackagesCellTableStyle extends CellTable.Style
    {
       String libraryHeader();
+      String packageTableHeader();
    }
   
    @Source({RStudioCellTableStyle.RSTUDIO_DEFAULT_CSS, "PackagesCellTableStyle.css"})

File: src/gwt/src/org/rstudio/studio/client/common/shiny/model/ShinyAppsServerOperations.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.shiny.model.ShinyAppsApplicationInfo;
+import org.rstudio.studio.client.shiny.model.ShinyAppsDeploymentFiles;
 import org.rstudio.studio.client.shiny.model.ShinyAppsDeploymentRecord;
 
 import com.google.gwt.core.client.JsArray;
@@ -40,7 +41,7 @@ void getShinyAppsDeployments(String dir,
                ServerRequestCallback<JsArray<ShinyAppsDeploymentRecord>> requestCallback); 
    
    void getDeploymentFiles (String dir, 
-               ServerRequestCallback<JsArrayString> requestCallback);
+               ServerRequestCallback<ShinyAppsDeploymentFiles> requestCallback);
    
    void deployShinyApp(String dir, String file, String account, String appName, 
                ServerRequestCallback<Boolean> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -71,6 +71,7 @@
 import org.rstudio.studio.client.server.*;
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.shiny.model.ShinyAppsApplicationInfo;
+import org.rstudio.studio.client.shiny.model.ShinyAppsDeploymentFiles;
 import org.rstudio.studio.client.shiny.model.ShinyAppsDeploymentRecord;
 import org.rstudio.studio.client.shiny.model.ShinyRunCmd;
 import org.rstudio.studio.client.shiny.model.ShinyViewerType;
@@ -3269,7 +3270,7 @@ public void deployShinyApp(String dir, String file, String account,
 
    @Override
    public void getDeploymentFiles(String dir,
-         ServerRequestCallback<JsArrayString> requestCallback)
+         ServerRequestCallback<ShinyAppsDeploymentFiles> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(dir));

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -2907,7 +2907,7 @@ public void getCppCapabilities(
    
    @Override
    public void installBuildTools(String action, 
-                                 ServerRequestCallback<Void> callback)
+                                 ServerRequestCallback<Boolean> callback)
    {
       sendRequest(RPC_SCOPE, INSTALL_BUILD_TOOLS, action, callback);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCppHelper.java
Patch:
@@ -18,7 +18,6 @@
 import org.rstudio.studio.client.common.filetypes.TextFileType;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
-import org.rstudio.studio.client.server.VoidServerRequestCallback;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildServerOperations;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTarget;
 import org.rstudio.studio.client.workbench.views.source.model.CppCapabilities;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -475,7 +475,7 @@ else if (filespec.length() == 0)
          assert filespec.indexOf("*") < 0 : "Unexpected filespec format";
          fileTypesByFilename_.put(filespec.toLowerCase(), fileType);
          if (icon != null)
-            iconsByFileExtension_.put(filespec.toLowerCase(), icon);
+            iconsByFilename_.put(filespec.toLowerCase(), icon);
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -67,8 +67,6 @@
 import org.rstudio.studio.client.rmarkdown.model.RmdFrontMatter;
 import org.rstudio.studio.client.rmarkdown.model.RmdOutputFormat;
 import org.rstudio.studio.client.rmarkdown.model.RmdTemplateData;
-import org.rstudio.studio.client.rmarkdown.model.RmdYamlData;
-import org.rstudio.studio.client.rmarkdown.model.YamlFrontMatter;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.VoidServerRequestCallback;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2405,7 +2405,7 @@ private void applyRmdFrontMatter(String yaml)
       String newCode = YamlFrontMatter.applyFrontMatter(code, yaml);
       if (!code.equals(newCode)) 
       {
-         docDisplay_.setCode(code, true);
+         docDisplay_.setCode(newCode, true);
          updateRmdFormatList();
       }
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -879,6 +879,7 @@ public void execute(RMarkdownContext context)
             {
                new NewRMarkdownDialog(
                   context,
+                  workbenchContext_,
                   uiPrefs_.documentAuthor().getGlobalValue(),
                   new OperationWithInput<NewRMarkdownDialog.Result>()
                   {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFrameItem.java
Patch:
@@ -153,7 +153,7 @@ private String getFrameLabel()
       }
       if (frame_.getShinyFunctionLabel().isEmpty())
       {
-         return frame_.getFunctionName() + "(" + frame_.getArgumentList() + ")";
+         return frame_.getCallSummary();
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -223,9 +223,9 @@ public void setEnvironmentName(String environmentName, boolean local)
    }
 
    @Override
-   public void setCallFrames(JsArray<CallFrame> frameList)
+   public void setCallFrames(JsArray<CallFrame> frameList, boolean autoSize)
    {
-      objects_.setCallFrames(frameList);
+      objects_.setCallFrames(frameList, autoSize);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdPreviewParams.java
Patch:
@@ -77,6 +77,6 @@ public final Size getPreferredSize()
          return new Size(960, 700 + chromeHeight);
       
       // default size (html_document and others)
-      return new Size(990, 1000 + chromeHeight);
+      return new Size(1020, 1000 + chromeHeight);
    }
 }

File: src/gwt/src/org/rstudio/core/client/command/ShortcutManager.java
Patch:
@@ -183,7 +183,7 @@ private boolean handleKeyDown(NativeEvent e)
          e.preventDefault();
 
          if (enabled)
-            command.execute();
+            command.executeFromShortcut();
       }
 
       return command != null;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -27,6 +27,7 @@
 import org.rstudio.core.client.files.FileSystemContext;
 import org.rstudio.studio.client.common.ReadOnlyValue;
 import org.rstudio.studio.client.common.filetypes.FileType;
+import org.rstudio.studio.client.common.filetypes.TextFileType;
 import org.rstudio.studio.client.workbench.model.UnsavedChangesTarget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.Position;
 import org.rstudio.studio.client.workbench.views.source.model.SourceDocument;
@@ -51,6 +52,8 @@ public interface EditingTarget extends IsWidget,
    String getContext();
    ImageResource getIcon();
    String getTabTooltip();
+   
+   TextFileType getTextFileType();
 
    void adaptToExtendedFileType(String extendedType);
    String getExtendedFileType();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdDiscoveredTemplateItem.java
Patch:
@@ -28,7 +28,7 @@ public RmdDiscoveredTemplateItem(RmdDiscoveredTemplate template)
    {
       template_ = template;
       panel_ = new HTMLPanel("");
-      Label pkg = new Label(template.getPackage());
+      Label pkg = new Label("{" + template.getPackage() + "}");
       pkg.getElement().getStyle().setFloat(Style.Float.RIGHT);
       pkg.getElement().getStyle().setColor("#909090");
       panel_.add(pkg);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -213,7 +213,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.rpres", RPRESENTATION, icons.iconRpresentation());
       register("*.md", MARKDOWN, icons.iconMarkdown());
       register("*.mdtxt", MARKDOWN, icons.iconMarkdown());
-      register("*.markdown", MARKDOWN, icons.iconMarkdown());
+      register("*.markdown*", MARKDOWN, icons.iconMarkdown());
       register("*.bib", TEXT, icons.iconText());
       register("*.c", C, icons.iconC());
       register("*.cpp", CPP, icons.iconCpp());

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/RmdOutput.java
Patch:
@@ -154,7 +154,8 @@ else if (".html".equals(extension))
       {
          displayHTMLRenderResult(result);
       }
-      else if (".md".equals(extension))
+      else if (".md".equals(extension) || 
+               extension.toLowerCase().startsWith(".markdown"))
       {
          ViewFilePanel viewFilePanel = pViewFilePanel_.get();
          viewFilePanel.showFile(

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RMarkdownServerOperations.java
Patch:
@@ -47,7 +47,7 @@ void convertToYAML(JavaScriptObject input,
    void convertFromYAML(String input, 
                         ServerRequestCallback<RmdYamlData> requestCallback);
 
-   void discoverRmdTemplates(ServerRequestCallback<Void> requestCallback);
+   void discoverRmdTemplates(ServerRequestCallback<Boolean> requestCallback);
    
    public String getApplicationURL(String pathName);
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -103,7 +103,7 @@ class ClientEvent extends JavaScriptObject
    public static final String RmdRenderOutput = "rmd_render_output";
    public static final String RmdRenderCompleted = "rmd_render_completed";
    public static final String RmdTemplateDiscovered = "rmd_template_discovered";
-   public static final String RmdTemplateDiscoveryComplete = "rmd_template_discovery_complete";
+   public static final String RmdTemplateDiscoveryCompleted = "rmd_template_discovery_completed";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -562,7 +562,7 @@ else if (type.equals(ClientEvent.RmdTemplateDiscovered))
             RmdDiscoveredTemplate template = event.getData();
             eventBus_.fireEvent(new RmdTemplateDiscoveredEvent(template));
          }
-         else if (type.equals(ClientEvent.RmdTemplateDiscoveryComplete))
+         else if (type.equals(ClientEvent.RmdTemplateDiscoveryCompleted))
          {
             eventBus_.fireEvent(new RmdTemplateDiscoveryCompletedEvent());
          }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -3297,7 +3297,7 @@ public void convertFromYAML(String yaml,
 
    @Override
    public void discoverRmdTemplates(
-         ServerRequestCallback<Void> requestCallback)
+         ServerRequestCallback<Boolean> requestCallback)
    {
       sendRequest(RPC_SCOPE,
             DISCOVER_RMD_TEMPLATES,

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -395,9 +395,9 @@ public static void disableNoHandlerAssertions()
    private boolean checked_ = false;
    private final HandlerManager handlers_ = new HandlerManager(this);
 
-   private String label_;
-   private String buttonLabel_;
-   private String menuLabel_;
+   private String label_ = null;
+   private String buttonLabel_ = null;
+   private String menuLabel_ = null;
    private String desc_;
    private ImageResource imageResource_;
    private KeyboardShortcut shortcut_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/assist/HelpStrategy.java
Patch:
@@ -141,12 +141,12 @@ public void showHelp(QualifiedName qname,
       {
          String selectedItem = qname.name ;
          
-         if (selectedItem.endsWith("="))
+         if (selectedItem.endsWith(" = "))
          {
             assert StringUtil.isNullOrEmpty(qname.pkgName)
                               : "Completion parameter had a package name!? " +
                                 qname.pkgName + "::" + qname.name;
-            selectedItem = selectedItem.substring(0, selectedItem.length() - 1) ;
+            selectedItem = selectedItem.substring(0, selectedItem.length() - 3) ;
             
             parameter_ = selectedItem ;
             if (helpInfo_ != null)

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeCommands.java
Patch:
@@ -79,22 +79,23 @@ public TextFileType[] statusBarFileTypes()
    {
       ArrayList<TextFileType> types = new ArrayList<TextFileType>();
       types.add(FileTypeRegistry.R);
-      types.add(FileTypeRegistry.SWEAVE);
       types.add(FileTypeRegistry.RMARKDOWN);
+      types.add(FileTypeRegistry.SWEAVE);
       types.add(FileTypeRegistry.RHTML);
       types.add(FileTypeRegistry.RPRESENTATION);
       types.add(FileTypeRegistry.RD);
       types.add(FileTypeRegistry.TEXT);
-      types.add(FileTypeRegistry.DCF);
       types.add(FileTypeRegistry.TEX);
       types.add(FileTypeRegistry.MARKDOWN);
+      types.add(FileTypeRegistry.DCF);
       types.add(FileTypeRegistry.SH);
       types.add(FileTypeRegistry.HTML);
       types.add(FileTypeRegistry.CSS);
       types.add(FileTypeRegistry.JS);
       types.add(FileTypeRegistry.CPP);
       types.add(FileTypeRegistry.PYTHON);
       types.add(FileTypeRegistry.SQL);
+
       
       return (TextFileType[])types.toArray(new TextFileType[0]);
    }

File: src/gwt/src/org/rstudio/studio/client/notebook/CompileNotebookOptionsDialog.java
Patch:
@@ -158,7 +158,7 @@ private String getType()
    
    private String getFormat()
    {
-      return "pdf_document";
+      return "html_document";
    }
    
    private void setType(String type)

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/PDFViewer.java
Patch:
@@ -161,7 +161,7 @@ public void onPdfJsWindowClosed(PdfJsWindowClosedEvent event)
    @Override
    public void onWindowOpened(WindowOpenedEvent event)
    {
-      if (event.getName().equals(WINDOW_NAME + "_minimal"))
+      if (event.getName().equals(WINDOW_NAME))
       {
          completePdfJsWindowLoad(event.getWindow());
       }

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -360,6 +360,7 @@ public final native StatusAndPathInfo getSVNStatus() /*-{
       MIME_TYPES.put( "mml",   "text/mathml" );
       MIME_TYPES.put( "log",   "text/plain");
       MIME_TYPES.put( "out",   "text/plain");
+      MIME_TYPES.put( "csl",   "text/x-csl");
       MIME_TYPES.put( "r",     "text/x-r-source");
       MIME_TYPES.put( "rd",    "text/x-r-doc");
       MIME_TYPES.put( "rnw",   "text/x-r-sweave");

File: src/gwt/src/org/rstudio/studio/client/common/synctex/Synctex.java
Patch:
@@ -209,9 +209,7 @@ public void onError(ServerError error)
       // use internal viewer
       else
       {
-         // execute the forward search
          doForwardSearch(targetFile_, sourceLocation);
-     
          return true;
       }
    }

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/PDFViewer.java
Patch:
@@ -72,6 +72,7 @@ public void onShowPDFViewer(ShowPDFViewerEvent event)
             public void execute(WindowEx win)
             {
                pdfJsWindow_ = win.cast();
+               pdfJsWindow_.injectUiOnLoad();
             }
          });
          display_.openMinimalWindow(url, false, 1000, 1000, options);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRMarkdownDialog.java
Patch:
@@ -20,8 +20,6 @@
 import org.rstudio.core.client.widget.ModalDialog;
 import org.rstudio.core.client.widget.OperationWithInput;
 import org.rstudio.core.client.widget.WidgetListBox;
-import org.rstudio.studio.client.RStudioGinjector;
-import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.rmarkdown.model.RMarkdownContext;
 import org.rstudio.studio.client.rmarkdown.model.RmdFrontMatter;
 import org.rstudio.studio.client.rmarkdown.model.RmdFrontMatterOutputOptions;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdOutputFormat.java
Patch:
@@ -33,6 +33,9 @@ public native final String getFormatName() /*-{
    // value to "Boolean", which fails since it's an unboxed native value. 
    public native final boolean getFormatOption(String option, 
                                                boolean defaultValue) /*-{
+      if (typeof this.format_options === "undefined" ||
+          this.format_options === null)
+          return defaultValue;
       var optionValue = this.format_options[option];
       if (typeof optionValue === "undefined")
          return defaultValue;

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPanel.java
Patch:
@@ -86,6 +86,7 @@ public void showOutput(RmdPreviewParams params, boolean enablePublish,
       // RPubs
       boolean showPublish = enablePublish && 
                             params.getResult().isHtml() &&
+                            params.getResult().getFormat() != null &&
                             params.getResult().getFormat().isSelfContained();
       publishButton_.setText(params.getResult().getRpubsPublished() ? 
             "Republish" : "Publish");

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdTemplateOptionsDialog.java
Patch:
@@ -43,7 +43,8 @@ public RmdTemplateOptionsDialog(RmdTemplate template,
          OperationWithInput<RmdTemplateOptionsDialog.Result> onSaved,
          Operation onCancelled)
    {
-      super("Edit R Markdown Format Options", onSaved, onCancelled);
+      super("Edit R Markdown " + template.getName() + " Options", 
+            onSaved, onCancelled);
       setWidth("350px");
       setHeight("400px");
       templateOptions_ = new RmdTemplateOptionsWidget();

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/model/RmdTemplateData.java
Patch:
@@ -29,7 +29,7 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
             format_options: [ "toc", "theme", "highlight", "fig_width", 
                               "fig_height", "fig_caption", "smart", 
                               "self_contained" ],
-            format_notes: "HTML is recommended for authoring. You can switch to PDF or Word anytime."
+            format_notes: "Recommended format for authoring (you can switch to PDF or Word output anytime)."
             },
             {
             format_name: "pdf_document", 
@@ -164,7 +164,7 @@ public static native JsArray<RmdTemplate> getTemplates() /*-{
                               "smaller", "fig_width", "fig_height", 
                               "fig_caption", "highlight", "self_contained",
                               "smart" ],
-            format_notes: "Recommended format for HTML presentations. You can also print ioslides to PDF with Chrome."
+            format_notes: "Recommended format for HTML presentations (you can also print ioslides to PDF with Chrome)."
             },
             {
             format_name: "revealjs_presentation",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRmdBooleanOption.java
Patch:
@@ -17,12 +17,12 @@
 import org.rstudio.studio.client.rmarkdown.model.RmdTemplateFormatOption;
 
 import com.google.gwt.user.client.ui.CheckBox;
-import com.google.gwt.user.client.ui.Composite;
 
-public class NewRmdBooleanOption extends Composite implements NewRmdFormatOption
+public class NewRmdBooleanOption extends NewRmdBaseOption
 {
    public NewRmdBooleanOption(RmdTemplateFormatOption option)
    {
+      super(option);
       checkBox_ = new CheckBox(option.getUiName());
       defaultValue_ = Boolean.parseBoolean(option.getDefaultValue());
       checkBox_.setValue(defaultValue_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRmdChoiceOption.java
Patch:
@@ -17,15 +17,15 @@
 import org.rstudio.studio.client.rmarkdown.model.RmdTemplateFormatOption;
 
 import com.google.gwt.core.client.JsArrayString;
-import com.google.gwt.user.client.ui.Composite;
 import com.google.gwt.user.client.ui.HTMLPanel;
 import com.google.gwt.user.client.ui.InlineLabel;
 import com.google.gwt.user.client.ui.ListBox;
 
-public class NewRmdChoiceOption extends Composite implements NewRmdFormatOption
+public class NewRmdChoiceOption extends NewRmdBaseOption
 {
    public NewRmdChoiceOption(RmdTemplateFormatOption option)
    {
+      super(option);
       HTMLPanel panel = new HTMLPanel("");
       defaultValue_ = option.getDefaultValue();
       panel.add(new InlineLabel(option.getUiName() + ":"));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ui/NewRmdFormatOption.java
Patch:
@@ -14,10 +14,13 @@
  */
 package org.rstudio.studio.client.workbench.views.source.editors.text.ui;
 
+import org.rstudio.studio.client.rmarkdown.model.RmdTemplateFormatOption;
+
 import com.google.gwt.user.client.ui.IsWidget;
 
 public interface NewRmdFormatOption extends IsWidget
 {
    boolean valueIsDefault();
    String getValue();
+   RmdTemplateFormatOption getOption();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -94,7 +94,6 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.SourceOnSaveChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.SourceOnSaveChangedHandler;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.NewRMarkdownDialog;
-import org.rstudio.studio.client.workbench.views.source.editors.text.ui.NewRMarkdownDialog.Result;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ui.NewRdDialog;
 import org.rstudio.studio.client.workbench.views.source.events.*;
 import org.rstudio.studio.client.workbench.views.source.model.ContentItem;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -632,8 +632,9 @@ public void initialize(SourceDocument document,
       fileType_ = (TextFileType) type;
       
       extendedType_ = document.getExtendedType();
-      extendedType_ = rmarkdownHelper_.detectExtendedType(extendedType_, 
-                                                            fileType_);
+      extendedType_ = rmarkdownHelper_.detectExtendedType(document.getContents(),
+                                                          extendedType_, 
+                                                          fileType_);
       
       view_ = new TextEditingTargetWidget(commands_,
                                           prefs_,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetRMarkdownHelper.java
Patch:
@@ -52,11 +52,13 @@ public void initialize(Session session,
       server_ = server;
    }
    
-   public String detectExtendedType(String extendedType,
+   public String detectExtendedType(String contents,
+                                    String extendedType,
                                     TextFileType fileType)
    {
       if (extendedType.length() == 0 && 
           fileType.isMarkdown() &&
+          !contents.contains("<!-- rmarkdown v1 -->") && 
           session_.getSessionInfo().getRMarkdownPackageAvailable())
       {
          return "rmarkdown";

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/dialog/CompilePdfProgressDialog.java
Patch:
@@ -104,7 +104,7 @@ protected Widget createDisplayWidget(Object param)
    @Override
    public void onCompilePdfOutput(CompilePdfOutputEvent event)
    {
-      output_.append(event.getOutput());
+      output_.append(event.getOutput().getOutput());
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -349,7 +349,7 @@ else if (type.equals(ClientEvent.CompilePdfStartedEvent))
          }
          else if (type.equals(ClientEvent.CompilePdfOutputEvent))
          {
-            String output = event.getData();
+            CompileOutput output = event.getData();
             eventBus_.fireEvent(new CompilePdfOutputEvent(output));
          }
          else if (type.equals(ClientEvent.CompilePdfErrorsEvent))
@@ -546,7 +546,7 @@ else if (type.equals(ClientEvent.RmdRenderStarted))
          }
          else if (type.equals(ClientEvent.RmdRenderOutput))
          {
-            String data = event.getData();
+            CompileOutput data = event.getData();
             eventBus_.fireEvent(new RmdRenderOutputEvent(data));
          }
          else if (type.equals(ClientEvent.RmdRenderCompleted))

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/common/CompileOutputPaneDisplay.java
Patch:
@@ -18,6 +18,7 @@
 import org.rstudio.core.client.events.HasEnsureHiddenHandlers;
 import org.rstudio.core.client.events.HasSelectionCommitHandlers;
 import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.compile.CompileOutput;
 import org.rstudio.studio.client.workbench.WorkbenchView;
 
 import com.google.gwt.core.client.JsArray;
@@ -27,7 +28,7 @@ public interface CompileOutputPaneDisplay extends WorkbenchView, HasEnsureHidden
 {
    void ensureVisible(boolean activate);
    void compileStarted(String text);
-   void showOutput(String output);
+   void showOutput(CompileOutput output);
    void showErrors(JsArray<CompileError> errors);
    void clearAll();
    void compileCompleted();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/CompilePdfOutputPresenter.java
Patch:
@@ -28,6 +28,7 @@
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.studio.client.common.DelayedProgressRequestCallback;
 import org.rstudio.studio.client.common.GlobalDisplay;
+import org.rstudio.studio.client.common.compile.CompileOutput;
 import org.rstudio.studio.client.common.compilepdf.events.CompilePdfCompletedEvent;
 import org.rstudio.studio.client.common.compilepdf.events.CompilePdfErrorsEvent;
 import org.rstudio.studio.client.common.compilepdf.events.CompilePdfOutputEvent;
@@ -110,7 +111,8 @@ public void initialize(CompilePdfState compilePdfState)
       
       compileStarted(compilePdfState.getTargetFile());
       
-      view_.showOutput(compilePdfState.getOutput());
+      view_.showOutput(CompileOutput.create(CompileOutput.kNormal,
+                                            compilePdfState.getOutput()));
       
       if (compilePdfState.getErrors().length() > 0)
          view_.showErrors(compilePdfState.getErrors());    

File: src/gwt/src/org/rstudio/studio/client/rmarkdown/ui/RmdOutputPresenter.java
Patch:
@@ -58,7 +58,7 @@ public Widget asWidget()
    @Handler
    public void onViewerPopout()
    {
-      globalDisplay_.openWindow(result_.getOutputFile());
+      globalDisplay_.showHtmlFile(result_.getOutputFile());
    }
 
    public void showOutput(RmdRenderResult result) 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -142,7 +142,7 @@ public void onClick(ClickEvent event)
       if (session_.getSessionInfo().getHaveSrcrefAttribute())
       {
 	      add(checkboxPref(
-	            "Use debug error handler only when errors contain my code", 
+	            "Use debug error handler only when my code contains errors", 
 	            prefs_.handleErrorsInUserCodeOnly()));
 	      CheckBox chkTracebacks = checkboxPref(
 	            "Automatically expand tracebacks in error inspector", 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -142,7 +142,7 @@ public void onClick(ClickEvent event)
       if (session_.getSessionInfo().getHaveSrcrefAttribute())
       {
 	      add(checkboxPref(
-	            "Use debug error handler only when errors contain my code", 
+	            "Use debug error handler only when my code contains errors", 
 	            prefs_.handleErrorsInUserCodeOnly()));
 	      CheckBox chkTracebacks = checkboxPref(
 	            "Automatically expand tracebacks in error inspector", 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2774,7 +2774,9 @@ void onKnitToHTML()
    @Handler
    void onPreviewHTML()
    {
-      if (fileType_.isRd())
+      if (extendedType_ == "rmarkdown")
+         globalDisplay_.showMessage(GlobalDisplay.MSG_INFO, "NYI", "Markdown render here.");
+      else if (fileType_.isRd())
          previewRd();
       else if (fileType_.isRpres())
          previewRpresentation();

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -98,6 +98,7 @@ class ClientEvent extends JavaScriptObject
    public static final String UpdateCheck = "update_check";
    public static final String SourceExtendedTypeDetected = "source_extended_type_detected";
    public static final String ShinyViewer = "shiny_viewer";
+   public static final String DebugSourceCompleted = "debug_source_completed";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -906,8 +906,8 @@ else if (breakpoint.isPackageBreakpoint())
          String message = "";
          if (hasDebugPendingBreakpoints) 
          {
-            message = "Breakpoints will be activated when the function is " +
-                      "finished running.";
+            message = "Breakpoints will be activated when the file or " +
+                      "function is finished executing.";
          }
          else if (isPackageFile())
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -131,7 +131,8 @@ public void setCallFrames(JsArray<CallFrame> frameList, int contextDepth)
       // If it is, the traceback window may appear empty, so show everything
       // to give the user some context.
       boolean allInternal = true;
-      int idxSourceEquiv = -1;
+      int idxSourceEquiv = Integer.MAX_VALUE;
+
       for (int idx = 0; idx < frameList.length(); idx++)
       {
          CallFrame frame = frameList.get(idx);

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -98,6 +98,7 @@ class ClientEvent extends JavaScriptObject
    public static final String UpdateCheck = "update_check";
    public static final String SourceExtendedTypeDetected = "source_extended_type_detected";
    public static final String ShinyViewer = "shiny_viewer";
+   public static final String DebugSourceCompleted = "debug_source_completed";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1400,8 +1400,9 @@ public void execute(EditingTarget target)
                               filePos.getEndLine() - 1,
                               filePos.getEndColumn() + 1);
                         
-                        if (Desktop.isDesktop())
-                           Desktop.getFrame().bringMainFrameToFront();
+                        if (Desktop.isDesktop() && 
+                            navMethod != NavigationMethod.DebugEnd)
+                            Desktop.getFrame().bringMainFrameToFront();
                      }
                      navigate(target, 
                               SourcePosition.create(position.getLine() - 1,

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplication.java
Patch:
@@ -25,6 +25,7 @@
 import org.rstudio.studio.client.common.shiny.model.ShinyServerOperations;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
+import org.rstudio.studio.client.server.VoidServerRequestCallback;
 import org.rstudio.studio.client.shiny.events.ShinyApplicationStatusEvent;
 import org.rstudio.studio.client.shiny.model.ShinyApplicationParams;
 import org.rstudio.studio.client.shiny.model.ShinyRunCmd;
@@ -186,6 +187,7 @@ private void setShinyViewerType(int viewerType)
       UIPrefs prefs = pPrefs_.get();
       prefs.shinyViewerType().setGlobalValue(viewerType);
       prefs.writeUIPrefs();
+      server_.setShinyViewerType(viewerType, new VoidServerRequestCallback());
    }
    
    private void launchShinyAppDir(String dir)

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyViewerTypePopupMenu.java
Patch:
@@ -33,8 +33,9 @@ public ShinyViewerTypePopupMenu(Commands commands,
    {
       commands_ = commands;
       server_ = server;
-      addItem(commands.shinyRunInPane().createMenuItem(false));
       addItem(commands.shinyRunInViewer().createMenuItem(false));
+      addItem(commands.shinyRunInPane().createMenuItem(false));
+      addSeparator();
       addItem(commands.shinyRunInBrowser().createMenuItem(false));
    }
 

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyViewerTypePopupMenu.java
Patch:
@@ -23,7 +23,8 @@
 
 import com.google.inject.Inject;
 
-// An extension of the toolbar popup menu that gets the 
+// An extension of the toolbar popup menu that gets the current Shiny viewer
+// type and checks the appropriate command before showing the menu
 public class ShinyViewerTypePopupMenu extends ToolbarPopupMenu
 {
    @Inject

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -45,6 +45,7 @@
 import org.rstudio.studio.client.projects.ui.prefs.buildtools.BuildToolsPackagePanel;
 import org.rstudio.studio.client.shiny.ShinyApplication;
 import org.rstudio.studio.client.shiny.ShinyApplicationSatellite;
+import org.rstudio.studio.client.shiny.ui.ShinyViewerTypePopupMenu;
 import org.rstudio.studio.client.vcs.VCSApplication;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.RemoteFileSystemContext;
@@ -97,6 +98,7 @@ public interface RStudioGinjector extends Ginjector
    HTMLPreviewApplication getHTMLPreviewApplication();
    ShinyApplicationSatellite getShinyApplicationSatellite();
    ShinyApplication getShinyApplication();
+   ShinyViewerTypePopupMenu getShinyViewerTypePopupMenu();
    EventBus getEventBus();
    GlobalDisplay getGlobalDisplay();
    RemoteFileSystemContext getRemoteFileSystemContext();

File: src/gwt/src/org/rstudio/studio/client/common/icons/StandardIcons.java
Patch:
@@ -34,4 +34,5 @@ public interface StandardIcons extends ClientBundle
    ImageResource function();
    ImageResource git();
    ImageResource svn();
+   ImageResource viewer_window();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/GitPresenter.java
Patch:
@@ -371,6 +371,7 @@ public void execute()
                 "No Remote Branch", 
                 "The current local branch " + branch + " is not synched to a " +
                 "remote branch so the source file can't be viewed on GitHub");
+               return;
             }
             
             // form the github url

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -43,6 +43,7 @@
 import org.rstudio.studio.client.projects.ui.newproject.CodeFilesList;
 import org.rstudio.studio.client.projects.ui.prefs.ProjectPreferencesPane;
 import org.rstudio.studio.client.projects.ui.prefs.buildtools.BuildToolsPackagePanel;
+import org.rstudio.studio.client.shiny.ShinyApplication;
 import org.rstudio.studio.client.shiny.ShinyApplicationSatellite;
 import org.rstudio.studio.client.vcs.VCSApplication;
 import org.rstudio.studio.client.workbench.commands.Commands;
@@ -95,6 +96,7 @@ public interface RStudioGinjector extends Ginjector
    PDFViewerApplication getPDFViewerApplication();
    HTMLPreviewApplication getHTMLPreviewApplication();
    ShinyApplicationSatellite getShinyApplicationSatellite();
+   ShinyApplication getShinyApplication();
    EventBus getEventBus();
    GlobalDisplay getGlobalDisplay();
    RemoteFileSystemContext getRemoteFileSystemContext();

File: src/gwt/src/org/rstudio/studio/client/shiny/events/ShinyApplicationStatusEvent.java
Patch:
@@ -23,7 +23,7 @@ public class ShinyApplicationStatusEvent extends GwtEvent<ShinyApplicationStatus
 { 
    public interface Handler extends EventHandler
    {
-      void onShowShinyApplication(ShinyApplicationStatusEvent event);
+      void onShinyApplicationStatus(ShinyApplicationStatusEvent event);
    }
 
    public static final GwtEvent.Type<ShinyApplicationStatusEvent.Handler> TYPE =
@@ -42,7 +42,7 @@ public ShinyApplicationParams getParams()
    @Override
    protected void dispatch(ShinyApplicationStatusEvent.Handler handler)
    {
-      handler.onShowShinyApplication(this);
+      handler.onShinyApplicationStatus(this);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/shiny/ShinyApplicationPresenter.java
Patch:
@@ -34,8 +34,8 @@ public interface Binder
 
    public interface Display extends IsWidget
    {
-      void showApp(String url);
       String getDocumentTitle();
+      void showApp(ShinyApplicationParams params);
    }
    
    @Inject
@@ -70,7 +70,7 @@ public Widget asWidget()
    
    public void loadApp(ShinyApplicationParams params) 
    {
-      view_.showApp(params.getUrl());
+      view_.showApp(params);
    }
 
    private final Display view_;

File: src/gwt/src/org/rstudio/studio/client/shiny/ui/ShinyApplicationWindow.java
Patch:
@@ -17,7 +17,6 @@
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.user.client.Window;
-import com.google.gwt.user.client.ui.Label;
 import com.google.gwt.user.client.ui.LayoutPanel;
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -96,6 +96,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ErrorHandlerChanged = "error_handler_changed";
    public static final String ViewerNavigate = "viewer_navigate";
    public static final String UpdateCheck = "update_check";
+   public static final String SourceExtendedTypeDetected = "source_extended_type_detected";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -41,7 +41,7 @@ public interface EditingTarget extends IsWidget,
                                        UnsavedChangesTarget
 {
    String getId();
-
+   
    /**
     * Used as the tab name
     */
@@ -52,6 +52,8 @@ public interface EditingTarget extends IsWidget,
    ImageResource getIcon();
    String getTabTooltip();
 
+   void adaptToExtendedFileType(String extendedType);
+   
    HashSet<AppCommand> getSupportedCommands();
    boolean canCompilePdf();
    

File: src/gwt/src/org/rstudio/studio/client/common/debugging/DebuggingServerOperations.java
Patch:
@@ -63,5 +63,6 @@ public void setErrorManagementType(
    public void updateShinyBreakpoints(
          ArrayList<Breakpoint> breakpoints,
          boolean set, 
+         boolean arm, 
          ServerRequestCallback<Void> requestCallback);
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleError.java
Patch:
@@ -85,7 +85,7 @@ public void onClick(ClickEvent event)
       
       for (int i = err.getErrorFrames().length() - 1; i >= 0; i--)
       {
-         ConsoleErrorFrame frame = new ConsoleErrorFrame(
+         ConsoleErrorFrame frame = new ConsoleErrorFrame(i + 1, 
                err.getErrorFrames().get(i), observer_);
          framePanel.add(frame);
       }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -3047,7 +3047,7 @@ public void setErrorManagementType(
    
    @Override
    public void updateShinyBreakpoints(ArrayList<Breakpoint> breakpoints,
-         boolean set, ServerRequestCallback<Void> requestCallback)
+         boolean set, boolean arm, ServerRequestCallback<Void> requestCallback)
    {
       JSONArray bps = new JSONArray();
       for (int i = 0; i < breakpoints.size(); i++)
@@ -3058,6 +3058,7 @@ public void updateShinyBreakpoints(ArrayList<Breakpoint> breakpoints,
       JSONArray params = new JSONArray();
       params.set(0, bps);
       params.set(1, JSONBoolean.getInstance(set));
+      params.set(2, JSONBoolean.getInstance(arm));
       sendRequest(RPC_SCOPE, 
             UPDATE_SHINY_BREAKPOINTS,
             params, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1500,6 +1500,9 @@ public void highlightDebugLocation(SourcePosition startPosition,
       int debugRow = (int) Math.floor(startPosition.getRow() + (
             endPosition.getRow() - startPosition.getRow())/2);
       
+      // if the row at which the debugging occurs is inside a fold, unfold it
+      getSession().unfold(debugRow, true);
+
       // if the line to be debugged is past or near the edges of the screen,
       // scroll it into view. allow some lines of context.
       if (debugRow <= (firstRow + DEBUG_CONTEXT_LINES) || 

File: src/gwt/src/org/rstudio/core/client/dom/impl/DomUtilsImpl.java
Patch:
@@ -41,4 +41,6 @@ public interface DomUtilsImpl
    void setSelectionOffsets(Element container, int start, int end);
 
    boolean isSelectionAsynchronous();
+
+   void selectElement(Element el);
 }

File: src/gwt/src/org/rstudio/core/client/theme/ThemeFonts.java
Patch:
@@ -45,11 +45,11 @@ static interface ThemeFontLoader
    static class DesktopThemeFontLoader implements ThemeFontLoader
    {
       public native final String getProportionalFont() /*-{
-         return $wnd.desktop.proportionalFont;
+         return $wnd.desktop.proportionalFont();
       }-*/;
 
       public native final String getFixedWidthFont() /*-{
-         return $wnd.desktop.fixedWidthFont;
+         return $wnd.desktop.fixedWidthFont();
       }-*/;
    }
 

File: src/gwt/src/org/rstudio/core/client/widget/ProgressDialog.java
Patch:
@@ -146,7 +146,7 @@ protected void unregisterHandlers()
    
    protected void setLabel(String text)
    {
-      if (BrowseCap.isChrome())
+      if (BrowseCap.isChrome() || BrowseCap.isCocoaDesktop())
       {
          Size labelSize = DomMetrics.measureHTML(text);
          labelCell_.getStyle().setWidth(labelSize.width + 10, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -42,6 +42,7 @@
 import org.rstudio.core.client.widget.ThemedPopupPanel;
 import org.rstudio.core.client.widget.WizardResources;
 import org.rstudio.core.client.widget.images.ProgressImages;
+import org.rstudio.studio.client.application.ui.AboutDialogContents;
 import org.rstudio.studio.client.application.ui.appended.ApplicationEndedPopupPanel;
 import org.rstudio.studio.client.application.ui.serializationprogress.ApplicationSerializationProgress;
 import org.rstudio.studio.client.application.ui.support.SupportPopupMenu;
@@ -231,6 +232,7 @@ private void ensureStylesInjected()
       RPubsUploadDialog.ensureStylesInjected();
       WizardResources.INSTANCE.styles().ensureInjected();
       NewProjectResources.INSTANCE.styles().ensureInjected();
+      AboutDialogContents.ensureStylesInjected();
       
       StyleInjector.inject(
             "button::-moz-focus-inner {border:0}");

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -95,6 +95,7 @@ class ClientEvent extends JavaScriptObject
    public static final String UnhandledError = "unhandled_error";
    public static final String ErrorHandlerChanged = "error_handler_changed";
    public static final String ViewerNavigate = "viewer_navigate";
+   public static final String UpdateCheck = "update_check";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -179,6 +179,7 @@
    // View
    public abstract AppCommand showToolbar();
    public abstract AppCommand hideToolbar();
+   public abstract AppCommand zoomActualSize();
    public abstract AppCommand zoomIn();
    public abstract AppCommand zoomOut();
    public abstract AppCommand jumpTo();
@@ -266,7 +267,6 @@
    public abstract AppCommand helpUsingRStudio();
    public abstract AppCommand helpKeyboardShortcuts();
    public abstract AppCommand showRequestLog();
-   public abstract AppCommand showWebkitDevtools();
    public abstract AppCommand logFocusedElement();
    public abstract AppCommand debugDumpContents();
    public abstract AppCommand debugImportDump();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -234,7 +234,8 @@ public String getPdfPreviewValue()
       // get the underlying value
       String pdfPreview = pdfPreview().getValue();
       
-      // the internal viewer no longer works on osx
+      // the internal viewer has stability issues on the mac 
+      // so re-route to system viewer
       if (BrowseCap.isMacintoshDesktop())
       {
          if (pdfPreview.equals(PDF_PREVIEW_RSTUDIO))

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -164,7 +164,7 @@ else if (session_.getSessionInfo().getSourceDocuments().length() > 0
       {
          public void onValueChange(ValueChangeEvent<PaneConfig> evt)
          {
-            ArrayList<LogicalWindow> newPanes = createPanes(evt.getValue());
+            ArrayList<LogicalWindow> newPanes = createPanes(validateConfig(evt.getValue()));
             panes_ = newPanes;
             left_.replaceWindows(newPanes.get(0), newPanes.get(1));
             right_.replaceWindows(newPanes.get(2), newPanes.get(3));

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchScreen.java
Patch:
@@ -87,7 +87,7 @@ public WorkbenchScreen(GlobalDisplay globalDisplay,
       edit_ = edit;
       optionsLoader_ = optionsLoader;
       
-      if (!BrowseCap.isMacintoshDesktop())
+      if (!BrowseCap.isMacintoshDesktop() || BrowseCap.isCocoaDesktop())
          commands.macPreferences().remove();
       
       if (!Desktop.isDesktop() || 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsHandler.java
Patch:
@@ -22,7 +22,6 @@
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.application.Desktop;
-import org.rstudio.studio.client.application.NodeWebkit;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.server.Bool;
 import org.rstudio.studio.client.server.ServerError;
@@ -58,7 +57,7 @@ public void attemptSave(FileSystemItem targetPath,
                            boolean viewAfterSave,
                            final Operation onCompleted)
    {
-      if (Desktop.isDesktop() || NodeWebkit.isNodeWebkit() || !viewAfterSave)
+      if (Desktop.isDesktop() || !viewAfterSave)
          desktopSavePlotAs(targetPath, overwrite, viewAfterSave, onCompleted);
       else
          webSavePlotAs(targetPath, overwrite, viewAfterSave, onCompleted);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/git/dialog/GitReviewPresenter.java
Patch:
@@ -321,6 +321,7 @@ public void onKeyDown(KeyDownEvent event)
             {
                getTable().toggleStaged(
                      event.getNativeKeyCode() == KeyCodes.KEY_ENTER);
+               event.preventDefault();
             }
          }
       });

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -164,7 +164,7 @@ else if (session_.getSessionInfo().getSourceDocuments().length() > 0
       {
          public void onValueChange(ValueChangeEvent<PaneConfig> evt)
          {
-            ArrayList<LogicalWindow> newPanes = createPanes(evt.getValue());
+            ArrayList<LogicalWindow> newPanes = createPanes(validateConfig(evt.getValue()));
             panes_ = newPanes;
             left_.replaceWindows(newPanes.get(0), newPanes.get(1));
             right_.replaceWindows(newPanes.get(2), newPanes.get(3));

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -42,6 +42,7 @@
 import org.rstudio.core.client.widget.ThemedPopupPanel;
 import org.rstudio.core.client.widget.WizardResources;
 import org.rstudio.core.client.widget.images.ProgressImages;
+import org.rstudio.studio.client.application.ui.AboutDialogContents;
 import org.rstudio.studio.client.application.ui.appended.ApplicationEndedPopupPanel;
 import org.rstudio.studio.client.application.ui.serializationprogress.ApplicationSerializationProgress;
 import org.rstudio.studio.client.application.ui.support.SupportPopupMenu;
@@ -231,6 +232,7 @@ private void ensureStylesInjected()
       RPubsUploadDialog.ensureStylesInjected();
       WizardResources.INSTANCE.styles().ensureInjected();
       NewProjectResources.INSTANCE.styles().ensureInjected();
+      AboutDialogContents.ensureStylesInjected();
       
       StyleInjector.inject(
             "button::-moz-focus-inner {border:0}");

File: src/gwt/src/org/rstudio/core/client/widget/ProgressDialog.java
Patch:
@@ -146,7 +146,7 @@ protected void unregisterHandlers()
    
    protected void setLabel(String text)
    {
-      if (BrowseCap.isChrome() || BrowseCap.isMacintoshDesktop())
+      if (BrowseCap.isChrome() || BrowseCap.isCocoaDesktop())
       {
          Size labelSize = DomMetrics.measureHTML(text);
          labelCell_.getStyle().setWidth(labelSize.width + 10, Unit.PX);

File: src/gwt/src/org/rstudio/core/client/widget/ProgressDialog.java
Patch:
@@ -146,7 +146,7 @@ protected void unregisterHandlers()
    
    protected void setLabel(String text)
    {
-      if (BrowseCap.isChrome())
+      if (BrowseCap.isChrome() || BrowseCap.isMacintoshDesktop())
       {
          Size labelSize = DomMetrics.measureHTML(text);
          labelCell_.getStyle().setWidth(labelSize.width + 10, Unit.PX);

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -93,7 +93,7 @@ void openTerminal(String terminalPath,
                      String workingDirectory,
                      String extraPathEntries);
 
-   String getFontList(boolean fixedWidthOnly);
+   String getFixedWidthFontList();
    String getFixedWidthFont();
    void setFixedWidthFont(String font);
    

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java
Patch:
@@ -84,7 +84,7 @@ public void onChange(ChangeEvent event)
          });
          
          
-         String[] fonts = Desktop.getFrame().getFontList(true).split("\\n");
+         String[] fonts = Desktop.getFrame().getFixedWidthFontList().split("\\n");
 
          fontFace_ = new SelectWidget("Editor font:", fonts, fonts, false, false, false);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1500,6 +1500,9 @@ public void highlightDebugLocation(SourcePosition startPosition,
       int debugRow = (int) Math.floor(startPosition.getRow() + (
             endPosition.getRow() - startPosition.getRow())/2);
       
+      // if the row at which the debugging occurs is inside a fold, unfold it
+      getSession().unfold(debugRow, true);
+
       // if the line to be debugged is past or near the edges of the screen,
       // scroll it into view. allow some lines of context.
       if (debugRow <= (firstRow + DEBUG_CONTEXT_LINES) || 

File: src/gwt/src/org/rstudio/studio/client/common/debugging/DebuggingServerOperations.java
Patch:
@@ -63,5 +63,6 @@ public void setErrorManagementType(
    public void updateShinyBreakpoints(
          ArrayList<Breakpoint> breakpoints,
          boolean set, 
+         boolean arm, 
          ServerRequestCallback<Void> requestCallback);
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -3045,7 +3045,7 @@ public void setErrorManagementType(
    
    @Override
    public void updateShinyBreakpoints(ArrayList<Breakpoint> breakpoints,
-         boolean set, ServerRequestCallback<Void> requestCallback)
+         boolean set, boolean arm, ServerRequestCallback<Void> requestCallback)
    {
       JSONArray bps = new JSONArray();
       for (int i = 0; i < breakpoints.size(); i++)
@@ -3056,6 +3056,7 @@ public void updateShinyBreakpoints(ArrayList<Breakpoint> breakpoints,
       JSONArray params = new JSONArray();
       params.set(0, bps);
       params.set(1, JSONBoolean.getInstance(set));
+      params.set(2, JSONBoolean.getInstance(arm));
       sendRequest(RPC_SCOPE, 
             UPDATE_SHINY_BREAKPOINTS,
             params, 

File: src/gwt/src/org/rstudio/studio/client/application/DesktopFrame.java
Patch:
@@ -119,4 +119,6 @@ void externalSynctexView(String pdfFile,
    void reloadZoomWindow();
    
    void setViewerUrl(String url);
+   
+   boolean isOSXMavericks();
 }

File: src/gwt/src/org/rstudio/studio/client/common/synctex/Synctex.java
Patch:
@@ -117,7 +117,7 @@ public void onCompilePdfStarted(CompilePdfStartedEvent event)
    @Override
    public void onCompilePdfCompleted(CompilePdfCompletedEvent event)
    {
-      String pdfPreview = prefs_.pdfPreview().getValue();
+      String pdfPreview = prefs_.getPdfPreviewValue();
       
       boolean synctexSupported =
                   // internal previewer
@@ -367,7 +367,7 @@ private boolean handleDesktopSynctex()
    {
       return Desktop.isDesktop() && 
              !satellite_.isCurrentWindowSatellite() &&
-              prefs_.pdfPreview().getValue().equals(
+              prefs_.getPdfPreviewValue().equals(
                                    UIPrefs.PDF_PREVIEW_DESKTOP_SYNCTEX);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2952,7 +2952,7 @@ public HTMLPreviewParams get()
    @Handler
    void onCompilePDF()
    {
-      String pdfPreview = prefs_.pdfPreview().getValue();
+      String pdfPreview = prefs_.getPdfPreviewValue();
       boolean showPdf = !pdfPreview.equals(UIPrefsAccessor.PDF_PREVIEW_NONE);
       boolean useInternalPreview = 
             pdfPreview.equals(UIPrefsAccessor.PDF_PREVIEW_RSTUDIO) && 

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -273,7 +273,6 @@
    public abstract AppCommand refreshSuperDevMode();
    
    // Viewer
-   public abstract AppCommand viewerPrint();
    public abstract AppCommand viewerPopout();
    public abstract AppCommand viewerRefresh();
    public abstract AppCommand viewerStop();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/data/DataEditingTargetWidget.java
Patch:
@@ -22,6 +22,7 @@
 
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.dom.IFrameElementEx;
+import org.rstudio.core.client.widget.RStudioFrame;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.PanelWithToolbars;
@@ -59,7 +60,7 @@ public DataEditingTargetWidget(Commands commands, DataItem dataItem)
 
       commands_ = commands;
 
-      frame_ = new Frame(dataItem.getContentUrl());
+      frame_ = new RStudioFrame(dataItem.getContentUrl());
       frame_.setSize("100%", "100%");
 
       Widget mainWidget = frame_;
@@ -130,5 +131,5 @@ public Widget asWidget()
    }
 
    private final Commands commands_;
-   private Frame frame_;
+   private RStudioFrame frame_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTargetWidget.java
Patch:
@@ -15,9 +15,9 @@
 package org.rstudio.studio.client.workbench.views.source.editors.urlcontent;
 
 import com.google.gwt.user.client.ui.Composite;
-import com.google.gwt.user.client.ui.Frame;
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.core.client.dom.IFrameElementEx;
+import org.rstudio.core.client.widget.RStudioFrame;
 import org.rstudio.core.client.widget.Toolbar;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.views.source.PanelWithToolbars;
@@ -30,7 +30,7 @@ public UrlContentEditingTargetWidget(Commands commands, String url)
    {
       commands_ = commands;
 
-      frame_ = new Frame(url);
+      frame_ = new RStudioFrame(url);
       frame_.setSize("100%", "100%");
 
       PanelWithToolbars panel = new PanelWithToolbars(createToolbar(),
@@ -59,5 +59,5 @@ public Widget asWidget()
    }
 
    private final Commands commands_;
-   private Frame frame_;
+   private RStudioFrame frame_;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/viewer/ui/ViewerFrame.java
Patch:
@@ -2,10 +2,10 @@
 
 import org.rstudio.core.client.dom.IFrameElementEx;
 import org.rstudio.core.client.dom.WindowEx;
+import org.rstudio.core.client.widget.RStudioFrame;
 
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.RepeatingCommand;
-import com.google.gwt.user.client.ui.Frame;
 
 /*
  * ViewerFrame.java
@@ -20,7 +20,7 @@
  *
  */
 
-public class ViewerFrame extends Frame
+public class ViewerFrame extends RStudioFrame
 {
    public void navigate(final String url)
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/model/RObject.java
Patch:
@@ -37,11 +37,11 @@ public final native boolean isData() /*-{
    }-*/;
 
    public final native String getValue() /*-{
-      return this.value;
+      return this.value ? this.value : "NO_VALUE";
    }-*/;
 
    public final native String getDescription() /*-{
-       return this.description;
+       return this.description ? this.description : "";
    }-*/;
 
    public final native JsArrayString getContents() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/model/EnvironmentServerOperations.java
Patch:
@@ -64,4 +64,6 @@ void getEnvironmentState(
    void getObjectContents(
               String objectName,
               ServerRequestCallback<ObjectContents> requestCallback);
+   
+   void requeryContext(ServerRequestCallback<Void> requestCallback);
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanelStyle.java
Patch:
@@ -20,4 +20,5 @@
 public interface CallFramePanelStyle extends CssResource
 {
    String tracebackHeader();
+   String toggleHide();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectDisplay.java
Patch:
@@ -40,6 +40,8 @@ public interface Host
       public void setSortColumn(int col);
       public void toggleAscendingSort();
       boolean getAscendingSort();
+      boolean getShowInternalFunctions();
+      void setShowInternalFunctions(boolean hide);
       public void fillObjectContents(RObject object, Operation onCompleted);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectsObserver.java
Patch:
@@ -25,5 +25,7 @@ public interface EnvironmentObjectsObserver
    void setPersistedScrollPosition(int scrollPosition);
    void changeContextDepth(int newDepth);
    void setViewDirty();
+   boolean getShowInternalFunctions();
+   void setShowInternalFunctions(boolean show);
    void fillObjectContents(RObject object, Operation onCompleted);
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -346,6 +346,7 @@ public void onExecute(final Command continuation)
             server_.createProject(
                   newProject.getProjectFile(),
                   newProject.getNewPackageOptions(),
+                  newProject.getNewShinyAppOptions(),
                   new VoidServerRequestCallback(indicator)
                   {
                      @Override

File: src/gwt/src/org/rstudio/studio/client/projects/model/ProjectsServerOperations.java
Patch:
@@ -26,6 +26,7 @@ public interface ProjectsServerOperations extends PrefsServerOperations,
    
    void createProject(String projectFile,
                       NewPackageOptions newPackageOptions,
+                      NewShinyAppOptions newShinyAppOptions,
                       ServerRequestCallback<Void> callback);
     
    void readProjectOptions(ServerRequestCallback<RProjectOptions> callback);

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/ExistingDirectoryPage.java
Patch:
@@ -52,7 +52,7 @@ protected NewProjectResult collectInput()
       if (dir.length() > 0)
       {
          return new NewProjectResult(
-                     projFileFromDir(dir), false, null, null, null);
+                     projFileFromDir(dir), false, null, null, null, null);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewProjectWizard.java
Patch:
@@ -46,7 +46,7 @@ public NewProjectWizard(
       openInNewWindow_.setVisible(false);
       
       
-      addPage(new NewDirectoryPage());
+      addPage(new NewDirectoryNavigationPage(sessionInfo));
       addPage(new ExistingDirectoryPage());
 
       if (sessionInfo.getAllowVcs())

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/VersionControlPage.java
Patch:
@@ -211,7 +211,7 @@ protected NewProjectResult collectInput()
                                                           checkoutDir, 
                                                           dir);
          
-         return new NewProjectResult(projFile, false, dir, options, null);
+         return new NewProjectResult(projFile, false, dir, options, null, null);
       }
       else
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectDisplay.java
Patch:
@@ -18,7 +18,9 @@
 import java.util.List;
 
 import org.rstudio.core.client.cellview.ScrollingDataGrid;
+import org.rstudio.core.client.widget.Operation;
 import org.rstudio.studio.client.workbench.views.environment.EnvironmentPane;
+import org.rstudio.studio.client.workbench.views.environment.model.RObject;
 
 import com.google.gwt.cell.client.FieldUpdater;
 import com.google.gwt.safehtml.shared.SafeHtml;
@@ -40,6 +42,7 @@ public interface Host
       boolean getAscendingSort();
       boolean getShowInternalFunctions();
       void setShowInternalFunctions(boolean hide);
+      public void fillObjectContents(RObject object, Operation onCompleted);
    }
 
    public EnvironmentObjectDisplay(Host host, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentStyle.java
Patch:
@@ -29,7 +29,6 @@ interface EnvironmentStyle extends CssResource
    String categoryHeaderText();
    String emptyEnvironmentPanel();
    String emptyEnvironmentMessage();
-   String expandIcon();
    String unclickableIcon();
    String unevaluatedPromise();
    String objectGrid();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectDisplay.java
Patch:
@@ -18,7 +18,9 @@
 import java.util.List;
 
 import org.rstudio.core.client.cellview.ScrollingDataGrid;
+import org.rstudio.core.client.widget.Operation;
 import org.rstudio.studio.client.workbench.views.environment.EnvironmentPane;
+import org.rstudio.studio.client.workbench.views.environment.model.RObject;
 
 import com.google.gwt.cell.client.FieldUpdater;
 import com.google.gwt.safehtml.shared.SafeHtml;
@@ -38,6 +40,7 @@ public interface Host
       public void setSortColumn(int col);
       public void toggleAscendingSort();
       boolean getAscendingSort();
+      public void fillObjectContents(RObject object, Operation onCompleted);
    }
 
    public EnvironmentObjectDisplay(Host host, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentStyle.java
Patch:
@@ -29,7 +29,6 @@ interface EnvironmentStyle extends CssResource
    String categoryHeaderText();
    String emptyEnvironmentPanel();
    String emptyEnvironmentMessage();
-   String expandIcon();
    String unclickableIcon();
    String unevaluatedPromise();
    String objectGrid();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/RObjectEntry.java
Patch:
@@ -63,7 +63,7 @@ public boolean hasTraceInfo()
    public int getCategory()
    {
       String type = rObject.getType();
-      if (type.equals("data.frame") ||
+      if (rObject.isData() ||
           type.equals("matrix") ||
           type.equals("data.table") ||
           type.equals("cast_df") ||

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -323,8 +323,8 @@ public final native DebugState getDebugState() /*-{
       return this.debug_state;
    }-*/;
    
-   public final native boolean getHaveBreakpoints() /*-{
-      return this.have_breakpoints;
+   public final native boolean getHaveSrcrefAttribute() /*-{
+      return this.have_srcref_attribute;
    }-*/;
    
    public final native ErrorManagerState getErrorState() /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectList.java
Patch:
@@ -64,9 +64,10 @@ public interface Resources extends ClientBundle
    }
 
    public EnvironmentObjectList(EnvironmentObjectDisplay.Host host,
-                                EnvironmentObjectsObserver observer)
+                                EnvironmentObjectsObserver observer,
+                                String environmentName)
    {
-      super(host, observer);
+      super(host, observer, environmentName);
       setTableBuilder(new EnvironmentObjectTableBuilder(this));
 
       // disable persistent and transient row selection (currently necessary

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleError.java
Patch:
@@ -32,7 +32,6 @@
 
 public class ConsoleError extends Composite
 {
-
    private static ConsoleErrorUiBinder uiBinder = GWT
          .create(ConsoleErrorUiBinder.class);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/model/CallFrame.java
Patch:
@@ -76,7 +76,7 @@ public final DebugFilePosition getRange()
    
    public final boolean isNavigable()
    {
-      return isNavigableFilename(getFileName());
+      return getLineNumber() > 0;
    }
    
    public final static boolean isNavigableFilename(String fileName)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -557,7 +557,9 @@ private void openOrUpdateFileBrowsePoint(boolean debugging)
    {
       String file = currentBrowseFile_;
       
-      if (!CallFrame.isNavigableFilename(file))
+      // if we have no file and no source code, we can do no navigation 
+      if (!CallFrame.isNavigableFilename(file) &&
+          !useCurrentBrowseSource_)
       {
          return;
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/model/CallFrame.java
Patch:
@@ -76,7 +76,7 @@ public final DebugFilePosition getRange()
    
    public final boolean isNavigable()
    {
-      return isNavigableFilename(getFileName());
+      return getLineNumber() > 0;
    }
    
    public final static boolean isNavigableFilename(String fileName)

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleError.java
Patch:
@@ -32,7 +32,6 @@
 
 public class ConsoleError extends Composite
 {
-
    private static ConsoleErrorUiBinder uiBinder = GWT
          .create(ConsoleErrorUiBinder.class);
 

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -115,7 +115,7 @@ public interface ThemeStyles extends CssResource
    String sessionAbendMessage();
    String applicationHeaderStrong();
           
-   String environmentDataFrameRow();
+   String environmentDataFrameCol();
 
    String odd();
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -70,6 +70,7 @@
 import org.rstudio.studio.client.workbench.views.edit.events.ShowEditorEvent;
 import org.rstudio.studio.client.workbench.views.edit.model.ShowEditorData;
 import org.rstudio.studio.client.workbench.views.environment.events.*;
+import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentContextData;
 import org.rstudio.studio.client.workbench.views.environment.model.RObject;
 import org.rstudio.studio.client.workbench.views.files.events.DirectoryNavigateEvent;
 import org.rstudio.studio.client.workbench.views.files.events.FileChangeEvent;
@@ -444,7 +445,7 @@ else if (type.equals(ClientEvent.UiPrefsChanged))
             eventBus_.fireEvent(new UiPrefsChangedEvent(data));
          }
          else if (type.equals(ClientEvent.ContextDepthChanged)) {
-            ContextDepthChangedEvent.ContextData data = event.getData();
+            EnvironmentContextData data = event.getData();
             eventBus_.fireEvent(new ContextDepthChangedEvent(data));
          }
          else if (type.equals(ClientEvent.HandleUnsavedChanges))

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentTab.java
Patch:
@@ -25,7 +25,7 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.ui.DelayLoadTabShim;
 import org.rstudio.studio.client.workbench.ui.DelayLoadWorkbenchTab;
-import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentState;
+import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentContextData;
 import com.google.inject.Inject;
 
 public class EnvironmentTab extends DelayLoadWorkbenchTab<EnvironmentPresenter>
@@ -47,7 +47,7 @@ public abstract static class Shim
       @Handler
       public abstract void onClearWorkspace();
 
-      abstract void initialize(EnvironmentState environmentState);
+      abstract void initialize(EnvironmentContextData environmentState);
    }
 
    @Inject
@@ -66,7 +66,7 @@ public EnvironmentTab(final Shim shim,
          
          public void onSessionInit(SessionInitEvent sie)
          {
-            EnvironmentState environmentState = 
+            EnvironmentContextData environmentState = 
                   session_.getSessionInfo().getEnvironmentState();
             shim.initialize(environmentState);
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFrameItem.java
Patch:
@@ -28,7 +28,6 @@
 import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.studio.client.common.FilePathUtils;
 import org.rstudio.studio.client.workbench.views.environment.model.CallFrame;
-import org.rstudio.studio.client.workbench.views.environment.view.EnvironmentObjects.Observer;
 
 public class CallFrameItem extends Composite
    implements ClickHandler
@@ -45,7 +44,7 @@ interface Style extends CssResource
       String hiddenFrame();
    }
 
-   public CallFrameItem(CallFrame frame, Observer observer, boolean hidden)
+   public CallFrameItem(CallFrame frame, EnvironmentObjectsObserver observer, boolean hidden)
    {
       isActive_ = false;
       isVisible_ = true;
@@ -134,7 +133,7 @@ private boolean hasFileLocation()
    @UiField Label functionName;
    @UiField Style style;
 
-   Observer observer_;
+   EnvironmentObjectsObserver observer_;
    CallFrame frame_;
    boolean isActive_;
    boolean isVisible_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -32,7 +32,6 @@
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.studio.client.workbench.views.environment.model.CallFrame;
-import org.rstudio.studio.client.workbench.views.environment.view.EnvironmentObjects.Observer;
 
 import java.util.ArrayList;
 import java.util.Collections;
@@ -49,7 +48,7 @@ public interface CallFramePanelHost
       void restoreCallFramePanel();
    }
    
-   public CallFramePanel(Observer observer, CallFramePanelHost panelHost)
+   public CallFramePanel(EnvironmentObjectsObserver observer, CallFramePanelHost panelHost)
    {
       final ThemeStyles globalStyles = ThemeResources.INSTANCE.themeStyles();
       panelHost_ = panelHost;
@@ -166,7 +165,7 @@ public boolean isMinimized()
    @UiField CallFramePanelStyle style;
    @UiField LayoutPanel callFramePanelHeader;
    
-   Observer observer_;
+   EnvironmentObjectsObserver observer_;
    CallFramePanelHost panelHost_;
    ArrayList<CallFrameItem> callFrameItems_;
    boolean isMinimized_ = false;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentStyle.java
Patch:
@@ -28,7 +28,6 @@ interface EnvironmentStyle extends CssResource
    String categoryHeaderRow();
    String categoryHeaderText();
    String emptyEnvironmentPanel();
-   String emptyEnvironmentName();
    String emptyEnvironmentMessage();
    String expandIcon();
    String unclickableIcon();
@@ -38,5 +37,7 @@ interface EnvironmentStyle extends CssResource
    String dataFrameValueCol();
    String environmentPanel();
    String filterMatch();
+   String environmentPane();
+   String fillHeight();
 }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -486,7 +486,8 @@ private void loadNewContextState(int contextDepth,
       environmentName_ = environmentName;
       view_.setEnvironmentName(environmentName_);
       if (callFrames != null && 
-          callFrames.length() > 0)
+          callFrames.length() > 0 &&
+          contextDepth > 0)
       {
          view_.setCallFrames(callFrames);
          CallFrame browseFrame = callFrames.get(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -486,7 +486,8 @@ private void loadNewContextState(int contextDepth,
       environmentName_ = environmentName;
       view_.setEnvironmentName(environmentName_);
       if (callFrames != null && 
-          callFrames.length() > 0)
+          callFrames.length() > 0 &&
+          contextDepth > 0)
       {
          view_.setCallFrames(callFrames);
          CallFrame browseFrame = callFrames.get(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectDisplay.java
Patch:
@@ -36,7 +36,7 @@ public interface Host
       public int getSortColumn();
       public void setSortColumn(int col);
       public void toggleAscendingSort();
-      boolean isAscendingSort();
+      boolean getAscendingSort();
    }
 
    public EnvironmentObjectDisplay(Host host, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectGrid.java
Patch:
@@ -253,7 +253,7 @@ protected boolean buildHeaderOrFooterImpl()
             Cell.Context context = new Cell.Context(0, i, null);
             renderSortableHeader(cell, context, col.getHeader(), 
                   i == host_.getSortColumn(), 
-                  host_.isAscendingSort());
+                  host_.getAscendingSort());
             cell.endTH();
          }
          row.end();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectsObserver.java
Patch:
@@ -7,4 +7,5 @@ public interface EnvironmentObjectsObserver
    void setObjectCollapsed(String objectName);
    void setPersistedScrollPosition(int scrollPosition);
    void changeContextDepth(int newDepth);
+   void setViewDirty();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectGrid.java
Patch:
@@ -231,6 +231,7 @@ protected boolean buildHeaderOrFooterImpl()
          TableCellBuilder selectAll = row.startTH();
          selectAll.className(style_.objectGridHeader() + " " +
                              style_.checkColumn());
+         selectAll.style().width(5, Unit.PCT);
          renderHeader(selectAll, new Cell.Context(0, 0, null), checkHeader_);
          selectAll.end();
 
@@ -273,6 +274,7 @@ protected void buildRowImpl(RObjectEntry rowValue, int absRowIndex)
 
          TableCellBuilder check = row.startTD();
          check.className(style_.checkColumn());
+         check.style().width(5, Unit.PCT);
          renderCell(check, createContext(0), checkColumn_, rowValue);
          check.endTD();
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -501,7 +501,7 @@ public void removeAllObjects(boolean includeHidden,
 
    @Override
    public void removeObjects(List<String> objectNames,
-         ServerRequestCallback<Void> requestCallback)
+                             ServerRequestCallback<Void> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, JSONUtils.toJSONStringArray(objectNames));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/RObjectEntry.java
Patch:
@@ -86,9 +86,9 @@ public boolean isPromise()
    
    public String getDisplayValue()
    {
-      String val = rObject.getValue();
+      String val = rObject.getValue().trim();
       return val == RObjectEntry.NO_VALUE ?
-                      rObject.getDescription() :
+                      rObject.getDescription().trim() :
                       val;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -90,6 +90,7 @@ public interface Display extends WorkbenchView
       void addObject(RObject object);
       void addObjects(JsArray<RObject> objects);
       void clearObjects();
+      void clearSelection();
       void setContextDepth(int contextDepth);
       void removeObject(String object);
       void setEnvironmentName(String name);
@@ -266,6 +267,7 @@ public void execute(Boolean includeHidden, ProgressIndicator indicator)
                            @Override
                            public void onSuccess()
                            {
+                              view_.clearSelection();
                               view_.clearObjects();
                            }
                        });
@@ -278,6 +280,7 @@ public void onSuccess()
                            @Override
                            public void onSuccess()
                            {
+                              view_.clearSelection();
                               for (String obj: objectNames)
                               {
                                  view_.removeObject(obj);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjectDisplay.java
Patch:
@@ -65,6 +65,7 @@ public SafeHtml render(String str)
    }
    
    public abstract List<String> getSelectedObjects();
+   public abstract void clearSelection();
    
    protected AbstractSafeHtmlRenderer<String> filterRenderer_;
    protected EnvironmentObjectsObserver observer_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/model/EnvironmentServerOperations.java
Patch:
@@ -58,4 +58,7 @@ void setEnvironmentFrame(int frame,
    void getEnvironmentNames(
               ServerRequestCallback<JsArray<EnvironmentFrame>> requestCallback);
    
+   void getEnvironmentState(
+              ServerRequestCallback<EnvironmentContextData> requestCallback);
+   
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentStyle.java
Patch:
@@ -23,7 +23,6 @@ interface EnvironmentStyle extends CssResource
    String expandCol();
    String nameCol();
    String valueCol();
-   String valueColNew();
    String clickableCol();
    String detailRow();
    String categoryHeaderRow();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/events/ContextDepthChangedEvent.java
Patch:
@@ -16,10 +16,10 @@
 
 import org.rstudio.studio.client.workbench.views.environment.model.CallFrame;
 import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentContextData;
+import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentFrame;
 import org.rstudio.studio.client.workbench.views.environment.model.RObject;
 
 import com.google.gwt.core.client.JsArray;
-import com.google.gwt.core.client.JsArrayString;
 import com.google.gwt.event.shared.EventHandler;
 import com.google.gwt.event.shared.GwtEvent;
 
@@ -71,7 +71,7 @@ public String getEnvironmentName()
       return contextData_.environmentName();
    }
    
-   public JsArrayString getEnvironments()
+   public JsArray<EnvironmentFrame> getEnvironments()
    {
       return contextData_.environments();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/model/EnvironmentContextData.java
Patch:
@@ -16,7 +16,6 @@
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
-import com.google.gwt.core.client.JsArrayString;
 
 public class EnvironmentContextData extends JavaScriptObject
 {
@@ -50,7 +49,7 @@ public final native String environmentName() /*-{
       return this.environment_name;
    }-*/;
 
-   public final native JsArrayString environments() /*-{
+   public final native JsArray<EnvironmentFrame> environments() /*-{
       return this.environments;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -28,7 +28,7 @@
 import org.rstudio.studio.client.common.debugging.model.ErrorManagerState;
 import org.rstudio.studio.client.common.rnw.RnwWeave;
 import org.rstudio.studio.client.workbench.views.buildtools.model.BuildState;
-import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentState;
+import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentContextData;
 import org.rstudio.studio.client.workbench.views.output.find.model.FindInFilesState;
 import org.rstudio.studio.client.workbench.views.presentation.model.PresentationState;
 import org.rstudio.studio.client.workbench.views.source.model.SourceDocument;
@@ -311,7 +311,7 @@ public final native String getSwitchToProject() /*-{
       return this.switch_to_project;
    }-*/;
 
-   public final native EnvironmentState getEnvironmentState() /*-{
+   public final native EnvironmentContextData getEnvironmentState() /*-{
       return this.environment_state;
    }-*/;
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -66,8 +66,8 @@
 import org.rstudio.studio.client.workbench.views.environment.events.EnvironmentRefreshEvent;
 import org.rstudio.studio.client.workbench.views.environment.model.CallFrame;
 import org.rstudio.studio.client.workbench.views.environment.model.DownloadInfo;
+import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentContextData;
 import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentServerOperations;
-import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentState;
 import org.rstudio.studio.client.workbench.views.environment.model.RObject;
 import org.rstudio.studio.client.workbench.views.environment.view.EnvironmentClientState;
 import org.rstudio.studio.client.workbench.views.source.SourceShim;
@@ -384,7 +384,7 @@ public void onSelected()
       }
    }
 
-   public void initialize(EnvironmentState environmentState)
+   public void initialize(EnvironmentContextData environmentState)
    {
       loadNewContextState(environmentState.contextDepth(),
             environmentState.environmentName(),

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentTab.java
Patch:
@@ -25,7 +25,7 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.ui.DelayLoadTabShim;
 import org.rstudio.studio.client.workbench.ui.DelayLoadWorkbenchTab;
-import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentState;
+import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentContextData;
 import com.google.inject.Inject;
 
 public class EnvironmentTab extends DelayLoadWorkbenchTab<EnvironmentPresenter>
@@ -47,7 +47,7 @@ public abstract static class Shim
       @Handler
       public abstract void onClearWorkspace();
 
-      abstract void initialize(EnvironmentState environmentState);
+      abstract void initialize(EnvironmentContextData environmentState);
    }
 
    @Inject
@@ -66,7 +66,7 @@ public EnvironmentTab(final Shim shim,
          
          public void onSessionInit(SessionInitEvent sie)
          {
-            EnvironmentState environmentState = 
+            EnvironmentContextData environmentState = 
                   session_.getSessionInfo().getEnvironmentState();
             shim.initialize(environmentState);
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -315,9 +315,8 @@ public void setFilterText (String filterText)
          RObjectEntry entry = objects.get(i);
          boolean visible = matchesFilter(entry.rObject);
          // Redraw the object if its visibility status has changed, or if it's
-         // visible and there's a filter (so we can show the search highlight)
-         if (visible != entry.visible ||
-             visible && hasFilter)
+         // visible (for visible entries we need to update the search highlight)
+         if (visible != entry.visible || visible)
          {
             entry.visible = visible;
             objectList_.redrawRow(i);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -315,9 +315,8 @@ public void setFilterText (String filterText)
          RObjectEntry entry = objects.get(i);
          boolean visible = matchesFilter(entry.rObject);
          // Redraw the object if its visibility status has changed, or if it's
-         // visible and there's a filter (so we can show the search highlight)
-         if (visible != entry.visible ||
-             visible && hasFilter)
+         // visible (for visible entries we need to update the search highlight)
+         if (visible != entry.visible || visible)
          {
             entry.visible = visible;
             objectList_.redrawRow(i);

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeResources.java
Patch:
@@ -189,4 +189,6 @@ public interface ThemeResources extends ClientBundle
    DataResource pendingBreakpoint();
    @Source("executingLine.png")
    DataResource executingLine();
+   
+   ImageResource menuCheck();
 }

File: src/gwt/src/org/rstudio/core/rebind/command/CommandBundleGenerator.java
Patch:
@@ -315,7 +315,9 @@ private void emitCommandInitializers(SourceWriter writer,
       setPropertyBool(writer, name, props.get(name), "enabled");
       setPropertyBool(writer, name, props.get(name),
                       "preventShortcutWhenDisabled");
-
+      setPropertyBool(writer, name, props.get(name), "checkable");
+      setPropertyBool(writer, name, props.get(name), "checked");
+      
       if (images.hasImage(name))
       {
          writer.println(name + "_.setImageResource("

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -36,6 +36,7 @@
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.ui.ApplicationHeader;
 import org.rstudio.studio.client.application.ui.GlobalToolbar;
+import org.rstudio.studio.client.common.debugging.ErrorManager;
 import org.rstudio.studio.client.workbench.codesearch.CodeSearch;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.events.SessionInitEvent;
@@ -66,7 +67,8 @@ public void initialize(Commands commands,
                           final Session session,
                           WorkbenchServerOperations server,
                           Provider<DesktopHooks> pDesktopHooks,
-                          Provider<CodeSearch> pCodeSearch)
+                          Provider<CodeSearch> pCodeSearch,
+                          ErrorManager errorManager)
    {
       session_ = session;
       eventBus_= events;

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -92,6 +92,8 @@ class ClientEvent extends JavaScriptObject
    public static final String PackageLoaded = "package_loaded";
    public static final String PackageUnloaded = "package_unloaded";
    public static final String PresentationPaneRequestCompleted = "presentation_pane_request_completed";
+   public static final String UnhandledError = "unhandled_error";
+   public static final String ErrorHandlerChanged = "error_handler_changed";
 
    protected ClientEvent()
    {
@@ -108,4 +110,4 @@ public final native String getType() /*-{
    public final native <T> T getData() /*-{
       return this.data;
    }-*/;
-}
\ No newline at end of file
+}

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ShellPane.java
Patch:
@@ -19,6 +19,7 @@
 import com.google.gwt.user.client.ui.*;
 import com.google.inject.Inject;
 import org.rstudio.core.client.CommandWithArg;
+import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.common.shell.ShellWidget;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
@@ -27,9 +28,9 @@
 public class ShellPane extends ShellWidget implements Shell.Display
 {
    @Inject
-   public ShellPane(final AceEditor editor, UIPrefs uiPrefs)
+   public ShellPane(final AceEditor editor, UIPrefs uiPrefs, EventBus events)
    {
-      super(editor);
+      super(editor, events);
 
       editor.setDisableOverwrite(true);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -69,7 +69,6 @@
 import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentServerOperations;
 import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentState;
 import org.rstudio.studio.client.workbench.views.environment.model.RObject;
-import org.rstudio.studio.client.workbench.views.environment.view.CallFrameItem;
 import org.rstudio.studio.client.workbench.views.environment.view.EnvironmentClientState;
 import org.rstudio.studio.client.workbench.views.source.SourceShim;
 import org.rstudio.studio.client.workbench.views.source.events.CodeBrowserFinishedEvent;
@@ -495,7 +494,7 @@ private void openOrUpdateFileBrowsePoint(boolean debugging)
    {
       String file = currentBrowseFile_;
       
-      if (!CallFrameItem.isNavigableFilename(file))
+      if (!CallFrame.isNavigableFilename(file))
       {
          return;
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFrameItem.java
Patch:
@@ -53,7 +53,7 @@ public CallFrameItem(CallFrame frame, Observer observer, boolean hidden)
       frame_ = frame;
       initWidget(GWT.<Binder>create(Binder.class).createAndBindUi(this));
       functionName.addClickHandler(this);
-      if (!isNavigableFilename(frame.getFileName()))
+      if (!frame.isNavigable())
       {
          functionName.addStyleName(style.noSourceFrame());
          
@@ -128,7 +128,7 @@ private void setDisplayText(int lineNumber)
 
    private boolean hasFileLocation()
    {
-      return isNavigableFilename(frame_.getFileName().trim());
+      return frame_.isNavigable();
    }
 
    @UiField Label functionName;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/ConsoleProgressWidget.java
Patch:
@@ -22,7 +22,7 @@ public class ConsoleProgressWidget extends ShellWidget implements ShellDisplay
 {
    public ConsoleProgressWidget()
    {
-      super(new AceEditor());     
+      super(new AceEditor(), null);     
    }
    
   

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -172,7 +172,8 @@ public void execute(String encoding)
       spaced(encoding_);
       setEncoding(prefs.defaultEncoding().getGlobalValue());
       
-      add(checkboxPref("Handle only errors containing my code", 
+      add(checkboxPref(
+            "Use debug error handler only when errors contain my code", 
             prefs_.handleErrorsInUserCodeOnly()));
       add(checkboxPref("Automatically expand error tracebacks", 
             prefs_.autoExpandErrorTracebacks()));

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -318,8 +318,6 @@
    public abstract AppCommand errorsMessage();
    public abstract AppCommand errorsTraceback();
    public abstract AppCommand errorsBreak();
-   public abstract AppCommand errorsInMyCode();
-   public abstract AppCommand errorsExpandTraceback();
    
    // Other
    public abstract AppCommand checkSpelling();   

File: src/gwt/src/org/rstudio/core/client/widget/ImageFrame.java
Patch:
@@ -116,7 +116,7 @@ private native void setupContent(Element el, String sizing) /*-{
       doc.write(
          '<html><head></head>' +
          '<body style="margin: 0; padding: 0; overflow: hidden; border: none">' +
-         '<img id="img" ' + sizing + ' style="display: none" src="javascript:false">' +
+         '<img id="img" ' + sizing + ' style="display: none" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D">' +
          '</body></html>');
       doc.close();
    }-*/;

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -91,6 +91,7 @@ class ClientEvent extends JavaScriptObject
    public static final String BrowserLineChanged = "browser_line_changed";
    public static final String PackageLoaded = "package_loaded";
    public static final String PackageUnloaded = "package_unloaded";
+   public static final String PresentationPaneRequestCompleted = "presentation_pane_request_completed";
    public static final String UnhandledError = "unhandled_error";
    public static final String ErrorHandlerChanged = "error_handler_changed";
 
@@ -109,4 +110,4 @@ public final native String getType() /*-{
    public final native <T> T getData() /*-{
       return this.data;
    }-*/;
-}
\ No newline at end of file
+}

File: src/gwt/src/org/rstudio/core/client/command/AppCommand.java
Patch:
@@ -184,8 +184,8 @@ public String getTooltip()
       String desc = StringUtil.notNull(getDesc());
       String shortcut = getShortcutPrettyHtml();
       shortcut = StringUtil.isNullOrEmpty(shortcut) 
-            ? "" 
-            : "(" + DomUtils.htmlToText(shortcut) + ")";
+                 ? "" 
+                 : "(" + DomUtils.htmlToText(shortcut) + ")";
 
       String result = (desc + " " + shortcut).trim();
       return result.length() == 0 ? null : result;
@@ -283,7 +283,7 @@ public void onClick(ClickEvent event)
    public ToolbarButton createToolbarButton()
    {
       CommandToolbarButton button = new CommandToolbarButton(getButtonLabel(),
-            this, this);
+                                                             this, this);
       if (getTooltip() != null)
          button.setTitle(getTooltip());
       return button;

File: src/gwt/src/org/rstudio/studio/client/application/ui/GlobalToolbar.java
Patch:
@@ -31,7 +31,7 @@
 import com.google.inject.Provider;
 
 
-public class GlobalToolbar extends Toolbar 
+public class GlobalToolbar extends Toolbar
 {
    public GlobalToolbar(Commands commands, 
                         EventBus eventBus,
@@ -43,7 +43,7 @@ public GlobalToolbar(Commands commands,
       ThemeResources res = ThemeResources.INSTANCE;
       addStyleName(res.themeStyles().globalToolbar());
       
-
+      
       // add new source doc commands
       newMenu_ = new ToolbarPopupMenu();
       newMenu_.addItem(commands.newSourceDoc().createMenuItem(false));
@@ -58,7 +58,7 @@ public GlobalToolbar(Commands commands,
       newMenu_.addSeparator();
       newMenu_.addItem(commands.newRDocumentationDoc().createMenuItem(false));
       
-
+      
       // create and add new menu
       StandardIcons icons = StandardIcons.INSTANCE;
       ToolbarButton newButton = new ToolbarButton("",

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellInteractionManager.java
Patch:
@@ -93,7 +93,8 @@ public void consoleWriteError(String error)
    
    @Override
    public void consoleWriteExtendedError(
-         String error, UnhandledError traceInfo, boolean expand)
+         String error, UnhandledError traceInfo, 
+         boolean expand, String command)
    {
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellOutputWriter.java
Patch:
@@ -20,7 +20,8 @@ public interface ShellOutputWriter
 {
    void consoleWriteError(String string);
    void consoleWriteExtendedError(
-         String string, UnhandledError traceInfo, boolean expand);
+         String string, UnhandledError traceInfo, 
+         boolean expand, String command);
    void consoleWriteOutput(String output) ;
    void consoleWritePrompt(String prompt);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -103,8 +103,9 @@ public void setCallFrames(JsArray<CallFrame> frameList, int contextDepth)
          CallFrame frame = frameList.get(idx);
          
          // hide the portion of the callstack containing our source-for-debug
-         // functions
-         if (frame.getFunctionName().contains(".rs.executeDebugSource") ||
+         // functions, and inline evaluations
+         if (frame.getFunctionName().equals(".rs.executeDebugSource") ||
+             frame.getFunctionName().equals("eval") || 
              frame.getFileName().contains("SessionBreakpoints.R"))
          {
             continue;

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeResources.java
Patch:
@@ -190,6 +190,5 @@ public interface ThemeResources extends ClientBundle
    @Source("executingLine.png")
    DataResource executingLine();
    
-   ImageResource switchOn();
-   ImageResource switchOff();
+   ImageResource menuCheck();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -603,5 +603,4 @@ public void onSelected()
    private static final String STATE_INPUT = "input";
 
    private boolean restoreFocus_ = true;
-
 }

File: src/gwt/src/org/rstudio/core/client/command/ImageResourceProvider.java
Patch:
@@ -16,8 +16,10 @@
 package org.rstudio.core.client.command;
 
 import com.google.gwt.resources.client.ImageResource;
+import com.google.gwt.user.client.ui.Image;
 
 public interface ImageResourceProvider
 {
    public ImageResource getImageResource();
+   public void addRenderedImage(Image image);
 }

File: src/gwt/src/org/rstudio/studio/client/application/ui/impl/DesktopApplicationHeader.java
Patch:
@@ -36,6 +36,7 @@
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.application.ui.ApplicationHeader;
 import org.rstudio.studio.client.application.ui.GlobalToolbar;
+import org.rstudio.studio.client.common.debugging.ErrorManager;
 import org.rstudio.studio.client.workbench.codesearch.CodeSearch;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.events.SessionInitEvent;
@@ -66,7 +67,8 @@ public void initialize(Commands commands,
                           final Session session,
                           WorkbenchServerOperations server,
                           Provider<DesktopHooks> pDesktopHooks,
-                          Provider<CodeSearch> pCodeSearch)
+                          Provider<CodeSearch> pCodeSearch,
+                          ErrorManager errorManager)
    {
       session_ = session;
       eventBus_= events;

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellInteractionManager.java
Patch:
@@ -93,7 +93,7 @@ public void consoleWriteError(String error)
    
    @Override
    public void consoleWriteExtendedError(
-         String error, UnhandledError traceInfo)
+         String error, UnhandledError traceInfo, boolean expand)
    {
    }
    

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellOutputWriter.java
Patch:
@@ -19,7 +19,8 @@
 public interface ShellOutputWriter 
 {
    void consoleWriteError(String string);
-   void consoleWriteExtendedError(String string, UnhandledError traceInfo);
+   void consoleWriteExtendedError(
+         String string, UnhandledError traceInfo, boolean expand);
    void consoleWriteOutput(String output) ;
    void consoleWritePrompt(String prompt);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -256,7 +256,8 @@ public void execute()
             if (err != null
                 && err.getErrorMessage().equals(event.getError()))
             {
-               view_.consoleWriteExtendedError(event.getError(), err);
+               view_.consoleWriteExtendedError(
+                     event.getError(), err, errorManager_.getExpandTraceback());
             }
             else
             {

File: src/gwt/src/org/rstudio/studio/client/common/debugging/DebuggingServerOperations.java
Patch:
@@ -56,5 +56,6 @@ public void executeDebugSource(
    
    public void setErrorManagementType(
          int type,
+         boolean inMyCode,
          ServerRequestCallback<Void> requestCallback);
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -2923,10 +2923,12 @@ public void executeDebugSource(
    
    public void setErrorManagementType(
          int type,
+         boolean inMyCode,
          ServerRequestCallback<Void> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONNumber(type));
+      params.set(1, JSONBoolean.getInstance(inMyCode));
       
       sendRequest(RPC_SCOPE, 
             SET_ERROR_MANAGEMENT_TYPE, 

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -315,10 +315,9 @@
    public abstract AppCommand debugStop();
    public abstract AppCommand debugStep();
    public abstract AppCommand debugHelp();   
-   public abstract AppCommand errorsAutomatic();
+   public abstract AppCommand errorsMessage();
+   public abstract AppCommand errorsTraceback();
    public abstract AppCommand errorsBreak();
-   public abstract AppCommand errorsBreakUser();
-   public abstract AppCommand errorsIgnore();
    public abstract AppCommand errorsInMyCode();
    public abstract AppCommand errorsExpandTraceback();
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -398,7 +398,7 @@ public void onDebugModeChanged(DebugModeChangedEvent event)
    public void onRerunLastCommand(RerunLastCommandEvent event)
    {
       errorManager_.setDebugSessionHandlerType(
-            ErrorHandlerType.ERRORS_BREAK_ALWAYS,
+            ErrorHandlerType.ERRORS_BREAK,
             new ServerRequestCallback<Void>()
             {
                @Override

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -91,6 +91,7 @@ class ClientEvent extends JavaScriptObject
    public static final String BrowserLineChanged = "browser_line_changed";
    public static final String PackageLoaded = "package_loaded";
    public static final String PackageUnloaded = "package_unloaded";
+   public static final String PresentationPaneRequestCompleted = "presentation_pane_request_completed";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleErrorFrame.java
Patch:
@@ -49,7 +49,7 @@ public ConsoleErrorFrame(ErrorFrame frame, ConsoleError.Observer observer)
       functionName.setText(frame.getFunctionName() + (hasSource ? " at " : ""));
       if (hasSource)
       {
-         sourceLink.setText(frame.getFileName());
+         sourceLink.setText(frame.getFileName() + "#" + frame.getLineNumber());
          sourceLink.addClickHandler(new ClickHandler()
          {            
             @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -318,6 +318,7 @@
    public abstract AppCommand errorsAutomatic();
    public abstract AppCommand errorsBreak();
    public abstract AppCommand errorsBreakUser();
+   public abstract AppCommand errorsIgnore();
    
    // Other
    public abstract AppCommand checkSpelling();   

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -21,7 +21,6 @@
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.RepeatingCommand;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.core.client.js.JsObject;
 import org.rstudio.core.client.jsonrpc.RpcObjectList;
@@ -502,8 +501,8 @@ else if (type.equals(ClientEvent.UnhandledError))
          }
          else if (type.equals(ClientEvent.ErrorHandlerChanged))
          {
-            ErrorHandlerType type = event.getData();
-            eventBus_.fireEvent(new ErrorHandlerChangedEvent(type));
+            ErrorHandlerType handlerType = event.getData();
+            eventBus_.fireEvent(new ErrorHandlerChangedEvent(handlerType));
          }
          else
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/ConsoleTabPanel.java
Patch:
@@ -44,7 +44,6 @@ public ConsoleTabPanel(final PrimaryWindowFrame owner,
       compilePdfTab_ = compilePdfTab;
       findResultsTab_ = findResultsTab;
       sourceCppTab_ = sourceCppTab;
-      consoleInterrupt_ = consoleInterrupt;
       consoleInterruptWidget_ = new ExplicitSizeWidget(
             consoleInterrupt, consoleInterrupt);
       goToWorkingDirButton_ = goToWorkingDirButton;
@@ -188,7 +187,6 @@ private void managePanels()
    private final FindOutputTab findResultsTab_;
    private final WorkbenchTab sourceCppTab_;
    private boolean sourceCppTabVisible_;
-   private ConsoleInterruptButton consoleInterrupt_;
    private ExplicitSizeWidget consoleInterruptWidget_;
    private final ToolbarButton goToWorkingDirButton_;
    private boolean findResultsTabVisible_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -250,7 +250,8 @@ public void onConsoleWriteError(final ConsoleWriteErrorEvent event)
          public void execute()
          {
             UnhandledError err = errorManager_.consumeLastError();
-            if (err.getErrorMessage().equals(event.getError()))
+            if (err != null
+                && err.getErrorMessage().equals(event.getError()))
             {
                view_.consoleWriteExtendedError(event.getError(), err);
             }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -92,6 +92,7 @@ class ClientEvent extends JavaScriptObject
    public static final String PackageLoaded = "package_loaded";
    public static final String PackageUnloaded = "package_unloaded";
    public static final String UnhandledError = "unhandled_error";
+   public static final String ErrorHandlerChanged = "error_handler_changed";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/common/debugging/model/ErrorFrame.java
Patch:
@@ -15,9 +15,9 @@
 
 package org.rstudio.studio.client.common.debugging.model;
 
-import com.google.gwt.core.client.JavaScriptObject;
+import org.rstudio.studio.client.workbench.views.environment.events.LineData;
 
-public class ErrorFrame extends JavaScriptObject
+public class ErrorFrame extends LineData
 {
    protected ErrorFrame() {}
    

File: src/gwt/src/org/rstudio/studio/client/common/debugging/model/UnhandledError.java
Patch:
@@ -15,11 +15,10 @@
 
 package org.rstudio.studio.client.common.debugging.model;
 
-import org.rstudio.studio.client.workbench.views.environment.events.LineData;
-
+import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
 
-public class UnhandledError extends LineData
+public class UnhandledError extends JavaScriptObject
 {
    protected UnhandledError() {}
    

File: src/gwt/src/org/rstudio/studio/client/common/debugging/ui/ConsoleError.java
Patch:
@@ -1,5 +1,6 @@
 package org.rstudio.studio.client.common.debugging.ui;
 
+import org.rstudio.studio.client.common.debugging.model.ErrorFrame;
 import org.rstudio.studio.client.common.debugging.model.UnhandledError;
 
 import com.google.gwt.core.client.GWT;
@@ -26,6 +27,7 @@ interface ConsoleErrorUiBinder extends UiBinder<Widget, ConsoleError>
    public interface Observer
    {
       void onErrorBoxResize();
+      void showSourceForFrame(ErrorFrame frame);
    }
 
    public ConsoleError(UnhandledError err, String errorClass, Observer observer)
@@ -53,7 +55,7 @@ public void onClick(ClickEvent event)
       for (int i = err.getErrorFrames().length() - 1; i >= 0; i--)
       {
          ConsoleErrorFrame frame = new ConsoleErrorFrame(
-               err.getErrorFrames().get(i));
+               err.getErrorFrames().get(i), observer_);
          framePanel.add(frame);
       }
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ShellPane.java
Patch:
@@ -19,6 +19,7 @@
 import com.google.gwt.user.client.ui.*;
 import com.google.inject.Inject;
 import org.rstudio.core.client.CommandWithArg;
+import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.common.shell.ShellWidget;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
@@ -27,9 +28,9 @@
 public class ShellPane extends ShellWidget implements Shell.Display
 {
    @Inject
-   public ShellPane(final AceEditor editor, UIPrefs uiPrefs)
+   public ShellPane(final AceEditor editor, UIPrefs uiPrefs, EventBus events)
    {
-      super(editor);
+      super(editor, events);
 
       editor.setDisableOverwrite(true);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/ConsoleProgressWidget.java
Patch:
@@ -22,7 +22,7 @@ public class ConsoleProgressWidget extends ShellWidget implements ShellDisplay
 {
    public ConsoleProgressWidget()
    {
-      super(new AceEditor());     
+      super(new AceEditor(), null);     
    }
    
   

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -154,7 +154,4 @@ public interface ThemeStyles extends CssResource
    String fullscreenCaptionLabel();
    
    String presentationNavigatorLabel();
-   
-   String consoleErrorBox();
-   String consoleErrorTraceback();
 }

File: src/gwt/src/org/rstudio/studio/client/common/debugging/model/ErrorFrame.java
Patch:
@@ -26,6 +26,6 @@ public final native String getFunctionName() /*-{
    }-*/;
 
    public final native String getFileName() /*-{
-      return this.file;
+      return this.file.trim();
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -91,6 +91,7 @@ class ClientEvent extends JavaScriptObject
    public static final String BrowserLineChanged = "browser_line_changed";
    public static final String PackageLoaded = "package_loaded";
    public static final String PackageUnloaded = "package_unloaded";
+   public static final String UnhandledError = "unhandled_error";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/common/debugging/DebuggingServerOperations.java
Patch:
@@ -30,12 +30,14 @@ public interface DebuggingServerOperations
    public void getFunctionSteps(
          String functionName,
          String fileName,
+         String packageName,
          int[] lineNumbers,
          ServerRequestCallback<JsArray<FunctionSteps>> requestCallback);
    
    public void setFunctionBreakpoints(
          String functionName,
          String fileName,
+         String packageName,
          ArrayList<String> steps,
          ServerRequestCallback<Void> requestCallback);
    

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -154,4 +154,7 @@ public interface ThemeStyles extends CssResource
    String fullscreenCaptionLabel();
    
    String presentationNavigatorLabel();
+   
+   String consoleErrorBox();
+   String consoleErrorTraceback();
 }

File: src/gwt/src/org/rstudio/studio/client/common/debugging/DebuggingServerOperations.java
Patch:
@@ -30,12 +30,14 @@ public interface DebuggingServerOperations
    public void getFunctionSteps(
          String functionName,
          String fileName,
+         String packageName,
          int[] lineNumbers,
          ServerRequestCallback<JsArray<FunctionSteps>> requestCallback);
    
    public void setFunctionBreakpoints(
          String functionName,
          String fileName,
+         String packageName,
          ArrayList<String> steps,
          ServerRequestCallback<Void> requestCallback);
    

File: src/gwt/src/org/rstudio/studio/client/common/debugging/model/FunctionState.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * FunctionSteps.java
+ * FunctionState.java
  *
  * Copyright (C) 2009-12 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -844,7 +844,7 @@ else if (isPackageFile())
          else if (hasPackagePendingBreakpoints)
          {
             message = "Breakpoints will be activated when an updated version " +
-            	   	  "of the " + pendingPackageName + " package is loaded";
+                      "of the " + pendingPackageName + " package is loaded";
          }
          else
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -843,8 +843,8 @@ else if (isPackageFile())
          }
          else if (hasPackagePendingBreakpoints)
          {
-            message = "Breakpoints will be activated when the " + 
-                      pendingPackageName + " package is loaded";
+            message = "Breakpoints will be activated when an updated version " +
+            	   	  "of the " + pendingPackageName + " package is loaded";
          }
          else
          {

File: src/gwt/src/org/rstudio/studio/client/common/debugging/model/Breakpoint.java
Patch:
@@ -31,7 +31,7 @@ protected Breakpoint() {}
    public final static int STATE_PROCESSING = 0;
    public final static int STATE_ACTIVE = 1;
    public final static int STATE_INACTIVE = 2;
-   public final static int STATE_DUPLICATE = 3;
+   public final static int STATE_REMOVING = 3;
    
    public final static int TYPE_FUNCTION = 0;
    public final static int TYPE_TOPLEVEL = 1;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RFileType.java
Patch:
@@ -61,6 +61,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       result.add(commands.goToFunctionDefinition());
       result.add(commands.insertSection());
       result.add(commands.codeCompletion());
+      result.add(commands.debugBreakpoint());
       return result;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -309,9 +309,12 @@
    public abstract AppCommand clearRecentFiles();
 
    // Debugging
+   public abstract AppCommand debugBreakpoint();
+   public abstract AppCommand debugClearBreakpoints();
    public abstract AppCommand debugContinue();
    public abstract AppCommand debugStop();
    public abstract AppCommand debugStep();
+   public abstract AppCommand debugHelp();   
 
    // Other
    public abstract AppCommand checkSpelling();   

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -248,6 +248,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.checkSpelling());
       dynamicCommands_.add(commands.codeCompletion());
       dynamicCommands_.add(commands.rcppHelp());
+      dynamicCommands_.add(commands.debugBreakpoint());
       for (AppCommand command : dynamicCommands_)
       {
          command.setVisible(false);
@@ -1800,6 +1801,7 @@ private void manageCommands()
       commands_.saveSourceDocAs().setVisible(true);
       commands_.printSourceDoc().setVisible(true);
       commands_.setWorkingDirToActiveDoc().setVisible(true);
+      commands_.debugBreakpoint().setVisible(true);
       
       // manage synctex commands
       manageSynctexCommands();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -216,5 +216,6 @@ void highlightDebugLocation(
    void addOrUpdateBreakpoint(Breakpoint breakpoint);
    void removeBreakpoint(Breakpoint breakpoint);
    void removeAllBreakpoints();
+   void toggleBreakpointAtCursor();
    boolean hasBreakpoints();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -830,7 +830,6 @@ else if (breakpoint.isPackageBreakpoint())
 
       if (showWarning && !isBreakpointWarningVisible_)
       {
-         
          String message = "";
          if (hasDebugPendingBreakpoints) 
          {

File: src/gwt/src/org/rstudio/studio/client/common/debugging/model/Breakpoint.java
Patch:
@@ -31,7 +31,7 @@ protected Breakpoint() {}
    public final static int STATE_PROCESSING = 0;
    public final static int STATE_ACTIVE = 1;
    public final static int STATE_INACTIVE = 2;
-   public final static int STATE_DUPLICATE = 3;
+   public final static int STATE_REMOVING = 3;
    
    public final static int TYPE_FUNCTION = 0;
    public final static int TYPE_TOPLEVEL = 1;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RFileType.java
Patch:
@@ -61,6 +61,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       result.add(commands.goToFunctionDefinition());
       result.add(commands.insertSection());
       result.add(commands.codeCompletion());
+      result.add(commands.debugBreakpoint());
       return result;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -309,9 +309,12 @@
    public abstract AppCommand clearRecentFiles();
 
    // Debugging
+   public abstract AppCommand debugBreakpoint();
+   public abstract AppCommand debugClearBreakpoints();
    public abstract AppCommand debugContinue();
    public abstract AppCommand debugStop();
    public abstract AppCommand debugStep();
+   public abstract AppCommand debugHelp();   
 
    // Other
    public abstract AppCommand checkSpelling();   

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -248,6 +248,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.checkSpelling());
       dynamicCommands_.add(commands.codeCompletion());
       dynamicCommands_.add(commands.rcppHelp());
+      dynamicCommands_.add(commands.debugBreakpoint());
       for (AppCommand command : dynamicCommands_)
       {
          command.setVisible(false);
@@ -1800,6 +1801,7 @@ private void manageCommands()
       commands_.saveSourceDocAs().setVisible(true);
       commands_.printSourceDoc().setVisible(true);
       commands_.setWorkingDirToActiveDoc().setVisible(true);
+      commands_.debugBreakpoint().setVisible(true);
       
       // manage synctex commands
       manageSynctexCommands();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -216,5 +216,6 @@ void highlightDebugLocation(
    void addOrUpdateBreakpoint(Breakpoint breakpoint);
    void removeBreakpoint(Breakpoint breakpoint);
    void removeAllBreakpoints();
+   void toggleBreakpointAtCursor();
    boolean hasBreakpoints();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RFileType.java
Patch:
@@ -61,6 +61,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       result.add(commands.goToFunctionDefinition());
       result.add(commands.insertSection());
       result.add(commands.codeCompletion());
+      result.add(commands.debugBreakpoint());
       return result;
    }
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -243,7 +243,6 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
          results.add(commands.commentUncomment());
          results.add(commands.reindent());
          results.add(commands.reflowComment());
-         results.add(commands.debugBreakpoint());
       }
       if (canExecuteAllCode())
       {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -237,6 +237,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       if (canExecuteCode())
       {
          results.add(commands.executeCode());
+         results.add(commands.executeCodeWithoutFocus());
          results.add(commands.executeLastCode());
          results.add(commands.extractFunction());
          results.add(commands.commentUncomment());

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -48,6 +48,7 @@
    public abstract AppCommand sourceActiveDocument();
    public abstract AppCommand sourceActiveDocumentWithEcho();
    public abstract AppCommand executeCode();
+   public abstract AppCommand executeCodeWithoutFocus();
    public abstract AppCommand executeToCurrentLine();
    public abstract AppCommand executeFromCurrentLine();
    public abstract AppCommand executeCurrentFunction();

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/GeneralPreferencesPane.java
Patch:
@@ -102,6 +102,8 @@ public void onClick(ClickEvent event)
       restoreLastProject_ = new CheckBox("Restore most recently opened project at startup");
       lessSpaced(restoreLastProject_);
       add(restoreLastProject_);
+      
+      add(checkboxPref("Restore previously open source documents at startup", prefs_.restoreSourceDocuments()));
         
       add(loadRData_ = new CheckBox("Restore .RData into workspace at startup"));
       lessSpaced(loadRData_); 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -242,6 +242,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
          results.add(commands.commentUncomment());
          results.add(commands.reindent());
          results.add(commands.reflowComment());
+         results.add(commands.debugBreakpoint());
       }
       if (canExecuteAllCode())
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -308,9 +308,11 @@
    public abstract AppCommand clearRecentFiles();
 
    // Debugging
+   public abstract AppCommand debugBreakpoint();
    public abstract AppCommand debugContinue();
    public abstract AppCommand debugStop();
    public abstract AppCommand debugStep();
+   public abstract AppCommand debugHelp();   
 
    // Other
    public abstract AppCommand checkSpelling();   

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -247,6 +247,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.checkSpelling());
       dynamicCommands_.add(commands.codeCompletion());
       dynamicCommands_.add(commands.rcppHelp());
+      dynamicCommands_.add(commands.debugBreakpoint());
       for (AppCommand command : dynamicCommands_)
       {
          command.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -216,5 +216,6 @@ void highlightDebugLocation(
    void addOrUpdateBreakpoint(Breakpoint breakpoint);
    void removeBreakpoint(Breakpoint breakpoint);
    void removeAllBreakpoints();
+   void toggleBreakpointAtCursor();
    boolean hasBreakpoints();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/common/debugging/BreakpointManager.java
Patch:
@@ -246,7 +246,7 @@ public void onSessionInit(SessionInitEvent sie)
    {
       new JSObjectStateValue(
             "debug-breakpoints",
-            "debugBreakpointState",
+            "debugBreakpointsState",
             ClientState.PROJECT_PERSISTENT,
             session_.getSessionInfo().getClientState(),
             false)

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -3168,7 +3168,6 @@ public void executeDebugSource(
    private static final String GET_FUNCTION_STEPS = "get_function_steps";
    private static final String SET_FUNCTION_BREAKPOINTS = "set_function_breakpoints";
    private static final String GET_FUNCTION_SYNC_STATE = "get_function_sync_state";
-   private static final String SOURCE_FOR_DEBUGGING = "source_for_debugging";
    private static final String EXECUTE_DEBUG_SOURCE = "execute_debug_source";
    
    private static final String LOG = "log";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -104,7 +104,8 @@ public void setCallFrames(JsArray<CallFrame> frameList, int contextDepth)
          
          // hide the portion of the callstack containing our source-for-debug
          // functions
-         if (frame.getFunctionName().contains(".rs.executeDebugSource"))
+         if (frame.getFunctionName().contains(".rs.executeDebugSource") ||
+             frame.getFileName().contains("SessionBreakpoints.R"))
          {
             continue;
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/Console.java
Patch:
@@ -31,7 +31,6 @@
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleHandler;
 import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent;
-import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent.DebugMode;
 
 public class Console
 {
@@ -87,7 +86,7 @@ public void onConsolePrompt(ConsolePromptEvent event)
          @Override
          public void onDebugModeChanged(DebugModeChangedEvent event)
          {
-            view.setDebugMode(event.getDebugMode() != DebugMode.Normal);
+            view.setDebugMode(event.debugging());
          }
       });
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -51,7 +51,6 @@
 import org.rstudio.studio.client.workbench.views.console.shell.assist.RCompletionManager;
 import org.rstudio.studio.client.workbench.views.console.shell.editor.InputEditorDisplay;
 import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent;
-import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent.DebugMode;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceEditorNative;
 
 import java.util.ArrayList;
@@ -347,7 +346,7 @@ public void onExecutePendingInput(ConsoleExecutePendingInputEvent event)
    @Override
    public void onDebugModeChanged(DebugModeChangedEvent event)
    {
-      if (event.getDebugMode() != DebugMode.Normal)
+      if (event.debugging())
       {
          view_.ensureInputVisible();
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -32,6 +32,7 @@
 import org.rstudio.studio.client.common.FileDialogs;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.debugging.DebugCommander;
+import org.rstudio.studio.client.common.debugging.DebugCommander.DebugMode;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.common.filetypes.events.OpenDataFileEvent;
 import org.rstudio.studio.client.common.filetypes.events.OpenDataFileHandler;
@@ -63,7 +64,6 @@
 import org.rstudio.studio.client.workbench.views.environment.events.EnvironmentObjectAssignedEvent;
 import org.rstudio.studio.client.workbench.views.environment.events.EnvironmentObjectRemovedEvent;
 import org.rstudio.studio.client.workbench.views.environment.events.EnvironmentRefreshEvent;
-import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent.DebugMode;
 import org.rstudio.studio.client.workbench.views.environment.model.CallFrame;
 import org.rstudio.studio.client.workbench.views.environment.model.DownloadInfo;
 import org.rstudio.studio.client.workbench.views.environment.model.EnvironmentServerOperations;

File: src/gwt/src/org/rstudio/studio/client/common/FilePathUtils.java
Patch:
@@ -15,7 +15,6 @@
 
 package org.rstudio.studio.client.common;
 
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.files.FileSystemItem;
 
 public class FilePathUtils

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -415,6 +415,6 @@ public final native StatusAndPathInfo getSVNStatus() /*-{
    private static final FileIconResources RES = FileIconResources.INSTANCE;
    
    public static final String HOME_PATH = "~";
-   private static final String HOME_PREFIX = HOME_PATH + "/";
+   public static final String HOME_PREFIX = HOME_PATH + "/";
    private static final String PUBLIC = "Public";
 }

File: src/gwt/src/org/rstudio/studio/client/common/debugging/model/Breakpoint.java
Patch:
@@ -169,5 +169,5 @@ public final native String getPath()
    public final native int getType()
    /*-{
       return this.type;
-   }-*/;
+   }-*/;   
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/Workbench.java
Patch:
@@ -245,7 +245,8 @@ public void execute(FileSystemItem input, ProgressIndicator indicator)
                         pPrefs_.get().defaultEncoding().getValue(),
                         false,
                         false,
-                        true); // focus
+                        true,
+                        false);
 
                   commands_.activateConsole().execute();
                }

File: src/gwt/src/org/rstudio/studio/client/common/debugging/model/TopLevelLineData.java
Patch:
@@ -15,7 +15,7 @@ public final native int getStep() /*-{
    }-*/;
    
    public final native boolean getFinished() /*-{
-      return this.step == 0;
+      return this.state == 2;
    }-*/;
    
    public final native int getState() /*-{

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -33,6 +33,7 @@
 import org.rstudio.studio.client.common.console.ConsoleProcess.ConsoleProcessFactory;
 import org.rstudio.studio.client.common.crypto.CryptoServerOperations;
 import org.rstudio.studio.client.common.debugging.BreakpointManager;
+import org.rstudio.studio.client.common.debugging.DebugCommander;
 import org.rstudio.studio.client.common.debugging.DebuggingServerOperations;
 import org.rstudio.studio.client.common.filetypes.FileTypeCommands;
 import org.rstudio.studio.client.common.latex.LatexProgramRegistry;
@@ -190,6 +191,7 @@ protected void configure()
       bind(PDFViewer.class).in(Singleton.class);
       bind(HTMLPreview.class).in(Singleton.class);      
       bind(BreakpointManager.class).asEagerSingleton();
+      bind(DebugCommander.class).asEagerSingleton();
 
       bind(ApplicationView.class).to(ApplicationWindow.class)
             .in(Singleton.class) ;

File: src/gwt/src/org/rstudio/studio/client/common/debugging/DebuggingServerOperations.java
Patch:
@@ -21,6 +21,7 @@
 
 import org.rstudio.studio.client.common.debugging.model.Breakpoint;
 import org.rstudio.studio.client.common.debugging.model.FunctionSteps;
+import org.rstudio.studio.client.common.debugging.model.TopLevelLineData;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.Void;
 
@@ -52,5 +53,5 @@ public void executeDebugSource(
          String fileName,
          int step, 
          int mode, 
-         ServerRequestCallback<Void> requestCallback);
+         ServerRequestCallback<TopLevelLineData> requestCallback);
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -64,7 +64,6 @@
 import org.rstudio.studio.client.workbench.views.edit.events.ShowEditorEvent;
 import org.rstudio.studio.client.workbench.views.edit.model.ShowEditorData;
 import org.rstudio.studio.client.workbench.views.environment.events.*;
-import org.rstudio.studio.client.workbench.views.environment.events.BrowserLineChangedEvent.LineData;
 import org.rstudio.studio.client.workbench.views.environment.model.RObject;
 import org.rstudio.studio.client.workbench.views.files.events.DirectoryNavigateEvent;
 import org.rstudio.studio.client.workbench.views.files.events.FileChangeEvent;

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -39,6 +39,7 @@
 import org.rstudio.studio.client.common.crypto.PublicKeyInfo;
 import org.rstudio.studio.client.common.debugging.model.Breakpoint;
 import org.rstudio.studio.client.common.debugging.model.FunctionSteps;
+import org.rstudio.studio.client.common.debugging.model.TopLevelLineData;
 import org.rstudio.studio.client.common.mirrors.model.CRANMirror;
 import org.rstudio.studio.client.common.satellite.Satellite;
 import org.rstudio.studio.client.common.satellite.SatelliteManager;
@@ -2948,7 +2949,7 @@ public void executeDebugSource(
          String fileName,
          int step, 
          int mode, 
-         ServerRequestCallback<Void> requestCallback)
+         ServerRequestCallback<TopLevelLineData> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(fileName));

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/Console.java
Patch:
@@ -31,6 +31,7 @@
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleHandler;
 import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent;
+import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent.DebugMode;
 
 public class Console
 {
@@ -86,7 +87,7 @@ public void onConsolePrompt(ConsolePromptEvent event)
          @Override
          public void onDebugModeChanged(DebugModeChangedEvent event)
          {
-            view.setDebugMode(event.getDebugMode());
+            view.setDebugMode(event.getDebugMode() != DebugMode.Normal);
          }
       });
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/Shell.java
Patch:
@@ -51,6 +51,7 @@
 import org.rstudio.studio.client.workbench.views.console.shell.assist.RCompletionManager;
 import org.rstudio.studio.client.workbench.views.console.shell.editor.InputEditorDisplay;
 import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent;
+import org.rstudio.studio.client.workbench.views.environment.events.DebugModeChangedEvent.DebugMode;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceEditorNative;
 
 import java.util.ArrayList;
@@ -346,7 +347,7 @@ public void onExecutePendingInput(ConsoleExecutePendingInputEvent event)
    @Override
    public void onDebugModeChanged(DebugModeChangedEvent event)
    {
-      if (event.getDebugMode())
+      if (event.getDebugMode() != DebugMode.Normal)
       {
          view_.ensureInputVisible();
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -215,5 +215,6 @@ void highlightDebugLocation(
       (BreakpointMoveEvent.Handler handler);
    void addOrUpdateBreakpoint(Breakpoint breakpoint);
    void removeBreakpoint(Breakpoint breakpoint);
+   void removeAllBreakpoints();
    boolean hasBreakpoints();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -64,7 +64,7 @@ public final native String getPath() /*-{
       return this.path;
    }-*/;
 
-   private final native String getRawPath() /*-{
+   public final native String getRawPath() /*-{
       return this.raw_path || this.path;
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceDocument.java
Patch:
@@ -43,7 +43,7 @@ public native final String getPath() /*-{
    }-*/;
 
    public native final String getRawPath() /*-{
-      return this.raw_path;
+      return this.raw_path ? this.raw_path : this.path;
    }-*/;
 
    public native final void setPath(String path) /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -563,6 +563,7 @@ private void autoSizeCallFramePanel()
          splitPanel.setWidgetSize(
                callFramePanel_, desiredCallFramePanelSize);
          callFramePanel_.onResize();
+         objectList_.onResize();
       }
       
       pendingCallFramePanelSize_ = false;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanelStyle.java
Patch:
@@ -19,6 +19,5 @@
 
 public interface CallFramePanelStyle extends CssResource
 {
-   int callFramePanelMargin();
    String tracebackHeader();
 }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsPackagePanel.java
Patch:
@@ -129,7 +129,7 @@ public void initialize(WorkbenchContext workbenchContext)
    @Override
    protected void provideDefaults()
    {
-      installAdditionalArguments_.setText("--no-multiarch");
+      installAdditionalArguments_.setText("--no-multiarch --with-keep.source");
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchServerOperations.java
Patch:
@@ -19,6 +19,7 @@
 import org.rstudio.studio.client.common.compilepdf.model.CompilePdfServerOperations;
 import org.rstudio.studio.client.common.console.ConsoleProcess;
 import org.rstudio.studio.client.common.crypto.CryptoServerOperations;
+import org.rstudio.studio.client.common.debugging.DebuggingServerOperations;
 import org.rstudio.studio.client.common.mirrors.model.MirrorsServerOperations;
 import org.rstudio.studio.client.common.spelling.model.SpellingServerOperations;
 import org.rstudio.studio.client.common.synctex.model.SynctexServerOperations;
@@ -69,7 +70,8 @@ public interface WorkbenchServerOperations extends ConsoleServerOperations,
                                                    SynctexServerOperations,
                                                    BuildServerOperations,
                                                    PresentationServerOperations,
-                                                   EnvironmentServerOperations
+                                                   EnvironmentServerOperations,
+                                                   DebuggingServerOperations
 {   
    void initializeForMainWorkbench();
    void disconnect();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -256,19 +256,19 @@ void onRefreshEnvironment()
    @Handler
    void onDebugContinue()
    {
-      eventBus_.fireEvent(new SendToConsoleEvent("c", true));
+      eventBus_.fireEvent(new SendToConsoleEvent("c", true, true));
    }
    
    @Handler
    void onDebugStop()
    {
-      eventBus_.fireEvent(new SendToConsoleEvent("Q", true));     
+      eventBus_.fireEvent(new SendToConsoleEvent("Q", true, true));     
    }
 
    @Handler
    void onDebugStep()
    {
-      eventBus_.fireEvent(new SendToConsoleEvent("n", true));     
+      eventBus_.fireEvent(new SendToConsoleEvent("n", true, true));     
    }
 
    void onClearWorkspace()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFrameItem.java
Patch:
@@ -44,7 +44,7 @@ interface Style extends CssResource
       String hiddenFrame();
    }
 
-   public CallFrameItem(CallFrame frame, Observer observer)
+   public CallFrameItem(CallFrame frame, Observer observer, boolean hidden)
    {
       isActive_ = false;
       isVisible_ = true;
@@ -59,7 +59,7 @@ public CallFrameItem(CallFrame frame, Observer observer)
          // hide call frames for which we don't have usable sources--but leave
          // them in the DOM (we may want to easily show/hide these at the user's
          // request)
-         if (frame.getContextDepth() > 1)
+         if (hidden)
          {
             functionName.addStyleName(style.hiddenFrame());
             isVisible_ = false;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -172,6 +172,7 @@
    public abstract AppCommand presentationPublishToRpubs();
    public abstract AppCommand activatePresentation();
    public abstract AppCommand tutorialFeedback();
+   public abstract AppCommand clearPresentationCache();
    
    // View
    public abstract AppCommand showToolbar();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFrameItem.java
Patch:
@@ -44,7 +44,7 @@ interface Style extends CssResource
       String hiddenFrame();
    }
 
-   public CallFrameItem(CallFrame frame, Observer observer)
+   public CallFrameItem(CallFrame frame, Observer observer, boolean hidden)
    {
       isActive_ = false;
       isVisible_ = true;
@@ -59,7 +59,7 @@ public CallFrameItem(CallFrame frame, Observer observer)
          // hide call frames for which we don't have usable sources--but leave
          // them in the DOM (we may want to easily show/hide these at the user's
          // request)
-         if (frame.getContextDepth() > 1)
+         if (hidden)
          {
             functionName.addStyleName(style.hiddenFrame());
             isVisible_ = false;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentClientState.java
Patch:
@@ -39,6 +39,6 @@ public final native int getScrollPosition() /*-{
    }-*/;
 
    public final native JsArrayString getExpandedObjects() /*-{
-       return this.expanded_objects;
+       return this.expanded_objects ? this.expanded_objects : [];
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationPane.java
Patch:
@@ -89,6 +89,8 @@ protected Toolbar createMainToolbar()
       if (!isTutorial)
       { 
          ToolbarPopupMenu moreMenu = new ToolbarPopupMenu();
+         moreMenu.addItem(commands_.clearPresentationCache().createMenuItem(false));
+         moreMenu.addSeparator();
          moreMenu.addItem(commands_.presentationViewInBrowser().createMenuItem(false));
          moreMenu.addItem(commands_.presentationSaveAsStandalone().createMenuItem(false));
          moreMenu.addSeparator();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/PresentationTab.java
Patch:
@@ -64,6 +64,7 @@ public void onSessionInit(SessionInitEvent sie)
             
             if (state.isTutorial())
             {
+               commands.clearPresentationCache().remove();
                commands.presentationViewInBrowser().remove();
                commands.presentationSaveAsStandalone().remove();
                commands.presentationPublishToRpubs().remove();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/model/PresentationServerOperations.java
Patch:
@@ -66,4 +66,6 @@ void getSlideNavigationForCode(
                      String baseDir,
                      ServerRequestCallback<SlideNavigation> requestCallback);
    
+   void clearPresentationCache(ServerRequestCallback<Void> requestCallback);
+   
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -88,11 +88,11 @@ protected Toolbar createMainToolbar()
    protected SecondaryToolbar createSecondaryToolbar()
    {
       SecondaryToolbar toolbar = new SecondaryToolbar(true);
+      toolbar.addLeftWidget(commands_.debugStep().createToolbarButton());      
+      toolbar.addLeftSeparator();
       toolbar.addLeftWidget(commands_.debugContinue().createToolbarButton());
       toolbar.addLeftSeparator();
       toolbar.addLeftWidget(commands_.debugStop().createToolbarButton());
-      toolbar.addLeftSeparator();
-      toolbar.addLeftWidget(commands_.debugStep().createToolbarButton());      
       return toolbar;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -256,19 +256,19 @@ void onRefreshEnvironment()
    @Handler
    void onDebugContinue()
    {
-      eventBus_.fireEvent(new SendToConsoleEvent("c", true));
+      eventBus_.fireEvent(new SendToConsoleEvent("c", true, true));
    }
    
    @Handler
    void onDebugStop()
    {
-      eventBus_.fireEvent(new SendToConsoleEvent("Q", true));     
+      eventBus_.fireEvent(new SendToConsoleEvent("Q", true, true));     
    }
 
    @Handler
    void onDebugStep()
    {
-      eventBus_.fireEvent(new SendToConsoleEvent("n", true));     
+      eventBus_.fireEvent(new SendToConsoleEvent("n", true, true));     
    }
 
    void onClearWorkspace()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentClientState.java
Patch:
@@ -39,6 +39,6 @@ public final native int getScrollPosition() /*-{
    }-*/;
 
    public final native JsArrayString getExpandedObjects() /*-{
-       return this.expanded_objects;
+       return this.expanded_objects ? this.expanded_objects : [];
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -634,7 +634,8 @@ private void buildDescriptionColumn(RObjectEntry rowValue,
          // build the column containing the description of the object
          TableCellBuilder descCol = row.startTD();
          String title = rowValue.rObject.getValue();
-         if (!title.equals("NO_VALUE"))
+         if ((!title.equals("NO_VALUE")) &&
+             title != null)
          {
             if (rowValue.isPromise())
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/ConsolePane.java
Patch:
@@ -88,11 +88,11 @@ protected Toolbar createMainToolbar()
    protected SecondaryToolbar createSecondaryToolbar()
    {
       SecondaryToolbar toolbar = new SecondaryToolbar(true);
-      toolbar.addLeftWidget(commands_.debugContinue().createToolbarButton());
+      toolbar.addLeftWidget(commands_.debugStep().createToolbarButton());  
       toolbar.addLeftSeparator();
-      toolbar.addLeftWidget(commands_.debugStop().createToolbarButton());
+      toolbar.addLeftWidget(commands_.debugContinue().createToolbarButton());
       toolbar.addLeftSeparator();
-      toolbar.addLeftWidget(commands_.debugStep().createToolbarButton());      
+      toolbar.addLeftWidget(commands_.debugStop().createToolbarButton());    
       return toolbar;
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileType.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.studio.client.application.events.EventBus;
+import org.rstudio.studio.client.common.filetypes.events.OpenSourceFileEvent.NavigationMethod;
 
 import java.util.ArrayList;
 
@@ -37,10 +38,10 @@ public String getTypeId()
 
    public void openFile(FileSystemItem file, 
                         FilePosition position,
-                        boolean highlightLine,
+                        NavigationMethod navMethod,
                         EventBus eventBus)
    {
-      openFile(file, null, false, eventBus);
+      openFile(file, null, NavigationMethod.Default, eventBus);
    }
    
    protected abstract void openFile(FileSystemItem file, EventBus eventBus);

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -88,6 +88,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ContextDepthChanged = "context_depth_changed";
    public static final String EnvironmentAssigned = "environment_assigned";
    public static final String EnvironmentRemoved = "environment_removed";
+   public static final String BrowserLineChanged = "browser_line_changed";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/model/EnvironmentServerOperations.java
Patch:
@@ -40,4 +40,6 @@ void getOutputPreview(
            String quote,
            ServerRequestCallback<DataPreviewResult> requestCallback);
 
+   void setContextDepth(int newContextDepth,
+                        ServerRequestCallback<Void> requestCallback);
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentStyle.java
Patch:
@@ -19,9 +19,11 @@
 
 interface EnvironmentStyle extends CssResource
 {
+   int headerRowHeight();
    String expandCol();
    String nameCol();
    String valueCol();
+   String clickableCol();
    String detailRow();
    String categoryHeaderRow();
    String categoryHeaderText();
@@ -33,5 +35,6 @@ interface EnvironmentStyle extends CssResource
    String objectGrid();
    String widthSettingRow();
    String dataFrameValueCol();
+   String environmentPanel();
 }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -77,6 +77,9 @@ void navigateToPosition(SourcePosition position,
    Position search(String regex);
    Position search(Position startPos, String regex);
    
+   void highlightDebugLocation(SourcePosition pos);   
+   void endDebugHighlighting();
+   
    /**
     * @return True if dismissal is allowed, false to cancel.
     */

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/NavigableSourceEditor.java
Patch:
@@ -32,7 +32,7 @@ void navigateToPosition(SourcePosition position,
    void navigateToPosition(SourcePosition position, 
                            boolean recordCurrentPosition,
                            boolean highlightLine);
-   
+
    void restorePosition(SourcePosition position);
    
    boolean isAtSourceRow(SourcePosition position);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPane.java
Patch:
@@ -26,7 +26,8 @@
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.icons.StandardIcons;
-import org.rstudio.studio.client.server.*;
+import org.rstudio.studio.client.server.ServerError;
+import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
 import org.rstudio.studio.client.workbench.views.console.events.SendToConsoleEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -47,8 +47,6 @@ public void setCallFrames(JsArray<CallFrame> frameList, int contextDepth)
       {
          CallFrame frame = frameList.get(idx);
          CallFrameItem item = new CallFrameItem(frame, observer_);
-         // when the context depth changes, the first item is selected
-         // automatically
          if (contextDepth == frame.getContextDepth())
          {
             item.setActive();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -69,7 +69,6 @@ public interface Observer
 
    public EnvironmentObjects(Observer observer)
    {
-      splitPosition_ = 150;
       observer_ = observer;
       contextDepth_ = 0;
 
@@ -116,7 +115,7 @@ public void onScroll(ScrollEvent event)
       objectList_.setEmptyTableWidget(buildEmptyGridMessage());
       objectList_.setStyleName(style.objectGrid() + " " + style.environmentPanel());
 
-      splitPanel.addSouth(callFramePanel_, splitPosition_);
+      splitPanel.addSouth(callFramePanel_, 150);
       splitPanel.setWidgetMinSize(callFramePanel_, style.headerRowHeight());
       splitPanel.add(objectList_);
    }
@@ -714,7 +713,6 @@ private void buildExpandedContentRow(RObjectEntry rowValue)
 
    private Observer observer_;
    private int contextDepth_;
-   private int splitPosition_;
 
    // deferred settings--set on load but not applied until we have data.
    private int deferredScrollPosition_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -484,7 +484,8 @@ else if (useCurrentBrowseSource_ &&
                   SearchPathFunctionDefinition.create(
                         environmentName_, 
                         "source unavailable or out of sync", 
-                        currentBrowseSource_),
+                        currentBrowseSource_,
+                        true),
                   lineNumber - currentFunctionLineNumber_));
          }
          else

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -277,6 +277,8 @@ public void onResponseReceived(SourceDocument response)
       });
       
       events.addHandler(CodeBrowserNavigationEvent.TYPE, this);
+      
+      events.addHandler(CodeBrowserFinishedEvent.TYPE, this);
 
       events.addHandler(FileTypeChangedEvent.TYPE, new FileTypeChangedHandler()
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -222,7 +222,7 @@ public void setCallFrames(JsArray<CallFrame> frameList)
       {
          desiredCallFramePanelSize = Math.min(
                  desiredCallFramePanelSize,
-                 splitPanel.getOffsetHeight() / 2);
+                 (int)(0.66 * splitPanel.getOffsetHeight()));
       }
       splitPanel.setWidgetSize(callFramePanel_, desiredCallFramePanelSize);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFramePanel.java
Patch:
@@ -19,8 +19,8 @@
 import com.google.gwt.core.client.JsArray;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
+import com.google.gwt.user.client.ui.HTMLPanel;
 import com.google.gwt.user.client.ui.ResizeComposite;
-import com.google.gwt.user.client.ui.VerticalPanel;
 import com.google.gwt.user.client.ui.Widget;
 import org.rstudio.studio.client.workbench.views.environment.model.CallFrame;
 import org.rstudio.studio.client.workbench.views.environment.view.EnvironmentObjects.Observer;
@@ -90,7 +90,7 @@ public int getHeightOfAllFrames()
    }
 
    @UiField
-   VerticalPanel callFramePanel;
+   HTMLPanel callFramePanel;
 
    Observer observer_;
    ArrayList<CallFrameItem> callFrameItems_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -39,6 +39,7 @@
 import com.google.gwt.user.client.ui.*;
 import com.google.gwt.view.client.ListDataProvider;
 import com.google.gwt.view.client.NoSelectionModel;
+import org.rstudio.core.client.cellview.AutoHidingSplitLayoutPanel;
 import org.rstudio.core.client.cellview.ScrollingDataGrid;
 import org.rstudio.core.client.theme.res.ThemeStyles;
 import org.rstudio.studio.client.workbench.views.environment.model.CallFrame;
@@ -699,7 +700,7 @@ private void buildExpandedContentRow(RObjectEntry rowValue)
            "Function environment is empty";
 
    @UiField EnvironmentStyle style;
-   @UiField SplitLayoutPanel splitPanel;
+   @UiField AutoHidingSplitLayoutPanel splitPanel;
 
    ScrollingDataGrid<RObjectEntry> objectList_;
    CallFramePanel callFramePanel_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/CallFrameItem.java
Patch:
@@ -81,7 +81,7 @@ public int getHeight()
       return style.callFrameHeight() + (style.callFrameMargin() * 2);
    }
 
-   public static boolean isNavigatableFilename(String fileName)
+   public static boolean isNavigableFilename(String fileName)
    {
       if (fileName.length() > 0 &&
           !fileName.equalsIgnoreCase("NULL") &&
@@ -130,7 +130,7 @@ private String friendlyFileName(String unfriendlyFileName)
 
    private boolean hasFileLocation()
    {
-      return isNavigatableFilename(frame_.getFileName().trim());
+      return isNavigableFilename(frame_.getFileName().trim());
    }
 
    @UiField Label functionName;

File: src/gwt/src/org/rstudio/core/client/cellview/AutoHidingSplitLayoutPanel.java
Patch:
@@ -1,7 +1,6 @@
 package org.rstudio.core.client.cellview;
 
 import com.google.gwt.dom.client.Style;
-import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.user.client.ui.SplitLayoutPanel;
 import com.google.gwt.user.client.ui.Widget;
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileType.java
Patch:
@@ -17,6 +17,7 @@
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.files.FileSystemItem;
 import org.rstudio.studio.client.application.events.EventBus;
+import org.rstudio.studio.client.common.filetypes.events.OpenSourceFileEvent.NavigationMethod;
 
 import java.util.ArrayList;
 
@@ -37,10 +38,10 @@ public String getTypeId()
 
    public void openFile(FileSystemItem file, 
                         FilePosition position,
-                        boolean highlightLine,
+                        NavigationMethod navMethod,
                         EventBus eventBus)
    {
-      openFile(file, null, false, eventBus);
+      openFile(file, null, NavigationMethod.Default, eventBus);
    }
    
    protected abstract void openFile(FileSystemItem file, EventBus eventBus);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -79,7 +79,8 @@ public void openFile(FileSystemItem file,
       eventBus.fireEvent(new OpenSourceFileEvent(file,
                                                  position, 
                                                  this, 
-                                                 highlightLine));
+                                                 highlightLine,
+                                                 true));
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -414,11 +414,12 @@ private void openOrUpdateFileBrowsePoint(String file, int lineNumber)
       if (file.length() > 0 && lineNumber > 0)
       {
          FileSystemItem sourceFile = FileSystemItem.createFile(file);
-         FilePosition filePosition = FilePosition.create(lineNumber, 1);
+         FilePosition filePosition = FilePosition.create(lineNumber, 0);
          eventBus_.fireEvent(new OpenSourceFileEvent(sourceFile,
                                                      filePosition,
                                                      FileTypeRegistry.R,
-                                                     true));
+                                                     true,
+                                                     false));
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -88,6 +88,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ContextDepthChanged = "context_depth_changed";
    public static final String EnvironmentAssigned = "environment_assigned";
    public static final String EnvironmentRemoved = "environment_removed";
+   public static final String BrowserLineChanged = "browser_line_changed";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/model/CallFrame.java
Patch:
@@ -47,7 +47,7 @@ public final native String getFileName() /*-{
        return this.file_name;
    }-*/;
 
-   public final native String getLineNumber() /*-{
+   public final native int getLineNumber() /*-{
        return this.line_number;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/EnvironmentObjects.java
Patch:
@@ -17,7 +17,6 @@
 
 import com.google.gwt.cell.client.ClickableTextCell;
 import com.google.gwt.cell.client.FieldUpdater;
-import com.google.gwt.cell.client.TextCell;
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.core.client.JsArray;
 import com.google.gwt.core.client.JsArrayString;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/ScrollingDataGrid.java
Patch:
@@ -5,6 +5,9 @@
 import com.google.gwt.user.client.ui.ScrollPanel;
 import com.google.gwt.view.client.ProvidesKey;
 
+// this class extends GWT's DataGrid with a single method that gives us access
+// to the scrolling panel used by the grid, which we need in order to
+// manipulate the scroll position directly (e.g. to save and restore it)
 public class ScrollingDataGrid<T> extends DataGrid<T>
 {
    public ScrollingDataGrid(int pageSize, ProvidesKey<T> keyProvider)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java
Patch:
@@ -62,6 +62,7 @@ public interface Display extends WorkbenchView
       void clearObjects();
       void setContextDepth(int contextDepth);
       void removeObject(String object);
+      void setEnvironmentName(String name);
    }
    
    @Inject
@@ -99,6 +100,7 @@ public void onContextDepthChanged(ContextDepthChangedEvent event)
          {
             contextDepth_ = event.getContextDepth();
             view_.setContextDepth(contextDepth_);
+            view_.setEnvironmentName(event.getFunctionName());
             setViewFromEnvironmentList(event.getEnvironmentList());
          }
       });

File: src/gwt/src/org/rstudio/studio/client/workbench/views/environment/view/RObjectEntry.java
Patch:
@@ -32,7 +32,7 @@ public Object getKey(RObjectEntry item) {
    {
       rObject = obj;
       expanded = false;
-      canExpand = true;
+      canExpand = rObject.getType() == "character";
    }
 
    RObject rObject;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/workspace/table/WorkspaceObjectTable.java
Patch:
@@ -363,7 +363,7 @@ public void setObserver(Observer observer)
 
    private boolean isData(String type)
    {
-      return "data.frame".equals(type) || "matrix".equals(type);
+      return "data.frame".equals(type) || "matrix".equals(type) || "data.table".equals(type) || "cast_df".equals(type);
    }
 
    private RowManager rowManager_ ;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/workspace/table/WorkspaceObjectTable.java
Patch:
@@ -363,7 +363,7 @@ public void setObserver(Observer observer)
 
    private boolean isData(String type)
    {
-      return "data.frame".equals(type) || "matrix".equals(type);
+      return "data.frame".equals(type) || "matrix".equals(type) || "data.table".equals(type) || "cast_df".equals(type);
    }
 
    private RowManager rowManager_ ;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/presentation/Presentation.java
Patch:
@@ -26,7 +26,6 @@
 import com.google.gwt.user.client.ui.MenuItem;
 import com.google.inject.Inject;
 
-import org.rstudio.core.client.BrowseCap;
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.TimeBufferedCommand;

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -330,6 +330,7 @@ public final native StatusAndPathInfo getSVNStatus() /*-{
       MIME_TYPES.put( "pdf",   "application/pdf" );
       MIME_TYPES.put( "svg",   "image/svg+xml" );
       MIME_TYPES.put( "swf",   "application/x-shockwave-flash" );
+      MIME_TYPES.put( "ttf",   "application/x-font-ttf" );
       
       // markdown types
       MIME_TYPES.put( "md",       "text/x-markdown" );

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -155,6 +155,7 @@ InputEditorSelection search(String needle,
    Scope getCurrentChunk();
    Scope getCurrentChunk(Position position);
    Scope getCurrentFunction();
+   boolean hasScopeTree();
    JsArray<Scope> getScopeTree();
    InsertChunkInfo getInsertChunkInfo();
 

File: src/gwt/src/org/rstudio/studio/client/application/ui/appended/ApplicationEndedPopupPanel.java
Patch:
@@ -44,7 +44,7 @@ public static void showQuit()
    
    public static void showSuicide(String reason)
    {
-      String description = "<p>R encoutered a fatal error";
+      String description = "<p>R encountered a fatal error.";
       if (reason.length() > 0)
          description += ": " + reason;
       description += "</p>The session was terminated.";

File: src/gwt/src/org/rstudio/studio/client/application/ui/appended/ApplicationEndedPopupPanel.java
Patch:
@@ -44,7 +44,7 @@ public static void showQuit()
    
    public static void showSuicide(String reason)
    {
-      String description = "<p>R encoutered a fatal error";
+      String description = "<p>R encountered a fatal error.";
       if (reason.length() > 0)
          description += ": " + reason;
       description += "</p>The session was terminated.";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -706,7 +706,9 @@ private void updateStatusBarPosition()
       Position pos = docDisplay_.getCursorPosition();
       statusBar_.getPosition().setValue((pos.getRow() + 1) + ":" +
                                         (pos.getColumn() + 1));
-      updateCurrentScope();
+      
+      if (fileType_.canShowScopeTree())
+         updateCurrentScope();
    }
   
    private void updateCurrentScope()

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -66,6 +66,7 @@
 import org.rstudio.studio.client.workbench.views.help.events.ShowHelpEvent;
 import org.rstudio.studio.client.workbench.views.history.events.HistoryEntriesAddedEvent;
 import org.rstudio.studio.client.workbench.views.history.model.HistoryEntry;
+import org.rstudio.studio.client.workbench.views.output.find.events.FindOperationEndedEvent;
 import org.rstudio.studio.client.workbench.views.output.find.events.FindResultEvent;
 import org.rstudio.studio.client.workbench.views.output.sourcecpp.events.SourceCppCompletedEvent;
 import org.rstudio.studio.client.workbench.views.output.sourcecpp.events.SourceCppStartedEvent;
@@ -369,7 +370,7 @@ else if (type.equals(ClientEvent.FindResult))
          else if (type.equals(ClientEvent.FindOperationEnded))
          {
             String data = event.getData();
-            eventBus_.fireEvent(new LoadedPackageUpdatesEvent(data));
+            eventBus_.fireEvent(new FindOperationEndedEvent(data));
          }
          else if (type.equals(ClientEvent.RPubsUploadStatus))
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -140,7 +140,8 @@ public PrefValue<String> theme()
    
    public String getThemeErrorClass()
    {    
-      if (AceThemes.TEXTMATE.equals(theme().getValue()))
+      if ((theme().getValue() == null) ||
+          AceThemes.TEXTMATE.equals(theme().getValue()))
          return " ace_constant";
       else  
          return " ace_constant ace_language";

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PackagesPreferencesPane.java
Patch:
@@ -98,7 +98,7 @@ public void execute(CRANMirror cranMirror)
       add(developmentLabel);
       
       add(checkboxPref("Save all files prior to building packages", uiPrefs.saveAllBeforeBuild()));
-      add(checkboxPref("Automatically navigate editor to package build errors", uiPrefs.navigateToBuildError()));
+      add(checkboxPref("Automatically navigate editor to build errors", uiPrefs.navigateToBuildError()));
       
       hideObjectFiles_ = new CheckBox("Hide object files in package src directory");
       lessSpaced(hideObjectFiles_);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1280,7 +1280,7 @@ public void moveCursorNearTop(int rowOffset)
    @Override
    public void moveCursorNearTop()
    {
-      moveCursorNearTop(12);
+      moveCursorNearTop(10);
    }
    
    public void scrollToBottom()

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileType.java
Patch:
@@ -34,10 +34,11 @@ public String getTypeId()
    }
 
    public void openFile(FileSystemItem file, 
-                        FilePosition position, 
+                        FilePosition position,
+                        boolean highlightLine,
                         EventBus eventBus)
    {
-      openFile(file, null, eventBus);
+      openFile(file, null, false, eventBus);
    }
    
    protected abstract void openFile(FileSystemItem file, EventBus eventBus);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPresenter.java
Patch:
@@ -143,7 +143,8 @@ public void onBuildErrors(BuildErrorsEvent event)
                {
                   fileTypeRegistry_.editFile(
                     FileSystemItem.createFile(error.getPath()),
-                    FilePosition.create(error.getLine(), error.getColumn()));
+                    FilePosition.create(error.getLine(), error.getColumn()),
+                    true);
                }
             }
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/sourcecpp/SourceCppOutputPresenter.java
Patch:
@@ -103,7 +103,8 @@ private void updateView(SourceCppState state, boolean activate)
       {
          fileTypeRegistry_.editFile(
            FileSystemItem.createFile(error.getPath()),
-           FilePosition.create(error.getLine(), error.getColumn()));
+           FilePosition.create(error.getLine(), error.getColumn()),
+           true);
       }
       
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1079,7 +1079,8 @@ public void execute()
                            target.navigateToPosition(
                                  SourcePosition.create(position.getLine() - 1,
                                                        position.getColumn() - 1),
-                                 false);
+                                 false,
+                                 event.getHighlightLine());
                         }
                      });
                   }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -129,6 +129,7 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
    Position getCursorPosition();
    void setCursorPosition(Position position);
    void moveCursorNearTop();
+   void moveCursorNearTop(int rowOffset);
 
    
    InputEditorSelection search(String needle,

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -80,6 +80,9 @@ class ClientEvent extends JavaScriptObject
    public static final String DirectoryNavigate = "directory_navigate";
    public static final String DeferredInitCompleted = "deferred_init_completed";
    public static final String PlotsZoomSizeChanged = "plots_zoom_size_changed";
+   public static final String SourceCppStarted = "source_cpp_started";
+   public static final String SourceCppCompleted = "source_cpp_completed";
+   
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/model/BuildState.java
Patch:
@@ -14,6 +14,7 @@
 package org.rstudio.studio.client.workbench.views.buildtools.model;
 
 import org.rstudio.studio.client.common.compile.CompileError;
+import org.rstudio.studio.client.common.compile.CompileOutput;
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
@@ -36,7 +37,7 @@ public final native JsArray<CompileError> getErrors() /*-{
       return this.errors;
    }-*/;
    
-   public final native JsArray<BuildOutput> getOutputs() /*-{
+   public final native JsArray<CompileOutput> getOutputs() /*-{
       return this.outputs;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1087,7 +1087,7 @@ public void execute()
                               "This file was created as an R script however " +
                               "the file extension you specified will change " +
                               "it into another file type that will no longer " +
-                              "open as as an R script.\n\n" +
+                              "open as an R script.\n\n" +
                               "Are you sure you want to change the type of " +
                               "the file so that it is no longer an R script?",
                               new Operation() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1087,7 +1087,7 @@ public void execute()
                               "This file was created as an R script however " +
                               "the file extension you specified will change " +
                               "it into another file type that will no longer " +
-                              "open as as an R script.\n\n" +
+                              "open as an R script.\n\n" +
                               "Are you sure you want to change the type of " +
                               "the file so that it is no longer an R script?",
                               new Operation() {

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -51,6 +51,7 @@
 import org.rstudio.studio.client.workbench.views.buildtools.events.BuildErrorsEvent;
 import org.rstudio.studio.client.workbench.views.buildtools.events.BuildOutputEvent;
 import org.rstudio.studio.client.workbench.views.buildtools.events.BuildStartedEvent;
+import org.rstudio.studio.client.workbench.views.buildtools.model.BuildOutput;
 import org.rstudio.studio.client.workbench.views.choosefile.events.ChooseFileEvent;
 import org.rstudio.studio.client.workbench.views.console.events.*;
 import org.rstudio.studio.client.workbench.views.console.model.ConsolePrompt;
@@ -377,8 +378,8 @@ else if (type.equals(ClientEvent.BuildStarted))
          }
          else if (type.equals(ClientEvent.BuildOutput))
          {
-            String output = event.getData();
-            eventBus_.fireEvent(new BuildOutputEvent(output));
+            BuildOutput data = event.getData();
+            eventBus_.fireEvent(new BuildOutputEvent(data));
          }
          else if (type.equals(ClientEvent.BuildCompleted))
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -29,6 +29,7 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
+import org.rstudio.studio.client.workbench.views.buildtools.model.BuildOutput;
 
 public class BuildPane extends WorkbenchPane implements BuildPresenter.Display
 {
@@ -111,9 +112,9 @@ public void buildStarted()
    }
 
    @Override
-   public void showOutput(String output)
+   public void showOutput(BuildOutput output)
    {
-      compilePanel_.showOutput(output);   
+      compilePanel_.showOutput(output.getOutput());   
    }
    
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/model/BuildState.java
Patch:
@@ -36,7 +36,7 @@ public final native JsArray<CompileError> getErrors() /*-{
       return this.errors;
    }-*/;
    
-   public final native String getOutput() /*-{
-      return this.output;
+   public final native JsArray<BuildOutput> getOutputs() /*-{
+      return this.outputs;
    }-*/;
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/ExportPlotDialog.java
Patch:
@@ -37,7 +37,7 @@ protected Widget createMainWidget()
    
       // enforce maximum initial dimensions based on screen size
       Size maxSize = new Size(Window.getClientWidth() - 100,
-                              Window.getClientHeight() - 250);
+                              Window.getClientHeight() - 200);
       
       int width = Math.min(options_.getWidth(), maxSize.width);
       int height = Math.min(options_.getHeight(), maxSize.height);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/ExportPlotSizeEditor.java
Patch:
@@ -404,7 +404,7 @@ private int constrainHeight(int height)
    private void setPreviewPanelSize(int width, int height)
    {
       Size maxSize = new Size(Window.getClientWidth() - 100,
-                              Window.getClientHeight() - 250);
+                              Window.getClientHeight() - 200);
       
       if (width <= maxSize.width && height <= maxSize.height)
       {

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -307,7 +307,7 @@ public final native StatusAndPathInfo getSVNStatus() /*-{
       MIME_TYPES.put( "jpeg",  "image/jpeg" );
       MIME_TYPES.put( "jpe",   "image/jpeg" );
       MIME_TYPES.put( "png",   "image/png" );
-      MIME_TYPES.put( "js",    "application/x-javascript" );
+      MIME_TYPES.put( "js",    "text/javascript" );
       MIME_TYPES.put( "pdf",   "application/pdf" );
       MIME_TYPES.put( "svg",   "image/svg+xml" );
       MIME_TYPES.put( "swf",   "application/x-shockwave-flash" );

File: src/gwt/src/org/rstudio/studio/client/workbench/views/workspace/Workspace.java
Patch:
@@ -124,7 +124,7 @@ public void editObject(String objectName)
 
    public void viewObject(String objectName)
    {
-      executeFunctionForObject("View", objectName);
+      executeFunctionForObject("viewData", objectName);
    }
  
    private void executeFunctionForObject(String function, String objectName)

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellWidget.java
Patch:
@@ -214,7 +214,7 @@ public void setSuppressPendingInput(boolean suppressPendingInput)
    public void consoleWriteError(final String error)
    {
       clearPendingInput();
-      output(error, styles_.error(), false);
+      output(error, styles_.error() + ERROR_CLASS_NAME, false);
    }
 
    public void consoleWriteOutput(final String output)
@@ -687,4 +687,5 @@ public void onResize()
    private boolean suppressPendingInput_;
 
    private static final String KEYWORD_CLASS_NAME = " ace_keyword";
+   private static final String ERROR_CLASS_NAME = " ace_constant";
 }

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -340,6 +340,8 @@ public final native StatusAndPathInfo getSVNStatus() /*-{
       MIME_TYPES.put( "Rout",  "text/plain");
       MIME_TYPES.put( "po",    "text/plain");
       MIME_TYPES.put( "pot",   "text/plain");
+      MIME_TYPES.put( "gitignore",   "text/plain");
+      MIME_TYPES.put( "Rbuildignore","text/plain");
      
       MIME_TYPES.put( "tif",   "image/tiff" );
       MIME_TYPES.put( "tiff",  "image/tiff" );

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -138,6 +138,7 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.log", TEXT, icons.iconText());
       register("README", TEXT, icons.iconText());
       register(".gitignore", TEXT, icons.iconText());
+      register(".Rbuildignore", TEXT, icons.iconText());
       register("*.r", R, icons.iconRdoc());
       register(".rprofile", R, icons.iconRprofile());
       register("Rprofile.site", R, icons.iconRprofile());

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsPackagePanel.java
Patch:
@@ -134,6 +134,7 @@ public void initialize(WorkbenchContext workbenchContext)
    @Override
    protected void provideDefaults()
    {
+      installAdditionalArguments_.setText("--no-multiarch");
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetFindReplace.java
Patch:
@@ -83,8 +83,9 @@ public void onClick(ClickEvent event)
          findReplaceButton_.setLeftImage(FindReplaceBar.getFindLatchedIcon());
       }
       
-      findReplaceBar_.setDefaultForward(defaultForward);
-      findReplaceBar_.focusFindField(true);
+      String selection = container_.getEditor().getSelectionValue();
+      String searchText = selection.indexOf('\n') == -1 ? selection : "";
+      findReplaceBar_.activate(searchText, defaultForward);
    }
    
    public boolean isShowing()

File: src/gwt/src/org/rstudio/core/client/widget/FindTextBox.java
Patch:
@@ -18,7 +18,6 @@
 import com.google.gwt.dom.client.Style.Position;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.dom.client.KeyDownHandler;
-import com.google.gwt.event.dom.client.KeyUpHandler;
 import com.google.gwt.event.logical.shared.ValueChangeHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.uibinder.client.UiBinder;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -470,7 +470,7 @@ public void onNewTextDoc()
    @Handler
    public void onNewCppDoc()
    {
-      newDoc(FileTypeRegistry.C, null);
+      newDoc(FileTypeRegistry.CPP, null);
    }
    
    @Handler

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsPackagePanel.java
Patch:
@@ -132,7 +132,6 @@ public void initialize(WorkbenchContext workbenchContext)
    @Override
    protected void provideDefaults()
    {
-      installAdditionalArguments_.setText("--no-multiarch");
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/Packages.java
Patch:
@@ -645,7 +645,7 @@ private void withPackageInstallContext(
    {
       final ProgressIndicator indicator = 
          globalDisplay_.getProgressIndicator("Error");
-      indicator.onProgress("Retreiving package installation context...");
+      indicator.onProgress("Retrieving package installation context...");
 
       server_.getPackageInstallContext(
          new SimpleRequestCallback<PackageInstallContext>() {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/Packages.java
Patch:
@@ -645,7 +645,7 @@ private void withPackageInstallContext(
    {
       final ProgressIndicator indicator = 
          globalDisplay_.getProgressIndicator("Error");
-      indicator.onProgress("Retreiving package installation context...");
+      indicator.onProgress("Retrieving package installation context...");
 
       server_.getPackageInstallContext(
          new SimpleRequestCallback<PackageInstallContext>() {

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -51,6 +51,8 @@ public EditingPreferencesPane(SourceServerOperations server,
       add(checkboxPref("Soft-wrap R source files", prefs_.softWrapRFiles()));
       add(checkboxPref("Show syntax highlighting in console input", prefs_.syntaxColorConsole()));
       add(checkboxPref("Save all files before build", prefs_.saveAllBeforeBuild()));
+      add(checkboxPref("Automatically navigate to build errors", prefs_.navigateToBuildError()));
+
 
       encodingValue_ = prefs_.defaultEncoding().getGlobalValue();
       add(encoding_ = new TextBoxWithButton(

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompilePanel.java
Patch:
@@ -119,7 +119,7 @@ public void showErrors(String basePath,
                             errors,
                             autoSelect);
 
-      if (CompileError.includesErrorType(errors))
+      if (CompileError.showErrorList(errors))
       {
          panel_.setWidget(errorList_);
          showOutputButton_.setVisible(true);

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/dialog/CompilePdfProgressDialog.java
Patch:
@@ -125,7 +125,7 @@ public void onCompilePdfCompleted(CompilePdfCompletedEvent event)
       {   
          // show error list if there are errors
          String label = "Compile PDF failed";
-         if (CompileError.includesErrorType(errors_))
+         if (CompileError.showErrorList(errors_))
          {
             label +=  " (double-click to view source location of error)";
             errorList_.showErrors(result.getTargetFile(), 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -124,7 +124,7 @@ public void showErrors(String basePath,
    {
       compilePanel_.showErrors(basePath, errors, autoSelect);
       
-      if (ensureVisible && CompileError.includesErrorType(errors))
+      if (ensureVisible && CompileError.showErrorList(errors))
          ensureVisible();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/CompilePdfOutputPane.java
Patch:
@@ -106,7 +106,7 @@ public void showErrors(JsArray<CompileError> errors)
    {
       compilePanel_.showErrors(null, errors, CompileErrorList.AUTO_SELECT_FIRST);
       
-      if (CompileError.includesErrorType(errors))
+      if (CompileError.showErrorList(errors))
          ensureVisible(true);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -119,9 +119,10 @@ public void showOutput(String output)
    @Override
    public void showErrors(String basePath,
                           JsArray<CompileError> errors, 
-                          boolean ensureVisible)
+                          boolean ensureVisible,
+                          int autoSelect)
    {
-      compilePanel_.showErrors(basePath, errors);
+      compilePanel_.showErrors(basePath, errors, autoSelect);
       
       if (ensureVisible && CompileError.includesErrorType(errors))
          ensureVisible();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/CompilePdfOutputPane.java
Patch:
@@ -25,6 +25,7 @@
 import org.rstudio.core.client.widget.*;
 import org.rstudio.studio.client.common.compile.CompileError;
 import org.rstudio.studio.client.common.compile.CompilePanel;
+import org.rstudio.studio.client.common.compile.errorlist.CompileErrorList;
 import org.rstudio.studio.client.common.icons.StandardIcons;
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
 
@@ -103,7 +104,7 @@ public void showOutput(String output)
    @Override
    public void showErrors(JsArray<CompileError> errors)
    {
-      compilePanel_.showErrors(null, errors);
+      compilePanel_.showErrors(null, errors, CompileErrorList.AUTO_SELECT_FIRST);
       
       if (CompileError.includesErrorType(errors))
          ensureVisible(true);

File: src/gwt/src/org/rstudio/studio/client/common/compile/CompilePanel.java
Patch:
@@ -110,9 +110,9 @@ public void showOutput(String output)
       outputBuffer_.append(output);
    }
    
-   public void showErrors(JsArray<CompileError> errors)
+   public void showErrors(String basePath, JsArray<CompileError> errors)
    {
-      errorList_.showErrors(targetFileName_, errors);
+      errorList_.showErrors(targetFileName_, basePath, errors);
 
       if (CompileError.includesErrorType(errors))
       {

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/dialog/CompilePdfProgressDialog.java
Patch:
@@ -128,7 +128,7 @@ public void onCompilePdfCompleted(CompilePdfCompletedEvent event)
          if (CompileError.includesErrorType(errors_))
          {
             label +=  " (double-click to view source location of error)";
-            errorList_.showErrors(result.getTargetFile(), errors_);
+            errorList_.showErrors(result.getTargetFile(), null, errors_);
             container_.setWidget(errorList_);
             errorList_.selectFirstItem();
             errorList_.focus();

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEventDispatcher.java
Patch:
@@ -386,8 +386,8 @@ else if (type.equals(ClientEvent.BuildCompleted))
          }
          else if (type.equals(ClientEvent.BuildErrors))
          {
-            JsArray<CompileError> errors = event.getData();
-            eventBus_.fireEvent(new BuildErrorsEvent(errors));
+            BuildErrorsEvent.Data data = event.getData();
+            eventBus_.fireEvent(new BuildErrorsEvent(data));
          }
          else if (type.equals(ClientEvent.ListChanged))
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/CompilePdfOutputPane.java
Patch:
@@ -103,7 +103,7 @@ public void showOutput(String output)
    @Override
    public void showErrors(JsArray<CompileError> errors)
    {
-      compilePanel_.showErrors(errors);
+      compilePanel_.showErrors(null, errors);
       
       if (CompileError.includesErrorType(errors))
          ensureVisible(true);

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -76,6 +76,7 @@ class ClientEvent extends JavaScriptObject
    public static final String BuildStarted = "build_started";
    public static final String BuildOutput = "build_output";
    public static final String BuildCompleted = "build_completed";
+   public static final String BuildErrors = "build_errors";
 
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/CompilePdfOutputPresenter.java
Patch:
@@ -61,7 +61,6 @@ public interface Display extends WorkbenchView, HasEnsureHiddenHandlers
       HasClickHandlers stopButton();
       HasClickHandlers showLogButton();
       HasSelectionCommitHandlers<CodeNavigationTarget> errorList();
-      boolean isErrorPanelShowing();
       boolean isEffectivelyVisible();
       void scrollToBottom();
    }

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsPackagePanel.java
Patch:
@@ -125,7 +125,6 @@ public void initialize(WorkbenchContext workbenchContext)
    protected void provideDefaults()
    {
       installAdditionalArguments_.setText("--no-multiarch");
-      buildBinaryAdditionalArguments_.setText("--preclean");
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/unsaved/UnsavedChangesDialog.java
Patch:
@@ -148,6 +148,8 @@ protected Widget createMainWidget()
       ScrollPanel scrollPanel = new ScrollPanel();
       scrollPanel.setStylePrimaryName(RESOURCES.styles().targetScrollPanel());
       scrollPanel.setWidget(targetsCellTable_);
+      if (dataProvider_.getList().size() > 4)
+         scrollPanel.setHeight("280px");
       
       // always save check box (may not be shown)
       chkAlwaysSave_ = new CheckBox(alwaysSaveOption_);

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefsAccessor.java
Patch:
@@ -89,7 +89,7 @@ public PrefValue<Boolean> syntaxColorConsole()
    
    public PrefValue<Boolean> saveAllBeforeBuild()
    {
-      return bool("save_all_before_build", true);
+      return bool("save_files_before_build", false);
    }
 
    public PrefValue<Double> fontSize()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourcePane.java
Patch:
@@ -249,7 +249,7 @@ public void showOverflowPopup()
    public void showUnsavedChangesDialog(
          String title,
          ArrayList<UnsavedChangesTarget> dirtyTargets,
-         OperationWithInput<ArrayList<UnsavedChangesTarget>> saveOperation,
+         OperationWithInput<UnsavedChangesDialog.Result> saveOperation,
          Command onCancelled)
    {
       new UnsavedChangesDialog(title, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -165,7 +165,8 @@ void detectFreeVars(String code,
 
    void iconvlist(ServerRequestCallback<IconvListResult> requestCallback);
    
-   void getSourceTemplate(String template,
+   void getSourceTemplate(String name,
+                          String template,
                           ServerRequestCallback<String> requestCallback);
 
    void createNotebook(

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPreferencesDialogResources.java
Patch:
@@ -34,6 +34,7 @@ static interface Styles extends CssResource
       String vcsNoOriginUrl();
       String buildToolsAdditionalArguments();
       String buildToolsRoxygenize();
+      String buildToolsCheckBox();
    }
   
    @Source("ProjectPreferencesDialog.css")

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/buildtools/BuildToolsPackagePanel.java
Patch:
@@ -69,13 +69,13 @@ public void onValueChange(ValueChangeEvent<String> event)
       add(checkAdditionalArguments_ = new AdditionalArguments(
             "R CMD check additional options:"));
       
-      add(chkCleanupAfterCheck_ = new CheckBox(
+      add(chkCleanupAfterCheck_ = checkBox(
             "Cleanup output after successful R CMD check"));
         
       roxygenizePanel_ = new VerticalPanel();
       roxygenizePanel_.addStyleName(RES.styles().buildToolsRoxygenize());
       HorizontalPanel rocletPanel = new HorizontalPanel();
-      chkUseRoxygen_ = new CheckBox("Generate documentation with Roxygen");
+      chkUseRoxygen_ = checkBox("Generate documentation with Roxygen");
       rocletPanel.add(chkUseRoxygen_);
       btnConfigureRoxygen_ = new ThemedButton("Configure...");
       btnConfigureRoxygen_.addClickHandler(new ClickHandler() {

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPreferencesDialog.java
Patch:
@@ -18,6 +18,7 @@
 import org.rstudio.studio.client.projects.model.ProjectsServerOperations;
 import org.rstudio.studio.client.projects.model.RProjectConfig;
 import org.rstudio.studio.client.projects.model.RProjectOptions;
+import org.rstudio.studio.client.projects.ui.prefs.buildtools.ProjectBuildToolsPreferencesPane;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
 import org.rstudio.studio.client.server.Void;

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPreferencesDialogResources.java
Patch:
@@ -22,6 +22,7 @@ public interface ProjectPreferencesDialogResources extends ClientBundle
    static interface Styles extends CssResource
    {
       String panelContainer();
+      String buildToolsPanel();
       String workspaceGrid();
       String enableCodeIndexing();
       String useSpacesForTab();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/buildtools/BuildPane.java
Patch:
@@ -55,6 +55,7 @@ protected Toolbar createMainToolbar()
          ToolbarPopupMenu buildMenu = new ToolbarPopupMenu();
          buildMenu.addItem(commands_.buildAll().createMenuItem(false));
          buildMenu.addItem(commands_.rebuildAll().createMenuItem(false));
+         buildMenu.addSeparator();
          buildMenu.addItem(commands_.cleanAll().createMenuItem(false));
          ToolbarButton buildMenuButton = new ToolbarButton(buildMenu, true);
          toolbar.addLeftWidget(buildMenuButton);

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectBuildToolsPreferencesPane.java
Patch:
@@ -72,8 +72,8 @@ private class BuildTypeSelectWidget extends SelectWidget
       public BuildTypeSelectWidget()
       {
          super("Project build tools:",
-               new String[]{"(None)", "Package", "Makefile", "Custom"},
-               new String[]{"None", "Package", "Makefile", "Custom"},
+               new String[]{"(None)", "Package"},
+               new String[]{"None", "Package"},
                false,
                true,
                false);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -35,6 +35,9 @@ public interface FileIconResources extends ClientBundle
    ImageResource iconTex();
    ImageResource iconText();
    ImageResource iconMarkdown();
+   ImageResource iconH();
+   ImageResource iconC();
+   ImageResource iconHpp();
    ImageResource iconCpp();
    ImageResource iconHTML();
    ImageResource iconCss();

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -149,10 +149,10 @@ public FileTypeRegistry(EventBus eventBus,
       register("*.mdtxt", MARKDOWN, icons.iconMarkdown());
       register("*.markdown", MARKDOWN, icons.iconMarkdown());
       register("*.bib", TEXT, icons.iconText());
-      register("*.c", CPP, icons.iconCpp());
+      register("*.c", CPP, icons.iconC());
       register("*.cpp", CPP, icons.iconCpp());
-      register("*.h", CPP, icons.iconCpp());
-      register("*.hpp", CPP, icons.iconCpp());
+      register("*.h", CPP, icons.iconH());
+      register("*.hpp", CPP, icons.iconHpp());
       register("*.Rout.save", TEXT, icons.iconText());
       register("*.rd", RD, icons.iconRd());
       register("*.rdata", RDATA, icons.iconRdata());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -2003,8 +2003,10 @@ private void generateNotebook(final Command executeOnSuccess)
    {
       String defaultTitle = docUpdateSentinel_.getProperty(NOTEBOOK_TITLE);
       if (defaultTitle == null)
-         defaultTitle = StringUtil.pathToTitle(docUpdateSentinel_.getPath());
+         defaultTitle = FileSystemItem.getNameFromPath(docUpdateSentinel_.getPath());
       String defaultAuthor = docUpdateSentinel_.getProperty(NOTEBOOK_AUTHOR);
+      if (defaultAuthor == null)
+         defaultAuthor = session_.getSessionInfo().getUserIdentity();
       CompileNotebookOptionsDialog dialog = new CompileNotebookOptionsDialog(getId(), defaultTitle, defaultAuthor, new OperationWithInput<CompileNotebookOptions>()
       {
          @Override

File: src/gwt/src/org/rstudio/core/client/command/KeyboardShortcut.java
Patch:
@@ -107,7 +107,7 @@ else if (keycode_ == 188)
       else if (keycode_ >= 112 && keycode_ <= 123)
          return "F" + (keycode_ - 111);
       else if (keycode_ == 8)
-         return "Backspace";
+         return macStyle ? "&#9003;" : "Backspace";
 
 
       return Character.toUpperCase((char)keycode_) + "";

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreview.java
Patch:
@@ -36,7 +36,7 @@ public void onShowHTMLPreview(ShowHTMLPreviewEvent event)
             // open the window 
             satelliteManager.openSatellite(HTMLPreviewApplication.NAME,     
                                             event.getParams(),
-                                            new Size(950,1200));   
+                                            new Size(850,1100));   
             
          }  
       });

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/SweaveFileType.java
Patch:
@@ -22,7 +22,6 @@
 
 public class SweaveFileType extends TextFileType
 {
-   public static final String R_LANG_MODE = "R";
    public static final String TEX_LANG_MODE = "TeX";
 
    SweaveFileType(String id,

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -31,6 +31,8 @@
 
 public class TextFileType extends EditableFileType
 {
+   public static final String R_LANG_MODE = "R";
+
    TextFileType(String id,
                 String label,
                 EditorLanguage editorLanguage,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -840,7 +840,7 @@ public int getCurrentLineCount()
    @Override
    public String getLanguageMode(Position position)
    {
-      return getSession().getMode().getCodeModel().getLanguageMode(position);
+      return getSession().getMode().getLanguageMode(position);
    }
 
    public void replaceCode(String code)

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreview.java
Patch:
@@ -36,7 +36,7 @@ public void onShowHTMLPreview(ShowHTMLPreviewEvent event)
             // open the window 
             satelliteManager.openSatellite(HTMLPreviewApplication.NAME,     
                                             event.getParams(),
-                                            new Size(850,1000));   
+                                            new Size(950,1200));   
             
          }  
       });

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -40,6 +40,7 @@
 import org.rstudio.studio.client.workbench.model.RemoteFileSystemContext;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
+import org.rstudio.studio.client.workbench.prefs.model.UIPrefsAccessor;
 import org.rstudio.studio.client.workbench.views.console.shell.assist.RCompletionManager;
 import org.rstudio.studio.client.workbench.views.source.DocsMenu;
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditor;
@@ -66,6 +67,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(SpellChecker spellChecker);
    void injectMembers(SpellingCustomDictionariesWidget widget);
    void injectMembers(FileExport fileExport);
+   void injectMembers(UIPrefsAccessor uiPrefs);
 
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/pdfjs/PDFView.java
Patch:
@@ -85,9 +85,9 @@ public static native void toggleSidebar() /*-{
 
    public native static void initializeEvents() /*-{
 
-      var _load = $wnd.PDFView.load;
-      $wnd.PDFView.load = $entry(function(data, scale) {
-         _load.call($wnd.PDFView, data, scale);
+      var _setInitialView = $wnd.PDFView.setInitialView;
+      $wnd.PDFView.setInitialView = $entry(function(storedHash, scale) {
+         _setInitialView.call($wnd.PDFView, storedHash, scale);
          @org.rstudio.studio.client.pdfviewer.pdfjs.PDFView::firePDFLoadEvent()();
       });
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -225,7 +225,6 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       }
       results.add(commands.findReplace());
       results.add(commands.setWorkingDirToActiveDoc());
-      results.add(commands.debugForceTopsToZero());
       results.add(commands.debugDumpContents());
       results.add(commands.debugImportDump());
       return results;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -221,7 +221,6 @@
    public abstract AppCommand helpKeyboardShortcuts();
    public abstract AppCommand showRequestLog();
    public abstract AppCommand logFocusedElement();
-   public abstract AppCommand debugForceTopsToZero();
    public abstract AppCommand debugDumpContents();
    public abstract AppCommand debugImportDump();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -218,7 +218,6 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.jumpTo());
       dynamicCommands_.add(commands.goToFunctionDefinition());
       dynamicCommands_.add(commands.setWorkingDirToActiveDoc());
-      dynamicCommands_.add(commands.debugForceTopsToZero());
       dynamicCommands_.add(commands.debugDumpContents());
       dynamicCommands_.add(commands.debugImportDump());
       dynamicCommands_.add(commands.goToLine());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -154,7 +154,6 @@ InputEditorSelection search(String needle,
 
    String getLine(int row);
    
-   void debug_forceTopsToZero();
    String debug_getDocumentDump();
    void debug_setSessionValueDirectly(String s);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/Renderer.java
Patch:
@@ -105,9 +105,7 @@ public native final void forceImmediateRender() /*-{
       this.$renderChanges(this.CHANGE_FULL);
    }-*/;
 
-   public native final void debug_forceTopsToZero() /*-{
-      this.scroller.style.top = "0";
-      this.content.style.top = "0";
+   public native final void fixVerticalOffsetBug() /*-{
       this.scroller.scrollTop = 0;
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -61,7 +61,7 @@ public class FileTypeRegistry
                             true);
 
    public static final RWebContentFileType RMARKDOWN =
-         new RWebContentFileType("r_markdown", "R Markdown", EditorLanguage.LANG_MARKDOWN,
+         new RWebContentFileType("r_markdown", "R Markdown", EditorLanguage.LANG_RMARKDOWN,
                               ".Rmd", ICONS.iconRmarkdown(), true);
    
    public static final WebContentFileType MARKDOWN =

File: src/gwt/src/org/rstudio/studio/client/common/reditor/EditorLanguage.java
Patch:
@@ -38,7 +38,9 @@ public class EditorLanguage
    public static final EditorLanguage LANG_PLAIN = new EditorLanguage(
          "ace/mode/text", false);
    public static final EditorLanguage LANG_MARKDOWN = new EditorLanguage(
-         "mode/markdown", false);
+         "ace/mode/markdown", false);
+   public static final EditorLanguage LANG_RMARKDOWN = new EditorLanguage(
+         "mode/rmarkdown", false);
 
    /**
     *

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewApplicationWindow.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * PDFViewerApplicationWindow.java
+ * HTMLPreviewApplicationWindow.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetCompilePdfHelper.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * CompilePdfDependencyChecker.java
+ * TextEditingTargetCompilePdfHelper.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/HTMLPreviewPresenter.java
Patch:
@@ -38,7 +38,6 @@
 import org.rstudio.studio.client.workbench.model.helper.StringStateValue;
 import org.rstudio.studio.client.server.VoidServerRequestCallback;
 
-import com.gargoylesoftware.htmlunit.javascript.host.Window;
 import com.google.gwt.dom.client.NativeEvent;
 import com.google.gwt.event.dom.client.ClickEvent;
 import com.google.gwt.event.dom.client.ClickHandler;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeCommands.java
Patch:
@@ -107,6 +107,7 @@ public TextFileType[] statusBarFileTypes()
          types.add(FileTypeRegistry.RMARKDOWN);
       if (rHTMLCommand_.isEnabled())
          types.add(FileTypeRegistry.RHTML);
+      types.add(FileTypeRegistry.RD);
       types.add(FileTypeRegistry.TEXT);
       types.add(FileTypeRegistry.TEX);
       types.add(FileTypeRegistry.MARKDOWN);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -48,7 +48,7 @@ public class FileTypeRegistry
                        false, false, false, false, false, false, false, false, false);
 
    public static final TextFileType SWEAVE =
-      new SweaveFileType("sweave", "Sweave", 
+      new SweaveFileType("sweave", "R Sweave", 
           EditorLanguage.LANG_SWEAVE, ".Rnw",ICONS.iconRsweave());
         
    public static final TexFileType TEX =

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -36,6 +36,8 @@ public interface FileIconResources extends ClientBundle
    ImageResource iconText();
    ImageResource iconMarkdown();
    ImageResource iconHTML();
+   ImageResource iconCss();
+   ImageResource iconJavascript();
    ImageResource iconRsweave();
    ImageResource iconRd();
    ImageResource iconRhtml();

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeCommands.java
Patch:
@@ -111,6 +111,8 @@ public TextFileType[] statusBarFileTypes()
       types.add(FileTypeRegistry.TEX);
       types.add(FileTypeRegistry.MARKDOWN);
       types.add(FileTypeRegistry.HTML);
+      types.add(FileTypeRegistry.CSS);
+      types.add(FileTypeRegistry.JS);
       
       return (TextFileType[])types.toArray(new TextFileType[0]);
    }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -137,7 +137,8 @@ public boolean isRnw()
    
    public boolean requiresKnit()
    {
-      return FileTypeRegistry.RMARKDOWN.getTypeId().equals(getTypeId());
+      return FileTypeRegistry.RMARKDOWN.getTypeId().equals(getTypeId()) ||
+             FileTypeRegistry.RHTML.getTypeId().equals(getTypeId());
    }
    
    public boolean isMarkdown()

File: src/gwt/src/org/rstudio/studio/client/htmlpreview/ui/HTMLPreviewPanel.java
Patch:
@@ -170,6 +170,7 @@ private class PreviewFrame extends Frame
       public PreviewFrame()
       {
          setStylePrimaryName("rstudio-HelpFrame");
+         getElement().getStyle().setBackgroundColor("white");
          setScriptsEnabled(false);
       }
       

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -75,7 +75,7 @@ public class FileTypeRegistry
   
    public static final WebContentFileType HTML =
          new WebContentFileType("html", "HTML", EditorLanguage.LANG_PLAIN,
-                              ".htm", ICONS.iconHTML());
+                              ".html", ICONS.iconHTML());
    
    public static final RDataType RDATA = new RDataType();
    public static final RProjectType RPROJECT = new RProjectType();

File: src/gwt/src/org/rstudio/studio/client/common/OutputBuffer.java
Patch:
@@ -23,15 +23,13 @@ public class OutputBuffer extends Composite
 {
    public OutputBuffer()
    {
-      StudioStyles styles = StudioResources.INSTANCE.styles();
-
       output_ = new PreWidget();
       output_.setStylePrimaryName(
                         ConsoleResources.INSTANCE.consoleStyles().output());
       FontSizer.applyNormalFontSize(output_);
     
       scrollPanel_ = new ScrollPanel();
-      scrollPanel_.addStyleName(styles.outputBufferScrollPanel());
+      scrollPanel_.setSize("100%", "100%");
       scrollPanel_.add(output_);
       
       initWidget(scrollPanel_);

File: src/gwt/src/org/rstudio/studio/client/common/StudioStyles.java
Patch:
@@ -16,5 +16,4 @@
 
 public interface StudioStyles extends CssResource
 {
-   String outputBufferScrollPanel();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/Renderer.java
Patch:
@@ -108,6 +108,7 @@ public native final void forceImmediateRender() /*-{
    public native final void debug_forceTopsToZero() /*-{
       this.scroller.style.top = "0";
       this.content.style.top = "0";
+      this.scroller.scrollTop = 0;
    }-*/;
 
    public native final void setPasswordMode(boolean passwordMode) /*-{

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourcePosition.java
Patch:
@@ -58,7 +58,7 @@ public native final int getScrollPosition() /*-{
    public final boolean isSameRowAs(SourcePosition other) 
    {
       if (getContext() == null && other.getContext() == null)
-         return true;
+         return other.getRow() == getRow();
       else if (getContext() == null && other.getContext() != null)
          return false;
       else if (other.getContext() == null && getContext() != null)

File: src/gwt/src/org/rstudio/studio/client/common/spelling/view/SpellingSandboxDebugText.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * SpellingSandboxDialog.java
+ * SpellingSandboxDebugText.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetLatexFormatMenu.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * TextEditingTargetFindReplace.java
+ * TextEditingTargetLatexFormatMenu.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -176,6 +176,7 @@ function updateEditorHeight() {
       if (!editor.autoHeightAttached) {
          editor.autoHeightAttached = true;
          editor.getSession().getDocument().on("change", updateEditorHeight);
+         editor.renderer.$textLayer.on("changeCharacterSize", updateEditorHeight);
       }
       updateEditorHeight();
    }-*/;

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -39,7 +39,6 @@
    public abstract AppCommand sourceFile();
    public abstract AppCommand sourceActiveDocument();
    public abstract AppCommand sourceActiveDocumentWithEcho();
-   public abstract AppCommand complete();
    public abstract AppCommand executeCode();
    public abstract AppCommand executeToCurrentLine();
    public abstract AppCommand executeFromCurrentLine();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceCompletionAdapter.java
Patch:
@@ -29,7 +29,7 @@ public native final KeyboardHandler getKeyboardHandler() /*-{
       var noop = {command: "null"};
       return {
          handleKeyboard: $entry(function(data, hashId, keyOrText, keyCode, e) {
-            if (hashId != 0 || keyCode != 0) {
+            if (hashId || keyCode) {
                if (self.@org.rstudio.studio.client.workbench.views.source.editors.text.AceCompletionAdapter::onKeyDown(Lcom/google/gwt/dom/client/NativeEvent;)(e)) {
                   event.stopEvent(e);
                   return noop; // perform a no-op

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceCompletionAdapter.java
Patch:
@@ -24,7 +24,7 @@ public AceCompletionAdapter(CompletionManager completionManager)
    }
 
    public native final KeyboardHandler getKeyboardHandler() /*-{
-      var event = $wnd.require("pilot/event");
+      var event = $wnd.require("ace/lib/event");
       var self = this;
       var noop = {command: "null"};
       return {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceEditorNative.java
Patch:
@@ -102,7 +102,7 @@ private native static JavaScriptObject addDomListener(
          Element element,
          String eventName,
          HasHandlers hasHandlers) /*-{
-      var event = $wnd.require("pilot/event");
+      var event = $wnd.require("ace/lib/event");
       var listener = $entry(function(e) {
          @com.google.gwt.event.dom.client.DomEvent::fireNativeEvent(Lcom/google/gwt/dom/client/NativeEvent;Lcom/google/gwt/event/shared/HasHandlers;Lcom/google/gwt/dom/client/Element;)(e, hasHandlers, element);
       }); 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceResources.java
Patch:
@@ -20,7 +20,7 @@ public interface AceResources extends ClientBundle
 {
    public static final AceResources INSTANCE = GWT.create(AceResources.class);
 
-   @Source("ace.js")
+   @Source("ace-uncompressed.js")
    StaticDataResource acejs();
 
    @Source("acesupport.js")

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1434,7 +1434,7 @@ protected void onChunkWritten(String chunk,
          String content = line.substring(Math.min(line.length(),
                                                   prefix.length()));
 
-         if (content.matches("^\\s*\\@examples\\b"))
+         if (content.matches("^\\s*\\@examples\\b.*$"))
             wordWrap.setWrappingEnabled(false);
          else if (content.trim().startsWith("@"))
             wordWrap.setWrappingEnabled(true);

File: src/gwt/src/org/rstudio/studio/client/application/ui/GlobalToolbar.java
Patch:
@@ -49,10 +49,10 @@ public GlobalToolbar(Commands commands,
       // add new source doc commands
       ToolbarPopupMenu newMenu = new ToolbarPopupMenu();
       newMenu.addItem(commands.newSourceDoc().createMenuItem(false));
+      newMenu.addSeparator();
       newMenu.addItem(commands.newSweaveDoc().createMenuItem(false));
            
       // dynamically add other commands
-      newMenu.addSeparator();
       ArrayList<FileTypeCommands.CommandWithId> fileNewCommands = 
                                        fileTypeCommands.commandsWithIds();
       for (FileTypeCommands.CommandWithId cmd : fileNewCommands)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/Mode.java
Patch:
@@ -35,7 +35,7 @@ public native final FunctionStart getCurrentFunction(Position position) /*-{
    }-*/;
 
    public native final JsArray<FunctionStart> getFunctionTree() /*-{
-      return this.getFunctionTree();
+      return this.getFunctionTree ? this.getFunctionTree() : [];
    }-*/;
 
    public native final FunctionStart findFunctionDefinitionFromUsage(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/status/StatusBarWidget.java
Patch:
@@ -67,6 +67,7 @@ public StatusBarElement getLanguage()
 
    public void setFunctionVisible(boolean visible)
    {
+      function_.setClicksEnabled(visible);
       function_.setContentsVisible(visible);
       funcIcon_.setVisible(visible);
    }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -35,7 +35,7 @@ public class FileTypeRegistry
          new TextFileType("text", "Text File", EditorLanguage.LANG_PLAIN, "",
                           ICONS.iconText(),
                           true,
-                          false, false, false, false, false, false);
+                          false, false, false, false, false, false, true);
 
    public static final TextFileType R =
          new RFileType("r_source", "R Script", EditorLanguage.LANG_R, ".R",
@@ -45,7 +45,7 @@ public class FileTypeRegistry
       new TextFileType("r_doc", "R Documentation", EditorLanguage.LANG_RDOC, ".Rd",
                        ICONS.iconRd(),
                        true,
-                       false, false, false, false, false, false);
+                       false, false, false, false, false, false, false);
 
    public static final TextFileType SWEAVE =
       new SweaveFileType("sweave", "Sweave Document", 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/PlainTextFileType.java
Patch:
@@ -34,7 +34,8 @@ public class PlainTextFileType extends TextFileType
             false,
             false,
             false,
-            false);
+            false,
+            true);
       
    }
 }

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RFileType.java
Patch:
@@ -33,7 +33,7 @@ public class RFileType extends TextFileType
             editorLanguage,
             defaultExtension,
             defaultIcon,
-            false, true, true, true, true, false, true);
+            false, true, true, true, true, false, true, false);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/SweaveFileType.java
Patch:
@@ -41,6 +41,7 @@ public class SweaveFileType extends TextFileType
             true, 
             false, 
             true, 
+            false,
             false);
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TexFileType.java
Patch:
@@ -38,6 +38,7 @@ public class TexFileType extends TextFileType
             false, 
             false, 
             true, 
+            false,
             false);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -64,6 +64,7 @@
    public abstract AppCommand reindent();
    public abstract AppCommand reflowComment();
    public abstract AppCommand setWorkingDirToActiveDoc();
+   public abstract AppCommand checkSpelling();
    
    // Projects
    public abstract AppCommand newProject();
@@ -218,7 +219,6 @@
    public abstract AppCommand rstudioLicense();
 
    public abstract AppCommand showWarningBar();
-   public abstract AppCommand spellingSandbox();
  
    // Clipboard placeholders
    public abstract AppCommand undoDummy();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -211,6 +211,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.debugDumpContents());
       dynamicCommands_.add(commands.debugImportDump());
       dynamicCommands_.add(commands.goToLine());
+      dynamicCommands_.add(commands.checkSpelling());
       for (AppCommand command : dynamicCommands_)
       {
          command.setVisible(false);

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/pdfjs/PDFView.java
Patch:
@@ -142,7 +142,7 @@ public static native JavaScriptObject getNavigateDest() /*-{
       if ($wnd.PDFView.pages.length == 0)
          return null;
       return {
-         scale: $wnd.PDFView.currentScale,
+         scale: $wnd.PDFView.currentScaleValue,
          x: $wnd.scrollX,
          y: $wnd.scrollY
       };

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/commit/SVNCommitDialog.java
Patch:
@@ -139,6 +139,7 @@ public void execute()
    @Override
    protected void onUnload()
    {
+      super.onUnload();
       commitDraft_ = message_.getText();
       session_.persistClientState();
    }

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -2468,9 +2468,8 @@ public void beginFind(String searchString,
       params.set(0, new JSONString(searchString));
       params.set(1, JSONBoolean.getInstance(regex));
       params.set(2, JSONBoolean.getInstance(ignoreCase));
-      params.set(3, directory.getPath() == null ?
-                    JSONNull.getInstance() :
-                    new JSONString(directory.getPath()));
+      params.set(3, new JSONString(directory == null ? ""
+                                                     : directory.getPath()));
       params.set(4, new JSONArray(filePatterns));
       sendRequest(RPC_SCOPE, BEGIN_FIND, params, requestCallback);
    }

File: src/gwt/src/org/rstudio/studio/client/common/synctex/Synctex.java
Patch:
@@ -39,9 +39,6 @@
 
 // TODO: caching of synctex info
 
-// TODO: consider dedicated synctex module
-
-// TODO: synctex operations return empty or null
 // TODO: where to get the pdf path from in presenter (last successful?)
 // TODO: warn user that firefox satellite can't activate main
 // TODO: enable/disable/errors for synctex from wrong source or target or

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/PDFViewerPresenter.java
Patch:
@@ -122,7 +122,6 @@ public void onWindowClosing(ClosingEvent event)
          @Override
          public void onClick(ClickEvent event)
          { 
-            Debug.log("Inverse search page: " + PDFView.currentPage() );
             synctex_.inverseSearch(PdfLocation.create(lastSuccessfulPdfPath_,
                                                       PDFView.currentPage(),
                                                       120, 120, 0, 0));

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/pdfjs/PDFView.java
Patch:
@@ -16,7 +16,6 @@
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.dom.client.Document;
 import com.google.gwt.dom.client.Element;
-import com.google.gwt.dom.client.Style;
 import com.google.gwt.event.shared.HandlerManager;
 import com.google.gwt.event.shared.HandlerRegistration;
 import org.rstudio.studio.client.pdfviewer.pdfjs.events.PDFLoadEvent;

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/ui/PDFViewerPanel.java
Patch:
@@ -64,14 +64,14 @@ public void toggleThumbnails()
    public void updateSelectedPage(int pageNumber)
    {
       if (selectedPageLabel_ != null)
-         selectedPageLabel_.removeAttribute("selected");
+         selectedPageLabel_.removeClassName("selected");
 
       selectedPageLabel_ =
                    Document.get().getElementById("thumbnailLabel" + pageNumber);
 
       if (selectedPageLabel_ != null)
       {
-         selectedPageLabel_.setAttribute("selected", "selected");
+         selectedPageLabel_.addClassName("selected");
 
          Element scroller = Document.get().getElementById("sidebarScrollView");
          Element page =

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/ui/PDFViewerToolbar.java
Patch:
@@ -146,7 +146,6 @@ public HasValue<Integer> getPageNumber()
    InlineToolbarButton btnThumbnails_;
    @UiField
    SpanLabel pageCountLabel_;
-   ListBox scaleSelect_;
    @UiField
    SpanLabel filename_;
    @UiField

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/CompilePdfErrorList.java
Patch:
@@ -29,6 +29,7 @@
 import com.google.gwt.dom.client.TableElement;
 import com.google.gwt.event.dom.client.ClickEvent;
 import com.google.gwt.event.dom.client.ClickHandler;
+import com.google.gwt.event.dom.client.KeyCodes;
 import com.google.gwt.event.dom.client.KeyDownEvent;
 import com.google.gwt.event.dom.client.KeyDownHandler;
 import com.google.gwt.event.dom.client.MouseDownEvent;
@@ -72,7 +73,8 @@ public void onClick(ClickEvent event)
          @Override
          public void onKeyDown(KeyDownEvent event)
          {
-            fireSelectionCommittedEvent();
+            if (event.getNativeKeyCode() == KeyCodes.KEY_ENTER)
+               fireSelectionCommittedEvent();
          }
       });
       

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/dialog/CompilePdfProgressDialog.java
Patch:
@@ -128,6 +128,8 @@ public void onCompilePdfCompleted(CompilePdfCompletedEvent event)
             label +=  " (double-click to view source location of error)";
             errorList_.showErrors(event.getTargetFile(), errors_);
             container_.setWidget(errorList_);
+            errorList_.selectFirstItem();
+            errorList_.focus();
          }
          
          // update the label and stop button

File: src/gwt/src/org/rstudio/studio/client/common/compilepdf/model/CompilePdfError.java
Patch:
@@ -62,6 +62,9 @@ public final String asString()
    public final static boolean includesErrorType(
                                           JsArray<CompilePdfError> errors)
    { 
+      if (errors == null)
+         return false;
+      
       for (CompilePdfError error : JsUtil.asIterable(errors))
       {  
          if (error.getType() == CompilePdfError.ERROR)

File: src/gwt/src/org/rstudio/core/client/widget/ProgressDialog.java
Patch:
@@ -142,7 +142,7 @@ protected void setLabel(String text)
    
    protected void hideProgress()
    {
-      progressAnim_.getElement().getStyle().setVisibility(Visibility.HIDDEN);
+      progressAnim_.getElement().getStyle().setDisplay(Style.Display.NONE);
    }
 
    protected boolean handleEnterKey()

File: src/gwt/src/org/rstudio/studio/client/pdfviewer/pdfjs/PdfJs.java
Patch:
@@ -39,7 +39,7 @@ public static void load(final Command command)
             new String[] {
                   res.compatibilityJs().getSafeUri().asString(),
                   res.pdfjs().getSafeUri().asString(),
-                  res.debuggerJs().getSafeUri().asString(),
+                  //res.debuggerJs().getSafeUri().asString(),
                   res.viewerJs().getSafeUri().asString(),
             },
             new Callback()

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -338,7 +338,7 @@ public void clearProgress()
       };
    }
    
-   public void closeDialog()
+   protected void closeDialog()
    {
       hide();
       removeFromParent();

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteApplication.java
Patch:
@@ -90,7 +90,7 @@ public void execute(JavaScriptObject params)
 
    protected void flushPendingEvents()
    {
-      satellite_.flushPendingEvents(PDFViewerApplication.NAME);
+      satellite_.flushPendingEvents(name_);
    }
 
 

File: src/gwt/src/org/rstudio/studio/client/common/satellite/SatelliteManager.java
Patch:
@@ -239,6 +239,9 @@ private void flushPendingEvents(String name)
       ArrayList<JavaScriptObject> events =
                                     pendingEventsBySatelliteName_.remove(name);
 
+      if (events == null || events.size() == 0)
+         return;
+
       for (ActiveSatellite satellite :
                                     new ArrayList<ActiveSatellite>(satellites_))
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/ConsoleTabPanel.java
Patch:
@@ -14,7 +14,6 @@
 
 import org.rstudio.core.client.events.*;
 import org.rstudio.core.client.theme.PrimaryWindowFrame;
-import org.rstudio.core.client.theme.WindowFrame;
 import org.rstudio.core.client.widget.ToolbarButton;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.workbench.views.console.ConsoleInterruptButton;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputPresenter.java
Patch:
@@ -19,7 +19,6 @@
 import com.google.gwt.user.client.ui.HasText;
 import com.google.inject.Inject;
 import org.rstudio.core.client.CodeNavigationTarget;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.command.Handler;
 import org.rstudio.core.client.events.*;
 import org.rstudio.core.client.files.FileSystemItem;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/find/FindOutputTab.java
Patch:
@@ -14,7 +14,6 @@
 
 import com.google.gwt.core.client.GWT;
 import com.google.inject.Inject;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.command.Handler;
 import org.rstudio.studio.client.application.events.EventBus;

File: src/gwt/src/org/rstudio/core/client/events/EnsureVisibleEvent.java
Patch:
@@ -13,7 +13,6 @@
 package org.rstudio.core.client.events;
 
 import com.google.gwt.event.shared.GwtEvent;
-import org.rstudio.core.client.Debug;
 
 public class EnsureVisibleEvent extends GwtEvent<EnsureVisibleHandler>
 {
@@ -28,7 +27,6 @@ public EnsureVisibleEvent()
    public EnsureVisibleEvent(boolean activate)
    {
       activate_ = activate;
-      Debug.printStackTrace("EnsureVisibleEvent(" + activate + ")");
    }
 
    public boolean getActivate()

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/DelayLoadTabShim.java
Patch:
@@ -45,7 +45,7 @@ protected void onDelayLoadSuccess(T obj)
          {
             public void onEnsureVisible(EnsureVisibleEvent event)
             {
-               parentTab_.ensureVisible();
+               parentTab_.ensureVisible(event.getActivate());
             }
          });
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/DelayLoadWorkbenchTab.java
Patch:
@@ -92,9 +92,9 @@ public void confirmClose(Command onConfirmed)
       onConfirmed.execute();
    }
 
-   public void ensureVisible()
+   public void ensureVisible(boolean activate)
    {
-      handlers_.fireEvent(new EnsureVisibleEvent());
+      handlers_.fireEvent(new EnsureVisibleEvent(activate));
    }
 
    public void ensureHidden()
@@ -138,7 +138,7 @@ protected void initialize(final WorkbenchPane pane, Panel panel)
       {
          public void onEnsureVisible(EnsureVisibleEvent event)
          {
-            ensureVisible();
+            ensureVisible(event.getActivate());
          }
       });
       pane.addEnsureHiddenHandler(new EnsureHiddenHandler()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourceShim.java
Patch:
@@ -93,7 +93,7 @@ protected void onDelayLoadSuccess(final Source obj)
                   {
                      public void onEnsureVisible(EnsureVisibleEvent event)
                      {
-                        parent_.fireEvent(new EnsureVisibleEvent());
+                        parent_.fireEvent(new EnsureVisibleEvent(event.getActivate()));
                      }
                   });
          }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryEntryItemCodec.java
Patch:
@@ -127,7 +127,8 @@ protected boolean needsBreak(TableRowElement prevRow, TableRowElement row)
 
       if (timestampMode_ == TimestampMode.GROUP)
       {
-         long lastTime = getTimestampForRow(prevRow);
+         long lastTime = prevRow == null ? Long.MIN_VALUE
+                                         : getTimestampForRow(prevRow);
          long time = getTimestampForRow(row);
          return Math.abs(time - lastTime) > 1000*60*15;
       }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/find/FindOutputPane.java
Patch:
@@ -24,7 +24,6 @@
 import com.google.gwt.user.cellview.client.HasKeyboardSelectionPolicy;
 import com.google.gwt.user.client.ui.LayoutPanel;
 import com.google.gwt.user.client.ui.Widget;
-import com.google.gwt.view.client.SelectionChangeEvent;
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.FilePosition;
 import org.rstudio.core.client.events.EnsureVisibleEvent;
@@ -35,7 +34,6 @@
 import org.rstudio.studio.client.workbench.ui.WorkbenchPane;
 import org.rstudio.studio.client.workbench.views.find.model.FindResult;
 
-import java.util.List;
 
 public class FindOutputPane extends WorkbenchPane
       implements FindOutputPresenter.Display,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/find/FindOutputPresenter.java
Patch:
@@ -15,8 +15,6 @@
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.event.logical.shared.HasSelectionHandlers;
-import com.google.gwt.event.logical.shared.SelectionEvent;
-import com.google.gwt.event.logical.shared.SelectionHandler;
 import com.google.inject.Inject;
 import org.rstudio.core.client.CodeNavigationTarget;
 import org.rstudio.core.client.command.Handler;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/find/FindOutputTab.java
Patch:
@@ -20,7 +20,6 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.events.FindInFilesResultEvent;
 import org.rstudio.studio.client.workbench.model.Session;
-import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.studio.client.workbench.ui.DelayLoadTabShim;
 import org.rstudio.studio.client.workbench.ui.DelayLoadWorkbenchTab;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/Search.java
Patch:
@@ -31,7 +31,7 @@ public static native Search create(String needle,
          wrap: wrap,
          caseSensitive: caseSensitive,
          wholeWord: wholeWord,
-         start: fromSelection ? null : {row: 0, columns: 0},
+         start: fromSelection ? null : {row: 0, column: 0},
          scope: selectionOnly ? Search.SELECTION : Search.ALL,
          regExp: regexpMode
       })

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/CompilePdfOutputPresenter.java
Patch:
@@ -48,8 +48,8 @@ public interface Display extends WorkbenchView, HasEnsureHiddenHandlers
    {
       void compileStarted(String text);
       void showOutput(String output);
-      void clearOutput();
       void showErrors(JsArray<CompilePdfError> errors);
+      void clearAll();
       void compileCompleted();
       HasClickHandlers stopButton();
    }
@@ -133,7 +133,7 @@ protected void onSuccess(Boolean started)
                {
                   if (started)
                   {
-                     view_.clearOutput();
+                     view_.clearAll();
                   }
                   else
                   {

File: src/gwt/src/org/rstudio/core/client/theme/WindowFrame.java
Patch:
@@ -256,6 +256,9 @@ public void setContextButton(Widget button, int width, int height)
          frame_.add(button);
          frame_.setWidgetRightWidth(button, 48, Unit.PX, width, Unit.PX);
          frame_.setWidgetTopHeight(button, 3, Unit.PX, height, Unit.PX);
+         // Without z-index, the header widget will obscure the context button
+         // if the former is set after the latter.
+         frame_.getWidgetContainerElement(button).getStyle().setZIndex(10);
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/CompilePdfOutputPane.java
Patch:
@@ -72,6 +72,7 @@ public void showOutput(String output)
    @Override
    public void showErrors(JsArray<CompilePdfError> errors)
    {
+      outputWidget_.consoleWriteOutput("\n");
       for (int i=0; i<errors.length(); i++)
          outputWidget_.consoleWriteOutput(errors.get(i).asString() + "\n");
    }

File: src/gwt/src/org/rstudio/studio/client/server/remote/ClientEvent.java
Patch:
@@ -65,6 +65,7 @@ class ClientEvent extends JavaScriptObject
    public static final String ConsoleProcessPrompt = "console_process_prompt";
    public static final String ConsoleProcessCreated = "console_process_created";
    public static final String CompilePdfOutputEvent = "compile_pdf_output_event";
+   public static final String CompilePdfErrorsEvent = "compile_pdf_errors_event";
    
    protected ClientEvent()
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/output/compilepdf/events/CompilePdfOutputEvent.java
Patch:
@@ -10,7 +10,7 @@
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
  *
  */
-package org.rstudio.studio.client.workbench.views.output.compilepdf;
+package org.rstudio.studio.client.workbench.views.output.compilepdf.events;
 
 import com.google.gwt.event.shared.EventHandler;
 import com.google.gwt.event.shared.GwtEvent;

File: src/gwt/src/org/rstudio/core/client/theme/ModuleTabLayoutPanel.java
Patch:
@@ -14,8 +14,6 @@
 
 import com.google.gwt.dom.client.NativeEvent;
 import com.google.gwt.dom.client.Style;
-import com.google.gwt.dom.client.Style.Position;
-import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.dom.client.ClickEvent;
 import com.google.gwt.event.dom.client.ClickHandler;
 import com.google.gwt.event.dom.client.MouseDownEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/ConsoleTabPanel.java
Patch:
@@ -12,9 +12,6 @@
  */
 package org.rstudio.studio.client.workbench.ui;
 
-import com.google.gwt.event.dom.client.ClickEvent;
-import com.google.gwt.event.dom.client.ClickHandler;
-import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.events.*;
 import org.rstudio.core.client.theme.PrimaryWindowFrame;
 import org.rstudio.core.client.theme.WindowFrame;

File: src/gwt/src/org/rstudio/studio/client/common/rnw/RnwWeaveSelectWidget.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * WeaveRnwSelectWidget.java
+ * RnwWeaveSelectWidget.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -284,6 +284,7 @@ private DualWindowLayoutPanel createSplitWindow(LogicalWindow top,
    private LogicalWindow createConsole()
    {
       PrimaryWindowFrame frame = new PrimaryWindowFrame("Console", null);
+      @SuppressWarnings("unused")
       ConsoleTabPanel consoleTabPanel = new ConsoleTabPanel(frame,
                                                             consolePane_,
                                                             compilePdfTab_,

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/ToolbarPane.java
Patch:
@@ -14,8 +14,6 @@
 
 import com.google.gwt.dom.client.Style;
 import com.google.gwt.event.shared.HandlerRegistration;
-import com.google.gwt.layout.client.Layout.AnimationCallback;
-import com.google.gwt.layout.client.Layout.Layer;
 import com.google.gwt.user.client.ui.DockLayoutPanel;
 import com.google.gwt.user.client.ui.LazyPanel;
 import com.google.gwt.user.client.ui.RequiresResize;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchScreen.java
Patch:
@@ -48,8 +48,6 @@
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.model.WorkbenchMetrics;
 import org.rstudio.studio.client.workbench.ui.PaneManager.Tab;
-import org.rstudio.studio.client.workbench.views.console.events.WorkingDirChangedEvent;
-import org.rstudio.studio.client.workbench.views.console.events.WorkingDirChangedHandler;
 import org.rstudio.studio.client.workbench.views.edit.Edit;
 import org.rstudio.studio.client.workbench.views.edit.Edit.Shim;
 import org.rstudio.studio.client.workbench.views.edit.events.ShowEditorEvent;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/WritingPreferencesPane.java
Patch:
@@ -64,7 +64,7 @@ public WritingPreferencesPane(UIPrefs prefs,
       add(chkUseTexi2Dvi_);
       
       chkCleanTexi2DviOutput_ = new CheckBox(
-            "Clean auxillary output after compile");
+            "Clean auxiliary output after compile");
       add(chkCleanTexi2DviOutput_);
       
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -518,7 +518,7 @@ private void validateRequiredComponents()
                                   !texCap.isTexInstalled();
       
       final boolean checkForRnwWeave = (rnwWeave != null) && 
-                                       !rnwWeave.isAvailable(texCap);
+                                       !texCap.isRnwWeaveAvailable(rnwWeave);
                                  
       if (checkForTeX || checkForRnwWeave)
       {
@@ -542,7 +542,8 @@ public void onResponseReceived(TexCapabilities response)
                                "may not be able to compile.";
                   view_.showWarningBar(warning);
                }
-               else if (checkForRnwWeave && !fRnwWeave.isAvailable(response))
+               else if (checkForRnwWeave && 
+                        !response.isRnwWeaveAvailable(fRnwWeave))
                {
                   String forContext = "";
                   if (hasRnwWeaveDirective)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTargetWidget.java
Patch:
@@ -204,9 +204,9 @@ public void onClick(ClickEvent event)
             }
             
          });
-         panel_.insertNorth(warningBar_, warningBar_.getHeight(), null);
       }
       warningBar_.setText(warning);
+      panel_.insertNorth(warningBar_, warningBar_.getHeight(), null);
    }
 
    public void hideWarningBar()

File: src/gwt/src/org/rstudio/studio/client/RStudioGinModule.java
Patch:
@@ -99,6 +99,7 @@
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditor;
 import org.rstudio.studio.client.workbench.views.source.editors.text.DocDisplay;
 import org.rstudio.studio.client.workbench.views.source.model.SourceServerOperations;
+import org.rstudio.studio.client.workbench.views.source.model.TexServerOperations;
 import org.rstudio.studio.client.workbench.views.vcs.VCSTab;
 import org.rstudio.studio.client.workbench.views.vcs.common.diff.LineTablePresenter;
 import org.rstudio.studio.client.workbench.views.vcs.common.diff.LineTableView;
@@ -214,6 +215,7 @@ protected void configure()
       bind(CodeSearchServerOperations.class).to(RemoteServer.class);
       bind(WorkbenchListsServerOperations.class).to(RemoteServer.class);
       bind(CryptoServerOperations.class).to(RemoteServer.class);
+      bind(TexServerOperations.class).to(RemoteServer.class);
 
       bind(WorkbenchMainView.class).to(WorkbenchScreen.class) ;
 

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -26,6 +26,7 @@
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.common.filetypes.NewFileMenu;
 import org.rstudio.studio.client.common.impl.DesktopFileDialogs;
+import org.rstudio.studio.client.common.prefs.WeaveRnwSelectWidget;
 import org.rstudio.studio.client.vcs.VCSApplication;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.RemoteFileSystemContext;
@@ -48,6 +49,7 @@ public interface RStudioGinjector extends Ginjector
    void injectMembers(RCompletionManager rCompletionManager);
    void injectMembers(SVNCommandHandler svnCommandHandler);
    void injectMembers(CaptionWithHelp captionWithHelp);
+   void injectMembers(WeaveRnwSelectWidget selectWidget);
 
    public static final RStudioGinjector INSTANCE = GWT.create(RStudioGinjector.class);
 

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectWritingPreferencesPane.java
Patch:
@@ -64,10 +64,11 @@ public boolean validate()
    }
 
    @Override
-   public void onApply(RProjectOptions options)
+   public boolean onApply(RProjectOptions options)
    {
       RProjectConfig config = options.getConfig();
       config.setDefaultSweaveEngine(defaultSweaveEngine_.getValue());
+      return false;
    }
     
    private WeaveRnwSelectWidget defaultSweaveEngine_;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/WritingPreferencesPane.java
Patch:
@@ -80,11 +80,12 @@ protected void initialize(RPrefs prefs)
    }
    
    @Override
-   public void onApply(RPrefs rPrefs)
+   public boolean onApply(RPrefs rPrefs)
    {
-      super.onApply(rPrefs);
+      boolean requiresRestart = super.onApply(rPrefs);
       prefs_.defaultSweaveEngine().setGlobalValue(
                                     defaultSweaveEngine_.getValue());
+      return requiresRestart;
    }
 
    private final UIPrefs prefs_;

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectPreferencesDialog.java
Patch:
@@ -84,7 +84,7 @@ public void onResponseReceived(Void response)
                 uiPrefs.defaultEncoding().setProjectValue(
                                            config.getEncoding()); 
                 uiPrefs.defaultSweaveEngine().setProjectValue(
-                                           config.getWeaveRnwWith());
+                                           config.getDefaultSweaveEngine());
                 
                 if (onCompleted != null)
                    onCompleted.execute();

File: src/gwt/src/org/rstudio/studio/client/projects/ui/prefs/ProjectWritingPreferencesPane.java
Patch:
@@ -54,7 +54,7 @@ public String getName()
    protected void initialize(RProjectOptions options)
    {
       RProjectConfig config = options.getConfig();
-      defaultSweaveEngine_.setValue(config.getWeaveRnwWith());
+      defaultSweaveEngine_.setValue(config.getDefaultSweaveEngine());
    }
    
    @Override
@@ -67,7 +67,7 @@ public boolean validate()
    public void onApply(RProjectOptions options)
    {
       RProjectConfig config = options.getConfig();
-      config.setSweaveRnwWith(defaultSweaveEngine_.getValue());
+      config.setDefaultSweaveEngine(defaultSweaveEngine_.getValue());
    }
     
    private WeaveRnwSelectWidget defaultSweaveEngine_;

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchTabPanel.java
Patch:
@@ -126,8 +126,8 @@ public void onEnsureVisible(EnsureVisibleEvent event)
 
    public void selectTab(int tabIndex)
    {
-      // deal with migrating from n+1 to n tabs 
-      int safeIndex = Math.min(tabIndex, tabs_.size() - 1);
+      // deal with migrating from n+1 to n tabs, and with -1 values
+      int safeIndex = Math.min(Math.max(0, tabIndex), tabs_.size() - 1);
       
       tabPanel_.selectTab(safeIndex);
    }

File: src/gwt/src/org/rstudio/studio/client/vcs/ui/VCSApplicationWindow.java
Patch:
@@ -96,7 +96,7 @@ public void reactivate(JavaScriptObject params)
       // for no parameters passed we still want to do a refresh
       else
       {
-         pCommands_.get().vcsRefresh().execute();
+         pCommands_.get().vcsRefreshNoError().execute();
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -106,6 +106,7 @@
    public abstract AppCommand vcsRevert();
    public abstract AppCommand vcsShowHistory();
    public abstract AppCommand vcsRefresh();
+   public abstract AppCommand vcsRefreshNoError();
    public abstract AppCommand vcsOpen();
    public abstract AppCommand vcsIgnore();
    public abstract AppCommand vcsPull();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/ConsoleProgressDialog.java
Patch:
@@ -118,6 +118,7 @@ public ConsoleProgressDialog(String title,
       setText(title);
 
       display_ = new ConsoleProgressWidget();
+      display_.addStyleName(resources_.styles().shellDisplay());
       Style style = display_.getElement().getStyle();
       double skewFactor = (12 + BrowseCap.getFontSkew()) / 12.0;
       int width = Math.min((int)(skewFactor * 660),

File: src/gwt/src/org/rstudio/core/client/widget/ScrollableToolbarPopupMenu.java
Patch:
@@ -13,7 +13,6 @@
 package org.rstudio.core.client.widget;
 
 import com.google.gwt.dom.client.Style.Overflow;
-import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.logical.shared.HasSelectionHandlers;
 import com.google.gwt.event.logical.shared.SelectionEvent;
 import com.google.gwt.event.logical.shared.SelectionHandler;

File: src/gwt/src/org/rstudio/core/client/widget/TextEntryModalDialog.java
Patch:
@@ -109,10 +109,9 @@ protected boolean validate(String input)
 
       if (numbersOnly_)
       {
-         setText(getText().trim());
          try
          {
-            Integer.parseInt(getText());
+            Integer.parseInt(input.trim());
          }
          catch (NumberFormatException nfe)
          {

File: src/gwt/src/org/rstudio/studio/client/common/DefaultGlobalDisplay.java
Patch:
@@ -144,8 +144,8 @@ public void promptForInteger(String title,
             {
                @Override
                public void execute(String input, ProgressIndicator indicator)
-               {
-                  int value = Integer.parseInt(input);
+               {  
+                  int value = Integer.parseInt(input.trim());
                   okOperation.execute(value, indicator);
                }
             },

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1400,6 +1400,8 @@ void onGoToLine()
                @Override
                public void execute(Integer line, ProgressIndicator indicator)
                {
+                  indicator.onCompleted();
+                  
                   line = Math.max(1, line);
                   line = Math.min(docDisplay_.getRowCount(), line);
 

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -1463,7 +1463,7 @@ public void gitDiffFile(String path,
                            PatchMode mode,
                            int contextLines,
                            boolean noSizeWarning,
-                           ServerRequestCallback<String> requestCallback)
+                           ServerRequestCallback<DiffResult> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(path));
@@ -1476,11 +1476,13 @@ public void gitDiffFile(String path,
    @Override
    public void gitApplyPatch(String patch,
                              PatchMode mode,
+                             String sourceEncoding,
                              ServerRequestCallback<Void> requestCallback)
    {
       JSONArray params = new JSONArray();
       params.set(0, new JSONString(patch));
       params.set(1, new JSONNumber(mode.getValue()));
+      params.set(2, new JSONString(sourceEncoding));
       sendRequest(RPC_SCOPE, GIT_APPLY_PATCH, params, requestCallback);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/WorkbenchView.java
Patch:
@@ -17,6 +17,7 @@ public interface WorkbenchView
 {
    void bringToFront();
    void setProgress(boolean showProgress);
+   void onBeforeUnselected();
    void onBeforeSelected();
    void onSelected();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/DelayLoadTabShim.java
Patch:
@@ -56,6 +56,7 @@ public void onEnsureVisible(EnsureVisibleEvent event)
       parentTab_.getPanel().add(child);
    }
 
+   public abstract void onBeforeUnselected();
    public abstract void onBeforeSelected();
    public abstract void onSelected();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchPane.java
Patch:
@@ -35,6 +35,9 @@ public String getTitle()
    }
 
    // hook for subclasses to be notified right before & after they are selected
+   public void onBeforeUnselected()
+   {
+   }
    public void onBeforeSelected()
    {
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchTab.java
Patch:
@@ -19,6 +19,7 @@
 public interface WorkbenchTab extends IsWidget, HasEnsureVisibleHandlers
 {
    String getTitle();
+   void onBeforeUnselected();
    void onBeforeSelected();
    void onSelected();
    void prefetch(Command continuation);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/HistoryStrategy.java
Patch:
@@ -56,4 +56,6 @@ void showCommit(String commitId,
    boolean getAutoSelectFirstRow();
 
    DiffParser createParserForCommit(String commitDiff);
+   
+   boolean getShowHistoryErrors();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/ConsoleProgressDialog.java
Patch:
@@ -126,8 +126,7 @@ public ConsoleProgressDialog(String title,
       style.setWidth(width, Unit.PX);
       
       display_.setMaxOutputLines(getMaxOutputLines());
-      if (Desktop.isDesktop() && BrowseCap.isWindows())
-         display_.setSuppressPendingInput(true);
+      display_.setSuppressPendingInput(true);
      
       if (getInteractionMode() != ConsoleProcessInfo.INTERACTION_NEVER)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/ConsoleProgressDialog.java
Patch:
@@ -37,6 +37,7 @@
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.command.KeyboardShortcut;
 import org.rstudio.core.client.widget.*;
+import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.common.SimpleRequestCallback;
 import org.rstudio.studio.client.common.console.ConsoleOutputEvent;
 import org.rstudio.studio.client.common.console.ConsolePromptEvent;
@@ -125,6 +126,8 @@ public ConsoleProgressDialog(String title,
       style.setWidth(width, Unit.PX);
       
       display_.setMaxOutputLines(getMaxOutputLines());
+      if (Desktop.isDesktop() && BrowseCap.isWindows())
+         display_.setSuppressPendingInput(true);
      
       if (getInteractionMode() != ConsoleProcessInfo.INTERACTION_NEVER)
       {

File: src/gwt/src/org/rstudio/studio/client/common/vcs/IgnoreStrategy.java
Patch:
@@ -8,7 +8,7 @@
  * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,
  * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the
  * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
- * 
+ *
  */
 package org.rstudio.studio.client.common.vcs;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/model/VcsState.java
Patch:
@@ -100,7 +100,7 @@ public void onFileChange(FileChangeEvent event)
                return;
             }
 
-            if (status_ != null)
+            if (status_ != null && status != null)
             {
                for (int i = 0; i < status_.size(); i++)
                {

File: src/gwt/src/org/rstudio/studio/client/common/vcs/StatusAndPath.java
Patch:
@@ -13,6 +13,7 @@
 package org.rstudio.studio.client.common.vcs;
 
 import com.google.gwt.core.client.JsArray;
+import org.rstudio.core.client.StringUtil;
 
 import java.util.ArrayList;
 import java.util.Comparator;
@@ -66,7 +67,7 @@ public static StatusAndPath fromInfo(StatusAndPathInfo info)
 
    private StatusAndPath(StatusAndPathInfo info)
    {
-      status_ = info.getStatus();
+      status_ = StringUtil.notNull(info.getStatus());
       path_ = info.getPath();
       rawPath_ = info.getRawPath();
       changelist_ = info.getChangelist();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/ReviewPresenterImpl.java
Patch:
@@ -35,10 +35,10 @@ public ReviewPresenterImpl(Provider<GitReviewPresenter> pGitReviewPresenter,
 
       if (vcsName.equalsIgnoreCase("git"))
          pres_ = pGitReviewPresenter.get();
-      else if (vcsName.equalsIgnoreCase("subversion"))
+      else if (vcsName.equalsIgnoreCase("svn"))
          pres_ = pSvnReviewPresenter.get();
       else
-         throw new IllegalStateException("Unknown vcs name");
+         throw new IllegalStateException("Unknown vcs name: " + vcsName);
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/svn/SVNPane.java
Patch:
@@ -51,7 +51,7 @@ public SVNPane(SVNChangelistTablePresenter changelistTablePresenter,
             (ClickHandler)null);
       revertFilesButton_ = new ToolbarButton(
             "Revert",
-            commands_.vcsRevertFiles().getImageResource(),
+            commands_.vcsRevert().getImageResource(),
             (ClickHandler)null);
       updateButton_ = new ToolbarButton(
             "Update",

File: src/gwt/src/org/rstudio/studio/client/common/shell/ShellInteractionManager.java
Patch:
@@ -1,6 +1,7 @@
 package org.rstudio.studio.client.common.shell;
 
 
+import org.rstudio.core.client.BrowseCap;
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.command.KeyboardShortcut;
 import org.rstudio.studio.client.application.Desktop;
@@ -82,7 +83,7 @@ private void processInput(final CommandWithArg<ShellInput> onInputReady)
       final boolean echoInput = showInputForPrompt(promptText);
       if (echoInput)
          display_.consoleWriteInput(input);
-      else
+      else if (!Desktop.isDesktop() || !BrowseCap.isWindows())
          display_.consoleWriteInput("\n");
       
       // encrypt the input and return it

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/ViewFilePresenter.java
Patch:
@@ -46,8 +46,8 @@ public ViewFilePresenter(Display view,
    
    public void showFile(FileSystemItem file, String commitId, String contents)
    {
-      view_.adaptToFileType(fileTypeRegistry_.getTextTypeForFile(file));
       view_.getDocDisplay().setCode(contents, false);  
+      view_.adaptToFileType(fileTypeRegistry_.getTextTypeForFile(file));
       view_.show();
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -268,7 +268,7 @@ public void onClick(AceClickEvent event)
 
    private void indentPastedRange(Range range)
    {
-      if (!fileType_.canAutoIndent())
+      if (fileType_ == null || !fileType_.canAutoIndent())
          return;
 
       String firstLinePrefix = getSession().getTextRange(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/ReviewPresenterImpl.java
Patch:
@@ -16,7 +16,6 @@
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
 import com.google.inject.Provider;
-import org.rstudio.core.client.Debug;
 import org.rstudio.studio.client.common.vcs.StatusAndPath;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.views.vcs.common.events.SwitchViewEvent.Handler;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/common/ChangelistTable.java
Patch:
@@ -230,6 +230,7 @@ public void hideInfoBar()
          layout_.remove(infoBar_);
          layout_.setWidgetTopBottom(scrollPanel_, 0, Unit.PX, 0, Unit.PX);
          layout_.animate(250);
+         infoBar_ = null;
       }
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/vcs/SVNServerOperations.java
Patch:
@@ -14,7 +14,6 @@
 
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.JsArray;
-import org.rstudio.studio.client.common.SimpleRequestCallback;
 import org.rstudio.studio.client.common.console.ConsoleProcess;
 import org.rstudio.studio.client.common.crypto.CryptoServerOperations;
 import org.rstudio.studio.client.server.*;

File: src/gwt/src/org/rstudio/studio/client/vcs/ui/VCSApplicationWindow.java
Patch:
@@ -25,7 +25,6 @@
 import org.rstudio.studio.client.workbench.views.vcs.dialog.ReviewPresenter;
 import org.rstudio.studio.client.workbench.views.vcs.git.GitPresenterCore;
 import org.rstudio.studio.client.workbench.views.vcs.dialog.HistoryPresenter;
-import org.rstudio.studio.client.workbench.views.vcs.git.dialog.GitReviewPresenter;
 import org.rstudio.studio.client.workbench.views.vcs.frame.VCSPopup;
 
 import com.google.gwt.core.client.JavaScriptObject;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/frame/VCSPopup.java
Patch:
@@ -22,7 +22,6 @@
 import org.rstudio.studio.client.workbench.views.vcs.common.events.SwitchViewEvent;
 import org.rstudio.studio.client.workbench.views.vcs.dialog.HistoryPresenter;
 import org.rstudio.studio.client.workbench.views.vcs.dialog.ReviewPresenter;
-import org.rstudio.studio.client.workbench.views.vcs.git.dialog.GitReviewPresenter;
 
 public class VCSPopup
 {

File: src/gwt/src/org/rstudio/core/client/files/FileSystemItem.java
Patch:
@@ -16,8 +16,8 @@
 import com.google.gwt.resources.client.ImageResource;
 import org.rstudio.core.client.regex.Match;
 import org.rstudio.core.client.regex.Pattern;
-import org.rstudio.studio.client.common.vcs.StatusAndPath;
 import org.rstudio.studio.client.common.filetypes.FileIconResources;
+import org.rstudio.studio.client.common.vcs.StatusAndPathInfo;
 
 import java.util.Date;
 import java.util.HashMap;
@@ -274,7 +274,7 @@ private final native double getLastModifiedNative() /*-{
       return this.lastModified;
    }-*/;
 
-   public final native StatusAndPath getGitStatus() /*-{
+   public final native StatusAndPathInfo getGitStatus() /*-{
       return this.git_status;
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/common/vcs/AllStatus.java
Patch:
@@ -19,7 +19,7 @@ public class AllStatus extends JavaScriptObject
 {
    protected AllStatus() {}
 
-   public native final JsArray<StatusAndPath> getStatus() /*-{
+   public native final JsArray<StatusAndPathInfo> getStatus() /*-{
       return this.status;
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/common/vcs/GitServerOperations.java
Patch:
@@ -61,7 +61,7 @@ void gitAllStatus(
          ServerRequestCallback<AllStatus> requestCallback);
 
    void gitFullStatus(
-         ServerRequestCallback<JsArray<StatusAndPath>> requestCallback);
+         ServerRequestCallback<JsArray<StatusAndPathInfo>> requestCallback);
 
    void gitListBranches(ServerRequestCallback<BranchesInfo> requestCallback);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/ReviewPresenter.java
Patch:
@@ -242,7 +242,8 @@ public void onFileChange(FileChangeEvent event)
                      return;
                   }
 
-                  StatusAndPath vcsStatus = event.getFileChange().getFile().getGitStatus();
+                  StatusAndPath vcsStatus = StatusAndPath.fromInfo(
+                        event.getFileChange().getFile().getGitStatus());
                   if (paths.get(0).getRawPath().equals(vcsStatus.getRawPath()))
                   {
                      vcsState.refresh(false);

File: src/gwt/src/org/rstudio/core/client/prefs/PreferencesDialogPaneBase.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * PreferencesDialogBasePane.java
+ * PreferencesDialogPaneBase.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/GitPane.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * VCSPane.java
+ * GitPane.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/GitPresenter.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * VCS.java
+ * GitPresenter.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/GitPresenterCore.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * VCSCore.java
+ * GitPresenterCore.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -403,8 +403,8 @@ public void onVersionControlProjectSetup()
          globalDisplay_.showMessage(
                MessageDialog.INFO, 
                "No Active Project", 
-               "Version control features can only accesssed from within an " +
-               "RStudio project. Note that if you have an exiting directory " +
+               "Version control features can only be accessed from within an " +
+               "RStudio project. Note that if you have an existing directory " +
                "under version control you can associate an RStudio project " +
                "with that directory using the New Project dialog.");
         

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/graph/GraphLine.java
Patch:
@@ -22,7 +22,7 @@ public class GraphLine
 {
    public GraphLine(String value)
    {
-      String[] vals = value.split(" ");
+      String[] vals = value.length() == 0 ? new String[] {} : value.split(" ");
       columns_ = new GraphColumn[vals.length];
       for (int i = 0; i < columns_.length; i++)
          columns_[i] = new GraphColumn(vals[i]);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/diff/Line.java
Patch:
@@ -108,7 +108,7 @@ public int getDiffIndex()
 
    public Line reverse()
    {
-      if (appliesTo_.length > 1)
+      if (appliesTo_.length > 2)
          throw new UnsupportedOperationException("Can't reverse combined diff");
 
       return new Line(type_.getInverse(),

File: src/gwt/src/org/rstudio/studio/client/common/vcs/CreateKeyDialog.java
Patch:
@@ -252,6 +252,7 @@ else if (type.equals(RSA1))
    @Override
    protected void onLoad()
    {
+      super.onLoad();
       FocusHelper.setFocusDeferred(txtPassphrase_);
    }
    

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServerError.java
Patch:
@@ -13,6 +13,7 @@
 
 package org.rstudio.studio.client.server.remote;
 
+import com.google.gwt.json.client.JSONNull;
 import com.google.gwt.json.client.JSONValue;
 import org.rstudio.core.client.jsonrpc.RpcError;
 import org.rstudio.core.client.jsonrpc.RpcUnderlyingError;
@@ -75,7 +76,7 @@ public String getUserMessage()
    @Override
    public JSONValue getClientInfo()
    {
-      return clientInfo_;
+      return clientInfo_ == null ? JSONNull.getInstance() : clientInfo_;
    }
 
    private int codeFromRpcErrorCode(int code)

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/SourceControlPreferencesPane.java
Patch:
@@ -14,8 +14,6 @@
 package org.rstudio.studio.client.workbench.prefs.views;
 
 
-// TODO: auto change filemode for .ssh directory uploads
-
 // TODO: create ssh key UI (auto change filemode). 
 
 /*

File: src/gwt/src/org/rstudio/studio/client/projects/ui/newproject/NewProjectResources.java
Patch:
@@ -36,7 +36,6 @@ public interface NewProjectResources extends ClientBundle
    static interface Styles extends CssResource
    {
       String wizardWidget();
-      String wizardVcsSelector();
       String wizardTextEntry();
       String wizardTextEntryLabel();
       String wizardSpacer();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/CommitListTable.java
Patch:
@@ -35,7 +35,6 @@
 import org.rstudio.studio.client.workbench.views.vcs.dialog.HistoryPanel.Styles;
 import org.rstudio.studio.client.workbench.views.vcs.dialog.HistoryPresenter.CommitListDisplay;
 
-import java.util.ArrayList;
 import java.util.List;
 
 public class CommitListTable extends MultiSelectCellTable<CommitInfo>

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/HistoryPanel.java
Patch:
@@ -31,8 +31,6 @@
 import org.rstudio.studio.client.workbench.views.vcs.dialog.HistoryPresenter.CommitListDisplay;
 import org.rstudio.studio.client.workbench.views.vcs.dialog.HistoryPresenter.Display;
 
-import java.util.ArrayList;
-
 public class HistoryPanel extends Composite implements Display
 {
    public interface Resources extends ClientBundle

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/HistoryPresenter.java
Patch:
@@ -38,8 +38,6 @@
 import org.rstudio.studio.client.workbench.views.vcs.events.VcsRefreshHandler;
 import org.rstudio.studio.client.workbench.views.vcs.model.VcsState;
 
-import java.util.ArrayList;
-
 public class HistoryPresenter
 {
    public interface Display extends IsWidget

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/ReviewPanel.java
Patch:
@@ -35,8 +35,6 @@
 import com.google.inject.Inject;
 import org.rstudio.core.client.WidgetHandlerRegistration;
 import org.rstudio.core.client.command.KeyboardShortcut;
-import org.rstudio.core.client.dom.DomUtils;
-import org.rstudio.core.client.regex.Match;
 import org.rstudio.core.client.widget.*;
 import org.rstudio.studio.client.common.filetypes.FileTypeRegistry;
 import org.rstudio.studio.client.common.vcs.StatusAndPath;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserContextWidget.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * CodeBrowserContextLabel.java
+ * CodeBrowserContextWidget.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/Selection.java
Patch:
@@ -36,6 +36,7 @@ public native final void moveCursorTo(int row,
                                          int column,
                                          boolean preventUpdateDesiredColumn) /*-{
       this.moveCursorTo(row, column, preventUpdateDesiredColumn);
+      this.setSelectionAnchor(row, column);
    }-*/;
 
    public native final boolean isEmpty() /*-{

File: src/gwt/src/org/rstudio/studio/client/application/events/HandleUnsavedChangesEvent.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * ServerOfflineEvent.java
+ * HandleUnsavedChangesEvent.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/application/events/HandleUnsavedChangesHandler.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * ServerOfflineHandler.java
+ * HandleUnsavedChangesHandler.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/core/client/widget/DynamicIFrame.java
Patch:
@@ -31,7 +31,7 @@ interface Resources extends ClientBundle
    public DynamicIFrame()
    {
       Resources res = GWT.create(Resources.class);
-      setUrl(res.dynamicFrame().getUrl());
+      setUrl(res.dynamicFrame().getSafeUri().asString());
       attachCallback();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AceEditorPreview.java
Patch:
@@ -68,12 +68,12 @@ protected void onFrameLoaded()
       FontSizer.injectStylesIntoDocument(doc);
       FontSizer.applyNormalFontSize(div);
 
-      new ExternalJavaScriptLoader(doc, AceResources.INSTANCE.acejs().getUrl())
+      new ExternalJavaScriptLoader(doc, AceResources.INSTANCE.acejs().getSafeUri().asString())
             .addCallback(new Callback()
       {
          public void onLoaded()
          {
-            new ExternalJavaScriptLoader(doc, AceResources.INSTANCE.acesupportjs().getUrl())
+            new ExternalJavaScriptLoader(doc, AceResources.INSTANCE.acesupportjs().getSafeUri().asString())
                   .addCallback(new Callback()
                   {
                      public void onLoaded()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -1148,7 +1148,7 @@ public void setNewLineMode(NewLineMode mode)
    private TextFileType fileType_;
 
    private static final ExternalJavaScriptLoader aceLoader_ =
-         new ExternalJavaScriptLoader(AceResources.INSTANCE.acejs().getUrl());
+         new ExternalJavaScriptLoader(AceResources.INSTANCE.acejs().getSafeUri().asString());
    private static final ExternalJavaScriptLoader aceSupportLoader_ =
-         new ExternalJavaScriptLoader(AceResources.INSTANCE.acesupportjs().getUrl());
+         new ExternalJavaScriptLoader(AceResources.INSTANCE.acesupportjs().getSafeUri().asString());
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java
Patch:
@@ -78,7 +78,7 @@ public String getThemeUrl(String name)
    private void addTheme(String name, StaticDataResource resource)
    {
       themes_.add(name);
-      themesByName_.put(name, resource.getUrl());
+      themesByName_.put(name, resource.getSafeUri().asString());
    }
 
    private void applyTheme(String themeName)

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchLists.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * WarningBarMessage.java
+ * WorkbenchLists.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WorkbenchListsServerOperations.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * WorkbenchServerOperations.java
+ * WorkbenchListsServerOperations.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/model/SessionInfo.java
Patch:
@@ -100,7 +100,7 @@ public final native JsArray<SourceDocument> getSourceDocuments() /*-{
       return this.source_documents;
    }-*/;
    
-   public final native JsObject getLists() /*-{
+   public final native WorkbenchLists getLists() /*-{
       return this.lists;
    }-*/;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/VCS.java
Patch:
@@ -21,8 +21,6 @@
 import com.google.inject.Inject;
 import com.google.inject.Provider;
 import org.rstudio.core.client.CommandWithArg;
-import org.rstudio.core.client.ExternalJavaScriptLoader;
-import org.rstudio.core.client.ExternalJavaScriptLoader.Callback;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.command.Handler;
 import org.rstudio.core.client.command.KeyboardShortcut;
@@ -31,7 +29,6 @@
 import org.rstudio.core.client.widget.Operation;
 import org.rstudio.core.client.widget.ProgressIndicator;
 import org.rstudio.core.client.widget.ProgressOperationWithInput;
-import org.rstudio.studio.client.application.Desktop;
 import org.rstudio.studio.client.application.events.EventBus;
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.common.SimpleRequestCallback;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceResources.java
Patch:
@@ -20,7 +20,7 @@ public interface AceResources extends ClientBundle
 {
    public static final AceResources INSTANCE = GWT.create(AceResources.class);
 
-   @Source("ace-uncompressed.js")
+   @Source("ace.js")
    StaticDataResource acejs();
 
    @Source("acesupport.js")

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ace/AceResources.java
Patch:
@@ -20,7 +20,7 @@ public interface AceResources extends ClientBundle
 {
    public static final AceResources INSTANCE = GWT.create(AceResources.class);
 
-   @Source("ace.js")
+   @Source("ace-uncompressed.js")
    StaticDataResource acejs();
 
    @Source("acesupport.js")

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/TextFileType.java
Patch:
@@ -134,6 +134,7 @@ public HashSet<AppCommand> getSupportedCommands(Commands commands)
       }
       results.add(commands.findReplace());
       results.add(commands.setWorkingDirToActiveDoc());
+      results.add(commands.debugForceTopsToZero());
       return results;
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/commands/Commands.java
Patch:
@@ -187,6 +187,7 @@
    public abstract AppCommand helpKeyboardShortcuts();
    public abstract AppCommand showRequestLog();
    public abstract AppCommand logFocusedElement();
+   public abstract AppCommand debugForceTopsToZero();
 
    // Application
    public abstract AppCommand quitSession();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -192,6 +192,7 @@ public Source(Commands commands,
       dynamicCommands_.add(commands.jumpToFunction());
       dynamicCommands_.add(commands.goToFunctionDefinition());
       dynamicCommands_.add(commands.setWorkingDirToActiveDoc());
+      dynamicCommands_.add(commands.debugForceTopsToZero());
       dynamicCommands_.add(commands.goToLine());
       for (AppCommand command : dynamicCommands_)
       {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -103,4 +103,6 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
    Position getSelectionEnd();
    int getLength(int row);
    int getRowCount();
+
+   void debug_forceTopsToZero();
 }
\ No newline at end of file

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -103,6 +103,7 @@ public void initialize(SourceDocument document,
       view_ = new CodeBrowserEditingTargetWidget(commands_,
                                                  globalDisplay_,
                                                  events_,
+                                                 prefs_, 
                                                  server_, 
                                                  docDisplay_);
       

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceNavigation.java
Patch:
@@ -59,7 +59,7 @@ public final boolean isAtSameRowAs(SourceNavigation other)
       else
       {
          return getDocumentId().equals(other.getDocumentId()) &&
-                (getPosition().getRow() == other.getPosition().getRow());
+                getPosition().isSameRowAs(other.getPosition());
       }
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/DocDisplay.java
Patch:
@@ -86,6 +86,9 @@ DocDisplay.AnchoredSelection createAnchoredSelection(Position start,
    Position getCursorPosition();
    void setCursorPosition(Position position);
 
+   void scrollToX(int x);
+   void scrollToY(int y);
+   
    FunctionStart getCurrentFunction();
    JsArray<FunctionStart> getFunctionTree();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTargetWidget.java
Patch:
@@ -14,6 +14,7 @@
 
 import com.google.gwt.dom.client.NativeEvent;
 import com.google.gwt.user.client.ui.Composite;
+import com.google.gwt.user.client.ui.ResizeComposite;
 import com.google.gwt.user.client.ui.Widget;
 
 import org.rstudio.core.client.StringUtil;
@@ -40,7 +41,7 @@
 import org.rstudio.studio.client.workbench.views.source.events.CodeBrowserNavigationEvent;
 import org.rstudio.studio.client.workbench.views.source.model.SourcePosition;
 
-public class CodeBrowserEditingTargetWidget extends Composite
+public class CodeBrowserEditingTargetWidget extends ResizeComposite
    implements CodeBrowserEditingTarget.Display
 {
    public CodeBrowserEditingTargetWidget(Commands commands,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/codebrowser/CodeBrowserEditingTarget.java
Patch:
@@ -55,12 +55,12 @@
 import java.util.ArrayList;
 import java.util.HashSet;
 
-// TODO: joe on reflow ace call to fix issues
-
 // TODO: token guessing must include explicit namespace qualifiers
 
 // TODO: go to function definition inside code browser editing target
-//       (no completion manager)
+//       (no completion manager). we need a simple completion manager
+//       which can do internal searches as well as run the appropriate
+//       external queries (based on the search path of the package)
 
 // TODO: consider replacing two spaces with one at the beginning of line
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceNavigation.java
Patch:
@@ -65,7 +65,7 @@ public final boolean isAtSameRowAs(SourceNavigation other)
    
    public final String toDebugString()
    {
-      return getPath() != null ? getPath() : getDocumentId() + " (" +
+      return (getPath() != null ? getPath() : getDocumentId()) + " (" +
              getPosition().getRow() + ", " + getPosition().getColumn() + ")";
    }
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/VCSPane.java
Patch:
@@ -43,7 +43,6 @@ public VCSPane(ConsoleBarFramePanel consoleBarFrame,
       commands_ = commands;
       branchToolbarButton_ = branchToolbarButton;
 
-      changelistTablePresenter.initializeClientState();
       table_ = changelistTablePresenter.getView();
       consoleBarFrame_.setWidget(table_);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/ReviewPanel.java
Patch:
@@ -253,7 +253,7 @@ public ReviewPanel(ChangelistTablePresenter changelist,
                public void onClick(ClickEvent event)
                {
                   changelist_.showProgress();
-                  commands.vcsRefresh();
+                  commands.vcsRefresh().execute();
                }
             }));
 

File: src/gwt/src/org/rstudio/core/client/BrowseCap.java
Patch:
@@ -94,7 +94,7 @@ private static final boolean getFixedUbuntuMono()
       }
       else
       {
-         return true;
+         return false;
       }
    }
 

File: src/gwt/src/org/rstudio/core/client/ResultCallback.java
Patch:
@@ -19,7 +19,7 @@
 public abstract class ResultCallback<TSuccess, TFailure>
 {
    public void onSuccess(TSuccess result) {}
-   public boolean onFailure(TFailure info) { return false; }
+   public void onFailure(TFailure info) {}
 
    public static <TSuccess, TFailure>
    ResultCallback<TSuccess, TFailure> create(final CommandWithArg<TSuccess> cmd)

File: src/gwt/src/org/rstudio/core/client/ResultCallback.java
Patch:
@@ -19,7 +19,7 @@
 public abstract class ResultCallback<TSuccess, TFailure>
 {
    public void onSuccess(TSuccess result) {}
-   public void onFailure(TFailure info) {}
+   public boolean onFailure(TFailure info) { return false; }
 
    public static <TSuccess, TFailure>
    ResultCallback<TSuccess, TFailure> create(final CommandWithArg<TSuccess> cmd)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -426,6 +426,9 @@ public void onResponseReceived(SourceDocument newDoc)
                @Override
                public void onError(ServerError error)
                {
+                  // make sure error dialog is shown
+                  super.onError(error);
+
                   if (resultCallback != null)
                      resultCallback.onFailure(error);
                }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -1146,6 +1146,7 @@ public void onTabClosed(TabClosedEvent event)
 
       if (view_.getTabCount() == 0)
       {
+         sourceNavigationHistory_.clear();
          events_.fireEvent(new LastSourceDocClosedEvent());
       }
    }
@@ -1329,10 +1330,9 @@ private void attemptSourceNavigation(final SourceNavigation navigation,
          // check for navigation to the current position -- in this
          // case execute the retry command
          if ( (target == activeEditor_) && 
-               target.isAtPosition(navigation.getPosition()))
+               target.isAtSourceRow(navigation.getPosition()))
          {
-            if (retryCommand.isEnabled())
-               retryCommand.execute();
+            retryCommand.execute();
          }
          else
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/EditingTarget.java
Patch:
@@ -57,7 +57,7 @@ public interface EditingTarget extends IsWidget,
    void recordCurrentNavigationPosition();
    void navigateToPosition(SourcePosition position, boolean recordCurrent);
    void restorePosition(SourcePosition position);
-   boolean isAtPosition(SourcePosition position);
+   boolean isAtSourceRow(SourcePosition position);
    
    /**
     * @return True if dismissal is allowed, false to cancel.

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -868,11 +868,10 @@ public void restorePosition(SourcePosition position)
    }
    
    @Override 
-   public boolean isAtPosition(SourcePosition position)
+   public boolean isAtSourceRow(SourcePosition position)
    {
       Position currPos = getCursorPosition();
-      return currPos.getRow() == position.getRow() &&
-             currPos.getColumn() == position.getColumn();
+      return currPos.getRow() == position.getRow();
    }
    
    private void navigate(SourcePosition srcPosition, boolean addToHistory)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/NavigableSourceEditor.java
Patch:
@@ -29,7 +29,7 @@ void navigateToPosition(SourcePosition position,
    
    void restorePosition(SourcePosition position);
    
-   boolean isAtPosition(SourcePosition position);
+   boolean isAtSourceRow(SourcePosition position);
    
    HandlerRegistration addRecordNavigationPositionHandler(
                               RecordNavigationPositionHandler handler);

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -352,9 +352,9 @@ public void restorePosition(SourcePosition position)
    }
    
    @Override
-   public boolean isAtPosition(SourcePosition position)
+   public boolean isAtSourceRow(SourcePosition position)
    {
-      return docDisplay_.isAtPosition(position);
+      return docDisplay_.isAtSourceRow(position);
    }
    
    private void jumpToPreviousFunction()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/urlcontent/UrlContentEditingTarget.java
Patch:
@@ -159,7 +159,7 @@ public void restorePosition(SourcePosition position)
    }
    
    @Override 
-   public boolean isAtPosition(SourcePosition position)
+   public boolean isAtSourceRow(SourcePosition position)
    {
       return false;
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/model/FunctionDefinitionLocation.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * CodeNavigationTarget.java
+ * FunctionDefinitionLocation.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/ReviewPresenter.java
Patch:
@@ -43,7 +43,6 @@
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.ClientState;
 import org.rstudio.studio.client.workbench.model.Session;
-import org.rstudio.studio.client.workbench.model.SessionInfo;
 import org.rstudio.studio.client.workbench.model.helper.IntStateValue;
 import org.rstudio.studio.client.workbench.views.vcs.ChangelistTable;
 import org.rstudio.studio.client.workbench.views.vcs.diff.*;

File: src/gwt/src/org/rstudio/studio/client/common/vcs/VCSServerOperations.java
Patch:
@@ -14,6 +14,7 @@
 
 import com.google.gwt.core.client.JsArray;
 import org.rstudio.core.client.jsonrpc.RpcObjectList;
+import org.rstudio.studio.client.common.console.ConsoleProcess;
 import org.rstudio.studio.client.server.*;
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.workbench.views.vcs.dialog.CommitInfo;
@@ -88,9 +89,9 @@ void vcsExecuteCommand(
    void vcsShow(String rev,
                 ServerRequestCallback<String> requestCallback);
 
-   void vcsPush(ServerRequestCallback<Void> requestCallback);
+   void vcsPush(ServerRequestCallback<ConsoleProcess> requestCallback);
 
-   void vcsPull(ServerRequestCallback<Void> requestCallback);
+   void vcsPull(ServerRequestCallback<ConsoleProcess> requestCallback);
 
    void askpassReturn(String handle, String value,
                       ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -82,6 +82,7 @@ public FileTypeRegistry(EventBus eventBus)
       register("*.txt", TEXT, icons.iconText());
       register("*.log", TEXT, icons.iconText());
       register("README", TEXT, icons.iconText());
+      register(".gitignore", TEXT, icons.iconText());
       register("*.r", R, icons.iconRdoc());
       register(".rprofile", R, icons.iconRprofile());
       register("*.rhistory", RHISTORY, icons.iconRhistory());

File: src/gwt/src/org/rstudio/studio/client/common/SimpleRequestCallback.java
Patch:
@@ -12,6 +12,7 @@
  */
 package org.rstudio.studio.client.common;
 
+import org.rstudio.core.client.Debug;
 import org.rstudio.studio.client.RStudioGinjector;
 import org.rstudio.studio.client.server.ServerError;
 import org.rstudio.studio.client.server.ServerRequestCallback;
@@ -31,6 +32,7 @@ public SimpleRequestCallback(String caption)
    @Override
    public void onError(ServerError error)
    {
+      Debug.logError(error);
       RStudioGinjector.INSTANCE.getGlobalDisplay().showErrorMessage(
             caption_,
             error.getUserMessage());

File: src/gwt/src/org/rstudio/core/client/widget/ModalDialogBase.java
Patch:
@@ -95,14 +95,14 @@ protected void beginDragging(MouseDownEvent event)
    @Override
    protected void onLoad()
    {
-      // 728: Focus remains in Source view when message dialog pops up over it
-      NativeWindow.get().focus();
-      
       super.onLoad();
       allActiveDialogs_.add(this);
       if (shortcutDisableHandle_ != null)
          shortcutDisableHandle_.close();
       shortcutDisableHandle_ = ShortcutManager.INSTANCE.disable();
+
+      // 728: Focus remains in Source view when message dialog pops up over it
+      NativeWindow.get().focus();
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/search/HelpSearch.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * Search.java
+ * HelpSearch.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/manipulator/ManipulatorControlButton.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * ManipulatorControlCheckBox.java
+ * ManipulatorControlButton.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -772,7 +772,8 @@ public void execute(EditingTarget target)
          }
       };
 
-      if (event.getFile().getLength() < 0)
+      // Warning: event.getFile() can be null (e.g. new Sweave document)
+      if (event.getFile() != null && event.getFile().getLength() < 0)
       {
          // If the file has no size info, stat the file from the server. This
          // is to prevent us from opening large files accidentally.

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -489,7 +489,8 @@ public void execute(FileSystemItem file)
          }
       };
 
-      if (event.getFile().getLength() < 0)
+      // Warning: event.getFile() can be null (e.g. new Sweave document)
+      if (event.getFile() != null && event.getFile().getLength() < 0)
       {
          // If the file has no size info, stat the file from the server. This
          // is to prevent us from opening large files accidentally.

File: src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java
Patch:
@@ -687,7 +687,7 @@ public void completeUpload(FileUploadToken token,
    
    public String getFileExportUrl(String name, FileSystemItem file)
    {
-      return getApplicationURL(EXPORT_SCOPE) + "?" +
+      return getApplicationURL(EXPORT_SCOPE) + "/" + URL.encodePathSegment(name) + "?" +
          "name=" + URL.encodeQueryString(name) + "&" +
          "file=" + URL.encodeQueryString(file.getPath());
    }
@@ -707,7 +707,7 @@ public String getFileExportUrl(String name,
       }
          
       // return url
-      return getApplicationURL(EXPORT_SCOPE) + "?" +
+      return getApplicationURL(EXPORT_SCOPE) + "/" + URL.encodePathSegment(name) + "?" +
         "name=" + URL.encodeQueryString(name) + "&" +
         "parent=" + URL.encodeQueryString(parentDirectory.getPath()) + "&" +
          files.toString();

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/CodeSearchSuggestion.java
Patch:
@@ -17,7 +17,7 @@ class CodeSearchSuggestion implements Suggestion
    public CodeSearchSuggestion(RFileItem fileItem)
    {
       navigationTarget_ = new CodeNavigationTarget(
-                     fileItem.getDirectory() + "/" + fileItem.getFilename());
+                                    fileItem.getProjectRelativePath());
       matchedString_ = fileItem.getFilename();
             
       // compute display string

File: src/gwt/src/org/rstudio/studio/client/workbench/codesearch/ui/CodeSearchWidget.java
Patch:
@@ -9,6 +9,7 @@
 import org.rstudio.studio.client.workbench.codesearch.CodeSearchOracle;
 import org.rstudio.studio.client.workbench.commands.Commands;
 
+import com.google.gwt.user.client.ui.SuggestBox;
 import com.google.inject.Inject;
 
 
@@ -21,7 +22,7 @@ public CodeSearchWidget(CodeSearchOracle oracle,
    {
       super(oracle, 
             new TextBoxWithCue("Go to function/file"), 
-            new CodeSearchSuggestionDisplay());
+            new SuggestBox.DefaultSuggestionDisplay());
       
       oracle_ = oracle;   
       

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -183,6 +183,7 @@ protected boolean hasChanged()
    @Override
    protected void onLoad()
    {
+      super.onLoad();
       deferredSaveWidthPercent();
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/WorkbenchScreen.java
Patch:
@@ -231,6 +231,7 @@ public void onResize()
    @Override
    protected void onLoad()
    {
+      super.onLoad();
       eventBus_.fireEvent(new WorkbenchLoadedEvent());
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/dialog/CommitDetail.java
Patch:
@@ -26,7 +26,7 @@
 
 public class CommitDetail extends Composite implements CommitDetailDisplay
 {
-   interface Resources extends ClientBundle
+   interface Resources 
    {
       Styles styles();
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/frame/VCSPopup.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.dom.client.ClickEvent;
 import com.google.gwt.event.dom.client.ClickHandler;
+import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.resources.client.ImageResource.ImageOptions;
 import com.google.gwt.resources.client.ImageResource.RepeatStyle;
@@ -31,7 +32,7 @@
 
 public class VCSPopup
 {
-   interface Resources extends NineUpBorder.Resources
+   interface Resources extends NineUpBorder.Resources, ClientBundle
    {
       @Override
       @Source("../../../../../../core/client/widget/NineUpBorder.css")

File: src/gwt/src/org/rstudio/studio/client/common/r/RToken.java
Patch:
@@ -94,6 +94,7 @@ public boolean equals(Object obj)
    public static final int ERROR          = 0x1007 ;
    public static final int LDBRACKET      = 0x1008 ; // [[
    public static final int RDBRACKET      = 0x1009 ; // ]]
+   public static final int COMMENT        = 0x100A ;
 
    private final int tokenType_ ;
    private final String content_ ;

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RProjectType.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * RDataType.java
+ * RProjectType.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/projects/model/RProjectConfig.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * OpenProjectError.java
+ * RProjectConfig.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/projects/Projects.java
Patch:
@@ -232,7 +232,8 @@ public void onReadyToQuit(final boolean saveChanges)
             fileDialogs_.openFile(
                "Open Project", 
                fsContext_, 
-               FileSystemItem.home(),
+               FileSystemItem.createDir(
+                     pUIPrefs_.get().defaultProjectLocation().getValue()),
                "R Projects (*.Rproj)",
                new ProgressOperationWithInput<FileSystemItem>() 
                {

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/RProjectType.java
Patch:
@@ -20,7 +20,7 @@ public class RProjectType extends FileType
 {
    RProjectType()
    {
-      super("r_project");
+      super("r_proj");
    }
 
    @Override

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PaneLayoutPreferencesPane.java
Patch:
@@ -172,7 +172,7 @@ public PaneLayoutPreferencesPane(PreferencesDialogResources res,
       }
 
       PaneConfig value = uiPrefs.paneConfig().getValue();
-      if (value == null || !value.isValid())
+      if (value == null || !value.validateAndAutoCorrect())
          uiPrefs.paneConfig().setValue(PaneConfig.createDefault(), false);
 
       JsArrayString origPanes = uiPrefs.paneConfig().getValue().getPanes();

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/PaneManager.java
Patch:
@@ -201,7 +201,7 @@ private PaneConfig validateConfig(PaneConfig config)
    {
       if (config == null)
          config = PaneConfig.createDefault();
-      if (!config.isValid())
+      if (!config.validateAndAutoCorrect())
       {
          Debug.log("Pane config is not valid");
          config = PaneConfig.createDefault();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/console/ConsoleBarView.java
Patch:
@@ -18,6 +18,7 @@
 import com.google.gwt.event.dom.client.HasKeyDownHandlers;
 import com.google.gwt.event.dom.client.KeyDownHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
+import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.resources.client.ImageResource.ImageOptions;
 import com.google.gwt.resources.client.ImageResource.RepeatStyle;
@@ -39,7 +40,7 @@ public class ConsoleBarView extends Composite
    interface MyBinder extends UiBinder<Widget, ConsoleBarView>
    {}
 
-   interface Resources extends LeftCenterRightBorder.Resources
+   interface Resources extends LeftCenterRightBorder.Resources, ClientBundle
    {
       ImageResource chevronUp();
       ImageResource chevronDown();

File: src/gwt/src/org/rstudio/studio/client/projects/events/OpenProjectErrorEvent.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * OpenProjectFileEvent.java
+ * OpenProjectErrorEvent.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/projects/events/OpenProjectErrorHandler.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * OpenProjectFileHandler.java
+ * OpenProjectErrorHandler.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/projects/events/SwitchToProjectEvent.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * SwitchToProjectEvent
+ * SwitchToProjectEvent.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/model/WarningBarMessage.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * SessionSerializationAction.java
+ * WarningBarMessage.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/ProjectsPrefs.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * HistoryPrefs.java
+ * ProjectsPrefs.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/vcs/history/CommitInfo.java
Patch:
@@ -22,7 +22,7 @@ public native final String getSubject() /*-{
 
    public final Date getDate()
    {
-      return new Date((long) getDateRaw());
+      return new Date((long) getDateRaw() * 1000);
    }
 
    public native final double getDateRaw() /*-{

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -69,6 +69,7 @@ public interface ThemeStyles extends CssResource
    String toolbarSeparator();
 
    String toolbarButtonMenu();
+   String toolbarButtonMenuOnly();
    String toolbarButtonLabel();
    String toolbarButtonLeftImage();
    String toolbarButtonRightImage();

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarButton.java
Patch:
@@ -90,6 +90,7 @@ public ToolbarButton(ToolbarPopupMenu menu, String tooltipText)
       addMenuHandlers(menu);
       
       addStyleName(styles_.toolbarButtonMenu());
+      addStyleName(styles_.toolbarButtonMenuOnly());
    }
     
    public ToolbarButton(String text, 

File: src/gwt/src/org/rstudio/core/client/widget/IsWidgetAdapter.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * WidgetableAdapter.java
+ * IsWidgetAdapter.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/core/client/widget/IsWidgetWithHeight.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * WidgetableWithHeight.java
+ * IsWidgetWithHeight.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/PlainTextFileType.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * TextFileType.java
+ * PlainTextFileType.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenProjectFileEvent.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * OpenDataFileEvent.java
+ * OpenProjectFileEvent.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/events/OpenProjectFileHandler.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * OpenDataFileHandler.java
+ * OpenProjectFileHandler.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/com/google/gwt/user/client/ui/MenuBar.java
Patch:
@@ -743,7 +743,8 @@ public void selectItem(MenuItem item) {
         }
       }
 
-      if (shownChildMenu != null
+      if (vertical
+          && shownChildMenu != null
           && shownChildMenu == selectedItem.getSubMenu())
       {
         shownChildMenu.onHide(false);

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileIconResources.java
Patch:
@@ -28,6 +28,7 @@ public interface FileIconResources extends ClientBundle
    ImageResource iconPdf();
    ImageResource iconPng();
    ImageResource iconRdata();
+   ImageResource iconRproject();
    ImageResource iconRdoc();
    ImageResource iconRhistory();
    ImageResource iconRprofile();

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -56,6 +56,8 @@ public class FileTypeRegistry
                           false, false, false, false, true);
 
    public static final RDataType RDATA = new RDataType();
+   
+   public static final RProjectType RPROJECT = new RProjectType();
 
    public static final DataFrameType DATAFRAME = new DataFrameType();
    public static final UrlContentType URLCONTENT = new UrlContentType();
@@ -93,6 +95,7 @@ public FileTypeRegistry(EventBus eventBus)
       register("*.rd", RD, icons.iconRd());
       register("*.rdata", RDATA, icons.iconRdata());
       register("*.rda", RDATA, icons.iconRdata());
+      register("*.rproject", RPROJECT, icons.iconRproject());
       defaultType_ = BROWSER;
 
       registerIcon(".jpg", icons.iconPng());

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/UnsavedChangesCellTableResources.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * PackagesCellTableResources.java
+ * UnsavedChangesCellTableResources.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/core/client/theme/res/ThemeStyles.java
Patch:
@@ -72,6 +72,7 @@ public interface ThemeStyles extends CssResource
    String toolbarSeparator();
 
    String toolbarButtonMenu();
+   String toolbarButtonMenuOnly();
    String toolbarButtonLabel();
    String toolbarButtonLeftImage();
    String toolbarButtonRightImage();

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarButton.java
Patch:
@@ -90,6 +90,7 @@ public ToolbarButton(ToolbarPopupMenu menu, String tooltipText)
       addMenuHandlers(menu);
       
       addStyleName(styles_.toolbarButtonMenu());
+      addStyleName(styles_.toolbarButtonMenuOnly());
    }
     
    public ToolbarButton(String text, 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -33,7 +33,7 @@ public PrefValue<Boolean> showLineNumbers()
 
    public PrefValue<Boolean> highlightSelectedWord()
    {
-      return bool("highlight_selected_word", false);
+      return bool("highlight_selected_word", true);
    }
 
    public PrefValue<Boolean> highlightSelectedLine()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -33,7 +33,7 @@ public PrefValue<Boolean> showLineNumbers()
 
    public PrefValue<Boolean> highlightSelectedWord()
    {
-      return bool("highlight_selected_word", true);
+      return bool("highlight_selected_word", false);
    }
 
    public PrefValue<Boolean> highlightSelectedLine()

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -37,6 +37,7 @@ public EditingPreferencesPane(SourceServerOperations server,
       prefs_ = prefs;
       res_ = res;
 
+      add(checkboxPref("Highlight selected word", prefs.highlightSelectedWord()));
       add(checkboxPref("Highlight selected line", prefs.highlightSelectedLine()));
       add(checkboxPref("Show line numbers", prefs.showLineNumbers()));
       add(tight(spacesForTab_ = checkboxPref("Insert spaces for tab", prefs.useSpacesForTab())));

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcRequest.java
Patch:
@@ -141,8 +141,7 @@ public void onResponseReceived(Request request,
                   // override error message for status code 0
                   if (status == 0)
                   {
-                     message = "Unable to reach RStudio server " +
-                                "(Internet connection may be offline)";
+                     message = "Unable to establish connection with R session"; 
                   }
                   
                  

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/ChooseMirrorDialog.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * ChooseCRANMirrorDialog.java
+ * ChooseMirrorDialog.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/common/mirrors/model/MirrorsServerOperations.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * CRANServerOperations.java
+ * MirrorsServerOperations.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/PackagesPrefs.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * HistoryPrefs.java
+ * PackagesPrefs.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/core/client/IntervalTracker.java
Patch:
@@ -28,8 +28,8 @@ public void reset()
 
    public boolean hasElapsed()
    {
-      return lastTime_ != null
-             && System.currentTimeMillis() - lastTime_ < threshold_;
+      return lastTime_ == null
+             || System.currentTimeMillis() - lastTime_ >= threshold_;
    }
 
    private Long lastTime_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -1447,7 +1447,7 @@ public void execute()
 
    public void checkForExternalEdit()
    {
-      if (externalEditCheckInterval_.hasElapsed())
+      if (!externalEditCheckInterval_.hasElapsed())
          return;
       externalEditCheckInterval_.reset();
 

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/GeneralPrefs.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * RPrefs.java
+ * GeneralPrefs.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/model/ConsoleResetHistory.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * ConsolePrompt.java
+ * ConsoleResetHistory.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/ExportPlotResources.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * ExportPlotDialogResources.java
+ * ExportPlotResources.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/ExportPlotSizeEditor.java
Patch:
@@ -1,5 +1,5 @@
 /*
-t * ResizableImagePreview.java
+ * ExportPlotSizeEditor.java
  *
  * Copyright (C) 2009-11 by RStudio, Inc.
  *

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/ShellPane.java
Patch:
@@ -132,7 +132,7 @@ public void consoleWriteOutput(String output)
 
    public void consoleWriteInput(String input)
    {
-      output(input, styles_.input() + KEYWORD_CLASS_NAME, false);
+      output(input, styles_.command() + KEYWORD_CLASS_NAME, false);
       scrollToBottomAsync();
    }
 

File: src/gwt/src/org/rstudio/core/client/dom/DomUtils.java
Patch:
@@ -337,6 +337,9 @@ public static native void ensureVisibleVert(
          child = child.offsetParent ;
       }
 
+      if (!child)
+         return;
+
       // padding
       top -= padding;
       height += padding*2;

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/HistoryPrefs.java
Patch:
@@ -39,7 +39,7 @@ public native final boolean getUseGlobal() /*-{
    
    public native final boolean getRemoveDuplicates() /*-{
       if (this.remove_duplicates === undefined)
-         return true;
+         return false;
       else
          return this.remove_duplicates;
    }-*/;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/editor/InputEditorDisplay.java
Patch:
@@ -24,7 +24,7 @@ public interface InputEditorDisplay extends HasAllFocusHandlers,
    void setText(String string) ;
    boolean hasSelection() ;
    InputEditorSelection getSelection() ;
-   void beginSetSelection(InputEditorSelection selection, Command callback) ;
+   void setSelection(InputEditorSelection selection) ;
    Rectangle getCursorBounds() ;
    Rectangle getBounds() ;
    void setFocus(boolean focused) ;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/model/PlotsServerOperations.java
Patch:
@@ -42,8 +42,9 @@ void setManipulatorValues(JSONObject values,
    void locatorCompleted(Point point, 
                         ServerRequestCallback<Void> requestCallback);
 
-   void getPlotExportContext(
-                  ServerRequestCallback<PlotExportContext> requestCallback);
+   void getSavePlotContext(
+                  String directory,
+                  ServerRequestCallback<SavePlotContext> requestCallback);
    
    void exportPlot(FileSystemItem file,
                    int width,

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/model/SavePlotFormat.java
Patch:
@@ -2,9 +2,9 @@
 
 import com.google.gwt.core.client.JavaScriptObject;
 
-public class PlotExportFormat extends JavaScriptObject
+public class SavePlotFormat extends JavaScriptObject
 {  
-   protected PlotExportFormat()
+   protected SavePlotFormat()
    {
    }
    

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/export/SavePlotAsImageDialog.java
Patch:
@@ -8,7 +8,7 @@
 import org.rstudio.studio.client.common.GlobalDisplay;
 import org.rstudio.studio.client.server.VoidServerRequestCallback;
 import org.rstudio.studio.client.workbench.views.plots.model.ExportPlotOptions;
-import org.rstudio.studio.client.workbench.views.plots.model.PlotExportContext;
+import org.rstudio.studio.client.workbench.views.plots.model.SavePlotContext;
 import org.rstudio.studio.client.workbench.views.plots.model.PlotsServerOperations;
 
 import com.google.gwt.event.dom.client.ClickEvent;
@@ -21,7 +21,7 @@ public class SavePlotAsImageDialog extends ExportPlotDialog
    public SavePlotAsImageDialog(
                            GlobalDisplay globalDisplay,
                            PlotsServerOperations server,
-                           PlotExportContext context, 
+                           SavePlotContext context, 
                            final ExportPlotOptions options,
                            final OperationWithInput<ExportPlotOptions> onClose)
    {

File: src/gwt/src/org/rstudio/core/client/widget/ResizeGripper.java
Patch:
@@ -56,6 +56,9 @@ public int getImageHeight()
    @Override
    public void onBrowserEvent(Event event) 
    {
+      event.preventDefault();
+      event.stopPropagation();
+
       final int eventType = DOM.eventGetType(event);
       
       if (Event.ONMOUSEDOWN == eventType)

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/ui/InstallPackageDialog.java
Patch:
@@ -47,7 +47,7 @@ public InstallPackageDialog(
                            GlobalDisplay globalDisplay,
                            OperationWithInput<PackageInstallRequest> operation)
 {
-      super("Install Package from CRAN", operation);
+      super("Install Package", operation);
       
       installContext_ = installContext;
       defaultInstallOptions_ = defaultInstallOptions;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/packages/model/PackagesServerOperations.java
Patch:
@@ -27,6 +27,8 @@ void availablePackages(
          String repository,
          ServerRequestCallback<JsArrayString> requestCallback);
    
+   void getDefaultLibrary(ServerRequestCallback<String> requestCallback);
+   
    // load a package
    void loadPackage(String packageName,
                     ServerRequestCallback<Void> requestCallback);

File: src/gwt/src/org/rstudio/studio/client/common/NotifyingSplitLayoutPanel.java
Patch:
@@ -20,9 +20,9 @@
 public class NotifyingSplitLayoutPanel extends SplitLayoutPanel
 {
    @Inject
-   public NotifyingSplitLayoutPanel(EventBus events)
+   public NotifyingSplitLayoutPanel(int splitterSize, EventBus events)
    {
-      super();
+      super(splitterSize);
 
       events_ = events;
 

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -101,7 +101,7 @@ public static boolean equals(State a, State b)
    public MainSplitPanel(EventBus events,
                          Session session)
    {
-      super(events);
+      super(3, events);
       session_ = session;
       addSplitterResizedHandler(this);
    }

File: src/gwt/src/com/google/gwt/user/client/ui/SplitLayoutPanel.java
Patch:
@@ -15,11 +15,11 @@
  */
 package com.google.gwt.user.client.ui;
 
+import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.dom.client.Document;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.Event;
 
 /**
@@ -173,7 +173,7 @@ public void execute() {
             forceLayout();
           }
         };
-        DeferredCommand.addCommand(layoutCommand);
+        Scheduler.get().scheduleDeferred(layoutCommand);
       }
     }
   }

File: src/gwt/src/org/rstudio/core/client/files/filedialog/DirectoryContentsWidget.java
Patch:
@@ -332,12 +332,12 @@ private int addItem(FileSystemItem item,
    public Point getScrollPosition()
    {
       return new Point(scrollPanel_.getHorizontalScrollPosition(),
-                       scrollPanel_.getScrollPosition());
+                       scrollPanel_.getVerticalScrollPosition());
    }
 
    public void setScrollPosition(Point p)
    {
-      scrollPanel_.setScrollPosition(p.getY());
+      scrollPanel_.setVerticalScrollPosition(p.getY());
       scrollPanel_.setHorizontalScrollPosition(p.getX());
    }
 

File: src/gwt/src/org/rstudio/core/client/layout/BinarySplitLayoutPanel.java
Patch:
@@ -12,12 +12,12 @@
  */
 package org.rstudio.core.client.layout;
 
+import com.google.gwt.core.client.Scheduler;
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.dom.client.Style;
 import com.google.gwt.event.dom.client.*;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.layout.client.Layout;
-import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.Event;
 import com.google.gwt.user.client.ui.*;
 
@@ -71,7 +71,7 @@ public void setWidgets(Widget[] widgets)
    protected void onAttach()
    {
       super.onAttach();
-      DeferredCommand.addCommand(new Command()
+      Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          public void execute()
          {

File: src/gwt/src/org/rstudio/core/client/layout/DualWindowLayoutPanel.java
Patch:
@@ -15,8 +15,6 @@
 import com.google.gwt.core.client.JavaScriptObject;
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.ScheduledCommand;
-import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.Window;
 import com.google.gwt.user.client.ui.*;
 import org.rstudio.core.client.Debug;
@@ -130,7 +128,7 @@ public void onWindowStateChange(WindowStateChangeEvent event)
          }
 
          // Defer this because layout changes are deferred by LayoutPanel.
-         DeferredCommand.addCommand(new Command()
+         Scheduler.get().scheduleDeferred(new ScheduledCommand()
          {
             public void execute()
             {

File: src/gwt/src/org/rstudio/core/client/widget/BottomScrollPanel.java
Patch:
@@ -29,7 +29,7 @@ public BottomScrollPanel()
       {
          public void onScroll(ScrollEvent event)
          {
-            scrolledToBottom_ = getScrollPosition() + getOffsetHeight()
+            scrolledToBottom_ = getVerticalScrollPosition() + getOffsetHeight()
                 == getElement().getScrollHeight();
          }
       });

File: src/gwt/src/org/rstudio/core/client/widget/ImageFrame.java
Patch:
@@ -13,9 +13,7 @@
 package org.rstudio.core.client.widget;
 
 import com.google.gwt.dom.client.Element;
-import com.google.gwt.user.client.Command;
 import com.google.gwt.user.client.DOM;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.Timer;
 import com.google.gwt.user.client.ui.Frame;
 

File: src/gwt/src/org/rstudio/core/client/widget/SlideLabel.java
Patch:
@@ -14,14 +14,15 @@
 
 import com.google.gwt.animation.client.Animation;
 import com.google.gwt.core.client.GWT;
+import com.google.gwt.core.client.Scheduler;
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.dom.client.*;
 import com.google.gwt.resources.client.ClientBundle;
 import com.google.gwt.resources.client.CssResource;
 import com.google.gwt.resources.client.DataResource;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
 import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.Timer;
 import com.google.gwt.user.client.ui.LayoutPanel;
 import com.google.gwt.user.client.ui.Widget;
@@ -157,7 +158,7 @@ public void show(final int autoHideMillis, final Command executeOnComplete)
             "Possible error: executeOnComplete will never be called with " +
             "negative value for autoHideMillis";
 
-      DeferredCommand.addCommand(new Command()
+      Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          public void execute()
          {

File: src/gwt/src/org/rstudio/core/client/widget/ToolbarPopupMenu.java
Patch:
@@ -12,8 +12,9 @@
  */
 package org.rstudio.core.client.widget;
 
+import com.google.gwt.core.client.Scheduler;
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.ui.MenuItem;
 import org.rstudio.core.client.command.AppMenuItem;
 import org.rstudio.core.client.command.BaseMenuBar;
@@ -86,7 +87,7 @@ public ToolbarPopupMenuCommand(Command coreCommand)
       }
       public void execute()
       {
-         DeferredCommand.addCommand(coreCommand_);
+         Scheduler.get().scheduleDeferred(coreCommand_);
          hide();
       }
    

File: src/gwt/src/org/rstudio/core/rebind/StaticDataResourceGenerator.java
Patch:
@@ -45,7 +45,7 @@ public String createAssignment(TreeLogger logger, ResourceContext context,
     }
 
     URL resource = resources[0];
-    String outputUrlExpression = context.deploy(resource, true);
+    String outputUrlExpression = context.deploy(resource, null, true);
 
     SourceWriter sw = new StringSourceWriter();
     // Write the expression to create the subtype.

File: src/gwt/src/org/rstudio/studio/client/application/ui/RequestLogVisualization.java
Patch:
@@ -12,6 +12,8 @@
  */
 package org.rstudio.studio.client.application.ui;
 
+import com.google.gwt.core.client.Scheduler;
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.dom.client.Style.Cursor;
 import com.google.gwt.dom.client.Style.FontWeight;
 import com.google.gwt.dom.client.Style.Overflow;
@@ -23,8 +25,6 @@
 import com.google.gwt.event.logical.shared.CloseHandler;
 import com.google.gwt.event.logical.shared.HasCloseHandlers;
 import com.google.gwt.event.shared.HandlerRegistration;
-import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.Event;
 import com.google.gwt.user.client.Event.NativePreviewEvent;
 import com.google.gwt.user.client.Event.NativePreviewHandler;
@@ -177,7 +177,7 @@ private void refresh(boolean reloadEntries, boolean scrollToEnd)
    protected void onLoad()
    {
       super.onLoad();
-      DeferredCommand.addCommand(new Command()
+      Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          public void execute()
          {

File: src/gwt/src/org/rstudio/studio/client/common/impl/DesktopFileDialogs.java
Patch:
@@ -12,8 +12,8 @@
  */
 package org.rstudio.studio.client.common.impl;
 
-import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
+import com.google.gwt.core.client.Scheduler;
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import org.rstudio.core.client.StringUtil;
 import org.rstudio.core.client.files.FileSystemContext;
 import org.rstudio.core.client.files.FileSystemItem;
@@ -58,7 +58,7 @@ public void execute(
                             ? fsContext.pwd()
                             : initialFilePath.getPath();
 
-         DeferredCommand.addCommand(new Command()
+         Scheduler.get().scheduleDeferred(new ScheduledCommand()
          {
             public void execute()
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/ui/MainSplitPanel.java
Patch:
@@ -16,7 +16,6 @@
 import com.google.gwt.core.client.Scheduler;
 import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.Window;
 import com.google.gwt.user.client.ui.SplitterResizedEvent;
 import com.google.gwt.user.client.ui.SplitterResizedHandler;
@@ -207,7 +206,7 @@ && layoutData.size > getOffsetWidth() - 3)
 
    private void deferredSaveWidthPercent()
    {
-      DeferredCommand.addCommand(new Command()
+      Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          public void execute()
          {
@@ -247,7 +246,7 @@ public void execute() {
                forceLayout();
              }
            };
-           DeferredCommand.addCommand(layoutCommand_);
+           Scheduler.get().scheduleDeferred(layoutCommand_);
          }
       }
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/impl/PlainTextEditorImplFirefox.java
Patch:
@@ -69,7 +69,7 @@ public void poll()
    {
       // This doesn't work all that well
       /*
-      DeferredCommand.addCommand(new Command()
+      Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          public void execute()
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/HelpPane.java
Patch:
@@ -13,6 +13,8 @@
 
 package org.rstudio.studio.client.workbench.views.help;
 
+import com.google.gwt.core.client.Scheduler;
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.dom.client.*;
 import com.google.gwt.dom.client.Style.Overflow;
 import com.google.gwt.dom.client.Style.Unit;
@@ -21,8 +23,6 @@
 import com.google.gwt.event.logical.shared.ResizeEvent;
 import com.google.gwt.event.logical.shared.ResizeHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
-import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.Window;
 import com.google.gwt.user.client.ui.*;
 import com.google.inject.Inject;
@@ -120,7 +120,7 @@ protected void onLoad()
 
          initHelpNavigateCallback() ;
 
-         DeferredCommand.addCommand(new Command()
+         Scheduler.get().scheduleDeferred(new ScheduledCommand()
          {
             public void execute()
             {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/search/SearchWidget.java
Patch:
@@ -13,14 +13,14 @@
 package org.rstudio.studio.client.workbench.views.help.search;
 
 import com.google.gwt.core.client.GWT;
+import com.google.gwt.core.client.Scheduler;
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.event.dom.client.*;
 import com.google.gwt.event.logical.shared.ValueChangeEvent;
 import com.google.gwt.event.logical.shared.ValueChangeHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.uibinder.client.UiBinder;
 import com.google.gwt.uibinder.client.UiField;
-import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.ui.*;
 import com.google.inject.Inject;
 import com.google.inject.name.Named;
@@ -78,7 +78,7 @@ public void onKeyDown(KeyDownEvent event)
             switch (event.getNativeKeyCode())
             {
             case KeyCodes.KEY_ENTER:
-               DeferredCommand.addCommand(new Command() {
+               Scheduler.get().scheduleDeferred(new ScheduledCommand() {
                   public void execute()
                   {
                      SelectionCommitEvent.fire(SearchWidget.this, 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryEntryItemCodec.java
Patch:
@@ -15,6 +15,7 @@
 import com.google.gwt.core.client.GWT;
 import com.google.gwt.dom.client.*;
 import com.google.gwt.i18n.client.DateTimeFormat;
+import com.google.gwt.i18n.client.DateTimeFormat.PredefinedFormat;
 import org.rstudio.core.client.BrowseCap;
 import org.rstudio.core.client.dom.DomUtils;
 import org.rstudio.core.client.widget.FastSelectTable.ItemCodec;
@@ -230,7 +231,7 @@ private String formatDate(long time)
       if (time == 0)
          return null;
       Date date = new Date(time);
-      return DateTimeFormat.getShortDateTimeFormat().format(date);
+      return DateTimeFormat.getFormat(PredefinedFormat.DATE_TIME_SHORT).format(date);
    }
 
    private final String commandClass_;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/history/view/HistoryTableWithToolbar.java
Patch:
@@ -113,9 +113,9 @@ public void highlightRows(int offset, int length)
          return;
       int height = scrollPanel_.getOffsetHeight();
       if (rect.getHeight() > height)
-         scrollPanel_.setScrollPosition(rect.getTop());
+         scrollPanel_.setVerticalScrollPosition(rect.getTop());
       else
-         scrollPanel_.setScrollPosition(
+         scrollPanel_.setVerticalScrollPosition(
                rect.getTop() - (height - rect.getHeight())/2);
    }
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/Source.java
Patch:
@@ -19,7 +19,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
 import com.google.inject.Provider;
@@ -58,9 +57,9 @@
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTarget;
 import org.rstudio.studio.client.workbench.views.source.editors.EditingTargetSource;
 import org.rstudio.studio.client.workbench.views.source.editors.data.DataEditingTarget;
+import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTarget;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.FileTypeChangedEvent;
 import org.rstudio.studio.client.workbench.views.source.editors.text.events.FileTypeChangedHandler;
-import org.rstudio.studio.client.workbench.views.source.editors.text.TextEditingTarget;
 import org.rstudio.studio.client.workbench.views.source.events.*;
 import org.rstudio.studio.client.workbench.views.source.model.ContentItem;
 import org.rstudio.studio.client.workbench.views.source.model.DataItem;
@@ -441,7 +440,7 @@ public void execute(final FileSystemItem input,
                      return;
 
                   indicator.onCompleted();
-                  DeferredCommand.addCommand(new Command()
+                  Scheduler.get().scheduleDeferred(new ScheduledCommand()
                   {
                      public void execute()
                      {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/SourcePane.java
Patch:
@@ -12,6 +12,8 @@
  */
 package org.rstudio.studio.client.workbench.views.source;
 
+import com.google.gwt.core.client.Scheduler;
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.dom.client.Style.Cursor;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.dom.client.ClickEvent;
@@ -22,8 +24,6 @@
 import com.google.gwt.event.logical.shared.SelectionHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ImageResource;
-import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.ui.*;
 import com.google.inject.Inject;
 import org.rstudio.core.client.events.*;
@@ -97,7 +97,7 @@ public void onClick(ClickEvent event)
    protected void onLoad()
    {
       super.onLoad();
-      DeferredCommand.addCommand(new Command()
+      Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          public void execute()
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/TabOverflowPopupPanel.java
Patch:
@@ -12,6 +12,8 @@
  */
 package org.rstudio.studio.client.workbench.views.source;
 
+import com.google.gwt.core.client.Scheduler;
+import com.google.gwt.core.client.Scheduler.ScheduledCommand;
 import com.google.gwt.dom.client.Style.Unit;
 import com.google.gwt.event.dom.client.KeyCodes;
 import com.google.gwt.event.dom.client.KeyDownEvent;
@@ -20,8 +22,6 @@
 import com.google.gwt.event.logical.shared.CloseHandler;
 import com.google.gwt.event.logical.shared.ValueChangeEvent;
 import com.google.gwt.event.logical.shared.ValueChangeHandler;
-import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.ui.DockPanel;
 import com.google.gwt.user.client.ui.MenuItem;
 import com.google.gwt.user.client.ui.PopupPanel;
@@ -146,7 +146,7 @@ public void onValueChange(ValueChangeEvent<String> event)
    public void show()
    {
       super.show();
-      DeferredCommand.addCommand(new Command()
+      Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          public void execute()
          {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -26,7 +26,6 @@
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.resources.client.ImageResource;
 import com.google.gwt.user.client.Command;
-import com.google.gwt.user.client.DeferredCommand;
 import com.google.gwt.user.client.ui.HasValue;
 import com.google.gwt.user.client.ui.Widget;
 import com.google.inject.Inject;
@@ -798,7 +797,7 @@ public void execute(String encoding)
    @Handler
    void onPrintSourceDoc()
    {
-      DeferredCommand.addCommand(new Command()
+      Scheduler.get().scheduleDeferred(new ScheduledCommand()
       {
          public void execute()
          {

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.studio.client.common.filetypes.NewFileMenu;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.RemoteFileSystemContext;
+import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 import org.rstudio.studio.client.workbench.views.source.DocsMenu;
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditor;
@@ -48,4 +49,5 @@ public interface RStudioGinjector extends Ginjector
    FileDialogs getFileDialogs();
    Commands getCommands();
    UIPrefs getUIPrefs();
+   Session getSession();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/EditingPreferencesPane.java
Patch:
@@ -76,7 +76,7 @@ private void setEncoding(String encoding)
    {
       encodingValue_ = encoding;
       if (StringUtil.isNullOrEmpty(encoding))
-         encoding_.setText("[Ask every time]");
+         encoding_.setText(ChooseEncodingDialog.ASK_LABEL);
       else
          encoding_.setText(encoding);
    }

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/model/UIPrefs.java
Patch:
@@ -2,6 +2,7 @@
 
 import com.google.inject.Inject;
 import com.google.inject.Singleton;
+import org.rstudio.core.client.BrowseCap;
 import org.rstudio.studio.client.workbench.model.Session;
 import org.rstudio.studio.client.workbench.ui.PaneConfig;
 
@@ -66,7 +67,7 @@ public PrefValue<Boolean> softWrapRFiles()
 
    public PrefValue<Integer> fontSize()
    {
-      return integer("font_size_points", 9);
+      return integer("font_size_points", BrowseCap.hasMetaKey() ? 9 : 10);
    }
 
    public PrefValue<String> theme()

File: src/gwt/src/org/rstudio/studio/client/RStudioGinjector.java
Patch:
@@ -24,6 +24,7 @@
 import org.rstudio.studio.client.common.filetypes.NewFileMenu;
 import org.rstudio.studio.client.workbench.commands.Commands;
 import org.rstudio.studio.client.workbench.model.RemoteFileSystemContext;
+import org.rstudio.studio.client.workbench.prefs.model.UIPrefs;
 import org.rstudio.studio.client.workbench.views.source.DocsMenu;
 import org.rstudio.studio.client.workbench.views.source.editors.text.AceEditor;
 
@@ -46,4 +47,5 @@ public interface RStudioGinjector extends Ginjector
    RemoteFileSystemContext getRemoteFileSystemContext();
    FileDialogs getFileDialogs();
    Commands getCommands();
+   UIPrefs getUIPrefs();
 }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/model/SourceServerOperations.java
Patch:
@@ -38,6 +38,7 @@ public interface SourceServerOperations
     * have never been saved.
     */
    void newDocument(String fileType,
+                    String encoding,
                     JsObject properties,
                     ServerRequestCallback<SourceDocument> requestCallback);
 

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/Help.java
Patch:
@@ -132,7 +132,7 @@ public void onClearHelpHistory()
 
    public void onShowHelp(ShowHelpEvent event)
    {
-      view_.showHelp(server_.getHelpUrl(event.getTopicUrl()));
+      view_.showHelp(server_.getApplicationURL(event.getTopicUrl()));
       view_.bringToFront();
    }
 
@@ -204,8 +204,8 @@ public void onResponseReceived(LinksList linksList)
 
    private void home()
    {
-      String url = "doc/html/index.html" ;
-      view_.showHelp(server_.getHelpUrl(url));
+      String url = "help/doc/html/index.html" ;
+      view_.showHelp(server_.getApplicationURL(url));
    }
    
    public Display getDisplay()

File: src/gwt/src/org/rstudio/studio/client/workbench/views/help/model/HelpServerOperations.java
Patch:
@@ -54,7 +54,7 @@ void getHelp(String topic,
                 int options,
                 ServerRequestCallback<HelpInfo> requestCallback);
    
-   String getHelpUrl(String topicURI);
+   String getApplicationURL(String topicURI);
 
    void showHelpTopic(String topic, String pkgName) ;
 

File: src/gwt/src/org/rstudio/core/client/layout/LogicalWindow.java
Patch:
@@ -37,6 +37,9 @@ public LogicalWindow(WindowFrame normal,
    {
       normal_ = normal;
       minimized_ = minimized;
+
+      normal_.addWindowStateChangeHandler(this);
+      minimized_.addWindowStateChangeHandler(this);
    }
 
    public WindowFrame getNormal()

File: src/gwt/src/org/rstudio/core/client/theme/ModuleTabLayoutPanel.java
Patch:
@@ -20,6 +20,7 @@
 import com.google.gwt.event.dom.client.MouseDownHandler;
 import com.google.gwt.event.shared.HandlerRegistration;
 import com.google.gwt.user.client.ui.*;
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.events.WindowStateChangeEvent;
 import org.rstudio.core.client.layout.WindowState;
 import org.rstudio.core.client.theme.res.ThemeResources;
@@ -129,7 +130,7 @@ public void add(Widget child, String text, boolean asHtml)
    @Override
    public void selectTab(int index)
    {
-      super.selectTab(index);
+      super.selectTab(Math.max(0, Math.min(index, getWidgetCount() - 1)));
       if (index == 0)
          owner_.addStyleName(styles_.firstTabSelected());
       else

File: src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/PaneLayoutPreferencesPane.java
Patch:
@@ -173,7 +173,7 @@ public PaneLayoutPreferencesPane(PreferencesDialogResources res,
       }
 
       PaneConfig value = uiPrefs.paneConfig().getValue();
-      if (value == null || value.isValid())
+      if (value == null || !value.isValid())
          uiPrefs.paneConfig().setValue(PaneConfig.createDefault());
 
       JsArrayString origPanes = uiPrefs.paneConfig().getValue().getPanes();

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java
Patch:
@@ -130,6 +130,8 @@ public interface DocDisplay extends HasValueChangeHandlers<Void>,
       void onActivate();
 
       void setFontSize(Size size);
+
+      void onVisibilityChanged(boolean visible);
    }
    private class ExplicitSaveProgressIndicator implements ProgressIndicator
    {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/plots/ui/manipulator/ManipulatorPopupPanel.java
Patch:
@@ -71,21 +71,21 @@ public void update(Manipulator manipulator)
                   Manipulator.Slider slider = control.cast();
                   addedControl = addSliderControl(
                                           variable, 
-                                          manipulator.getDoubleValue(variable), 
+                                          slider.getInitialValue(), 
                                           slider);
                   break;
                case Manipulator.Control.PICKER:
                   Manipulator.Picker picker = control.cast();
                   addedControl = addPickerControl(
                                           variable, 
-                                          manipulator.getStringValue(variable), 
+                                          picker.getInitialValue(), 
                                           picker);
                   break;
                case Manipulator.Control.CHECKBOX:
                   Manipulator.CheckBox checkBox = control.cast();
                   addedControl = addCheckBoxControl(
                                           variable, 
-                                          manipulator.getBooleanValue(variable),
+                                          checkBox.getInitialValue(),
                                           checkBox);
                   break;
                }

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -101,7 +101,8 @@ public void onActivate()
 
    public void setCode(String code)
    {
-      initToEmptyString_ = StringUtil.notNull(code).length() == 0;
+      code = StringUtil.notNull(code);
+      initToEmptyString_ = code.length() == 0;
       editor_.getSession().setValue(code);
    }
 

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -84,6 +84,7 @@ public FileTypeRegistry(EventBus eventBus)
       register("*.latex", TEX, icons.iconTex());
       register("*.sty", TEX, icons.iconTex());
       register("*.cls", TEX, icons.iconTex());
+      register("*.bbl", TEX, icons.iconTex());
       register("*.bib", TEXT, icons.iconText());
       register("*.rd", RD, icons.iconTex());
       register("*.rdata", RDATA, icons.iconRdata());

File: src/gwt/src/org/rstudio/core/client/jsonrpc/RpcResponse.java
Patch:
@@ -22,9 +22,9 @@ protected RpcResponse()
    }
    
    public final native static RpcResponse parse(String json) /*-{
-      try 
+      try
       {
-         return eval('(' + json + ')');
+         return $wnd.JSON.parse(json);
       }
       catch( ex )
       {

File: src/gwt/src/org/rstudio/studio/client/RStudio.java
Patch:
@@ -27,6 +27,7 @@
 import org.rstudio.core.client.ExternalJavaScriptLoader;
 import org.rstudio.core.client.ExternalJavaScriptLoader.Callback;
 import org.rstudio.core.client.files.filedialog.FileDialogResources;
+import org.rstudio.core.client.jsonrpc.JSON2;
 import org.rstudio.core.client.resources.CoreResources;
 import org.rstudio.core.client.theme.res.ThemeResources;
 import org.rstudio.core.client.widget.FontSizer;
@@ -135,6 +136,8 @@ private void load(final Command dismissProgressAnimation)
       FindReplaceBar.ensureStylesInjected();
       FontSizer.ensureStylesInjected();
 
+      JSON2.ensureInjected();
+
       StyleInjector.inject(
             "button::-moz-focus-inner {border:0}");
 

File: src/gwt/src/org/rstudio/core/client/StringUtil.java
Patch:
@@ -153,7 +153,7 @@ private static String toHex(char c)
    public static String toRSymbolName(String name)
    {
       if (!name.matches("^[a-zA-Z_.][a-zA-Z0-9_.]*$")
-          || name.matches("^.[0-9]")
+          || name.matches("^.[0-9].*$")
           || isRKeyword(name))
       {
          return "`" + name + "`";

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -14,7 +14,6 @@
 import com.google.gwt.user.client.ui.RequiresResize;
 import org.rstudio.core.client.BrowseCap;
 import org.rstudio.core.client.CommandWithArg;
-import org.rstudio.core.client.events.*;
 import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.studio.client.server.Void;
 import org.rstudio.studio.client.workbench.views.source.editors.text.ace.AceEditorNative;

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java
Patch:
@@ -439,12 +439,12 @@ public int getSelectionOffset(boolean start)
 
    public void updateBodyMinHeight()
    {
-      //To change body of implemented methods use File | Settings | File Templates.
+      widget_.onResize();
    }
 
    public void setFontSize(Size size)
    {
-      //To change body of implemented methods use File | Settings | File Templates.
+      // No change needed--the AceEditorWidget uses the "normalSize" style 
    }
 
    public HandlerRegistration addValueChangeHandler(

File: src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditorWidget.java
Patch:
@@ -17,6 +17,7 @@
 import com.google.gwt.user.client.ui.RequiresResize;
 import org.rstudio.core.client.CommandWithArg;
 import org.rstudio.core.client.events.*;
+import org.rstudio.core.client.widget.FontSizer;
 import org.rstudio.studio.client.server.Void;
 
 public class AceEditorWidget extends Composite
@@ -41,6 +42,7 @@ protected AceEditorWidget(JavaScriptObject environment)
       env_ = environment;
 
       initWidget(new HTML());
+      FontSizer.applyNormalFontSize(this);
       setSize("100%", "100%");
    }
 

File: src/gwt/src/org/rstudio/core/client/widget/HtmlFormModalDialog.java
Patch:
@@ -60,8 +60,7 @@ public void execute()
                            StringUtil.notNull(e.getDescription()).trim()))
                      {
                         progressIndicator.onError(
-                              "For security reasons, you must click the " +
-                              "Browse button and choose your file.");
+                              "Please use a complete file path.");
                      }
                      else
                      {

File: src/gwt/src/org/rstudio/studio/client/workbench/views/files/Files.java
Patch:
@@ -249,8 +249,6 @@ public void execute(String input,
 
    void onUploadFile()
    {
-      if (currentPath_ != null)
-         fileSystemContext_.cd(currentPath_.getPath());
       pFilesUpload_.get().execute(currentPath_, fileSystemContext_);
    }
    

File: src/gwt/src/org/rstudio/core/client/dom/impl/NodeRelativePosition.java
Patch:
@@ -120,9 +120,9 @@ private static NodeRelativePosition toPositionHelper(Node here,
             String tagName = el.getTagName().toLowerCase();
             if (tagName.equals("br"))
             {
-               counter[0] -= 1;
                if (counter[0] <= 0)
                   return new NodeRelativePosition(here, 0);
+               counter[0] -= 1;
                return null;
             }
             else if (tagName.equals("script") || tagName.equals("style"))

File: src/gwt/src/org/rstudio/core/client/TimeBufferedCommand.java
Patch:
@@ -125,9 +125,9 @@ private final void execute(final boolean passive, int millisAgo)
             // if we're in the passive chain of execution, then reschedule.
             if (passive)
             {
-               long gap = passiveIntervalMillis_ - millisSinceLast;
+               int gap = passiveIntervalMillis_ - (int)millisSinceLast;
                gap = Math.max(1, gap); // a non-positive value will cause error
-               scheduleExecution(true, (int) gap);
+               scheduleExecution(true, gap);
             }
             return;
          }

File: src/gwt/src/org/rstudio/studio/client/common/DefaultGlobalDisplay.java
Patch:
@@ -146,6 +146,7 @@ public void onCompleted()
 
          public void onError(String message)
          {
+            dismissProgress();
             showMessage(GlobalDisplay.MSG_ERROR, errorCaption, message);
          }
 

File: src/gwt/src/org/rstudio/core/client/dom/impl/DomUtilsStandardImpl.java
Patch:
@@ -36,8 +36,7 @@ public void focus(Element element, boolean alwaysDriveSelection)
          Range range = Range.create(doc) ;
          range.selectNodeContents(el) ;
          Selection sel = Selection.get(NativeWindow.get(doc)) ;
-         sel.removeAllRanges() ;
-         sel.addRange(range) ;
+         sel.setRange(range);
       }
 
       NativeWindow.get().focus();

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -30,6 +30,7 @@
 import com.google.inject.Provider;
 import com.google.inject.Singleton;
 import org.rstudio.core.client.CsvWriter;
+import org.rstudio.core.client.Debug;
 import org.rstudio.core.client.command.CommandBinder;
 import org.rstudio.core.client.command.Handler;
 import org.rstudio.core.client.dom.DomUtils;

File: src/gwt/src/org/rstudio/studio/client/application/Application.java
Patch:
@@ -131,6 +131,7 @@ public void execute()
 
          public void onError(ServerError error)
          {
+            Debug.logError(error);
             dismissLoadingProgress.execute();
 
             globalDisplay_.showErrorMessage("RStudio Initialization Error",

File: src/gwt/src/org/rstudio/studio/client/workbench/views/console/shell/editor/impl/InterceptPasteStrategy.java
Patch:
@@ -33,7 +33,7 @@ public void initialize(PlainTextEditor editor, Element textContainer)
    }
 
    private native void hookPaste(Element el) /*-{
-      el.onpaste = thiz.@org.rstudio.studio.client.workbench.views.console.shell.editor.impl.TextareaPasteStrategy::onPaste(Lcom/google/gwt/dom/client/NativeEvent;);
+      el.onpaste = this.@org.rstudio.studio.client.workbench.views.console.shell.editor.impl.TextareaPasteStrategy::onPaste(Lcom/google/gwt/dom/client/NativeEvent;);
    }-*/;
 
    @SuppressWarnings("unused")

File: src/gwt/src/org/rstudio/studio/client/common/filetypes/FileTypeRegistry.java
Patch:
@@ -82,7 +82,7 @@ public FileTypeRegistry(EventBus eventBus)
       register("*.nw", SWEAVE, icons.iconText());
       register("*.tex", TEX, icons.iconTex());
       register("*.latex", TEX, icons.iconTex());
-      register("*.rd", TEX, icons.iconTex());
+      register("*.rd", RD, icons.iconTex());
       register("*.rdata", RDATA, icons.iconRdata());
       defaultType_ = BROWSER;
 

