File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/MessageRequestProcessor.java
Patch:
@@ -24,6 +24,7 @@
 import javax.sip.InvalidArgumentException;
 import javax.sip.RequestEvent;
 import javax.sip.SipException;
+import javax.sip.header.CSeqHeader;
 import javax.sip.header.CallIdHeader;
 import javax.sip.message.Response;
 import java.text.ParseException;
@@ -69,6 +70,7 @@ public void process(RequestEvent evt) {
 //        logger.info("接收到消息：" + evt.getRequest());
         String deviceId = SipUtils.getUserIdFromFromHeader(evt.getRequest());
         CallIdHeader callIdHeader = sipRequest.getCallIdHeader();
+        CSeqHeader cSeqHeader = sipRequest.getCSeqHeader();
         // 先从会话内查找
         SsrcTransaction ssrcTransaction = sessionManager.getSsrcTransactionByCallId(callIdHeader.getCallId());
         // 兼容海康 媒体通知 消息from字段不是设备ID的问题
@@ -94,7 +96,7 @@ public void process(RequestEvent evt) {
                 // 不存在则回复404
                 responseAck(request, Response.NOT_FOUND, "device "+ deviceId +" not found");
                 log.warn("[设备未找到 ]deviceId: {}, callId: {}", deviceId, callIdHeader.getCallId());
-                SipEvent sipEvent = sipSubscribe.getSubscribe(callIdHeader.getCallId());
+                SipEvent sipEvent = sipSubscribe.getSubscribe(callIdHeader.getCallId() + cSeqHeader.getSeqNumber());
                 if (sipEvent != null && sipEvent.getErrorEvent() != null){
                     DeviceNotFoundEvent deviceNotFoundEvent = new DeviceNotFoundEvent(evt.getDialog());
                     deviceNotFoundEvent.setCallId(callIdHeader.getCallId());

File: src/main/java/com/genersoft/iot/vmp/service/impl/LogServiceImpl.java
Patch:
@@ -24,7 +24,7 @@ public class LogServiceImpl implements ILogService {
     @Override
     public List<LogFileInfo> queryList(String query, String startTime, String endTime) {
         File logFile = getLogDir();
-        if (logFile == null && !logFile.exists()) {
+        if (logFile == null || !logFile.exists()) {
             throw new ControllerException(ErrorCode.ERROR100.getCode(), "获取日志文件目录失败");
         }
         File[] files = logFile.listFiles();

File: src/main/java/com/genersoft/iot/vmp/gb28181/dao/CommonGBChannelMapper.java
Patch:
@@ -152,7 +152,7 @@ public interface CommonGBChannelMapper {
             " SET gb_status = #{status}" +
             " WHERE id = #{gbId}"+
             " </script>"})
-    int updateStatusById(@Param("gbId") int gbId, @Param("status") int status);
+    int updateStatusById(@Param("gbId") int gbId, @Param("status") String status);
 
     @Update("<script> " +
             "<foreach collection='commonGBChannels' index='index' item='item' separator=';'> " +

File: src/main/java/com/genersoft/iot/vmp/gb28181/service/impl/GbChannelServiceImpl.java
Patch:
@@ -131,7 +131,7 @@ public int offline(CommonGBChannel commonGBChannel) {
             log.warn("[通道离线] 未找到数据库ID，更新失败， {}({})", commonGBChannel.getGbName(), commonGBChannel.getGbDeviceId());
             return 0;
         }
-        int result = commonGBChannelMapper.updateStatusById(commonGBChannel.getGbId(), 0);
+        int result = commonGBChannelMapper.updateStatusById(commonGBChannel.getGbId(), "OFF");
         if (result > 0) {
             try {
                 // 发送通知
@@ -185,7 +185,7 @@ public int online(CommonGBChannel commonGBChannel) {
             log.warn("[通道上线] 未找到数据库ID，更新失败， {}({})", commonGBChannel.getGbName(), commonGBChannel.getGbDeviceId());
             return 0;
         }
-        int result = commonGBChannelMapper.updateStatusById(commonGBChannel.getGbId(), 1);
+        int result = commonGBChannelMapper.updateStatusById(commonGBChannel.getGbId(), "ON");
         if (result > 0) {
             try {
                 // 发送通知

File: src/main/java/com/genersoft/iot/vmp/conf/CivilCodeFileConf.java
Patch:
@@ -53,8 +53,8 @@ public void run(String... args) throws Exception {
             }
             inputStream = Files.newInputStream(civilCodeFile.toPath());
         }
-
-        BufferedReader inputStreamReader = new BufferedReader(new InputStreamReader(inputStream));
+      
+        BufferedReader inputStreamReader = new BufferedReader(new InputStreamReader(inputStream,"UTF-8"));
         int index = -1;
         String line;
         while ((line = inputStreamReader.readLine()) != null) {

File: src/main/java/com/genersoft/iot/vmp/conf/security/JwtUtils.java
Patch:
@@ -46,7 +46,7 @@ public class JwtUtils implements InitializingBean {
     /**
      * token过期时间(分钟)
      */
-    public static final long EXPIRATION_TIME = 30 * 24 * 60;
+    public static final long EXPIRATION_TIME = 30;
 
     private static RsaJsonWebKey rsaJsonWebKey;
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/controller/DeviceQuery.java
Patch:
@@ -269,7 +269,7 @@ public void updateChannelStreamIdentification(DeviceChannel channel){
 	@Operation(summary = "修改数据流传输模式", security = @SecurityRequirement(name = JwtUtils.HEADER))
 	@Parameter(name = "deviceId", description = "设备国标编号", required = true)
 	@Parameter(name = "streamMode", description = "数据流传输模式, 取值：" +
-			"UDP（udp传输），TCP-ACTIVE（tcp主动模式,暂不支持），TCP-PASSIVE（tcp被动模式）", required = true)
+			"UDP（udp传输），TCP-ACTIVE（tcp主动模式），TCP-PASSIVE（tcp被动模式）", required = true)
 	@PostMapping("/transport/{deviceId}/{streamMode}")
 	public void updateTransport(@PathVariable String deviceId, @PathVariable String streamMode){
 		Device device = deviceService.getDeviceByDeviceId(deviceId);

File: src/main/java/com/genersoft/iot/vmp/gb28181/dao/CommonGBChannelMapper.java
Patch:
@@ -119,6 +119,7 @@ public interface CommonGBChannelMapper {
             ", gb_block = #{gbBlock}" +
             ", gb_address = #{gbAddress}" +
             ", gb_parental = #{gbParental}" +
+            ", gb_parent_id = #{gbParentId}" +
             ", gb_safety_way = #{gbSafetyWay}" +
             ", gb_register_way = #{gbRegisterWay}" +
             ", gb_cert_num = #{gbCertNum}" +

File: src/main/java/com/genersoft/iot/vmp/gb28181/dao/PlatformMapper.java
Patch:
@@ -71,7 +71,7 @@ public interface PlatformMapper {
             "    ) as channel_count" +
             " FROM wvp_platform pp where 1=1 " +
             " <if test='query != null'> " +
-            " AND (pp.name LIKE concat('%',#{query},'%') OR pp.server_gb_id  LIKE concat('%',#{query},'%') )</if> " +
+            " AND (pp.name LIKE concat('%',#{query},'%') escape '/' OR pp.server_gb_id  LIKE concat('%',#{query},'%') escape '/' )</if> " +
             " order by pp.id desc"+
             " </script>")
     List<Platform> queryList(@Param("query") String query);

File: src/main/java/com/genersoft/iot/vmp/gb28181/dao/RegionMapper.java
Patch:
@@ -26,7 +26,7 @@ public interface RegionMapper {
 
     @Select(value = {" <script>" +
             "SELECT *  from wvp_common_region WHERE 1=1 " +
-            " <if test='query != null'> AND (device_id LIKE concat('%',#{query},'%') OR name LIKE concat('%',#{query},'%'))</if> " +
+            " <if test='query != null'> AND (device_id LIKE concat('%',#{query},'%') escape '/' OR name LIKE concat('%',#{query},'%') escape '/')</if> " +
             " <if test='parentId != null'> AND parent_device_id = #{parentId}</if> " +
             "ORDER BY id " +
             " </script>"})
@@ -79,7 +79,7 @@ public interface RegionMapper {
             " where " +
             " <if test='parentId != null'> parent_id = #{parentId} </if> " +
             " <if test='parentId == null'> parent_id is null </if> " +
-            " <if test='query != null'> AND (device_id LIKE concat('%',#{query},'%') OR name LIKE concat('%',#{query},'%'))</if> " +
+            " <if test='query != null'> AND (device_id LIKE concat('%',#{query},'%') escape '/' OR name LIKE concat('%',#{query},'%') escape '/')</if> " +
             " </script>")
     List<RegionTree> queryForTree(@Param("query") String query, @Param("parentId") Integer parentId);
 

File: src/main/java/com/genersoft/iot/vmp/storager/dao/CloudRecordServiceMapper.java
Patch:
@@ -41,7 +41,7 @@ public interface CloudRecordServiceMapper {
             "select * " +
             " from wvp_cloud_record " +
             " where 0 = 0" +
-            " <if test='query != null'> AND (app LIKE concat('%',#{query},'%') OR stream LIKE concat('%',#{query},'%') )</if> " +
+            " <if test='query != null'> AND (app LIKE concat('%',#{query},'%') escape '/' OR stream LIKE concat('%',#{query},'%') escape '/' )</if> " +
             " <if test= 'app != null '> and app=#{app}</if>" +
             " <if test= 'stream != null '> and stream=#{stream}</if>" +
             " <if test= 'startTimeStamp != null '> and end_time &gt;= #{startTimeStamp}</if>" +

File: src/main/java/com/genersoft/iot/vmp/streamPush/dao/StreamPushMapper.java
Patch:
@@ -48,8 +48,8 @@ public interface StreamPushMapper {
             " on st.id = wdc.stream_push_id " +
             " WHERE " +
             " 1=1 " +
-            " <if test='query != null'> AND (st.app LIKE concat('%',#{query},'%') OR st.stream LIKE concat('%',#{query},'%') " +
-            " OR wdc.gb_device_id LIKE concat('%',#{query},'%') OR wdc.gb_name LIKE concat('%',#{query},'%'))</if> " +
+            " <if test='query != null'> AND (st.app LIKE concat('%',#{query},'%') escape '/' OR st.stream LIKE concat('%',#{query},'%') escape '/' " +
+            " OR wdc.gb_device_id LIKE concat('%',#{query},'%') escape '/' OR wdc.gb_name LIKE concat('%',#{query},'%') escape '/')</if> " +
             " <if test='pushing == true' > AND st.pushing=1</if>" +
             " <if test='pushing == false' > AND st.pushing=0 </if>" +
             " <if test='mediaServerId != null' > AND st.media_server_id=#{mediaServerId} </if>" +

File: src/main/java/com/genersoft/iot/vmp/gb28181/service/impl/PlayServiceImpl.java
Patch:
@@ -267,7 +267,7 @@ public void onApplicationEvent(MediaNotFoundEvent event) {
         }
         if (s.length == 2) {
             log.info("[ZLM HOOK] 预览流未找到, 发起自动点播：{}->{}->{}/{}", event.getMediaServer().getId(), event.getSchema(), event.getApp(), event.getStream());
-            play(event.getMediaServer(), deviceId, channelId, null, null);
+            play(event.getMediaServer(), deviceId, channelId, null, (code, msg, data) -> {});
         } else if (s.length == 4) {
             // 此时为录像回放， 录像回放格式为> 设备ID_通道ID_开始时间_结束时间
             String startTimeStr = s[2];
@@ -283,7 +283,7 @@ public void onApplicationEvent(MediaNotFoundEvent event) {
                     startTime, endTime
             );
 
-            playBack(event.getMediaServer(), device, deviceChannel, startTime, endTime, null);
+            playBack(event.getMediaServer(), device, deviceChannel, startTime, endTime, (code, msg, data) -> {});
         }
     }
 

File: src/main/java/com/genersoft/iot/vmp/common/InviteInfo.java
Patch:
@@ -33,6 +33,8 @@ public class InviteInfo {
 
     private Long expirationTime;
 
+    private Long createTime;
+
 
     public static InviteInfo getInviteInfo(String deviceId, Integer channelId, String stream, SSRCInfo ssrcInfo, String mediaServerId,
                                            String receiveIp, Integer receivePort, String streamMode,

File: src/main/java/com/genersoft/iot/vmp/common/VideoManagerConstants.java
Patch:
@@ -18,7 +18,7 @@ public class VideoManagerConstants {
 
 	public static final String DEVICE_PREFIX = "VMP_DEVICE_INFO";
 
-	public static final String INVITE_PREFIX = "VMP_INVITE_INFO";
+	public static final String INVITE_PREFIX = "VMP_GB_INVITE_INFO";
 
 	public static final String PLATFORM_CATCH_PREFIX = "VMP_PLATFORM_CATCH_";
 

File: src/main/java/com/genersoft/iot/vmp/common/VideoManagerConstants.java
Patch:
@@ -16,15 +16,15 @@ public class VideoManagerConstants {
 
 	public static final String ONLINE_MEDIA_SERVERS_PREFIX = "VMP_ONLINE_MEDIA_SERVERS:";
 
-	public static final String DEVICE_PREFIX = "VMP_DEVICE:";
+	public static final String DEVICE_PREFIX = "VMP_DEVICE_INFO";
 
 	public static final String INVITE_PREFIX = "VMP_INVITE_INFO";
 
 	public static final String PLATFORM_CATCH_PREFIX = "VMP_PLATFORM_CATCH_";
 
 	public static final String PLATFORM_REGISTER_INFO_PREFIX = "VMP_PLATFORM_REGISTER_INFO_";
 
-	public static final String SEND_RTP_INFO = "VMP_SEND_RTP_INFO:";
+	public static final String SEND_RTP_PORT = "VM_SEND_RTP_PORT:";
 	public static final String SEND_RTP_INFO_CALLID = "VMP_SEND_RTP_INFO:CALL_ID:";
 	public static final String SEND_RTP_INFO_STREAM = "VMP_SEND_RTP_INFO:STREAM:";
 	public static final String SEND_RTP_INFO_CHANNEL = "VMP_SEND_RTP_INFO:CHANNEL:";

File: src/main/java/com/genersoft/iot/vmp/gb28181/dao/DeviceChannelMapper.java
Patch:
@@ -151,9 +151,6 @@ List<DeviceChannel> queryChannels(@Param("deviceDbId") int deviceDbId, @Param("c
             " </script>"})
     List<DeviceChannelExtend> queryChannelsWithDeviceInfo(@Param("deviceId") String deviceId, @Param("parentChannelId") String parentChannelId, @Param("query") String query, @Param("hasSubChannel") Boolean hasSubChannel, @Param("online") Boolean online, @Param("channelIds") List<String> channelIds);
 
-    @Update(value = {"UPDATE wvp_device_channel SET stream_id=null WHERE device_db_id=#{deviceId} AND device_id=#{channelId}"})
-    void stopPlay(@Param("deviceId") int deviceId, @Param("channelId") String channelId);
-
     @Update(value = {"UPDATE wvp_device_channel SET stream_id=#{streamId} WHERE id=#{channelId}"})
     void startPlay(@Param("channelId") Integer channelId, @Param("streamId") String streamId);
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/service/IPlayService.java
Patch:
@@ -30,13 +30,13 @@ public interface IPlayService {
     MediaServer getNewMediaServerItem(Device device);
 
     void playBack(Device device, DeviceChannel channel, String startTime, String endTime, ErrorCallback<StreamInfo> callback);
-    void zlmServerOffline(String mediaServerId);
+    void zlmServerOffline(MediaServer mediaServer);
 
     void download(Device device, DeviceChannel channel, String startTime, String endTime, int downloadSpeed, ErrorCallback<StreamInfo> callback);
 
     StreamInfo getDownLoadInfo(Device device, DeviceChannel channel, String stream);
 
-    void zlmServerOnline(String mediaServerId);
+    void zlmServerOnline(MediaServer mediaServer);
 
     AudioBroadcastResult audioBroadcast(Device device, DeviceChannel deviceChannel, Boolean broadcastMode);
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/service/impl/InviteStreamServiceImpl.java
Patch:
@@ -210,9 +210,6 @@ public void removeInviteInfo(InviteSessionType type, Integer channelId, String s
                     ":" + inviteInfo.getSsrcInfo().getSsrc();
             redisTemplate.opsForHash().delete(key, objectKey);
         }
-        if (redisTemplate.opsForHash().size(key) == 0) {
-            redisTemplate.opsForHash().delete(key);
-        }
     }
 
     @Override

File: src/main/java/com/genersoft/iot/vmp/media/MediaServerConfig.java
Patch:
@@ -41,7 +41,7 @@ public void run(String... strings) throws Exception {
             mediaServerService.update(mediaSerItemInConfig);
         }else {
             if (defaultMediaServer != null) {
-                mediaServerService.delete(defaultMediaServer.getId());
+                mediaServerService.delete(defaultMediaServer);
             }
             MediaServer mediaServerItem = mediaServerService.getOneFromDatabase(mediaSerItemInConfig.getId());
             if (mediaServerItem == null) {

File: src/main/java/com/genersoft/iot/vmp/media/service/IMediaNodeServerService.java
Patch:
@@ -67,4 +67,7 @@ public interface IMediaNodeServerService {
     StreamInfo startProxy(MediaServer mediaServer, StreamProxy streamProxy);
 
     void stopProxy(MediaServer mediaServer, String streamKey);
+
+    List<String> listRtpServer(MediaServer mediaServer);
+
 }

File: src/main/java/com/genersoft/iot/vmp/media/service/IMediaServerService.java
Patch:
@@ -65,7 +65,7 @@ SSRCInfo openRTPServer(MediaServer mediaServerItem, String streamId, String pres
 
     boolean checkMediaRecordServer(String ip, int port);
 
-    void delete(String id);
+    void delete(MediaServer mediaServer);
 
     MediaServer getDefaultMediaServer();
 
@@ -158,4 +158,5 @@ SSRCInfo openRTPServer(MediaServer mediaServerItem, String streamId, String pres
 
     int createRTPServer(MediaServer mediaServerItem, String streamId, long ssrc, Integer port, boolean onlyAuto, boolean disableAudio, boolean reUsePort, Integer tcpMode);
 
+    List<String> listRtpServer(MediaServer mediaServer);
 }

File: src/main/java/com/genersoft/iot/vmp/service/ISendRtpServerService.java
Patch:
@@ -40,4 +40,6 @@ SendRtpInfo createSendRtpInfo(MediaServer mediaServer, String ip, Integer port,
     List<SendRtpInfo> queryByChannelId(int id);
 
     void deleteByStream(String stream);
+
+    int getNextPort(MediaServer mediaServer);
 }

File: src/main/java/com/genersoft/iot/vmp/streamPush/service/IStreamPushService.java
Patch:
@@ -1,5 +1,6 @@
 package com.genersoft.iot.vmp.streamPush.service;
 
+import com.genersoft.iot.vmp.media.bean.MediaServer;
 import com.genersoft.iot.vmp.service.bean.GPSMsgInfo;
 import com.genersoft.iot.vmp.service.bean.StreamPushItemFromRedis;
 import com.genersoft.iot.vmp.streamPush.bean.StreamPush;
@@ -36,12 +37,12 @@ public interface IStreamPushService {
     /**
      * 新的节点加入
      */
-    void zlmServerOnline(String mediaServerId);
+    void zlmServerOnline(MediaServer mediaServer);
 
     /**
      * 节点离线
      */
-    void zlmServerOffline(String mediaServerId);
+    void zlmServerOffline(MediaServer mediaServer);
 
     /**
      * 批量添加

File: src/main/java/com/genersoft/iot/vmp/streamProxy/service/impl/StreamProxyServiceImpl.java
Patch:
@@ -290,7 +290,7 @@ public void zlmServerOnline(String mediaServerId) {
             return;
         }
         // 这里主要是控制数据库/redis缓存/以及zlm中存在的代理流 三者状态一致。以数据库中数据为根本
-        redisCatchStorage.removeStream(mediaServerId, "pull");
+        redisCatchStorage.removeStream(mediaServerId, "PULL");
 
         List<StreamProxy> streamProxies = streamProxyMapper.selectForEnableInMediaServer(mediaServerId, true);
         if (streamProxies.isEmpty()) {
@@ -363,7 +363,7 @@ public void zlmServerOffline(String mediaServerId) {
         List<StreamProxy> streamProxies = streamProxyMapper.selectForEnableInMediaServer(mediaServerId, true);
 
         // 清理redis相关的缓存
-        redisCatchStorage.removeStream(mediaServerId, "pull");
+        redisCatchStorage.removeStream(mediaServerId, "PULL");
 
         if (streamProxies.isEmpty()) {
             return;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/ByeRequestProcessor.java
Patch:
@@ -184,7 +184,7 @@ public void process(RequestEvent evt) {
 			return;
 		}
 		log.info("[收到bye] 来自：{}, 通道: {}, 类型： {}", ssrcTransaction.getDeviceId(), ssrcTransaction.getChannelId(), ssrcTransaction.getType());
-
+		// TODO 结束点播 避免等待
 
 		if (ssrcTransaction.getPlatformId() != null ) {
 			Platform platform = platformService.queryPlatformByServerGBId(ssrcTransaction.getPlatformId());

File: src/main/java/com/genersoft/iot/vmp/media/service/impl/MediaServerServiceImpl.java
Patch:
@@ -273,6 +273,7 @@ public void clearRTPServer(MediaServer mediaServer) {
     public void update(MediaServer mediaSerItem) {
         mediaServerMapper.update(mediaSerItem);
         MediaServer mediaServerInRedis = getOne(mediaSerItem.getId());
+        // 获取完整数据
         MediaServer mediaServerInDataBase = mediaServerMapper.queryOne(mediaSerItem.getId());
         if (mediaServerInDataBase == null) {
             return;
@@ -350,7 +351,7 @@ public List<MediaServer> getAllOnline() {
         Set<Object> mediaServerIdSet = redisTemplate.opsForZSet().reverseRange(key, 0, -1);
 
         List<MediaServer> result = new ArrayList<>();
-        if (mediaServerIdSet != null && mediaServerIdSet.size() > 0) {
+        if (mediaServerIdSet != null && !mediaServerIdSet.isEmpty()) {
             for (Object mediaServerId : mediaServerIdSet) {
                 String mediaServerIdStr = (String) mediaServerId;
                 String serverKey = VideoManagerConstants.MEDIA_SERVER_PREFIX + userSetting.getServerId() + ":" + mediaServerIdStr;

File: src/main/java/com/genersoft/iot/vmp/vmanager/server/ServerController.java
Patch:
@@ -228,7 +228,7 @@ public SystemAllInfo getSystemInfo() {
     public List<MediaServerLoad> getMediaLoad() {
         List<MediaServerLoad> result = new ArrayList<>();
         List<MediaServer> allOnline = mediaServerService.getAllOnline();
-        if (allOnline.size() == 0) {
+        if (allOnline.isEmpty()) {
             return result;
         }else {
             for (MediaServer mediaServerItem : allOnline) {

File: src/main/java/com/genersoft/iot/vmp/gb28181/session/SipInviteSessionManager.java
Patch:
@@ -54,7 +54,7 @@ public List<SsrcTransaction> getSsrcTransactionByDeviceId(String deviceId){
 		List<SsrcTransaction> result = new ArrayList<>();
 		for (Object keyObj : scanResult) {
 			SsrcTransaction ssrcTransaction = (SsrcTransaction)redisTemplate.opsForValue().get(keyObj);
-			if (ssrcTransaction != null && ssrcTransaction.getDeviceId().equals(deviceId)) {
+			if (ssrcTransaction != null && deviceId.equals(ssrcTransaction.getDeviceId())) {
 				result.add(ssrcTransaction);
 			}
 		}

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/AckRequestProcessor.java
Patch:
@@ -134,7 +134,7 @@ public void process(RequestEvent evt) {
 
 					redisCatchStorage.sendPlatformStartPlayMsg(sendRtpItem, deviceChannel, parentPlatform);
 				}catch (ControllerException e) {
-					log.error("RTP推流失败: {}", e.getMessage());
+					log.error("RTP推流失败: ", e);
 					playService.startSendRtpStreamFailHand(sendRtpItem, parentPlatform, callIdHeader);
 				}
 			}

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMMediaNodeServerService.java
Patch:
@@ -381,7 +381,9 @@ public void startSendRtpStream(MediaServer mediaServer, SendRtpInfo sendRtpItem)
         param.put("dst_url", sendRtpItem.getIp());
         param.put("dst_port", sendRtpItem.getPort());
         JSONObject jsonObject = zlmresTfulUtils.startSendRtp(mediaServer, param);
-        if (jsonObject == null || jsonObject.getInteger("code") != 0 ) {
+        if (jsonObject == null ) {
+            throw new ControllerException(ErrorCode.ERROR100.getCode(), "连接zlm失败");
+        }else if (jsonObject.getInteger("code") != 0) {
             throw new ControllerException(jsonObject.getInteger("code"), jsonObject.getString("msg"));
         }
         log.info("[推流结果]：{} ，参数： {}",jsonObject, JSONObject.toJSONString(param));

File: src/main/java/com/genersoft/iot/vmp/gb28181/service/impl/PlayServiceImpl.java
Patch:
@@ -1636,7 +1636,7 @@ public void play(CommonGBChannel channel, ErrorCallback<StreamInfo> callback) {
             log.warn("[点播] 未找到可用媒体节点");
             throw new PlayException(Response.SERVER_INTERNAL_ERROR, "server internal error");
         }
-        DeviceChannel deviceChannel = deviceChannelService.getOneById(channel.getGbId());
+        DeviceChannel deviceChannel = deviceChannelService.getOneForSourceById(channel.getGbId());
         play(mediaServer, device, deviceChannel, null, callback);
     }
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/notify/cmd/KeepaliveNotifyMessageHandler.java
Patch:
@@ -82,7 +82,7 @@ public void handForDevice(RequestEvent evt, Device device, Element element) {
             device.setPort(remoteAddressInfo.getPort());
             device.setHostAddress(remoteAddressInfo.getIp().concat(":").concat(String.valueOf(remoteAddressInfo.getPort())));
             device.setIp(remoteAddressInfo.getIp());
-            device.setLocalIp(request.getRemoteAddress().getHostAddress());
+            device.setLocalIp(request.getLocalAddress().getHostAddress());
             // 设备地址变化会引起目录订阅任务失效，需要重新添加
             if (device.getSubscribeCycleForCatalog() > 0) {
                 deviceService.removeCatalogSubscribe(device, result->{

File: src/main/java/com/genersoft/iot/vmp/gb28181/dao/DeviceMapper.java
Patch:
@@ -59,6 +59,7 @@ public interface DeviceMapper {
                 "firmware, " +
                 "transport," +
                 "stream_mode," +
+                "media_server_id," +
                 "ip," +
                 "sdp_ip," +
                 "local_ip," +
@@ -88,6 +89,7 @@ public interface DeviceMapper {
                 "#{firmware}," +
                 "#{transport}," +
                 "#{streamMode}," +
+                "#{mediaServerId}," +
                 "#{ip}," +
                 "#{sdpIp}," +
                 "#{localIp}," +

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/RegisterRequestProcessor.java
Patch:
@@ -172,6 +172,7 @@ public void process(RequestEvent evt) {
                 device.setStreamMode("UDP");
                 device.setCharset("GB2312");
                 device.setGeoCoordSys("WGS84");
+                device.setMediaServerId("auto");
                 device.setDeviceId(deviceId);
                 device.setOnLine(false);
             }else {

File: src/main/java/com/genersoft/iot/vmp/gb28181/SipLayer.java
Patch:
@@ -125,7 +125,7 @@ private void addListeningPoint(String monitorIp, int port){
 
 			SipProviderImpl udpSipProvider = (SipProviderImpl)sipStack.createSipProvider(udpListeningPoint);
 			udpSipProvider.addSipListener(sipProcessorObserver);
-
+			udpSipProvider.setDialogErrorsAutomaticallyHandled();
 			udpSipProviderMap.put(monitorIp, udpSipProvider);
 
 			log.info("[SIP SERVER] udp://{}:{} 启动成功", monitorIp, port);

File: src/main/java/com/genersoft/iot/vmp/gb28181/service/impl/PlatformServiceImpl.java
Patch:
@@ -380,7 +380,9 @@ private void registerTask(Platform platform, SipTransactionInfo sipTransactionIn
             commanderForPlatform.register(platform, sipTransactionInfo,  eventResult -> {
                 log.info("[国标级联] 平台：{}注册失败，{}:{}", platform.getServerGBId(),
                         eventResult.statusCode, eventResult.msg);
-                offline(platform, false);
+                if (platform.isStatus()) {
+                    offline(platform, false);
+                }
             }, null);
         } catch (Exception e) {
             log.error("[命令发送失败] 国标级联定时注册: {}", e.getMessage());

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/response/ISIPResponseProcessor.java
Patch:
@@ -1,5 +1,7 @@
 package com.genersoft.iot.vmp.gb28181.transmit.event.response;
 
+import org.springframework.scheduling.annotation.Async;
+
 import javax.sip.ResponseEvent;
 
 /**    
@@ -9,6 +11,7 @@
  */
 public interface ISIPResponseProcessor {
 
+
 	void process(ResponseEvent evt);
 
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/response/impl/InviteResponseProcessor.java
Patch:
@@ -38,14 +38,12 @@ public class InviteResponseProcessor extends SIPResponseProcessorAbstract {
 	@Autowired
 	private SIPProcessorObserver sipProcessorObserver;
 
-
 	@Autowired
 	private SIPSender sipSender;
 
 	@Autowired
 	private SIPRequestHeaderProvider headerProvider;
 
-
 	@Override
 	public void afterPropertiesSet() throws Exception {
 		// 添加消息处理的订阅

File: src/main/java/com/genersoft/iot/vmp/gb28181/controller/GBRecordController.java
Patch:
@@ -201,8 +201,7 @@ public void playStop(@PathVariable String deviceId, @PathVariable String channel
 		try {
 			cmder.streamByeCmd(device, channelId, stream, null);
 		} catch (InvalidArgumentException | ParseException | SipException | SsrcTransactionNotFoundException e) {
-			log.error("[停止历史媒体下载]停止历史媒体下载，发送BYE失败 {}", e.getMessage());
-			throw new ControllerException(ErrorCode.ERROR100.getCode(), e.getMessage());
+			log.warn("[停止历史媒体下载]停止历史媒体下载，发送BYE失败 {}", e.getMessage());
 		}
 	}
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/controller/PlayController.java
Patch:
@@ -165,11 +165,11 @@ public JSONObject playStop(@PathVariable String deviceId, @PathVariable String c
 		}
 
 		Device device = deviceService.getDeviceByDeviceId(deviceId);
-		DeviceChannel channel = deviceChannelService.getOne(deviceId, channelId);
+		DeviceChannel channel = deviceChannelService.getOneForSource(deviceId, channelId);
 		Assert.notNull(device, "设备不存在");
 		Assert.notNull(channel, "通道不存在");
-
-		playService.stopPlay(device, channel);
+		String streamId = String.format("%s_%s", device.getDeviceId(), channel.getDeviceId());
+		playService.stop(InviteSessionType.PLAY, device, channel, streamId);
 		JSONObject json = new JSONObject();
 		json.put("deviceId", deviceId);
 		json.put("channelId", channelId);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/impl/SIPCommanderFroPlatform.java
Patch:
@@ -360,7 +360,9 @@ public void sendNotifyMobilePosition(Platform parentPlatform, GPSMsgInfo gpsMsgI
         if (parentPlatform == null) {
             return;
         }
-        log.info("[发送 移动位置订阅] {}/{}->{},{}", parentPlatform.getServerGBId(), gpsMsgInfo.getChannelId(), gpsMsgInfo.getLng(), gpsMsgInfo.getLat());
+        if (log.isDebugEnabled()) {
+            log.info("[发送 移动位置订阅] {}/{}->{},{}", parentPlatform.getServerGBId(), gpsMsgInfo.getChannelId(), gpsMsgInfo.getLng(), gpsMsgInfo.getLat());
+        }
 
         String characterSet = parentPlatform.getCharacterSet();
         StringBuffer deviceStatusXml = new StringBuffer(600);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/InviteRequestProcessor.java
Patch:
@@ -198,7 +198,7 @@ public void process(RequestEvent evt) {
                         String content = createSendSdp(sendRtpItem, inviteInfo, sdpIp);
                         // 超时未收到Ack应该回复bye,当前等待时间为10秒
                         dynamicTask.startDelay(inviteInfo.getCallId(), () -> {
-                            log.info("Ack 等待超时");
+                            log.info("[Ack ] 等待超时, {}/{}", inviteInfo.getCallId(), channel.getGbDeviceId());
                             mediaServerService.releaseSsrc(streamInfo.getMediaServer().getId(), sendRtpItem.getSsrc());
                             // 回复bye
                             sendBye(platform, inviteInfo.getCallId());

File: src/main/java/com/genersoft/iot/vmp/gb28181/service/IGbChannelService.java
Patch:
@@ -30,8 +30,6 @@ public interface IGbChannelService {
 
     void updateStatus(List<CommonGBChannel> channelList);
 
-    List<CommonGBChannel> queryByPlatform(Platform platform);
-
     CommonGBChannel getOne(int id);
 
     List<IndustryCodeType> getIndustryCodeList();

File: src/main/java/com/genersoft/iot/vmp/gb28181/dao/PlatformChannelMapper.java
Patch:
@@ -89,7 +89,7 @@ public interface PlatformChannelMapper {
             "FROM " +
             "wvp_platform pp " +
             "left join wvp_platform_gb_channel pgc on " +
-            "pp.server_gb_id = pgc.platform_id " +
+            "pp.id = pgc.platform_id " +
             "left join wvp_device_channel dc on " +
             "dc.id = pgc.device_channel_id " +
             "WHERE " +

File: src/main/java/com/genersoft/iot/vmp/storager/impl/RedisCatchStorageImpl.java
Patch:
@@ -10,7 +10,6 @@
 import com.genersoft.iot.vmp.media.bean.MediaServer;
 import com.genersoft.iot.vmp.media.event.media.MediaArrivalEvent;
 import com.genersoft.iot.vmp.media.zlm.dto.StreamAuthorityInfo;
-import com.genersoft.iot.vmp.media.zlm.dto.StreamPushItem;
 import com.genersoft.iot.vmp.media.zlm.dto.hook.OnStreamChangedHookParam;
 import com.genersoft.iot.vmp.service.bean.GPSMsgInfo;
 import com.genersoft.iot.vmp.service.bean.MessageForPushChannel;
@@ -695,6 +694,7 @@ public void sendPlatformStopPlayMsg(SendRtpItem sendRtpItem, ParentPlatform plat
     @Override
     public void addPushListItem(String app, String stream, MediaArrivalEvent event) {
         String key = VideoManagerConstants.PUSH_STREAM_LIST + app + "_" + stream;
+        event.getHookParam().setSeverId(userSetting.getServerId());
         redisTemplate.opsForValue().set(key, event.getHookParam());
     }
 
@@ -707,7 +707,7 @@ public OnStreamChangedHookParam getPushListItem(String app, String stream) {
     @Override
     public void removePushListItem(String app, String stream, String mediaServerId) {
         String key = VideoManagerConstants.PUSH_STREAM_LIST + app + "_" + stream;
-        StreamPushItem param = (StreamPushItem)redisTemplate.opsForValue().get(key);
+        OnStreamChangedHookParam param = (OnStreamChangedHookParam)redisTemplate.opsForValue().get(key);
         if (param != null && param.getMediaServerId().equalsIgnoreCase(mediaServerId)) {
             redisTemplate.delete(key);
         }

File: src/main/java/com/genersoft/iot/vmp/storager/impl/RedisCatchStorageImpl.java
Patch:
@@ -694,6 +694,7 @@ public void sendPlatformStopPlayMsg(SendRtpItem sendRtpItem, ParentPlatform plat
     @Override
     public void addPushListItem(String app, String stream, MediaArrivalEvent event) {
         String key = VideoManagerConstants.PUSH_STREAM_LIST + app + "_" + stream;
+        event.getHookParam().setSeverId(userSetting.getServerId());
         redisTemplate.opsForValue().set(key, event.getHookParam());
     }
 

File: src/main/java/com/genersoft/iot/vmp/storager/impl/RedisCatchStorageImpl.java
Patch:
@@ -10,7 +10,6 @@
 import com.genersoft.iot.vmp.media.bean.MediaServer;
 import com.genersoft.iot.vmp.media.event.media.MediaArrivalEvent;
 import com.genersoft.iot.vmp.media.zlm.dto.StreamAuthorityInfo;
-import com.genersoft.iot.vmp.media.zlm.dto.StreamPushItem;
 import com.genersoft.iot.vmp.media.zlm.dto.hook.OnStreamChangedHookParam;
 import com.genersoft.iot.vmp.service.bean.GPSMsgInfo;
 import com.genersoft.iot.vmp.service.bean.MessageForPushChannel;
@@ -707,7 +706,7 @@ public OnStreamChangedHookParam getPushListItem(String app, String stream) {
     @Override
     public void removePushListItem(String app, String stream, String mediaServerId) {
         String key = VideoManagerConstants.PUSH_STREAM_LIST + app + "_" + stream;
-        StreamPushItem param = (StreamPushItem)redisTemplate.opsForValue().get(key);
+        OnStreamChangedHookParam param = (OnStreamChangedHookParam)redisTemplate.opsForValue().get(key);
         if (param != null && param.getMediaServerId().equalsIgnoreCase(mediaServerId)) {
             redisTemplate.delete(key);
         }

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMServerFactory.java
Patch:
@@ -17,7 +17,7 @@
 @Component
 public class ZLMServerFactory {
 
-    private Logger logger = LoggerFactory.getLogger("ZLMServerFactory");
+    private final static Logger logger = LoggerFactory.getLogger(ZLMServerFactory.class);
 
     @Autowired
     private ZLMRESTfulUtils zlmresTfulUtils;

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlayServiceImpl.java
Patch:
@@ -757,7 +757,7 @@ public void playBack(String deviceId, String channelId, String startTime,
         }
 
         MediaServer newMediaServerItem = getNewMediaServerItem(device);
-        if (device.getStreamMode().equalsIgnoreCase("TCP-ACTIVE") && ! newMediaServerItem.isRtpEnable()) {
+        if ("TCP-ACTIVE".equalsIgnoreCase(device.getStreamMode()) && ! newMediaServerItem.isRtpEnable()) {
             logger.warn("[录像回放] 单端口收流时不支持TCP主动方式收流 deviceId: {},channelId:{}", deviceId, channelId);
             throw new ControllerException(ErrorCode.ERROR100.getCode(), "单端口收流时不支持TCP主动方式收流");
         }

File: src/main/java/com/genersoft/iot/vmp/service/IInviteStreamService.java
Patch:
@@ -14,6 +14,8 @@ public interface IInviteStreamService {
      */
     void updateInviteInfo(InviteInfo inviteInfo);
 
+    void updateInviteInfo(InviteInfo inviteInfo, Long time);
+
     InviteInfo updateInviteInfoForStream(InviteInfo inviteInfo, String stream);
 
     /**

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlayServiceImpl.java
Patch:
@@ -1038,7 +1038,8 @@ public void download(MediaServer mediaServerItem, SSRCInfo ssrcInfo, String devi
                             InviteInfo inviteInfoForNew = inviteStreamService.getInviteInfo(inviteInfo.getType(), inviteInfo.getDeviceId()
                                     , inviteInfo.getChannelId(), inviteInfo.getStream());
                             inviteInfoForNew.getStreamInfo().setDownLoadFilePath(downloadFileInfo);
-                            inviteStreamService.updateInviteInfo(inviteInfoForNew);
+                            // 不可以马上移除会导致后续接口拿不到下载地址
+                            inviteStreamService.updateInviteInfo(inviteInfoForNew, 60*15L);
                         };
                         Hook hook = Hook.getInstance(HookType.on_record_mp4, "rtp", ssrcInfo.getStream(), mediaServerItem.getId());
                         // 设置过期时间，下载失败时自动处理订阅数据

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/device/DeviceQuery.java
Patch:
@@ -322,6 +322,9 @@ public void addDevice(Device device){
 	public void updateDevice(Device device){
 
 		if (device != null && device.getDeviceId() != null) {
+			if (device.getSubscribeCycleForMobilePosition() > 0 && device.getMobilePositionSubmissionInterval() <= 0) {
+				device.setMobilePositionSubmissionInterval(5);
+			}
 			deviceService.updateCustomDevice(device);
 		}
 	}

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlayServiceImpl.java
Patch:
@@ -1003,6 +1003,7 @@ public void download(MediaServer mediaServerItem, SSRCInfo ssrcInfo, String devi
             dynamicTask.stop(downLoadTimeOutTaskKey);
             callback.run(InviteErrorCode.ERROR_FOR_SIGNALLING_TIMEOUT.getCode(),
                     String.format("录像下载失败， 错误码： %s, %s", event.statusCode, event.msg), null);
+            mediaServerService.releaseSsrc(mediaServerItem.getId(), ssrcInfo.getSsrc());
             streamSession.remove(device.getDeviceId(), channelId, ssrcInfo.getStream());
             inviteStreamService.removeInviteInfo(inviteInfo);
         };

File: src/main/java/com/genersoft/iot/vmp/service/impl/MediaServiceImpl.java
Patch:
@@ -92,7 +92,7 @@ public StreamInfo getStreamInfoByAppAndStream(MediaServerItem mediaInfo, String
         }
         if (!"broadcast".equalsIgnoreCase(app) && !ObjectUtils.isEmpty(mediaInfo.getTranscodeSuffix()) && !"null".equalsIgnoreCase(mediaInfo.getTranscodeSuffix())) {
             stream = stream + "_" + mediaInfo.getTranscodeSuffix();
-            streamInfoResult.setStream(stream);
+//            streamInfoResult.setStream(stream);
         }
 
         streamInfoResult.setIp(addr);

File: src/main/java/com/genersoft/iot/vmp/gb28181/task/SipRunner.java
Patch:
@@ -104,7 +104,7 @@ public void run(String... args) throws Exception {
                 redisCatchStorage.deleteSendRTPServer(sendRtpItem.getPlatformId(),sendRtpItem.getChannelId(), sendRtpItem.getCallId(),sendRtpItem.getStream());
                 if (mediaServerItem != null) {
                     ssrcFactory.releaseSsrc(sendRtpItem.getMediaServerId(), sendRtpItem.getSsrc());
-                    boolean stopResult = mediaServerService.stopSendRtp(mediaServerItem, sendRtpItem.getApp(), sendRtpItem.getStream(), sendRtpItem.getSsrc());
+                    boolean stopResult = mediaServerService.initStopSendRtp(mediaServerItem, sendRtpItem.getApp(), sendRtpItem.getStream(), sendRtpItem.getSsrc());
                     if (stopResult) {
                         ParentPlatform platform = platformService.queryPlatformByServerGBId(sendRtpItem.getPlatformId());
                         if (platform != null) {

File: src/main/java/com/genersoft/iot/vmp/media/service/IMediaNodeServerService.java
Patch:
@@ -29,6 +29,8 @@ public interface IMediaNodeServerService {
 
     boolean stopSendRtp(MediaServer mediaInfo, String app, String stream, String ssrc);
 
+    boolean initStopSendRtp(MediaServer mediaInfo, String app, String stream, String ssrc);
+
     boolean deleteRecordDirectory(MediaServer mediaServer, String app, String stream, String date, String fileName);
 
     List<StreamInfo> getMediaList(MediaServer mediaServer, String app, String stream, String callId);

File: src/main/java/com/genersoft/iot/vmp/media/service/IMediaServerService.java
Patch:
@@ -76,6 +76,8 @@ SSRCInfo openRTPServer(MediaServer mediaServerItem, String streamId, String pres
 
     boolean stopSendRtp(MediaServer mediaInfo, String app, String stream, String ssrc);
 
+    boolean initStopSendRtp(MediaServer mediaInfo, String app, String stream, String ssrc);
+
     boolean deleteRecordDirectory(MediaServer mediaServerItem, String app, String stream, String date, String fileName);
 
     List<StreamInfo> getMediaList(MediaServer mediaInfo, String app, String stream, String callId);

File: src/main/java/com/genersoft/iot/vmp/gb28181/task/SipRunner.java
Patch:
@@ -104,7 +104,7 @@ public void run(String... args) throws Exception {
                 redisCatchStorage.deleteSendRTPServer(sendRtpItem.getPlatformId(),sendRtpItem.getChannelId(), sendRtpItem.getCallId(),sendRtpItem.getStream());
                 if (mediaServerItem != null) {
                     ssrcFactory.releaseSsrc(sendRtpItem.getMediaServerId(), sendRtpItem.getSsrc());
-                    boolean stopResult = mediaServerService.stopSendRtp(mediaServerItem, sendRtpItem.getApp(), sendRtpItem.getStream(), sendRtpItem.getSsrc());
+                    boolean stopResult = mediaServerService.initStopSendRtp(mediaServerItem, sendRtpItem.getApp(), sendRtpItem.getStream(), sendRtpItem.getSsrc());
                     if (stopResult) {
                         ParentPlatform platform = platformService.queryPlatformByServerGBId(sendRtpItem.getPlatformId());
                         if (platform != null) {

File: src/main/java/com/genersoft/iot/vmp/media/service/IMediaNodeServerService.java
Patch:
@@ -29,6 +29,8 @@ public interface IMediaNodeServerService {
 
     boolean stopSendRtp(MediaServer mediaInfo, String app, String stream, String ssrc);
 
+    boolean initStopSendRtp(MediaServer mediaInfo, String app, String stream, String ssrc);
+
     boolean deleteRecordDirectory(MediaServer mediaServer, String app, String stream, String date, String fileName);
 
     List<StreamInfo> getMediaList(MediaServer mediaServer, String app, String stream, String callId);

File: src/main/java/com/genersoft/iot/vmp/media/service/IMediaServerService.java
Patch:
@@ -76,6 +76,8 @@ SSRCInfo openRTPServer(MediaServer mediaServerItem, String streamId, String pres
 
     boolean stopSendRtp(MediaServer mediaInfo, String app, String stream, String ssrc);
 
+    boolean initStopSendRtp(MediaServer mediaInfo, String app, String stream, String ssrc);
+
     boolean deleteRecordDirectory(MediaServer mediaServerItem, String app, String stream, String date, String fileName);
 
     List<StreamInfo> getMediaList(MediaServer mediaInfo, String app, String stream, String callId);

File: src/main/java/com/genersoft/iot/vmp/service/impl/CloudRecordServiceImpl.java
Patch:
@@ -86,8 +86,8 @@ public List<String> getDateList(String app, String stream, int year, int month,
         }else {
             endDate = LocalDate.of(year, month + 1, 1);
         }
-        long startTimeStamp = startDate.atStartOfDay().toInstant(ZoneOffset.ofHours(8)).getEpochSecond();
-        long endTimeStamp = endDate.atStartOfDay().toInstant(ZoneOffset.ofHours(8)).getEpochSecond();
+        long startTimeStamp = startDate.atStartOfDay().toInstant(ZoneOffset.ofHours(8)).getEpochSecond() * 1000;
+        long endTimeStamp = endDate.atStartOfDay().toInstant(ZoneOffset.ofHours(8)).getEpochSecond() * 1000;
         List<CloudRecordItem> cloudRecordItemList = cloudRecordServiceMapper.getList(null, app, stream, startTimeStamp,
                 endTimeStamp, null, mediaServerItems);
         if (cloudRecordItemList.isEmpty()) {

File: src/main/java/com/genersoft/iot/vmp/gb28181/bean/DeviceChannel.java
Patch:
@@ -535,11 +535,11 @@ public void setSubCount(int subCount) {
 		this.subCount = subCount;
 	}
 
-	public boolean isHasAudio() {
+	public Boolean getHasAudio() {
 		return hasAudio;
 	}
 
-	public void setHasAudio(boolean hasAudio) {
+	public void setHasAudio(Boolean hasAudio) {
 		this.hasAudio = hasAudio;
 	}
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/NotifyRequestForCatalogProcessor.java
Patch:
@@ -143,6 +143,7 @@ public void process(List<RequestEvent> evtList) {
 							case CatalogEvent.UPDATE:
 								// 更新
 								channel.setUpdateTime(DateUtil.getNow());
+								channel.setHasAudio(null);
 								deviceChannelService.updateChannel(deviceId,channel);
 								if (userSetting.getDeviceStatusNotify()) {
 									// 发送redis消息

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMHttpHookListener.java
Patch:
@@ -289,7 +289,7 @@ public HookResultForOnPublish onPublish(@RequestBody OnPublishHookParam param) {
                 String channelId = ssrcTransactionForAll.get(0).getChannelId();
                 DeviceChannel deviceChannel = storager.queryChannel(deviceId, channelId);
                 if (deviceChannel != null) {
-                    result.setEnable_audio(deviceChannel.isHasAudio());
+                    result.setEnable_audio(deviceChannel.getHasAudio());
                 }
                 // 如果是录像下载就设置视频间隔十秒
                 if (ssrcTransactionForAll.get(0).getType() == InviteSessionType.DOWNLOAD) {

File: src/main/java/com/genersoft/iot/vmp/storager/impl/VideoManagerStorageImpl.java
Patch:
@@ -7,7 +7,6 @@
 import com.genersoft.iot.vmp.gb28181.event.EventPublisher;
 import com.genersoft.iot.vmp.gb28181.event.subscribe.catalog.CatalogEvent;
 import com.genersoft.iot.vmp.media.zlm.dto.StreamProxyItem;
-import com.genersoft.iot.vmp.service.IGbStreamService;
 import com.genersoft.iot.vmp.service.bean.GPSMsgInfo;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
 import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
@@ -139,7 +138,7 @@ public boolean resetChannels(String deviceId, List<DeviceChannel> deviceChannelL
 			gbIdSet.add(deviceChannel.getChannelId());
 			if (allChannelMap.containsKey(deviceChannel.getChannelId())) {
 				deviceChannel.setStreamId(allChannelMap.get(deviceChannel.getChannelId()).getStreamId());
-				deviceChannel.setHasAudio(allChannelMap.get(deviceChannel.getChannelId()).isHasAudio());
+				deviceChannel.setHasAudio(allChannelMap.get(deviceChannel.getChannelId()).getHasAudio());
 				if (allChannelMap.get(deviceChannel.getChannelId()).isStatus() !=deviceChannel.isStatus()){
 					List<String> strings = platformChannelMapper.queryParentPlatformByChannelId(deviceChannel.getChannelId());
 					if (!CollectionUtils.isEmpty(strings)){
@@ -275,7 +274,7 @@ public boolean updateChannels(String deviceId, List<DeviceChannel> deviceChannel
 					deviceChannel.setUpdateTime(DateUtil.getNow());
 					if (allChannelMap.containsKey(deviceChannel.getChannelId())) {
 						deviceChannel.setStreamId(allChannelMap.get(deviceChannel.getChannelId()).getStreamId());
-						deviceChannel.setHasAudio(allChannelMap.get(deviceChannel.getChannelId()).isHasAudio());
+						deviceChannel.setHasAudio(allChannelMap.get(deviceChannel.getChannelId()).getHasAudio());
 						if (allChannelMap.get(deviceChannel.getChannelId()).isStatus() !=deviceChannel.isStatus()){
 							List<String> strings = platformChannelMapper.queryParentPlatformByChannelId(deviceChannel.getChannelId());
 							if (!CollectionUtils.isEmpty(strings)){

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/record/RecordEndEventListener.java
Patch:
@@ -37,15 +37,14 @@ public void onApplicationEvent(RecordEndEvent event) {
                 event.getRecordInfo().getChannelId(), count,sumNum);
         if (!handlerMap.isEmpty()) {
             RecordEndEventHandler handler = handlerMap.get(deviceId + channelId);
+            logger.info("录像查询完成事件触发, 发送订阅，deviceId：{}, channelId: {}",
+                    event.getRecordInfo().getDeviceId(), event.getRecordInfo().getChannelId());
             if (handler !=null){
                 handler.handler(event.getRecordInfo());
                 if (count ==sumNum){
                     handlerMap.remove(deviceId + channelId);
                 }
             }
-        }else {
-            logger.info("录像查询完成事件触发, 但是订阅为空，取消发送，deviceId：{}, channelId: {}",
-                    event.getRecordInfo().getDeviceId(), event.getRecordInfo().getChannelId());
         }
     }
 

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlayServiceImpl.java
Patch:
@@ -1044,9 +1044,7 @@ public void download(MediaServer mediaServerItem, SSRCInfo ssrcInfo, String devi
                         };
                         Hook hook = Hook.getInstance(HookType.on_record_mp4, "rtp", ssrcInfo.getStream(), mediaServerItem.getId());
                         // 设置过期时间，下载失败时自动处理订阅数据
-//                        long difference = DateUtil.getDifference(startTime, endTime)/1000;
-//                        Instant expiresInstant = Instant.now().plusSeconds(TimeUnit.MINUTES.toSeconds(difference * 2));
-//                        hookSubscribe.setExpires(expiresInstant);
+                        hook.setExpireTime(System.currentTimeMillis() + 24 * 60 * 60 * 1000);
                         subscribe.addSubscribe(hook, hookEventForRecord);
                     });
         } catch (InvalidArgumentException | SipException | ParseException e) {

File: src/main/java/com/genersoft/iot/vmp/service/redisMsg/RedisPushStreamStatusListMsgListener.java
Patch:
@@ -89,7 +89,7 @@ public void onMessage(Message message, byte[] bytes) {
                                 allGBId.put(streamPushItem.getGbId(), streamPushItem);
                             } else {
                                 if (allGBId.containsKey(streamPushItem.getGbId())
-                                        && (allGBId.get(streamPushItem.getGbId()).getApp().equals(streamPushItem.getApp()) || allGBId.get(streamPushItem.getGbId()).getStream().equals(streamPushItem.getStream()))) {
+                                        && (!allGBId.get(streamPushItem.getGbId()).getApp().equals(streamPushItem.getApp()) || !allGBId.get(streamPushItem.getGbId()).getStream().equals(streamPushItem.getStream()))) {
                                     GbStream gbStream = allGBId.get(streamPushItem.getGbId());
                                     logger.warn("[REDIS消息-推流设备列表更新-UPDATE] 国标编号重复: {}, 已分配给{}/{}",
                                             streamPushItem.getGbId(), gbStream.getApp(), gbStream.getStream());

File: src/main/java/com/genersoft/iot/vmp/service/redisMsg/RedisPushStreamStatusListMsgListener.java
Patch:
@@ -88,7 +88,8 @@ public void onMessage(Message message, byte[] bytes) {
                                 streamPushItemForSave.add(streamPushItem);
                                 allGBId.put(streamPushItem.getGbId(), streamPushItem);
                             } else {
-                                if (allGBId.containsKey(streamPushItem.getGbId())) {
+                                if (allGBId.containsKey(streamPushItem.getGbId())
+                                        && (allGBId.get(streamPushItem.getGbId()).getApp().equals(streamPushItem.getApp()) || allGBId.get(streamPushItem.getGbId()).getStream().equals(streamPushItem.getStream()))) {
                                     GbStream gbStream = allGBId.get(streamPushItem.getGbId());
                                     logger.warn("[REDIS消息-推流设备列表更新-UPDATE] 国标编号重复: {}, 已分配给{}/{}",
                                             streamPushItem.getGbId(), gbStream.getApp(), gbStream.getStream());

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/impl/SIPCommanderFroPlatform.java
Patch:
@@ -358,8 +358,8 @@ private String getCatalogXml(List<DeviceChannel> channels, String sn, ParentPlat
                             }else {
                                 catalogXml.append("<Password></Password>\r\n");
                             }
-                            if (!ObjectUtils.isEmpty(channel.getPTZType())) {
-                                catalogXml.append("<PTZType>" + channel.getPTZType() + "</PTZType>\r\n");
+                            if (!ObjectUtils.isEmpty(channel.getPtzType())) {
+                                catalogXml.append("<PTZType>" + channel.getPtzType() + "</PTZType>\r\n");
                             }else {
                                 catalogXml.append("<PTZType></PTZType>\r\n");
                             }

File: src/main/java/com/genersoft/iot/vmp/gb28181/utils/XmlUtil.java
Patch:
@@ -568,14 +568,14 @@ public static DeviceChannel channelContentHandler(Element itemDevice, Device dev
                         String ptzTypeFromInfo = XmlUtil.getText(info, "PTZType");
                         if(!ObjectUtils.isEmpty(ptzTypeFromInfo)){
                             try {
-                                deviceChannel.setPTZType(Integer.parseInt(ptzTypeFromInfo));
+                                deviceChannel.setPtzType(Integer.parseInt(ptzTypeFromInfo));
                             }catch (NumberFormatException e){
                                 logger.warn("[xml解析] 从通道数据info中获取PTZType失败： {}", ptzTypeFromInfo);
                             }
                         }
                     } else {
                         try {
-                            deviceChannel.setPTZType(Integer.parseInt(ptzType));
+                            deviceChannel.setPtzType(Integer.parseInt(ptzType));
                         }catch (NumberFormatException e){
                             logger.warn("[xml解析] 从通道数据中获取PTZType失败： {}", ptzType);
                         }

File: src/main/java/com/genersoft/iot/vmp/service/impl/CloudRecordServiceImpl.java
Patch:
@@ -59,14 +59,14 @@ public PageInfo<CloudRecordItem> getList(int page, int count, String query, Stri
             if (!DateUtil.verification(startTime, DateUtil.formatter)) {
                 throw new ControllerException(ErrorCode.ERROR100.getCode(), "开始时间格式错误，正确格式为： " + DateUtil.formatter);
             }
-            startTimeStamp = DateUtil.yyyy_MM_dd_HH_mm_ssToTimestamp(startTime);
+            startTimeStamp = DateUtil.yyyy_MM_dd_HH_mm_ssToTimestampMs(startTime);
 
         }
         if (endTime != null ) {
             if (!DateUtil.verification(endTime, DateUtil.formatter)) {
                 throw new ControllerException(ErrorCode.ERROR100.getCode(), "结束时间格式错误，正确格式为： " + DateUtil.formatter);
             }
-            endTimeStamp = DateUtil.yyyy_MM_dd_HH_mm_ssToTimestamp(endTime);
+            endTimeStamp = DateUtil.yyyy_MM_dd_HH_mm_ssToTimestampMs(endTime);
 
         }
         PageHelper.startPage(page, count);

File: src/main/java/com/genersoft/iot/vmp/service/impl/CloudRecordServiceImpl.java
Patch:
@@ -59,14 +59,14 @@ public PageInfo<CloudRecordItem> getList(int page, int count, String query, Stri
             if (!DateUtil.verification(startTime, DateUtil.formatter)) {
                 throw new ControllerException(ErrorCode.ERROR100.getCode(), "开始时间格式错误，正确格式为： " + DateUtil.formatter);
             }
-            startTimeStamp = DateUtil.yyyy_MM_dd_HH_mm_ssToTimestamp(startTime);
+            startTimeStamp = DateUtil.yyyy_MM_dd_HH_mm_ssToTimestampMs(startTime);
 
         }
         if (endTime != null ) {
             if (!DateUtil.verification(endTime, DateUtil.formatter)) {
                 throw new ControllerException(ErrorCode.ERROR100.getCode(), "结束时间格式错误，正确格式为： " + DateUtil.formatter);
             }
-            endTimeStamp = DateUtil.yyyy_MM_dd_HH_mm_ssToTimestamp(endTime);
+            endTimeStamp = DateUtil.yyyy_MM_dd_HH_mm_ssToTimestampMs(endTime);
 
         }
         PageHelper.startPage(page, count);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/AckRequestProcessor.java
Patch:
@@ -90,6 +90,7 @@ public void afterPropertiesSet() throws Exception {
 	@Override
 	public void process(RequestEvent evt) {
 		CallIdHeader callIdHeader = (CallIdHeader)evt.getRequest().getHeader(CallIdHeader.NAME);
+		dynamicTask.stop(callIdHeader.getCallId());
 		String fromUserId = ((SipURI) ((HeaderAddress) evt.getRequest().getHeader(FromHeader.NAME)).getAddress().getURI()).getUser();
 		String toUserId = ((SipURI) ((HeaderAddress) evt.getRequest().getHeader(ToHeader.NAME)).getAddress().getURI()).getUser();
 		logger.info("[收到ACK]： 来自->{}", fromUserId);

File: src/main/java/com/genersoft/iot/vmp/storager/dao/GbStreamMapper.java
Patch:
@@ -20,7 +20,7 @@ public interface GbStreamMapper {
             "(#{app}, #{stream}, #{gbId}, #{name}, " +
             "#{longitude}, #{latitude}, #{streamType}, " +
             "#{mediaServerId}, #{createTime})")
-    @Options(useGeneratedKeys = true, keyProperty = "gbStreamId", keyColumn = "gbStreamId")
+    @Options(useGeneratedKeys = true, keyProperty = "gbStreamId", keyColumn = "gb_stream_id")
     int add(GbStream gbStream);
 
     @Update("UPDATE wvp_gb_stream " +

File: src/main/java/com/genersoft/iot/vmp/storager/dao/GbStreamMapper.java
Patch:
@@ -20,7 +20,7 @@ public interface GbStreamMapper {
             "(#{app}, #{stream}, #{gbId}, #{name}, " +
             "#{longitude}, #{latitude}, #{streamType}, " +
             "#{mediaServerId}, #{createTime})")
-    @Options(useGeneratedKeys = true, keyProperty = "gbStreamId", keyColumn = "gbStreamId")
+    @Options(useGeneratedKeys = true, keyProperty = "gbStreamId", keyColumn = "gb_stream_id")
     int add(GbStream gbStream);
 
     @Update("UPDATE wvp_gb_stream " +

File: src/main/java/com/genersoft/iot/vmp/service/ICloudRecordService.java
Patch:
@@ -39,7 +39,7 @@ String addTask(String app, String stream, MediaServerItem mediaServerItem, Strin
     /**
      * 查询合并任务列表
      */
-    JSONArray queryTask(String app, String stream, String callId, String taskId, String mediaServerId, Boolean isEnd);
+    JSONArray queryTask(String app, String stream, String callId, String taskId, String mediaServerId, Boolean isEnd, String scheme);
 
     /**
      * 收藏视频，收藏的视频过期不会删除

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlatformChannelServiceImpl.java
Patch:
@@ -134,7 +134,7 @@ private List<DeviceChannel> getDeviceChannelListByChannelReduceList(List<Channel
                     deviceChannelList.add(deviceChannel);
                 }
                 return deviceChannelList;
-            } else if (catalog == null || !catalogId.equals(platform.getDeviceGBId())) {
+            } else if (catalog == null && !catalogId.equals(platform.getDeviceGBId())) {
                 logger.warn("未查询到目录{}的信息", catalogId);
                 return null;
             }

File: src/main/java/com/genersoft/iot/vmp/conf/security/JwtUtils.java
Patch:
@@ -28,7 +28,7 @@ public class JwtUtils implements InitializingBean {
 
     private static final Logger logger = LoggerFactory.getLogger(JwtUtils.class);
 
-    private static final String HEADER = "access-token";
+    public static final String HEADER = "access-token";
 
     private static final String AUDIENCE = "Audience";
 

File: src/main/java/com/genersoft/iot/vmp/vmanager/user/UserController.java
Patch:
@@ -14,6 +14,7 @@
 import com.github.pagehelper.PageInfo;
 import io.swagger.v3.oas.annotations.Operation;
 import io.swagger.v3.oas.annotations.Parameter;
+import io.swagger.v3.oas.annotations.security.SecurityRequirement;
 import io.swagger.v3.oas.annotations.tags.Tag;
 import org.springframework.beans.factory.annotation.Autowired;
 import org.springframework.security.authentication.AuthenticationManager;
@@ -95,7 +96,7 @@ public void changePassword(@RequestParam String oldPassword, @RequestParam Strin
 
 
     @PostMapping("/add")
-    @Operation(summary = "添加用户")
+    @Operation(summary = "添加用户", security = @SecurityRequirement(name = JwtUtils.HEADER))
     @Parameter(name = "username", description = "用户名", required = true)
     @Parameter(name = "password", description = "密码（未md5加密的密码）", required = true)
     @Parameter(name = "roleId", description = "角色ID", required = true)

File: src/main/java/com/genersoft/iot/vmp/storager/impl/RedisCatchStorageImpl.java
Patch:
@@ -609,14 +609,13 @@ public int getGbSendCount(String id) {
     @Override
     public void sendDeviceOrChannelStatus(String deviceId, String channelId, boolean online) {
         String key = VideoManagerConstants.VM_MSG_SUBSCRIBE_DEVICE_STATUS;
-        logger.info("[redis通知] 发送 推送设备/通道状态， {}/{}-{}", deviceId, channelId, online);
         StringBuilder msg = new StringBuilder();
         msg.append(deviceId);
         if (channelId != null) {
             msg.append(":").append(channelId);
         }
         msg.append(" ").append(online? "ON":"OFF");
-        logger.info("[redis通知] 推送状态-> {} ", msg);
+        logger.info("[redis通知] 推送设备/通道状态-> {} ", msg);
         // 使用 RedisTemplate<Object, Object> 发送字符串消息会导致发送的消息多带了双引号
         stringRedisTemplate.convertAndSend(key, msg.toString());
     }

File: src/main/java/com/genersoft/iot/vmp/service/impl/StreamProxyServiceImpl.java
Patch:
@@ -407,6 +407,8 @@ public boolean start(String app, String stream) {
                 logger.info("启用代理失败： {}/{}->{}({})", app, stream, jsonObject.getString("msg"),
                         streamProxy.getSrcUrl() == null? streamProxy.getUrl():streamProxy.getSrcUrl());
             }
+        } else if (streamProxy != null && streamProxy.isEnable()) {
+           return true ;
         }
         return result;
     }

File: src/main/java/com/genersoft/iot/vmp/service/impl/StreamProxyServiceImpl.java
Patch:
@@ -407,6 +407,8 @@ public boolean start(String app, String stream) {
                 logger.info("启用代理失败： {}/{}->{}({})", app, stream, jsonObject.getString("msg"),
                         streamProxy.getSrcUrl() == null? streamProxy.getUrl():streamProxy.getSrcUrl());
             }
+        } else if (streamProxy != null && streamProxy.isEnable()) {
+           return true ;
         }
         return result;
     }

File: src/main/java/com/genersoft/iot/vmp/conf/security/JwtAuthenticationFilter.java
Patch:
@@ -78,6 +78,7 @@ protected void doFilterInternal(HttpServletRequest request, HttpServletResponse
 
         // 构建UsernamePasswordAuthenticationToken,这里密码为null，是因为提供了正确的JWT,实现自动登录
         User user = new User();
+        user.setId(jwtUser.getUserId());
         user.setUsername(jwtUser.getUserName());
         user.setPassword(jwtUser.getPassword());
         Role role = new Role();

File: src/main/java/com/genersoft/iot/vmp/conf/security/JwtUtils.java
Patch:
@@ -144,6 +144,7 @@ public static JwtUser verifyToken(String token) {
             jwtUser.setUserName(username);
             jwtUser.setPassword(user.getPassword());
             jwtUser.setRoleId(user.getRole().getId());
+            jwtUser.setUserId(user.getId());
 
             return jwtUser;
         } catch (InvalidJwtException e) {

File: src/main/java/com/genersoft/iot/vmp/service/impl/MediaServerServiceImpl.java
Patch:
@@ -569,7 +569,7 @@ public void setZLMConfig(MediaServerItem mediaServerItem, boolean restart) {
         Map<String, Object> param = new HashMap<>();
         param.put("api.secret",mediaServerItem.getSecret()); // -profile:v Baseline
         if (mediaServerItem.getRtspPort() != 0) {
-            param.put("ffmpeg.snap", "%s -rtsp_transport tcp -i %s -y -f mjpeg -t 0.001 %s");
+            param.put("ffmpeg.snap", "%s -rtsp_transport tcp -i %s -y -f mjpeg -frames:v 1 %s");
         }
         param.put("hook.enable","1");
         param.put("hook.on_flow_report","");

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlayServiceImpl.java
Patch:
@@ -394,7 +394,7 @@ private StreamInfo onPublishHandlerForPlayback(MediaServerItem mediaServerItem,
                 deviceChannel.setStreamId(streamInfo.getStream());
                 storager.startPlay(deviceId, channelId, streamInfo.getStream());
             }
-            InviteInfo inviteInfo = inviteStreamService.getInviteInfoByDeviceAndChannel(InviteSessionType.PLAYBACK, deviceId, channelId);
+            InviteInfo inviteInfo = inviteStreamService.getInviteInfoByStream(InviteSessionType.PLAYBACK, ((OnStreamChangedHookParam) param).getStream());
             if (inviteInfo != null) {
                 inviteInfo.setStatus(InviteSessionStatus.ok);
 

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlayServiceImpl.java
Patch:
@@ -394,7 +394,7 @@ private StreamInfo onPublishHandlerForPlayback(MediaServerItem mediaServerItem,
                 deviceChannel.setStreamId(streamInfo.getStream());
                 storager.startPlay(deviceId, channelId, streamInfo.getStream());
             }
-            InviteInfo inviteInfo = inviteStreamService.getInviteInfoByDeviceAndChannel(InviteSessionType.PLAYBACK, deviceId, channelId);
+            InviteInfo inviteInfo = inviteStreamService.getInviteInfoByStream(InviteSessionType.PLAYBACK, ((OnStreamChangedHookParam) param).getStream());
             if (inviteInfo != null) {
                 inviteInfo.setStatus(InviteSessionStatus.ok);
 

File: src/main/java/com/genersoft/iot/vmp/service/impl/InviteStreamServiceImpl.java
Patch:
@@ -257,7 +257,7 @@ public InviteInfo updateInviteInfoForSSRC(InviteInfo inviteInfo, String ssrc) {
                 ":" + inviteInfo.getDeviceId() +
                 ":" + inviteInfo.getChannelId() +
                 ":" + inviteInfo.getStream() +
-                ":" + inviteInfo.getSsrcInfo().getSsrc();
+                ":" + ssrc;
         if (inviteInfoInDb.getSsrcInfo() != null) {
             inviteInfoInDb.getSsrcInfo().setSsrc(ssrc);
         }

File: src/main/java/com/genersoft/iot/vmp/service/impl/InviteStreamServiceImpl.java
Patch:
@@ -257,7 +257,7 @@ public InviteInfo updateInviteInfoForSSRC(InviteInfo inviteInfo, String ssrc) {
                 ":" + inviteInfo.getDeviceId() +
                 ":" + inviteInfo.getChannelId() +
                 ":" + inviteInfo.getStream() +
-                ":" + inviteInfo.getSsrcInfo().getSsrc();
+                ":" + ssrc;
         if (inviteInfoInDb.getSsrcInfo() != null) {
             inviteInfoInDb.getSsrcInfo().setSsrc(ssrc);
         }

File: src/main/java/com/genersoft/iot/vmp/storager/dao/DeviceChannelMapper.java
Patch:
@@ -167,8 +167,8 @@ public interface DeviceChannelMapper {
             " <if test='query != null'> AND (dc.channel_id LIKE concat('%',#{query},'%') OR dc.name LIKE concat('%',#{query},'%') OR dc.name LIKE concat('%',#{query},'%'))</if> " +
             " <if test='online == true' > AND dc.status=true</if> " +
             " <if test='online == false' > AND dc.status=false</if> " +
-            " <if test='hasSubChannel!= null and has_sub_channel == true' >  AND dc.sub_count > 0</if> " +
-            " <if test='hasSubChannel!= null and has_sub_channel == false' >  AND dc.sub_count = 0</if> " +
+            " <if test='hasSubChannel!= null and hasSubChannel == true' >  AND dc.sub_count > 0</if> " +
+            " <if test='hasSubChannel!= null and hasSubChannel == false' >  AND dc.sub_count = 0</if> " +
             " <if test='catalogId == null ' >  AND dc.id not in (select device_channel_id from wvp_platform_gb_channel where platform_id=#{platformId} ) </if> " +
             " <if test='catalogId != null ' >  AND pgc.platform_id = #{platformId} and pgc.catalog_id=#{catalogId} </if> " +
             " ORDER BY dc.device_id, dc.channel_id ASC" +

File: src/main/java/com/genersoft/iot/vmp/storager/dao/DeviceChannelMapper.java
Patch:
@@ -167,8 +167,8 @@ public interface DeviceChannelMapper {
             " <if test='query != null'> AND (dc.channel_id LIKE concat('%',#{query},'%') OR dc.name LIKE concat('%',#{query},'%') OR dc.name LIKE concat('%',#{query},'%'))</if> " +
             " <if test='online == true' > AND dc.status=true</if> " +
             " <if test='online == false' > AND dc.status=false</if> " +
-            " <if test='hasSubChannel!= null and has_sub_channel == true' >  AND dc.sub_count > 0</if> " +
-            " <if test='hasSubChannel!= null and has_sub_channel == false' >  AND dc.sub_count = 0</if> " +
+            " <if test='hasSubChannel!= null and hasSubChannel == true' >  AND dc.sub_count > 0</if> " +
+            " <if test='hasSubChannel!= null and hasSubChannel == false' >  AND dc.sub_count = 0</if> " +
             " <if test='catalogId == null ' >  AND dc.id not in (select device_channel_id from wvp_platform_gb_channel where platform_id=#{platformId} ) </if> " +
             " <if test='catalogId != null ' >  AND pgc.platform_id = #{platformId} and pgc.catalog_id=#{catalogId} </if> " +
             " ORDER BY dc.device_id, dc.channel_id ASC" +

File: src/main/java/com/genersoft/iot/vmp/service/impl/MediaServerServiceImpl.java
Patch:
@@ -128,7 +128,7 @@ public void updateVmServer(List<MediaServerItem>  mediaServerItemList) {
                 continue;
             }
             // 更新
-            if (ssrcFactory.hasMediaServerSSRC(mediaServerItem.getId())) {
+            if (!ssrcFactory.hasMediaServerSSRC(mediaServerItem.getId())) {
                 ssrcFactory.initMediaServerSSRC(mediaServerItem.getId(), null);
             }
             // 查询redis是否存在此mediaServer
@@ -229,7 +229,7 @@ public void update(MediaServerItem mediaSerItem) {
         mediaServerMapper.update(mediaSerItem);
         MediaServerItem mediaServerItemInRedis = getOne(mediaSerItem.getId());
         MediaServerItem mediaServerItemInDataBase = mediaServerMapper.queryOne(mediaSerItem.getId());
-        if (mediaServerItemInRedis == null || ssrcFactory.hasMediaServerSSRC(mediaSerItem.getId())) {
+        if (mediaServerItemInRedis == null || !ssrcFactory.hasMediaServerSSRC(mediaSerItem.getId())) {
             ssrcFactory.initMediaServerSSRC(mediaServerItemInDataBase.getId(),null);
         }
         String key = VideoManagerConstants.MEDIA_SERVER_PREFIX + userSetting.getServerId() + "_" + mediaServerItemInDataBase.getId();
@@ -411,7 +411,7 @@ public void zlmServerOnline(ZLMServerConfig zlmServerConfig) {
         }
         mediaServerMapper.update(serverItem);
         String key = VideoManagerConstants.MEDIA_SERVER_PREFIX + userSetting.getServerId() + "_" + zlmServerConfig.getGeneralMediaServerId();
-        if (ssrcFactory.hasMediaServerSSRC(serverItem.getId())) {
+        if (!ssrcFactory.hasMediaServerSSRC(serverItem.getId())) {
             ssrcFactory.initMediaServerSSRC(zlmServerConfig.getGeneralMediaServerId(), null);
         }
         redisTemplate.opsForValue().set(key, serverItem);

File: src/main/java/com/genersoft/iot/vmp/service/impl/MediaServerServiceImpl.java
Patch:
@@ -128,7 +128,7 @@ public void updateVmServer(List<MediaServerItem>  mediaServerItemList) {
                 continue;
             }
             // 更新
-            if (ssrcFactory.hasMediaServerSSRC(mediaServerItem.getId())) {
+            if (!ssrcFactory.hasMediaServerSSRC(mediaServerItem.getId())) {
                 ssrcFactory.initMediaServerSSRC(mediaServerItem.getId(), null);
             }
             // 查询redis是否存在此mediaServer
@@ -229,7 +229,7 @@ public void update(MediaServerItem mediaSerItem) {
         mediaServerMapper.update(mediaSerItem);
         MediaServerItem mediaServerItemInRedis = getOne(mediaSerItem.getId());
         MediaServerItem mediaServerItemInDataBase = mediaServerMapper.queryOne(mediaSerItem.getId());
-        if (mediaServerItemInRedis == null || ssrcFactory.hasMediaServerSSRC(mediaSerItem.getId())) {
+        if (mediaServerItemInRedis == null || !ssrcFactory.hasMediaServerSSRC(mediaSerItem.getId())) {
             ssrcFactory.initMediaServerSSRC(mediaServerItemInDataBase.getId(),null);
         }
         String key = VideoManagerConstants.MEDIA_SERVER_PREFIX + userSetting.getServerId() + "_" + mediaServerItemInDataBase.getId();
@@ -411,7 +411,7 @@ public void zlmServerOnline(ZLMServerConfig zlmServerConfig) {
         }
         mediaServerMapper.update(serverItem);
         String key = VideoManagerConstants.MEDIA_SERVER_PREFIX + userSetting.getServerId() + "_" + zlmServerConfig.getGeneralMediaServerId();
-        if (ssrcFactory.hasMediaServerSSRC(serverItem.getId())) {
+        if (!ssrcFactory.hasMediaServerSSRC(serverItem.getId())) {
             ssrcFactory.initMediaServerSSRC(zlmServerConfig.getGeneralMediaServerId(), null);
         }
         redisTemplate.opsForValue().set(key, serverItem);

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/play/PlayController.java
Patch:
@@ -359,7 +359,7 @@ public DeferredResult<String> getSnap(String deviceId, String channelId,boolean
 		message.setKey(key);
 		message.setId(uuid);
 
-		String fileName = deviceId + "_" + channelId + "_" + DateUtil.getNowForUrl() + "jpg";
+		String fileName = deviceId + "_" + channelId + "_" + DateUtil.getNowForUrl() + ".jpg";
 		playService.getSnap(deviceId, channelId, fileName, (code, msg, data) -> {
 			if (code == InviteErrorCode.SUCCESS.getCode()) {
 				message.setData(data);

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/play/PlayController.java
Patch:
@@ -359,7 +359,7 @@ public DeferredResult<String> getSnap(String deviceId, String channelId,boolean
 		message.setKey(key);
 		message.setId(uuid);
 
-		String fileName = deviceId + "_" + channelId + "_" + DateUtil.getNowForUrl() + "jpg";
+		String fileName = deviceId + "_" + channelId + "_" + DateUtil.getNowForUrl() + ".jpg";
 		playService.getSnap(deviceId, channelId, fileName, (code, msg, data) -> {
 			if (code == InviteErrorCode.SUCCESS.getCode()) {
 				message.setData(data);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/impl/SIPCommanderFroPlatform.java
Patch:
@@ -731,7 +731,7 @@ public void recordInfo(DeviceChannel deviceChannel, ParentPlatform parentPlatfor
                 .append("<Response>\r\n")
                 .append("<CmdType>RecordInfo</CmdType>\r\n")
                 .append("<SN>" +recordInfo.getSn() + "</SN>\r\n")
-                .append("<DeviceID>" + recordInfo.getDeviceId() + "</DeviceID>\r\n")
+                .append("<DeviceID>" + recordInfo.getChannelId() + "</DeviceID>\r\n")
                 .append("<SumNum>" + recordInfo.getSumNum() + "</SumNum>\r\n");
         if (recordInfo.getRecordList() == null ) {
             recordXml.append("<RecordList Num=\"0\">\r\n");

File: src/main/java/com/genersoft/iot/vmp/service/impl/StreamProxyServiceImpl.java
Patch:
@@ -130,9 +130,6 @@ public void save(StreamProxyItem param, GeneralCallback<StreamInfo> callback) {
                 port = mediaInfo.getRtspPort();
                 schemaForUri = schema;
             }else if (schema.equalsIgnoreCase("flv")) {
-                port = mediaInfo.getHttpPort();
-                schemaForUri = "http";
-            }else if (schema.equalsIgnoreCase("rtmp")) {
                 port = mediaInfo.getRtmpPort();
                 schemaForUri = schema;
             }else {

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMRESTfulUtils.java
Patch:
@@ -192,10 +192,10 @@ public void sendGetForImg(MediaServerItem mediaServerItem, String api, Map<Strin
                 } else {
                     logger.error(String.format("[ %s ]请求失败: %s %s", url, response.code(), response.message()));
                 }
-                Objects.requireNonNull(response.body()).close();
             } else {
                 logger.error(String.format("[ %s ]请求失败: %s %s", url, response.code(), response.message()));
             }
+            Objects.requireNonNull(response.body()).close();
         } catch (ConnectException e) {
             logger.error(String.format("连接ZLM失败: %s, %s", e.getCause().getMessage(), e.getMessage()));
             logger.info("请检查media配置并确认ZLM已启动...");

File: src/main/java/com/genersoft/iot/vmp/jt1078/config/JT1078AutoConfiguration.java
Patch:
@@ -16,7 +16,7 @@
 @Order(Integer.MIN_VALUE)
 @Configuration
 @ConditionalOnProperty(value = "jt1078.enable", havingValue = "true")
-public class TcpAutoConfiguration {
+public class JT1078AutoConfiguration {
 
     @Bean(initMethod = "start", destroyMethod = "stop")
     public TcpServer jt1078Server(@Value("${jt1078.port}") Integer port) {

File: src/main/java/com/genersoft/iot/vmp/jt1078/proc/response/J9101.java
Patch:
@@ -6,6 +6,8 @@
 import io.netty.util.CharsetUtil;
 
 /**
+ * 实时音视频传输请求
+ *
  * @author QingtaiJiang
  * @date 2023/4/27 18:25
  * @email qingtaij@163.com

File: src/main/java/com/genersoft/iot/vmp/jt1078/session/SessionManager.java
Patch:
@@ -76,13 +76,13 @@ public String request(Cmd cmd, Integer timeOut) {
         Session session = this.get(cmd.getDevId());
         if (session == null) {
             log.error("DevId: {} not online!", cmd.getDevId());
-            return "-1";
+            return null;
         }
         String requestKey = requestKey(cmd.getDevId(), cmd.getRespId(), cmd.getPackageNo());
         SynchronousQueue<String> subscribe = subscribe(requestKey);
         if (subscribe == null) {
             log.error("DevId: {} key:{} send repaid", cmd.getDevId(), requestKey);
-            return "-1";
+            return null;
         }
         session.writeObject(cmd);
         try {
@@ -105,7 +105,7 @@ public Boolean response(String devId, String respId, Long responseNo, String dat
                 log.error("{}", e.getMessage(), e);
             }
         }
-        log.warn("未找到对应回复指令,key:{} 消息:{} ", requestKey, data);
+        log.warn("Not find response,key:{} data:{} ", requestKey, data);
         return false;
     }
 

File: src/main/java/com/genersoft/iot/vmp/jt1078/config/JT1078AutoConfiguration.java
Patch:
@@ -16,7 +16,7 @@
 @Order(Integer.MIN_VALUE)
 @Configuration
 @ConditionalOnProperty(value = "jt1078.enable", havingValue = "true")
-public class TcpAutoConfiguration {
+public class JT1078AutoConfiguration {
 
     @Bean(initMethod = "start", destroyMethod = "stop")
     public TcpServer jt1078Server(@Value("${jt1078.port}") Integer port) {

File: src/main/java/com/genersoft/iot/vmp/jt1078/proc/response/J9101.java
Patch:
@@ -6,6 +6,8 @@
 import io.netty.util.CharsetUtil;
 
 /**
+ * 实时音视频传输请求
+ *
  * @author QingtaiJiang
  * @date 2023/4/27 18:25
  * @email qingtaij@163.com

File: src/main/java/com/genersoft/iot/vmp/jt1078/session/SessionManager.java
Patch:
@@ -76,13 +76,13 @@ public String request(Cmd cmd, Integer timeOut) {
         Session session = this.get(cmd.getDevId());
         if (session == null) {
             log.error("DevId: {} not online!", cmd.getDevId());
-            return "-1";
+            return null;
         }
         String requestKey = requestKey(cmd.getDevId(), cmd.getRespId(), cmd.getPackageNo());
         SynchronousQueue<String> subscribe = subscribe(requestKey);
         if (subscribe == null) {
             log.error("DevId: {} key:{} send repaid", cmd.getDevId(), requestKey);
-            return "-1";
+            return null;
         }
         session.writeObject(cmd);
         try {
@@ -105,7 +105,7 @@ public Boolean response(String devId, String respId, Long responseNo, String dat
                 log.error("{}", e.getMessage(), e);
             }
         }
-        log.warn("未找到对应回复指令,key:{} 消息:{} ", requestKey, data);
+        log.warn("Not find response,key:{} data:{} ", requestKey, data);
         return false;
     }
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/utils/SipUtils.java
Patch:
@@ -142,8 +142,8 @@ public static RemoteAddressInfo getRemoteAddressFromRequest(SIPRequest request,
             remotePort = request.getTopmostViaHeader().getRPort();
             // 解析本地地址替代
             if (ObjectUtils.isEmpty(remoteAddress) || remotePort == -1) {
-                remoteAddress = request.getTopmostViaHeader().getHost();
-                remotePort = request.getTopmostViaHeader().getPort();
+                remoteAddress = request.getRemoteAddress().getHostAddress();
+                remotePort = request.getRemotePort();
             }
         }
 

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlayServiceImpl.java
Patch:
@@ -398,7 +398,9 @@ public void play(MediaServerItem mediaServerItem, SSRCInfo ssrcInfo, Device devi
             mediaServerService.releaseSsrc(mediaServerItem.getId(), ssrcInfo.getSsrc());
 
             streamSession.remove(device.getDeviceId(), channelId, ssrcInfo.getStream());
-            SipSubscribe.EventResult eventResult = new SipSubscribe.EventResult(new CmdSendFailEvent(null));
+            SipSubscribe.EventResult eventResult = new SipSubscribe.EventResult();
+            eventResult.type = SipSubscribe.EventResultType.cmdSendFailEvent;
+            eventResult.statusCode = -1;
             eventResult.msg = "命令发送失败";
             errorEvent.response(eventResult);
         }

File: src/main/java/com/genersoft/iot/vmp/service/impl/MediaServerServiceImpl.java
Patch:
@@ -547,7 +547,9 @@ public void setZLMConfig(MediaServerItem mediaServerItem, boolean restart) {
 
         Map<String, Object> param = new HashMap<>();
         param.put("api.secret",mediaServerItem.getSecret()); // -profile:v Baseline
-        param.put("ffmpeg.snap", "%s -rtsp_transport tcp -i %s -y -f mjpeg -t 0.001 %s");
+        if (mediaServerItem.getRtspPort() != 0) {
+            param.put("ffmpeg.snap", "%s -rtsp_transport tcp -i %s -y -f mjpeg -t 0.001 %s");
+        }
         param.put("hook.enable","1");
         param.put("hook.on_flow_report","");
         param.put("hook.on_play",String.format("%s/on_play", hookPrex));

File: src/main/java/com/genersoft/iot/vmp/vmanager/user/UserController.java
Patch:
@@ -83,8 +83,8 @@ public void changePassword(@RequestParam String oldPassword, @RequestParam Strin
             if (user == null) {
                 throw new ControllerException(ErrorCode.ERROR100);
             }
-            int userId = SecurityUtils.getUserId();
-            boolean result = userService.changePassword(userId, DigestUtils.md5DigestAsHex(password.getBytes()));
+            //int userId = SecurityUtils.getUserId();
+            boolean result = userService.changePassword(user.getId(), DigestUtils.md5DigestAsHex(password.getBytes()));
             if (!result) {
                 throw new ControllerException(ErrorCode.ERROR100);
             }

File: src/main/java/com/genersoft/iot/vmp/service/impl/MediaServerServiceImpl.java
Patch:
@@ -547,7 +547,9 @@ public void setZLMConfig(MediaServerItem mediaServerItem, boolean restart) {
 
         Map<String, Object> param = new HashMap<>();
         param.put("api.secret",mediaServerItem.getSecret()); // -profile:v Baseline
-        param.put("ffmpeg.snap", "%s -rtsp_transport tcp -i %s -y -f mjpeg -t 0.001 %s");
+        if (mediaServerItem.getRtspPort() != 0) {
+            param.put("ffmpeg.snap", "%s -rtsp_transport tcp -i %s -y -f mjpeg -t 0.001 %s");
+        }
         param.put("hook.enable","1");
         param.put("hook.on_flow_report","");
         param.put("hook.on_play",String.format("%s/on_play", hookPrex));

File: src/main/java/com/genersoft/iot/vmp/vmanager/user/UserController.java
Patch:
@@ -83,8 +83,8 @@ public void changePassword(@RequestParam String oldPassword, @RequestParam Strin
             if (user == null) {
                 throw new ControllerException(ErrorCode.ERROR100);
             }
-            int userId = SecurityUtils.getUserId();
-            boolean result = userService.changePassword(userId, DigestUtils.md5DigestAsHex(password.getBytes()));
+            //int userId = SecurityUtils.getUserId();
+            boolean result = userService.changePassword(user.getId(), DigestUtils.md5DigestAsHex(password.getBytes()));
             if (!result) {
                 throw new ControllerException(ErrorCode.ERROR100);
             }

File: src/main/java/com/genersoft/iot/vmp/storager/dao/DeviceMapper.java
Patch:
@@ -42,7 +42,8 @@ public interface DeviceMapper {
             "asMessageChannel," +
             "geoCoordSys," +
             "treeType," +
-            "online" +
+            "online," +
+            "(SELECT count(0) FROM device_channel WHERE deviceId=device.deviceId) as channelCount "+
             " FROM device WHERE deviceId = #{deviceId}")
     Device getDeviceByDeviceId(String deviceId);
 

File: src/main/java/com/genersoft/iot/vmp/storager/dao/DeviceMapper.java
Patch:
@@ -42,7 +42,8 @@ public interface DeviceMapper {
             "asMessageChannel," +
             "geoCoordSys," +
             "treeType," +
-            "online" +
+            "online," +
+            "(SELECT count(0) FROM device_channel WHERE deviceId=device.deviceId) as channelCount "+
             " FROM device WHERE deviceId = #{deviceId}")
     Device getDeviceByDeviceId(String deviceId);
 

File: src/main/java/com/genersoft/iot/vmp/service/impl/StreamPushServiceImpl.java
Patch:
@@ -366,7 +366,7 @@ public void batchAddForUpload(List<StreamPushItem> streamPushItems, Map<String,
         // 存储数据到stream_push表
         streamPushMapper.addAll(streamPushItems);
         List<StreamPushItem> streamPushItemForGbStream = streamPushItems.stream()
-                .filter(streamPushItem-> streamPushItem.getId() != null)
+                .filter(streamPushItem-> streamPushItem.getGbId() != null)
                 .collect(Collectors.toList());
         // 存储数据到gb_stream表， id会返回到streamPushItemForGbStream里
         if (streamPushItemForGbStream.size() > 0) {

File: src/main/java/com/genersoft/iot/vmp/storager/IVideoManagerStorage.java
Patch:
@@ -56,7 +56,7 @@ public interface IVideoManagerStorage {
 	 * @param count 每页数量
 	 * @return
 	 */
-	public PageInfo queryChannelsByDeviceId(String deviceId, String query, Boolean hasSubChannel, Boolean online, Boolean catalogUnderDevice, int page, int count);
+	public PageInfo<DeviceChannel> queryChannelsByDeviceId(String deviceId, String query, Boolean hasSubChannel, Boolean online, Boolean catalogUnderDevice, int page, int count);
 	
 	public List<DeviceChannel> queryChannelsByDeviceIdWithStartAndLimit(String deviceId, String query, Boolean hasSubChannel, Boolean online, int start, int limit,List<String> channelIds);
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/InviteRequestProcessor.java
Patch:
@@ -314,7 +314,7 @@ public void process(RequestEvent evt) {
                     return;
                 }
                 String username = sdp.getOrigin().getUsername();
-                String addressStr = sdp.getOrigin().getAddress();
+                String addressStr = sdp.getConnection().getAddress();
 
                 logger.info("[上级点播]用户：{}， 通道：{}, 地址：{}:{}， ssrc：{}", username, channelId, addressStr, port, ssrc);
                 Device device = null;
@@ -912,7 +912,7 @@ public void inviteFromDeviceHandle(SIPRequest request, String requesterId) {
                     return;
                 }
                 String username = sdp.getOrigin().getUsername();
-                String addressStr = sdp.getOrigin().getAddress();
+                String addressStr = sdp.getConnection().getAddress();
                 logger.info("设备{}请求语音流，地址：{}:{}，ssrc：{}", username, addressStr, port, ssrc);
             } catch (SdpException e) {
                 logger.error("[SDP解析异常]", e);

File: src/main/java/com/genersoft/iot/vmp/utils/JsonUtil.java
Patch:
@@ -27,11 +27,10 @@ private JsonUtil() {
      * @return result type
      */
     public static <T> T redisJsonToObject(String key, Class<T> clazz) {
-        JSONObject jsonObject = (JSONObject) RedisUtil.get(key);
+        Object jsonObject = RedisUtil.get(key);
         if (Objects.isNull(jsonObject)) {
             return null;
         }
-        return JSON.parseObject(jsonObject.toJSONString(), clazz);
+        return clazz.cast(jsonObject);
     }
-
 }
\ No newline at end of file

File: src/main/java/com/genersoft/iot/vmp/gb28181/session/VideoStreamSessionManager.java
Patch:
@@ -4,6 +4,7 @@
 import com.genersoft.iot.vmp.conf.UserSetting;
 import com.genersoft.iot.vmp.gb28181.bean.SipTransactionInfo;
 import com.genersoft.iot.vmp.gb28181.bean.SsrcTransaction;
+import com.genersoft.iot.vmp.utils.JsonUtil;
 import com.genersoft.iot.vmp.utils.redis.RedisUtil;
 import gov.nist.javax.sip.message.SIPResponse;
 import org.springframework.beans.factory.annotation.Autowired;
@@ -133,7 +134,7 @@ public List<SsrcTransaction> getAllSsrc() {
 		List<SsrcTransaction> result= new ArrayList<>();
 		for (int i = 0; i < ssrcTransactionKeys.size(); i++) {
 			String key = (String)ssrcTransactionKeys.get(i);
-			SsrcTransaction ssrcTransaction = (SsrcTransaction)RedisUtil.get(key);
+			SsrcTransaction ssrcTransaction = JsonUtil.redisJsonToObject(key, SsrcTransaction.class);
 			result.add(ssrcTransaction);
 		}
 		return result;

File: src/main/java/com/genersoft/iot/vmp/gb28181/session/VideoStreamSessionManager.java
Patch:
@@ -4,6 +4,7 @@
 import com.genersoft.iot.vmp.conf.UserSetting;
 import com.genersoft.iot.vmp.gb28181.bean.SipTransactionInfo;
 import com.genersoft.iot.vmp.gb28181.bean.SsrcTransaction;
+import com.genersoft.iot.vmp.utils.JsonUtil;
 import com.genersoft.iot.vmp.utils.redis.RedisUtil;
 import gov.nist.javax.sip.message.SIPResponse;
 import org.springframework.beans.factory.annotation.Autowired;
@@ -133,7 +134,7 @@ public List<SsrcTransaction> getAllSsrc() {
 		List<SsrcTransaction> result= new ArrayList<>();
 		for (int i = 0; i < ssrcTransactionKeys.size(); i++) {
 			String key = (String)ssrcTransactionKeys.get(i);
-			SsrcTransaction ssrcTransaction = (SsrcTransaction)RedisUtil.get(key);
+			SsrcTransaction ssrcTransaction = JsonUtil.redisJsonToObject(key, SsrcTransaction.class);
 			result.add(ssrcTransaction);
 		}
 		return result;

File: src/main/java/com/genersoft/iot/vmp/conf/MediaStatusTimerTask.java
Patch:
@@ -1,6 +1,5 @@
 package com.genersoft.iot.vmp.conf;
 
-import com.alibaba.fastjson.JSONObject;
 import org.springframework.scheduling.annotation.Scheduled;
 
 /**

File: src/main/java/com/genersoft/iot/vmp/conf/WVPTimerTask.java
Patch:
@@ -1,6 +1,6 @@
 package com.genersoft.iot.vmp.conf;
 
-import com.alibaba.fastjson.JSONObject;
+import com.alibaba.fastjson2.JSONObject;
 import com.genersoft.iot.vmp.service.IMediaServerService;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
 import org.springframework.beans.factory.annotation.Autowired;

File: src/main/java/com/genersoft/iot/vmp/conf/security/LoginSuccessHandler.java
Patch:
@@ -11,6 +11,9 @@
 import javax.servlet.http.HttpServletResponse;
 import java.io.IOException;
 
+/**
+ * @author lin
+ */
 @Component
 public class LoginSuccessHandler implements AuthenticationSuccessHandler {
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/bean/ParentPlatformCatch.java
Patch:
@@ -4,7 +4,9 @@ public class ParentPlatformCatch {
 
     private String id;
 
-    // 心跳未回复次数
+    /**
+     * 心跳未回复次数
+     */
     private int keepAliveReply;
 
     // 注册未回复次数

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/alarm/AlarmEventListener.java
Patch:
@@ -51,7 +51,6 @@ public void onApplicationEvent(AlarmEvent event) {
                 }
                 // 移除已关闭的连接
                 it.remove();
-                // e.printStackTrace();
             }
         }
     }

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/CancelRequestProcessor.java
Patch:
@@ -15,7 +15,7 @@
 @Component
 public class CancelRequestProcessor extends SIPRequestProcessorParent implements InitializingBean, ISIPRequestProcessor {
 
-	private String method = "CANCEL";
+	private final String method = "CANCEL";
 
 	@Autowired
 	private SIPProcessorObserver sipProcessorObserver;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/notify/NotifyMessageHandler.java
Patch:
@@ -7,8 +7,9 @@
 import org.springframework.stereotype.Component;
 
 /**
- * 命令类型： 通知命令
+ * 命令类型： 通知命令， 参看 A.2.5 通知命令
  * 命令类型： 状态信息(心跳)报送, 报警通知, 媒体通知, 移动设备位置数据，语音广播通知(TODO), 设备预置位(TODO)
+ * @author lin
  */
 @Component
 public class NotifyMessageHandler extends MessageHandlerAbstract implements InitializingBean  {

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/AlarmResponseMessageHandler.java
Patch:
@@ -1,6 +1,6 @@
 package com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.response.cmd;
 
-import com.alibaba.fastjson.JSONObject;
+import com.alibaba.fastjson2.JSONObject;
 import com.genersoft.iot.vmp.gb28181.bean.Device;
 import com.genersoft.iot.vmp.gb28181.bean.ParentPlatform;
 import com.genersoft.iot.vmp.gb28181.transmit.callback.DeferredResultHolder;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/DeviceConfigResponseMessageHandler.java
Patch:
@@ -1,6 +1,6 @@
 package com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.response.cmd;
 
-import com.alibaba.fastjson.JSONObject;
+import com.alibaba.fastjson2.JSONObject;
 import com.genersoft.iot.vmp.gb28181.bean.Device;
 import com.genersoft.iot.vmp.gb28181.bean.ParentPlatform;
 import com.genersoft.iot.vmp.gb28181.transmit.callback.DeferredResultHolder;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/response/impl/ByeResponseProcessor.java
Patch:
@@ -17,7 +17,7 @@
 @Component
 public class ByeResponseProcessor extends SIPResponseProcessorAbstract {
 
-	private String method = "BYE";
+	private final String method = "BYE";
 
 	@Autowired
 	private SipLayer sipLayer;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/response/impl/CancelResponseProcessor.java
Patch:
@@ -17,7 +17,7 @@
 @Component
 public class CancelResponseProcessor extends SIPResponseProcessorAbstract {
 
-	private String method = "CANCEL";
+	private final String method = "CANCEL";
 
 	@Autowired
 	private SipLayer sipLayer;

File: src/main/java/com/genersoft/iot/vmp/common/StreamInfo.java
Patch:
@@ -236,8 +236,8 @@ public void setTs(String host, int port, int sslPort, String app, String stream,
         }
     }
 
-    public void setRtc(String host, int port, int sslPort, String app, String stream, String callIdParam) {
-        String file = String.format("index/api/webrtc?app=%s&stream=%s&type=play%s", app, stream, callIdParam);
+    public void setRtc(String host, int port, int sslPort, String app, String stream, String callIdParam, boolean isPlay) {
+        String file = String.format("index/api/webrtc?app=%s&stream=%s&type=%s%s", app, stream, isPlay?"play":"push", callIdParam);
         if (port > 0) {
             this.rtc = new StreamURL("http", host, port, file);
         }

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/NotifyRequestProcessor.java
Patch:
@@ -127,8 +127,6 @@ public void process(RequestEvent evt) {
 					}
 				}catch (Exception e) {
 					logger.error("处理NOTIFY消息时错误", e);
-				}finally {
-					taskQueueHandlerRun = false;
 				}
 			});
 		}

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/NotifyRequestProcessor.java
Patch:
@@ -124,10 +124,9 @@ public void process(RequestEvent evt) {
 							}
 						} catch (DocumentException e) {
 							logger.error("处理NOTIFY消息时错误", e);
-						} finally {
-							taskQueueHandlerRun = false;
 						}
 					}
+					taskQueueHandlerRun = false;
 				});
 			}
 		} catch (SipException | InvalidArgumentException | ParseException e) {

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/RecordInfoResponseMessageHandler.java
Patch:
@@ -148,10 +148,9 @@ public void handForDevice(RequestEvent evt, Device device, Element rootElement)
                             }
                         } catch (DocumentException e) {
                             logger.error("xml解析异常： ", e);
-                        } finally {
-                            taskQueueHandlerRun = false;
                         }
                     }
+                    taskQueueHandlerRun = false;
                 });
             }
 

File: src/main/java/com/genersoft/iot/vmp/service/redisMsg/RedisAlarmMsgListener.java
Patch:
@@ -18,6 +18,7 @@
 
 import javax.sip.InvalidArgumentException;
 import javax.sip.SipException;
+import javax.validation.constraints.NotNull;
 import java.text.ParseException;
 import java.util.List;
 import java.util.concurrent.ConcurrentLinkedQueue;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/SIPProcessorObserver.java
Patch:
@@ -71,7 +71,6 @@ public void addTimeoutProcessor(ITimeoutProcessor processor) {
     @Override
     @Async
     public void processRequest(RequestEvent requestEvent) {
-        logger.debug("\n收到请求：\n{}", requestEvent.getRequest());
         String method = requestEvent.getRequest().getMethod();
         ISIPRequestProcessor sipRequestProcessor = requestProcessorMap.get(method);
         if (sipRequestProcessor == null) {
@@ -90,7 +89,6 @@ public void processRequest(RequestEvent requestEvent) {
     @Async
     public void processResponse(ResponseEvent responseEvent) {
         Response response = responseEvent.getResponse();
-        logger.debug("\n收到响应：\n{}", responseEvent.getResponse());
         int status = response.getStatusCode();
 
         if (((status >= 200) && (status < 300)) || status == Response.UNAUTHORIZED) { // Success!

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/impl/SIPCommander.java
Patch:
@@ -640,7 +640,7 @@ public void downloadStreamCmd(MediaServerItem mediaServerItem, SSRCInfo ssrcInfo
 						hookEvent.call(new InviteStreamInfo(mediaServerItem, json, callIdHeader.getCallId(), "rtp", ssrcInfo.getStream()));
 						subscribe.removeSubscribe(hookSubscribe);
 						hookSubscribe.getContent().put("regist", false);
-						hookSubscribe.getContent().put("schema", "rtmp");
+						hookSubscribe.getContent().put("schema", "rtsp");
 						// 添加流注销的订阅，注销了后向设备发送bye
 						subscribe.addSubscribe(hookSubscribe,
 								(MediaServerItem mediaServerItemForEnd, JSONObject jsonForEnd)->{

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/InviteRequestProcessor.java
Patch:
@@ -410,6 +410,7 @@ public void process(RequestEvent evt) {
                                 streamId = String.format("%s_%s", device.getDeviceId(), channelId);
                             }
                             SSRCInfo ssrcInfo = mediaServerService.openRTPServer(mediaServerItem, streamId, null, device.isSsrcCheck(), false);
+                            logger.info(JSONObject.toJSONString(ssrcInfo));
                             sendRtpItem.setStreamId(ssrcInfo.getStream());
                             // 写入redis， 超时时回复
                             redisCatchStorage.updateSendRTPSever(sendRtpItem);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/SubscribeRequestProcessor.java
Patch:
@@ -180,7 +180,6 @@ private void processNotifyAlarm(RequestEvent evt, Element rootElement) {
 
 	private void processNotifyCatalogList(RequestEvent evt, Element rootElement) throws SipException {
 
-		System.out.println(evt.getRequest().toString());
 		String platformId = SipUtils.getUserIdFromFromHeader(evt.getRequest());
 		String deviceId = XmlUtil.getText(rootElement, "DeviceID");
 		ParentPlatform platform = storager.queryParentPlatByServerGBId(platformId);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/notify/cmd/AlarmNotifyMessageHandler.java
Patch:
@@ -164,7 +164,7 @@ public void handForDevice(RequestEvent evt, Device device, Element rootElement)
             }
         }
 
-        if (channelId.equals(sipConfig.getId())) {
+        if ("7".equals(deviceAlarm.getAlarmMethod()) ) {
             // 发送给平台的报警信息。 发送redis通知
             AlarmChannelMessage alarmChannelMessage = new AlarmChannelMessage();
             alarmChannelMessage.setAlarmSn(Integer.parseInt(deviceAlarm.getAlarmMethod()));

File: src/main/java/com/genersoft/iot/vmp/service/impl/MediaServerServiceImpl.java
Patch:
@@ -417,7 +417,7 @@ public void resetOnlineServerItem(MediaServerItem serverItem) {
         if (RedisUtil.zScore(key, serverItem.getId()) == null) {  // 不存在则设置默认值 已存在则重置
             RedisUtil.zAdd(key, serverItem.getId(), 0L);
             // 查询服务流数量
-            zlmresTfulUtils.getMediaList(serverItem, null, null, "rtmp",(mediaList ->{
+            zlmresTfulUtils.getMediaList(serverItem, null, null, "rtsp",(mediaList ->{
                 Integer code = mediaList.getInteger("code");
                 if (code == 0) {
                     JSONArray data = mediaList.getJSONArray("data");

File: src/main/java/com/genersoft/iot/vmp/service/impl/MediaServiceImpl.java
Patch:
@@ -112,6 +112,7 @@ public StreamInfo getStreamInfoByAppAndStream(MediaServerItem mediaInfo, String
         streamInfoResult.setWs_fmp4(String.format("ws://%s:%s/%s/%s.live.mp4%s", addr, mediaInfo.getHttpPort(), app,  stream, callIdParam));
         streamInfoResult.setTs(String.format("http://%s:%s/%s/%s.live.ts%s", addr, mediaInfo.getHttpPort(), app,  stream, callIdParam));
         streamInfoResult.setWs_ts(String.format("ws://%s:%s/%s/%s.live.ts%s", addr, mediaInfo.getHttpPort(), app,  stream, callIdParam));
+        streamInfoResult.setRtc(String.format("http://%s:%s/index/api/webrtc?app=%s&stream=%s&type=play%s", mediaInfo.getStreamIp(), mediaInfo.getHttpPort(), app,  stream, ObjectUtils.isEmpty(callId)?"":"&callId=" + callId));
         if (mediaInfo.getHttpSSlPort() != 0) {
             streamInfoResult.setHttps_flv(String.format("https://%s:%s/%s/%s.live.flv%s", addr, mediaInfo.getHttpSSlPort(), app,  stream, callIdParam));
             streamInfoResult.setWss_flv(String.format("wss://%s:%s/%s/%s.live.flv%s", addr, mediaInfo.getHttpSSlPort(), app,  stream, callIdParam));
@@ -122,7 +123,7 @@ public StreamInfo getStreamInfoByAppAndStream(MediaServerItem mediaInfo, String
             streamInfoResult.setHttps_ts(String.format("https://%s:%s/%s/%s.live.ts%s", addr, mediaInfo.getHttpSSlPort(), app,  stream, callIdParam));
             streamInfoResult.setWss_ts(String.format("wss://%s:%s/%s/%s.live.ts%s", addr, mediaInfo.getHttpSSlPort(), app,  stream, callIdParam));
             streamInfoResult.setWss_ts(String.format("wss://%s:%s/%s/%s.live.ts%s", addr, mediaInfo.getHttpSSlPort(), app,  stream, callIdParam));
-            streamInfoResult.setRtc(String.format("https://%s:%s/index/api/webrtc?app=%s&stream=%s&type=play%s", mediaInfo.getStreamIp(), mediaInfo.getHttpSSlPort(), app,  stream, ObjectUtils.isEmpty(callId)?"":"&callId=" + callId));
+            streamInfoResult.setRtcs(String.format("https://%s:%s/index/api/webrtc?app=%s&stream=%s&type=play%s", mediaInfo.getStreamIp(), mediaInfo.getHttpSSlPort(), app,  stream, ObjectUtils.isEmpty(callId)?"":"&callId=" + callId));
         }
 
         streamInfoResult.setTracks(tracks);

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlayServiceImpl.java
Patch:
@@ -195,6 +195,7 @@ public PlayResult play(MediaServerItem mediaServerItem, String deviceId, String
                 streamId = String.format("%s_%s", device.getDeviceId(), channelId);
             }
             SSRCInfo ssrcInfo = mediaServerService.openRTPServer(mediaServerItem, streamId, device.isSsrcCheck(), false);
+            logger.info(JSONObject.toJSONString(ssrcInfo));
             play(mediaServerItem, ssrcInfo, device, channelId, (mediaServerItemInUse, response)->{
                 if (hookEvent != null) {
                     hookEvent.response(mediaServerItem, response);
@@ -306,7 +307,7 @@ public void play(MediaServerItem mediaServerItem, SSRCInfo ssrcInfo, Device devi
                     // 单端口模式streamId也有变化，需要重新设置监听
                     if (!mediaServerItem.isRtpEnable()) {
                         // 添加订阅
-                        HookSubscribeForStreamChange hookSubscribe = HookSubscribeFactory.on_stream_changed("rtp", stream, true, "rtmp", mediaServerItem.getId());
+                        HookSubscribeForStreamChange hookSubscribe = HookSubscribeFactory.on_stream_changed("rtp", stream, true, "rtsp", mediaServerItem.getId());
                         subscribe.removeSubscribe(hookSubscribe);
                         hookSubscribe.getContent().put("stream", String.format("%08x", Integer.parseInt(ssrcInResponse)).toUpperCase());
                         subscribe.addSubscribe(hookSubscribe, (MediaServerItem mediaServerItemInUse, JSONObject response)->{

File: src/main/java/com/genersoft/iot/vmp/service/impl/RedisGbPlayMsgListener.java
Patch:
@@ -271,7 +271,7 @@ private void requestSendItemMsgHand(RequestSendItemMsg content, String toId, Str
             }, userSetting.getPlatformPlayTimeout());
 
             // 添加订阅
-            HookSubscribeForStreamChange hookSubscribe = HookSubscribeFactory.on_stream_changed(content.getApp(), content.getStream(), true, "rtmp", mediaServerItem.getId());
+            HookSubscribeForStreamChange hookSubscribe = HookSubscribeFactory.on_stream_changed(content.getApp(), content.getStream(), true, "rtsp", mediaServerItem.getId());
 
             subscribe.addSubscribe(hookSubscribe, (MediaServerItem mediaServerItemInUse, JSONObject json)->{
                         dynamicTask.stop(taskKey);

File: src/main/java/com/genersoft/iot/vmp/service/impl/StreamProxyServiceImpl.java
Patch:
@@ -301,7 +301,6 @@ public boolean start(String app, String stream) {
             if (jsonObject == null) {
                 return false;
             }
-            System.out.println(jsonObject);
             if (jsonObject.getInteger("code") == 0) {
                 result = true;
                 streamProxy.setEnable(true);
@@ -427,7 +426,7 @@ private void syncPullStream(String mediaServerId){
                         if(data != null && data.size() > 0) {
                             for (int i = 0; i < data.size(); i++) {
                                 JSONObject streamJSONObj = data.getJSONObject(i);
-                                if ("rtmp".equals(streamJSONObj.getString("schema"))) {
+                                if ("rtsp".equals(streamJSONObj.getString("schema"))) {
                                     StreamInfo streamInfo = new StreamInfo();
                                     String app = streamJSONObj.getString("app");
                                     String stream = streamJSONObj.getString("stream");

File: src/main/java/com/genersoft/iot/vmp/storager/IRedisCatchStorage.java
Patch:
@@ -237,4 +237,6 @@ public interface IRedisCatchStorage {
      * 发送redis消息 查询所有推流设备的状态
      */
     void sendStreamPushRequestedMsgForStatus();
+
+    List<SendRtpItem> querySendRTPServerByChnnelId(String channelId);
 }

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/platform/PlatformController.java
Patch:
@@ -197,7 +197,7 @@ public String addPlatform(@RequestBody ParentPlatform parentPlatform) {
     @Operation(summary = "保存上级平台信息")
     @PostMapping("/save")
     @ResponseBody
-    public String savePlatform(@RequestBody ParentPlatform parentPlatform) {
+    public void savePlatform(@RequestBody ParentPlatform parentPlatform) {
 
         if (logger.isDebugEnabled()) {
             logger.debug("保存上级平台信息API调用");
@@ -247,7 +247,6 @@ public String savePlatform(@RequestBody ParentPlatform parentPlatform) {
                 // 停止订阅相关的定时任务
                 subscribeHolder.removeAllSubscribe(parentPlatform.getServerGBId());
             }
-            return null;
         } else {
             throw new ControllerException(ErrorCode.ERROR100.getCode(),"写入数据库失败");
         }

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/EventPublisher.java
Patch:
@@ -37,9 +37,9 @@ public class EventPublisher {
 	 * @param platformGbId
 	 */
 	public void platformKeepaliveExpireEventPublish(String platformGbId){
-		PlatformKeepaliveExpireEvent platformNotRegisterEvent = new PlatformKeepaliveExpireEvent(this);
-		platformNotRegisterEvent.setPlatformGbID(platformGbId);
-        applicationEventPublisher.publishEvent(platformNotRegisterEvent);
+		PlatformKeepaliveExpireEvent platformKeepaliveExpireEvent = new PlatformKeepaliveExpireEvent(this);
+		platformKeepaliveExpireEvent.setPlatformGbID(platformGbId);
+        applicationEventPublisher.publishEvent(platformKeepaliveExpireEvent);
     }
 
 	/**

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/EventPublisher.java
Patch:
@@ -37,9 +37,9 @@ public class EventPublisher {
 	 * @param platformGbId
 	 */
 	public void platformKeepaliveExpireEventPublish(String platformGbId){
-		PlatformKeepaliveExpireEvent platformNotRegisterEvent = new PlatformKeepaliveExpireEvent(this);
-		platformNotRegisterEvent.setPlatformGbID(platformGbId);
-        applicationEventPublisher.publishEvent(platformNotRegisterEvent);
+		PlatformKeepaliveExpireEvent platformKeepaliveExpireEvent = new PlatformKeepaliveExpireEvent(this);
+		platformKeepaliveExpireEvent.setPlatformGbID(platformGbId);
+        applicationEventPublisher.publishEvent(platformKeepaliveExpireEvent);
     }
 
 	/**

File: src/main/java/com/genersoft/iot/vmp/conf/UserSetting.java
Patch:
@@ -1,6 +1,5 @@
 package com.genersoft.iot.vmp.conf;
 
-import io.swagger.models.auth.In;
 import org.springframework.boot.context.properties.ConfigurationProperties;
 import org.springframework.stereotype.Component;
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/ByeRequestProcessor.java
Patch:
@@ -126,7 +126,7 @@ public void process(RequestEvent evt) {
 					SsrcTransaction ssrcTransactionForPlay = streamSession.getSsrcTransaction(device.getDeviceId(), channelId, "play", null);
 					if (ssrcTransactionForPlay != null){
 						SIPDialog dialogForPlay = (SIPDialog) SerializeUtils.deSerialize(ssrcTransactionForPlay.getDialog());
-						if (dialogForPlay.getCallId().equals(callIdHeader.getCallId())){
+						if (dialogForPlay.getCallId().getCallId().equals(callIdHeader.getCallId())){
 							// 释放ssrc
 							MediaServerItem mediaServerItem = mediaServerService.getOne(ssrcTransactionForPlay.getMediaServerId());
 							if (mediaServerItem != null) {

File: src/main/java/com/genersoft/iot/vmp/conf/UserSetting.java
Patch:
@@ -1,6 +1,5 @@
 package com.genersoft.iot.vmp.conf;
 
-import io.swagger.models.auth.In;
 import org.springframework.boot.context.properties.ConfigurationProperties;
 import org.springframework.stereotype.Component;
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/ByeRequestProcessor.java
Patch:
@@ -126,7 +126,7 @@ public void process(RequestEvent evt) {
 					SsrcTransaction ssrcTransactionForPlay = streamSession.getSsrcTransaction(device.getDeviceId(), channelId, "play", null);
 					if (ssrcTransactionForPlay != null){
 						SIPDialog dialogForPlay = (SIPDialog) SerializeUtils.deSerialize(ssrcTransactionForPlay.getDialog());
-						if (dialogForPlay.getCallId().equals(callIdHeader.getCallId())){
+						if (dialogForPlay.getCallId().getCallId().equals(callIdHeader.getCallId())){
 							// 释放ssrc
 							MediaServerItem mediaServerItem = mediaServerService.getOne(ssrcTransactionForPlay.getMediaServerId());
 							if (mediaServerItem != null) {

File: src/main/java/com/genersoft/iot/vmp/service/impl/DeviceServiceImpl.java
Patch:
@@ -160,7 +160,7 @@ public boolean addCatalogSubscribe(Device device) {
         logger.info("[添加目录订阅] 设备{}", device.getDeviceId());
         // 添加目录订阅
         CatalogSubscribeTask catalogSubscribeTask = new CatalogSubscribeTask(device, sipCommander, dynamicTask);
-        // 提前开始刷新订阅
+        // 刷新订阅
         int subscribeCycleForCatalog = Math.max(device.getSubscribeCycleForCatalog(),30);
         // 设置最小值为30
         dynamicTask.startCron(device.getDeviceId() + "catalog", catalogSubscribeTask, (subscribeCycleForCatalog -1) * 1000);
@@ -195,8 +195,8 @@ public boolean addMobilePositionSubscribe(Device device) {
         MobilePositionSubscribeTask mobilePositionSubscribeTask = new MobilePositionSubscribeTask(device, sipCommander, dynamicTask);
         // 设置最小值为30
         int subscribeCycleForCatalog = Math.max(device.getSubscribeCycleForMobilePosition(),30);
-        // 提前开始刷新订阅
-        dynamicTask.startCron(device.getDeviceId() + "mobile_position" , mobilePositionSubscribeTask, (subscribeCycleForCatalog -1 ) * 1000);
+        // 刷新订阅
+        dynamicTask.startCron(device.getDeviceId() + "mobile_position" , mobilePositionSubscribeTask, (subscribeCycleForCatalog) * 1000);
         return true;
     }
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/task/impl/MobilePositionSubscribeTask.java
Patch:
@@ -39,9 +39,9 @@ public void run() {
             dynamicTask.stop(taskKey);
         }
         sipCommander.mobilePositionSubscribe(device, dialog, eventResult -> {
-//            if (eventResult.dialog != null || eventResult.dialog.getState().equals(DialogState.CONFIRMED)) {
-//                dialog = eventResult.dialog;
-//            }
+            if (eventResult.dialog != null || eventResult.dialog.getState().equals(DialogState.CONFIRMED)) {
+                dialog = eventResult.dialog;
+            }
             ResponseEvent event = (ResponseEvent) eventResult.event;
             if (event.getResponse().getRawContent() != null) {
                 // 成功

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/notify/cmd/AlarmNotifyMessageHandler.java
Patch:
@@ -69,7 +69,7 @@ public void afterPropertiesSet() throws Exception {
 
     @Override
     public void handForDevice(RequestEvent evt, Device device, Element rootElement) {
-        logger.info("收到来自设备[{}]的报警通知", device.getDeviceId());
+        logger.info("[收到报警通知]设备：{}", device.getDeviceId());
         // 回复200 OK
         try {
             responseAck(evt, Response.OK);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/CatalogResponseMessageHandler.java
Patch:
@@ -111,7 +111,7 @@ public void handForDevice(RequestEvent evt, Device device, Element element) {
                         int sumNum = Integer.parseInt(sumNumElement.getText());
 
                         if (sumNum == 0) {
-                            logger.info("收到来自设备【{}】的通道: 0个", take.getDevice().getDeviceId());
+                            logger.info("[收到通道]设备:{}的: 0个", take.getDevice().getDeviceId());
                             // 数据已经完整接收
                             storager.cleanChannelsForDevice(take.getDevice().getDeviceId());
                             catalogDataCatch.setChannelSyncEnd(take.getDevice().getDeviceId(), null);
@@ -133,7 +133,7 @@ public void handForDevice(RequestEvent evt, Device device, Element element) {
                                 }
                                 int sn = Integer.parseInt(snElement.getText());
                                 catalogDataCatch.put(take.getDevice().getDeviceId(), sn, sumNum, take.getDevice(), channelList);
-                                logger.info("收到来自设备【{}】的通道: {}个，{}/{}", take.getDevice().getDeviceId(), channelList.size(), catalogDataCatch.get(take.getDevice().getDeviceId()) == null ? 0 :catalogDataCatch.get(take.getDevice().getDeviceId()).size(), sumNum);
+                                logger.info("[收到通道]设备: {} -> {}个，{}/{}", take.getDevice().getDeviceId(), channelList.size(), catalogDataCatch.get(take.getDevice().getDeviceId()) == null ? 0 :catalogDataCatch.get(take.getDevice().getDeviceId()).size(), sumNum);
                                 if (catalogDataCatch.get(take.getDevice().getDeviceId()).size() == sumNum) {
                                     // 数据已经完整接收
                                     boolean resetChannelsResult = storager.resetChannels(take.getDevice().getDeviceId(), catalogDataCatch.get(take.getDevice().getDeviceId()));

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMHttpHookListener.java
Patch:
@@ -240,6 +240,8 @@ public ResponseEntity<String> onPublish(@RequestBody OnPublishHookParam param) {
 			if (mediaInfo != null) {
 				assistRESTfulUtils.addStreamCallInfo(mediaInfo, param.getApp(), param.getStream(), callId, null);
 			}
+		}else {
+			zlmMediaListManager.sendStreamEvent(param.getApp(),param.getStream(), param.getMediaServerId());
 		}
 
 		ret.put("code", 0);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/RegisterRequestProcessor.java
Patch:
@@ -143,6 +143,7 @@ public void process(RequestEvent evt) {
                 device.setGeoCoordSys("WGS84");
                 device.setTreeType("CivilCode");
                 device.setDeviceId(deviceId);
+                device.setOnline(0);
             }
             device.setIp(received);
             device.setPort(rPort);

File: src/main/java/com/genersoft/iot/vmp/storager/dao/DeviceChannelMapper.java
Patch:
@@ -140,6 +140,9 @@ public interface DeviceChannelMapper {
     @Update(value = {"UPDATE device_channel SET status=0 WHERE deviceId=#{deviceId} AND channelId=#{channelId}"})
     void offline(String deviceId,  String channelId);
 
+    @Update(value = {"UPDATE device_channel SET status=0 WHERE deviceId=#{deviceId}"})
+    void offlineByDeviceId(String deviceId);
+
     @Update(value = {"UPDATE device_channel SET status=1 WHERE deviceId=#{deviceId} AND channelId=#{channelId}"})
     void online(String deviceId,  String channelId);
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/DeviceStatusResponseMessageHandler.java
Patch:
@@ -82,7 +82,7 @@ public void handForDevice(RequestEvent evt, Device device, Element element) {
             deviceService.offline(device.getDeviceId());
         }
         RequestMessage msg = new RequestMessage();
-        msg.setKey(DeferredResultHolder.CALLBACK_CMD_DEVICESTATUS + device.getDeviceId() + channelId);
+        msg.setKey(DeferredResultHolder.CALLBACK_CMD_DEVICESTATUS + device.getDeviceId());
         msg.setData(json);
         deferredResultHolder.invokeAllResult(msg);
     }

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/DeviceStatusResponseMessageHandler.java
Patch:
@@ -82,7 +82,7 @@ public void handForDevice(RequestEvent evt, Device device, Element element) {
             deviceService.offline(device.getDeviceId());
         }
         RequestMessage msg = new RequestMessage();
-        msg.setKey(DeferredResultHolder.CALLBACK_CMD_DEVICESTATUS + device.getDeviceId() + channelId);
+        msg.setKey(DeferredResultHolder.CALLBACK_CMD_DEVICESTATUS + device.getDeviceId());
         msg.setData(json);
         deferredResultHolder.invokeAllResult(msg);
     }

File: src/main/java/com/genersoft/iot/vmp/gb28181/utils/XmlUtil.java
Patch:
@@ -255,6 +255,8 @@ public static DeviceChannel channelContentHander(Element itemDevice, Device devi
             }else if (deviceChannel.getChannelId().length() == 20) {
                 if (Integer.parseInt(deviceChannel.getChannelId().substring(10, 13)) == 216) { // 虚拟组织
                     deviceChannel.setParentId(businessGroupID);
+                }else if (Integer.parseInt(device.getDeviceId().substring(10, 13) )== 118) {//NVR 如果上级设备编号是NVR则直接将NVR的编号设置给通道的上级编号
+                    deviceChannel.setParentId(device.getDeviceId());
                 }else if (deviceChannel.getCivilCode() != null) {
                     // 设备， 无parentId的20位是使用CivilCode表示上级的设备，
                     // 注：215 业务分组是需要有parentId的

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/DeviceStatusResponseMessageHandler.java
Patch:
@@ -82,7 +82,7 @@ public void handForDevice(RequestEvent evt, Device device, Element element) {
             deviceService.offline(device.getDeviceId());
         }
         RequestMessage msg = new RequestMessage();
-        msg.setKey(DeferredResultHolder.CALLBACK_CMD_DEVICESTATUS + device.getDeviceId() + channelId);
+        msg.setKey(DeferredResultHolder.CALLBACK_CMD_DEVICESTATUS + device.getDeviceId());
         msg.setData(json);
         deferredResultHolder.invokeAllResult(msg);
     }

File: src/main/java/com/genersoft/iot/vmp/gb28181/utils/XmlUtil.java
Patch:
@@ -255,6 +255,8 @@ public static DeviceChannel channelContentHander(Element itemDevice, Device devi
             }else if (deviceChannel.getChannelId().length() == 20) {
                 if (Integer.parseInt(deviceChannel.getChannelId().substring(10, 13)) == 216) { // 虚拟组织
                     deviceChannel.setParentId(businessGroupID);
+                }else if (Integer.parseInt(device.getDeviceId().substring(10, 13) )== 118) {//NVR 如果上级设备编号是NVR则直接将NVR的编号设置给通道的上级编号
+                    deviceChannel.setParentId(device.getDeviceId());
                 }else if (deviceChannel.getCivilCode() != null) {
                     // 设备， 无parentId的20位是使用CivilCode表示上级的设备，
                     // 注：215 业务分组是需要有parentId的

File: src/main/java/com/genersoft/iot/vmp/gb28181/bean/Device.java
Patch:
@@ -131,7 +131,7 @@ public class Device {
 	/**
 	 * 是否开启ssrc校验，默认关闭，开启可以防止串流
 	 */
-	private boolean ssrcCheck;
+	private boolean ssrcCheck = true;
 
 	/**
 	 * 地理坐标系， 目前支持 WGS84,GCJ02 TODO CGCS2000

File: src/main/java/com/genersoft/iot/vmp/gb28181/bean/Device.java
Patch:
@@ -131,7 +131,7 @@ public class Device {
 	/**
 	 * 是否开启ssrc校验，默认关闭，开启可以防止串流
 	 */
-	private boolean ssrcCheck;
+	private boolean ssrcCheck = true;
 
 	/**
 	 * 地理坐标系， 目前支持 WGS84,GCJ02 TODO CGCS2000

File: src/main/java/com/genersoft/iot/vmp/gb28181/session/VideoStreamSessionManager.java
Patch:
@@ -185,7 +185,7 @@ public void remove(String deviceId, String channelId, String stream) {
 
 
 	public List<SsrcTransaction> getAllSsrc() {
-		List<Object> ssrcTransactionKeys = redisUtil.scan(String.format("%s_*_*_*_*", VideoManagerConstants.MEDIA_TRANSACTION_USED_PREFIX+ userSetting.getServerId() + "_" ));
+		List<Object> ssrcTransactionKeys = redisUtil.scan(String.format("%s*_*_*_*", VideoManagerConstants.MEDIA_TRANSACTION_USED_PREFIX+ userSetting.getServerId() + "_" ));
 		List<SsrcTransaction> result= new ArrayList<>();
 		for (int i = 0; i < ssrcTransactionKeys.size(); i++) {
 			String key = (String)ssrcTransactionKeys.get(i);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/RegisterRequestProcessor.java
Patch:
@@ -6,12 +6,12 @@
 import com.genersoft.iot.vmp.gb28181.transmit.SIPProcessorObserver;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.ISIPRequestProcessor;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.SIPRequestProcessorParent;
+import com.genersoft.iot.vmp.gb28181.auth.DigestServerAuthenticationHelper;
 import com.genersoft.iot.vmp.service.IDeviceService;
 import com.genersoft.iot.vmp.utils.DateUtil;
 import gov.nist.javax.sip.RequestEventExt;
 import gov.nist.javax.sip.address.AddressImpl;
 import gov.nist.javax.sip.address.SipUri;
-import gov.nist.javax.sip.clientauthutils.DigestServerAuthenticationHelper;
 import gov.nist.javax.sip.header.Expires;
 import gov.nist.javax.sip.header.SIPDateHeader;
 import org.slf4j.Logger;
@@ -92,7 +92,6 @@ public void process(RequestEvent evt) {
             // 校验密码是否正确
             passwordCorrect = StringUtils.isEmpty(sipConfig.getPassword()) ||
                     new DigestServerAuthenticationHelper().doAuthenticatePlainTextPassword(request, sipConfig.getPassword());
-            // 未携带授权头或者密码错误 回复401
 
             if (!passwordCorrect) {
                 // 注册失败

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/RegisterRequestProcessor.java
Patch:
@@ -6,12 +6,12 @@
 import com.genersoft.iot.vmp.gb28181.transmit.SIPProcessorObserver;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.ISIPRequestProcessor;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.SIPRequestProcessorParent;
+import com.genersoft.iot.vmp.gb28181.auth.DigestServerAuthenticationHelper;
 import com.genersoft.iot.vmp.service.IDeviceService;
 import com.genersoft.iot.vmp.utils.DateUtil;
 import gov.nist.javax.sip.RequestEventExt;
 import gov.nist.javax.sip.address.AddressImpl;
 import gov.nist.javax.sip.address.SipUri;
-import gov.nist.javax.sip.clientauthutils.DigestServerAuthenticationHelper;
 import gov.nist.javax.sip.header.Expires;
 import gov.nist.javax.sip.header.SIPDateHeader;
 import org.slf4j.Logger;
@@ -92,7 +92,6 @@ public void process(RequestEvent evt) {
             // 校验密码是否正确
             passwordCorrect = StringUtils.isEmpty(sipConfig.getPassword()) ||
                     new DigestServerAuthenticationHelper().doAuthenticatePlainTextPassword(request, sipConfig.getPassword());
-            // 未携带授权头或者密码错误 回复401
 
             if (!passwordCorrect) {
                 // 注册失败

File: src/main/java/com/genersoft/iot/vmp/gb28181/task/impl/MobilePositionSubscribeHandlerTask.java
Patch:
@@ -29,7 +29,6 @@ public class MobilePositionSubscribeHandlerTask implements ISubscribeTask {
     private String key;
 
     public MobilePositionSubscribeHandlerTask(IRedisCatchStorage redisCatchStorage, ISIPCommanderForPlatform sipCommanderForPlatform, IVideoManagerStorage storager, String platformId, String sn, String key, SubscribeHolder subscribeInfo) {
-        System.out.println("MobilePositionSubscribeHandlerTask 初始化");
         this.redisCatchStorage = redisCatchStorage;
         this.storager = storager;
         this.platform = storager.queryParentPlatByServerGBId(platformId);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/notify/cmd/CatalogNotifyMessageHandler.java
Patch:
@@ -79,7 +79,7 @@ public void handForPlatform(RequestEvent evt, ParentPlatform parentPlatform, Ele
                     deviceChannel.setParental(1);
                     deviceChannel.setParentId(catalog.getParentId());
                     deviceChannel.setRegisterWay(1);
-                    deviceChannel.setCivilCode(parentPlatform.getDeviceGBId().substring(0,6));
+                    deviceChannel.setCivilCode(parentPlatform.getAdministrativeDivision());
                     deviceChannel.setModel("live");
                     deviceChannel.setOwner("wvp-pro");
                     deviceChannel.setSecrecy("0");
@@ -116,7 +116,7 @@ public void handForPlatform(RequestEvent evt, ParentPlatform parentPlatform, Ele
                     deviceChannel.setStatus(1);
     				deviceChannel.setParentId(gbStream.getCatalogId());
                     deviceChannel.setRegisterWay(1);
-                    deviceChannel.setCivilCode(parentPlatform.getDeviceGBId().substring(0,6));
+                    deviceChannel.setCivilCode(parentPlatform.getAdministrativeDivision());
                     deviceChannel.setModel("live");
                     deviceChannel.setOwner("wvp-pro");
                     deviceChannel.setParental(0);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/query/cmd/CatalogQueryMessageHandler.java
Patch:
@@ -93,7 +93,7 @@ public void handForPlatform(RequestEvent evt, ParentPlatform parentPlatform, Ele
                     deviceChannel.setParental(1);
                     deviceChannel.setParentId(catalog.getParentId());
                     deviceChannel.setRegisterWay(1);
-                    deviceChannel.setCivilCode(parentPlatform.getDeviceGBId().substring(0,6));
+                    deviceChannel.setCivilCode(parentPlatform.getAdministrativeDivision());
                     deviceChannel.setModel("live");
                     deviceChannel.setOwner("wvp-pro");
                     deviceChannel.setSecrecy("0");
@@ -130,7 +130,7 @@ public void handForPlatform(RequestEvent evt, ParentPlatform parentPlatform, Ele
                     deviceChannel.setStatus(1);
                     deviceChannel.setParentId(gbStream.getCatalogId());
                     deviceChannel.setRegisterWay(1);
-                    deviceChannel.setCivilCode(parentPlatform.getDeviceGBId().substring(0,6));
+                    deviceChannel.setCivilCode(parentPlatform.getAdministrativeDivision());
                     deviceChannel.setModel("live");
                     deviceChannel.setOwner("wvp-pro");
                     deviceChannel.setParental(0);

File: src/main/java/com/genersoft/iot/vmp/service/impl/StreamPushServiceImpl.java
Patch:
@@ -420,9 +420,6 @@ public void batchAddForUpload(List<StreamPushItem> streamPushItems, Map<String,
                                 continue;
                             }
                             streamPushItemForPlatform.setPlatformId(platFormInfoArray[0]);
-                            if (platFormInfoArray[0].equals("34020000002110000001")) {
-                                System.out.println(111);
-                            }
                             List<GbStream> gbStreamList = platformForEvent.get(platFormInfoArray[0]);
                             if (gbStreamList == null) {
                                 gbStreamList = new ArrayList<>();

File: src/main/java/com/genersoft/iot/vmp/storager/impl/VideoManagerStorageImpl.java
Patch:
@@ -524,7 +524,7 @@ public boolean updateParentPlatform(ParentPlatform parentPlatform) {
 			parentPlatform.setCatalogGroup(1);
 		}
 		if (parentPlatform.getAdministrativeDivision() == null) {
-			parentPlatform.setAdministrativeDivision(parentPlatform.getDeviceGBId().substring(0,6));
+			parentPlatform.setAdministrativeDivision(parentPlatform.getAdministrativeDivision());
 		}
 		ParentPlatformCatch parentPlatformCatch = redisCatchStorage.queryPlatformCatchInfo(parentPlatform.getServerGBId()); // .getDeviceGBId());
 		if (parentPlatform.getId() == null ) {
@@ -1081,7 +1081,7 @@ private DeviceChannel getDeviceChannelByCatalog(PlatformCatalog catalog) {
 		deviceChannel.setParentId(catalog.getParentId());
 		deviceChannel.setRegisterWay(1);
 		// 行政区划应该是Domain的前八位
-		deviceChannel.setCivilCode(parentPlatByServerGBId.getDeviceGBId().substring(0,6));
+		deviceChannel.setCivilCode(parentPlatByServerGBId.getAdministrativeDivision());
 		deviceChannel.setModel("live");
 		deviceChannel.setOwner("wvp-pro");
 		deviceChannel.setSecrecy("0");

File: src/main/java/com/genersoft/iot/vmp/conf/ApiAccessFilter.java
Patch:
@@ -29,7 +29,7 @@ public class ApiAccessFilter extends OncePerRequestFilter {
     private final SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
 
     @Autowired
-    private UserSetup userSetup;
+    private UserSetting userSetting;
 
     @Autowired
     private ILogService logService;
@@ -48,7 +48,7 @@ protected void doFilterInternal(HttpServletRequest servletRequest, HttpServletRe
 
         filterChain.doFilter(servletRequest, servletResponse);
 
-        if (uriName != null && userSetup.getLogInDatebase()) {
+        if (uriName != null && userSetting.getLogInDatebase()) {
 
             LogDto logDto = new LogDto();
             logDto.setName(uriName);

File: src/main/java/com/genersoft/iot/vmp/conf/RedisConfig.java
Patch:
@@ -92,7 +92,7 @@ RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory
 
         RedisMessageListenerContainer container = new RedisMessageListenerContainer();
         container.setConnectionFactory(connectionFactory);
-		container.addMessageListener(redisGPSMsgListener, new PatternTopic(VideoManagerConstants.WVP_MSG_GPS_PREFIX));
+		container.addMessageListener(redisGPSMsgListener, new PatternTopic(VideoManagerConstants.VM_MSG_GPS));
         return container;
     }
 

File: src/main/java/com/genersoft/iot/vmp/conf/SipPlatformRunner.java
Patch:
@@ -4,9 +4,8 @@
 import com.genersoft.iot.vmp.gb28181.bean.ParentPlatformCatch;
 import com.genersoft.iot.vmp.gb28181.event.EventPublisher;
 import com.genersoft.iot.vmp.gb28181.transmit.cmd.ISIPCommanderForPlatform;
-import com.genersoft.iot.vmp.media.zlm.ZLMRTPServerFactory;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.springframework.beans.factory.annotation.Autowired;
 import org.springframework.boot.CommandLineRunner;
 import org.springframework.core.annotation.Order;
@@ -22,7 +21,7 @@
 public class SipPlatformRunner implements CommandLineRunner {
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     @Autowired
     private IRedisCatchStorage redisCatchStorage;

File: src/main/java/com/genersoft/iot/vmp/gb28181/auth/RegisterLogicHandler.java
Patch:
@@ -1,6 +1,6 @@
 package com.genersoft.iot.vmp.gb28181.auth;
 
-import com.genersoft.iot.vmp.storager.impl.VideoManagerStoragerImpl;
+import com.genersoft.iot.vmp.storager.impl.VideoManagerStorageImpl;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import org.springframework.beans.factory.annotation.Autowired;
@@ -23,7 +23,7 @@ public class RegisterLogicHandler {
 	private SIPCommander cmder;
 
 	@Autowired
-	private VideoManagerStoragerImpl storager;
+	private VideoManagerStorageImpl storager;
 	
 	public void onRegister(Device device) {
 		// 只有第一次注册时调用查询设备信息，如需更新调用更新API接口

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/DeviceOffLineDetector.java
Patch:
@@ -1,6 +1,6 @@
 package com.genersoft.iot.vmp.gb28181.event;
 
-import com.genersoft.iot.vmp.conf.UserSetup;
+import com.genersoft.iot.vmp.conf.UserSetting;
 import org.springframework.beans.factory.annotation.Autowired;
 import org.springframework.stereotype.Component;
 
@@ -19,10 +19,10 @@ public class DeviceOffLineDetector {
     private RedisUtil redis;
 
 	@Autowired
-    private UserSetup userSetup;
+    private UserSetting userSetting;
 	
 	public boolean isOnline(String deviceId) {
-		String key = VideoManagerConstants.KEEPLIVEKEY_PREFIX + userSetup.getServerId() + "_" + deviceId;
+		String key = VideoManagerConstants.KEEPLIVEKEY_PREFIX + userSetting.getServerId() + "_" + deviceId;
 		return redis.hasKey(key);
 	}
 }

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/platformKeepaliveExpire/PlatformKeepaliveExpireEventLister.java
Patch:
@@ -6,15 +6,14 @@
 import com.genersoft.iot.vmp.gb28181.event.SipSubscribe;
 import com.genersoft.iot.vmp.gb28181.transmit.cmd.ISIPCommanderForPlatform;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.jetbrains.annotations.NotNull;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import org.springframework.beans.factory.annotation.Autowired;
 import org.springframework.context.ApplicationListener;
 import org.springframework.stereotype.Component;
 
-import javax.sip.ResponseEvent;
 import javax.sip.message.Response;
 
 /**
@@ -29,7 +28,7 @@ public class PlatformKeepaliveExpireEventLister implements ApplicationListener<P
     private final static Logger logger = LoggerFactory.getLogger(PlatformKeepaliveExpireEventLister.class);
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     @Autowired
     private IRedisCatchStorage redisCatchStorage;

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/platformNotRegister/PlatformCycleRegisterEventLister.java
Patch:
@@ -3,7 +3,7 @@
 import com.genersoft.iot.vmp.gb28181.bean.ParentPlatform;
 import com.genersoft.iot.vmp.gb28181.event.SipSubscribe;
 import com.genersoft.iot.vmp.gb28181.transmit.cmd.ISIPCommanderForPlatform;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import org.springframework.beans.factory.annotation.Autowired;
@@ -19,7 +19,7 @@ public class PlatformCycleRegisterEventLister implements ApplicationListener<Pla
     private final static Logger logger = LoggerFactory.getLogger(PlatformCycleRegisterEventLister.class);
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
     @Autowired
     private ISIPCommanderForPlatform sipCommanderFroPlatform;
 

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/platformNotRegister/PlatformNotRegisterEventLister.java
Patch:
@@ -9,7 +9,7 @@
 import com.genersoft.iot.vmp.media.zlm.dto.MediaServerItem;
 import com.genersoft.iot.vmp.service.IMediaServerService;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import org.springframework.beans.factory.annotation.Autowired;
@@ -31,7 +31,7 @@ public class PlatformNotRegisterEventLister implements ApplicationListener<Platf
     private final static Logger logger = LoggerFactory.getLogger(PlatformNotRegisterEventLister.class);
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
     @Autowired
     private IRedisCatchStorage redisCatchStorage;
     @Autowired

File: src/main/java/com/genersoft/iot/vmp/gb28181/session/CatalogDataCatch.java
Patch:
@@ -5,7 +5,7 @@
 import com.genersoft.iot.vmp.gb28181.bean.DeviceChannel;
 import com.genersoft.iot.vmp.gb28181.transmit.callback.DeferredResultHolder;
 import com.genersoft.iot.vmp.gb28181.transmit.callback.RequestMessage;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import com.genersoft.iot.vmp.vmanager.bean.WVPResult;
 import org.springframework.beans.factory.annotation.Autowired;
 import org.springframework.scheduling.annotation.Scheduled;
@@ -23,7 +23,7 @@ public class CatalogDataCatch {
     private DeferredResultHolder deferredResultHolder;
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     public void put(String key, int total, Device device, List<DeviceChannel> deviceChannelList) {
         CatalogData catalogData = data.get(key);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/ISIPCommander.java
Patch:
@@ -305,11 +305,9 @@ boolean alarmInfoQuery(Device device, String startPriority, String endPriority,
 	 * 订阅、取消订阅移动位置
 	 * 
 	 * @param device	视频设备
-	 * @param expires	订阅超时时间（值=0时为取消订阅）
-	 * @param interval	上报时间间隔
 	 * @return			true = 命令发送成功
 	 */
-	boolean mobilePositionSubscribe(Device device, int expires, int interval);
+	boolean mobilePositionSubscribe(Device device, SipSubscribe.Event okEvent ,SipSubscribe.Event errorEvent);
 
 	/**
 	 * 订阅、取消订阅报警信息

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/impl/SIPCommanderFroPlatform.java
Patch:
@@ -372,7 +372,6 @@ public boolean sendNotifyMobilePosition(ParentPlatform parentPlatform, GPSMsgInf
                     : udpSipProvider.getNewCallId();
             callIdHeader.setCallId(subscribeInfo.getCallId());
 
-//
             sendNotify(parentPlatform, deviceStatusXml.toString(), subscribeInfo, eventResult -> {
                 logger.error("发送NOTIFY通知消息失败。错误：{} {}", eventResult.statusCode, eventResult.msg);
             }, null);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/RegisterRequestProcessor.java
Patch:
@@ -11,7 +11,7 @@
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.ISIPRequestProcessor;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.SIPRequestProcessorParent;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import gov.nist.javax.sip.RequestEventExt;
 import gov.nist.javax.sip.address.AddressImpl;
 import gov.nist.javax.sip.address.SipUri;
@@ -56,7 +56,7 @@ public class RegisterRequestProcessor extends SIPRequestProcessorParent implemen
 	private IRedisCatchStorage redisCatchStorage;
 
 	@Autowired
-	private IVideoManagerStorager storager;
+	private IVideoManagerStorage storager;
 
 	@Autowired
 	private EventPublisher publisher;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/MessageRequestProcessor.java
Patch:
@@ -11,7 +11,7 @@
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.SIPRequestProcessorParent;
 import com.genersoft.iot.vmp.gb28181.utils.SipUtils;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.dom4j.DocumentException;
 import org.dom4j.Element;
 import org.slf4j.Logger;
@@ -43,7 +43,7 @@ public class MessageRequestProcessor extends SIPRequestProcessorParent implement
     private SIPProcessorObserver sipProcessorObserver;
 
     @Autowired
-    private IVideoManagerStorager storage;
+    private IVideoManagerStorage storage;
 
     @Autowired
     private SipSubscribe sipSubscribe;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/control/cmd/DeviceControlQueryMessageHandler.java
Patch:
@@ -8,8 +8,7 @@
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.SIPRequestProcessorParent;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.IMessageHandler;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.control.ControlMessageHandler;
-import com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.query.QueryMessageHandler;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import com.genersoft.iot.vmp.utils.SpringBeanFactory;
 import gov.nist.javax.sip.SipStackImpl;
 import org.dom4j.Element;
@@ -41,7 +40,7 @@ public class DeviceControlQueryMessageHandler extends SIPRequestProcessorParent
     private ControlMessageHandler controlMessageHandler;
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     @Autowired
     private SIPCommander cmder;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/query/cmd/CatalogQueryMessageHandler.java
Patch:
@@ -8,8 +8,7 @@
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.SIPRequestProcessorParent;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.IMessageHandler;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.query.QueryMessageHandler;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
-import com.genersoft.iot.vmp.vmanager.gb28181.platform.bean.ChannelReduce;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.dom4j.Element;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -35,7 +34,7 @@ public class CatalogQueryMessageHandler extends SIPRequestProcessorParent implem
     private QueryMessageHandler queryMessageHandler;
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     @Autowired
     private SIPCommanderFroPlatform cmderFroPlatform;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/query/cmd/DeviceStatusQueryMessageHandler.java
Patch:
@@ -8,7 +8,7 @@
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.SIPRequestProcessorParent;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.IMessageHandler;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.query.QueryMessageHandler;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.dom4j.Element;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -33,7 +33,7 @@ public class DeviceStatusQueryMessageHandler extends SIPRequestProcessorParent i
     private QueryMessageHandler queryMessageHandler;
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     @Autowired
     private SIPCommanderFroPlatform cmderFroPlatform;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/DeviceInfoResponseMessageHandler.java
Patch:
@@ -11,7 +11,7 @@
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.SIPRequestProcessorParent;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.IMessageHandler;
 import com.genersoft.iot.vmp.gb28181.transmit.event.request.impl.message.response.ResponseMessageHandler;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.dom4j.DocumentException;
 import org.dom4j.Element;
 import org.slf4j.Logger;
@@ -39,7 +39,7 @@ public class DeviceInfoResponseMessageHandler extends SIPRequestProcessorParent
     private ResponseMessageHandler responseMessageHandler;
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     @Autowired
     private DeferredResultHolder deferredResultHolder;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/response/impl/RegisterResponseProcessor.java
Patch:
@@ -7,7 +7,7 @@
 import com.genersoft.iot.vmp.gb28181.transmit.cmd.ISIPCommanderForPlatform;
 import com.genersoft.iot.vmp.gb28181.transmit.event.response.SIPResponseProcessorAbstract;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import org.springframework.beans.factory.annotation.Autowired;
@@ -33,7 +33,7 @@ public class RegisterResponseProcessor extends SIPResponseProcessorAbstract {
 	private ISIPCommanderForPlatform sipCommanderForPlatform;
 
 	@Autowired
-	private IVideoManagerStorager storager;
+	private IVideoManagerStorage storager;
 
 	@Autowired
 	private IRedisCatchStorage redisCatchStorage;

File: src/main/java/com/genersoft/iot/vmp/service/StreamGPSSubscribeTask.java
Patch:
@@ -2,7 +2,7 @@
 
 import com.genersoft.iot.vmp.service.bean.GPSMsgInfo;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.springframework.beans.factory.annotation.Autowired;
 import org.springframework.scheduling.annotation.Scheduled;
 import org.springframework.stereotype.Component;
@@ -20,7 +20,7 @@ public class StreamGPSSubscribeTask {
     private IRedisCatchStorage redisCatchStorage;
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
 
 

File: src/main/java/com/genersoft/iot/vmp/service/bean/CatalogSubscribeTask.java
Patch:
@@ -10,6 +10,9 @@
 
 import javax.sip.ResponseEvent;
 
+/**
+ * 目录订阅任务
+ */
 public class CatalogSubscribeTask implements Runnable{
     private final Logger logger = LoggerFactory.getLogger(CatalogSubscribeTask.class);
     private  Device device;
@@ -24,7 +27,6 @@ public CatalogSubscribeTask(Device device, ISIPCommander sipCommander) {
     public void run() {
         sipCommander.catalogSubscribe(device, eventResult -> {
             ResponseEvent event = (ResponseEvent) eventResult.event;
-            Element rootElement = null;
             if (event.getResponse().getRawContent() != null) {
                 // 成功
                 logger.info("[目录订阅]成功： {}", device.getDeviceId());

File: src/main/java/com/genersoft/iot/vmp/service/impl/MediaServiceImpl.java
Patch:
@@ -6,11 +6,10 @@
 import com.genersoft.iot.vmp.common.StreamInfo;
 import com.genersoft.iot.vmp.conf.MediaConfig;
 import com.genersoft.iot.vmp.media.zlm.ZLMRESTfulUtils;
-import com.genersoft.iot.vmp.media.zlm.dto.MediaItem;
 import com.genersoft.iot.vmp.media.zlm.dto.MediaServerItem;
 import com.genersoft.iot.vmp.service.IMediaServerService;
 import com.genersoft.iot.vmp.storager.IRedisCatchStorage;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import com.genersoft.iot.vmp.service.IMediaService;
 import org.springframework.beans.factory.annotation.Autowired;
 import org.springframework.stereotype.Service;
@@ -22,7 +21,7 @@ public class MediaServiceImpl implements IMediaService {
     private IRedisCatchStorage redisCatchStorage;
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     @Autowired
     private IMediaServerService mediaServerService;

File: src/main/java/com/genersoft/iot/vmp/service/impl/RedisGPSMsgListener.java
Patch:
@@ -20,7 +20,7 @@ public class RedisGPSMsgListener implements MessageListener {
 
     @Override
     public void onMessage(Message message, byte[] bytes) {
-        logger.debug("收到来自REDIS的GPS通知： {}", new String(message.getBody()));
+        logger.info("收到来自REDIS的GPS通知： {}", new String(message.getBody()));
         GPSMsgInfo gpsMsgInfo = JSON.parseObject(message.getBody(), GPSMsgInfo.class);
         redisCatchStorage.updateGpsMsgInfo(gpsMsgInfo);
     }

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/gbStream/GbStreamController.java
Patch:
@@ -1,7 +1,7 @@
 package com.genersoft.iot.vmp.vmanager.gb28181.gbStream;
 
 import com.genersoft.iot.vmp.gb28181.bean.GbStream;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import com.genersoft.iot.vmp.vmanager.gb28181.gbStream.bean.GbStreamParam;
 import com.genersoft.iot.vmp.service.IGbStreamService;
 import com.github.pagehelper.PageInfo;
@@ -27,7 +27,7 @@ public class GbStreamController {
     private IGbStreamService gbStreamService;
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
 
     /**

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/media/MediaController.java
Patch:
@@ -4,13 +4,12 @@
 import com.genersoft.iot.vmp.service.IMediaServerService;
 import com.genersoft.iot.vmp.service.IStreamPushService;
 import com.genersoft.iot.vmp.service.IMediaService;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import com.genersoft.iot.vmp.vmanager.bean.WVPResult;
 import io.swagger.annotations.Api;
 import io.swagger.annotations.ApiImplicitParam;
 import io.swagger.annotations.ApiImplicitParams;
 import io.swagger.annotations.ApiOperation;
-import org.apache.commons.lang3.StringUtils;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import org.springframework.beans.factory.annotation.Autowired;
@@ -27,7 +26,7 @@ public class MediaController {
     private final static Logger logger = LoggerFactory.getLogger(MediaController.class);
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     @Autowired
     private IStreamPushService streamPushService;

File: src/main/java/com/genersoft/iot/vmp/web/gb28181/ApiControlController.java
Patch:
@@ -3,7 +3,7 @@
 import com.alibaba.fastjson.JSONObject;
 import com.genersoft.iot.vmp.gb28181.bean.Device;
 import com.genersoft.iot.vmp.gb28181.transmit.cmd.impl.SIPCommander;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import org.springframework.beans.factory.annotation.Autowired;
@@ -23,7 +23,7 @@ public class ApiControlController {
     private SIPCommander cmder;
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     /**
      * 设备控制 - 云台控制

File: src/main/java/com/genersoft/iot/vmp/web/gb28181/ApiDeviceController.java
Patch:
@@ -4,7 +4,7 @@
 import com.alibaba.fastjson.JSONObject;
 import com.genersoft.iot.vmp.gb28181.bean.Device;
 import com.genersoft.iot.vmp.gb28181.bean.DeviceChannel;
-import com.genersoft.iot.vmp.storager.IVideoManagerStorager;
+import com.genersoft.iot.vmp.storager.IVideoManagerStorage;
 import com.github.pagehelper.PageInfo;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -25,7 +25,7 @@ public class ApiDeviceController {
     private final static Logger logger = LoggerFactory.getLogger(ApiDeviceController.class);
 
     @Autowired
-    private IVideoManagerStorager storager;
+    private IVideoManagerStorage storager;
 
     // @Autowired
     // private SIPCommander cmder;

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/subscribe/catalog/CatalogEventLister.java
Patch:
@@ -165,7 +165,7 @@ public void onApplicationEvent(CatalogEvent event) {
                                 GbStream gbStream = storager.queryStreamInParentPlatform(platform.getServerGBId(), gbId);
                                 DeviceChannel deviceChannelByStream = gbStreamService.getDeviceChannelListByStream(gbStream, gbStream.getCatalogId(), platform.getDeviceGBId());
                                 deviceChannelList.add(deviceChannelByStream);
-                                sipCommanderFroPlatform.sendNotifyForCatalogOther(event.getType(), platform, deviceChannelList, subscribeInfo, null);
+                                sipCommanderFroPlatform.sendNotifyForCatalogAddOrUpdate(event.getType(), platform, deviceChannelList, subscribeInfo, null);
                             }
                         }
                     }

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/NotifyRequestProcessor.java
Patch:
@@ -309,7 +309,7 @@ private void processNotifyCatalogList(RequestEvent evt) {
 
 				}
 
-				if (offLineDetector.isOnline(deviceId)) {
+				if (!offLineDetector.isOnline(deviceId)) {
 					publisher.onlineEventPublish(device, VideoManagerConstants.EVENT_ONLINE_MESSAGE);
 				}
 			}

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/SIPRequestHeaderProvider.java
Patch:
@@ -256,7 +256,7 @@ public Request createInfoRequest(Device device, StreamInfo streamInfo, String co
 		// Forwards
 		MaxForwardsHeader maxForwards = sipFactory.createHeaderFactory().createMaxForwardsHeader(70);
 
-		cseq = redisCatchStorage.getCSEQ(Request.INVITE);
+		Long cseq = redisCatchStorage.getCSEQ(Request.INVITE);
 		// ceq
 		CSeqHeader cSeqHeader = sipFactory.createHeaderFactory()
 				.createCSeqHeader(cseq, Request.INFO);

File: src/main/java/com/genersoft/iot/vmp/utils/node/ForestNode.java
Patch:
@@ -15,8 +15,8 @@ public class ForestNode extends BaseNode<ForestNode> {
 	 */
 	private Object content;
 
-	public ForestNode(int id, String parentId, Object content) {
-		this.id = id;
+	public ForestNode(String id, String parentId, Object content) {
+		this.channelId = id;
 		this.parentId = parentId;
 		this.content = content;
 	}

File: src/main/java/com/genersoft/iot/vmp/utils/node/ForestNodeMerger.java
Patch:
@@ -25,7 +25,7 @@ public static <T extends INode<T>> List<T> merge(List<T> items) {
 				if (node != null) {
 					node.getChildren().add(forestNode);
 				} else {
-					forestNodeManager.addParentId(forestNode.getId());
+					forestNodeManager.addParentId(forestNode.getChannelId());
 				}
 			}
 		});
@@ -37,8 +37,8 @@ public static <T extends INode<T>> List<T> merge(List<T> items, String[] parentI
 		items.forEach(forestNode -> {
 			if (forestNode.getParentId() != null) {
 				INode<T> node = forestNodeManager.getTreeNodeAt(forestNode.getParentId());
-				if (CollectionUtil.contains(parentIds, forestNode.getId())){
-					forestNodeManager.addParentId(forestNode.getId());
+				if (CollectionUtil.contains(parentIds, forestNode.getChannelId())){
+					forestNodeManager.addParentId(forestNode.getChannelId());
 				} else {
 					if (node != null){
 						node.getChildren().add(forestNode);

File: src/main/java/com/genersoft/iot/vmp/utils/node/INode.java
Patch:
@@ -14,7 +14,7 @@ public interface INode<T> extends Serializable {
 	 *
 	 * @return String
 	 */
-	int getId();
+	String getChannelId();
 
 	/**
 	 * 父主键

File: src/main/java/com/genersoft/iot/vmp/storager/impl/VideoManagerStoragerImpl.java
Patch:
@@ -772,7 +772,7 @@ public boolean updateStreamProxy(StreamProxyItem streamProxyItem) {
 		try {
 			if (streamProxyMapper.update(streamProxyItem) > 0) {
 				if (!StringUtils.isEmpty(streamProxyItem.getGbId())) {
-					if (gbStreamMapper.update(streamProxyItem) > 0) {
+					if (gbStreamMapper.updateByallAndStream(streamProxyItem) > 0) {
 						//事务回滚
 						dataSourceTransactionManager.rollback(transactionStatus);
 						return false;

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/platform/PlatformController.java
Patch:
@@ -305,6 +305,8 @@ public ResponseEntity<String> deletePlatform(@PathVariable String serverGBId) {
         // 停止发送位置订阅定时任务
         String key = VideoManagerConstants.SIP_SUBSCRIBE_PREFIX + userSetup.getServerId() +  "_MobilePosition_" + parentPlatform.getServerGBId();
         dynamicTask.stop(key);
+        // 删除缓存的订阅信息
+        subscribeHolder.removeAllSubscribe(parentPlatform.getServerGBId());
         if (deleteResult) {
             return new ResponseEntity<>("success", HttpStatus.OK);
         } else {
@@ -341,7 +343,6 @@ public ResponseEntity<String> exitPlatform(@PathVariable String serverGBId) {
      * @param platformId  上级平台ID
      * @param query       查询内容
      * @param online      是否在线
-     * @param choosed     是否已选中
      * @param channelType 通道类型
      * @return
      */

File: src/main/java/com/genersoft/iot/vmp/storager/impl/VideoManagerStoragerImpl.java
Patch:
@@ -885,9 +885,9 @@ public void updateMedia(StreamPushItem streamPushItem) {
 			List<ParentPlatform> parentPlatforms = parentPlatformMapper.selectAllAhareAllLiveStream();
 			if (parentPlatforms.size() > 0) {
 				for (ParentPlatform parentPlatform : parentPlatforms) {
-					StreamProxyItem streamProxyItems = platformGbStreamMapper.selectOne(streamPushItem.getApp(), streamPushItem.getStream(),
+					StreamProxyItem streamProxyItem = platformGbStreamMapper.selectOne(streamPushItem.getApp(), streamPushItem.getStream(),
 							parentPlatform.getServerGBId());
-					if (streamProxyItems == null) {
+					if (streamProxyItem == null) {
 						streamPushItem.setCatalogId(parentPlatform.getCatalogId());
 						streamPushItem.setPlatformId(parentPlatform.getServerGBId());
 						platformGbStreamMapper.add(streamPushItem);

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMRTPServerFactory.java
Patch:
@@ -95,7 +95,7 @@ public int createRTPServer(MediaServerItem mediaServerItem, String streamId) {
             if (openRtpServerResultJson.getInteger("code") == 0) {
                 result= openRtpServerResultJson.getInteger("port");
             }else {
-                logger.error("创建RTP Server 失败 {}: " + openRtpServerResultJson.getString("msg"),  param.get("port"));
+                logger.error("创建RTP Server 失败 {}: ", openRtpServerResultJson.getString("msg"));
             }
         }else {
             //  检查ZLM状态

File: src/main/java/com/genersoft/iot/vmp/utils/node/ForestNode.java
Patch:
@@ -15,8 +15,8 @@ public class ForestNode extends BaseNode<ForestNode> {
 	 */
 	private Object content;
 
-	public ForestNode(int id, String parentId, Object content) {
-		this.id = id;
+	public ForestNode(String id, String parentId, Object content) {
+		this.channelId = id;
 		this.parentId = parentId;
 		this.content = content;
 	}

File: src/main/java/com/genersoft/iot/vmp/utils/node/ForestNodeMerger.java
Patch:
@@ -25,7 +25,7 @@ public static <T extends INode<T>> List<T> merge(List<T> items) {
 				if (node != null) {
 					node.getChildren().add(forestNode);
 				} else {
-					forestNodeManager.addParentId(forestNode.getId());
+					forestNodeManager.addParentId(forestNode.getChannelId());
 				}
 			}
 		});
@@ -37,8 +37,8 @@ public static <T extends INode<T>> List<T> merge(List<T> items, String[] parentI
 		items.forEach(forestNode -> {
 			if (forestNode.getParentId() != null) {
 				INode<T> node = forestNodeManager.getTreeNodeAt(forestNode.getParentId());
-				if (CollectionUtil.contains(parentIds, forestNode.getId())){
-					forestNodeManager.addParentId(forestNode.getId());
+				if (CollectionUtil.contains(parentIds, forestNode.getChannelId())){
+					forestNodeManager.addParentId(forestNode.getChannelId());
 				} else {
 					if (node != null){
 						node.getChildren().add(forestNode);

File: src/main/java/com/genersoft/iot/vmp/utils/node/INode.java
Patch:
@@ -14,7 +14,7 @@ public interface INode<T> extends Serializable {
 	 *
 	 * @return String
 	 */
-	int getId();
+	String getChannelId();
 
 	/**
 	 * 父主键

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/response/impl/RegisterResponseProcessor.java
Patch:
@@ -100,7 +100,6 @@ public void process(ResponseEvent evt) {
 				subscribeHolder.removeCatalogSubscribe(platformGBId);
 				subscribeHolder.removeMobilePositionSubscribe(platformGBId);
 			}
-
 		}
 	}
 

File: src/main/java/com/genersoft/iot/vmp/storager/impl/VideoManagerStoragerImpl.java
Patch:
@@ -543,7 +543,7 @@ public boolean updateParentPlatform(ParentPlatform parentPlatform) {
 			if (parentPlatformCatch == null) { // serverGBId 已变化
 				ParentPlatform parentPlatById = platformMapper.getParentPlatById(parentPlatform.getId());
 				// 使用旧的查出缓存ID
-				parentPlatformCatch = redisCatchStorage.queryPlatformCatchInfo(parentPlatById.getServerGBId());
+				parentPlatformCatch = new ParentPlatformCatch();
 				parentPlatformCatch.setId(parentPlatform.getServerGBId());
 				redisCatchStorage.delPlatformCatchInfo(parentPlatById.getServerGBId());
 			}

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/impl/SIPCommanderFroPlatform.java
Patch:
@@ -563,6 +563,9 @@ public boolean recordInfo(DeviceChannel deviceChannel, ParentPlatform parentPlat
 
     @Override
     public void streamByeCmd(ParentPlatform platform, String callId) {
+        if (platform == null) {
+            return;
+        }
         SendRtpItem sendRtpItem = redisCatchStorage.querySendRTPServer(platform.getServerGBId(), null, null, callId);
         if (sendRtpItem != null) {
             String mediaServerId = sendRtpItem.getMediaServerId();

File: src/main/java/com/genersoft/iot/vmp/storager/impl/VideoManagerStoragerImpl.java
Patch:
@@ -717,7 +717,7 @@ public boolean addStreamProxy(StreamProxyItem streamProxyItem) {
 		try {
 			if (streamProxyMapper.add(streamProxyItem) > 0) {
 				if (!StringUtils.isEmpty(streamProxyItem.getGbId())) {
-					if (gbStreamMapper.add(streamProxyItem) > 0) {
+					if (gbStreamMapper.add(streamProxyItem) < 0) {
 						//事务回滚
 						dataSourceTransactionManager.rollback(transactionStatus);
 						return false;

File: src/main/java/com/genersoft/iot/vmp/storager/impl/VideoManagerStoragerImpl.java
Patch:
@@ -717,7 +717,7 @@ public boolean addStreamProxy(StreamProxyItem streamProxyItem) {
 		try {
 			if (streamProxyMapper.add(streamProxyItem) > 0) {
 				if (!StringUtils.isEmpty(streamProxyItem.getGbId())) {
-					if (gbStreamMapper.add(streamProxyItem) > 0) {
+					if (gbStreamMapper.add(streamProxyItem) < 0) {
 						//事务回滚
 						dataSourceTransactionManager.rollback(transactionStatus);
 						return false;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/InviteRequestProcessor.java
Patch:
@@ -364,8 +364,6 @@ public void process(RequestEvent evt) {
 					}
 
 					// 写入redis， 超时时回复
-					redisCatchStorage.updateSendRTPSever(sendRtpItem);
-
 					sendRtpItem.setStatus(1);
 					redisCatchStorage.updateSendRTPSever(sendRtpItem);
 					StringBuffer content = new StringBuffer(200);

File: src/main/java/com/genersoft/iot/vmp/service/impl/PlayServiceImpl.java
Patch:
@@ -117,7 +117,7 @@ public PlayResult play(MediaServerItem mediaServerItem, String deviceId, String
             // 点播超时回复BYE
             cmder.streamByeCmd(device.getDeviceId(), channelId, streamInfo.getStream());
             // 释放rtpserver
-            mediaServerService.closeRTPServer(playResult.getDevice(), channelId, streamInfo.getStream());
+            mediaServerService.closeRTPServer(playResult.getDevice().getDeviceId(), channelId, streamInfo.getStream());
             // 回复之前所有的点播请求
             resultHolder.invokeAllResult(msg);
             // TODO 释放ssrc

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMRunner.java
Patch:
@@ -92,6 +92,7 @@ public void run(String... strings) throws Exception {
 
         // 获取所有的zlm， 并开启主动连接
         List<MediaServerItem> all = mediaServerService.getAllFromDatabase();
+        mediaServerService.updateVmServer(all);
         if (all.size() == 0) {
             all.add(mediaConfig.getMediaSerItem());
         }

File: src/main/java/com/genersoft/iot/vmp/vmanager/server/ServerController.java
Patch:
@@ -158,6 +158,7 @@ public WVPResult<String> saveMediaServer(@RequestBody  MediaServerItem mediaServ
     public WVPResult<String> deleteMediaServer(@RequestParam  String id){
         if (mediaServerService.getOne(id) != null) {
             mediaServerService.delete(id);
+            mediaServerService.deleteDb(id);
         }else {
             WVPResult<String> result = new WVPResult<>();
             result.setCode(-1);

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMRunner.java
Patch:
@@ -92,6 +92,7 @@ public void run(String... strings) throws Exception {
 
         // 获取所有的zlm， 并开启主动连接
         List<MediaServerItem> all = mediaServerService.getAllFromDatabase();
+        mediaServerService.updateVmServer(all);
         if (all.size() == 0) {
             all.add(mediaConfig.getMediaSerItem());
         }

File: src/main/java/com/genersoft/iot/vmp/service/IMediaServerService.java
Patch:
@@ -42,6 +42,8 @@ public interface IMediaServerService {
 
     void setZLMConfig(MediaServerItem mediaServerItem, boolean restart);
 
+    void updateVmServer(List<MediaServerItem>  mediaServerItemList);
+
     SSRCInfo openRTPServer(MediaServerItem mediaServerItem, String streamId);
 
     SSRCInfo openRTPServer(MediaServerItem mediaServerItem, String streamId, boolean isPlayback);

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMHttpHookSubscribe.java
Patch:
@@ -91,7 +91,7 @@ public void removeSubscribe(HookType type, JSONObject hookResponse) {
                 }
             }
             if (null != result && result){
-                iterator.remove();
+                eventMap.remove(key);
             }
         }
     }

File: src/main/java/com/genersoft/iot/vmp/gb28181/event/subscribe/catalog/CatalogEventLister.java
Patch:
@@ -60,7 +60,7 @@ public void onApplicationEvent(CatalogEvent event) {
         Map<String, List<ParentPlatform>> parentPlatformMap = new HashMap<>();
         if (event.getPlatformId() != null) {
             parentPlatform = storager.queryParentPlatByServerGBId(event.getPlatformId());
-            if (!parentPlatform.isStatus())return;
+            if (parentPlatform != null && !parentPlatform.isStatus())return;
             String key = VideoManagerConstants.SIP_SUBSCRIBE_PREFIX + userSetup.getServerId() +  "_Catalog_" + event.getPlatformId();
             subscribe = redisCatchStorage.getSubscribe(key);
             if (subscribe == null) return;

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/notify/cmd/CatalogNotifyMessageHandler.java
Patch:
@@ -98,7 +98,6 @@ public void handForPlatform(RequestEvent evt, ParentPlatform parentPlatform, Ele
                     DeviceChannel deviceChannel = storager.queryChannel(channelReduce.getDeviceId(), channelReduce.getChannelId());
                     deviceChannel.setParental(0);
                     deviceChannel.setParentId(channelReduce.getCatalogId());
-
                     cmderFroPlatform.catalogQuery(deviceChannel, parentPlatform, sn, fromHeader.getTag(), size);
                     // 防止发送过快
                     Thread.sleep(50);

File: src/main/java/com/genersoft/iot/vmp/storager/dao/GbStreamMapper.java
Patch:
@@ -19,6 +19,7 @@ public interface GbStreamMapper {
             "('${app}', '${stream}', '${gbId}', '${name}', " +
             "'${longitude}', '${latitude}', '${streamType}', " +
             "'${mediaServerId}', ${status}, ${createStamp})")
+    @Options(useGeneratedKeys = true, keyProperty = "gbStreamId", keyColumn = "gbStreamId")
     int add(GbStream gbStream);
 
     @Update("UPDATE gb_stream " +

File: src/main/java/com/genersoft/iot/vmp/utils/node/BaseNode.java
Patch:
@@ -18,7 +18,7 @@ public class BaseNode<T> implements INode<T> {
 	/**
 	 * 主键ID
 	 */
-	protected String id;
+	protected int id;
 
 	/**
 	 * 父节点ID

File: src/main/java/com/genersoft/iot/vmp/utils/node/ForestNode.java
Patch:
@@ -19,7 +19,7 @@ public class ForestNode extends BaseNode<ForestNode> {
 	 */
 	private Object content;
 
-	public ForestNode(String id, String parentId, Object content) {
+	public ForestNode(int id, String parentId, Object content) {
 		this.id = id;
 		this.parentId = parentId;
 		this.content = content;

File: src/main/java/com/genersoft/iot/vmp/utils/node/ForestNodeManager.java
Patch:
@@ -17,12 +17,12 @@ public class ForestNodeManager<T extends INode<T>> {
 	/**
 	 * 森林的所有节点
 	 */
-	private final ImmutableMap<String, T> nodeMap;
+	private final ImmutableMap<Integer, T> nodeMap;
 
 	/**
 	 * 森林的父节点ID
 	 */
-	private final Map<String, Object> parentIdMap = Maps.newHashMap();
+	private final Map<Integer, Object> parentIdMap = Maps.newHashMap();
 
 	public ForestNodeManager(List<T> nodes) {
 		nodeMap = Maps.uniqueIndex(nodes, INode::getId);
@@ -46,7 +46,7 @@ public INode<T> getTreeNodeAt(String id) {
 	 *
 	 * @param parentId 父节点ID
 	 */
-	public void addParentId(String parentId) {
+	public void addParentId(int parentId) {
 		parentIdMap.put(parentId, "");
 	}
 

File: src/main/java/com/genersoft/iot/vmp/utils/node/INode.java
Patch:
@@ -14,7 +14,7 @@ public interface INode<T> extends Serializable {
 	 *
 	 * @return String
 	 */
-	String getId();
+	int getId();
 
 	/**
 	 * 父主键

File: src/main/java/com/genersoft/iot/vmp/vmanager/bean/DeviceChannelTree.java
Patch:
@@ -19,7 +19,7 @@ public class DeviceChannelTree extends DeviceChannel implements INode<DeviceChan
     /**
      * 主键ID
      */
-    private String id;
+    private int id;
 
     /**
      * 父节点ID

File: src/main/java/com/genersoft/iot/vmp/storager/impl/VideoManagerStoragerImpl.java
Patch:
@@ -707,7 +707,7 @@ public boolean addStreamProxy(StreamProxyItem streamProxyItem) {
 		try {
 			if (streamProxyMapper.add(streamProxyItem) > 0) {
 				if (!StringUtils.isEmpty(streamProxyItem.getGbId())) {
-					if (gbStreamMapper.add(streamProxyItem) > 0) {
+					if (gbStreamMapper.add(streamProxyItem) < 0) {
 						//事务回滚
 						dataSourceTransactionManager.rollback(transactionStatus);
 						return false;
@@ -742,7 +742,7 @@ public boolean updateStreamProxy(StreamProxyItem streamProxyItem) {
 		try {
 			if (streamProxyMapper.update(streamProxyItem) > 0) {
 				if (!StringUtils.isEmpty(streamProxyItem.getGbId())) {
-					if (gbStreamMapper.update(streamProxyItem) > 0) {
+					if (gbStreamMapper.update(streamProxyItem) < 0) {
 						//事务回滚
 						dataSourceTransactionManager.rollback(transactionStatus);
 						return false;

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMMediaListManager.java
Patch:
@@ -138,6 +138,7 @@ public StreamPushItem addPush(MediaItem mediaItem) {
             if (gbStreamMapper.selectOne(transform.getApp(), transform.getStream()) != null) {
                 gbStreamMapper.update(transform);
             }else {
+                transform.setCreateStamp(System.currentTimeMillis());
                 gbStreamMapper.add(transform);
             }
         }

File: src/main/java/com/genersoft/iot/vmp/service/impl/GbStreamServiceImpl.java
Patch:
@@ -117,7 +117,7 @@ public boolean delPlatformInfo(String platformId, List<GbStream> gbStreams) {
         try {
             List<DeviceChannel> deviceChannelList = new ArrayList<>();
             for (GbStream gbStream : gbStreams) {
-                platformGbStreamMapper.delByAppAndStream(gbStream.getApp(), gbStream.getStream());
+                platformGbStreamMapper.delByAppAndStreamAndPlatform(gbStream.getApp(), gbStream.getStream(), platformId);
                 DeviceChannel deviceChannel = new DeviceChannel();
                 deviceChannel.setChannelId(gbStream.getGbId());
                 deviceChannelList.add(deviceChannel);

File: src/main/java/com/genersoft/iot/vmp/service/impl/StreamPushServiceImpl.java
Patch:
@@ -125,6 +125,7 @@ public List<StreamPushItem> getPushList(String mediaServerId) {
     public boolean saveToGB(GbStream stream) {
         stream.setStreamType("push");
         stream.setStatus(true);
+        stream.setCreateStamp(System.currentTimeMillis());
         int add = gbStreamMapper.add(stream);
 
         // 查找开启了全部直播流共享的上级平台
@@ -305,6 +306,7 @@ public boolean saveToRandomGB() {
             streamPushItem.setStreamType("push");
             streamPushItem.setStatus(true);
             streamPushItem.setGbId("34020000004111" + gbId);
+            streamPushItem.setCreateStamp(System.currentTimeMillis());
             gbId ++;
         }
         int  limitCount = 30;

File: src/main/java/com/genersoft/iot/vmp/service/impl/StreamPushUploadFileHandler.java
Patch:
@@ -56,7 +56,7 @@ public void invoke(StreamPushExcelDto streamPushExcelDto, AnalysisContext analys
         streamPushItem.setGbId(streamPushExcelDto.getGbId());
         streamPushItem.setStatus(false);
         streamPushItem.setStreamType("push");
-        streamPushItem.setCreateStamp(System.currentTimeMillis()/1000);
+        streamPushItem.setCreateStamp(System.currentTimeMillis());
         streamPushItem.setMediaServerId(defaultMediaServerId);
         streamPushItem.setName(streamPushExcelDto.getName());
         streamPushItem.setOriginType(2);

File: src/main/java/com/genersoft/iot/vmp/storager/dao/PlatformGbStreamMapper.java
Patch:
@@ -73,6 +73,6 @@ public interface PlatformGbStreamMapper {
             "</script> ")
     List<ParentPlatform> queryPlatFormListForGBWithGBId(String app, String stream, List<String> platforms);
 
-    @Select("SELECT * FROM platform_gb_stream WHERE app=#{app} AND stream=#{stream} AND platformId=#{platformId}")
-    int delByAppAndStreamAndPlatform(String app, String streamId, String platformId);
+    @Delete("DELETE FROM platform_gb_stream WHERE app=#{app} AND stream=#{stream} AND platformId=#{platformId}")
+    int delByAppAndStreamAndPlatform(String app, String stream, String platformId);
 }

File: src/main/java/com/genersoft/iot/vmp/storager/impl/VideoManagerStoragerImpl.java
Patch:
@@ -679,6 +679,7 @@ public boolean addStreamProxy(StreamProxyItem streamProxyItem) {
 		streamProxyItem.setStatus(true);
 		String now = this.format.format(System.currentTimeMillis());
 		streamProxyItem.setCreateTime(now);
+		streamProxyItem.setCreateStamp(System.currentTimeMillis());
 		try {
 			if (gbStreamMapper.add(streamProxyItem)<0 || streamProxyMapper.add(streamProxyItem) < 0) {
 				//事务回滚

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/device/DeviceQuery.java
Patch:
@@ -316,7 +316,8 @@ public ResponseEntity<WVPResult<String>> updateDevice(Device device){
 			if (!StringUtils.isEmpty(device.getCharset())) deviceInStore.setCharset(device.getCharset());
 			if (!StringUtils.isEmpty(device.getMediaServerId())) deviceInStore.setMediaServerId(device.getMediaServerId());
 
-			if (deviceInStore.getSubscribeCycleForCatalog() <=0 && device.getSubscribeCycleForCatalog() > 0) {
+			if ((deviceInStore.getSubscribeCycleForCatalog() <=0 && device.getSubscribeCycleForCatalog() > 0)
+					|| deviceInStore.getSubscribeCycleForCatalog() != device.getSubscribeCycleForCatalog()) {
 				deviceInStore.setSubscribeCycleForCatalog(device.getSubscribeCycleForCatalog());
 				// 开启订阅
 				deviceService.addCatalogSubscribe(deviceInStore);

File: src/main/java/com/genersoft/iot/vmp/common/VideoManagerConstants.java
Patch:
@@ -64,7 +64,7 @@ public class VideoManagerConstants {
 
 	//************************** redis 消息*********************************
 	public static final String WVP_MSG_STREAM_CHANGE_PREFIX = "WVP_MSG_STREAM_CHANGE_";
-	public static final String WVP_MSG_GPS_PREFIX = "WVP_MSG_GPS_";
+	public static final String WVP_MSG_GPS_PREFIX = "VM_MSG_GPS";
 
 	//**************************    第三方  ****************************************
 	public static final String WVP_STREAM_GB_ID_PREFIX = "memberNo_";

File: src/main/java/com/genersoft/iot/vmp/storager/dao/PlatformChannelMapper.java
Patch:
@@ -83,7 +83,7 @@ public interface PlatformChannelMapper {
             "left join platform_gb_channel pgc on " +
             "pp.serverGBId = pgc.platformId " +
             "WHERE " +
-            "pgc.channelId = #{channelId} pp.status = true " +
+            "pgc.channelId = #{channelId} and pp.status = true " +
             "AND pp.serverGBId IN" +
             "<foreach collection='platforms'  item='item'  open='(' separator=',' close=')' > #{item}</foreach>" +
             "</script> ")

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/CatalogResponseMessageHandler.java
Patch:
@@ -166,10 +166,11 @@ public void handForDevice(RequestEvent evt, Device device, Element element) {
                     } else {
                         deviceChannel.setLatitude(0.00);
                     }
-                    if (getText(itemDevice, "PTZType") == null || getText(itemDevice, "PTZType") == "") {
+                    Element InfoNode = channelDeviceElement.element("Info");
+                    if (getText(InfoNode, "PTZType") == null || getText(InfoNode, "PTZType") == "") {
                         deviceChannel.setPTZType(0);
                     } else {
-                        deviceChannel.setPTZType(Integer.parseInt(getText(itemDevice, "PTZType")));
+                        deviceChannel.setPTZType(Integer.parseInt(getText(InfoNode, "PTZType")));
                     }
                     deviceChannel.setHasAudio(true); // 默认含有音频，播放时再检查是否有音频及是否AAC
                     channelList.add(deviceChannel);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/event/request/impl/message/response/cmd/CatalogResponseMessageHandler.java
Patch:
@@ -166,10 +166,11 @@ public void handForDevice(RequestEvent evt, Device device, Element element) {
                     } else {
                         deviceChannel.setLatitude(0.00);
                     }
-                    if (getText(itemDevice, "PTZType") == null || getText(itemDevice, "PTZType") == "") {
+                    Element InfoNode = channelDeviceElement.element("Info");
+                    if (getText(InfoNode, "PTZType") == null || getText(InfoNode, "PTZType") == "") {
                         deviceChannel.setPTZType(0);
                     } else {
-                        deviceChannel.setPTZType(Integer.parseInt(getText(itemDevice, "PTZType")));
+                        deviceChannel.setPTZType(Integer.parseInt(getText(InfoNode, "PTZType")));
                     }
                     deviceChannel.setHasAudio(true); // 默认含有音频，播放时再检查是否有音频及是否AAC
                     channelList.add(deviceChannel);

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/device/DeviceControl.java
Patch:
@@ -108,10 +108,10 @@ public DeferredResult<ResponseEntity<String>> recordApi(@PathVariable String dev
 			msg.setData("Timeout. Device did not response to this command.");
 			resultHolder.invokeAllResult(msg);
 		});
-		resultHolder.put(key, uuid, result);
 		if (resultHolder.exist(key, null)){
 			return result;
 		}
+		resultHolder.put(key, uuid, result);
 		cmder.recordCmd(device, channelId, recordCmdStr, event -> {
             RequestMessage msg = new RequestMessage();
 			msg.setId(uuid);

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/playback/DownloadController.java
Patch:
@@ -88,10 +88,10 @@ public DeferredResult<ResponseEntity<String>> play(@PathVariable String deviceId
 			msg.setData("Timeout");
 			resultHolder.invokeAllResult(msg);
 		});
-		resultHolder.put(key, uuid, result);
 		if(resultHolder.exist(key, null)) {
 			return result;
 		}
+		resultHolder.put(key, uuid, result);
 		Device device = storager.queryVideoDevice(deviceId);
 		StreamInfo streamInfo = redisCatchStorage.queryPlaybackByDevice(deviceId, channelId);
 		if (streamInfo != null) {

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/device/DeviceControl.java
Patch:
@@ -108,10 +108,10 @@ public DeferredResult<ResponseEntity<String>> recordApi(@PathVariable String dev
 			msg.setData("Timeout. Device did not response to this command.");
 			resultHolder.invokeAllResult(msg);
 		});
-		resultHolder.put(key, uuid, result);
 		if (resultHolder.exist(key, null)){
 			return result;
 		}
+		resultHolder.put(key, uuid, result);
 		cmder.recordCmd(device, channelId, recordCmdStr, event -> {
             RequestMessage msg = new RequestMessage();
 			msg.setId(uuid);

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/playback/DownloadController.java
Patch:
@@ -88,10 +88,10 @@ public DeferredResult<ResponseEntity<String>> play(@PathVariable String deviceId
 			msg.setData("Timeout");
 			resultHolder.invokeAllResult(msg);
 		});
-		resultHolder.put(key, uuid, result);
 		if(resultHolder.exist(key, null)) {
 			return result;
 		}
+		resultHolder.put(key, uuid, result);
 		Device device = storager.queryVideoDevice(deviceId);
 		StreamInfo streamInfo = redisCatchStorage.queryPlaybackByDevice(deviceId, channelId);
 		if (streamInfo != null) {

File: src/main/java/com/genersoft/iot/vmp/storager/dao/DeviceMapper.java
Patch:
@@ -33,6 +33,7 @@ public interface DeviceMapper {
                 "createTime," +
                 "updateTime," +
                 "charset," +
+                "subscribeCycleForCatalog," +
                 "online" +
             ") VALUES (" +
                 "#{deviceId}," +
@@ -51,6 +52,7 @@ public interface DeviceMapper {
                 "#{createTime}," +
                 "#{updateTime}," +
                 "#{charset}," +
+                "#{subscribeCycleForCatalog}," +
                 "#{online}" +
             ")")
     int add(Device device);
@@ -72,6 +74,7 @@ public interface DeviceMapper {
                 "<if test=\"keepaliveTime != null\">, keepaliveTime='${keepaliveTime}'</if>" +
                 "<if test=\"expires != null\">, expires=${expires}</if>" +
                 "<if test=\"charset != null\">, charset='${charset}'</if>" +
+                "<if test=\"subscribeCycleForCatalog != null\">, subscribeCycleForCatalog=#{subscribeCycleForCatalog}</if>" +
                 "WHERE deviceId='${deviceId}'"+
             " </script>"})
     int update(Device device);

File: src/main/java/com/genersoft/iot/vmp/vmanager/gb28181/ptz/PtzController.java
Patch:
@@ -54,7 +54,7 @@ public class PtzController {
 	@ApiImplicitParams({
 			@ApiImplicitParam(name = "deviceId", value = "设备ID", dataTypeClass = String.class),
 			@ApiImplicitParam(name = "channelId", value = "通道ID", dataTypeClass = String.class),
-			@ApiImplicitParam(name = "command", value = "控制指令,允许值: left, right, up, down, upleft, upright, downleft, downright, zoomin, zoomout, stop", dataTypeClass = Integer.class),
+			@ApiImplicitParam(name = "command", value = "控制指令,允许值: left, right, up, down, upleft, upright, downleft, downright, zoomin, zoomout, stop", dataTypeClass = String.class),
 			@ApiImplicitParam(name = "horizonSpeed", value = "水平速度", dataTypeClass = Integer.class),
 			@ApiImplicitParam(name = "verticalSpeed", value = "垂直速度", dataTypeClass = Integer.class),
 			@ApiImplicitParam(name = "zoomSpeed", value = "缩放速度", dataTypeClass = Integer.class),

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMRunner.java
Patch:
@@ -111,7 +111,7 @@ public void run() {
 
     public ZLMServerConfig getMediaServerConfig(MediaServerItem mediaServerItem) {
         if (startGetMedia == null) { return null;}
-        if (mediaServerService.getOne(mediaServerItem.getId()) == null) {
+        if (!mediaServerItem.isDefaultServer() && mediaServerService.getOne(mediaServerItem.getId()) == null) {
             return null;
         }
         if ( startGetMedia.get(mediaServerItem.getId()) == null || !startGetMedia.get(mediaServerItem.getId())) {

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/SIPRequestHeaderPlarformProvider.java
Patch:
@@ -70,7 +70,7 @@ public Request createRegisterRequest(@NotNull ParentPlatform platform, long CSeq
 		Request request = null;
 		String sipAddress = sipConfig.getSipIp() + ":" + sipConfig.getSipPort();
 		//请求行
-		SipURI requestLine = sipFactory.createAddressFactory().createSipURI(platform.getDeviceGBId(),
+		SipURI requestLine = sipFactory.createAddressFactory().createSipURI(platform.getServerGBId(),
 				platform.getServerIP() + ":" + platform.getServerPort());
 		//via
 		ArrayList<ViaHeader> viaHeaders = new ArrayList<ViaHeader>();

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMRunner.java
Patch:
@@ -44,7 +44,7 @@ public class ZLMRunner implements CommandLineRunner {
     @Value("${server.port}")
     private String serverPort;
 
-    @Value("${server.ssl.enabled}")
+    @Value("${server.ssl.enabled:false}")
     private boolean sslEnabled;
 
     private boolean startGetMedia = false;
@@ -115,7 +115,7 @@ private void saveZLMConfig() {
         }
         Map<String, Object> param = new HashMap<>();
         param.put("api.secret",mediaConfig.getSecret()); // -profile:v Baseline
-        param.put("ffmpeg.cmd","%s -fflags nobuffer -rtsp_transport tcp -i %s -c:a aac -strict -2 -ar 44100 -ab 48k -c:v libx264  -f flv %s");
+//        param.put("ffmpeg.cmd","%s -fflags nobuffer -rtsp_transport tcp -i %s -c:a aac -strict -2 -ar 44100 -ab 48k -c:v libx264  -f flv %s");
         param.put("hook.enable","1");
         param.put("hook.on_flow_report","");
         param.put("hook.on_play",String.format("%s/on_play", hookPrex));

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMRunner.java
Patch:
@@ -123,7 +123,7 @@ private void saveZLMConfig() {
         param.put("ffmpeg.cmd","%s -fflags nobuffer -rtsp_transport tcp -i %s -c:a aac -strict -2 -ar 44100 -ab 48k -c:v libx264  -f flv %s");
         param.put("hook.enable","1");
         param.put("hook.on_flow_report","");
-        param.put("hook.on_play","");
+        param.put("hook.on_play",String.format("%s/on_play", hookPrex));
         param.put("hook.on_http_access","");
         param.put("hook.on_publish",String.format("%s/on_publish", hookPrex));
         param.put("hook.on_record_mp4","");

File: src/main/java/com/genersoft/iot/vmp/storager/dao/ParentPlatformMapper.java
Patch:
@@ -14,10 +14,10 @@
 public interface ParentPlatformMapper {
 
     @Insert("INSERT INTO parent_platform (enable, name, serverGBId, serverGBDomain, serverIP, serverPort, deviceGBId, deviceIp,  " +
-            "            devicePort, username, password, expires, keepTimeout, transport, characterSet, PTZEnable, rtcp, " +
+            "            devicePort, username, password, expires, keepTimeout, transport, characterSet, ptz, rtcp, " +
             "            status) " +
             "            VALUES (${enable}, '${name}', '${serverGBId}', '${serverGBDomain}', '${serverIP}', ${serverPort}, '${deviceGBId}', '${deviceIp}', " +
-            "            '${devicePort}', '${username}', '${password}', '${expires}', '${keepTimeout}', '${transport}', '${characterSet}', ${PTZEnable}, ${rtcp}, " +
+            "            '${devicePort}', '${username}', '${password}', '${expires}', '${keepTimeout}', '${transport}', '${characterSet}', ${ptz}, ${rtcp}, " +
             "            ${status})")
     int addParentPlatform(ParentPlatform parentPlatform);
 
@@ -36,7 +36,7 @@ public interface ParentPlatformMapper {
             "keepTimeout=#{keepTimeout}, " +
             "transport=#{transport}, " +
             "characterSet=#{characterSet}, " +
-            "PTZEnable=#{PTZEnable}, " +
+            "ptz=#{ptz}, " +
             "rtcp=#{rtcp}, " +
             "status=#{status} " +
             "WHERE serverGBId=#{serverGBId}")

File: src/main/java/com/genersoft/iot/vmp/common/VideoManagerConstants.java
Patch:
@@ -28,6 +28,8 @@ public class VideoManagerConstants {
 
 	public static final String PLATFORM_REGISTER_PREFIX = "VMP_platform_register_";
 
+	public static final String PLATFORM_REGISTER_INFO_PREFIX = "VMP_platform_register_info_";
+
 	public static final String Pattern_Topic = "VMP_keeplive_platform_";
 
 	public static final String EVENT_ONLINE_REGISTER = "1";

File: src/main/java/com/genersoft/iot/vmp/conf/SipPlatformRunner.java
Patch:
@@ -45,11 +45,11 @@ public void run(String... args) throws Exception {
             ParentPlatformCatch parentPlatformCatch = new ParentPlatformCatch();
 
             parentPlatformCatch.setParentPlatform(parentPlatform);
-            parentPlatformCatch.setId(parentPlatform.getDeviceGBId());
+            parentPlatformCatch.setId(parentPlatform.getServerGBId());
             redisCatchStorage.updatePlatformCatchInfo(parentPlatformCatch);
 
             // 发送平台未注册消息
-            publisher.platformNotRegisterEventPublish(parentPlatform.getDeviceGBId());
+            publisher.platformNotRegisterEventPublish(parentPlatform.getServerGBId());
         }
     }
 }

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/SIPProcessorFactory.java
Patch:
@@ -119,6 +119,9 @@ public ISIPRequestProcessor createRequestProcessor(RequestEvent evt) {
 			processor.setRequestEvent(evt);
 			processor.setTcpSipProvider(getTcpSipProvider());
 			processor.setUdpSipProvider(getUdpSipProvider());
+
+			processor.setCmderFroPlatform(cmderFroPlatform);
+			processor.setStorager(storager);
 			return processor;
 		} else if (Request.REGISTER.equals(method)) {
 			RegisterRequestProcessor processor = new RegisterRequestProcessor();

File: src/main/java/com/genersoft/iot/vmp/storager/IVideoManagerStorager.java
Patch:
@@ -233,4 +233,5 @@ public interface IVideoManagerStorager {
 	int delChannelForGB(String platformId, List<ChannelReduce> channelReduces);
 
 
+    DeviceChannel queryChannelInParentPlatform(String platformId, String channelId);
 }

File: src/main/java/com/genersoft/iot/vmp/storager/dao/DeviceChannelMapper.java
Patch:
@@ -83,19 +83,19 @@ public interface DeviceChannelMapper {
             "SELECT * FROM ( "+
                 " SELECT dc.channelId, dc.deviceId, dc.name, de.manufacturer, de.hostAddress, " +
                 "(SELECT count(0) FROM device_channel WHERE parentId=dc.channelId) as subCount, " +
-                "pc.platformId " +
+                "(SELECT pc.platformId FROM platform_gb_channel pc WHERE pc.deviceId=dc.deviceId AND pc.channelId = dc.channelId ) as platformId " +
                 "FROM device_channel dc " +
                 "LEFT JOIN device de ON dc.deviceId = de.deviceId " +
-                "LEFT JOIN platform_gb_channel pc on pc.deviceId = dc.deviceId AND pc.channelId = dc.channelId " +
                 " WHERE 1=1 " +
                 " <if test=\"query != null\"> AND (dc.channelId LIKE '%${query}%' OR dc.name LIKE '%${query}%' OR dc.name LIKE '%${query}%')</if> " +
                 " <if test=\"online == true\" > AND dc.status=1</if> " +
                 " <if test=\"online == false\" > AND dc.status=0</if> " +
-                " <if test=\"platformId != null and inPlatform == true\"> AND pc.platformId=#{platformId} </if> " +
             ") dcr" +
             " WHERE 1=1 " +
             " <if test=\"hasSubChannel!= null and hasSubChannel == true\" >  AND subCount >0</if> " +
             " <if test=\"hasSubChannel!= null and hasSubChannel == false\" >  AND subCount=0</if> " +
+            " <if test=\"platformId != null and inPlatform == true \" >  AND platformId='${platformId}'</if> " +
+            " <if test=\"platformId != null and inPlatform == false \" >  AND (platformId != '${platformId}' OR platformId is NULL )  </if> " +
             " </script>"})
 
     List<ChannelReduce> queryChannelListInAll(String query, Boolean online, Boolean hasSubChannel, String platformId, Boolean inPlatform);

File: src/main/java/com/genersoft/iot/vmp/storager/dao/ParentPlatformMapper.java
Patch:
@@ -45,7 +45,7 @@ public interface ParentPlatformMapper {
     @Delete("DELETE FROM parent_platform WHERE deviceGBId=#{deviceGBId}")
     int delParentPlatform(ParentPlatform parentPlatform);
 
-    @Select("SELECT * FROM parent_platform")
+    @Select("SELECT *,( SELECT count(0) FROM platform_gb_channel pc WHERE pc.platformId = pp.deviceGBId) as channelCount FROM parent_platform pp ")
     List<ParentPlatform> getParentPlatformList();
 
     @Select("SELECT * FROM parent_platform WHERE enable=#{enable}")

File: src/main/java/com/genersoft/iot/vmp/web/ApiStreamController.java
Patch:
@@ -86,6 +86,8 @@ private DeferredResult<JSONObject> start(String serial ,
             JSONObject result = new JSONObject();
             result.put("error","timeout");
             resultDeferredResult.setResult(result);
+
+             // 清理RTP server
         });
 
         DeviceChannel deviceChannel = storager.queryChannel(serial, code);

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/impl/SIPCommander.java
Patch:
@@ -350,7 +350,7 @@ public StreamInfo playbackStreamCmd(Device device, String channelId, String star
 	        content.append("o="+sipConfig.getSipId()+" 0 0 IN IP4 "+sipConfig.getSipIp()+"\r\n");
 	        content.append("s=Playback\r\n");
 	        content.append("u="+channelId+":0\r\n");
-	        content.append("c=IN IP4 "+mediaInfo.getLocalIP()+"\r\n");
+	        content.append("c=IN IP4 "+mediaInfo.getWanIp()+"\r\n");
 	        content.append("t="+DateUtil.yyyy_MM_dd_HH_mm_ssToTimestamp(startTime)+" "
 					+DateUtil.yyyy_MM_dd_HH_mm_ssToTimestamp(endTime) +"\r\n");
 			String mediaPort = null;

File: src/main/java/com/genersoft/iot/vmp/vmanager/play/PlayController.java
Patch:
@@ -104,7 +104,7 @@ public ResponseEntity<String> play(@PathVariable String deviceId, @PathVariable
 				}
 			}
 		} else {
-			String flv = storager.getMediaInfo().getLocalIP() + ":" + storager.getMediaInfo().getHttpPort() + "/rtp/"
+			String flv = storager.getMediaInfo().getWanIp() + ":" + storager.getMediaInfo().getHttpPort() + "/rtp/"
 					+ streamId + ".flv";
 			streamInfo.setFlv("http://" + flv);
 			streamInfo.setWs_flv("ws://" + flv);

File: src/main/java/com/genersoft/iot/vmp/storager/redis/VideoManagerRedisStoragerImpl.java
Patch:
@@ -288,7 +288,7 @@ public PageResult<Device> queryVideoDeviceList(String[] deviceIds, int page, int
 				// devices.add((Device)redis.get((String)deviceIdList.get(i)));
 				device =(Device)redis.get((String)deviceIdList.get(i));
 				if (redis.scan(VideoManagerConstants.KEEPLIVEKEY_PREFIX+device.getDeviceId()).size() == 0){
-					outline(device.getDeviceId());
+					// outline(device.getDeviceId());
 				}
 				devices.add(device);
 			}
@@ -297,7 +297,7 @@ public PageResult<Device> queryVideoDeviceList(String[] deviceIds, int page, int
 				// devices.add((Device)redis.get(VideoManagerConstants.DEVICE_PREFIX+deviceIds[i]));
 				device = (Device)redis.get(VideoManagerConstants.DEVICE_PREFIX+deviceIds[i]);
 				if (redis.scan(VideoManagerConstants.KEEPLIVEKEY_PREFIX+device.getDeviceId()).size() == 0){
-					outline(device.getDeviceId());
+					// outline(device.getDeviceId());
 				}
 				devices.add(device);
 			}

File: src/main/java/com/genersoft/iot/vmp/gb28181/transmit/cmd/impl/SIPCommander.java
Patch:
@@ -538,7 +538,7 @@ public boolean recordInfoQuery(Device device, String channelId, String startTime
 			recordInfoXml.append("<DeviceID>" + channelId + "</DeviceID>\r\n");
 			recordInfoXml.append("<StartTime>" + DateUtil.yyyy_MM_dd_HH_mm_ssToISO8601(startTime) + "</StartTime>\r\n");
 			recordInfoXml.append("<EndTime>" + DateUtil.yyyy_MM_dd_HH_mm_ssToISO8601(endTime) + "</EndTime>\r\n");
-			recordInfoXml.append("<Secrecy>0</Secrecy>\\r\n");
+			recordInfoXml.append("<Secrecy>0</Secrecy>\r\n");
 			// 大华NVR要求必须增加一个值为all的文本元素节点Type
 			recordInfoXml.append("<Type>all</Type>\r\n");
 			recordInfoXml.append("</Query>\r\n");

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMHttpHookListener.java
Patch:
@@ -140,8 +140,6 @@ public ResponseEntity<String> onPublish(@RequestBody JSONObject json){
 			streamInfo.setRtmp(String.format("rtmp://%s:%s/rtp/%s", mediaInfo.getLocalIP(), mediaInfo.getRtmpPort(), streamId));
 			streamInfo.setHls(String.format("http://%s:%s/rtp/%s/hls.m3u8", mediaInfo.getLocalIP(), mediaInfo.getHttpPort(), streamId));
 			streamInfo.setRtsp(String.format("rtsp://%s:%s/rtp/%s", mediaInfo.getLocalIP(), mediaInfo.getRtspPort(), streamId));
-
-
 			storager.startPlay(streamInfo);
 		}
 

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMUtils.java
Patch:
@@ -37,7 +37,7 @@ public int getNewRTPPort(String ssrc) {
             System.out.println(jsonObject.toJSONString());
             return newPort;
         }else {
-            return getNewRTPPort(streamId);
+            return getNewRTPPort(ssrc);
         }
     }
 

File: src/main/java/com/genersoft/iot/vmp/storager/jdbc/VideoManagerJdbcStoragerImpl.java
Patch:
@@ -165,7 +165,7 @@ public PageResult querySubChannels(String deviceId, String channelId, String que
 
 	@Override
 	public void updateCatch() {
-
+		System.out.println("##################");
 	}
 
 	@Override

File: src/main/java/com/genersoft/iot/vmp/media/zlm/ZLMRunner.java
Patch:
@@ -99,6 +99,7 @@ private void saveZLMConfig() {
         param.put("secret",mediaSecret);
         param.put("hook.enable","1");
         param.put("hook.on_flow_report","");
+        param.put("hook.on_play","");
         param.put("hook.on_http_access","");
         param.put("hook.on_publish",String.format("%s/on_publish", hookPrex));
         param.put("hook.on_record_mp4","");
@@ -107,6 +108,7 @@ private void saveZLMConfig() {
         param.put("hook.on_rtsp_realm","");
         param.put("hook.on_server_started",String.format("%s/on_server_started", hookPrex));
         param.put("hook.on_shell_login",String.format("%s/on_shell_login", hookPrex));
+        param.put("hook.on_stream_changed",String.format("%s/on_stream_changed", hookPrex));
         param.put("hook.on_stream_none_reader",String.format("%s/on_stream_none_reader", hookPrex));
         param.put("hook.on_stream_not_found",String.format("%s/on_stream_not_found", hookPrex));
         param.put("hook.timeoutSec","20");

File: src/main/java/com/genersoft/iot/vmp/storager/IVideoManagerStorager.java
Patch:
@@ -1,6 +1,7 @@
 package com.genersoft.iot.vmp.storager;
 
 import java.util.List;
+import java.util.Map;
 
 import com.alibaba.fastjson.JSONObject;
 import com.genersoft.iot.vmp.common.PageResult;
@@ -180,4 +181,6 @@ public interface IVideoManagerStorager {
 	StreamInfo queryPlayBySSRC(String ssrc);
 
 	StreamInfo queryPlayByDevice(String deviceId, String code);
+
+	Map<String, StreamInfo> queryPlayByDeviceId(String deviceId);
 }

File: src/main/java/com/genersoft/iot/vmp/gb28181/session/SsrcUtil.java
Patch:
@@ -22,7 +22,7 @@ public class SsrcUtil {
 
 	private static void init() {
 		SipConfig sipConfig = (SipConfig) SpringBeanFactory.getBean("sipConfig");
-		ssrcPrefix = sipConfig.getSipDomain().substring(4, 9);
+		ssrcPrefix = sipConfig.getSipDomain().substring(3, 8);
 		isUsed = new ArrayList<String>();
 		notUsed = new ArrayList<String>();
 		for (int i = 1; i < 10000; i++) {

File: src/main/java/com/genersoft/iot/vmp/gb28181/utils/DateUtil.java
Patch:
@@ -46,7 +46,7 @@ public static long yyyy_MM_dd_HH_mm_ssToTimestamp(String formatTime) {
 		Date date;
 		try {
 			date = format.parse(formatTime);
-			Long timestamp=date.getTime();
+			Long timestamp=date.getTime()/1000;
 			//转换为Date类
 			return timestamp;
 		} catch (ParseException e) {

