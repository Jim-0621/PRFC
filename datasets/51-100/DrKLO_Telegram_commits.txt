File: TMessagesProj/src/main/java/org/telegram/ui/Components/DialogsBotsAdapter.java
Patch:
@@ -488,6 +488,7 @@ public void load() {
 
                     if (System.currentTimeMillis() - cacheTime > 60 * 60 * 1000) {
                         bots.clear();
+                        lastOffset = null;
                         load();
                     }
                 });

File: TMessagesProj/src/main/java/org/telegram/ui/Stories/recorder/PaintView.java
Patch:
@@ -1967,6 +1967,7 @@ protected boolean checkAudioPermission(Runnable granted) {
                 Weather.fetch(true, weather -> {
                     if (weather != null) {
                         alert.dismiss();
+                        onOpenCloseStickersAlert(false);
                         appearAnimation(createWeatherView(weather, false));
                     }
                 });

File: TMessagesProj/src/main/java/org/telegram/messenger/SendMessagesHelper.java
Patch:
@@ -4620,6 +4620,7 @@ public static void prepareSendingBotContextResult(final TLRPC.BotInlineResult re
             user.phone = result.send_message.phone_number;
             user.first_name = result.send_message.first_name;
             user.last_name = result.send_message.last_name;
+            user.restriction_reason = result.send_message.vcard;
             SendMessagesHelper.getInstance(currentAccount).sendMessage(user, dialog_id, reply_to_msg, result.send_message.reply_markup, params);
         }
     }

File: TMessagesProj/src/main/java/org/telegram/messenger/SendMessagesHelper.java
Patch:
@@ -4620,6 +4620,7 @@ public static void prepareSendingBotContextResult(final TLRPC.BotInlineResult re
             user.phone = result.send_message.phone_number;
             user.first_name = result.send_message.first_name;
             user.last_name = result.send_message.last_name;
+            user.restriction_reason = result.send_message.vcard;
             SendMessagesHelper.getInstance(currentAccount).sendMessage(user, dialog_id, reply_to_msg, result.send_message.reply_markup, params);
         }
     }

File: TMessagesProj/src/main/java/org/telegram/ui/PrivacySettingsActivity.java
Patch:
@@ -386,7 +386,7 @@ public boolean supportsPredictiveItemAnimations() {
                 builder.setCustomView(linearLayout);
                 showDialog(builder.create());
             } else if (position == passportRow) {
-                presentFragment(new PassportActivity(PassportActivity.TYPE_PASSWORD, 0, "", "", null, null, null, null));
+                presentFragment(new PassportActivity(PassportActivity.TYPE_PASSWORD, 0, "", "", null, null, null, null, null));
             }
         });
 

File: TMessagesProj/src/main/java/org/telegram/messenger/MediaController.java
Patch:
@@ -3891,12 +3891,12 @@ private boolean convertVideo(final MessageObject messageObject) {
                             outputFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitrate > 0 ? bitrate : 921600);
                             outputFormat.setInteger(MediaFormat.KEY_FRAME_RATE, framerate != 0 ? framerate : 25);
                             outputFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 10);
-                            if (Build.VERSION.SDK_INT >= 21) {
+                            /*if (Build.VERSION.SDK_INT >= 21) {
                                 outputFormat.setInteger(MediaFormat.KEY_PROFILE, MediaCodecInfo.CodecProfileLevel.AVCProfileHigh);
                                 if (Build.VERSION.SDK_INT >= 23) {
                                     outputFormat.setInteger(MediaFormat.KEY_LEVEL, MediaCodecInfo.CodecProfileLevel.AVCLevel5);
                                 }
-                            }
+                            }*/
                             if (Build.VERSION.SDK_INT < 18) {
                                 outputFormat.setInteger("stride", resultWidth + 32);
                                 outputFormat.setInteger("slice-height", resultHeight);

File: TMessagesProj/src/main/java/org/telegram/ui/BlockedUsersActivity.java
Patch:
@@ -105,15 +105,15 @@ public void onItemClick(int id) {
                 return;
             }
             Bundle args = new Bundle();
-            args.putInt("user_id", MessagesController.getInstance(currentAccount).blockedUsers.get(position));
+            args.putInt("user_id", MessagesController.getInstance(currentAccount).blockedUsers.keyAt(position));
             presentFragment(new ProfileActivity(args));
         });
 
         listView.setOnItemLongClickListener((view, position) -> {
             if (position >= MessagesController.getInstance(currentAccount).blockedUsers.size() || getParentActivity() == null) {
                 return true;
             }
-            selectedUserId = MessagesController.getInstance(currentAccount).blockedUsers.get(position);
+            selectedUserId = MessagesController.getInstance(currentAccount).blockedUsers.keyAt(position);
 
             AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
             CharSequence[] items = new CharSequence[]{LocaleController.getString("Unblock", R.string.Unblock)};
@@ -219,7 +219,7 @@ public RecyclerView.ViewHolder onCreateViewHolder(ViewGroup parent, int viewType
         @Override
         public void onBindViewHolder(RecyclerView.ViewHolder holder, int position) {
             if (holder.getItemViewType() == 0) {
-                TLRPC.User user = MessagesController.getInstance(currentAccount).getUser(MessagesController.getInstance(currentAccount).blockedUsers.get(position));
+                TLRPC.User user = MessagesController.getInstance(currentAccount).getUser(MessagesController.getInstance(currentAccount).blockedUsers.keyAt(position));
                 if (user != null) {
                     String number;
                     if (user.bot) {

File: TMessagesProj/src/main/java/org/telegram/ui/Components/InstantCameraView.java
Patch:
@@ -1941,12 +1941,12 @@ private void prepareEncoder() {
                 format.setInteger(MediaFormat.KEY_BIT_RATE, videoBitrate);
                 format.setInteger(MediaFormat.KEY_FRAME_RATE, FRAME_RATE);
                 format.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, IFRAME_INTERVAL);
-                if (Build.VERSION.SDK_INT >= 21) {
+                /*if (Build.VERSION.SDK_INT >= 21) {
                     format.setInteger(MediaFormat.KEY_PROFILE, MediaCodecInfo.CodecProfileLevel.AVCProfileHigh);
                     if (Build.VERSION.SDK_INT >= 23) {
                         format.setInteger(MediaFormat.KEY_LEVEL, MediaCodecInfo.CodecProfileLevel.AVCLevel5);
                     }
-                }
+                }*/
 
                 videoEncoder.configure(format, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE);
                 surface = videoEncoder.createInputSurface();

File: TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
Patch:
@@ -11,7 +11,7 @@
 public class BuildVars {
     public static boolean DEBUG_VERSION = false;
     public static boolean DEBUG_PRIVATE_VERSION = false;
-    public static int BUILD_VERSION = 1154;
+    public static int BUILD_VERSION = 1155;
     public static String BUILD_VERSION_STRING = "4.6";
     public static int APP_ID = 0; //obtain your own APP_ID at https://core.telegram.org/api/obtaining_api_id
     public static String APP_HASH = ""; //obtain your own APP_HASH at https://core.telegram.org/api/obtaining_api_id

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesStorage.java
Patch:
@@ -4863,7 +4863,7 @@ private void putMessagesInternal(final ArrayList<TLRPC.Message> messages, final
                     mentionsIdsMap.put(messageId, message.dialog_id);
                 }
 
-                if (!MessageObject.isOut(message) && (message.id > 0 || MessageObject.isUnread(message))) {
+                if (!(message.action instanceof TLRPC.TL_messageActionHistoryClear) && !MessageObject.isOut(message) && (message.id > 0 || MessageObject.isUnread(message))) {
                     Integer currentMaxId = dialogsReadMax.get(message.dialog_id);
                     if (currentMaxId == null) {
                         SQLiteCursor cursor = database.queryFinalized("SELECT inbox_max FROM dialogs WHERE did = " + message.dialog_id);

File: TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
Patch:
@@ -11,7 +11,7 @@
 public class BuildVars {
     public static boolean DEBUG_VERSION = false;
     public static boolean DEBUG_PRIVATE_VERSION = false;
-    public static int BUILD_VERSION = 1041;
+    public static int BUILD_VERSION = 1042;
     public static String BUILD_VERSION_STRING = "4.2";
     public static int APP_ID = 0; //obtain your own APP_ID at https://core.telegram.org/api/obtaining_api_id
     public static String APP_HASH = ""; //obtain your own APP_HASH at https://core.telegram.org/api/obtaining_api_id

File: TMessagesProj/src/main/java/org/telegram/messenger/NotificationCenter.java
Patch:
@@ -174,7 +174,8 @@ public void setAllowedNotificationsDutingAnimation(int notifications[]) {
     public void setAnimationInProgress(boolean value) {
         animationInProgress = value;
         if (!animationInProgress && !delayedPosts.isEmpty()) {
-            for (DelayedPost delayedPost : delayedPosts) {
+            for (int a = 0; a < delayedPosts.size(); a++) {
+                DelayedPost delayedPost = delayedPosts.get(a);
                 postNotificationNameInternal(delayedPost.id, true, delayedPost.args);
             }
             delayedPosts.clear();

File: TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
Patch:
@@ -11,7 +11,7 @@
 public class BuildVars {
     public static boolean DEBUG_VERSION = false;
     public static boolean DEBUG_PRIVATE_VERSION = false;
-    public static int BUILD_VERSION = 1040;
+    public static int BUILD_VERSION = 1041;
     public static String BUILD_VERSION_STRING = "4.2";
     public static int APP_ID = 0; //obtain your own APP_ID at https://core.telegram.org/api/obtaining_api_id
     public static String APP_HASH = ""; //obtain your own APP_HASH at https://core.telegram.org/api/obtaining_api_id

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesStorage.java
Patch:
@@ -1784,7 +1784,7 @@ public void run() {
         });
     }
 
-    public void createTaskForSecretChat(final long did, final int time, final int readTime, final int isOut, final ArrayList<Long> random_ids) {
+    public void createTaskForSecretChat(final int chatId, final int time, final int readTime, final int isOut, final ArrayList<Long> random_ids) {
         storageQueue.postRunnable(new Runnable() {
             @Override
             public void run() {
@@ -1795,7 +1795,7 @@ public void run() {
                     StringBuilder mids = new StringBuilder();
                     SQLiteCursor cursor;
                     if (random_ids == null) {
-                        cursor = database.queryFinalized(String.format(Locale.US, "SELECT mid, ttl FROM messages WHERE uid = %d AND out = %d AND read_state != 0 AND ttl > 0 AND date <= %d AND send_state = 0 AND media != 1", did, isOut, time));
+                        cursor = database.queryFinalized(String.format(Locale.US, "SELECT mid, ttl FROM messages WHERE uid = %d AND out = %d AND read_state != 0 AND ttl > 0 AND date <= %d AND send_state = 0 AND media != 1", ((long) chatId) << 32, isOut, time));
                     } else {
                         String ids = TextUtils.join(",", random_ids);
                         cursor = database.queryFinalized(String.format(Locale.US, "SELECT m.mid, m.ttl FROM messages as m INNER JOIN randoms as r ON m.mid = r.mid WHERE r.random_id IN (%s)", ids));

File: TMessagesProj/src/main/java/org/telegram/ui/Components/PhotoFilterView.java
Patch:
@@ -1917,7 +1917,7 @@ public void onClick(View v) {
 
     private void updateSelectedBlurType() {
         if (blurType == 0) {
-            Drawable drawable = blurOffButton.getContext().getDrawable(R.drawable.blur_off).mutate();
+            Drawable drawable = blurOffButton.getContext().getResources().getDrawable(R.drawable.blur_off).mutate();
             drawable.setColorFilter(new PorterDuffColorFilter(0xff51bdf3, PorterDuff.Mode.MULTIPLY));
             blurOffButton.setCompoundDrawablesWithIntrinsicBounds(null, drawable, null, null);
             blurOffButton.setTextColor(0xff51bdf3);
@@ -1931,7 +1931,7 @@ private void updateSelectedBlurType() {
             blurOffButton.setCompoundDrawablesWithIntrinsicBounds(0, R.drawable.blur_off, 0, 0);
             blurOffButton.setTextColor(0xffffffff);
 
-            Drawable drawable = blurOffButton.getContext().getDrawable(R.drawable.blur_radial).mutate();
+            Drawable drawable = blurOffButton.getContext().getResources().getDrawable(R.drawable.blur_radial).mutate();
             drawable.setColorFilter(new PorterDuffColorFilter(0xff51bdf3, PorterDuff.Mode.MULTIPLY));
             blurRadialButton.setCompoundDrawablesWithIntrinsicBounds(null, drawable, null, null);
             blurRadialButton.setTextColor(0xff51bdf3);
@@ -1945,7 +1945,7 @@ private void updateSelectedBlurType() {
             blurRadialButton.setCompoundDrawablesWithIntrinsicBounds(0, R.drawable.blur_radial, 0, 0);
             blurRadialButton.setTextColor(0xffffffff);
 
-            Drawable drawable = blurOffButton.getContext().getDrawable(R.drawable.blur_linear).mutate();
+            Drawable drawable = blurOffButton.getContext().getResources().getDrawable(R.drawable.blur_linear).mutate();
             drawable.setColorFilter(new PorterDuffColorFilter(0xff51bdf3, PorterDuff.Mode.MULTIPLY));
             blurLinearButton.setCompoundDrawablesWithIntrinsicBounds(null, drawable, null, null);
             blurLinearButton.setTextColor(0xff51bdf3);

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesController.java
Patch:
@@ -5787,7 +5787,7 @@ public void run() {
                         }
                     }
 
-                    long dialog_id = -update.channel_id;
+                    long dialog_id = -message.to_id.channel_id;
                     Integer value = dialogs_read_inbox_max.get(dialog_id);
                     if (value == null) {
                         value = MessagesStorage.getInstance().getDialogReadInboxMax(dialog_id);

File: TMessagesProj/src/main/java/org/telegram/messenger/ImageLoader.java
Patch:
@@ -1191,8 +1191,8 @@ public void run() {
                                 AndroidUtilities.addMediaToGallery(finalFile.toString());
                             }
                         }
-                        ImageLoader.this.fileDidLoaded(location, finalFile, type);
                         NotificationCenter.getInstance().postNotificationName(NotificationCenter.FileDidLoaded, location);
+                        ImageLoader.this.fileDidLoaded(location, finalFile, type);
                     }
                 });
             }

File: TMessagesProj/src/main/java/org/telegram/messenger/MessageObject.java
Patch:
@@ -1673,6 +1673,8 @@ public String getForwardedName() {
 
     public void checkMediaExistance() {
         File cacheFile = null;
+        attachPathExists = false;
+        mediaExists = false;
         if (type == 1) {
             TLRPC.PhotoSize currentPhotoObject = FileLoader.getClosestPhotoSizeWithSize(photoThumbs, AndroidUtilities.getPhotoSize());
             if (currentPhotoObject != null) {

File: TMessagesProj/src/main/java/org/telegram/ui/AudioSelectActivity.java
Patch:
@@ -203,7 +203,7 @@ public void run() {
                 final ArrayList<MediaController.AudioEntry> newAudioEntries = new ArrayList<>();
                 Cursor cursor = null;
                 try {
-                    cursor = ApplicationLoader.applicationContext.getContentResolver().query(MediaStore.Audio.Media.EXTERNAL_CONTENT_URI, projection, MediaStore.Audio.Media.IS_MUSIC + " != 0", null, null);
+                    cursor = ApplicationLoader.applicationContext.getContentResolver().query(MediaStore.Audio.Media.EXTERNAL_CONTENT_URI, projection, MediaStore.Audio.Media.IS_MUSIC + " != 0", null, MediaStore.Audio.Media.TITLE);
                     int id = -2000000000;
                     while (cursor.moveToNext()) {
                         MediaController.AudioEntry audioEntry = new MediaController.AudioEntry();

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -779,7 +779,7 @@ private boolean handleIntent(Intent intent, boolean isNew, boolean restore, bool
                                                 group = path.replace("joinchat/", "");
                                             } else if (path.startsWith("addstickers/")) {
                                                 sticker = path.replace("addstickers/", "");
-                                            } else if (path.startsWith("msg/")) {
+                                            } else if (path.startsWith("msg/") || path.startsWith("share/")) {
                                                 message = data.getQueryParameter("url");
                                                 if (message == null) {
                                                     message = "";
@@ -823,8 +823,8 @@ private boolean handleIntent(Intent intent, boolean isNew, boolean restore, bool
                                         url = url.replace("tg:addstickers", "tg://telegram.org").replace("tg://addstickers", "tg://telegram.org");
                                         data = Uri.parse(url);
                                         sticker = data.getQueryParameter("set");
-                                    } else if (url.startsWith("tg:msg") || url.startsWith("tg://msg")) {
-                                        url = url.replace("tg:msg", "tg://telegram.org").replace("tg://msg", "tg://telegram.org");
+                                    } else if (url.startsWith("tg:msg") || url.startsWith("tg://msg") || url.startsWith("tg://share") || url.startsWith("tg:share")) {
+                                        url = url.replace("tg:msg", "tg://telegram.org").replace("tg://msg", "tg://telegram.org").replace("tg://share", "tg://telegram.org").replace("tg:share", "tg://telegram.org");
                                         data = Uri.parse(url);
                                         message = data.getQueryParameter("url");
                                         if (message == null) {

File: TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java
Patch:
@@ -890,7 +890,7 @@ public void onNextPressed() {
             if (countryState == 1) {
                 needShowAlert(LocaleController.getString("AppName", R.string.AppName), LocaleController.getString("ChooseCountry", R.string.ChooseCountry));
                 return;
-            } else if (countryState == 2 && !BuildVars.DEBUG_VERSION) {
+            } else if (countryState == 2 && !BuildVars.DEBUG_VERSION && !codeField.getText().toString().equals("999")) {
                 needShowAlert(LocaleController.getString("AppName", R.string.AppName), LocaleController.getString("WrongCountry", R.string.WrongCountry));
                 return;
             }

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenu.java
Patch:
@@ -112,8 +112,8 @@ public void onItemClick(int id) {
     }
 
     public void clearItems() {
-        for (int a = 0; a < getChildCount(); a++) {
-            View view = getChildAt(a);
+        while(getChildCount() > 0) {
+            View view = getChildAt(0);
             removeView(view);
         }
     }

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenu.java
Patch:
@@ -112,8 +112,8 @@ public void onItemClick(int id) {
     }
 
     public void clearItems() {
-        for (int a = 0; a < getChildCount(); a++) {
-            View view = getChildAt(a);
+        while(getChildCount() > 0) {
+            View view = getChildAt(0);
             removeView(view);
         }
     }

File: TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
Patch:
@@ -10,7 +10,7 @@
 
 public class BuildVars {
     public static boolean DEBUG_VERSION = false;
-    public static int BUILD_VERSION = 541;
+    public static int BUILD_VERSION = 542;
     public static int APP_ID = 0; //obtain your own APP_ID at https://core.telegram.org/api/obtaining_api_id
     public static String APP_HASH = ""; //obtain your own APP_HASH at https://core.telegram.org/api/obtaining_api_id
     public static String HOCKEY_APP_HASH = "your-hockeyapp-api-key-here";

File: TMessagesProj/src/main/java/org/telegram/android/Animation/Animator10.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 import android.view.animation.Interpolator;
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/AnimatorListenerAdapter10.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 public abstract class AnimatorListenerAdapter10 implements Animator10.AnimatorListener, Animator10.AnimatorPauseListener {
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/AnimatorSet10.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 import android.view.animation.Interpolator;
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/FloatEvaluator.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 public class FloatEvaluator implements TypeEvaluator<Number> {
     public Float evaluate(float fraction, Number startValue, Number endValue) {

File: TMessagesProj/src/main/java/org/telegram/android/Animation/FloatKeyframeSet.java
Patch:
@@ -14,11 +14,11 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 import android.view.animation.Interpolator;
 
-import org.telegram.ui.Animation.Keyframe.FloatKeyframe;
+import org.telegram.android.Animation.Keyframe.FloatKeyframe;
 
 import java.util.ArrayList;
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/FloatProperty10.java
Patch:
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 public abstract class FloatProperty10<T> extends Property<T, Float> {
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/IntEvaluator.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 public class IntEvaluator implements TypeEvaluator<Integer> {
     public Integer evaluate(float fraction, Integer startValue, Integer endValue) {

File: TMessagesProj/src/main/java/org/telegram/android/Animation/IntKeyframeSet.java
Patch:
@@ -14,11 +14,11 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 import android.view.animation.Interpolator;
 
-import org.telegram.ui.Animation.Keyframe.IntKeyframe;
+import org.telegram.android.Animation.Keyframe.IntKeyframe;
 
 import java.util.ArrayList;
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/IntProperty.java
Patch:
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 public abstract class IntProperty<T> extends Property<T, Integer> {
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/Keyframe.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 import android.view.animation.Interpolator;
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/NoSuchPropertyException.java
Patch:
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 public class NoSuchPropertyException extends RuntimeException {
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/ObjectAnimator10.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 import android.view.View;
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/Property.java
Patch:
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 public abstract class Property<T, V> {
 

File: TMessagesProj/src/main/java/org/telegram/android/Animation/PropertyValuesHolder.java
Patch:
@@ -14,9 +14,8 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
-import java.lang.reflect.InvocationTargetException;
 import java.lang.reflect.Method;
 import java.util.HashMap;
 import java.util.concurrent.locks.ReentrantReadWriteLock;

File: TMessagesProj/src/main/java/org/telegram/android/Animation/ReflectiveProperty.java
Patch:
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 import java.lang.reflect.Field;
 import java.lang.reflect.InvocationTargetException;

File: TMessagesProj/src/main/java/org/telegram/android/Animation/TypeEvaluator.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 public interface TypeEvaluator<T> {
     T evaluate(float fraction, T startValue, T endValue);

File: TMessagesProj/src/main/java/org/telegram/android/Animation/ValueAnimator.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 import android.os.Looper;
 import android.util.AndroidRuntimeException;

File: TMessagesProj/src/main/java/org/telegram/android/Animation/View10.java
Patch:
@@ -14,7 +14,7 @@
 limitations under the License.
  */
 
-package org.telegram.ui.Animation;
+package org.telegram.android.Animation;
 
 import android.graphics.Camera;
 import android.graphics.Matrix;

File: TMessagesProj/src/main/java/org/telegram/android/AnimationCompat/ViewProxy.java
Patch:
@@ -6,11 +6,11 @@
  * Copyright Nikolai Kudashov, 2013-2014.
  */
 
-package org.telegram.ui.AnimationCompat;
+package org.telegram.android.AnimationCompat;
 
 import android.view.View;
 
-import org.telegram.ui.Animation.View10;
+import org.telegram.android.Animation.View10;
 
 public class ViewProxy {
 

File: TMessagesProj/src/main/java/org/telegram/android/NativeLoader.java
Patch:
@@ -23,7 +23,7 @@
 
 public class NativeLoader {
 
-    private final static int LIB_VERSION = 7;
+    private final static int LIB_VERSION = 8;
     private final static String LIB_NAME = "tmessages." + LIB_VERSION;
     private final static String LIB_SO_NAME = "lib" + LIB_NAME + ".so";
     private final static String LOCALE_LIB_SO_NAME = "lib" + LIB_NAME + "loc.so";

File: TMessagesProj/src/main/java/org/telegram/android/query/ReplyMessageQuery.java
Patch:
@@ -21,7 +21,6 @@
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.RPCRequest;
-import org.telegram.messenger.TLClassStore;
 import org.telegram.messenger.TLObject;
 import org.telegram.messenger.TLRPC;
 
@@ -65,7 +64,7 @@ public void run() {
                     while (cursor.next()) {
                         ByteBufferDesc data = MessagesStorage.getInstance().getBuffersStorage().getFreeBuffer(cursor.byteArrayLength(0));
                         if (data != null && cursor.byteBufferValue(0, data.buffer) != 0) {
-                            TLRPC.Message message = (TLRPC.Message) TLClassStore.Instance().TLdeserialize(data, data.readInt32());
+                            TLRPC.Message message = TLRPC.Message.TLdeserialize(data, data.readInt32(false), false);
                             message.id = cursor.intValue(1);
                             message.date = cursor.intValue(2);
                             message.dialog_id = dialog_id;

File: TMessagesProj/src/main/java/org/telegram/android/query/SharedMediaQuery.java
Patch:
@@ -20,7 +20,6 @@
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.RPCRequest;
-import org.telegram.messenger.TLClassStore;
 import org.telegram.messenger.TLObject;
 import org.telegram.messenger.TLRPC;
 
@@ -178,7 +177,7 @@ private static void processLoadedMedia(final TLRPC.messages_Messages res, final
             }
             final ArrayList<MessageObject> objects = new ArrayList<>();
             for (TLRPC.Message message : res.messages) {
-                objects.add(new MessageObject(message, usersLocal, false));
+                objects.add(new MessageObject(message, usersLocal, true));
             }
 
             AndroidUtilities.runOnUIThread(new Runnable() {
@@ -324,7 +323,7 @@ public void run() {
                     while (cursor.next()) {
                         ByteBufferDesc data = MessagesStorage.getInstance().getBuffersStorage().getFreeBuffer(cursor.byteArrayLength(0));
                         if (data != null && cursor.byteBufferValue(0, data.buffer) != 0) {
-                            TLRPC.Message message = (TLRPC.Message) TLClassStore.Instance().TLdeserialize(data, data.readInt32());
+                            TLRPC.Message message = TLRPC.Message.TLdeserialize(data, data.readInt32(false), false);
                             message.id = cursor.intValue(1);
                             message.dialog_id = uid;
                             if ((int)uid == 0) {

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenu.java
Patch:
@@ -13,10 +13,10 @@
 import android.util.AttributeSet;
 import android.view.LayoutInflater;
 import android.view.View;
-import android.widget.FrameLayout;
 import android.widget.LinearLayout;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class ActionBarMenu extends LinearLayout {
 
@@ -46,7 +46,7 @@ public View addItemResource(int id, int resourceId) {
         view.setTag(id);
         addView(view);
         LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)view.getLayoutParams();
-        layoutParams.height = FrameLayout.LayoutParams.FILL_PARENT;
+        layoutParams.height = LayoutHelper.MATCH_PARENT;
         view.setBackgroundResource(parentActionBar.itemsBackgroundResourceId);
         view.setLayoutParams(layoutParams);
         view.setOnClickListener(new OnClickListener() {
@@ -84,7 +84,7 @@ public ActionBarMenuItem addItem(int id, int icon, int backgroundResource, Drawa
         }
         addView(menuItem);
         LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)menuItem.getLayoutParams();
-        layoutParams.height = FrameLayout.LayoutParams.MATCH_PARENT;
+        layoutParams.height = LayoutHelper.MATCH_PARENT;
         layoutParams.width = width;
         menuItem.setLayoutParams(layoutParams);
         menuItem.setOnClickListener(new OnClickListener() {

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java
Patch:
@@ -204,7 +204,7 @@ public boolean needAddActionBar() {
     }
 
     public AlertDialog showAlertDialog(AlertDialog.Builder builder) {
-        if (parentLayout == null || parentLayout.checkTransitionAnimation() || parentLayout.animationInProgress || parentLayout.startedTracking) {
+        if (parentLayout == null || parentLayout.animationInProgress || parentLayout.startedTracking || parentLayout.checkTransitionAnimation()) {
             return null;
         }
         try {

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/DrawerActionCell.java
Patch:
@@ -15,6 +15,7 @@
 import android.widget.TextView;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class DrawerActionCell extends FrameLayout {
 
@@ -34,8 +35,8 @@ public DrawerActionCell(Context context) {
         textView.setCompoundDrawablePadding(AndroidUtilities.dp(34));
         addView(textView);
         LayoutParams layoutParams = (LayoutParams) textView.getLayoutParams();
-        layoutParams.width = LayoutParams.MATCH_PARENT;
-        layoutParams.height = LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
+        layoutParams.height = LayoutHelper.MATCH_PARENT;
         layoutParams.gravity = Gravity.LEFT;
         layoutParams.leftMargin = AndroidUtilities.dp(14);
         layoutParams.rightMargin = AndroidUtilities.dp(16);

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/EmptyCell.java
Patch:
@@ -11,8 +11,6 @@
 import android.content.Context;
 import android.widget.FrameLayout;
 
-import org.telegram.android.AndroidUtilities;
-
 public class EmptyCell extends FrameLayout {
 
     int cellHeight;
@@ -33,6 +31,6 @@ public void setHeight(int height) {
 
     @Override
     protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
-        super.onMeasure(widthMeasureSpec, MeasureSpec.makeMeasureSpec(AndroidUtilities.dp(cellHeight), MeasureSpec.EXACTLY));
+        super.onMeasure(widthMeasureSpec, MeasureSpec.makeMeasureSpec(cellHeight, MeasureSpec.EXACTLY));
     }
 }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/GreySectionCell.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class GreySectionCell extends FrameLayout {
     private TextView textView;
@@ -32,8 +33,8 @@ public GreySectionCell(Context context) {
         textView.setGravity((LocaleController.isRTL ? Gravity.RIGHT : Gravity.LEFT) | Gravity.CENTER_VERTICAL);
         addView(textView);
         FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams)textView.getLayoutParams();
-        layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
-        layoutParams.height = FrameLayout.LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
+        layoutParams.height = LayoutHelper.MATCH_PARENT;
         layoutParams.leftMargin = AndroidUtilities.dp(16);
         layoutParams.rightMargin = AndroidUtilities.dp(16);
         layoutParams.gravity = LocaleController.isRTL ? Gravity.RIGHT : Gravity.LEFT;

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/HeaderCell.java
Patch:
@@ -17,6 +17,7 @@
 
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class HeaderCell extends FrameLayout {
 
@@ -30,8 +31,8 @@ private void init() {
         textView.setGravity((LocaleController.isRTL ? Gravity.RIGHT : Gravity.LEFT) | Gravity.CENTER_VERTICAL);
         addView(textView);
         FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams)textView.getLayoutParams();
-        layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
-        layoutParams.height = FrameLayout.LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
+        layoutParams.height = LayoutHelper.MATCH_PARENT;
         layoutParams.leftMargin = AndroidUtilities.dp(17);
         layoutParams.rightMargin = AndroidUtilities.dp(17);
         layoutParams.topMargin = AndroidUtilities.dp(15);

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/LetterSectionCell.java
Patch:
@@ -16,6 +16,7 @@
 import android.widget.TextView;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class LetterSectionCell extends FrameLayout {
 
@@ -32,8 +33,8 @@ public LetterSectionCell(Context context) {
         textView.setGravity(Gravity.CENTER);
         addView(textView);
         FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams)textView.getLayoutParams();
-        layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
-        layoutParams.height = FrameLayout.LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
+        layoutParams.height = LayoutHelper.MATCH_PARENT;
         textView.setLayoutParams(layoutParams);
     }
 

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/LoadingCell.java
Patch:
@@ -14,6 +14,7 @@
 import android.widget.ProgressBar;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class LoadingCell extends FrameLayout {
 
@@ -23,8 +24,8 @@ public LoadingCell(Context context) {
         ProgressBar progressBar = new ProgressBar(context);
         addView(progressBar);
         LayoutParams layoutParams = (FrameLayout.LayoutParams) progressBar.getLayoutParams();
-        layoutParams.width = LayoutParams.WRAP_CONTENT;
-        layoutParams.height = LayoutParams.WRAP_CONTENT;
+        layoutParams.width = LayoutHelper.WRAP_CONTENT;
+        layoutParams.height = LayoutHelper.WRAP_CONTENT;
         layoutParams.gravity = Gravity.CENTER;
         progressBar.setLayoutParams(layoutParams);
     }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/PhotoPickerPhotoCell.java
Patch:
@@ -16,6 +16,7 @@
 import org.telegram.messenger.R;
 import org.telegram.ui.Components.BackupImageView;
 import org.telegram.ui.Components.CheckBox;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class PhotoPickerPhotoCell extends FrameLayout {
 
@@ -30,8 +31,8 @@ public PhotoPickerPhotoCell(Context context) {
         photoImage = new BackupImageView(context);
         addView(photoImage);
         LayoutParams layoutParams = (LayoutParams) photoImage.getLayoutParams();
-        layoutParams.width = LayoutParams.MATCH_PARENT;
-        layoutParams.height = LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
+        layoutParams.height = LayoutHelper.MATCH_PARENT;
         photoImage.setLayoutParams(layoutParams);
 
         checkFrame = new FrameLayout(context);

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/SharedMediaSectionCell.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class SharedMediaSectionCell extends FrameLayout {
 
@@ -31,8 +32,8 @@ public SharedMediaSectionCell(Context context) {
         textView.setGravity((LocaleController.isRTL ? Gravity.RIGHT : Gravity.LEFT) | Gravity.CENTER_VERTICAL);
         addView(textView);
         FrameLayout.LayoutParams layoutParams = (FrameLayout.LayoutParams)textView.getLayoutParams();
-        layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
-        layoutParams.height = FrameLayout.LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
+        layoutParams.height = LayoutHelper.MATCH_PARENT;
         layoutParams.leftMargin = AndroidUtilities.dp(13);
         layoutParams.rightMargin = AndroidUtilities.dp(13);
         layoutParams.gravity = LocaleController.isRTL ? Gravity.RIGHT : Gravity.LEFT;

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/TextColorCell.java
Patch:
@@ -22,6 +22,7 @@
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
 import org.telegram.messenger.R;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class TextColorCell extends FrameLayout {
     private TextView textView;
@@ -48,8 +49,8 @@ public TextColorCell(Context context) {
         textView.setGravity((LocaleController.isRTL ? Gravity.RIGHT : Gravity.LEFT) | Gravity.CENTER_VERTICAL);
         addView(textView);
         LayoutParams layoutParams = (LayoutParams) textView.getLayoutParams();
-        layoutParams.width = LayoutParams.MATCH_PARENT;
-        layoutParams.height = LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
+        layoutParams.height = LayoutHelper.MATCH_PARENT;
         layoutParams.leftMargin = AndroidUtilities.dp(17);
         layoutParams.rightMargin = AndroidUtilities.dp(17);
         layoutParams.gravity = LocaleController.isRTL ? Gravity.RIGHT : Gravity.LEFT;

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/TextInfoCell.java
Patch:
@@ -15,6 +15,7 @@
 import android.widget.TextView;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class TextInfoCell extends FrameLayout {
 
@@ -30,8 +31,8 @@ public TextInfoCell(Context context) {
         textView.setPadding(0, AndroidUtilities.dp(19), 0, AndroidUtilities.dp(19));
         addView(textView);
         LayoutParams layoutParams = (LayoutParams) textView.getLayoutParams();
-        layoutParams.width = LayoutParams.WRAP_CONTENT;
-        layoutParams.height = LayoutParams.WRAP_CONTENT;
+        layoutParams.width = LayoutHelper.WRAP_CONTENT;
+        layoutParams.height = LayoutHelper.WRAP_CONTENT;
         layoutParams.leftMargin = AndroidUtilities.dp(17);
         layoutParams.rightMargin = AndroidUtilities.dp(17);
         layoutParams.gravity = Gravity.CENTER;

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/TextInfoPrivacyCell.java
Patch:
@@ -16,6 +16,7 @@
 
 import org.telegram.android.AndroidUtilities;
 import org.telegram.android.LocaleController;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class TextInfoPrivacyCell extends FrameLayout {
 
@@ -31,8 +32,8 @@ public TextInfoPrivacyCell(Context context) {
         textView.setPadding(0, AndroidUtilities.dp(10), 0, AndroidUtilities.dp(17));
         addView(textView);
         LayoutParams layoutParams = (LayoutParams) textView.getLayoutParams();
-        layoutParams.width = LayoutParams.WRAP_CONTENT;
-        layoutParams.height = LayoutParams.WRAP_CONTENT;
+        layoutParams.width = LayoutHelper.WRAP_CONTENT;
+        layoutParams.height = LayoutHelper.WRAP_CONTENT;
         layoutParams.leftMargin = AndroidUtilities.dp(17);
         layoutParams.rightMargin = AndroidUtilities.dp(17);
         layoutParams.gravity = LocaleController.isRTL ? Gravity.RIGHT : Gravity.LEFT;

File: TMessagesProj/src/main/java/org/telegram/ui/ChangeChatNameActivity.java
Patch:
@@ -34,6 +34,7 @@
 import org.telegram.ui.ActionBar.ActionBar;
 import org.telegram.ui.ActionBar.ActionBarMenu;
 import org.telegram.ui.ActionBar.BaseFragment;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class ChangeChatNameActivity extends BaseFragment {
 
@@ -118,7 +119,7 @@ public boolean onEditorAction(TextView textView, int i, KeyEvent keyEvent) {
         layoutParams.height = AndroidUtilities.dp(36);
         layoutParams.leftMargin = AndroidUtilities.dp(24);
         layoutParams.rightMargin = AndroidUtilities.dp(24);
-        layoutParams.width = LinearLayout.LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
         firstNameField.setLayoutParams(layoutParams);
 
         if (chat_id > 0) {

File: TMessagesProj/src/main/java/org/telegram/ui/ChangeNameActivity.java
Patch:
@@ -38,6 +38,7 @@
 import org.telegram.ui.ActionBar.ActionBar;
 import org.telegram.ui.ActionBar.ActionBarMenu;
 import org.telegram.ui.ActionBar.BaseFragment;
+import org.telegram.ui.Components.LayoutHelper;
 
 public class ChangeNameActivity extends BaseFragment {
 
@@ -103,7 +104,7 @@ public boolean onTouch(View v, MotionEvent event) {
         layoutParams.height = AndroidUtilities.dp(36);
         layoutParams.leftMargin = AndroidUtilities.dp(24);
         layoutParams.rightMargin = AndroidUtilities.dp(24);
-        layoutParams.width = LinearLayout.LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
         firstNameField.setLayoutParams(layoutParams);
         firstNameField.setOnEditorActionListener(new TextView.OnEditorActionListener() {
             @Override
@@ -135,7 +136,7 @@ public boolean onEditorAction(TextView textView, int i, KeyEvent keyEvent) {
         layoutParams.height = AndroidUtilities.dp(36);
         layoutParams.leftMargin = AndroidUtilities.dp(24);
         layoutParams.rightMargin = AndroidUtilities.dp(24);
-        layoutParams.width = LinearLayout.LayoutParams.MATCH_PARENT;
+        layoutParams.width = LayoutHelper.MATCH_PARENT;
         lastNameField.setLayoutParams(layoutParams);
         lastNameField.setOnEditorActionListener(new TextView.OnEditorActionListener() {
             @Override

File: TMessagesProj/src/main/java/org/telegram/android/ContactsController.java
Patch:
@@ -1772,7 +1772,7 @@ public void setPrivacyRules(ArrayList<TLRPC.PrivacyRule> rules) {
     }
 
     public static String formatName(String firstName, String lastName) {
-        String result = null;
+        String result = "";
         if (LocaleController.nameDisplayOrder == 1) {
             result = firstName;
             if (result == null || result.length() == 0) {

File: TMessagesProj/src/main/java/org/telegram/ui/Components/ChatActivityEnterView.java
Patch:
@@ -376,6 +376,7 @@ public void afterTextChanged(Editable editable) {
         audioSendButton.setScaleType(ImageView.ScaleType.CENTER_INSIDE);
         audioSendButton.setImageResource(R.drawable.mic_button_states);
         audioSendButton.setBackgroundColor(0xffffffff);
+        audioSendButton.setSoundEffectsEnabled(false);
         audioSendButton.setPadding(0, 0, AndroidUtilities.dp(4), 0);
         frameLayout1.addView(audioSendButton);
         layoutParams1 = (FrameLayout.LayoutParams) audioSendButton.getLayoutParams();
@@ -461,6 +462,7 @@ public boolean onTouch(View view, MotionEvent motionEvent) {
         sendButton.setVisibility(View.INVISIBLE);
         sendButton.setScaleType(ImageView.ScaleType.CENTER_INSIDE);
         sendButton.setImageResource(R.drawable.ic_send);
+        sendButton.setSoundEffectsEnabled(false);
         ViewProxy.setScaleX(sendButton, 0.1f);
         ViewProxy.setScaleY(sendButton, 0.1f);
         ViewProxy.setAlpha(sendButton, 0.0f);

File: TMessagesProj/src/main/java/org/telegram/android/MessageObject.java
Patch:
@@ -504,7 +504,7 @@ private boolean containsUrls(CharSequence message) {
             } else if (!(c != ' ' && digitsInRow > 0)) {
                 digitsInRow = 0;
             }
-            if ((c == '@' || c == '#') && i == 0 || i != 0 && message.charAt(i - 1) == ' ') {
+            if ((c == '@' || c == '#') && i == 0 || i != 0 && (message.charAt(i - 1) == ' ' || message.charAt(i - 1) == '\n')) {
                 return true;
             }
             if (c == ':') {

File: TMessagesProj/src/main/java/org/telegram/android/SmsListener.java
Patch:
@@ -51,11 +51,11 @@ public void onReceive(Context context, Intent intent) {
                                 NotificationCenter.getInstance().postNotificationName(NotificationCenter.didReceiveSmsCode, matcher.group(0));
                             }
                         }
-                    } catch (Exception e) {
+                    } catch (Throwable e) {
                         FileLog.e("tmessages", e);
                     }
 
-                } catch(Exception e) {
+                } catch(Throwable e) {
                     FileLog.e("tmessages", e);
                 }
             }

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -2154,7 +2154,7 @@ void processMessage(TLObject message, long messageId, int messageSeqNo, long mes
                                 implicitError.code = ((TLRPC.RpcError)resultContainer.result).error_code;
                                 implicitError.text = ((TLRPC.RpcError)resultContainer.result).error_message;
                             } else if (!(resultContainer.result instanceof TLRPC.TL_error)) {
-                                if (request.rawRequest == null || !request.rawRequest.responseClass().isAssignableFrom(resultContainer.result.getClass())) {
+                                if (request.rawRequest == null || resultContainer.result == null || !request.rawRequest.responseClass().isAssignableFrom(resultContainer.result.getClass())) {
                                     if (request.rawRequest == null) {
                                         FileLog.e("tmessages", "rawRequest is null");
                                     } else {

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLoader.java
Patch:
@@ -132,6 +132,9 @@ public void uploadFile(final String location, final boolean encrypted, final boo
     }
 
     public void uploadFile(final String location, final boolean encrypted, final boolean small, final int estimatedSize) {
+        if (location == null) {
+            return;
+        }
         fileLoaderQueue.postRunnable(new Runnable() {
             @Override
             public void run() {

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLog.java
Patch:
@@ -181,7 +181,7 @@ public void run() {
     }
 
     public static void cleanupLogs() {
-        ArrayList<Uri> uris = new ArrayList<Uri>();
+        ArrayList<Uri> uris = new ArrayList<>();
         File sdCard = ApplicationLoader.applicationContext.getExternalFilesDir(null);
         File dir = new File (sdCard.getAbsolutePath() + "/logs");
         File[] files = dir.listFiles();

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/MentionsAdapter.java
Patch:
@@ -70,7 +70,7 @@ public void searchUsername(String text, int position, ArrayList<MessageObject> m
                 continue;
             }
             char ch = text.charAt(a);
-            if (ch == '@' && (a == 0 || text.charAt(a - 1) == ' ')) {
+            if (ch == '@' && (a == 0 || text.charAt(a - 1) == ' ' || text.charAt(a - 1) == '\n')) {
                 found = true;
                 usernameStartPosition = a;
                 usernameLength = username.length() + 1;

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/MentionsAdapter.java
Patch:
@@ -111,7 +111,7 @@ public int compare(TLRPC.User lhs, TLRPC.User rhs) {
                 int lhsNum = users.indexOf(lhs.id);
                 int rhsNum = users.indexOf(rhs.id);
                 if (lhsNum != -1 && rhsNum != -1) {
-                    return Integer.compare(lhsNum, rhsNum);
+                    return lhsNum < rhsNum ? -1 : (lhsNum == rhsNum ? 0 : 1);
                 } else if (lhsNum != -1 && rhsNum == -1) {
                     return -1;
                 } else if (lhsNum == -1 && rhsNum != -1) {

File: TMessagesProj/src/main/java/org/telegram/ui/Components/PhotoFilterView.java
Patch:
@@ -1446,7 +1446,7 @@ public void init() {
     }
 
     public Bitmap getBitmap() {
-        return eglThread.getTexture();
+        return eglThread != null ? eglThread.getTexture() : null;
     }
 
     private void fixLayout(int viewWidth, int viewHeight) {

File: TMessagesProj/src/main/java/org/telegram/ui/PasscodeActivity.java
Patch:
@@ -488,7 +488,7 @@ private void updateDropDownTextView() {
             filterArray[0] = new InputFilter.LengthFilter(4);
             passwordEditText.setFilters(filterArray);
             passwordEditText.setInputType(InputType.TYPE_CLASS_PHONE);
-            passwordEditText.setKeyListener(DigitsKeyListener.getInstance("123456789"));
+            passwordEditText.setKeyListener(DigitsKeyListener.getInstance("1234567890"));
         } else if (type == 1 && currentPasswordType == 1 || type == 2 && UserConfig.passcodeType == 1) {
             passwordEditText.setFilters(new InputFilter[0]);
             passwordEditText.setKeyListener(null);

File: TMessagesProj/src/main/java/org/telegram/ui/WallpapersActivity.java
Patch:
@@ -419,7 +419,9 @@ public void run() {
                             wallPapers.add((TLRPC.WallPaper)obj);
                             wallpappersByIds.put(((TLRPC.WallPaper)obj).id, (TLRPC.WallPaper)obj);
                         }
-                        listAdapter.notifyDataSetChanged();
+                        if (listAdapter != null) {
+                            listAdapter.notifyDataSetChanged();
+                        }
                         if (backgroundImage != null) {
                             processSelectedBackground();
                         }

File: TMessagesProj/src/main/java/org/telegram/android/SecretChatHelper.java
Patch:
@@ -656,7 +656,7 @@ public void run() {
                 TLObject toEncryptObject = null;
                 if (AndroidUtilities.getPeerLayerVersion(chat.layer) >= 17) {
                     TLRPC.TL_decryptedMessageLayer layer = new TLRPC.TL_decryptedMessageLayer();
-                    layer.layer = Math.min(AndroidUtilities.getMyLayerVersion(chat.layer), AndroidUtilities.getPeerLayerVersion(chat.layer));
+                    layer.layer = Math.min(17, AndroidUtilities.getPeerLayerVersion(chat.layer));
                     layer.message = req;
                     layer.random_bytes = new byte[Math.max(1, (int) Math.ceil(Utilities.random.nextDouble() * 16))];
                     Utilities.random.nextBytes(layer.random_bytes);

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/StickerCell.java
Patch:
@@ -70,5 +70,8 @@ public void setSticker(TLRPC.Document document, int side) {
             setBackgroundResource(R.drawable.stickers_back_all);
             setPadding(AndroidUtilities.dp(3), 0, AndroidUtilities.dp(3), 0);
         }
+        if (getBackground() != null) {
+            getBackground().setAlpha(230);
+        }
     }
 }

File: TMessagesProj/src/main/java/org/telegram/android/SendMessagesHelper.java
Patch:
@@ -1342,7 +1342,7 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
                     continue;
                 }
                 for (TLRPC.PhotoSize size2 : newMsg.media.photo.sizes) {
-                    if (size2.location.volume_id == Integer.MIN_VALUE && size.type.equals(size2.type) || size.w == size2.w && size.h == size2.h) {
+                    if (size2.location != null && size2.location.volume_id == Integer.MIN_VALUE && size.type.equals(size2.type) || size.w == size2.w && size.h == size2.h) {
                         String fileName = size2.location.volume_id + "_" + size2.location.local_id;
                         String fileName2 = size.location.volume_id + "_" + size.location.local_id;
                         if (fileName.equals(fileName2)) {
@@ -1371,7 +1371,7 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
 
             TLRPC.PhotoSize size2 = newMsg.media.video.thumb;
             TLRPC.PhotoSize size = sentMessage.media.video.thumb;
-            if (size2.location.volume_id == Integer.MIN_VALUE && size2.location != null && size.location != null && !(size instanceof TLRPC.TL_photoSizeEmpty) && !(size2 instanceof TLRPC.TL_photoSizeEmpty)) {
+            if (size2.location != null && size2.location.volume_id == Integer.MIN_VALUE && size.location != null && !(size instanceof TLRPC.TL_photoSizeEmpty) && !(size2 instanceof TLRPC.TL_photoSizeEmpty)) {
                 String fileName = size2.location.volume_id + "_" + size2.location.local_id;
                 String fileName2 = size.location.volume_id + "_" + size.location.local_id;
                 if (!fileName.equals(fileName2)) {
@@ -1402,7 +1402,7 @@ private void processSentMessage(TLRPC.Message newMsg, TLRPC.Message sentMessage,
 
             TLRPC.PhotoSize size2 = newMsg.media.document.thumb;
             TLRPC.PhotoSize size = sentMessage.media.document.thumb;
-            if (size2.location.volume_id == Integer.MIN_VALUE && size2.location != null && size.location != null && !(size instanceof TLRPC.TL_photoSizeEmpty) && !(size2 instanceof TLRPC.TL_photoSizeEmpty)) {
+            if (size2.location != null && size2.location.volume_id == Integer.MIN_VALUE && size.location != null && !(size instanceof TLRPC.TL_photoSizeEmpty) && !(size2 instanceof TLRPC.TL_photoSizeEmpty)) {
                 String fileName = size2.location.volume_id + "_" + size2.location.local_id;
                 String fileName2 = size.location.volume_id + "_" + size.location.local_id;
                 if (!fileName.equals(fileName2)) {

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -112,7 +112,7 @@ public static class TPFactorizedValue {
     private native static void aesIgeEncryption(ByteBuffer buffer, byte[] key, byte[] iv, boolean encrypt, int offset, int length);
 
     public static void aesIgeEncryption(ByteBuffer buffer, byte[] key, byte[] iv, boolean encrypt, boolean changeIv, int offset, int length) {
-        aesIgeEncryption(buffer, key, changeIv ? iv : (byte [])iv.clone(), encrypt, offset, length);
+        aesIgeEncryption(buffer, key, changeIv ? iv : iv.clone(), encrypt, offset, length);
     }
 
     public static Integer parseInt(String value) {

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/BaseFragment.java
Patch:
@@ -119,7 +119,6 @@ public void onResume() {
     public void onPause() {
         if (actionBar != null) {
             actionBar.onPause();
-            actionBar.closeSearchField();
         }
         try {
             if (visibleDialog != null && visibleDialog.isShowing()) {

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -572,9 +572,9 @@ public void didSelectLocation(double latitude, double longitude) {
                         DocumentSelectActivity fragment = new DocumentSelectActivity();
                         fragment.setDelegate(new DocumentSelectActivity.DocumentSelectActivityDelegate() {
                             @Override
-                            public void didSelectFile(DocumentSelectActivity activity, String path) {
+                            public void didSelectFiles(DocumentSelectActivity activity, ArrayList<String> files) {
                                 activity.finishFragment();
-                                SendMessagesHelper.prepareSendingDocument(path, path, null, null, dialog_id);
+                                SendMessagesHelper.prepareSendingDocuments(files, files, null, null, dialog_id);
                             }
 
                             @Override

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateActivity.java
Patch:
@@ -455,6 +455,9 @@ public void onScrollStateChanged(AbsListView absListView, int i) {
                     if (i == SCROLL_STATE_TOUCH_SCROLL) {
                         AndroidUtilities.hideKeyboard(userSelectEditText);
                     }
+                    if (listViewAdapter != null) {
+                        listViewAdapter.setIsScrolling(i != SCROLL_STATE_IDLE);
+                    }
                 }
 
                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/ProfileActivity.java
Patch:
@@ -485,10 +485,10 @@ public void onClick(DialogInterface dialogInterface, int i) {
                                 } else if (i == 1) {
                                     if(Build.VERSION.SDK_INT < android.os.Build.VERSION_CODES.HONEYCOMB) {
                                         android.text.ClipboardManager clipboard = (android.text.ClipboardManager)ApplicationLoader.applicationContext.getSystemService(Context.CLIPBOARD_SERVICE);
-                                        clipboard.setText(user.phone);
+                                        clipboard.setText("+" + user.phone);
                                     } else {
                                         android.content.ClipboardManager clipboard = (android.content.ClipboardManager)ApplicationLoader.applicationContext.getSystemService(Context.CLIPBOARD_SERVICE);
-                                        android.content.ClipData clip = android.content.ClipData.newPlainText("label", user.phone);
+                                        android.content.ClipData clip = android.content.ClipData.newPlainText("label", "+" + user.phone);
                                         clipboard.setPrimaryClip(clip);
                                     }
                                 }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
Patch:
@@ -148,6 +148,7 @@ public void setContainerView(Activity activity, View containerView) {
         ViewProxy.setScaleX(sendButton, 0.1f);
         ViewProxy.setScaleY(sendButton, 0.1f);
         ViewProxy.setAlpha(sendButton, 0.0f);
+        sendButton.clearAnimation();
         emojiButton = (ImageView) containerView.findViewById(R.id.chat_smile_button);
         audioSendButton = (ImageButton) containerView.findViewById(R.id.chat_audio_send_button);
         recordPanel = containerView.findViewById(R.id.record_panel);

File: TMessagesProj/src/main/java/org/telegram/ui/Views/Switch.java
Patch:
@@ -23,6 +23,7 @@
 import android.graphics.Rect;
 import android.graphics.Region;
 import android.graphics.drawable.Drawable;
+import android.os.Build;
 import android.view.Gravity;
 import android.view.MotionEvent;
 import android.view.VelocityTracker;
@@ -532,7 +533,7 @@ public void draw(Canvas c) {
             mThumbDrawable.setBounds(thumbLeft, switchTop + offset, thumbRight, switchBottom + offset);
 
             final Drawable background = getBackground();
-            if (background != null) {
+            if (background != null && Build.VERSION.SDK_INT >= 21) {
                 background.setHotspotBounds(thumbLeft, switchTop, thumbRight, switchBottom);
             }
         }

File: TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java
Patch:
@@ -346,7 +346,7 @@ public static AlertDialog.Builder buildTTLAlert(final Context context, final TLR
         } else if (encryptedChat.ttl == 60 * 60 * 24 * 7) {
             numberPicker.setValue(20);
         } else if (encryptedChat.ttl == 0) {
-            numberPicker.setValue(5);
+            numberPicker.setValue(0);
         }
         numberPicker.setFormatter(new NumberPicker.Formatter() {
             @Override

File: TMessagesProj/src/main/java/org/telegram/android/MessageObject.java
Patch:
@@ -345,7 +345,9 @@ public MessageObject(TLRPC.Message message, AbstractMap<Integer, TLRPC.User> use
         int dateMonth = rightNow.get(Calendar.MONTH);
         dateKey = String.format("%d_%02d_%02d", dateYear, dateMonth, dateDay);
 
-        generateLayout();
+        if (preview != 0) {
+            generateLayout();
+        }
         generateThumbs(false, preview);
     }
 

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/ContactsAdapter.java
Patch:
@@ -220,7 +220,7 @@ public View getItemView(int section, int position, View convertView, ViewGroup p
             TLRPC.User user = MessagesController.getInstance().getUser(arr.get(position).user_id);
             ((UserCell)convertView).setData(user, null, null, 0);
             if (checkedMap != null) {
-                ((UserCell) convertView).setChecked(checkedMap.containsKey(user.id));
+                ((UserCell) convertView).setChecked(checkedMap.containsKey(user.id), false);
             }
             if (ignoreUsers != null) {
                 if (ignoreUsers.containsKey(user.id)) {

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatActionCell.java
Patch:
@@ -228,7 +228,7 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
             setMeasuredDimension(MeasureSpec.getSize(widthMeasureSpec), textHeight + AndroidUtilities.dp(14));
             return;
         }
-        int width = MeasureSpec.getSize(widthMeasureSpec);
+        int width = Math.max(AndroidUtilities.dp(30), MeasureSpec.getSize(widthMeasureSpec));
         if (width != previousWidth) {
             previousWidth = width;
 

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/UserCell.java
Patch:
@@ -142,11 +142,11 @@ public void setData(TLRPC.User user, CharSequence name, CharSequence status, int
         update(0);
     }
 
-    public void setChecked(boolean checked) {
+    public void setChecked(boolean checked, boolean animated) {
         if (checkBox.getVisibility() != VISIBLE) {
             checkBox.setVisibility(VISIBLE);
         }
-        checkBox.setChecked(checked);
+        checkBox.setChecked(checked, animated);
     }
 
     @Override

File: TMessagesProj/src/main/java/org/telegram/ui/Views/Switch.java
Patch:
@@ -90,7 +90,6 @@ public static float constrain(float amount, float low, float high) {
 
     private ObjectAnimatorProxy mPositionAnimator;
 
-    @SuppressWarnings("hiding")
     private final Rect mTempRect = new Rect();
 
     public Switch(Context context) {

File: TMessagesProj/src/main/java/org/telegram/android/NotificationsController.java
Patch:
@@ -238,7 +238,7 @@ private void scheduleNotificationRepeat() {
             PendingIntent pintent = PendingIntent.getService(ApplicationLoader.applicationContext, 0, new Intent(ApplicationLoader.applicationContext, NotificationRepeat.class), 0);
             SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Notifications", Activity.MODE_PRIVATE);
             int minutes = preferences.getInt("repeat_messages", 60);
-            if (minutes > 0 || personal_count > 0) {
+            if (minutes > 0 && personal_count > 0) {
                 alarm.set(AlarmManager.RTC_WAKEUP, System.currentTimeMillis() + minutes * 60 * 1000, pintent);
             } else {
                 alarm.cancel(pintent);

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarLayout.java
Patch:
@@ -567,6 +567,7 @@ public boolean presentFragment(final BaseFragment fragment, final boolean remove
             containerViewBack.addView(fragment.actionBar);
             fragment.actionBar.setTitleOverlayText(titleOverlayText);
         }
+
         containerViewBack.addView(fragmentView);
         ViewGroup.LayoutParams layoutParams = fragmentView.getLayoutParams();
         layoutParams.width = FrameLayout.LayoutParams.MATCH_PARENT;
@@ -623,6 +624,7 @@ public void onAnimationEnd(Object animation) {
                     public void run() {
                         presentFragmentInternalRemoveOld(removeLast, currentFragment);
                         fragment.onOpenAnimationEnd();
+                        ViewProxy.setTranslationX(containerView, 0);
                     }
                 };
                 currentAnimation = new AnimatorSetProxy();

File: TMessagesProj/src/main/java/org/telegram/ui/BlockedUsersActivity.java
Patch:
@@ -290,7 +290,9 @@ public View getView(int i, View view, ViewGroup viewGroup) {
                     view = new UserCell(mContext, 1);
                 }
                 TLRPC.User user = MessagesController.getInstance().getUser(MessagesController.getInstance().blockedUsers.get(i));
-                ((UserCell)view).setData(user, null, user.phone != null && user.phone.length() != 0 ? PhoneFormat.getInstance().format("+" + user.phone) : LocaleController.getString("NumberUnknown", R.string.NumberUnknown), 0);
+                if (user != null) {
+                    ((UserCell) view).setData(user, null, user.phone != null && user.phone.length() != 0 ? PhoneFormat.getInstance().format("+" + user.phone) : LocaleController.getString("NumberUnknown", R.string.NumberUnknown), 0);
+                }
             } else if (type == 1) {
                 if (view == null) {
                     view = new TextInfoCell(mContext);

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoCropActivity.java
Patch:
@@ -242,12 +242,12 @@ public Bitmap getBitmap() {
             }
             try {
                 return Bitmap.createBitmap(imageToCrop, x, y, size, size);
-            } catch (Exception e) {
+            } catch (Throwable e) {
                 FileLog.e("tmessags", e);
                 System.gc();
                 try {
                     return Bitmap.createBitmap(imageToCrop, x, y, size, size);
-                } catch (Exception e2) {
+                } catch (Throwable e2) {
                     FileLog.e("tmessages", e2);
                 }
             }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -287,10 +287,10 @@ public void onClick(DialogInterface dialogInterface, int i) {
                                 SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("Notifications", Activity.MODE_PRIVATE);
                                 SharedPreferences.Editor editor = preferences.edit();
                                 editor.clear().commit();
-                                NotificationCenter.getInstance().postNotificationName(NotificationCenter.appDidLogout);
                                 MessagesController.getInstance().unregistedPush();
                                 MessagesController.getInstance().logOut();
                                 UserConfig.clearConfig();
+                                NotificationCenter.getInstance().postNotificationName(NotificationCenter.appDidLogout);
                                 MessagesStorage.getInstance().cleanUp(false);
                                 MessagesController.getInstance().cleanUp();
                                 ContactsController.getInstance().deleteAllAppAccounts();

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarLayout.java
Patch:
@@ -628,7 +628,7 @@ public void run() {
                 currentAnimation = new AnimatorSetProxy();
                 currentAnimation.playTogether(
                         ObjectAnimatorProxy.ofFloat(containerView, "alpha", 0.0f, 1.0f),
-                        ObjectAnimatorProxy.ofFloat(containerView, "translationY", AndroidUtilities.dp(48), 0));
+                        ObjectAnimatorProxy.ofFloat(containerView, "translationX", AndroidUtilities.dp(48), 0));
                 currentAnimation.setInterpolator(new DecelerateInterpolator(1.5f));
                 currentAnimation.setDuration(200);
                 currentAnimation.addListener(new AnimatorListenerAdapterProxy() {
@@ -730,14 +730,14 @@ public void closeLastFragment(boolean animated) {
                     @Override
                     public void run() {
                         closeLastFragmentInternalRemoveOld(currentFragment);
-                        ViewProxy.setTranslationY(containerViewBack, 0);
+                        ViewProxy.setTranslationX(containerViewBack, 0);
                     }
                 };
 
                 currentAnimation = new AnimatorSetProxy();
                 currentAnimation.playTogether(
                         ObjectAnimatorProxy.ofFloat(containerViewBack, "alpha", 1.0f, 0.0f),
-                        ObjectAnimatorProxy.ofFloat(containerViewBack, "translationY", 0, AndroidUtilities.dp(48)));
+                        ObjectAnimatorProxy.ofFloat(containerViewBack, "translationX", 0, AndroidUtilities.dp(48)));
                 currentAnimation.setInterpolator(new DecelerateInterpolator(1.5f));
                 currentAnimation.setDuration(200);
                 currentAnimation.addListener(new AnimatorListenerAdapterProxy() {

File: TMessagesProj/src/main/java/org/telegram/ui/ProfileActivity.java
Patch:
@@ -1125,11 +1125,12 @@ private void createActionBarMenu() {
             }
         } else if (chat_id != 0) {
             ActionBarMenuItem item = menu.addItem(0, R.drawable.ic_ab_other);
-            item.addSubItem(edit_name, LocaleController.getString("EditName", R.string.EditName), 0);
             if (chat_id > 0) {
                 item.addSubItem(add_member, LocaleController.getString("AddMember", R.string.AddMember), 0);
+                item.addSubItem(edit_name, LocaleController.getString("EditName", R.string.EditName), 0);
                 item.addSubItem(leave_group, LocaleController.getString("DeleteAndExit", R.string.DeleteAndExit), 0);
             } else {
+                item.addSubItem(edit_name, LocaleController.getString("EditName", R.string.EditName), 0);
                 item.addSubItem(add_member, LocaleController.getString("AddRecipient", R.string.AddRecipient), 0);
             }
         }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarDrawable.java
Patch:
@@ -44,6 +44,7 @@ public class AvatarDrawable extends Drawable {
     private StaticLayout textLayout;
     private float textWidth;
     private float textHeight;
+    private float textLeft;
     private boolean isProfile;
     private boolean drawBrodcast;
     private boolean drawPhoto;
@@ -168,6 +169,7 @@ public void setInfo(int id, String firstName, String lastName, boolean isBroadca
             try {
                 textLayout = new StaticLayout(text, namePaint, AndroidUtilities.dp(100), Layout.Alignment.ALIGN_NORMAL, 1.0f, 0.0f, false);
                 if (textLayout.getLineCount() > 0) {
+                    textLeft = textLayout.getLineLeft(0);
                     textWidth = textLayout.getLineWidth(0);
                     textHeight = textLayout.getLineBottom(0);
                 }
@@ -205,7 +207,7 @@ public void draw(Canvas canvas) {
             broadcastDrawable.draw(canvas);
         } else {
             if (textLayout != null) {
-                canvas.translate((size - textWidth) / 2, (size - textHeight) / 2);
+                canvas.translate((size - textWidth) / 2 - textLeft, (size - textHeight) / 2);
                 textLayout.draw(canvas);
             } else if (drawPhoto && photoDrawable != null) {
                 int x = (size - photoDrawable.getIntrinsicWidth()) / 2;

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
Patch:
@@ -145,6 +145,9 @@ public void setContainerView(Activity activity, View containerView) {
 
         sendButton = (ImageButton) containerView.findViewById(R.id.chat_send_button);
         sendButton.setVisibility(View.INVISIBLE);
+        ViewProxy.setScaleX(sendButton, 0.1f);
+        ViewProxy.setScaleY(sendButton, 0.1f);
+        ViewProxy.setAlpha(sendButton, 0.0f);
         emojiButton = (ImageView) containerView.findViewById(R.id.chat_smile_button);
         audioSendButton = (ImageButton) containerView.findViewById(R.id.chat_audio_send_button);
         recordPanel = containerView.findViewById(R.id.record_panel);

File: TMessagesProj/src/main/java/org/telegram/android/ContactsController.java
Patch:
@@ -1636,6 +1636,9 @@ public void run() {
                                     TLRPC.User toDbUser = new TLRPC.User();
                                     TLRPC.TL_contactStatus status = (TLRPC.TL_contactStatus) object;
 
+                                    if (status == null) {
+                                        continue;
+                                    }
                                     if (status.status instanceof TLRPC.TL_userStatusRecently) {
                                         status.status.expires = -100;
                                     } else if (status.status instanceof TLRPC.TL_userStatusLastWeek) {

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarMenu.java
Patch:
@@ -134,8 +134,9 @@ public void onMenuButtonPressed() {
             View view = getChildAt(a);
             if (view instanceof ActionBarMenuItem) {
                 ActionBarMenuItem item = (ActionBarMenuItem)view;
-                if (item.hasSubMenu()) {
+                if (item.hasSubMenu() && item.getVisibility() == VISIBLE) {
                     item.toggleSubMenu();
+                    break;
                 }
             }
         }

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/ContactsAdapter.java
Patch:
@@ -52,7 +52,9 @@ public Object getItem(int section, int position) {
         if (onlyUsers) {
             if (section < ContactsController.getInstance().sortedUsersSectionsArray.size()) {
                 ArrayList<TLRPC.TL_contact> arr = ContactsController.getInstance().usersSectionsDict.get(ContactsController.getInstance().sortedUsersSectionsArray.get(section));
-                return MessagesController.getInstance().getUser(arr.get(position).user_id);
+                if (position < arr.size()) {
+                    return MessagesController.getInstance().getUser(arr.get(position).user_id);
+                }
             }
             return null;
         } else {

File: TMessagesProj/src/main/java/org/telegram/ui/PrivacySettingsActivity.java
Patch:
@@ -183,7 +183,7 @@ public void onClick(DialogInterface dialog, int which) {
                                 if (which == 0) {
                                     value = 30;
                                 } else if (which == 1) {
-                                    value = 60;
+                                    value = 90;
                                 } else if (which == 2) {
                                     value = 182;
                                 } else if (which == 3) {

File: TMessagesProj/src/main/java/org/telegram/ui/VideoEditorActivity.java
Patch:
@@ -184,7 +184,9 @@ public void run() {
             @Override
             public void onPrepared(MediaPlayer mp) {
                 playerPrepared = true;
-                videoPlayer.seekTo((int) (videoTimelineView.getLeftProgress() * videoDuration));
+                if (videoTimelineView != null && videoPlayer != null) {
+                    videoPlayer.seekTo((int) (videoTimelineView.getLeftProgress() * videoDuration));
+                }
             }
         });
         try {

File: TMessagesProj/src/main/java/org/telegram/ui/Views/SectionsListView.java
Patch:
@@ -132,6 +132,8 @@ public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCoun
                 View child = getChildAt(itemNum - firstVisibleItem);
                 if (child != null) {
                     header.setTag(child.getTop());
+                } else {
+                    header.setTag(-AndroidUtilities.dp(100));
                 }
                 itemNum += count;
             }

File: TMessagesProj/src/main/java/org/telegram/android/ContactsController.java
Patch:
@@ -1616,6 +1616,7 @@ public void run() {
 
     public void reloadContactsStatuses() {
         saveContactsLoadTime();
+        MessagesController.getInstance().clearFullUsers();
         SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
         final SharedPreferences.Editor editor = preferences.edit();
         editor.putBoolean("needGetStatuses", true).commit();

File: TMessagesProj/src/main/java/org/telegram/android/PhotoObject.java
Patch:
@@ -18,6 +18,7 @@
 import java.util.ArrayList;
 
 public class PhotoObject {
+
     public TLRPC.PhotoSize photoOwner;
     public Bitmap image;
 

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarLayout.java
Patch:
@@ -68,7 +68,7 @@ protected boolean drawChild(Canvas canvas, View child, long drawingTime) {
                     if (view == child) {
                         continue;
                     }
-                    if (view instanceof ActionBar) {
+                    if (view instanceof ActionBar && view.getVisibility() == VISIBLE) {
                         actionBarHeight = view.getMeasuredHeight();
                         wasActionBar = true;
                         break;

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/TextSettingsCell.java
Patch:
@@ -48,7 +48,7 @@ public TextSettingsCell(Context context) {
         textView.setGravity((LocaleController.isRTL ? Gravity.RIGHT : Gravity.LEFT) | Gravity.CENTER_VERTICAL);
         addView(textView);
         LayoutParams layoutParams = (LayoutParams) textView.getLayoutParams();
-        layoutParams.width = LayoutParams.WRAP_CONTENT;
+        layoutParams.width = LayoutParams.MATCH_PARENT;
         layoutParams.height = LayoutParams.MATCH_PARENT;
         layoutParams.leftMargin = AndroidUtilities.dp(17);
         layoutParams.rightMargin = AndroidUtilities.dp(17);
@@ -100,7 +100,7 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
         } else {
             width = availableWidth;
         }
-        textView.measure(MeasureSpec.makeMeasureSpec(width, MeasureSpec.AT_MOST), MeasureSpec.makeMeasureSpec(getMeasuredHeight(), MeasureSpec.EXACTLY));
+        textView.measure(MeasureSpec.makeMeasureSpec(width, MeasureSpec.EXACTLY), MeasureSpec.makeMeasureSpec(getMeasuredHeight(), MeasureSpec.EXACTLY));
     }
 
     public void setTextColor(int color) {
@@ -110,6 +110,7 @@ public void setTextColor(int color) {
     public void setText(String text, boolean divider) {
         textView.setText(text);
         valueTextView.setVisibility(GONE);
+        valueImageView.setVisibility(GONE);
         needDivider = divider;
         setWillNotDraw(!divider);
     }

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -654,7 +654,7 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
             actionBarLayout.presentFragment(new SettingsActivity(), false, true, true);
             drawerLayoutContainer.setAllowOpenDrawer(false);
             if (AndroidUtilities.isTablet()) {
-                layersActionBarLayout.showLastFragment();
+                actionBarLayout.showLastFragment();
                 rightActionBarLayout.showLastFragment();
             }
             pushOpened = true;

File: TMessagesProj/src/main/java/org/telegram/ui/ProfileActivity.java
Patch:
@@ -763,7 +763,7 @@ public void didReceivedNotification(int id, final Object... args) {
         if (id == NotificationCenter.updateInterfaces) {
             int mask = (Integer)args[0];
             if (user_id != 0) {
-                if ((mask & MessagesController.UPDATE_MASK_AVATAR) != 0 || (mask & MessagesController.UPDATE_MASK_NAME) != 0) {
+                if ((mask & MessagesController.UPDATE_MASK_AVATAR) != 0 || (mask & MessagesController.UPDATE_MASK_NAME) != 0 || (mask & MessagesController.UPDATE_MASK_STATUS) != 0) {
                     updateProfileData();
                 }
             } else if (chat_id != 0) {
@@ -1042,8 +1042,7 @@ private void updateProfileData() {
                 photo = user.photo.photo_small;
                 photoBig = user.photo.photo_big;
             }
-            AvatarDrawable avatarDrawable = new AvatarDrawable(user, true);
-            avatarDrawable.setColor(0xff5c98cd);
+            AvatarDrawable avatarDrawable = new AvatarDrawable(user);
             avatarImage.setImage(photo, "50_50", avatarDrawable);
 
             nameTextView.setText(ContactsController.formatName(user.first_name, user.last_name));

File: TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarDrawable.java
Patch:
@@ -69,13 +69,15 @@ public AvatarDrawable(TLRPC.Chat chat) {
     }
 
     public AvatarDrawable(TLRPC.User user, boolean profile) {
+        this();
         isProfile = profile;
         if (user != null) {
             setInfo(user.id, user.first_name, user.last_name, false);
         }
     }
 
     public AvatarDrawable(TLRPC.Chat chat, boolean profile) {
+        this();
         isProfile = profile;
         if (chat != null) {
             setInfo(chat.id, chat.title, null, chat.id < 0);

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/DrawerLayoutContainer.java
Patch:
@@ -165,6 +165,9 @@ public void cancelCurrentAnimation() {
     }
 
     public void openDrawer(boolean fast) {
+        if (AndroidUtilities.isTablet() && parentActionBarLayout != null && parentActionBarLayout.parentActivity != null) {
+            AndroidUtilities.hideKeyboard(parentActionBarLayout.parentActivity.getCurrentFocus());
+        }
         cancelCurrentAnimation();
         AnimatorSetProxy animatorSet = new AnimatorSetProxy();
         animatorSet.playTogether(

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
Patch:
@@ -695,6 +695,9 @@ public void setDialogId(long id) {
     }
 
     public void setFieldText(String text) {
+        if (messsageEditText == null) {
+            return;
+        }
         ignoreTextChange = true;
         messsageEditText.setText(text);
         messsageEditText.setSelection(messsageEditText.getText().length());

File: TMessagesProj/src/main/java/org/telegram/android/NativeLoader.java
Patch:
@@ -23,7 +23,7 @@
 
 public class NativeLoader {
 
-    private final static int LIB_VERSION = 2;
+    private final static int LIB_VERSION = 3;
     private final static String LIB_NAME = "tmessages." + LIB_VERSION;
     private final static String LIB_SO_NAME = "lib" + LIB_NAME + ".so";
     private final static String LOCALE_LIB_SO_NAME = "lib" + LIB_NAME + "loc.so";

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -108,7 +108,7 @@ public static class TPFactorizedValue {
     }
 
     public native static long doPQNative(long _what);
-    public native static void loadBitmap(String path, Bitmap bitmap, int scale);
+    public native static void loadBitmap(String path, Bitmap bitmap, int scale, int width, int height, int stride);
     public native static void blurBitmap(Object bitmap, int radius);
     public native static int convertVideoFrame(ByteBuffer src, ByteBuffer dest, int destFormat, int width, int height, int padding, int swap);
     private native static void aesIgeEncryption(ByteBuffer buffer, byte[] key, byte[] iv, boolean encrypt, int offset, int length);

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBarLayout.java
Patch:
@@ -284,6 +284,7 @@ private void onSlideAnimationEnd(final boolean backAnimation) {
             bringChildToFront(containerView);
 
             lastFragment = fragmentsStack.get(fragmentsStack.size() - 1);
+            currentActionBar = lastFragment.actionBar;
             lastFragment.onResume();
         } else {
             BaseFragment lastFragment = fragmentsStack.get(fragmentsStack.size() - 2);
@@ -302,7 +303,7 @@ private void onSlideAnimationEnd(final boolean backAnimation) {
             }
         }
         containerViewBack.setVisibility(View.GONE);
-        AndroidUtilities.unlockOrientation(parentActivity);
+        //AndroidUtilities.unlockOrientation(parentActivity);
         startedTracking = false;
         animationInProgress = false;
 
@@ -345,7 +346,7 @@ private void prepareForMoving(MotionEvent ev) {
         }
         lastFragment.onResume();
 
-        AndroidUtilities.lockOrientation(parentActivity);
+        //AndroidUtilities.lockOrientation(parentActivity);
     }
 
     public boolean onTouchEvent(MotionEvent ev) {

File: TMessagesProj/src/main/java/org/telegram/ui/BlockedUsersActivity.java
Patch:
@@ -161,9 +161,7 @@ public boolean onItemLongClick(AdapterView<?> adapterView, View view, int i, lon
                     selectedUserId = MessagesController.getInstance().blockedUsers.get(i);
 
                     AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
-
                     CharSequence[] items = new CharSequence[] {LocaleController.getString("Unblock", R.string.Unblock)};
-
                     builder.setItems(items, new DialogInterface.OnClickListener() {
                         @Override
                         public void onClick(DialogInterface dialogInterface, int i) {

File: TMessagesProj/src/main/java/org/telegram/ui/Views/SectionsListView.java
Patch:
@@ -17,6 +17,7 @@
 import android.widget.ListAdapter;
 import android.widget.ListView;
 
+import org.telegram.android.LocaleController;
 import org.telegram.messenger.FileLog;
 import org.telegram.ui.Adapters.BaseSectionsAdapter;
 
@@ -181,7 +182,7 @@ protected void dispatchDraw(Canvas canvas) {
         for (View header : headers) {
             int saveCount = canvas.save();
             int top = (Integer)header.getTag();
-            canvas.translate(0, top);
+            canvas.translate(LocaleController.isRTL ? getWidth() - header.getWidth() : 0, top);
             canvas.clipRect(0, 0, getWidth(), header.getMeasuredHeight());
             if (top < 0) {
                 canvas.saveLayerAlpha(0, top, header.getWidth(), top + canvas.getHeight(), (int)(255 * (1.0f + (float)top / (float)header.getMeasuredHeight())), Canvas.HAS_ALPHA_LAYER_SAVE_FLAG);

File: TMessagesProj/src/main/java/org/telegram/ui/ActionBar/ActionBar.java
Patch:
@@ -232,7 +232,7 @@ public void setSubtitle(CharSequence value) {
             createSubtitleTextView();
         }
         if (subTitleTextView != null) {
-            subTitleTextView.setVisibility(value != null ? VISIBLE : GONE);
+            subTitleTextView.setVisibility(value != null && !isSearchFieldVisible ? VISIBLE : GONE);
             subTitleTextView.setText(value);
             positionTitle(getMeasuredWidth(), getMeasuredHeight());
         }
@@ -274,7 +274,7 @@ public void setTitle(CharSequence value) {
         }
         if (titleTextView != null) {
             lastTitle = value;
-            titleTextView.setVisibility(value != null ? VISIBLE : GONE);
+            titleTextView.setVisibility(value != null && !isSearchFieldVisible ? VISIBLE : GONE);
             titleTextView.setText(value);
             positionTitle(getMeasuredWidth(), getMeasuredHeight());
         }
@@ -433,7 +433,7 @@ public void setTitleOverlayText(String text) {
             createTitleTextView();
         }
         if (titleTextView != null) {
-            titleTextView.setVisibility(textToSet != null ? VISIBLE : GONE);
+            titleTextView.setVisibility(textToSet != null && !isSearchFieldVisible ? VISIBLE : GONE);
             titleTextView.setText(textToSet);
             positionTitle(getMeasuredWidth(), getMeasuredHeight());
         }

File: TMessagesProj/src/main/java/org/telegram/ui/LocationActivity.java
Patch:
@@ -153,7 +153,8 @@ public void onItemClick(int id) {
             View bottomView = fragmentView.findViewById(R.id.location_bottom_view);
             TextView sendButton = (TextView) fragmentView.findViewById(R.id.location_send_button);
             if (sendButton != null) {
-                sendButton.setText(LocaleController.getString("SendLocation", R.string.SendLocation));
+                sendButton.setText(LocaleController.getString("SendLocation", R.string.SendLocation).toUpperCase());
+                sendButton.setTypeface(AndroidUtilities.getTypeface("fonts/rmedium.ttf"));
             }
 
             mapView = (MapView)fragmentView.findViewById(R.id.map_view);

File: TMessagesProj/src/main/java/org/telegram/ui/ProfileActivity.java
Patch:
@@ -697,7 +697,8 @@ private void needLayout() {
                 layoutParams.topMargin = (actionBar.getOccupyStatusBar() ? AndroidUtilities.statusBarHeight : 0) + AndroidUtilities.getCurrentActionBarHeight() + actionBar.getExtraHeight() - AndroidUtilities.dp(29.5f);
                 writeButton.setLayoutParams(layoutParams);
                 ViewProxy.setAlpha(writeButton, diff);
-                writeButton.setVisibility(diff == 0 ? View.GONE : View.VISIBLE);
+                writeButton.setEnabled(diff > 0.02);
+                writeButton.setVisibility(diff <= 0.02 ? View.GONE : View.VISIBLE);
             }
 
             avatarImage.imageReceiver.setRoundRadius(AndroidUtilities.dp(avatarSize / 2));
@@ -1063,7 +1064,7 @@ private void updateProfileData() {
                 photo = chat.photo.photo_small;
                 photoBig = chat.photo.photo_big;
             }
-            avatarImage.setImage(photo, "50_50", new AvatarDrawable(chat));
+            avatarImage.setImage(photo, "50_50", new AvatarDrawable(chat, true));
 
             avatarImage.imageReceiver.setVisible(!PhotoViewer.getInstance().isShowingImage(photoBig), false);
         }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -885,7 +885,8 @@ private void needLayout() {
             layoutParams.topMargin = (actionBar.getOccupyStatusBar() ? AndroidUtilities.statusBarHeight : 0) + AndroidUtilities.getCurrentActionBarHeight() + actionBar.getExtraHeight() - AndroidUtilities.dp(29.5f);
             writeButton.setLayoutParams(layoutParams);
             ViewProxy.setAlpha(writeButton, diff);
-            writeButton.setVisibility(diff == 0 ? View.GONE : View.VISIBLE);
+            writeButton.setEnabled(diff > 0.02);
+            writeButton.setVisibility(diff <= 0.02 ? View.GONE : View.VISIBLE);
 
             avatarImage.imageReceiver.setRoundRadius(AndroidUtilities.dp(avatarSize / 2));
             layoutParams = (FrameLayout.LayoutParams) avatarImage.getLayoutParams();

File: TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarDrawable.java
Patch:
@@ -31,9 +31,9 @@ public class AvatarDrawable extends Drawable {
     private static Paint paint = new Paint(Paint.ANTI_ALIAS_FLAG);
     private static TextPaint namePaint;
     private static int[] arrColors = {0xffe56555, 0xfff28c48, 0xffeec764, 0xff76c84d, 0xff5fbed5, 0xff549cdd, 0xff8e85ee, 0xfff2749a};
-    private static int[] arrColorsProfiles = {0xffd86f65, 0xffdc9663, 0xffdebc68, 0xff67b35d, 0xff56a2bb, 0xff5c98cd, 0xff8c79d2, 0xffda738e};
-    private static int[] arrColorsProfilesBack = {0xffca6056, 0xffcf8550, 0xffcfa742, 0xff56a14c, 0xff4492ac, 0xff4c84b6, 0xff7d6ac4, 0xffc9637e};
-    private static int[] arrColorsProfilesText = {0xfff9cbc5, 0xfffadbc4, 0xfff7e7bf, 0xffc0edba, 0xffb8e2f0, 0xffb3d7f7, 0xffcdc4ed, 0xfff2cfd8};
+    private static int[] arrColorsProfiles = {0xffd86f65, 0xfff69d61, 0xfffabb3c, 0xff67b35d, 0xff56a2bb, 0xff5c98cd, 0xff8c79d2, 0xfff37fa6};
+    private static int[] arrColorsProfilesBack = {0xffca6056, 0xfff18944, 0xfff2b02c, 0xff56a14c, 0xff4492ac, 0xff4c84b6, 0xff7d6ac4, 0xffe66b94};
+    private static int[] arrColorsProfilesText = {0xfff9cbc5, 0xfffdddc8, 0xfffce5bb, 0xffc0edba, 0xffb8e2f0, 0xffb3d7f7, 0xffcdc4ed, 0xfffed1e0};
     private static int[] arrColorsButtons = {R.drawable.bar_selector_red, R.drawable.bar_selector_orange, R.drawable.bar_selector_yellow,
             R.drawable.bar_selector_green, R.drawable.bar_selector_cyan, R.drawable.bar_selector_blue, R.drawable.bar_selector_violet, R.drawable.bar_selector_pink};
 

File: TMessagesProj/src/main/java/org/telegram/android/NativeLoader.java
Patch:
@@ -23,7 +23,7 @@
 
 public class NativeLoader {
 
-    private final static int LIB_VERSION = 1;
+    private final static int LIB_VERSION = 2;
     private final static String LIB_NAME = "tmessages." + LIB_VERSION;
     private final static String LIB_SO_NAME = "lib" + LIB_NAME + ".so";
     private final static String LOCALE_LIB_SO_NAME = "lib" + LIB_NAME + "loc.so";

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -14,6 +14,7 @@
 import android.content.Intent;
 import android.content.SharedPreferences;
 import android.database.Cursor;
+import android.graphics.Bitmap;
 import android.net.Uri;
 import android.os.Build;
 import android.os.Environment;
@@ -107,7 +108,7 @@ public static class TPFactorizedValue {
     }
 
     public native static long doPQNative(long _what);
-    public native static void loadBitmap(String path, int[] bitmap, int scale, int format, int width, int height);
+    public native static void loadBitmap(String path, Bitmap bitmap, int scale);
     public native static void blurBitmap(Object bitmap, int radius);
     public native static int convertVideoFrame(ByteBuffer src, ByteBuffer dest, int destFormat, int width, int height, int padding, int swap);
     private native static void aesIgeEncryption(ByteBuffer buffer, byte[] key, byte[] iv, boolean encrypt, int offset, int length);

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
Patch:
@@ -319,9 +319,9 @@ private void sendMessage() {
     public boolean processSendingText(String text) {
         text = getTrimmedString(text);
         if (text.length() != 0) {
-            int count = (int)Math.ceil(text.length() / 2048.0f);
+            int count = (int)Math.ceil(text.length() / 4096.0f);
             for (int a = 0; a < count; a++) {
-                String mess = text.substring(a * 2048, Math.min((a + 1) * 2048, text.length()));
+                String mess = text.substring(a * 4096, Math.min((a + 1) * 4096, text.length()));
                 SendMessagesHelper.getInstance().sendMessage(mess, dialog_id);
             }
             return true;

File: TMessagesProj/src/main/java/org/telegram/android/LocaleController.java
Patch:
@@ -18,6 +18,7 @@
 import android.text.format.DateFormat;
 import android.util.Xml;
 
+import org.telegram.android.time.FastDateFormat;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.R;

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLog.java
Patch:
@@ -11,7 +11,7 @@
 import android.net.Uri;
 import android.util.Log;
 
-import org.telegram.android.FastDateFormat;
+import org.telegram.android.time.FastDateFormat;
 import org.telegram.ui.ApplicationLoader;
 
 import java.io.File;

File: TMessagesProj/src/main/java/org/telegram/messenger/TLClassStore.java
Patch:
@@ -371,6 +371,7 @@ public TLClassStore () {
         classStore.put(TLRPC.TL_userForeign_old.constructor, TLRPC.TL_userForeign_old.class);
         classStore.put(TLRPC.TL_userDeleted_old.constructor, TLRPC.TL_userDeleted_old.class);
         classStore.put(TLRPC.TL_messageEncryptedAction.constructor, TLRPC.TL_messageEncryptedAction.class);
+        classStore.put(TLRPC.TL_decryptedMessageHolder.constructor, TLRPC.TL_decryptedMessageHolder.class);
     }
 
     static TLClassStore store = null;

File: TMessagesProj/src/main/java/org/telegram/android/video/Track.java
Patch:
@@ -16,7 +16,7 @@
 import com.coremedia.iso.boxes.SampleDescriptionBox;
 import com.coremedia.iso.boxes.SoundMediaHeaderBox;
 import com.coremedia.iso.boxes.VideoMediaHeaderBox;
-import com.coremedia.iso.boxes.h264.AvcConfigurationBox;
+import com.mp4parser.iso14496.part15.AvcConfigurationBox;
 import com.coremedia.iso.boxes.sampleentry.AudioSampleEntry;
 import com.coremedia.iso.boxes.sampleentry.VisualSampleEntry;
 import com.googlecode.mp4parser.boxes.mp4.ESDescriptorBox;

File: TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java
Patch:
@@ -218,7 +218,7 @@ public static void hideKeyboard(View view) {
     }
 
     public static File getCacheDir() {
-        if (Environment.getExternalStorageState().startsWith(Environment.MEDIA_MOUNTED)) {
+        if (Environment.getExternalStorageState() == null || Environment.getExternalStorageState().startsWith(Environment.MEDIA_MOUNTED)) {
             try {
                 File file = ApplicationLoader.applicationContext.getExternalCacheDir();
                 if (file != null) {

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -1040,7 +1040,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
     }
 
     private boolean sendSecretMessageRead(MessageObject messageObject) {
-        if (messageObject == null || messageObject.isOut() || !messageObject.isSecretMedia() || messageObject.messageOwner.destroyTime != 0) {
+        if (messageObject == null || messageObject.isOut() || !messageObject.isSecretMedia() || messageObject.messageOwner.destroyTime != 0 || messageObject.messageOwner.ttl <= 0) {
             return false;
         }
         MessagesController.getInstance().markMessageAsRead(dialog_id, messageObject.messageOwner.random_id, messageObject.messageOwner.ttl);

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -477,7 +477,7 @@ private void openAddMenu() {
         args.putBoolean("destroyAfterSelect", true);
         args.putBoolean("usersAsSections", true);
         args.putBoolean("returnAsResult", true);
-        args.putBoolean("allowUsernameSearch", false);
+        //args.putBoolean("allowUsernameSearch", false);
         if (chat_id > 0) {
             args.putString("selectAlertString", LocaleController.getString("AddToTheGroup", R.string.AddToTheGroup));
         }

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
Patch:
@@ -82,11 +82,10 @@ public boolean onFragmentCreate() {
         if (!usersToLoad.isEmpty()) {
             final Semaphore semaphore = new Semaphore(0);
             final ArrayList<TLRPC.User> users = new ArrayList<TLRPC.User>();
-            final boolean[] error = new boolean[1];
             MessagesStorage.getInstance().storageQueue.postRunnable(new Runnable() {
                 @Override
                 public void run() {
-                    users.addAll(MessagesStorage.getInstance().getUsers(usersToLoad, error));
+                    users.addAll(MessagesStorage.getInstance().getUsers(usersToLoad));
                     semaphore.release();
                 }
             });
@@ -95,7 +94,7 @@ public void run() {
             } catch (Exception e) {
                 FileLog.e("tmessages", e);
             }
-            if (error[0]) {
+            if (usersToLoad.size() != users.size()) {
                 return false;
             }
             if (!users.isEmpty()) {

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
Patch:
@@ -1173,6 +1173,7 @@ private void onPhotoShow(final MessageObject messageObject, final TLRPC.FileLoca
                 menuItem.hideSubItem(gallery_menu_save);
                 shareButton.setVisibility(View.GONE);
             } else {
+                menuItem.showSubItem(gallery_menu_save);
                 shareButton.setVisibility(View.VISIBLE);
             }
             setImageIndex(0, true);
@@ -1215,6 +1216,7 @@ private void onPhotoShow(final MessageObject messageObject, final TLRPC.FileLoca
                 menuItem.hideSubItem(gallery_menu_save);
                 shareButton.setVisibility(View.GONE);
             } else {
+                menuItem.showSubItem(gallery_menu_save);
                 shareButton.setVisibility(View.VISIBLE);
             }
             opennedFromMedia = true;

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsChangeUsernameActivity.java
Patch:
@@ -194,6 +194,9 @@ public void onResume() {
     }
 
     private void showErrorAlert(String error) {
+        if (getParentActivity() == null) {
+            return;
+        }
         AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
         builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
         if (error.equals("USERNAME_INVALID")) {

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/BaseContactsSearchAdapter.java
Patch:
@@ -18,7 +18,7 @@
 
 public class BaseContactsSearchAdapter extends BaseFragmentAdapter {
 
-    protected ArrayList<TLRPC.User> globalSearch;
+    protected ArrayList<TLRPC.User> globalSearch = new ArrayList<TLRPC.User>();
     private long reqId = 0;
     private int lastReqId;
     protected String lastFoundUsername = null;
@@ -29,7 +29,7 @@ public void queryServerSearch(final String query) {
                 ConnectionsManager.getInstance().cancelRpc(reqId, true);
                 reqId = 0;
             }
-            globalSearch = null;
+            globalSearch.clear();
             lastReqId = 0;
             notifyDataSetChanged();
             return;

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -477,6 +477,7 @@ private void openAddMenu() {
         args.putBoolean("destroyAfterSelect", true);
         args.putBoolean("usersAsSections", true);
         args.putBoolean("returnAsResult", true);
+        args.putBoolean("allowUsernameSearch", false);
         if (chat_id > 0) {
             args.putString("selectAlertString", LocaleController.getString("AddToTheGroup", R.string.AddToTheGroup));
         }

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -787,6 +787,9 @@ public void needLayout() {
 
     public void fixLayout() {
         if (AndroidUtilities.isTablet()) {
+            if (actionBarLayout == null) {
+                return;
+            }
             actionBarLayout.getViewTreeObserver().addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() {
                 @Override
                 public void onGlobalLayout() {

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoPickerActivity.java
Patch:
@@ -279,6 +279,9 @@ public void willSwitchFromPhoto(MessageObject messageObject, TLRPC.FileLocation
         int count = listView.getChildCount();
         for (int a = 0; a < count; a++) {
             View view = listView.getChildAt(a);
+            if (view.getTag() == null) {
+                continue;
+            }
             int num = (Integer)view.getTag();
             if (num < 0 || num >= selectedAlbum.photos.size()) {
                 continue;

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsChangeUsernameActivity.java
Patch:
@@ -239,7 +239,7 @@ private boolean checkUserName(final String name, boolean alert) {
                     }
                     return false;
                 }
-                if (!(ch >= '0' && ch <= '9' || ch >= 'a' && ch <= 'z' || ch >= 'A' && ch <= 'Z' || a == '_')) {
+                if (!(ch >= '0' && ch <= '9' || ch >= 'a' && ch <= 'z' || ch >= 'A' && ch <= 'Z' || ch == '_')) {
                     if (alert) {
                         showErrorAlert(LocaleController.getString("UsernameInvalid", R.string.UsernameInvalid));
                     } else {

File: TMessagesProj/src/main/java/org/telegram/android/MessagesController.java
Patch:
@@ -4147,7 +4147,7 @@ public void run() {
                                             }
                                             AlertDialog.Builder builder = new AlertDialog.Builder(context);
                                             builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
-                                            builder.setMessage(LocaleController.formatString("CreateEncryptedChatOutdatedError", R.string.CreateEncryptedChatOutdatedError, user.first_name, user.first_name));
+                                            builder.setMessage(LocaleController.getString("CreateEncryptedChatError", R.string.CreateEncryptedChatError));
                                             builder.setPositiveButton(LocaleController.getString("OK", R.string.OK), null);
                                             builder.show().setCanceledOnTouchOutside(true);
                                         }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -1001,7 +1001,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                     if (user != null && user.username != null && user.username.length() != 0) {
                         detailTextView.setText("@" + user.username);
                     } else {
-                        detailTextView.setText("-");
+                        detailTextView.setText(LocaleController.getString("UsernameEmpty", R.string.UsernameEmpty));
                     }
                     divider.setVisibility(View.INVISIBLE);
                 }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsChangeUsernameActivity.java
Patch:
@@ -202,8 +202,10 @@ private void showErrorAlert(String error) {
             builder.setMessage(LocaleController.getString("UsernameInvalid", R.string.UsernameInvalid));
         } else if (error.equals("USERNAME_OCCUPIED")) {
             builder.setMessage(LocaleController.getString("UsernameInUse", R.string.UsernameInUse));
+        } else if (error.equals("USERNAMES_UNAVAILABLE")) {
+            builder.setMessage(LocaleController.getString("FeatureUnavailable", R.string.FeatureUnavailable));
         } else {
-            builder.setMessage(error);
+            builder.setMessage(LocaleController.getString("ErrorOccurred", R.string.ErrorOccurred));
         }
         builder.setPositiveButton(LocaleController.getString("OK", R.string.OK), null);
         showAlertDialog(builder);

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -2438,6 +2438,7 @@ public void run() {
                 }
             });
         } else if ((connection.transportRequestClass & RPCRequest.RPCRequestClassPush) != 0) {
+            FileLog.e("tmessages", "call connection closed");
             sendingPushPing = false;
             lastPushPingTime = System.currentTimeMillis() - 60000 * 3 + 4000;
         }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/NumberPicker.java
Patch:
@@ -166,7 +166,7 @@ public NumberPicker(Context context, AttributeSet attrs, int defStyle) {
         mInputText.setLayoutParams(new LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT));
         mInputText.setGravity(Gravity.CENTER);
         mInputText.setSingleLine(true);
-        mInputText.setBackground(null);
+        mInputText.setBackgroundResource(0);
         mInputText.setTextSize(TypedValue.COMPLEX_UNIT_SP, 18);
 
         ViewConfiguration configuration = ViewConfiguration.get(context);

File: TMessagesProj/src/main/java/org/telegram/android/ImageReceiver.java
Patch:
@@ -108,6 +108,9 @@ public void setImage(TLRPC.FileLocation fileLocation, String httpUrl, String fil
         if (img == null) {
             isPlaceholder = true;
             ImageLoader.getInstance().loadImage(fileLocation, httpUrl, this, size, cacheOnly);
+            if (parentView != null) {
+                parentView.invalidate();
+            }
         } else {
             setImageBitmap(img, currentPath);
         }

File: TMessagesProj/src/main/java/org/telegram/messenger/TLClassStore.java
Patch:
@@ -370,6 +370,7 @@ public TLClassStore () {
         classStore.put(TLRPC.TL_userRequest_old.constructor, TLRPC.TL_userRequest_old.class);
         classStore.put(TLRPC.TL_userForeign_old.constructor, TLRPC.TL_userForeign_old.class);
         classStore.put(TLRPC.TL_userDeleted_old.constructor, TLRPC.TL_userDeleted_old.class);
+        classStore.put(TLRPC.TL_messageEcryptedAction.constructor, TLRPC.TL_messageEcryptedAction.class);
     }
 
     static TLClassStore store = null;

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -926,7 +926,7 @@ public void onScrollStateChanged(AbsListView absListView, int i) {
                 @Override
                 public void onScroll(AbsListView absListView, int firstVisibleItem, int visibleItemCount, int totalItemCount) {
                     if (visibleItemCount > 0) {
-                        if (firstVisibleItem <= 4) {
+                        if (firstVisibleItem <= 10) {
                             if (!endReached && !loading) {
                                 if (messagesByDays.size() != 0) {
                                     MessagesController.getInstance().loadMessages(dialog_id, 20, maxMessageId, !cacheEndReaced, minDate, classGuid, false, false, null);

File: TMessagesProj/src/main/java/org/telegram/android/ImageLoader.java
Patch:
@@ -28,7 +28,6 @@
 import org.telegram.messenger.DispatchQueue;
 import org.telegram.messenger.FileLoader;
 import org.telegram.messenger.FileLog;
-import org.telegram.messenger.R;
 import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.UserConfig;
 import org.telegram.messenger.Utilities;
@@ -293,7 +292,7 @@ public void run() {
                             }
                         }
                         if (image != null && blur && bitmapH < 100 && bitmapW < 100) {
-                            Utilities.blurBitmap(image);
+                            Utilities.blurBitmap(image, 3);
                         }
                     }
                     if (runtimeHack != null) {

File: TMessagesProj/src/main/java/org/telegram/android/NativeLoader.java
Patch:
@@ -24,9 +24,9 @@
 public class NativeLoader {
 
     private static final long sizes[] = new long[] {
-            951052,     //armeabi
-            1032992,    //armeabi-v7a
-            1612020,    //x86
+            955148,     //armeabi
+            1041184,    //armeabi-v7a
+            1616116,    //x86
             0,          //mips
     };
 

File: TMessagesProj/src/main/java/org/telegram/messenger/TLClassStore.java
Patch:
@@ -362,6 +362,7 @@ public TLClassStore () {
         classStore.put(TLRPC.TL_messageService_old.constructor, TLRPC.TL_messageService_old.class);
         classStore.put(TLRPC.TL_decryptedMessageService_old.constructor, TLRPC.TL_decryptedMessageService_old.class);
         classStore.put(TLRPC.TL_decryptedMessage_old.constructor, TLRPC.TL_decryptedMessage_old.class);
+        classStore.put(TLRPC.TL_message_secret.constructor, TLRPC.TL_message_secret.class);
     }
 
     static TLClassStore store = null;

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -28,7 +28,6 @@
 import net.hockeyapp.android.CrashManagerListener;
 import net.hockeyapp.android.UpdateManager;
 
-import org.telegram.android.LocaleController;
 import org.telegram.ui.ApplicationLoader;
 
 import java.io.ByteArrayInputStream;
@@ -112,7 +111,7 @@ public static class TPFactorizedValue {
 
     public native static long doPQNative(long _what);
     public native static void loadBitmap(String path, int[] bitmap, int scale, int format, int width, int height);
-    public native static void blurBitmap(Object bitmap);
+    public native static void blurBitmap(Object bitmap, int radius);
     public native static int convertVideoFrame(ByteBuffer src, ByteBuffer dest, int destFormat, int width, int height, int padding, int swap);
     private native static void aesIgeEncryption(ByteBuffer buffer, byte[] key, byte[] iv, boolean encrypt, int offset, int length);
 

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -836,6 +836,7 @@ protected void onPause() {
     @Override
     protected void onDestroy() {
         PhotoViewer.getInstance().destroyPhotoViewer();
+        SecretPhotoViewer.getInstance().destroyPhotoViewer();
         super.onDestroy();
         onFinish();
     }

File: TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
Patch:
@@ -9,9 +9,9 @@
 package org.telegram.messenger;
 
 public class BuildVars {
-    public static boolean DEBUG_VERSION = true;
-    public static int APP_ID = 2458;
-    public static String APP_HASH = "5bce48dc7d331e62c955669eb7233217";
+    public static boolean DEBUG_VERSION = false;
+    public static int APP_ID = 0; //obtaion your own APP_ID at https://core.telegram.org/api/obtaining_api_id
+    public static String APP_HASH = ""; //obtaion your own APP_HASH at https://core.telegram.org/api/obtaining_api_id
     public static String HOCKEY_APP_HASH = "your-hockeyapp-api-key-here";
     public static String GCM_SENDER_ID = "760348033672";
     public static String SEND_LOGS_EMAIL = "email@gmail.com";

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/ContactsActivitySearchAdapter.java
Patch:
@@ -87,7 +87,8 @@ public void run() {
 
                         for (TLRPC.TL_contact contact : contactsCopy) {
                             TLRPC.User user = MessagesController.getInstance().getUser(contact.user_id);
-                            if (user.first_name != null && user.first_name.toLowerCase().startsWith(q) || user.last_name != null && user.last_name.toLowerCase().startsWith(q)) {
+                            String name = ContactsController.formatName(user.first_name, user.last_name).toLowerCase();
+                            if (name.startsWith(q) || name.contains(" " + q)) {
                                 if (user.id == UserConfig.getClientUserId()) {
                                     continue;
                                 }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
Patch:
@@ -354,9 +354,9 @@ public void setMessageObject(MessageObject messageObject) {
                 if (audioUser.photo != null) {
                     currentPhoto = audioUser.photo.photo_small;
                 }
-                avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)));
+                avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)), false);
             } else {
-                avatarImage.setImage((TLRPC.FileLocation)null, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)));
+                avatarImage.setImage((TLRPC.FileLocation)null, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)), false);
             }
 
             if (messageObject.isOut()) {

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
Patch:
@@ -265,9 +265,9 @@ public void setMessageObject(MessageObject messageObject) {
                 } else {
                     currentPhoto = null;
                 }
-                avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(currentUser.id)));
+                avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(currentUser.id)), false);
             } else {
-                avatarImage.setImage((TLRPC.FileLocation)null, "50_50", null);
+                avatarImage.setImage(null, "50_50", null, false);
             }
         }
 

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatOrUserCell.java
Patch:
@@ -215,7 +215,7 @@ public void update(int mask) {
 
 
         lastAvatar = photo;
-        avatarImage.setImage(photo, "50_50", placeHolderId == 0 ? null : getResources().getDrawable(placeHolderId));
+        avatarImage.setImage(photo, "50_50", placeHolderId == 0 ? null : getResources().getDrawable(placeHolderId), false);
 
         if (getMeasuredWidth() != 0 || getMeasuredHeight() != 0) {
             buildLayout();

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
Patch:
@@ -263,7 +263,7 @@ public void update(int mask) {
                 placeHolderId = AndroidUtilities.getBroadcastAvatarForId(chat.id);
             }
         }
-        avatarImage.setImage(photo, "50_50", placeHolderId == 0 ? null : getResources().getDrawable(placeHolderId));
+        avatarImage.setImage(photo, "50_50", placeHolderId == 0 ? null : getResources().getDrawable(placeHolderId), false);
 
         if (getMeasuredWidth() != 0 || getMeasuredHeight() != 0) {
             buildLayout();

File: TMessagesProj/src/main/java/org/telegram/ui/Views/BackupImageView.java
Patch:
@@ -69,7 +69,7 @@ public void setImage(TLRPC.FileLocation path, String httpUrl, String filter, int
         } else if (placeholder != 0) {
             placeholderDrawable = getResources().getDrawable(placeholder);
         }
-        imageReceiver.setImage(path, httpUrl, filter, placeholderDrawable, size);
+        imageReceiver.setImage(path, httpUrl, filter, placeholderDrawable, size, false);
     }
 
     public void setImageBitmap(Bitmap bitmap) {

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -630,7 +630,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                 }
 
                 if (count != 0 && onlineCount > 1) {
-                    onlineText.setText(Html.fromHtml(String.format("%s, <font color='#357aa8'>%d %s</font>", LocaleController.formatPluralString("Members", count), onlineCount, LocaleController.formatPluralString("Online", onlineCount))));
+                    onlineText.setText(Html.fromHtml(String.format("%s, <font color='#357aa8'>%s</font>", LocaleController.formatPluralString("Members", count), LocaleController.formatPluralString("Online", onlineCount))));
                 } else {
                     onlineText.setText(LocaleController.formatPluralString("Members", count));
                 }

File: TMessagesProj/src/main/java/org/telegram/android/AndroidUtilities.java
Patch:
@@ -35,7 +35,7 @@ public class AndroidUtilities {
     private static final Hashtable<String, Typeface> typefaceCache = new Hashtable<String, Typeface>();
     private static int prevOrientation = -10;
     private static boolean waitingForSms = false;
-    private static final Integer smsLock = 2;
+    private static final Object smsLock = new Object();
     public static int externalCacheNotAvailableState = 0;
 
     public static int statusBarHeight = 0;

File: TMessagesProj/src/main/java/org/telegram/android/ContactsController.java
Patch:
@@ -40,10 +40,10 @@
 public class ContactsController {
     private Account currentAccount;
     private boolean loadingContacts = false;
-    private static final Integer loadContactsSync = 1;
+    private static final Object loadContactsSync = new Object();
     private boolean ignoreChanges = false;
     private boolean contactsSyncInProgress = false;
-    private final Integer observerLock = 1;
+    private final Object observerLock = new Object();
     public boolean contactsLoaded = false;
     private boolean contactsBookLoaded = false;
     private String lastContactsVersions = "";

File: TMessagesProj/src/main/java/org/telegram/android/GcmBroadcastReceiver.java
Patch:
@@ -16,13 +16,11 @@
 import org.json.JSONObject;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLog;
-import org.telegram.messenger.Utilities;
 import org.telegram.ui.ApplicationLoader;
 
 public class GcmBroadcastReceiver extends BroadcastReceiver {
 
     public static final int NOTIFICATION_ID = 1;
-    private static final Integer sync = 1;
 
     @Override
     public void onReceive(final Context context, final Intent intent) {

File: TMessagesProj/src/main/java/org/telegram/android/ImageLoader.java
Patch:
@@ -161,7 +161,7 @@ protected void onCancelled() {
 
     private class CacheOutTask implements Runnable {
         private Thread runningThread = null;
-        private final Integer sync = 1;
+        private final Object sync = new Object();
 
         private CacheImage cacheImage = null;
         private boolean isCancelled = false;

File: TMessagesProj/src/main/java/org/telegram/android/MessageObject.java
Patch:
@@ -214,7 +214,7 @@ public MessageObject(TLRPC.Message message, AbstractMap<Integer, TLRPC.User> use
                         }
                     }
                 } else if (message.action instanceof TLRPC.TL_messageActionLoginUnknownLocation) {
-                    String date = String.format("%s %s %s", LocaleController.formatterYear.format(((long)message.date) * 1000), LocaleController.getString("OtherAt", R.string.OtherAt), LocaleController.formatterDay.format(((long)message.date) * 1000));
+                    String date = LocaleController.formatString("formatDateAtTime", R.string.formatDateAtTime, LocaleController.formatterYear.format(((long)message.date) * 1000), LocaleController.formatterDay.format(((long)message.date) * 1000));
                     TLRPC.User to_user = UserConfig.getCurrentUser();
                     if (to_user == null) {
                         if (users != null) {

File: TMessagesProj/src/main/java/org/telegram/messenger/BuffersStorage.java
Patch:
@@ -19,7 +19,7 @@ public class BuffersStorage {
     private final ArrayList<ByteBufferDesc> freeBuffers32768;
     private final ArrayList<ByteBufferDesc> freeBuffersBig;
     private boolean isThreadSafe;
-    private final static Integer sync = 1;
+    private final static Object sync = new Object();
 
     private static volatile BuffersStorage Instance = null;
     public static BuffersStorage getInstance() {

File: TMessagesProj/src/main/java/org/telegram/messenger/HandshakeAction.java
Patch:
@@ -87,7 +87,7 @@ void beginHandshake(boolean dropConnection) {
         reqPQMsgData = sendMessageData(reqPq, generateMessageId());
     }
 
-    final Integer lock = 1;
+    final Object lock = new Object();
     static ArrayList<HashMap<String, Object>> serverPublicKeys = null;
     HashMap<String, Object> selectPublicKey(ArrayList<Long> fingerprints) {
         synchronized (lock) {

File: TMessagesProj/src/main/java/org/telegram/messenger/TcpConnection.java
Patch:
@@ -48,7 +48,7 @@ public abstract static interface TcpConnectionDelegate {
     private boolean hasSomeDataSinceLastConnect = false;
     private int willRetryConnectCount = 5;
     private boolean isNextPort = false;
-    private final Integer timerSync = 1;
+    private final Object timerSync = new Object();
     private boolean wasConnected;
     private int lastPacketLength;
 

File: TMessagesProj/src/main/java/org/telegram/messenger/UserConfig.java
Patch:
@@ -28,7 +28,7 @@ public class UserConfig {
     public static String contactsHash = "";
     public static String importHash = "";
     public static boolean blockedUsersLoaded = false;
-    private final static Integer sync = 1;
+    private final static Object sync = new Object();
     public static boolean saveIncomingPhotos = false;
     public static int contactsVersion = 1;
 

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -1270,8 +1270,8 @@ private void updateSubtitle() {
                     if (info != null) {
                         count = info.participants.size();
                     }
-                    if (onlineCount > 0 && count != 0) {
-                        actionBarLayer.setSubtitle(String.format("%s, %d %s", LocaleController.formatPluralString("Members", count), onlineCount, LocaleController.getString("Online", R.string.Online)));
+                    if (onlineCount > 1 && count != 0) {
+                        actionBarLayer.setSubtitle(String.format("%s, %s", LocaleController.formatPluralString("Members", count), LocaleController.formatPluralString("Online", onlineCount)));
                     } else {
                         actionBarLayer.setSubtitle(LocaleController.formatPluralString("Members", count));
                     }

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -630,7 +630,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                 }
 
                 if (count != 0 && onlineCount > 1) {
-                    onlineText.setText(Html.fromHtml(String.format("%s, <font color='#357aa8'>%d %s</font>", LocaleController.formatPluralString("Members", count), onlineCount, LocaleController.getString("Online", R.string.Online))));
+                    onlineText.setText(Html.fromHtml(String.format("%s, <font color='#357aa8'>%d %s</font>", LocaleController.formatPluralString("Members", count), onlineCount, LocaleController.formatPluralString("Online", onlineCount))));
                 } else {
                     onlineText.setText(LocaleController.formatPluralString("Members", count));
                 }

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -562,9 +562,8 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
                 pushOpened = true;
             }
         } else if (showDialogsList) {
-            for (int a = 1; a < actionBarLayout.fragmentsStack.size(); a++) {
-                actionBarLayout.removeFragmentFromStack(actionBarLayout.fragmentsStack.get(a));
-                a--;
+            if (!AndroidUtilities.isTablet()) {
+                actionBarLayout.removeAllFragments();
             }
             pushOpened = false;
             isNew = false;

File: TMessagesProj/src/main/java/org/telegram/ui/LoginActivitySmsView.java
Patch:
@@ -54,7 +54,7 @@ public class LoginActivitySmsView extends SlideView implements NotificationCente
 
     private Timer timeTimer;
     private Timer codeTimer;
-    private static final Integer timerSync = 1;
+    private static final Object timerSync = new Object();
     private volatile int time = 60000;
     private volatile int codeTime = 15000;
     private double lastCurrentTime;
@@ -165,7 +165,7 @@ public void setParams(Bundle params) {
 
         destroyTimer();
         destroyCodeTimer();
-        timeText.setText(String.format("%s 1:00", LocaleController.getString("CallText", R.string.CallText)));
+        timeText.setText(LocaleController.formatString("CallText", R.string.CallText, 1, 0));
         lastCurrentTime = System.currentTimeMillis();
         problemText.setVisibility(time < 1000 ? VISIBLE : GONE);
 
@@ -230,7 +230,7 @@ public void run() {
                         if (time >= 1000) {
                             int minutes = time / 1000 / 60;
                             int seconds = time / 1000 - minutes * 60;
-                            timeText.setText(String.format("%s %d:%02d", LocaleController.getString("CallText", R.string.CallText), minutes, seconds));
+                            timeText.setText(LocaleController.formatString("CallText", R.string.CallText, minutes, seconds));
                         } else {
                             timeText.setText(LocaleController.getString("Calling", R.string.Calling));
                             destroyTimer();

File: TMessagesProj/src/main/java/org/telegram/ui/Views/VideoTimelineView.java
Patch:
@@ -41,7 +41,7 @@ public class VideoTimelineView extends View {
     private VideoTimelineViewDelegate delegate = null;
     private ArrayList<Bitmap> frames = new ArrayList<Bitmap>();
     private AsyncTask<Integer, Integer, Bitmap> currentTask = null;
-    private static final Integer sync = 1;
+    private static final Object sync = new Object();
     private long frameTimeOffset = 0;
     private int frameWidth = 0;
     private int frameHeight = 0;

File: TMessagesProj/src/main/java/org/telegram/android/MessageObject.java
Patch:
@@ -417,7 +417,7 @@ public String getFileName() {
         } else if (messageOwner.media instanceof TLRPC.TL_messageMediaPhoto) {
             ArrayList<TLRPC.PhotoSize> sizes = messageOwner.media.photo.sizes;
             if (sizes.size() > 0) {
-                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
+                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(sizes, AndroidUtilities.getPhotoSize());
                 if (sizeFull != null) {
                     return FileLoader.getAttachFileName(sizeFull);
                 }

File: TMessagesProj/src/main/java/org/telegram/android/MessagesStorage.java
Patch:
@@ -2600,7 +2600,7 @@ private void putMessagesInternal(final ArrayList<TLRPC.Message> messages, final
                             }
                         } else if (message.media instanceof TLRPC.TL_messageMediaPhoto) {
                             if ((downloadMask & MediaController.AUTODOWNLOAD_MASK_PHOTO) != 0) {
-                                TLRPC.PhotoSize photoSize = FileLoader.getClosestPhotoSizeWithSize(message.media.photo.sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
+                                TLRPC.PhotoSize photoSize = FileLoader.getClosestPhotoSizeWithSize(message.media.photo.sizes, AndroidUtilities.getPhotoSize());
                                 if (photoSize != null) {
                                     id = message.media.photo.id;
                                     type = MediaController.AUTODOWNLOAD_MASK_PHOTO;

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -946,17 +946,17 @@ public static boolean isNetworkOnline() {
         try {
             ConnectivityManager cm = (ConnectivityManager)ApplicationLoader.applicationContext.getSystemService(Context.CONNECTIVITY_SERVICE);
             NetworkInfo netInfo = cm.getActiveNetworkInfo();
-            if (netInfo != null && (netInfo.isConnectedOrConnecting() || netInfo.isRoaming() || netInfo.isAvailable())) {
+            if (netInfo != null && (netInfo.isConnectedOrConnecting() || netInfo.isAvailable())) {
                 return true;
             }
 
             netInfo = cm.getNetworkInfo(ConnectivityManager.TYPE_MOBILE);
 
-            if (netInfo != null && (netInfo.isConnectedOrConnecting() || netInfo.isRoaming())) {
+            if (netInfo != null && netInfo.isConnectedOrConnecting()) {
                 return true;
             } else {
                 netInfo = cm.getNetworkInfo(ConnectivityManager.TYPE_WIFI);
-                if(netInfo != null && (netInfo.isConnectedOrConnecting() || netInfo.isRoaming())) {
+                if(netInfo != null && netInfo.isConnectedOrConnecting()) {
                     return true;
                 }
             }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
Patch:
@@ -472,7 +472,7 @@ public void setMessageObject(MessageObject messageObject) {
                 photoWidth = AndroidUtilities.dp(86);
                 photoHeight = AndroidUtilities.dp(86);
                 backgroundWidth = photoWidth + Math.max(nameWidth, infoWidth) + AndroidUtilities.dp(68);
-                currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
+                currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize());
                 if (currentPhotoObject != null) {
                     if (currentPhotoObject.image != null) {
                         photoImage.setImageBitmap(currentPhotoObject.image);
@@ -507,7 +507,7 @@ public void setMessageObject(MessageObject messageObject) {
                     photoHeight = AndroidUtilities.getPhotoSize();
                 }
 
-                currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
+                currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize());
                 if (currentPhotoObject != null) {
                     boolean noSize = false;
                     if (currentMessageObject.type == 3 || currentMessageObject.type == 8) {

File: TMessagesProj/src/main/java/org/telegram/ui/MediaActivity.java
Patch:
@@ -413,7 +413,7 @@ public View getView(int i, View view, ViewGroup viewGroup) {
                     if (message.imagePreview != null) {
                         imageView.setImageBitmap(message.imagePreview);
                     } else {
-                        TLRPC.PhotoSize photoSize = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.media.photo.sizes, 80, 80);
+                        TLRPC.PhotoSize photoSize = FileLoader.getClosestPhotoSizeWithSize(message.messageOwner.media.photo.sizes, 80);
                         imageView.setImage(photoSize.location, null, R.drawable.photo_placeholder_in);
                     }
                 } else {

File: TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
Patch:
@@ -445,7 +445,7 @@ public void onClick(View v) {
             TextView messageText = (TextView)view.findViewById(R.id.message_text);
             BackupImageView imageView = (BackupImageView) view.findViewById(R.id.message_image);
             imageView.imageReceiver.setAspectFit(true);
-            PhotoObject currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
+            PhotoObject currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize());
             boolean photoSet = false;
             if (currentPhotoObject != null) {
                 boolean photoExist = true;

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -143,8 +143,8 @@ public void run(TLObject response, TLRPC.TL_error error) {
                             }
                             TLRPC.TL_photos_photo photo = (TLRPC.TL_photos_photo)response;
                             ArrayList<TLRPC.PhotoSize> sizes = photo.photo.sizes;
-                            TLRPC.PhotoSize smallSize = FileLoader.getClosestPhotoSizeWithSize(sizes, 100, 100);
-                            TLRPC.PhotoSize bigSize = FileLoader.getClosestPhotoSizeWithSize(sizes, 1000, 1000);
+                            TLRPC.PhotoSize smallSize = FileLoader.getClosestPhotoSizeWithSize(sizes, 100);
+                            TLRPC.PhotoSize bigSize = FileLoader.getClosestPhotoSizeWithSize(sizes, 1000);
                             user.photo = new TLRPC.TL_userProfilePhoto();
                             user.photo.photo_id = photo.photo.id;
                             if (smallSize != null) {

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java
Patch:
@@ -119,7 +119,7 @@ public void onClick(View view) {
                             width = height;
                             height = temp;
                         }
-                        TLRPC.PhotoSize size = FileLoader.getClosestPhotoSizeWithSize(wallPaper.sizes, width, height);
+                        TLRPC.PhotoSize size = FileLoader.getClosestPhotoSizeWithSize(wallPaper.sizes, Math.min(width, height));
                         String fileName = size.location.volume_id + "_" + size.location.local_id + ".jpg";
                         File f = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName);
                         File toFile = new File(ApplicationLoader.applicationContext.getFilesDir(), "wallpaper.jpg");
@@ -273,7 +273,7 @@ private void processSelectedBackground() {
                 width = height;
                 height = temp;
             }
-            TLRPC.PhotoSize size = FileLoader.getClosestPhotoSizeWithSize(wallPaper.sizes, width, height);
+            TLRPC.PhotoSize size = FileLoader.getClosestPhotoSizeWithSize(wallPaper.sizes, Math.min(width, height));
             String fileName = size.location.volume_id + "_" + size.location.local_id + ".jpg";
             File f = new File(FileLoader.getInstance().getDirectory(FileLoader.MEDIA_DIR_CACHE), fileName);
             if (!f.exists()) {
@@ -532,7 +532,7 @@ public View getView(int i, View view, ViewGroup viewGroup) {
                 BackupImageView image = (BackupImageView)view.findViewById(R.id.image);
                 View selection = view.findViewById(R.id.selection);
                 TLRPC.WallPaper wallPaper = wallPapers.get(i - 1);
-                TLRPC.PhotoSize size = FileLoader.getClosestPhotoSizeWithSize(wallPaper.sizes, AndroidUtilities.dp(100), AndroidUtilities.dp(100));
+                TLRPC.PhotoSize size = FileLoader.getClosestPhotoSizeWithSize(wallPaper.sizes, AndroidUtilities.dp(100));
                 if (size != null && size.location != null) {
                     image.setImage(size.location, "100_100", 0);
                 }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayer.java
Patch:
@@ -110,7 +110,7 @@ private void positionBackImage(int height) {
     }
 
     private void positionLogoImage(int height) {
-        if (logoImageView != null) {
+        if (logoImageView != null && logoImageView.getDrawable() != null) {
             LayoutParams layoutParams = (LayoutParams) logoImageView.getLayoutParams();
             if (!AndroidUtilities.isTablet() && getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE) {
                 layoutParams.width = (int)(logoImageView.getDrawable().getIntrinsicWidth() / 1.3f);
@@ -482,7 +482,7 @@ public void onClick(View v) {
     }
 
     public void setBackOverlayVisible(boolean visible) {
-        if (actionOverlay == null) {
+        if (actionOverlay == null || parentFragment == null || parentFragment.parentLayout == null) {
             return;
         }
         isBackOverlayVisible = visible;

File: TMessagesProj/src/main/java/org/telegram/android/ImageLoader.java
Patch:
@@ -551,7 +551,7 @@ public void fileDidLoaded(final String location, final File finalFile, final Fil
                     @Override
                     public void run() {
                         if (location != null) {
-                            if (telegramPath != null && finalFile != null && finalFile.exists() && location.endsWith(".mp4") || location.endsWith(".jpg")) {
+                            if (MediaController.getInstance().canSaveToGallery() && telegramPath != null && finalFile != null && finalFile.exists() && (location.endsWith(".mp4") || location.endsWith(".jpg"))) {
                                 if (finalFile.toString().startsWith(telegramPath.toString())) {
                                     Utilities.addMediaToGallery(finalFile.toString());
                                 }
@@ -624,7 +624,6 @@ private HashMap<Integer, File> createMediaPaths() {
                         File videoPath = new File(telegramPath, LocaleController.getString("AppName", R.string.AppName) + " Video");
                         videoPath.mkdir();
                         if (videoPath.isDirectory()) {
-                            //new File(videoPath, ".nomedia").delete();
                             mediaDirs.put(FileLoader.MEDIA_DIR_VIDEO, videoPath);
                         }
                     } catch (Exception e) {

File: TMessagesProj/src/main/java/org/telegram/ui/ProfileNotificationsActivity.java
Patch:
@@ -183,7 +183,7 @@ public void onClick(DialogInterface dialog, int which) {
                             }
 
                             tmpIntent.putExtra(RingtoneManager.EXTRA_RINGTONE_EXISTING_URI, currentSound);
-                            getParentActivity().startActivityForResult(tmpIntent, 12);
+                            startActivityForResult(tmpIntent, 12);
                         } catch (Exception e) {
                             FileLog.e("tmessages", e);
                         }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
Patch:
@@ -200,7 +200,7 @@ public void onItemClick(AdapterView<?> adapterView, View view, final int i, long
                                 }
                             }
                             tmpIntent.putExtra(RingtoneManager.EXTRA_RINGTONE_EXISTING_URI, currentSound);
-                            getParentActivity().startActivityForResult(tmpIntent, i);
+                            startActivityForResult(tmpIntent, i);
                         } catch (Exception e) {
                             FileLog.e("tmessages", e);
                         }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java
Patch:
@@ -184,11 +184,11 @@ public void onClick(DialogInterface dialogInterface, int i) {
                                             takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, Uri.fromFile(image));
                                             currentPicturePath = image.getAbsolutePath();
                                         }
-                                        getParentActivity().startActivityForResult(takePictureIntent, 10);
+                                        startActivityForResult(takePictureIntent, 10);
                                     } else if (i == 1) {
                                         Intent photoPickerIntent = new Intent(Intent.ACTION_PICK);
                                         photoPickerIntent.setType("image/*");
-                                        getParentActivity().startActivityForResult(photoPickerIntent, 11);
+                                        startActivityForResult(photoPickerIntent, 11);
                                     }
                                 } catch (Exception e) {
                                     FileLog.e("tmessages", e);

File: TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarUpdater.java
Patch:
@@ -61,7 +61,7 @@ public void openCamera() {
                 takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, Uri.fromFile(image));
                 currentPicturePath = image.getAbsolutePath();
             }
-            parentFragment.getParentActivity().startActivityForResult(takePictureIntent, 13);
+            parentFragment.startActivityForResult(takePictureIntent, 13);
         } catch (Exception e) {
             FileLog.e("tmessages", e);
         }
@@ -71,7 +71,7 @@ public void openGallery() {
         try {
             Intent photoPickerIntent = new Intent(Intent.ACTION_GET_CONTENT);
             photoPickerIntent.setType("image/*");
-            parentFragment.getParentActivity().startActivityForResult(photoPickerIntent, 14);
+            parentFragment.startActivityForResult(photoPickerIntent, 14);
         } catch (Exception e) {
             FileLog.e("tmessages", e);
         }

File: TMessagesProj/src/main/java/org/telegram/android/MessageObject.java
Patch:
@@ -417,7 +417,7 @@ public String getFileName() {
         } else if (messageOwner.media instanceof TLRPC.TL_messageMediaPhoto) {
             ArrayList<TLRPC.PhotoSize> sizes = messageOwner.media.photo.sizes;
             if (sizes.size() > 0) {
-                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(sizes, 800, 800);
+                TLRPC.PhotoSize sizeFull = FileLoader.getClosestPhotoSizeWithSize(sizes, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
                 if (sizeFull != null) {
                     return FileLoader.getAttachFileName(sizeFull);
                 }

File: TMessagesProj/src/main/java/org/telegram/android/NotificationCenter.java
Patch:
@@ -40,6 +40,7 @@ public class NotificationCenter {
     public static final int blockedUsersDidLoaded = 28;
     public static final int openedChatChanged = 29;
     public static final int hideEmojiKeyboard = 30;
+    public static final int stopEncodingService = 31;
 
     public static final int wallpapersDidLoaded = 171;
     public static final int closeOtherAppActivities = 702;

File: TMessagesProj/src/main/java/org/telegram/messenger/RPCRequest.java
Patch:
@@ -27,6 +27,7 @@ public interface RPCQuickAckDelegate {
     public static int RPCRequestClassPush = 64;
     public static int RPCRequestClassWithoutLogin = 128;
     public static int RPCRequestClassTryDifferentDc = 256;
+    public static int RPCRequestClassForceDownload = 512;
 
     static int RPCRequestClassTransportMask = (RPCRequestClassGeneric | RPCRequestClassDownloadMedia | RPCRequestClassUploadMedia);
 
@@ -35,6 +36,7 @@ public interface RPCQuickAckDelegate {
 
     int serverFailureCount;
     int flags;
+    boolean wait = false;
     protected int retryCount = 0;
     protected int lastResendTime = 0;
     protected boolean completed = false;

File: TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
Patch:
@@ -445,7 +445,7 @@ public void onClick(View v) {
             TextView messageText = (TextView)view.findViewById(R.id.message_text);
             BackupImageView imageView = (BackupImageView) view.findViewById(R.id.message_image);
             imageView.imageReceiver.setAspectFit(true);
-            PhotoObject currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, 800, 800);
+            PhotoObject currentPhotoObject = PhotoObject.getClosestImageWithSize(messageObject.photoThumbs, AndroidUtilities.getPhotoSize(), AndroidUtilities.getPhotoSize());
             boolean photoSet = false;
             if (currentPhotoObject != null) {
                 boolean photoExist = true;

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
Patch:
@@ -45,8 +45,6 @@
 import org.telegram.messenger.TLRPC;
 import org.telegram.ui.ApplicationLoader;
 
-import java.lang.reflect.Method;
-
 public class ChatActivityEnterView implements NotificationCenter.NotificationCenterDelegate, SizeNotifierRelativeLayout.SizeNotifierRelativeLayoutDelegate {
 
     public static interface ChatActivityEnterViewDelegate {

File: TMessagesProj/src/main/java/org/telegram/ui/Views/TypingDotsDrawable.java
Patch:
@@ -39,6 +39,9 @@ private void update() {
         long newTime = System.currentTimeMillis();
         long dt = newTime - lastUpdateTime;
         lastUpdateTime = newTime;
+        if (dt > 50) {
+            dt = 50;
+        }
 
         for (int a = 0; a < 3; a++) {
             elapsedTimes[a] += dt;

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -1364,7 +1364,7 @@ public void onActivityResultFragment(int requestCode, int resultCode, Intent dat
                     args.putString("videoPath", videoPath);
                     VideoEditorActivity fragment = new VideoEditorActivity(args);
                     fragment.setDelegate(this);
-                    presentFragment(fragment);
+                    presentFragment(fragment, false, true);
                 } else {
                     processSendingVideo(videoPath, 0, 0, 0, 0, null);
                 }

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -629,7 +629,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                     count = info.participants.size();
                 }
 
-                if (count != 0 && onlineCount > 0) {
+                if (count != 0 && onlineCount > 1) {
                     onlineText.setText(Html.fromHtml(String.format("%s, <font color='#357aa8'>%d %s</font>", LocaleController.formatPluralString("Members", count), onlineCount, LocaleController.getString("Online", R.string.Online))));
                 } else {
                     onlineText.setText(LocaleController.formatPluralString("Members", count));

File: TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarUpdater.java
Patch:
@@ -69,7 +69,7 @@ public void openCamera() {
 
     public void openGallery() {
         try {
-            Intent photoPickerIntent = new Intent(Intent.ACTION_PICK);
+            Intent photoPickerIntent = new Intent(Intent.ACTION_GET_CONTENT);
             photoPickerIntent.setType("image/*");
             parentFragment.getParentActivity().startActivityForResult(photoPickerIntent, 14);
         } catch (Exception e) {

File: TMessagesProj/src/main/java/org/telegram/android/ContactsController.java
Patch:
@@ -105,7 +105,7 @@ public ContactsController() {
         try {
             nameDisplayOrder = Settings.System.getInt(ApplicationLoader.applicationContext.getContentResolver(), "android.contacts.DISPLAY_ORDER");
         } catch (Exception e) {
-            FileLog.e("tmessages", e);
+            //don't promt
         }
     }
 

File: TMessagesProj/src/main/java/org/telegram/android/MessagesController.java
Patch:
@@ -2450,7 +2450,7 @@ public void run() {
                                         public void run() {
                                             for (HashMap.Entry<Integer, Integer> entry : corrected.entrySet()) {
                                                 Integer oldId = entry.getKey();
-                                                SendMessagesHelper.getInstance().setMessageSent(oldId);
+                                                SendMessagesHelper.getInstance().processSentMessage(oldId);
                                                 Integer newId = entry.getValue();
                                                 NotificationCenter.getInstance().postNotificationName(NotificationCenter.messageReceivedByServer, oldId, newId, null);
                                             }
@@ -3464,9 +3464,9 @@ protected void updateInterfaceWithMessages(final long uid, final ArrayList<Messa
             } else {
                 MessageObject currentDialogMessage = dialogMessage.get(dialog.top_message);
                 if (currentDialogMessage != null) {
-                    if (currentDialogMessage.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING && lastMessage.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                    if (currentDialogMessage.isSending() && lastMessage.isSending()) {
                         change = true;
-                    } else if (dialog.last_message_date < lastMessage.messageOwner.date || dialog.last_message_date == lastMessage.messageOwner.date && lastMessage.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                    } else if (dialog.last_message_date < lastMessage.messageOwner.date || dialog.last_message_date == lastMessage.messageOwner.date && lastMessage.isSending()) {
                         change = true;
                     }
                 } else {

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
Patch:
@@ -564,17 +564,17 @@ protected void onDraw(Canvas canvas) {
                 boolean drawError = false;
                 boolean isBroadcast = (int)(currentMessageObject.getDialogId() >> 32) == 1;
 
-                if (currentMessageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                if (currentMessageObject.isSending()) {
                     drawCheck1 = false;
                     drawCheck2 = false;
                     drawClock = true;
                     drawError = false;
-                } else if (currentMessageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+                } else if (currentMessageObject.isSendError()) {
                     drawCheck1 = false;
                     drawCheck2 = false;
                     drawClock = false;
                     drawError = true;
-                } else if (currentMessageObject.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENT) {
+                } else if (currentMessageObject.isSent()) {
                     if (!currentMessageObject.isUnread()) {
                         drawCheck1 = true;
                         drawCheck2 = true;

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
Patch:
@@ -528,18 +528,18 @@ public void build(int width, int height) {
                 }
 
                 if (message.isFromMe() && message.isOut()) {
-                    if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENDING) {
+                    if (message.isSending()) {
                         drawCheck1 = false;
                         drawCheck2 = false;
                         drawClock = true;
                         drawError = false;
-                    } else if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+                    } else if (message.isSendError()) {
                         drawCheck1 = false;
                         drawCheck2 = false;
                         drawClock = false;
                         drawError = true;
                         drawCount = false;
-                    } else if (message.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENT) {
+                    } else if (message.isSent()) {
                         if (!message.isUnread()) {
                             drawCheck1 = true;
                             drawCheck2 = true;

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoCropActivity.java
Patch:
@@ -288,6 +288,7 @@ public PhotoCropActivity(Bundle args) {
 
     @Override
     public boolean onFragmentCreate() {
+        swipeBackEnabled = false;
         String photoPath = getArguments().getString("photoPath");
         Uri photoUri = getArguments().getParcelable("photoUri");
         if (photoPath == null && photoUri == null) {

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
Patch:
@@ -645,7 +645,7 @@ public void onClick(View v) {
                         return;
                     }
                     MessageObject obj = imagesArr.get(currentIndex);
-                    if (obj.messageOwner.send_state == MessageObject.MESSAGE_SEND_STATE_SENT) {
+                    if (obj.isSent()) {
                         ArrayList<Integer> arr = new ArrayList<Integer>();
                         arr.add(obj.messageOwner.id);
                         MessagesController.getInstance().deleteMessages(arr, null, null);
@@ -1061,7 +1061,7 @@ private void updateActionOverlays() {
             return;
         }
         if (currentFileName.endsWith("mp4")) {
-            if (currentMessageObject.messageOwner.send_state != MessageObject.MESSAGE_SEND_STATE_SENDING && currentMessageObject.messageOwner.send_state != MessageObject.MESSAGE_SEND_STATE_SEND_ERROR) {
+            if (!currentMessageObject.isSending() && !currentMessageObject.isSendError()) {
                 currentOverlay.setVisibility(View.VISIBLE);
                 boolean load = false;
                 if (currentMessageObject.messageOwner.attachPath != null && currentMessageObject.messageOwner.attachPath.length() != 0) {
@@ -1393,7 +1393,7 @@ private void setIndexToImage(ImageReceiver imageReceiver, int index) {
                         if (currentThumb != null && imageReceiver == centerImage) {
                             placeHolder = currentThumb;
                         }
-                        imageReceiver.setImage(fileLocation, null, placeHolder != null ? new BitmapDrawable(null, placeHolder) : null, size[0]);
+                        imageReceiver.setImage(fileLocation, null, placeHolder != null ? new BitmapDrawable(null, placeHolder) : null, 0);
                     } else {
                         imageReceiver.setImageBitmap(parentActivity.getResources().getDrawable(R.drawable.photoview_placeholder));
                     }

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLoader.java
Patch:
@@ -606,7 +606,7 @@ public static File getPathToAttach(TLObject attach) {
             }
         } else if (attach instanceof TLRPC.PhotoSize) {
             TLRPC.PhotoSize photoSize = (TLRPC.PhotoSize)attach;
-            if (photoSize.location == null || photoSize.location.key != null) {
+            if (photoSize.location == null || photoSize.location.key != null || photoSize.location.volume_id == Integer.MIN_VALUE && photoSize.location.local_id < 0) {
                 dir = getInstance().getDirectory(MEDIA_DIR_CACHE);
             } else {
                 dir = getInstance().getDirectory(MEDIA_DIR_IMAGE);
@@ -620,7 +620,7 @@ public static File getPathToAttach(TLObject attach) {
             }
         } else if (attach instanceof TLRPC.FileLocation) {
             TLRPC.FileLocation fileLocation = (TLRPC.FileLocation)attach;
-            if (fileLocation.key != null) {
+            if (fileLocation.key != null || fileLocation.volume_id == Integer.MIN_VALUE && fileLocation.local_id < 0) {
                 dir = getInstance().getDirectory(MEDIA_DIR_CACHE);
             } else {
                 dir = getInstance().getDirectory(MEDIA_DIR_IMAGE);

File: TMessagesProj/src/main/java/org/telegram/android/MessagesStorage.java
Patch:
@@ -1253,7 +1253,7 @@ public void run() {
                                         if (user.status != null) {
                                             user.status.expires = cursor.intValue(7);
                                         }
-                                        resultArrayNames.add(Html.fromHtml("<font color=\"#00a60e\">" + Utilities.formatName(user.first_name, user.last_name) + "</font>"));
+                                        resultArrayNames.add(Html.fromHtml("<font color=\"#00a60e\">" + ContactsController.formatName(user.first_name, user.last_name) + "</font>"));
                                         resultArray.add(chat);
                                         encUsers.add(user);
                                     }

File: TMessagesProj/src/main/java/org/telegram/android/NativeLoader.java
Patch:
@@ -24,9 +24,9 @@
 public class NativeLoader {
 
     private static final long sizes[] = new long[] {
-            811664,     //armeabi
-            864932,    //armeabi-v7a
-            1262644,    //x86
+            946908,     //armeabi
+            1028848,    //armeabi-v7a
+            1603780,    //x86
             0,          //mips
     };
 

File: TMessagesProj/src/main/java/org/telegram/android/video/Mp4Movie.java
Patch:
@@ -74,8 +74,8 @@ public void addSample(int trackIndex, long offset, MediaCodec.BufferInfo bufferI
         track.addSample(offset, bufferInfo);
     }
 
-    public int addTrack(MediaFormat mediaFormat, boolean isVideo) throws Exception {
-        tracks.add(new Track(tracks.size(), mediaFormat, isVideo));
+    public int addTrack(MediaFormat mediaFormat, boolean isAudio) throws Exception {
+        tracks.add(new Track(tracks.size(), mediaFormat, isAudio));
         return tracks.size() - 1;
     }
 }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
Patch:
@@ -23,7 +23,6 @@
 import org.telegram.messenger.TLRPC;
 import org.telegram.android.MessagesController;
 import org.telegram.messenger.R;
-import org.telegram.messenger.Utilities;
 import org.telegram.android.MessageObject;
 import org.telegram.android.ImageReceiver;
 import org.telegram.ui.Views.ProgressView;
@@ -355,9 +354,9 @@ public void setMessageObject(MessageObject messageObject) {
                 if (audioUser.photo != null) {
                     currentPhoto = audioUser.photo.photo_small;
                 }
-                avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(Utilities.getUserAvatarForId(uid)));
+                avatarImage.setImage(currentPhoto, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)));
             } else {
-                avatarImage.setImage((TLRPC.FileLocation)null, "50_50", getResources().getDrawable(Utilities.getUserAvatarForId(uid)));
+                avatarImage.setImage((TLRPC.FileLocation)null, "50_50", getResources().getDrawable(AndroidUtilities.getUserAvatarForId(uid)));
             }
 
             if (messageObject.isOut()) {

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -641,7 +641,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                     photo = chat.photo.photo_small;
                     photoBig = chat.photo.photo_big;
                 }
-                avatarImage.setImage(photo, "50_50", Utilities.getGroupAvatarForId(chat.id));
+                avatarImage.setImage(photo, "50_50", chat_id > 0 ? AndroidUtilities.getGroupAvatarForId(chat.id) : AndroidUtilities.getBroadcastAvatarForId(chat.id));
                 avatarImage.imageReceiver.setVisible(!PhotoViewer.getInstance().isShowingImage(photoBig), false);
                 return view;
             } else if (type == 1) {

File: TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
Patch:
@@ -29,7 +29,6 @@
 import org.telegram.android.MessagesController;
 import org.telegram.android.NotificationCenter;
 import org.telegram.messenger.R;
-import org.telegram.messenger.Utilities;
 import org.telegram.ui.Views.BackupImageView;
 import org.telegram.ui.Views.ActionBar.BaseFragment;
 
@@ -165,7 +164,7 @@ private void updateAvatarLayout() {
         if (user.photo != null) {
             photo = user.photo.photo_small;
         }
-        avatarImage.setImage(photo, "50_50", Utilities.getUserAvatarForId(user.id));
+        avatarImage.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
     }
 
     public void didReceivedNotification(int id, Object... args) {

File: TMessagesProj/src/main/java/org/telegram/ui/ContactsActivity.java
Patch:
@@ -349,7 +349,7 @@ private void didSelectResult(final TLRPC.User user, boolean useAlert, String par
             }
             AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
             builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
-            builder.setMessage(LocaleController.formatStringSimple(selectAlertString, Utilities.formatName(user.first_name, user.last_name)));
+            builder.setMessage(LocaleController.formatStringSimple(selectAlertString, ContactsController.formatName(user.first_name, user.last_name)));
             final EditText editText = new EditText(getParentActivity());
             if (android.os.Build.VERSION.SDK_INT < 11) {
                 editText.setBackgroundResource(android.R.drawable.editbox_background_normal);

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateActivity.java
Patch:
@@ -332,7 +332,7 @@ public XImageSpan createAndPutChipForUser(TLRPC.User user) {
         LayoutInflater lf = (LayoutInflater)ApplicationLoader.applicationContext.getSystemService(Activity.LAYOUT_INFLATER_SERVICE);
         View textView = lf.inflate(R.layout.group_create_bubble, null);
         TextView text = (TextView)textView.findViewById(R.id.bubble_text_view);
-        String name = Utilities.formatName(user.first_name, user.last_name);
+        String name = ContactsController.formatName(user.first_name, user.last_name);
         if (name.length() == 0 && user.phone != null && user.phone.length() != 0) {
             name = PhoneFormat.getInstance().format("+" + user.phone);
         }
@@ -539,7 +539,7 @@ public View getItemView(int section, int position, View convertView, ViewGroup p
             if (searchWas && searching) {
                 holder.nameTextView.setText(searchResultNames.get(position));
             } else {
-                String name = Utilities.formatName(user.first_name, user.last_name);
+                String name = ContactsController.formatName(user.first_name, user.last_name);
                 if (name.length() == 0) {
                     if (user.phone != null && user.phone.length() != 0) {
                         name = PhoneFormat.getInstance().format("+" + user.phone);
@@ -554,7 +554,7 @@ public View getItemView(int section, int position, View convertView, ViewGroup p
             if (user.photo != null) {
                 photo = user.photo.photo_small;
             }
-            int placeHolderId = Utilities.getUserAvatarForId(user.id);
+            int placeHolderId = AndroidUtilities.getUserAvatarForId(user.id);
             holder.avatarImage.setImage(photo, "50_50", placeHolderId);
 
             holder.messageTextView.setText(LocaleController.formatUserStatus(user));

File: TMessagesProj/src/main/java/org/telegram/ui/LanguageSelectActivity.java
Patch:
@@ -125,7 +125,7 @@ public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
                     }
                     if (localeInfo != null) {
                         LocaleController.getInstance().applyLanguage(localeInfo, true);
-                        getParentActivity().rebuildAllFragmentViews();
+                        parentLayout.rebuildAllFragmentViews(false);
                     }
                     finishFragment();
                 }

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
Patch:
@@ -47,6 +47,7 @@
 import android.widget.TextView;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.android.ContactsController;
 import org.telegram.android.MessagesStorage;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLoader;
@@ -62,7 +63,6 @@
 import org.telegram.android.MessageObject;
 import org.telegram.android.PhotoObject;
 import org.telegram.ui.Views.ActionBar.ActionBar;
-import org.telegram.ui.Views.ActionBar.ActionBarActivity;
 import org.telegram.ui.Views.ActionBar.ActionBarLayer;
 import org.telegram.ui.Views.ActionBar.ActionBarMenu;
 import org.telegram.ui.Views.ActionBar.ActionBarMenuItem;
@@ -521,7 +521,7 @@ public void onItemClick(int id) {
                         closePhoto(false);
                         Bundle args2 = new Bundle();
                         args2.putLong("dialog_id", currentDialogId);
-                        ((ActionBarActivity)parentActivity).presentFragment(new MediaActivity(args2), false, true);
+                        ((LaunchActivity)parentActivity).presentFragment(new MediaActivity(args2), false, true);
                     }
                 } else if (id == gallery_menu_send) {
                     /*Intent intent = new Intent(this, MessagesActivity.class);
@@ -1219,7 +1219,7 @@ public void setImageIndex(int index, boolean init) {
             currentMessageObject = imagesArr.get(currentIndex);
             TLRPC.User user = MessagesController.getInstance().getUser(currentMessageObject.messageOwner.from_id);
             if (user != null) {
-                nameTextView.setText(Utilities.formatName(user.first_name, user.last_name));
+                nameTextView.setText(ContactsController.formatName(user.first_name, user.last_name));
             } else {
                 nameTextView.setText("");
             }

File: TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java
Patch:
@@ -34,7 +34,6 @@
 import org.telegram.android.MessagesStorage;
 import org.telegram.android.NotificationCenter;
 import org.telegram.messenger.R;
-import org.telegram.messenger.Utilities;
 import org.telegram.android.MessageObject;
 import org.telegram.ui.Adapters.BaseFragmentAdapter;
 import org.telegram.ui.Views.ActionBar.ActionBarLayer;
@@ -542,7 +541,7 @@ public void onClick(View view) {
                 Typeface typeface = AndroidUtilities.getTypeface("fonts/rmedium.ttf");
                 textView.setTypeface(typeface);
 
-                textView.setText(Utilities.formatName(user.first_name, user.last_name));
+                textView.setText(ContactsController.formatName(user.first_name, user.last_name));
                 onlineText.setText(LocaleController.formatUserStatus(user));
 
                 TLRPC.FileLocation photo = null;
@@ -551,7 +550,7 @@ public void onClick(View view) {
                     photo = user.photo.photo_small;
                     photoBig = user.photo.photo_big;
                 }
-                avatarImage.setImage(photo, "50_50", Utilities.getUserAvatarForId(user.id));
+                avatarImage.setImage(photo, "50_50", AndroidUtilities.getUserAvatarForId(user.id));
                 avatarImage.imageReceiver.setVisible(!PhotoViewer.getInstance().isShowingImage(photoBig), false);
                 return view;
             } else if (type == 1) {

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBar.java
Patch:
@@ -21,7 +21,6 @@
 
 import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.R;
-import org.telegram.messenger.Utilities;
 
 import java.util.ArrayList;
 
@@ -171,7 +170,7 @@ public void setupAnimations(ArrayList<Animator> animators, boolean back) {
 
     @Override
     protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
-        if (!Utilities.isTablet(getContext()) && getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE) {
+        if (!AndroidUtilities.isTablet() && getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE) {
             super.onMeasure(widthMeasureSpec, MeasureSpec.makeMeasureSpec(AndroidUtilities.dp(40), MeasureSpec.EXACTLY));
         } else {
             super.onMeasure(widthMeasureSpec, MeasureSpec.makeMeasureSpec(AndroidUtilities.dp(48), MeasureSpec.EXACTLY));

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ChatActivityEnterView.java
Patch:
@@ -451,7 +451,7 @@ private void showEmojiPopup(boolean show) {
             }
             emojiPopup.setHeight(View.MeasureSpec.makeMeasureSpec(currentHeight, View.MeasureSpec.EXACTLY));
             if (sizeNotifierRelativeLayout != null) {
-                emojiPopup.setWidth(View.MeasureSpec.makeMeasureSpec(sizeNotifierRelativeLayout.getWidth(), View.MeasureSpec.EXACTLY));
+                emojiPopup.setWidth(View.MeasureSpec.makeMeasureSpec(AndroidUtilities.displaySize.x, View.MeasureSpec.EXACTLY));
             }
 
             emojiPopup.showAtLocation(parentActivity.getWindow().getDecorView(), 83, 0, 0);
@@ -585,7 +585,7 @@ public void onSizeChanged(int height) {
         if (emojiPopup != null && emojiPopup.isShowing()) {
             WindowManager wm = (WindowManager) ApplicationLoader.applicationContext.getSystemService(Context.WINDOW_SERVICE);
             final WindowManager.LayoutParams layoutParams = (WindowManager.LayoutParams)emojiPopup.getContentView().getLayoutParams();
-            layoutParams.width = sizeNotifierRelativeLayout.getWidth();
+            layoutParams.width = AndroidUtilities.displaySize.x;
             if (rotation == Surface.ROTATION_270 || rotation == Surface.ROTATION_90) {
                 layoutParams.height = keyboardHeightLand;
             } else {

File: TMessagesProj/src/main/java/org/telegram/android/NotificationsController.java
Patch:
@@ -447,7 +447,7 @@ private void showOrUpdateNotification(boolean notifyAboutLast) {
                 } else if (needVibrate == 0 || needVibrate == 5) {
                     mBuilder.setDefaults(NotificationCompat.DEFAULT_VIBRATE);
                 } else if (needVibrate == 3) {
-                    mBuilder.setVibrate(new long[]{0, 300, 100, 300});
+                    mBuilder.setVibrate(new long[]{0, 500});
                 }
             } else {
                 mBuilder.setVibrate(new long[]{0, 0});

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -2791,7 +2791,7 @@ private void processSelectedOption(int option) {
                 MediaController.saveFile(fileName, selectedObject.messageOwner.attachPath, getParentActivity(), 1, null);
             } else if (selectedObject.type == 1) {
                 MediaController.saveFile(fileName, selectedObject.messageOwner.attachPath, getParentActivity(), 0, null);
-            } else if (selectedObject.type == 8) {
+            } else if (selectedObject.type == 8 || selectedObject.type == 9) {
                 MediaController.saveFile(fileName, selectedObject.messageOwner.attachPath, getParentActivity(), 2, selectedObject.messageOwner.media.document.file_name);
             }
         } else if (option == 5) {

File: TMessagesProj/src/main/java/org/telegram/messenger/TLRPC.java
Patch:
@@ -8886,7 +8886,6 @@ public static class TL_dialog extends TLObject {
         public int last_message_date;
         public long id;
         public int last_read;
-        public int flags;
 
         public void readParams(AbsSerializedData stream) {
             peer = (Peer)TLClassStore.Instance().TLdeserialize(stream, stream.readInt32());

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -405,6 +405,8 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
                 removeFragmentFromStack(fragmentsStack.get(a));
                 a--;
             }
+            pushOpened = false;
+            isNew = false;
         }
         if (videoPath != null || photoPathsArray != null || sendingText != null || documentsPathsArray != null || contactsToSend != null) {
             NotificationCenter.getInstance().postNotificationName(NotificationCenter.closeChats);

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
Patch:
@@ -2344,7 +2344,7 @@ public boolean onSingleTapConfirmed(MotionEvent e) {
         if (canShowBottom) {
             toggleActionBar(!isActionBarVisible, true);
         } else {
-            checkImageView.callOnClick();
+            checkImageView.performClick();
         }
         return true;
     }

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -547,7 +547,7 @@ public static int getColorForId(int id) {
     }
 
     public static int getUserAvatarForId(int id) {
-        if (id / 1000 == 333) {
+        if (id / 1000 == 333 || id / 1000 == 777) {
             return R.drawable.telegram_avatar;
         }
         return arrUsersAvatars[getColorIndex(id)];

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
Patch:
@@ -60,7 +60,7 @@ public class ChatAudioCell extends ChatBaseCell implements SeekBar.SeekBarDelega
     private String currentNameString;
 
     public ChatAudioCell(Context context) {
-        super(context, false);
+        super(context);
         TAG = MediaController.getInstance().generateObserverTag();
 
         avatarImage = new ImageReceiver(this);

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
Patch:
@@ -146,10 +146,9 @@ public void run() {
         }
     }
 
-    public ChatBaseCell(Context context, boolean isMedia) {
+    public ChatBaseCell(Context context) {
         super(context);
         init();
-        media = isMedia;
         avatarImage = new ImageReceiver(this);
     }
 

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java
Patch:
@@ -29,7 +29,7 @@ public class ChatMessageCell extends ChatBaseCell {
     private int totalVisibleBlocksCount = 0;
 
     public ChatMessageCell(Context context) {
-        super(context, false);
+        super(context);
         drawForwardedName = true;
     }
 

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatOrUserCell.java
Patch:
@@ -405,6 +405,7 @@ public void build(int width, int height) {
             }
             avatarImage.setImageCoords(avatarLeft, avatarTop, AndroidUtilities.dp(50), AndroidUtilities.dp(50));
 
+
             double widthpx = 0;
             float left = 0;
             if (LocaleController.isRTL) {

File: TMessagesProj/src/main/java/org/telegram/messenger/FileUploadOperation.java
Patch:
@@ -218,8 +218,6 @@ private void startUploadRequest() {
                         editor.putString(fileKey + "_key", Utilities.bytesToHex(key));
                     }
                     editor.commit();
-
-                    editor.putString(fileKey + "_key", Utilities.bytesToHex(key));
                 }
 
                 if (isEncrypted) {

File: TMessagesProj/src/main/java/org/telegram/android/ImageReceiver.java
Patch:
@@ -88,14 +88,14 @@ public void setImage(TLRPC.FileLocation fileLocation, String httpUrl, String fil
                 if (currentImage != null) {
                     return;
                 } else {
-                    img = ImageLoader.getInstance().getImageFromMemory(fileLocation, httpUrl, filter);
+                    img = ImageLoader.getInstance().getImageFromMemory(fileLocation, httpUrl, filter, this);
                 }
             } else {
-                img = ImageLoader.getInstance().getImageFromMemory(fileLocation, httpUrl, filter);
+                img = ImageLoader.getInstance().getImageFromMemory(fileLocation, httpUrl, filter, this);
                 recycleBitmap(img);
             }
         }
-        img = ImageLoader.getInstance().getImageFromMemory(fileLocation, httpUrl, filter);
+        img = ImageLoader.getInstance().getImageFromMemory(fileLocation, httpUrl, filter, this);
         currentPath = key;
         last_path = fileLocation;
         last_httpUrl = httpUrl;

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -988,7 +988,6 @@ public static boolean isConnectedToWiFi() {
             }
         } catch(Exception e) {
             FileLog.e("tmessages", e);
-            return true;
         }
         return false;
     }

File: TMessagesProj/src/main/java/org/telegram/android/MediaController.java
Patch:
@@ -382,7 +382,9 @@ public void onReceive(Context context, Intent intent) {
         IntentFilter filter = new IntentFilter(ConnectivityManager.CONNECTIVITY_ACTION);
         ApplicationLoader.applicationContext.registerReceiver(networkStateReceiver, filter);
 
-        checkAutodownloadSettings();
+        if (UserConfig.isClientActivated()) {
+            checkAutodownloadSettings();
+        }
     }
 
     private void startProgressTimer() {

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -354,8 +354,6 @@ public void needSendTyping() {
 
         loading = true;
         MessagesController.getInstance().loadMessages(dialog_id, 30, 0, true, 0, classGuid, true, false);
-        SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
-
         if (currentUser != null) {
             userBlocked = MessagesController.getInstance().blockedUsers.contains(currentUser.id);
         }
@@ -2572,6 +2570,7 @@ public void onPause() {
         }
 
         chatActivityEnterView.setFieldFocused(false);
+        MessagesController.getInstance().cancelTyping(dialog_id);
 
         /*if (currentEncryptedChat != null) { disabled
             chatLeaveTime = System.currentTimeMillis();
@@ -3393,7 +3392,7 @@ public void didPressedImage(ChatMediaCell cell) {
                 ((ChatBaseCell)view).setMessageObject(message);
                 ((ChatBaseCell)view).setCheckPressed(!disableSelection, disableSelection && selected);
                 if (view instanceof ChatAudioCell && MediaController.getInstance().canDownloadMedia(MediaController.AUTODOWNLOAD_MASK_AUDIO)) {
-                    ((ChatAudioCell)view).downloadAudioIfNeed(); //TODO
+                    ((ChatAudioCell)view).downloadAudioIfNeed();
                 }
             } else {
                 ChatListRowHolderEx holder = (ChatListRowHolderEx)view.getTag();

File: TMessagesProj/src/main/java/org/telegram/android/NativeLoader.java
Patch:
@@ -24,8 +24,8 @@
 public class NativeLoader {
 
     private static final long sizes[] = new long[] {
-            799376,     //armeabi
-            852644,     //armeabi-v7a
+            803472,     //armeabi
+            856740,     //armeabi-v7a
             1250356,    //x86
             0,          //mips
     };

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLog.java
Patch:
@@ -63,12 +63,12 @@ public FileLog() {
             e.printStackTrace();
         }
         try {
+            logQueue = new DispatchQueue("logQueue");
             currentFile.createNewFile();
             FileOutputStream stream = new FileOutputStream(currentFile);
             streamWriter = new OutputStreamWriter(stream);
             streamWriter.write("-----start log " + dateFormat.format(System.currentTimeMillis()) + "-----\n");
             streamWriter.flush();
-            logQueue = new DispatchQueue("logQueue");
         } catch (Exception e) {
             e.printStackTrace();
         }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
Patch:
@@ -394,7 +394,7 @@ public void setMessageObject(MessageObject messageObject) {
                     photoHeight = h;
                     backgroundWidth = w + AndroidUtilities.dp(12);
                     currentPhotoFilter = String.format(Locale.US, "%d_%d", (int) (w / AndroidUtilities.density), (int) (h / AndroidUtilities.density));
-                    if (messageObject.photoThumbs.size() > 1) {
+                    if (messageObject.photoThumbs.size() > 1 || messageObject.type == 3 || messageObject.type == 8) {
                         currentPhotoFilter += "_b";
                     }
 

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -291,7 +291,7 @@ public void saveSelfArgs(Bundle args) {
 
     @Override
     public void restoreSelfArgs(Bundle args) {
-        MessagesController.getInstance().loadChatInfo(chat_id);
+        MessagesController.getInstance().loadChatInfo(chat_id, null);
         if (avatarUpdater != null) {
             avatarUpdater.currentPicturePath = args.getString("path");
         }

File: TMessagesProj/src/main/java/org/telegram/ui/PopupNotificationActivity.java
Patch:
@@ -161,7 +161,7 @@ public void onMessageSend() {
                     return;
                 }
                 NotificationsController.getInstance().popupMessages.remove(currentMessageNum);
-                MessagesController.getInstance().markDialogAsRead(currentMessageObject.getDialogId(), currentMessageObject.messageOwner.id, Math.max(0, currentMessageObject.messageOwner.id), 0, currentMessageObject.messageOwner.date, true);
+                MessagesController.getInstance().markDialogAsRead(currentMessageObject.getDialogId(), currentMessageObject.messageOwner.id, Math.max(0, currentMessageObject.messageOwner.id), 0, currentMessageObject.messageOwner.date, true, true);
                 currentMessageObject = null;
                 getNewMessage();
             }

File: TMessagesProj/src/main/java/org/telegram/android/MessagesStorage.java
Patch:
@@ -2009,7 +2009,7 @@ private void putMessagesInternal(final ArrayList<TLRPC.Message> messages, final
                 } else {
                     state.bindInteger(2, dialog_date != 0 ? dialog_date : value.date);
                 }
-                state.bindInteger(3, unread_count);
+                state.bindInteger(3, old_unread_count + unread_count);
                 state.bindInteger(4, messageId);
                 state.step();
             }

File: TMessagesProj/src/main/java/org/telegram/objects/MessageObject.java
Patch:
@@ -380,7 +380,7 @@ public void generateThumbs(boolean update, int preview) {
                         photoThumbs.add(obj);
                     } else if (photoThumbs != null && !photoThumbs.isEmpty() && messageOwner.media.document.thumb != null) {
                         PhotoObject photoObject = photoThumbs.get(0);
-                        photoObject.photoOwner.location = messageOwner.media.video.thumb.location;
+                        photoObject.photoOwner.location = messageOwner.media.document.thumb.location;
                     }
                 }
             }

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -781,6 +781,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
 
                         processRequestQueue(RPCRequest.RPCRequestClassTransportMask, 0);
                     }
+                    MessagesController.getInstance().updateConfig(config);
                 }
                 updatingDcSettings = false;
             }

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -2161,6 +2161,7 @@ public void run() {
                 MessageObject newMsgObj = (MessageObject)args[2];
                 if (newMsgObj != null) {
                     obj.messageOwner.media = newMsgObj.messageOwner.media;
+                    obj.generateThumbs(true, 1);
                 }
                 messagesDict.remove(msgId);
                 messagesDict.put(newMsgId, obj);

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -143,7 +143,8 @@ private void updateRowsIds() {
             membersSectionRow = rowCount++;
             rowCount += info.participants.size();
             membersEndRow = rowCount;
-            if (info.participants.size() < 200) {
+            int maxCount = chat_id > 0 ? MessagesController.getInstance().maxGroupCount : MessagesController.getInstance().maxBroadcastCount;
+            if (info.participants.size() < maxCount) {
                 addMemberRow = rowCount++;
             } else {
                 addMemberRow = -1;

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -1752,7 +1752,7 @@ public void run() {
     }
 
     private void registerForPush() {
-        if (registeringForPush) {
+        if (registeringForPush || !UserConfig.isClientActivated()) {
             return;
         }
         UserConfig.registeredForInternalPush = false;
@@ -1805,6 +1805,8 @@ public void run(TLObject response, TLRPC.TL_error error) {
                         UserConfig.saveConfig(false);
                         saveSession();
                         FileLog.e("tmessages", "registered for internal push");
+                    } else {
+                        UserConfig.registeredForInternalPush = false;
                     }
                     registeringForPush = false;
                 }

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLoader.java
Patch:
@@ -1111,7 +1111,7 @@ public static TLRPC.PhotoSize scaleAndSaveImage(Bitmap bitmap, float maxWidth, f
             return null;
         }
 
-        Bitmap scaledBitmap = Bitmap.createScaledBitmap(bitmap, h, w, true);
+        Bitmap scaledBitmap = Bitmap.createScaledBitmap(bitmap, w, h, true);
 
         TLRPC.TL_fileLocation location = new TLRPC.TL_fileLocation();
         location.volume_id = Integer.MIN_VALUE;

File: TMessagesProj/src/main/java/org/telegram/ui/LoginActivityRegisterView.java
Patch:
@@ -150,10 +150,10 @@ public void run() {
                             final TLRPC.TL_auth_authorization res = (TLRPC.TL_auth_authorization)response;
                             TLRPC.TL_userSelf user = (TLRPC.TL_userSelf)res.user;
                             UserConfig.clearConfig();
-                            MessagesStorage.getInstance().cleanUp();
                             MessagesController.getInstance().cleanUp();
                             UserConfig.setCurrentUser(user);
                             UserConfig.saveConfig(true);
+                            MessagesStorage.getInstance().cleanUp(true);
                             ArrayList<TLRPC.User> users = new ArrayList<TLRPC.User>();
                             users.add(user);
                             MessagesStorage.getInstance().putUsersAndChats(users, null, true, true);

File: TMessagesProj/src/main/java/org/telegram/ui/LoginActivitySmsView.java
Patch:
@@ -260,10 +260,10 @@ public void run() {
                             TLRPC.TL_auth_authorization res = (TLRPC.TL_auth_authorization)response;
                             destroyTimer();
                             UserConfig.clearConfig();
-                            MessagesStorage.getInstance().cleanUp();
                             MessagesController.getInstance().cleanUp();
                             UserConfig.setCurrentUser(res.user);
                             UserConfig.saveConfig(true);
+                            MessagesStorage.getInstance().cleanUp(true);
                             ArrayList<TLRPC.User> users = new ArrayList<TLRPC.User>();
                             users.add(res.user);
                             MessagesStorage.getInstance().putUsersAndChats(users, null, true, true);

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -962,7 +962,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                                     MessagesController.getInstance().unregistedPush();
                                     MessagesController.getInstance().logOut();
                                     UserConfig.clearConfig();
-                                    MessagesStorage.getInstance().cleanUp();
+                                    MessagesStorage.getInstance().cleanUp(false);
                                     MessagesController.getInstance().cleanUp();
                                     ContactsController.getInstance().deleteAllAppAccounts();
                                 }

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionContext.java
Patch:
@@ -74,6 +74,9 @@ public boolean hasMessagesToConfirm() {
     }
 
     public void addMessageToConfirm(long messageId) {
+        if (messagesIdsForConfirmation.contains(messageId)) {
+            return;
+        }
         messagesIdsForConfirmation.add(messageId);
     }
 

File: TMessagesProj/src/main/java/org/telegram/messenger/RPCRequest.java
Patch:
@@ -35,7 +35,9 @@ public interface RPCQuickAckDelegate {
 
     int serverFailureCount;
     int flags;
-    public int retryCount = 0;
+    protected int retryCount = 0;
+    protected int lastResendTime = 0;
+    protected boolean completed = false;
 
     TLObject rawRequest;
     TLObject rpcRequest;

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLoadOperation.java
Patch:
@@ -674,7 +674,7 @@ private void processRequestResult(RequestInfo requestInfo, TLRPC.TL_error error)
                     }
                 }
 
-                if (downloadedBytes % downloadChunkSize == 0 || totalBytesCount > 0 && totalBytesCount > downloadedBytes) {
+                if (totalBytesCount != downloadedBytes && downloadedBytes % downloadChunkSize == 0 || totalBytesCount > 0 && totalBytesCount > downloadedBytes) {
                     startDownloadRequest();
                 } else {
                     onFinishLoadingFile();

File: TMessagesProj/src/main/java/org/telegram/ui/ApplicationLoader.java
Patch:
@@ -30,6 +30,7 @@
 import com.google.android.gms.gcm.GoogleCloudMessaging;
 
 import org.telegram.android.AndroidUtilities;
+import org.telegram.android.ContactsController;
 import org.telegram.android.NotificationsService;
 import org.telegram.messenger.BuildVars;
 import org.telegram.messenger.ConnectionsManager;
@@ -128,6 +129,8 @@ public static void postInitApplication() {
         ApplicationLoader app = (ApplicationLoader)ApplicationLoader.applicationContext;
         app.initPlayServices();
         FileLog.e("tmessages", "app initied");
+
+        ContactsController.getInstance().checkAppAccount();
     }
 
     @Override

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatOrUserCell.java
Patch:
@@ -307,7 +307,7 @@ public void build(int width, int height) {
                 nameString = nameString2.replace("\n", " ");
             }
             if (nameString.length() == 0) {
-                if (user.phone != null && user.phone.length() != 0) {
+                if (user != null && user.phone != null && user.phone.length() != 0) {
                     nameString = PhoneFormat.getInstance().format("+" + user.phone);
                 } else {
                     nameString = LocaleController.getString("HiddenName", R.string.HiddenName);

File: TMessagesProj/src/main/java/org/telegram/ui/LocationActivity.java
Patch:
@@ -133,6 +133,9 @@ public void onItemClick(int id) {
             }
 
             avatarImageView = (BackupImageView)fragmentView.findViewById(R.id.location_avatar_view);
+            if (avatarImageView != null) {
+                avatarImageView.processDetach = false;
+            }
             nameTextView = (TextView)fragmentView.findViewById(R.id.location_name_label);
             distanceTextView = (TextView)fragmentView.findViewById(R.id.location_distance_label);
             View bottomView = fragmentView.findViewById(R.id.location_bottom_view);

File: TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
Patch:
@@ -506,12 +506,12 @@ private void didSelectResult(final long dialog_id, boolean useAlert, final boole
                 builder.setMessage(LocaleController.formatStringSimple(selectAlertString, Utilities.formatName(user.first_name, user.last_name)));
             }
             CheckBox checkBox = null;
-            if (delegate instanceof ChatActivity) {
+            /*if (delegate instanceof ChatActivity) {
                 checkBox = new CheckBox(getParentActivity());
                 checkBox.setText(LocaleController.getString("ForwardFromMyName", R.string.ForwardFromMyName));
                 checkBox.setChecked(false);
                 builder.setView(checkBox);
-            }
+            }*/
             final CheckBox checkBoxFinal = checkBox;
             builder.setPositiveButton(R.string.OK, new DialogInterface.OnClickListener() {
                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -293,7 +293,7 @@ public void onClick(DialogInterface dialog, int which) {
                     } else if (i == notificationRow) {
                         presentFragment(new SettingsNotificationsActivity());
                     } else if (i == blockedRow) {
-                        presentFragment(new SettingsBlockedUsers());
+                        presentFragment(new SettingsBlockedUsersActivity());
                     } else if (i == backgroundRow) {
                         presentFragment(new SettingsWallpapersActivity());
                     } else if (i == askQuestionRow) {

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsersActivity.java
Patch:
@@ -38,7 +38,7 @@
 import java.util.ArrayList;
 import java.util.HashMap;
 
-public class SettingsBlockedUsers extends BaseFragment implements NotificationCenter.NotificationCenterDelegate, ContactsActivity.ContactsActivityDelegate {
+public class SettingsBlockedUsersActivity extends BaseFragment implements NotificationCenter.NotificationCenterDelegate, ContactsActivity.ContactsActivityDelegate {
     private ListView listView;
     private ListAdapter listViewAdapter;
     private boolean loading;
@@ -82,7 +82,7 @@ public void onItemClick(int id) {
                         args.putBoolean("usersAsSections", true);
                         args.putBoolean("returnAsResult", true);
                         ContactsActivity fragment = new ContactsActivity(args);
-                        fragment.setDelegate(SettingsBlockedUsers.this);
+                        fragment.setDelegate(SettingsBlockedUsersActivity.this);
                         presentFragment(fragment);
                     }
                 }

File: TMessagesProj/src/main/java/org/telegram/android/MessagesController.java
Patch:
@@ -1346,9 +1346,9 @@ public void run() {
                             loadingDialogs = false;
                             if (resetEnd) {
                                 dialogsEndReached = false;
-                                NotificationCenter.getInstance().postNotificationName(dialogsNeedReload);
                             }
                             loadDialogs(offset, serverOffset, count, false);
+                            NotificationCenter.getInstance().postNotificationName(dialogsNeedReload);
                         }
                     });
                     return;

File: TMessagesProj/src/main/java/org/telegram/android/MessagesStorage.java
Patch:
@@ -876,7 +876,7 @@ public void run() {
                                 if (arg.startsWith(q)) {
                                     ByteBufferDesc data = buffersStorage.getFreeBuffer(cursor.byteArrayLength(0));
                                     ByteBufferDesc data2 = buffersStorage.getFreeBuffer(cursor.byteArrayLength(6));
-                                    if (data != null && cursor.byteBufferValue(0, data.buffer) != 0 && cursor.byteBufferValue(0, data2.buffer) != 0) {
+                                    if (data != null && cursor.byteBufferValue(0, data.buffer) != 0 && cursor.byteBufferValue(6, data2.buffer) != 0) {
                                         TLRPC.EncryptedChat chat = (TLRPC.EncryptedChat) TLClassStore.Instance().TLdeserialize(data, data.readInt32());
                                         chat.user_id = cursor.intValue(2);
                                         chat.a_or_b = cursor.byteArrayValue(3);

File: TMessagesProj/src/main/java/org/telegram/android/NativeLoader.java
Patch:
@@ -24,9 +24,9 @@
 public class NativeLoader {
 
     private static final long sizes[] = new long[] {
-            795280,     //armeabi
-            844452,     //armeabi-v7a
-            1242164,    //x86
+            799376,     //armeabi
+            848548,     //armeabi-v7a
+            1246260,    //x86
             0,          //mips
     };
 

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -2836,10 +2836,13 @@ private void processForwardFromMe(MessageObject messageObject, long did) {
             if (messageObject.messageOwner.media.photo instanceof TLRPC.TL_photo) {
                 MessagesController.getInstance().sendMessage((TLRPC.TL_photo)messageObject.messageOwner.media.photo, null, did);
             } else if (messageObject.messageOwner.media.audio instanceof TLRPC.TL_audio) {
+                messageObject.messageOwner.media.audio.path = messageObject.messageOwner.attachPath;
                 MessagesController.getInstance().sendMessage((TLRPC.TL_audio)messageObject.messageOwner.media.audio, did);
             } else if (messageObject.messageOwner.media.video instanceof TLRPC.TL_video) {
+                messageObject.messageOwner.media.video.path = messageObject.messageOwner.attachPath;
                 MessagesController.getInstance().sendMessage((TLRPC.TL_video)messageObject.messageOwner.media.video, null, did);
             } else if (messageObject.messageOwner.media.document instanceof TLRPC.TL_document) {
+                messageObject.messageOwner.media.document.path = messageObject.messageOwner.attachPath;
                 MessagesController.getInstance().sendMessage((TLRPC.TL_document)messageObject.messageOwner.media.document, null, did);
             } else if (messageObject.messageOwner.media.geo instanceof TLRPC.TL_geoPoint) {
                 MessagesController.getInstance().sendMessage(messageObject.messageOwner.media.geo.lat, messageObject.messageOwner.media.geo._long, did);

File: TMessagesProj/src/main/java/org/telegram/android/MessagesController.java
Patch:
@@ -1032,7 +1032,7 @@ public void sendTyping(long dialog_id, int classGuid) {
                 public void run(TLObject response, TLRPC.TL_error error) {
 
                 }
-            });
+            }, true, RPCRequest.RPCRequestClassGeneric | RPCRequest.RPCRequestClassFailOnServerErrors);
             ConnectionsManager.getInstance().bindRequestToGuid(reqId, classGuid);
         } else {
             int encId = (int)(dialog_id >> 32);
@@ -1048,7 +1048,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
                     public void run(TLObject response, TLRPC.TL_error error) {
 
                     }
-                });
+                }, true, RPCRequest.RPCRequestClassGeneric | RPCRequest.RPCRequestClassFailOnServerErrors);
                 ConnectionsManager.getInstance().bindRequestToGuid(reqId, classGuid);
             }
         }
@@ -1535,7 +1535,7 @@ public void markDialogAsRead(final long dialog_id, final int max_id, final int m
             req.max_id = max_positive_id;
             req.offset = offset;
             if (offset == 0) {
-                NotificationsController.getInstance().processReadMessages(null, dialog_id, 0, max_id);
+                NotificationsController.getInstance().processReadMessages(null, dialog_id, 0, max_positive_id);
                 MessagesStorage.getInstance().processPendingRead(dialog_id, max_positive_id, max_date, false);
                 MessagesStorage.getInstance().storageQueue.postRunnable(new Runnable() {
                     @Override

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -500,6 +500,7 @@ protected void onPause() {
 
     @Override
     protected void onDestroy() {
+        PhotoViewer.getInstance().destroyPhotoViewer();
         super.onDestroy();
         onFinish();
     }

File: TMessagesProj/src/main/java/org/telegram/android/NotificationsController.java
Patch:
@@ -547,9 +547,9 @@ public void processDialogsUpdateRead(final HashMap<Long, Integer> dialogsToUpdat
         }
         if (old_unread_count != total_unread_count) {
             showOrUpdateNotification(notifyCheck);
-            setBadge(ApplicationLoader.applicationContext, total_unread_count);
             notifyCheck = false;
         }
+        setBadge(ApplicationLoader.applicationContext, total_unread_count);
     }
 
     public void processLoadedUnreadMessages(HashMap<Long, Integer> dialogs) {
@@ -569,6 +569,7 @@ public void processLoadedUnreadMessages(HashMap<Long, Integer> dialogs) {
                 dialogsToLoad += "" + dialog_id;
             }
         }
+        setBadge(ApplicationLoader.applicationContext, total_unread_count);
     }
 
     private void setBadge(Context context, int count) {

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -788,6 +788,7 @@ private TLObject wrapInLayer(TLObject object, int datacenterId, RPCRequest reque
         if (object.layer() > 0) {
             Datacenter datacenter = datacenterWithId(datacenterId);
             if (datacenter == null || datacenter.lastInitVersion != currentAppVersion) {
+                registerForPush();
                 request.initRequest = true;
                 TLRPC.initConnection invoke = new TLRPC.initConnection();
                 invoke.query = object;

File: TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java
Patch:
@@ -218,7 +218,7 @@ public void onClick(View view) {
                         return;
                     }
                     AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
-                    builder.setMessage(LocaleController.getString("AreYouSure", R.string.AreYouSure));
+                    builder.setMessage(LocaleController.getString("AreYouSureSecretChat", R.string.AreYouSureSecretChat));
                     builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
                     builder.setPositiveButton(LocaleController.getString("OK", R.string.OK), new DialogInterface.OnClickListener() {
                         @Override

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -258,8 +258,8 @@ public void onItemClick(AdapterView<?> adapterView, View view, final int i, long
     }
 
     @Override
-    public void didSelectContact(TLRPC.User user) {
-        MessagesController.getInstance().addUserToChat(chat_id, user, info);
+    public void didSelectContact(TLRPC.User user, String param) {
+        MessagesController.getInstance().addUserToChat(chat_id, user, info, Utilities.parseInt(param));
     }
 
     @Override
@@ -680,7 +680,7 @@ public void onClick(View view) {
                                 return;
                             }
                             AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
-                            builder.setMessage(LocaleController.getString("AreYouSure", R.string.AreYouSure));
+                            builder.setMessage(LocaleController.getString("AreYouSureDeleteAndExit", R.string.AreYouSureDeleteAndExit));
                             builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
                             builder.setPositiveButton(LocaleController.getString("OK", R.string.OK), new DialogInterface.OnClickListener() {
                                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -413,7 +413,7 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
             NotificationCenter.getInstance().postNotificationName(MessagesController.closeChats);
             Bundle args = new Bundle();
             args.putBoolean("onlySelect", true);
-            args.putString("selectAlertString", LocaleController.getString("ForwardMessagesTo", R.string.ForwardMessagesTo));
+            args.putString("selectAlertString", LocaleController.getString("SendMessagesTo", R.string.SendMessagesTo));
             MessagesActivity fragment = new MessagesActivity(args);
             fragment.setDelegate(this);
             presentFragment(fragment, false, true);
@@ -437,7 +437,7 @@ protected void onNewIntent(Intent intent) {
     }
 
     @Override
-    public void didSelectDialog(MessagesActivity messageFragment, long dialog_id) {
+    public void didSelectDialog(MessagesActivity messageFragment, long dialog_id, boolean param) {
         if (dialog_id != 0) {
             int lower_part = (int)dialog_id;
 

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -334,7 +334,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                             return;
                         }
                         AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
-                        builder.setMessage(LocaleController.getString("AreYouSure", R.string.AreYouSure));
+                        builder.setMessage(LocaleController.getString("AreYouSureSessions", R.string.AreYouSureSessions));
                         builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
                         builder.setPositiveButton(LocaleController.getString("OK", R.string.OK), new DialogInterface.OnClickListener() {
                             @Override
@@ -950,7 +950,7 @@ public void onClick(View view) {
                                 return;
                             }
                             AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
-                            builder.setMessage(LocaleController.getString("AreYouSure", R.string.AreYouSure));
+                            builder.setMessage(LocaleController.getString("AreYouSureLogout", R.string.AreYouSureLogout));
                             builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
                             builder.setPositiveButton(LocaleController.getString("OK", R.string.OK), new DialogInterface.OnClickListener() {
                                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsers.java
Patch:
@@ -256,7 +256,7 @@ public void onResume() {
     }
 
     @Override
-    public void didSelectContact(TLRPC.User user) {
+    public void didSelectContact(TLRPC.User user, String param) {
         if (user == null || blockedContactsDict.containsKey(user.id)) {
             return;
         }

File: TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java
Patch:
@@ -140,7 +140,7 @@ public void onItemClick(int id) {
                         finishFragment();
                     } else if (id == block_contact) {
                         AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
-                        builder.setMessage(LocaleController.getString("AreYouSure", R.string.AreYouSure));
+                        builder.setMessage(LocaleController.getString("AreYouSureBlockContact", R.string.AreYouSureBlockContact));
                         builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
                         builder.setPositiveButton(LocaleController.getString("OK", R.string.OK), new DialogInterface.OnClickListener() {
                             @Override
@@ -186,7 +186,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
                             return;
                         }
                         AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
-                        builder.setMessage(LocaleController.getString("AreYouSure", R.string.AreYouSure));
+                        builder.setMessage(LocaleController.getString("AreYouSureDeleteContact", R.string.AreYouSureDeleteContact));
                         builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
                         builder.setPositiveButton(LocaleController.getString("OK", R.string.OK), new DialogInterface.OnClickListener() {
                             @Override
@@ -445,7 +445,7 @@ private void createActionBarMenu() {
     }
 
     @Override
-    public void didSelectDialog(MessagesActivity messageFragment, long dialog_id) {
+    public void didSelectDialog(MessagesActivity messageFragment, long dialog_id, boolean param) {
         if (dialog_id != 0) {
             Bundle args = new Bundle();
             args.putBoolean("scrollToTopOnResume", true);

File: TMessagesProj/src/main/java/org/telegram/android/AppStartReceiver.java
Patch:
@@ -6,12 +6,13 @@
  * Copyright Nikolai Kudashov, 2013-2014.
  */
 
-package org.telegram.messenger;
+package org.telegram.android;
 
 import android.content.BroadcastReceiver;
 import android.content.Context;
 import android.content.Intent;
 
+import org.telegram.messenger.Utilities;
 import org.telegram.ui.ApplicationLoader;
 
 public class AppStartReceiver extends BroadcastReceiver {

File: TMessagesProj/src/main/java/org/telegram/android/AuthenticatorService.java
Patch:
@@ -6,7 +6,7 @@
  * Copyright Nikolai Kudashov, 2013.
  */
 
-package org.telegram.messenger;
+package org.telegram.android;
 
 import android.accounts.AbstractAccountAuthenticator;
 import android.accounts.Account;

File: TMessagesProj/src/main/java/org/telegram/android/ContactsSyncAdapterService.java
Patch:
@@ -6,7 +6,7 @@
  * Copyright Nikolai Kudashov, 2013.
  */
 
-package org.telegram.messenger;
+package org.telegram.android;
 
 import android.accounts.Account;
 import android.accounts.OperationCanceledException;
@@ -19,6 +19,8 @@
 import android.os.Bundle;
 import android.os.IBinder;
 
+import org.telegram.messenger.FileLog;
+
 public class ContactsSyncAdapterService extends Service {
     private static SyncAdapterImpl sSyncAdapter = null;
 

File: TMessagesProj/src/main/java/org/telegram/android/FastDateFormat.java
Patch:
@@ -5,7 +5,7 @@
  *
  * Copyright Nikolai Kudashov, 2013.
  */
-package org.telegram.messenger;
+package org.telegram.android;
 
 import java.io.IOException;
 import java.io.ObjectInputStream;

File: TMessagesProj/src/main/java/org/telegram/android/NativeLoader.java
Patch:
@@ -6,12 +6,14 @@
  * Copyright Nikolai Kudashov, 2013-2014.
  */
 
-package org.telegram.messenger;
+package org.telegram.android;
 
 import android.content.Context;
 import android.content.pm.ApplicationInfo;
 import android.os.Build;
 
+import org.telegram.messenger.FileLog;
+
 import java.io.File;
 import java.io.FileOutputStream;
 import java.io.InputStream;

File: TMessagesProj/src/main/java/org/telegram/android/NotificationsService.java
Patch:
@@ -6,13 +6,14 @@
  * Copyright Nikolai Kudashov, 2013-2014.
  */
 
-package org.telegram.messenger;
+package org.telegram.android;
 
 import android.app.Service;
 import android.content.Intent;
 import android.content.SharedPreferences;
 import android.os.IBinder;
 
+import org.telegram.messenger.FileLog;
 import org.telegram.ui.ApplicationLoader;
 
 public class NotificationsService extends Service {

File: TMessagesProj/src/main/java/org/telegram/messenger/Action.java
Patch:
@@ -25,6 +25,4 @@ public void execute(HashMap params) {
     public void cancel() {
 
     }
-
-    public int state;
 }

File: TMessagesProj/src/main/java/org/telegram/messenger/ExportAuthorizationAction.java
Patch:
@@ -54,7 +54,7 @@ public void run() {
                     }
                 }
             }
-        }, null, true, RPCRequest.RPCRequestClassGeneric);
+        });
     }
 
     void beginImport() {

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLog.java
Patch:
@@ -11,6 +11,7 @@
 import android.net.Uri;
 import android.util.Log;
 
+import org.telegram.android.FastDateFormat;
 import org.telegram.ui.ApplicationLoader;
 
 import java.io.File;

File: TMessagesProj/src/main/java/org/telegram/messenger/UserConfig.java
Patch:
@@ -12,6 +12,7 @@
 import android.content.SharedPreferences;
 import android.util.Base64;
 
+import org.telegram.android.MessagesStorage;
 import org.telegram.ui.ApplicationLoader;
 
 import java.io.File;
@@ -197,6 +198,5 @@ public static void clearConfig() {
         contactsVersion = 1;
         saveIncomingPhotos = false;
         saveConfig(true);
-        MessagesController.getInstance().deleteAllAppAccounts();
     }
 }

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/ContactsActivityAdapter.java
Patch:
@@ -14,10 +14,10 @@
 import android.view.ViewGroup;
 import android.widget.TextView;
 
-import org.telegram.messenger.LocaleController;
+import org.telegram.android.LocaleController;
 import org.telegram.messenger.TLRPC;
-import org.telegram.messenger.ContactsController;
-import org.telegram.messenger.MessagesController;
+import org.telegram.android.ContactsController;
+import org.telegram.android.MessagesController;
 import org.telegram.messenger.R;
 import org.telegram.ui.Cells.ChatOrUserCell;
 import org.telegram.ui.Views.SectionedBaseAdapter;

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/ContactsActivitySearchAdapter.java
Patch:
@@ -13,9 +13,9 @@
 import android.view.ViewGroup;
 
 import org.telegram.messenger.TLRPC;
-import org.telegram.messenger.ContactsController;
+import org.telegram.android.ContactsController;
 import org.telegram.messenger.FileLog;
-import org.telegram.messenger.MessagesController;
+import org.telegram.android.MessagesController;
 import org.telegram.messenger.UserConfig;
 import org.telegram.messenger.Utilities;
 import org.telegram.ui.Cells.ChatOrUserCell;

File: TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
Patch:
@@ -24,7 +24,7 @@
 import android.widget.TextView;
 
 import org.telegram.messenger.FileLog;
-import org.telegram.messenger.LocaleController;
+import org.telegram.android.LocaleController;
 import org.telegram.messenger.R;
 import org.telegram.messenger.Utilities;
 import org.telegram.ui.Adapters.BaseFragmentAdapter;

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
Patch:
@@ -22,11 +22,11 @@
 import android.widget.TextView;
 
 import org.telegram.messenger.ConnectionsManager;
-import org.telegram.messenger.LocaleController;
-import org.telegram.messenger.MessagesStorage;
+import org.telegram.android.LocaleController;
+import org.telegram.android.MessagesStorage;
 import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.FileLog;
-import org.telegram.messenger.MessagesController;
+import org.telegram.android.MessagesController;
 import org.telegram.messenger.NotificationCenter;
 import org.telegram.messenger.R;
 import org.telegram.messenger.Utilities;

File: TMessagesProj/src/main/java/org/telegram/ui/IntroActivity.java
Patch:
@@ -24,7 +24,7 @@
 import android.widget.ImageView;
 import android.widget.TextView;
 
-import org.telegram.messenger.LocaleController;
+import org.telegram.android.LocaleController;
 import org.telegram.messenger.R;
 import org.telegram.messenger.Utilities;
 

File: TMessagesProj/src/main/java/org/telegram/ui/LocationActivity.java
Patch:
@@ -26,10 +26,10 @@
 import com.google.android.gms.maps.model.MarkerOptions;
 
 import org.telegram.messenger.FileLog;
-import org.telegram.messenger.LocaleController;
+import org.telegram.android.LocaleController;
 import org.telegram.messenger.TLRPC;
 import org.telegram.objects.MessageObject;
-import org.telegram.messenger.MessagesController;
+import org.telegram.android.MessagesController;
 import org.telegram.messenger.NotificationCenter;
 import org.telegram.messenger.R;
 import org.telegram.messenger.Utilities;

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenu.java
Patch:
@@ -16,7 +16,7 @@
 import android.widget.ImageView;
 import android.widget.LinearLayout;
 
-import org.telegram.messenger.Utilities;
+import org.telegram.android.AndroidUtilities;
 
 public class ActionBarMenu extends LinearLayout {
 
@@ -68,7 +68,7 @@ public ActionBarMenuItem addItem(int id, int icon) {
         addView(menuItem);
         LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)menuItem.getLayoutParams();
         layoutParams.height = FrameLayout.LayoutParams.MATCH_PARENT;
-        layoutParams.width = Utilities.dp(56);
+        layoutParams.width = AndroidUtilities.dp(56);
         menuItem.setLayoutParams(layoutParams);
         menuItem.setOnClickListener(new OnClickListener() {
             @Override

File: TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarUpdater.java
Patch:
@@ -15,6 +15,7 @@
 import android.os.Bundle;
 import android.provider.MediaStore;
 
+import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.FileLoader;
 import org.telegram.messenger.FileLog;
@@ -126,7 +127,7 @@ private void processBitmap(Bitmap bitmap) {
                 }
             } else {
                 UserConfig.saveConfig(false);
-                uploadingAvatar = Utilities.getCacheDir() + "/" + bigPhoto.location.volume_id + "_" + bigPhoto.location.local_id + ".jpg";
+                uploadingAvatar = AndroidUtilities.getCacheDir() + "/" + bigPhoto.location.volume_id + "_" + bigPhoto.location.local_id + ".jpg";
                 NotificationCenter.getInstance().addObserver(AvatarUpdater.this, FileLoader.FileDidUpload);
                 NotificationCenter.getInstance().addObserver(AvatarUpdater.this, FileLoader.FileDidFailUpload);
                 FileLoader.getInstance().uploadFile(uploadingAvatar, false);

File: TMessagesProj/src/main/java/org/telegram/ui/Views/BackupImageView.java
Patch:
@@ -18,8 +18,6 @@
 
 import org.telegram.messenger.TLRPC;
 
-import java.lang.ref.WeakReference;
-
 public class BackupImageView extends View {
     public ImageReceiver imageReceiver;
     public boolean processDetach = true;

File: TMessagesProj/src/main/java/org/telegram/ui/Views/MessageActionLayout.java
Patch:
@@ -10,8 +10,8 @@
 
 import android.widget.FrameLayout;
 
+import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.R;
-import org.telegram.messenger.Utilities;
 
 public class MessageActionLayout extends FrameLayout {
     public TightTextView messageTextView;
@@ -31,7 +31,7 @@ public MessageActionLayout(android.content.Context context, android.util.Attribu
     @Override
     protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
         super.onMeasure(widthMeasureSpec, heightMeasureSpec);
-        setMeasuredDimension(messageTextView.linesMaxWidth + Utilities.dp(14), getMeasuredHeight());
+        setMeasuredDimension(messageTextView.linesMaxWidth + AndroidUtilities.dp(14), getMeasuredHeight());
     }
 
     @Override

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ProgressView.java
Patch:
@@ -11,7 +11,7 @@
 import android.graphics.Canvas;
 import android.graphics.Paint;
 
-import org.telegram.messenger.Utilities;
+import org.telegram.android.AndroidUtilities;
 
 public class ProgressView {
     private Paint innerPaint;
@@ -20,7 +20,7 @@ public class ProgressView {
     public float currentProgress = 0;
     public int width;
     public int height;
-    public float progressHeight = Utilities.dpf(2.0f);
+    public float progressHeight = AndroidUtilities.dpf(2.0f);
 
     public ProgressView() {
         innerPaint = new Paint();

File: TMessagesProj/src/main/java/org/telegram/ui/Views/SeekBar.java
Patch:
@@ -14,8 +14,8 @@
 import android.graphics.drawable.Drawable;
 import android.view.MotionEvent;
 
+import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.R;
-import org.telegram.messenger.Utilities;
 
 public class SeekBar {
 
@@ -121,8 +121,8 @@ public void draw(Canvas canvas) {
             outer = outerPaint2;
         }
         int y = (height - thumbHeight) / 2;
-        canvas.drawRect(thumbWidth / 2, height / 2 - Utilities.dp(1), width - thumbWidth / 2, height / 2 + Utilities.dp(1), inner);
-        canvas.drawRect(thumbWidth / 2, height / 2 - Utilities.dp(1), thumbWidth / 2 + thumbX, height / 2 + Utilities.dp(1), outer);
+        canvas.drawRect(thumbWidth / 2, height / 2 - AndroidUtilities.dp(1), width - thumbWidth / 2, height / 2 + AndroidUtilities.dp(1), inner);
+        canvas.drawRect(thumbWidth / 2, height / 2 - AndroidUtilities.dp(1), thumbWidth / 2 + thumbX, height / 2 + AndroidUtilities.dp(1), outer);
         thumb.setBounds(thumbX, y, thumbX + thumbWidth, y + thumbHeight);
         thumb.draw(canvas);
     }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/TimerButton.java
Patch:
@@ -19,9 +19,9 @@
 import android.util.AttributeSet;
 import android.view.View;
 
+import org.telegram.android.AndroidUtilities;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.R;
-import org.telegram.messenger.Utilities;
 
 public class TimerButton extends View {
 
@@ -38,7 +38,7 @@ private void init() {
             emptyTimerDrawable = getResources().getDrawable(R.drawable.header_timer);
             timerDrawable = getResources().getDrawable(R.drawable.header_timer2);
             timePaint = new TextPaint(Paint.ANTI_ALIAS_FLAG);
-            timePaint.setTextSize(Utilities.dp(10));
+            timePaint.setTextSize(AndroidUtilities.dp(10));
             timePaint.setColor(0xffd7e8f7);
             timePaint.setTypeface(Typeface.DEFAULT_BOLD);
         }
@@ -110,7 +110,7 @@ protected void onDraw(Canvas canvas) {
         drawable.draw(canvas);
 
         if (time != 0 && timeLayout != null) {
-            canvas.translate((width - timeWidth) / 2, (height - timeHeight) / 2 + Utilities.dp(1));
+            canvas.translate((width - timeWidth) / 2, (height - timeHeight) / 2 + AndroidUtilities.dp(1));
             timeLayout.draw(canvas);
         }
     }

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -1514,7 +1514,7 @@ private void updateSubtitle() {
         if (currentChat != null) {
             actionBarLayer.setTitle(currentChat.title);
         } else if (currentUser != null) {
-            if (currentUser.id / 1000 != 777 || currentUser.id / 1000 != 333 && ContactsController.getInstance().contactsDict.get(currentUser.id) == null && (ContactsController.getInstance().contactsDict.size() != 0 || !ContactsController.getInstance().isLoadingContacts())) {
+            if (currentUser.id / 1000 != 777 && currentUser.id / 1000 != 333 && ContactsController.getInstance().contactsDict.get(currentUser.id) == null && (ContactsController.getInstance().contactsDict.size() != 0 || !ContactsController.getInstance().isLoadingContacts())) {
                 if (currentUser.phone != null && currentUser.phone.length() != 0) {
                     actionBarLayer.setTitle(PhoneFormat.getInstance().format("+" + currentUser.phone));
                 } else {

File: TMessagesProj/src/main/java/org/telegram/messenger/MediaController.java
Patch:
@@ -1024,7 +1024,7 @@ public void onCompletion(MediaPlayer mediaPlayer) {
             fileDecodingQueue.postRunnable(new Runnable() {
                 @Override
                 public void run() {
-                    if (playingMessageObject.audioProgress != 0) {
+                    if (playingMessageObject != null && playingMessageObject.audioProgress != 0) {
                         lastPlayPcm = (long)(currentTotalPcmDuration * playingMessageObject.audioProgress);
                         seekOpusFile(playingMessageObject.audioProgress);
                     }

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesController.java
Patch:
@@ -3093,7 +3093,7 @@ public void registerForPush(final String regid) {
             }
             req.system_version = "SDK " + Build.VERSION.SDK_INT;
             PackageInfo pInfo = ApplicationLoader.applicationContext.getPackageManager().getPackageInfo(ApplicationLoader.applicationContext.getPackageName(), 0);
-            req.app_version = pInfo.versionName;
+            req.app_version = pInfo.versionName + " (" + pInfo.versionCode + ")";
             if (req.app_version == null) {
                 req.app_version = "App version unknown";
             }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
Patch:
@@ -546,7 +546,7 @@ public void build(int width, int height) {
             if (chat != null) {
                 nameString = chat.title;
             } else if (user != null) {
-                if (user.id / 1000 != 333 && ContactsController.getInstance().contactsDict.get(user.id) == null) {
+                if (user.id / 1000 != 777 && user.id / 1000 != 333 && ContactsController.getInstance().contactsDict.get(user.id) == null) {
                     if (ContactsController.getInstance().contactsDict.size() == 0 && (!ContactsController.getInstance().contactsLoaded || ContactsController.getInstance().isLoadingContacts())) {
                         nameString = Utilities.formatName(user.first_name, user.last_name);
                     } else {

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -535,7 +535,7 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {
     @Override
     protected void onPause() {
         super.onPause();
-        ApplicationLoader.lastPauseTime = System.currentTimeMillis();
+        ConnectionsManager.setAppPaused(true);
         if (notificationView != null) {
             notificationView.hide(false);
         }
@@ -559,7 +559,7 @@ protected void onResume() {
         }
         Utilities.checkForCrashes(this);
         Utilities.checkForUpdates(this);
-        ApplicationLoader.resetLastPauseTime();
+        ConnectionsManager.setAppPaused(false);
         actionBar.setBackOverlayVisible(currentConnectionState != 0);
         try {
             NotificationManager mNotificationManager = (NotificationManager)this.getSystemService(Context.NOTIFICATION_SERVICE);

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -2584,10 +2584,11 @@ public void run() {
     public void tcpConnectionConnected(TcpConnection connection) {
         Datacenter datacenter = datacenterWithId(connection.getDatacenterId());
         if (datacenter.authKey != null) {
-            processRequestQueue(connection.transportRequestClass, connection.getDatacenterId());
             if ((connection.transportRequestClass & RPCRequest.RPCRequestClassPush) != 0) {
                 sendingPushPing = false;
                 lastPushPingTime = System.currentTimeMillis() - 60000 * 3 + 10000;
+            } else {
+                processRequestQueue(connection.transportRequestClass, connection.getDatacenterId());
             }
         }
     }

File: TMessagesProj/src/main/java/org/telegram/messenger/ScreenReceiver.java
Patch:
@@ -19,9 +19,11 @@ public class ScreenReceiver extends BroadcastReceiver {
     public void onReceive(Context context, Intent intent) {
         if (intent.getAction().equals(Intent.ACTION_SCREEN_OFF)) {
             FileLog.e("tmessages", "screen off");
+            ApplicationLoader.lastPauseTime = System.currentTimeMillis();
             ApplicationLoader.isScreenOn = false;
         } else if (intent.getAction().equals(Intent.ACTION_SCREEN_ON)) {
             FileLog.e("tmessages", "screen on");
+            ApplicationLoader.resetLastPauseTime();
             ApplicationLoader.isScreenOn = true;
         }
     }

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoCropActivity.java
Patch:
@@ -100,6 +100,9 @@ public boolean onTouch(View view, MotionEvent motionEvent) {
                         } else {
                             draggingState = 0;
                         }
+                        if (draggingState != 0) {
+                            PhotoCropView.this.requestDisallowInterceptTouchEvent(true);
+                        }
                         oldX = x;
                         oldY = y;
                     } else if (motionEvent.getAction() == MotionEvent.ACTION_UP) {

File: TMessagesProj/src/main/java/org/telegram/messenger/TcpConnection.java
Patch:
@@ -135,7 +135,7 @@ public void run() {
                     client.addListener(TcpConnection.this);
                     if ((transportRequestClass & RPCRequest.RPCRequestClassPush) != 0) {
                         if (isNextPort) {
-                            client.setTimeout(15000);
+                            client.setTimeout(20000);
                         } else {
                             client.setTimeout(30000);
                         }
@@ -424,7 +424,7 @@ public void run() {
                 datacenter.storeCurrentAddressAndPortNum();
                 isNextPort = false;
                 if ((transportRequestClass & RPCRequest.RPCRequestClassPush) != 0) {
-                    client.setTimeout(40000);
+                    client.setTimeout(60000 * 3 + 20000);
                 } else {
                     client.setTimeout(25000);
                 }

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -747,6 +747,9 @@ public static int getGroupAvatarForId(int id) {
     }
 
     public static String MD5(String md5) {
+        if (md5 == null) {
+            return null;
+        }
         try {
             java.security.MessageDigest md = java.security.MessageDigest.getInstance("MD5");
             byte[] array = md.digest(md5.getBytes());

File: TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
Patch:
@@ -102,6 +102,7 @@ public void onClick(View view) {
 
             onlineText = (TextView)fragmentView.findViewById(R.id.settings_online);
             avatarImage = (BackupImageView)fragmentView.findViewById(R.id.settings_avatar_image);
+            avatarImage.processDetach = false;
             phoneText = (TextView)fragmentView.findViewById(R.id.settings_name);
             Typeface typeface = Utilities.getTypeface("fonts/rmedium.ttf");
             phoneText.setTypeface(typeface);

File: TMessagesProj/src/main/java/org/telegram/ui/CountrySelectActivity.java
Patch:
@@ -85,7 +85,7 @@ public boolean onFragmentCreate() {
                 }
                 arr.add(c);
             }
-            reader.close();//TODO
+            reader.close();
             stream.close();
         } catch (Exception e) {
             FileLog.e("tmessages", e);

File: TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
Patch:
@@ -45,7 +45,7 @@
 public class DocumentSelectActivity extends BaseFragment {
 
     public static abstract interface DocumentSelectActivityDelegate {
-        public void didSelectFile(DocumentSelectActivity activity, String path, String name, String ext, long size);
+        public void didSelectFile(DocumentSelectActivity activity, String path);
         public void startDocumentSelectActivity();
     }
 
@@ -186,7 +186,7 @@ public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
                             return;
                         }
                         if (delegate != null) {
-                            delegate.didSelectFile(DocumentSelectActivity.this, file.getAbsolutePath(), item.title, item.ext, file.length());
+                            delegate.didSelectFile(DocumentSelectActivity.this, file.getAbsolutePath());
                         }
                     }
                 }

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -498,14 +498,14 @@ public void didSelectDialog(MessagesActivity messageFragment, long dialog_id) {
                 fragment.processSendingText(sendingText);
             }
             if (documentPath != null) {
-                fragment.processSendingDocument(documentPath);
+                fragment.processSendingDocument(documentPath, null);
             }
             if (imagesPathArray != null) {
                 fragment.processSendingPhotos(null, imagesPathArray);
             }
             if (documentsPathArray != null) {
                 for (String path : documentsPathArray) {
-                    fragment.processSendingDocument(path);
+                    fragment.processSendingDocument(path, null);
                 }
             }
             if (contactsToSend != null && !contactsToSend.isEmpty()) {

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarLayer.java
Patch:
@@ -377,7 +377,7 @@ public void hideActionMode() {
         }
         actionMode.setVisibility(GONE);
         if (backButtonFrameLayout != null) {
-            backButtonFrameLayout.setVisibility(VISIBLE);
+            backButtonFrameLayout.setVisibility(isSearchFieldVisible || actionOverlay == null || actionOverlay.getVisibility() == GONE ? VISIBLE : INVISIBLE);
         }
         if (menu != null) {
             menu.setVisibility(VISIBLE);
@@ -471,10 +471,10 @@ public void setBackOverlayVisible(boolean visible) {
             return;
         }
         isBackOverlayVisible = visible;
-        positionBackOverlay(getMeasuredWidth(), getMeasuredHeight());
         if (visible) {
             ((ActionBarActivity)getContext()).onOverlayShow(actionOverlay, parentFragment);
         }
+        positionBackOverlay(getMeasuredWidth(), getMeasuredHeight());
     }
 
     private void positionBackOverlay(int widthMeasureSpec, int heightMeasureSpec) {

File: TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarUpdater.java
Patch:
@@ -129,7 +129,7 @@ private void processBitmap(Bitmap bitmap) {
                 uploadingAvatar = Utilities.getCacheDir() + "/" + bigPhoto.location.volume_id + "_" + bigPhoto.location.local_id + ".jpg";
                 NotificationCenter.getInstance().addObserver(AvatarUpdater.this, FileLoader.FileDidUpload);
                 NotificationCenter.getInstance().addObserver(AvatarUpdater.this, FileLoader.FileDidFailUpload);
-                FileLoader.getInstance().uploadFile(uploadingAvatar, null, null);
+                FileLoader.getInstance().uploadFile(uploadingAvatar, null, false);
             }
         }
     }

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -17,7 +17,6 @@
 import android.content.pm.ActivityInfo;
 import android.content.res.Configuration;
 import android.database.Cursor;
-import android.graphics.Bitmap;
 import android.graphics.Point;
 import android.graphics.Typeface;
 import android.net.Uri;
@@ -156,7 +155,7 @@ public static class TPFactorizedValue {
     public native static long doPQNative(long _what);
     public native static byte[] aesIgeEncryption(byte[] _what, byte[] _key, byte[] _iv, boolean encrypt, boolean changeIv, int len);
     public native static void aesIgeEncryption2(ByteBuffer _what, byte[] _key, byte[] _iv, boolean encrypt, boolean changeIv, int len);
-    public native static void loadBitmap(String path, Bitmap bitmap, int scale);
+    public native static void loadBitmap(String path, int[] bitmap, int scale, int format, int width, int height);
 
     public static void lockOrientation(Activity activity) {
         if (prevOrientation != -10) {

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -2335,9 +2335,7 @@ public void run() {
                         dayArr.remove(obj);
                         if (dayArr.isEmpty()) {
                             messagesByDays.remove(obj.dateKey);
-                            if (index != -1) {
-                                messages.remove(index);
-                            }
+                            messages.remove(index);
                         }
                         updated = true;
                     }

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
Patch:
@@ -208,6 +208,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
             });
 
             avatarImage = (BackupImageView)fragmentView.findViewById(R.id.settings_avatar_image);
+            avatarImage.setImageResource(R.drawable.group_blue);
 
             nameTextView = (EditText)fragmentView.findViewById(R.id.bubble_input_text);
             nameTextView.setHint(LocaleController.getString("EnterGroupNamePlaceholder", R.string.EnterGroupNamePlaceholder));
@@ -304,7 +305,7 @@ public void run() {
                     }
                     Bundle args2 = new Bundle();
                     args2.putInt("chat_id", (Integer)args[0]);
-                    presentFragment(new ChatActivity(args2));
+                    presentFragment(new ChatActivity(args2), true);
                 }
             });
         }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/EmojiView.java
Patch:
@@ -232,11 +232,11 @@ public void onMeasure(int paramAnonymousInt1, int paramAnonymousInt2) {
                     }
                 };
                 localObject.setOnClickListener(new View.OnClickListener() {
-                    public void onClick(View paramAnonymousView) {
+                    public void onClick(View view) {
                         if (EmojiView.this.listener != null) {
-                            EmojiView.this.listener.onEmojiSelected(EmojiView.this.convert((Long)paramAnonymousView.getTag()));
+                            EmojiView.this.listener.onEmojiSelected(EmojiView.this.convert((Long)view.getTag()));
                         }
-                        EmojiView.this.addToRecent((Long)paramAnonymousView.getTag());
+                        EmojiView.this.addToRecent((Long)view.getTag());
                     }
                 });
                 localObject.setBackgroundResource(R.drawable.list_selector);

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLog.java
Patch:
@@ -110,7 +110,7 @@ public void run() {
         }
     }
 
-    public static void e(final String tag, final Exception e) {
+    public static void e(final String tag, final Throwable e) {
         if (!BuildVars.DEBUG_VERSION) {
             return;
         }

File: TMessagesProj/src/main/java/org/telegram/messenger/MediaController.java
Patch:
@@ -1536,7 +1536,7 @@ public static boolean isGif(Uri uri) {
         return false;
     }
 
-    public static String copyDocumentToCache(Uri uri) {
+    public static String copyDocumentToCache(Uri uri, String ext) {
         ParcelFileDescriptor parcelFD = null;
         FileInputStream input = null;
         FileOutputStream output = null;
@@ -1545,7 +1545,7 @@ public static String copyDocumentToCache(Uri uri) {
             UserConfig.lastLocalId--;
             parcelFD = ApplicationLoader.applicationContext.getContentResolver().openFileDescriptor(uri, "r");
             input = new FileInputStream(parcelFD.getFileDescriptor());
-            File f = new File(Utilities.getCacheDir(), String.format(Locale.US, "%d.gif", id));
+            File f = new File(Utilities.getCacheDir(), String.format(Locale.US, "%d.%s", id, ext));
             output = new FileOutputStream(f);
             input.getChannel().transferTo(0, input.getChannel().size(), output.getChannel());
             UserConfig.saveConfig(false);

File: TMessagesProj/src/main/java/org/telegram/ui/ApplicationLoader.java
Patch:
@@ -21,6 +21,7 @@
 import android.content.pm.PackageManager;
 import android.content.res.Configuration;
 import android.graphics.Bitmap;
+import android.graphics.drawable.Drawable;
 import android.os.AsyncTask;
 import android.os.Handler;
 import android.os.PowerManager;
@@ -53,7 +54,7 @@ public class ApplicationLoader extends Application {
     private static final String PROPERTY_APP_VERSION = "appVersion";
     private static final int PLAY_SERVICES_RESOLUTION_REQUEST = 9000;
     public static long lastPauseTime;
-    public static Bitmap cachedWallpaper = null;
+    public static Drawable cachedWallpaper = null;
 
     public static volatile Context applicationContext = null;
     public static volatile Handler applicationHandler = null;

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatBaseCell.java
Patch:
@@ -233,7 +233,7 @@ protected boolean isUserDataChanged() {
 
         newUser = MessagesController.getInstance().users.get(currentMessageObject.messageOwner.fwd_from_id);
         newNameString = null;
-        if (drawForwardedName && currentMessageObject.messageOwner instanceof TLRPC.TL_messageForwarded) {
+        if (newUser != null && drawForwardedName && currentMessageObject.messageOwner instanceof TLRPC.TL_messageForwarded) {
             newNameString = Utilities.formatName(newUser.first_name, newUser.last_name);
         }
         return currentForwardNameString == null && newNameString != null || currentForwardNameString != null && newNameString == null || currentForwardNameString != null && newNameString != null && !currentForwardNameString.equals(newNameString);

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
Patch:
@@ -176,7 +176,9 @@ public void onClick(DialogInterface dialog, int which) {
             button2.setOnClickListener(new View.OnClickListener() {
                 @Override
                 public void onClick(View view) {
-
+                    if (getParentActivity() == null) {
+                        return;
+                    }
                     AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
 
                     CharSequence[] items;

File: TMessagesProj/src/main/java/org/telegram/ui/LanguageSelectActivity.java
Patch:
@@ -143,7 +143,7 @@ public boolean onItemLongClick(AdapterView<?> adapterView, View view, int i, lon
                             localeInfo = LocaleController.getInstance().sortedLanguages.get(i);
                         }
                     }
-                    if (localeInfo == null || localeInfo.pathToFile == null) {
+                    if (localeInfo == null || localeInfo.pathToFile == null || getParentActivity() == null) {
                         return false;
                     }
                     final LocaleController.LocaleInfo finalLocaleInfo = localeInfo;

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -280,7 +280,7 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
                             } else if (tempPath == null) {
                                 isGif = MediaController.isGif(uri);
                                 if (isGif) {
-                                    documentPath = MediaController.copyDocumentToCache(uri);
+                                    documentPath = MediaController.copyDocumentToCache(uri, "gif");
                                 }
                             }
                             if (!isGif || documentPath == null) {
@@ -325,7 +325,7 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
                                     } else if (tempPath == null) {
                                         isGif = MediaController.isGif(uri);
                                         if (isGif) {
-                                            tempPath = MediaController.copyDocumentToCache(uri);
+                                            tempPath = MediaController.copyDocumentToCache(uri, "gif");
                                         }
                                     }
                                     if (isGif && tempPath != null) {

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsers.java
Patch:
@@ -120,7 +120,7 @@ public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
             listView.setOnItemLongClickListener(new AdapterView.OnItemLongClickListener() {
                 @Override
                 public boolean onItemLongClick(AdapterView<?> adapterView, View view, int i, long l) {
-                    if (i >= blockedContacts.size()) {
+                    if (i >= blockedContacts.size() || getParentActivity() == null) {
                         return true;
                     }
                     selectedUserId = blockedContacts.get(i).user_id;

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java
Patch:
@@ -158,6 +158,9 @@ public void onClick(View view) {
                 @Override
                 public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
                     if (i == 0) {
+                        if (getParentActivity() == null) {
+                            return;
+                        }
                         AlertDialog.Builder builder = new AlertDialog.Builder(getParentActivity());
 
                         CharSequence[] items = new CharSequence[] {LocaleController.getString("FromCamera", R.string.FromCamera), LocaleController.getString("FromGalley", R.string.FromGalley), LocaleController.getString("Cancel", R.string.Cancel)};

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java
Patch:
@@ -196,9 +196,9 @@ public void onLowMemory() {
 
     }
 
-    protected boolean showAlertDialog(AlertDialog.Builder builder) {
+    protected void showAlertDialog(AlertDialog.Builder builder) {
         if (parentActivity == null || parentActivity.checkTransitionAnimation() || parentActivity.animationInProgress || parentActivity.startedTracking) {
-            return false;
+            return;
         }
         try {
             if (visibleDialog != null) {
@@ -216,6 +216,5 @@ public void onDismiss(DialogInterface dialog) {
                 visibleDialog = null;
             }
         });
-        return true;
     }
 }

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesController.java
Patch:
@@ -4529,7 +4529,6 @@ private void showInAppNotification(MessageObject messageObject) {
             notification.ledOnMS = 1000;
             notification.ledOffMS = 1000;
             if (needVibrate) {
-                notification.defaults = Notification.DEFAULT_VIBRATE;
                 notification.vibrate = new long[]{0, 100, 0, 100};
             } else {
                 notification.vibrate = new long[]{0, 0};

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -2859,7 +2859,7 @@ private View getRowParentView(View v) {
     }
 
     public void createMenu(View v, boolean single) {
-        if (actionBarLayer.isActionModeShowed()) {
+        if (getParentActivity() == null || actionBarLayer.isActionModeShowed()) {
             return;
         }
 

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
Patch:
@@ -128,13 +128,12 @@ public void toggleSubMenu() {
             popupWindow.setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED);
             popupLayout.measure(MeasureSpec.makeMeasureSpec(Utilities.dp(1000), MeasureSpec.AT_MOST), MeasureSpec.makeMeasureSpec(Utilities.dp(1000), MeasureSpec.AT_MOST));
         }
+        popupWindow.setFocusable(true);
         if (popupLayout.getMeasuredWidth() == 0) {
             popupWindow.showAsDropDown(this, parentActionBar.getMeasuredWidth() - popupLayout.getMeasuredWidth() - getLeft() - parentMenu.getLeft(), 0);
             popupWindow.update(this, parentActionBar.getMeasuredWidth() - popupLayout.getMeasuredWidth() - getLeft() - parentMenu.getLeft(), 0, -1, -1);
-            popupWindow.setFocusable(true);
         } else {
             popupWindow.showAsDropDown(this, parentActionBar.getMeasuredWidth() - popupLayout.getMeasuredWidth() - getLeft() - parentMenu.getLeft(), 0);
-            popupWindow.setFocusable(true);
         }
     }
 

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoPickerActivity.java
Patch:
@@ -107,7 +107,7 @@ public void onItemClick(int id) {
                         }
                     } else if (id == 1) {
                         if (delegate != null) {
-                            finishFragment();
+                            finishFragment(false);
                             delegate.startPhotoSelectActivity();
                         }
                     }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
Patch:
@@ -121,7 +121,6 @@ public void toggleSubMenu() {
         }
         if (popupWindow == null) {
             popupWindow = new ActionBarPopupWindow(popupLayout, FrameLayout.LayoutParams.WRAP_CONTENT, FrameLayout.LayoutParams.WRAP_CONTENT);
-            popupWindow.setFocusable(true);
             popupWindow.setBackgroundDrawable(new BitmapDrawable());
             popupWindow.setOutsideTouchable(true);
             popupWindow.setClippingEnabled(true);
@@ -132,8 +131,10 @@ public void toggleSubMenu() {
         if (popupLayout.getMeasuredWidth() == 0) {
             popupWindow.showAsDropDown(this, parentActionBar.getMeasuredWidth() - popupLayout.getMeasuredWidth() - getLeft() - parentMenu.getLeft(), 0);
             popupWindow.update(this, parentActionBar.getMeasuredWidth() - popupLayout.getMeasuredWidth() - getLeft() - parentMenu.getLeft(), 0, -1, -1);
+            popupWindow.setFocusable(true);
         } else {
             popupWindow.showAsDropDown(this, parentActionBar.getMeasuredWidth() - popupLayout.getMeasuredWidth() - getLeft() - parentMenu.getLeft(), 0);
+            popupWindow.setFocusable(true);
         }
     }
 

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarPopupWindow.java
Patch:
@@ -152,6 +152,7 @@ public void showAtLocation(View parent, int gravity, int x, int y) {
 
     @Override
     public void dismiss() {
+        setFocusable(false);
         super.dismiss();
         unregisterListener();
     }

File: TMessagesProj/src/main/java/org/telegram/messenger/ExportAuthorizationAction.java
Patch:
@@ -85,6 +85,6 @@ public void run() {
                     }
                 }
             }
-        }, null, true, RPCRequest.RPCRequestClassGeneric | RPCRequest.RPCRequestClassEnableUnauthorized, datacenter.datacenterId);
+        }, null, true, RPCRequest.RPCRequestClassGeneric | RPCRequest.RPCRequestClassEnableUnauthorized | RPCRequest.RPCRequestClassWithoutLogin, datacenter.datacenterId);
     }
 }

File: TMessagesProj/src/main/java/org/telegram/messenger/HandshakeAction.java
Patch:
@@ -209,7 +209,7 @@ void processMessage(TLObject message, long messageId) {
                 ByteBuffer data = ByteBuffer.wrap(resPq.pq);
                 final long pqf = data.getLong();
                 final long messageIdf = messageId;
-                Utilities.globalQueue.postRunnable(new Runnable() {
+                new Thread(new Runnable() {
                     @Override
                     public void run() {
 
@@ -281,7 +281,7 @@ public void run() {
                             }
                         });
                     }
-                });
+                }).start();
             } else {
                 FileLog.e("tmessages", "***** Error: invalid handshake nonce");
                 beginHandshake(false);

File: TMessagesProj/src/main/java/org/telegram/messenger/MediaController.java
Patch:
@@ -1143,7 +1143,7 @@ public void run() {
                 recordingAudio = new TLRPC.TL_audio();
                 recordingAudio.dc_id = Integer.MIN_VALUE;
                 recordingAudio.id = UserConfig.lastLocalId;
-                recordingAudio.user_id = UserConfig.clientUserId;
+                recordingAudio.user_id = UserConfig.getClientUserId();
                 UserConfig.lastLocalId--;
                 UserConfig.saveConfig(false);
 
@@ -1352,7 +1352,7 @@ public static void saveFile(String path, String fullPath, Context context, final
 
             final ProgressDialog finalProgress = progressDialog;
 
-            Utilities.globalQueue.postRunnable(new Runnable() {
+            new Thread(new Runnable() {
                 @Override
                 public void run() {
                     try {
@@ -1427,7 +1427,7 @@ public void run() {
                         });
                     }
                 }
-            });
+            }).start();
         }
     }
 

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesStorage.java
Patch:
@@ -781,7 +781,7 @@ public void run() {
                                 if (userData != null) {
                                     SerializedData data = new SerializedData(userData);
                                     TLRPC.User user = (TLRPC.User)TLClassStore.Instance().TLdeserialize(data, data.readInt32());
-                                    if (user.id == UserConfig.clientUserId) {
+                                    if (user.id == UserConfig.getClientUserId()) {
                                         continue;
                                     }
                                     if (user.status != null) {
@@ -1018,7 +1018,7 @@ public void run() {
                     String uids = "";
                     while (cursor.next()) {
                         int user_id = cursor.intValue(0);
-                        if (user_id == UserConfig.clientUserId) {
+                        if (user_id == UserConfig.getClientUserId()) {
                             continue;
                         }
                         TLRPC.TL_contact contact = new TLRPC.TL_contact();
@@ -2484,7 +2484,7 @@ public void run() {
                 ArrayList<TLRPC.EncryptedChat> encryptedChats = new ArrayList<TLRPC.EncryptedChat>();
                 try {
                     ArrayList<Integer> usersToLoad = new ArrayList<Integer>();
-                    usersToLoad.add(UserConfig.clientUserId);
+                    usersToLoad.add(UserConfig.getClientUserId());
                     ArrayList<Integer> chatsToLoad = new ArrayList<Integer>();
                     ArrayList<Integer> encryptedToLoad = new ArrayList<Integer>();
                     SQLiteCursor cursor = database.queryFinalized(String.format(Locale.US, "SELECT d.did, d.last_mid, d.unread_count, d.date, m.data, m.read_state, m.mid, m.send_state FROM dialogs as d LEFT JOIN messages as m ON d.last_mid = m.mid ORDER BY d.date DESC LIMIT %d,%d", offset, count));

File: TMessagesProj/src/main/java/org/telegram/messenger/RPCRequest.java
Patch:
@@ -28,6 +28,7 @@ public interface RPCQuickAckDelegate {
     public static int RPCRequestClassFailOnServerErrors = 16;
     public static int RPCRequestClassCanCompress = 32;
     public static int RPCRequestClassPush = 64;
+    public static int RPCRequestClassWithoutLogin = 128;
 
     static int RPCRequestClassTransportMask = (RPCRequestClassGeneric | RPCRequestClassDownloadMedia | RPCRequestClassUploadMedia);
 

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -87,6 +87,8 @@ public static class TPFactorizedValue {
 
     public static volatile DispatchQueue stageQueue = new DispatchQueue("stageQueue");
     public static volatile DispatchQueue globalQueue = new DispatchQueue("globalQueue");
+    public static volatile DispatchQueue searchQueue = new DispatchQueue("searchQueue");
+    public static volatile DispatchQueue photoBookQueue = new DispatchQueue("photoBookQueue");
 
     public static int[] arrColors = {0xffee4928, 0xff41a903, 0xffe09602, 0xff0f94ed, 0xff8f3bf7, 0xfffc4380, 0xff00a1c4, 0xffeb7002};
     public static int[] arrUsersAvatars = {
@@ -668,7 +670,7 @@ public static int getColorIndex(int id) {
         try {
             String str;
             if (id >= 0) {
-                str = String.format(Locale.US, "%d%d", id, UserConfig.clientUserId);
+                str = String.format(Locale.US, "%d%d", id, UserConfig.getClientUserId());
             } else {
                 str = String.format(Locale.US, "%d", id);
             }

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/ContactsActivitySearchAdapter.java
Patch:
@@ -72,7 +72,7 @@ private void processSearch(final String query) {
             public void run() {
                 final ArrayList<TLRPC.TL_contact> contactsCopy = new ArrayList<TLRPC.TL_contact>();
                 contactsCopy.addAll(ContactsController.getInstance().contacts);
-                Utilities.globalQueue.postRunnable(new Runnable() {
+                Utilities.searchQueue.postRunnable(new Runnable() {
                     @Override
                     public void run() {
                         String q = query.trim().toLowerCase();
@@ -87,7 +87,7 @@ public void run() {
                         for (TLRPC.TL_contact contact : contactsCopy) {
                             TLRPC.User user = MessagesController.getInstance().users.get(contact.user_id);
                             if (user.first_name != null && user.first_name.toLowerCase().startsWith(q) || user.last_name != null && user.last_name.toLowerCase().startsWith(q)) {
-                                if (user.id == UserConfig.clientUserId) {
+                                if (user.id == UserConfig.getClientUserId()) {
                                     continue;
                                 }
                                 resultArrayNames.add(Utilities.generateSearchName(user.first_name, user.last_name, q));

File: TMessagesProj/src/main/java/org/telegram/ui/ApplicationLoader.java
Patch:
@@ -93,7 +93,7 @@ public static void postInitApplication() {
         }
 
         UserConfig.loadConfig();
-        if (UserConfig.currentUser != null) {
+        if (UserConfig.getCurrentUser() != null) {
             boolean changed = false;
             SharedPreferences preferences = applicationContext.getSharedPreferences("Notifications", MODE_PRIVATE);
             int v = preferences.getInt("v", 0);
@@ -122,8 +122,8 @@ public static void postInitApplication() {
                 editor.commit();
             }
 
-            MessagesController.getInstance().users.put(UserConfig.clientUserId, UserConfig.currentUser);
-            ConnectionsManager.getInstance().applyCountryPortNumber(UserConfig.currentUser.phone);
+            MessagesController.getInstance().users.put(UserConfig.getClientUserId(), UserConfig.getCurrentUser());
+            ConnectionsManager.getInstance().applyCountryPortNumber(UserConfig.getCurrentUser().phone);
             ConnectionsManager.getInstance().initPushConnection();
         }
 

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
Patch:
@@ -423,7 +423,7 @@ public void build(int width, int height) {
                         } else if (encryptedChat instanceof TLRPC.TL_encryptedChatDiscarded) {
                             messageString = LocaleController.getString("EncryptionRejected", R.string.EncryptionRejected);
                         } else if (encryptedChat instanceof TLRPC.TL_encryptedChat) {
-                            if (encryptedChat.admin_id == UserConfig.clientUserId) {
+                            if (encryptedChat.admin_id == UserConfig.getClientUserId()) {
                                 if (user != null && user.first_name != null) {
                                     messageString = LocaleController.formatString("EncryptedChatStartedOutgoing", R.string.EncryptedChatStartedOutgoing, user.first_name);
                                 } else {
@@ -547,7 +547,7 @@ public void build(int width, int height) {
                 nameString = chat.title;
             } else if (user != null) {
                 if (user.id / 1000 != 333 && ContactsController.getInstance().contactsDict.get(user.id) == null) {
-                    if (ContactsController.getInstance().contactsDict.size() == 0 && (!ContactsController.getInstance().contactsLoaded || ContactsController.getInstance().loadingContacts)) {
+                    if (ContactsController.getInstance().contactsDict.size() == 0 && (!ContactsController.getInstance().contactsLoaded || ContactsController.getInstance().isLoadingContacts())) {
                         nameString = Utilities.formatName(user.first_name, user.last_name);
                     } else {
                         if (user.phone != null && user.phone.length() != 0) {

File: TMessagesProj/src/main/java/org/telegram/ui/ContactsActivity.java
Patch:
@@ -205,7 +205,7 @@ public void onTextChanged(EditText editText) {
                 public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
                     if (searching && searchWas) {
                         TLRPC.User user = searchListViewAdapter.getItem(i);
-                        if (user == null || user.id == UserConfig.clientUserId) {
+                        if (user == null || user.id == UserConfig.getClientUserId()) {
                             return;
                         }
                         if (returnAsResult) {
@@ -263,7 +263,7 @@ public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
                         }
 
                         if (user != null) {
-                            if (user.id == UserConfig.clientUserId) {
+                            if (user.id == UserConfig.getClientUserId()) {
                                 return;
                             }
                             if (returnAsResult) {

File: TMessagesProj/src/main/java/org/telegram/ui/CountrySelectActivity.java
Patch:
@@ -280,7 +280,7 @@ public void run() {
     }
 
     private void processSearch(final String query) {
-        Utilities.globalQueue.postRunnable(new Runnable() {
+        Utilities.searchQueue.postRunnable(new Runnable() {
             @Override
             public void run() {
 

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateActivity.java
Patch:
@@ -382,7 +382,7 @@ private void processSearch(final String query) {
             public void run() {
                 final ArrayList<TLRPC.TL_contact> contactsCopy = new ArrayList<TLRPC.TL_contact>();
                 contactsCopy.addAll(ContactsController.getInstance().contacts);
-                Utilities.globalQueue.postRunnable(new Runnable() {
+                Utilities.searchQueue.postRunnable(new Runnable() {
                     @Override
                     public void run() {
                         if (query.length() == 0) {
@@ -397,7 +397,7 @@ public void run() {
                         for (TLRPC.TL_contact contact : contactsCopy) {
                             TLRPC.User user = MessagesController.getInstance().users.get(contact.user_id);
                             if (user.first_name.toLowerCase().startsWith(q) || user.last_name.toLowerCase().startsWith(q)) {
-                                if (user.id == UserConfig.clientUserId) {
+                                if (user.id == UserConfig.getClientUserId()) {
                                     continue;
                                 }
                                 resultArrayNames.add(Utilities.generateSearchName(user.first_name, user.last_name, q));

File: TMessagesProj/src/main/java/org/telegram/ui/LanguageSelectActivity.java
Patch:
@@ -232,7 +232,7 @@ public void run() {
     }
 
     private void processSearch(final String query) {
-        Utilities.globalQueue.postRunnable(new Runnable() {
+        Utilities.searchQueue.postRunnable(new Runnable() {
             @Override
             public void run() {
 

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -64,7 +64,7 @@ public class LaunchActivity extends ActionBarActivity implements NotificationCen
     protected void onCreate(Bundle savedInstanceState) {
         ApplicationLoader.postInitApplication();
 
-        if (!UserConfig.clientActivated) {
+        if (!UserConfig.isClientActivated()) {
             Intent intent = getIntent();
             if (intent != null && intent.getAction() != null && (Intent.ACTION_SEND.equals(intent.getAction()) || intent.getAction().equals(Intent.ACTION_SEND_MULTIPLE))) {
                 super.onCreateFinish(savedInstanceState);
@@ -101,7 +101,7 @@ protected void onCreate(Bundle savedInstanceState) {
         NotificationCenter.getInstance().addObserver(this, 703);
 
         if (fragmentsStack.isEmpty()) {
-            if (!UserConfig.clientActivated) {
+            if (!UserConfig.isClientActivated()) {
                 addFragmentToStack(new LoginActivity());
             } else {
                 addFragmentToStack(new MessagesActivity(null));
@@ -417,7 +417,7 @@ private void handleIntent(Intent intent, boolean isNew, boolean restore) {
         }
 
         if (push_user_id != 0) {
-            if (push_user_id == UserConfig.clientUserId) {
+            if (push_user_id == UserConfig.getClientUserId()) {
                 open_settings = 1;
             } else {
                 Bundle args = new Bundle();

File: TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
Patch:
@@ -324,7 +324,7 @@ public void onClick(DialogInterface dialog, int which) {
                                 if (which == 0) {
                                     MessagesController.getInstance().deleteDialog(selectedDialog, 0, true);
                                 } else if (which == 1) {
-                                    MessagesController.getInstance().deleteUserFromChat((int) -selectedDialog, MessagesController.getInstance().users.get(UserConfig.clientUserId), null);
+                                    MessagesController.getInstance().deleteUserFromChat((int) -selectedDialog, MessagesController.getInstance().users.get(UserConfig.getClientUserId()), null);
                                     MessagesController.getInstance().deleteDialog(selectedDialog, 0, false);
                                 }
                             }

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoViewer.java
Patch:
@@ -1038,7 +1038,7 @@ private void onPhotoShow(final MessageObject messageObject, final TLRPC.FileLoca
                     if (messageObject.messageOwner.to_id.chat_id != 0) {
                         currentDialogId = -messageObject.messageOwner.to_id.chat_id;
                     } else {
-                        if (messageObject.messageOwner.to_id.user_id == UserConfig.clientUserId) {
+                        if (messageObject.messageOwner.to_id.user_id == UserConfig.getClientUserId()) {
                             currentDialogId = messageObject.messageOwner.from_id;
                         } else {
                             currentDialogId = messageObject.messageOwner.to_id.user_id;
@@ -1076,7 +1076,7 @@ private void onPhotoShow(final MessageObject messageObject, final TLRPC.FileLoca
                 if (messageObject.messageOwner.to_id.chat_id != 0) {
                     currentDialogId = -messageObject.messageOwner.to_id.chat_id;
                 } else {
-                    if (messageObject.messageOwner.to_id.user_id == UserConfig.clientUserId) {
+                    if (messageObject.messageOwner.to_id.user_id == UserConfig.getClientUserId()) {
                         currentDialogId = messageObject.messageOwner.from_id;
                     } else {
                         currentDialogId = messageObject.messageOwner.to_id.user_id;

File: TMessagesProj/src/main/java/org/telegram/messenger/MediaController.java
Patch:
@@ -949,6 +949,7 @@ public void run() {
                     currentTotalPcmDuration = getTotalPcmDuration();
 
                     audioTrackPlayer = new AudioTrack(AudioManager.STREAM_MUSIC, 48000, AudioFormat.CHANNEL_OUT_MONO, AudioFormat.ENCODING_PCM_16BIT, playerBufferSize, AudioTrack.MODE_STREAM);
+                    audioTrackPlayer.setStereoVolume(1.0f, 1.0f);
                     //audioTrackPlayer.setNotificationMarkerPosition((int)currentTotalPcmDuration);
                     audioTrackPlayer.setPlaybackPositionUpdateListener(new AudioTrack.OnPlaybackPositionUpdateListener() {
                         @Override
@@ -1606,7 +1607,7 @@ public void run() {
                             long dateTaken = cursor.getLong(dateColumn);
                             int orientation = cursor.getInt(orientationColumn);
 
-                            if (path == null || path.isEmpty()) {
+                            if (path == null || path.length() == 0) {
                                 continue;
                             }
 

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
Patch:
@@ -127,6 +127,7 @@ public void toggleSubMenu() {
             popupWindow.setClippingEnabled(true);
             popupWindow.setInputMethodMode(ActionBarPopupWindow.INPUT_METHOD_NOT_NEEDED);
             popupWindow.setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED);
+            popupLayout.measure(MeasureSpec.makeMeasureSpec(Utilities.dp(1000), MeasureSpec.AT_MOST), MeasureSpec.makeMeasureSpec(Utilities.dp(1000), MeasureSpec.AT_MOST));
         }
         if (popupLayout.getMeasuredWidth() == 0) {
             popupWindow.showAsDropDown(this, parentActionBar.getMeasuredWidth() - popupLayout.getMeasuredWidth() - getLeft() - parentMenu.getLeft(), 0);

File: TMessagesProj/src/main/java/org/telegram/messenger/FileLoadOperation.java
Patch:
@@ -12,6 +12,7 @@
 import android.graphics.BitmapFactory;
 import android.os.Build;
 import android.provider.MediaStore;
+import android.util.Log;
 
 import org.telegram.ui.ApplicationLoader;
 
@@ -265,7 +266,7 @@ public void run() {
                             }
                             opts.inDither = false;
                             if (mediaIdFinal != null) {
-                                image = MediaStore.Images.Thumbnails.getThumbnail(ApplicationLoader.applicationContext.getContentResolver(), mediaIdFinal, MediaStore.Images.Thumbnails.MINI_KIND, opts);
+                                image = MediaStore.Images.Thumbnails.getThumbnail(ApplicationLoader.applicationContext.getContentResolver(), mediaIdFinal, MediaStore.Images.Thumbnails.MINI_KIND, null);
                             }
                             if (image == null) {
                                 FileInputStream is = new FileInputStream(cacheFileFinal);
@@ -277,7 +278,7 @@ public void run() {
                                    cacheFileFinal.delete();
                                 }
                             } else {
-                                if (filter != null && image != null) {
+                                if (filter != null) {
                                     float bitmapW = image.getWidth();
                                     float bitmapH = image.getHeight();
                                     if (bitmapW != w_filter && bitmapW > w_filter) {

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
Patch:
@@ -65,7 +65,7 @@ public ChatAudioCell(Context context) {
         TAG = MediaController.getInstance().generateObserverTag();
 
         avatarImage = new ImageReceiver();
-        avatarImage.parentView = new WeakReference<View>(this);
+        avatarImage.parentView = this;
         seekBar = new SeekBar(context);
         seekBar.delegate = this;
         progressView = new ProgressView();

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
Patch:
@@ -102,7 +102,7 @@ public ChatMediaCell(Context context) {
         TAG = MediaController.getInstance().generateObserverTag();
 
         photoImage = new ImageReceiver();
-        photoImage.parentView = new WeakReference<View>(this);
+        photoImage.parentView = this;
         progressView = new ProgressView();
         progressView.setProgressColors(0x802a2a2a, 0xffffffff);
     }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatOrUserCell.java
Patch:
@@ -97,7 +97,7 @@ private void init() {
 
         if (avatarImage == null) {
             avatarImage = new ImageReceiver();
-            avatarImage.parentView = new WeakReference<View>(this);
+            avatarImage.parentView = this;
         }
 
         if (cellLayout == null) {

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -501,9 +501,7 @@ public void didSelectDialog(MessagesActivity messageFragment, long dialog_id) {
                 fragment.processSendingDocument(documentPath);
             }
             if (imagesPathArray != null) {
-                for (Uri path : imagesPathArray) {
-                    fragment.processSendingPhoto(null, path);
-                }
+                fragment.processSendingPhotos(null, imagesPathArray);
             }
             if (documentsPathArray != null) {
                 for (String path : documentsPathArray) {

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -418,6 +418,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override
                 public void onItemClick(int id) {
@@ -551,6 +552,7 @@ public void onItemClick(int id) {
                     }
                 }
             });
+
             updateSubtitle();
 
             if (currentEncryptedChat != null) {

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -145,6 +145,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("GroupInfo", R.string.GroupInfo));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override
@@ -331,6 +332,7 @@ public void saveSelfArgs(Bundle args) {
 
     @Override
     public void restoreSelfArgs(Bundle args) {
+        MessagesController.getInstance().loadChatInfo(chat_id);
         if (avatarUpdater != null) {
             avatarUpdater.currentPicturePath = args.getString("path");
         }

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileChangeNameActivity.java
Patch:
@@ -67,9 +67,9 @@ public void onClick(View view) {
                 }
             });
 
-            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel));
+            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel).toUpperCase());
             TextView textView = (TextView)doneButton.findViewById(R.id.done_button_text);
-            textView.setText(LocaleController.getString("Done", R.string.Done));
+            textView.setText(LocaleController.getString("Done", R.string.Done).toUpperCase());
 
             fragmentView = inflater.inflate(R.layout.chat_profile_change_name_layout, container, false);
 

File: TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
Patch:
@@ -87,9 +87,9 @@ public void onClick(View view) {
                 }
             });
 
-            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel));
+            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel).toUpperCase());
             TextView textView = (TextView)doneButton.findViewById(R.id.done_button_text);
-            textView.setText(LocaleController.getString("Done", R.string.Done));
+            textView.setText(LocaleController.getString("Done", R.string.Done).toUpperCase());
 
             fragmentView = inflater.inflate(R.layout.contact_add_layout, container, false);
 

File: TMessagesProj/src/main/java/org/telegram/ui/ContactsActivity.java
Patch:
@@ -116,6 +116,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             if (destroyAfterSelect) {
                 actionBarLayer.setTitle(LocaleController.getString("SelectContact", R.string.SelectContact));
             } else {

File: TMessagesProj/src/main/java/org/telegram/ui/CountrySelectActivity.java
Patch:
@@ -119,6 +119,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("ChooseCountry", R.string.ChooseCountry));
 
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {

File: TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
Patch:
@@ -127,6 +127,7 @@ public View createView(LayoutInflater inflater, ViewGroup container) {
 
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("SelectFile", R.string.SelectFile));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateActivity.java
Patch:
@@ -124,6 +124,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("NewGroup", R.string.NewGroup));
             actionBarLayer.setSubtitle(String.format("%d/200 %s", selectedContacts.size(), LocaleController.getString("Members", R.string.Members)));
 

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
Patch:
@@ -119,6 +119,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("NewGroup", R.string.NewGroup));
 
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
@@ -167,7 +168,7 @@ public void onClick(DialogInterface dialog, int which) {
             View doneItem = menu.addItemResource(done_button, R.layout.group_create_done_layout);
 
             TextView doneTextView = (TextView)doneItem.findViewById(R.id.done_button);
-            doneTextView.setText(LocaleController.getString("Done", R.string.Done));
+            doneTextView.setText(LocaleController.getString("Done", R.string.Done).toUpperCase());
 
             fragmentView = inflater.inflate(R.layout.group_create_final_layout, container, false);
 

File: TMessagesProj/src/main/java/org/telegram/ui/IdenticonActivity.java
Patch:
@@ -46,6 +46,7 @@ public boolean onFragmentCreate() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("EncryptionKey", R.string.EncryptionKey));
             actionBarLayer.setTitleIcon(R.drawable.ic_lock_white, Utilities.dp(4));
 

File: TMessagesProj/src/main/java/org/telegram/ui/IntroActivity.java
Patch:
@@ -17,6 +17,7 @@
 import android.text.Html;
 import android.view.View;
 import android.view.ViewGroup;
+import android.view.Window;
 import android.view.animation.Animation;
 import android.view.animation.AnimationUtils;
 import android.widget.ImageView;
@@ -42,6 +43,7 @@ public class IntroActivity extends Activity {
     protected void onCreate(Bundle savedInstanceState) {
         setTheme(R.style.Theme_TMessages);
         super.onCreate(savedInstanceState);
+        requestWindowFeature(Window.FEATURE_NO_TITLE);
 
         setContentView(R.layout.intro_layout);
 

File: TMessagesProj/src/main/java/org/telegram/ui/LanguageSelectActivity.java
Patch:
@@ -49,6 +49,7 @@ public class LanguageSelectActivity extends BaseFragment {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("Language", R.string.Language));
 
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {

File: TMessagesProj/src/main/java/org/telegram/ui/LocationActivity.java
Patch:
@@ -81,6 +81,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             if (messageObject != null) {
                 actionBarLayer.setTitle(LocaleController.getString("ChatLocation", R.string.ChatLocation));
             } else {

File: TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java
Patch:
@@ -56,7 +56,7 @@ public void onFragmentDestroy() {
     @Override
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
-            actionBarLayer.setDisplayUseLogoEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setDisplayUseLogoEnabled(true, R.drawable.ic_ab_logo);
             actionBarLayer.setTitle(LocaleController.getString("AppName", R.string.AppName));
 
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
@@ -71,7 +71,7 @@ public void onItemClick(int id) {
             ActionBarMenu menu = actionBarLayer.createMenu();
             View doneItem = menu.addItemResource(done_button, R.layout.group_create_done_layout);
             TextView doneTextView = (TextView)doneItem.findViewById(R.id.done_button);
-            doneTextView.setText(LocaleController.getString("Done", R.string.Done));
+            doneTextView.setText(LocaleController.getString("Done", R.string.Done).toUpperCase());
 
             fragmentView = inflater.inflate(R.layout.login_layout, container, false);
 

File: TMessagesProj/src/main/java/org/telegram/ui/MediaActivity.java
Patch:
@@ -87,6 +87,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("SharedMedia", R.string.SharedMedia));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
Patch:
@@ -176,6 +176,7 @@ public void onTextChanged(EditText editText) {
                 item.addSubItem(messages_list_menu_contacts, LocaleController.getString("Contacts", R.string.Contacts), 0);
                 item.addSubItem(messages_list_menu_settings, LocaleController.getString("Settings", R.string.Settings), 0);
             }
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
 
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoCropActivity.java
Patch:
@@ -353,9 +353,9 @@ public void onClick(View v) {
                 }
             });
 
-            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel));
+            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel).toUpperCase());
             TextView textView = (TextView)doneButton.findViewById(R.id.done_button_text);
-            textView.setText(LocaleController.getString("Done", R.string.Done));
+            textView.setText(LocaleController.getString("Done", R.string.Done).toUpperCase());
 
             fragmentView = view = new PhotoCropView(getParentActivity());
             fragmentView.setLayoutParams(new FrameLayout.LayoutParams(FrameLayout.LayoutParams.MATCH_PARENT, FrameLayout.LayoutParams.MATCH_PARENT));

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoPickerActivity.java
Patch:
@@ -492,7 +492,7 @@ public View getView(int i, View view, ViewGroup viewGroup) {
                 MediaController.AlbumEntry albumEntry = albumsSorted.get(i);
                 BackupImageView imageView = (BackupImageView)view.findViewById(R.id.media_photo_image);
                 if (albumEntry.coverPhoto != null && albumEntry.coverPhoto.path != null) {
-                    imageView.setImage(albumEntry.coverPhoto.path, "150_150", R.drawable.nophotos);
+                    imageView.setImage("thumb://" + albumEntry.coverPhoto.imageId + ":" + albumEntry.coverPhoto.path, "150_150", R.drawable.nophotos);
                 } else {
                     imageView.setImageResource(R.drawable.nophotos);
                 }
@@ -534,7 +534,7 @@ public void onClick(View v) {
                 imageView.setTag(i);
                 view.setTag(i);
                 if (photoEntry.path != null) {
-                    imageView.setImage(photoEntry.path, "100_100", R.drawable.nophotos);
+                    imageView.setImage("thumb://" + photoEntry.imageId + ":" + photoEntry.path, "100_100", R.drawable.nophotos);
                 } else {
                     imageView.setImageResource(R.drawable.nophotos);
                 }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -221,6 +221,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("Settings", R.string.Settings));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsers.java
Patch:
@@ -68,6 +68,7 @@ public void onFragmentDestroy() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("BlockedUsers", R.string.BlockedUsers));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsChangeNameActivity.java
Patch:
@@ -59,9 +59,9 @@ public void onClick(View view) {
                 }
             });
 
-            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel));
+            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel).toUpperCase());
             TextView textView = (TextView)doneButton.findViewById(R.id.done_button_text);
-            textView.setText(LocaleController.getString("Done", R.string.Done));
+            textView.setText(LocaleController.getString("Done", R.string.Done).toUpperCase());
 
             fragmentView = inflater.inflate(R.layout.settings_change_name_layout, container, false);
 

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
Patch:
@@ -98,6 +98,7 @@ public boolean onFragmentCreate() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             actionBarLayer.setTitle(LocaleController.getString("NotificationsAndSounds", R.string.NotificationsAndSounds));
             actionBarLayer.setActionBarMenuOnItemClick(new ActionBarLayer.ActionBarMenuOnItemClick() {
                 @Override

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java
Patch:
@@ -143,9 +143,9 @@ public void onClick(View view) {
                 }
             });
 
-            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel));
+            cancelButton.setText(LocaleController.getString("Cancel", R.string.Cancel).toUpperCase());
             TextView textView = (TextView)doneButton.findViewById(R.id.done_button_text);
-            textView.setText(LocaleController.getString("Set", R.string.Set));
+            textView.setText(LocaleController.getString("Set", R.string.Set).toUpperCase());
 
             fragmentView = inflater.inflate(R.layout.settings_wallpapers_layout, container, false);
             listAdapter = new ListAdapter(getParentActivity());

File: TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java
Patch:
@@ -135,6 +135,7 @@ private void updateRowsIds() {
     public View createView(LayoutInflater inflater, ViewGroup container) {
         if (fragmentView == null) {
             actionBarLayer.setDisplayHomeAsUpEnabled(true, R.drawable.ic_ab_back);
+            actionBarLayer.setBackOverlay(R.layout.updating_state_layout);
             if (dialog_id != 0) {
                 actionBarLayer.setTitle(LocaleController.getString("SecretTitle", R.string.SecretTitle));
                 actionBarLayer.setTitleIcon(R.drawable.ic_lock_white, Utilities.dp(4));

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/BaseFragment.java
Patch:
@@ -61,6 +61,7 @@ public void setParentActivity(ActionBarActivity activity) {
                     actionBarLayer.onDestroy();
                 }
                 actionBarLayer = parentActivity.getInternalActionBar().createLayer();
+                actionBarLayer.parentFragment = this;
                 actionBarLayer.setBackgroundResource(R.color.header);
                 actionBarLayer.setItemsBackground(R.drawable.bar_selector);
             }

File: TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
Patch:
@@ -21,7 +21,6 @@
 import android.view.ViewGroup;
 import android.widget.AdapterView;
 import android.widget.BaseAdapter;
-import android.widget.ImageView;
 import android.widget.ListView;
 import android.widget.TextView;
 
@@ -423,12 +422,10 @@ public View getView(int position, View convertView, ViewGroup parent) {
                 imageView.setImageBitmap(null);
                 typeTextView.setText(item.ext.toUpperCase().substring(0, Math.min(item.ext.length(), 4)));
                 imageView.setImage(item.thumb, "55_42", 0);
-                imageView.setScaleType(ImageView.ScaleType.CENTER_CROP);
                 imageView.setVisibility(View.VISIBLE);
                 typeTextView.setVisibility(View.VISIBLE);
             } else if (item.icon != 0) {
                 imageView.setImageResource(item.icon);
-                imageView.setScaleType(ImageView.ScaleType.CENTER);
                 imageView.setVisibility(View.VISIBLE);
                 typeTextView.setVisibility(View.GONE);
             } else {

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBar.java
Patch:
@@ -111,12 +111,13 @@ private void updateBackOverlay(int widthMeasureSpec, int heightMeasureSpec) {
             currentLayer.setBackLayoutVisible(currentLayer.isSearchFieldVisible || currentBackOverlay == null ? VISIBLE : INVISIBLE);
         }
         if (currentBackOverlay != null) {
-            currentBackOverlay.setVisibility(currentLayer.isSearchFieldVisible ? GONE : VISIBLE);
             ViewGroup.LayoutParams layoutParams = currentBackOverlay.getLayoutParams();
             if (currentLayer != null) {
+                currentBackOverlay.setVisibility(currentLayer.isSearchFieldVisible ? GONE : VISIBLE);
                 currentLayer.measure(widthMeasureSpec, heightMeasureSpec);
                 layoutParams.width = Math.min(currentBackOverlayWidth, currentLayer.getBackLayoutWidth());
             } else {
+                currentBackOverlay.setVisibility(VISIBLE);
                 layoutParams.width = LayoutParams.WRAP_CONTENT;
             }
             if (layoutParams.width != 0) {

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenu.java
Patch:
@@ -75,7 +75,9 @@ public ActionBarMenuItem addItem(int id, int icon) {
             public void onClick(View view) {
                 ActionBarMenuItem item = (ActionBarMenuItem)view;
                 if (item.hasSubMenu()) {
-                    item.toggleSubMenu();
+                    if (parentActionBarLayer.actionBarMenuOnItemClick.canOpenMenu()) {
+                        item.toggleSubMenu();
+                    }
                 } else if (item.isSearchField()) {
                     parentActionBarLayer.onSearchFieldVisibilityChanged(item.toggleSearch());
                 } else {

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -1603,7 +1603,6 @@ void sendMessagesToTransport(ArrayList<NetworkMessage> messagesToSend, TcpConnec
         }
     }
 
-    @SuppressWarnings("unused")
     ByteBufferDesc createConnectionData(ArrayList<NetworkMessage> messages, ArrayList<Integer> quickAckId, TcpConnection connection) {
         Datacenter datacenter = datacenterWithId(connection.getDatacenterId());
         if (datacenter.authKey == null) {

File: TMessagesProj/src/main/java/org/telegram/ui/ContactsActivity.java
Patch:
@@ -307,7 +307,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                                 }
                             });
                             builder.setNegativeButton(LocaleController.getString("Cancel", R.string.Cancel), null);
-                            builder.show().setCanceledOnTouchOutside(true);
+                            showAlertDialog(builder);
                         }
                     }
                 }
@@ -346,7 +346,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                 }
             });
             builder.setNegativeButton(R.string.Cancel, null);
-            builder.show().setCanceledOnTouchOutside(true);
+            showAlertDialog(builder);
         } else {
             if (delegate != null) {
                 delegate.didSelectContact(user);

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
Patch:
@@ -200,7 +200,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                             }
                         }
                     });
-                    builder.show().setCanceledOnTouchOutside(true);
+                    showAlertDialog(builder);
                 }
             });
 

File: TMessagesProj/src/main/java/org/telegram/ui/LanguageSelectActivity.java
Patch:
@@ -166,7 +166,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                         }
                     });
                     builder.setNegativeButton(LocaleController.getString("Cancel", R.string.Cancel), null);
-                    builder.show().setCanceledOnTouchOutside(true);
+                    showAlertDialog(builder);
                     return true;
                 }
             });

File: TMessagesProj/src/main/java/org/telegram/ui/LoginActivity.java
Patch:
@@ -215,7 +215,7 @@ public void run() {
                 builder.setTitle(LocaleController.getString("AppName", R.string.AppName));
                 builder.setMessage(text);
                 builder.setPositiveButton(LocaleController.getString("OK", R.string.OK), null);
-                builder.show().setCanceledOnTouchOutside(true);
+                showAlertDialog(builder);
             }
         });
     }

File: TMessagesProj/src/main/java/org/telegram/ui/MessagesActivity.java
Patch:
@@ -337,7 +337,7 @@ public void onClick(DialogInterface dialog, int which) {
                         });
                     }
                     builder.setNegativeButton(LocaleController.getString("Cancel", R.string.Cancel), null);
-                    builder.show().setCanceledOnTouchOutside(true);
+                    showAlertDialog(builder);
                     return true;
                 }
             });
@@ -487,7 +487,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                 }
             });
             builder.setNegativeButton(R.string.Cancel, null);
-            builder.show().setCanceledOnTouchOutside(true);
+            showAlertDialog(builder);
         } else {
             if (delegate != null) {
                 delegate.didSelectDialog(MessagesActivity.this, dialog_id);

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsers.java
Patch:
@@ -151,7 +151,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
                             }
                         }
                     });
-                    builder.show().setCanceledOnTouchOutside(true);
+                    showAlertDialog(builder);
 
                     return true;
                 }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
Patch:
@@ -279,7 +279,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
                                 }
                             });
                             builder.setNegativeButton(LocaleController.getString("Cancel", R.string.Cancel), null);
-                            builder.show().setCanceledOnTouchOutside(true);
+                            showAlertDialog(builder);
                         }
                     }
                 }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenu.java
Patch:
@@ -16,7 +16,6 @@
 import android.widget.ImageView;
 import android.widget.LinearLayout;
 
-import org.telegram.messenger.R;
 import org.telegram.messenger.Utilities;
 
 public class ActionBarMenu extends LinearLayout {
@@ -50,7 +49,7 @@ public View addItemResource(int id, int resourceId) {
         addView(view);
         LinearLayout.LayoutParams layoutParams = (LinearLayout.LayoutParams)view.getLayoutParams();
         layoutParams.height = FrameLayout.LayoutParams.FILL_PARENT;
-        view.setBackgroundResource(R.drawable.bar_selector);
+        view.setBackgroundResource(parentActionBar.itemsBackgroundResourceId);
         view.setLayoutParams(layoutParams);
         view.setOnClickListener(new OnClickListener() {
             @Override

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenuItem.java
Patch:
@@ -48,7 +48,7 @@ public static interface ActionBarMenuItemSearchListener {
 
     public ActionBarMenuItem(Context context, ActionBarMenu menu, ActionBar actionBar) {
         super(context);
-        setBackgroundResource(R.drawable.bar_selector);
+        setBackgroundResource(actionBar.itemsBackgroundResourceId);
         parentMenu = menu;
         parentActionBar = actionBar;
     }

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -2655,6 +2655,8 @@ public void hideEmojiPopup() {
 
     @Override
     public void onResume() {
+        super.onResume();
+
         showActionBar();
 
         checkActionBarMenu();
@@ -2741,6 +2743,7 @@ private void setTypingAnimation(boolean start) {
 
     @Override
     public void onPause() {
+        super.onPause();
         actionBarLayer.hideActionMode();
         hideEmojiPopup();
         paused = true;

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileActivity.java
Patch:
@@ -371,6 +371,7 @@ public void didReceivedNotification(int id, Object... args) {
 
     @Override
     public void onResume() {
+        super.onResume();
         if (listViewAdapter != null) {
             listViewAdapter.notifyDataSetChanged();
         }

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileChangeNameActivity.java
Patch:
@@ -103,6 +103,7 @@ public boolean onEditorAction(TextView textView, int i, KeyEvent keyEvent) {
 
     @Override
     public void onResume() {
+        super.onResume();
         SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
         boolean animations = preferences.getBoolean("view_animations", true);
         if (!animations) {

File: TMessagesProj/src/main/java/org/telegram/ui/ContactAddActivity.java
Patch:
@@ -177,6 +177,7 @@ public void didReceivedNotification(int id, Object... args) {
 
     @Override
     public void onResume() {
+        super.onResume();
         SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
         boolean animations = preferences.getBoolean("view_animations", true);
         if (!animations) {

File: TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
Patch:
@@ -194,6 +194,7 @@ public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
 
     @Override
     public void onResume() {
+        super.onResume();
         if (listAdapter != null) {
             listAdapter.notifyDataSetChanged();
         }

File: TMessagesProj/src/main/java/org/telegram/ui/IdenticonActivity.java
Patch:
@@ -84,6 +84,7 @@ public void onConfigurationChanged(android.content.res.Configuration newConfig)
 
     @Override
     public void onResume() {
+        super.onResume();
         fixLayout();
     }
 

File: TMessagesProj/src/main/java/org/telegram/ui/MediaActivity.java
Patch:
@@ -253,6 +253,7 @@ public void didReceivedNotification(int id, Object... args) {
 
     @Override
     public void onResume() {
+        super.onResume();
         if (listAdapter != null) {
             listAdapter.notifyDataSetChanged();
         }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -546,6 +546,7 @@ private void sendLogs() {
 
     @Override
     public void onResume() {
+        super.onResume();
         showActionBar();
         if (listAdapter != null) {
             listAdapter.notifyDataSetChanged();

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsers.java
Patch:
@@ -252,6 +252,7 @@ private void updateVisibleRows(int mask) {
 
     @Override
     public void onResume() {
+        super.onResume();
         if (listViewAdapter != null) {
             listViewAdapter.notifyDataSetChanged();
         }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsChangeNameActivity.java
Patch:
@@ -115,6 +115,7 @@ public boolean onEditorAction(TextView textView, int i, KeyEvent keyEvent) {
 
     @Override
     public void onResume() {
+        super.onResume();
         SharedPreferences preferences = ApplicationLoader.applicationContext.getSharedPreferences("mainconfig", Activity.MODE_PRIVATE);
         boolean animations = preferences.getBoolean("view_animations", true);
         if (!animations) {

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java
Patch:
@@ -424,6 +424,7 @@ public void run() {
 
     @Override
     public void onResume() {
+        super.onResume();
         if (listAdapter != null) {
             listAdapter.notifyDataSetChanged();
         }

File: TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java
Patch:
@@ -436,6 +436,7 @@ public void didReceivedNotification(int id, Object... args) {
 
     @Override
     public void onResume() {
+        super.onResume();
         if (listAdapter != null) {
             listAdapter.notifyDataSetChanged();
         }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBarMenu.java
Patch:
@@ -87,7 +87,7 @@ public void onClick(View view) {
         return menuItem;
     }
 
-    public void onDestroy() {
+    public void hideAllPopupMenus() {
         for (int a = 0; a < getChildCount(); a++) {
             View view = getChildAt(a);
             if (view instanceof ActionBarMenuItem) {

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -147,7 +147,8 @@ public void run() {
 
             if (datacenters != null) {
                 MessagesController.getInstance().updateTimerProc();
-                if (datacenterWithId(currentDatacenterId).authKey != null) {
+                Datacenter datacenter = datacenterWithId(currentDatacenterId);
+                if (datacenter != null && datacenter.authKey != null) {
                     if (lastPingTime < System.currentTimeMillis() - 19000) {
                         lastPingTime = System.currentTimeMillis();
                         generatePing();

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -1036,6 +1036,9 @@ public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
 
     private String getTrimmedString(String src) {
         String result = src.trim();
+        if (result.length() == 0) {
+            return result;
+        }
         while (src.startsWith("\n")) {
             src = src.substring(1);
         }

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ActionBar/ActionBar.java
Patch:
@@ -107,9 +107,10 @@ public void setBackOverlay(View view, int width) {
 
     private void updateBackOverlay(int widthMeasureSpec, int heightMeasureSpec) {
         if (currentLayer != null) {
-            currentLayer.setBackLayoutVisible(currentBackOverlay == null ? VISIBLE : INVISIBLE);
+            currentLayer.setBackLayoutVisible(currentLayer.isSearchFieldVisible || currentBackOverlay == null ? VISIBLE : INVISIBLE);
         }
         if (currentBackOverlay != null) {
+            currentBackOverlay.setVisibility(currentLayer.isSearchFieldVisible ? GONE : VISIBLE);
             ViewGroup.LayoutParams layoutParams = currentBackOverlay.getLayoutParams();
             if (currentLayer != null) {
                 currentLayer.measure(widthMeasureSpec, heightMeasureSpec);

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -205,7 +205,7 @@ public static String bytesToHex(byte[] bytes) {
     }
 
     public static int dp(int value) {
-        return (int)(density * value);
+        return (int)(Math.max(1, density * value));
     }
 
     public static int dpf(float value) {

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMediaCell.java
Patch:
@@ -135,7 +135,6 @@ public boolean onTouchEvent(MotionEvent event) {
 
         boolean result = false;
         int side = Utilities.dp(44);
-        checkSwipes(event);
         if (event.getAction() == MotionEvent.ACTION_DOWN) {
             if (delegate == null || delegate.canPerformActions()) {
                 if (buttonState != -1 && x >= buttonX && x <= buttonX + side && y >= buttonY && y <= buttonY + side) {

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
Patch:
@@ -482,7 +482,7 @@ public void build(int width, int height) {
                                 messageString = Emoji.replaceEmoji(Html.fromHtml(String.format("<font color=#316f9f>%s:</font> <font color=#316f9f>%s</font>", name, message.messageText)), messagePaint.getFontMetricsInt(), Utilities.dp(20));
                             } else {
                                 if (message.messageOwner.message != null) {
-                                    messageString = Emoji.replaceEmoji(Html.fromHtml(String.format("<font color=#316f9f>%s:</font> <font color=#808080>%s</font>", name, message.messageOwner.message.replace("\n", " "))), messagePaint.getFontMetricsInt(), Utilities.dp(20));
+                                    messageString = Emoji.replaceEmoji(Html.fromHtml(String.format("<font color=#316f9f>%s:</font> <font color=#808080>%s</font>", name, message.messageOwner.message.replace("\n", " ").replace("<", "&lt;").replace(">", "&gt;"))), messagePaint.getFontMetricsInt(), Utilities.dp(20));
                                 }
                             }
                         } else {

File: TMessagesProj/src/main/java/org/telegram/ui/IntroActivity.java
Patch:
@@ -194,7 +194,8 @@ public void onClick(View view) {
                     return;
                 }
                 startPressed = true;
-                Intent intent2 = new Intent(IntroActivity.this, LoginActivity.class);
+                Intent intent2 = new Intent(IntroActivity.this, LaunchActivity.class);
+                intent2.putExtra("fromIntro", true);
                 startActivity(intent2);
                 finish();
             }

File: TMessagesProj/src/main/java/jawnae/pyronet/PyroSelector.java
Patch:
@@ -83,7 +83,7 @@ public PyroClient connect(InetSocketAddress host, InetSocketAddress bind) throws
     }
 
     public void select() {
-        this.select(10);
+        this.select(0);
     }
 
     public void select(long eventTimeout) {

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesStorage.java
Patch:
@@ -997,8 +997,6 @@ public void putCachedPhoneBook(final HashMap<Integer, ContactsController.Contact
             @Override
             public void run() {
                 try {
-                    database.executeFast("DELETE FROM user_contacts_v6 WHERE 1").stepThis().dispose();
-                    database.executeFast("DELETE FROM user_phones_v6 WHERE 1").stepThis().dispose();
                     database.beginTransaction();
                     SQLitePreparedStatement state = database.executeFast("REPLACE INTO user_contacts_v6 VALUES(?, ?, ?)");
                     SQLitePreparedStatement state2 = database.executeFast("REPLACE INTO user_phones_v6 VALUES(?, ?, ?, ?)");

File: TMessagesProj/src/main/java/org/telegram/messenger/Utilities.java
Patch:
@@ -47,9 +47,7 @@
 import java.math.BigInteger;
 import java.nio.ByteBuffer;
 import java.nio.ByteOrder;
-import java.nio.channels.Channels;
 import java.nio.channels.FileChannel;
-import java.nio.channels.ReadableByteChannel;
 import java.security.KeyFactory;
 import java.security.MessageDigest;
 import java.security.PublicKey;

File: TMessagesProj/src/main/java/org/telegram/ui/Adapters/ContactsActivitySearchAdapter.java
Patch:
@@ -148,7 +148,7 @@ public long getItemId(int i) {
 
     @Override
     public boolean hasStableIds() {
-        return false;
+        return true;
     }
 
     @Override

File: TMessagesProj/src/main/java/org/telegram/ui/Views/SectionedBaseAdapter.java
Patch:
@@ -11,7 +11,6 @@
 import android.util.SparseArray;
 import android.view.View;
 import android.view.ViewGroup;
-import android.widget.BaseAdapter;
 
 import org.telegram.ui.Adapters.BaseFragmentAdapter;
 
@@ -223,5 +222,4 @@ private int internalGetSectionCount() {
         mSectionCount = getSectionCount();
         return mSectionCount;
     }
-
 }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java
Patch:
@@ -40,8 +40,8 @@ public boolean onTouchEvent(MotionEvent event) {
                 int x = (int)event.getX();
                 int y = (int)event.getY();
                 if (x >= textX && y >= textY && x <= textX + currentMessageObject.textWidth && y <= textY + currentMessageObject.textHeight) {
-                    int blockNum = Math.max(0, y / currentMessageObject.blockHeight);
                     y -= textY;
+                    int blockNum = Math.max(0, y / currentMessageObject.blockHeight);
                     if (blockNum < currentMessageObject.textLayoutBlocks.size()) {
                         MessageObject.TextLayoutBlock block = currentMessageObject.textLayoutBlocks.get(blockNum);
                         x -= textX - (int)Math.ceil(block.textXOffset);

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java
Patch:
@@ -40,8 +40,8 @@ public boolean onTouchEvent(MotionEvent event) {
                 int x = (int)event.getX();
                 int y = (int)event.getY();
                 if (x >= textX && y >= textY && x <= textX + currentMessageObject.textWidth && y <= textY + currentMessageObject.textHeight) {
-                    y -= textY;
                     int blockNum = Math.max(0, y / currentMessageObject.blockHeight);
+                    y -= textY;
                     if (blockNum < currentMessageObject.textLayoutBlocks.size()) {
                         MessageObject.TextLayoutBlock block = currentMessageObject.textLayoutBlocks.get(blockNum);
                         x -= textX - (int)Math.ceil(block.textXOffset);

File: TMessagesProj/src/main/java/org/telegram/messenger/NativeLoader.java
Patch:
@@ -34,7 +34,7 @@ private static File getNativeLibraryDir(Context context) {
         File f = null;
         if (context != null) {
             try {
-                f = (File) ApplicationInfo.class.getField("nativeLibraryDir").get(context.getApplicationInfo());
+                f = new File((String)ApplicationInfo.class.getField("nativeLibraryDir").get(context.getApplicationInfo()));
             } catch (Throwable th) {
                 th.printStackTrace();
             }

File: TMessagesProj/src/main/java/org/telegram/objects/MessageObject.java
Patch:
@@ -376,6 +376,9 @@ public static String getAttachFileName(TLObject attach) {
             }
         } else if (attach instanceof TLRPC.PhotoSize) {
             TLRPC.PhotoSize photo = (TLRPC.PhotoSize)attach;
+            if (photo.location == null) {
+                return "";
+            }
             return photo.location.volume_id + "_" + photo.location.local_id + ".jpg";
         } else if (attach instanceof TLRPC.Audio) {
             TLRPC.Audio audio = (TLRPC.Audio)attach;

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileChangeNameActivity.java
Patch:
@@ -69,7 +69,7 @@ public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle sa
             firstNameField.setOnEditorActionListener(new TextView.OnEditorActionListener() {
                 @Override
                 public boolean onEditorAction(TextView textView, int i, KeyEvent keyEvent) {
-                    if (i == EditorInfo.IME_ACTION_DONE) {
+                    if (i == EditorInfo.IME_ACTION_DONE && doneButton != null) {
                         doneButton.performClick();
                         return true;
                     }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java
Patch:
@@ -136,6 +136,7 @@ public void setMessageObject(MessageObject messageObject) {
                 drawName = true;
             } else {
                 maxWidth = Utilities.displaySize.x - Utilities.dp(80);
+                drawName = false;
             }
 
             backgroundWidth = maxWidth;

File: TMessagesProj/src/main/java/org/telegram/messenger/FileUploadOperation.java
Patch:
@@ -130,13 +130,13 @@ private void startUploadRequest() {
                 isLastPart = true;
             }
             sendBuffer.writeRaw(readBuffer, 0, readed);
-            sendBuffer.rewind();
             if (key != null) {
                 for (int a = 0; a < toAdd; a++) {
                     sendBuffer.writeByte(0);
                 }
                 Utilities.aesIgeEncryption2(sendBuffer.buffer, key, iv, true, true, readed + toAdd);
             }
+            sendBuffer.rewind();
             if (!isBigFile) {
                 mdEnc.update(sendBuffer.buffer);
             }

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesStorage.java
Patch:
@@ -1400,7 +1400,7 @@ public void run() {
                                 fromUser.add(message.fwd_from_id);
                             }
                             message.send_state = cursor.intValue(2);
-                            if (!message.unread || message.id > 0) {
+                            if (!message.unread && lower_id != 0 || message.id > 0) {
                                 message.send_state = 0;
                             }
                             if (lower_id == 0 && !cursor.isNull(5)) {

File: TMessagesProj/src/main/java/org/telegram/messenger/AbsSerializedData.java
Patch:
@@ -30,6 +30,7 @@ public abstract class AbsSerializedData {
     public abstract String readString();
     public abstract byte[] readByteArray();
     public abstract ByteBufferDesc readByteBuffer();
+    public abstract void writeByteBuffer(ByteBufferDesc buffer);
     public abstract double readDouble();
     public abstract int length();
 }

File: TMessagesProj/src/main/java/org/telegram/messenger/NativeLoader.java
Patch:
@@ -34,7 +34,7 @@ public static synchronized void initNativeLibs(Context context) {
             return;
         }
 
-        if (Build.VERSION.SDK_INT > 10) {
+        if (Build.VERSION.SDK_INT >= 9) {
             try {
                 String folder = null;
                 long libSize = 0;

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatAudioCell.java
Patch:
@@ -298,7 +298,7 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
     protected void onLayout(boolean changed, int left, int top, int right, int bottom) {
         super.onLayout(changed, left, top, right, bottom);
 
-        if (currentMessageObject.messageOwner.out) {
+        if (currentMessageObject.isOut()) {
             avatarImage.imageX = layoutWidth - backgroundWidth + Utilities.dp(9);
             seekBarX = layoutWidth - backgroundWidth + Utilities.dp(97);
             buttonX = layoutWidth - backgroundWidth + Utilities.dp(67);
@@ -359,7 +359,7 @@ public void setMessageObject(MessageObject messageObject) {
                 avatarImage.setImage((TLRPC.FileLocation)null, "50_50", getResources().getDrawable(Utilities.getUserAvatarForId(uid)));
             }
 
-            if (messageObject.messageOwner.out) {
+            if (messageObject.isOut()) {
                 seekBar.type = 0;
                 progressView.setProgressColors(0xffb4e396, 0xff6ac453);
             } else {
@@ -393,7 +393,7 @@ protected void onDraw(Canvas canvas) {
         canvas.restore();
 
         int state = buttonState;
-        if (!currentMessageObject.messageOwner.out) {
+        if (!currentMessageObject.isOut()) {
             state += 4;
             timePaint.setColor(0xffa1aab3);
         } else {

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/DialogCell.java
Patch:
@@ -465,7 +465,7 @@ public void build(int width, int height) {
                     } else {
                         if (chat != null) {
                             String name = "";
-                            if (message.messageOwner.from_id == UserConfig.clientUserId) {
+                            if (message.isFromMe()) {
                                 name = LocaleController.getString("FromYou", R.string.FromYou);
                             } else {
                                 if (fromUser != null) {
@@ -507,7 +507,7 @@ public void build(int width, int height) {
                     }
                 }
 
-                if (message.messageOwner.from_id == UserConfig.clientUserId) {
+                if (message.isFromMe()) {
                     if (message.messageOwner.send_state == MessagesController.MESSAGE_SEND_STATE_SENDING) {
                         drawCheck1 = false;
                         drawCheck2 = false;

File: TMessagesProj/src/main/java/org/telegram/ui/GalleryImageViewer.java
Patch:
@@ -726,9 +726,9 @@ private void processSelectedMenu(int itemId) {
                     return;
                 }
                 if (isVideo) {
-                    MediaController.saveFile(currentFileName, this, 1, null);
+                    MediaController.saveFile(currentFileName, null, this, 1, null);
                 } else {
-                    MediaController.saveFile(currentFileName, this, 0, null);
+                    MediaController.saveFile(currentFileName, null, this, 0, null);
                 }
                 break;
 //            case R.id.gallery_menu_send: {

File: TMessagesProj/src/main/java/org/telegram/ui/PhotoCropActivity.java
Patch:
@@ -182,7 +182,7 @@ public boolean onTouch(View view, MotionEvent motionEvent) {
         }
 
         private void updateBitmapSize() {
-            if (viewWidth == 0 || viewHeight == 0) {
+            if (viewWidth == 0 || viewHeight == 0 || imageToCrop == null) {
                 return;
             }
             float percX = (rectX - bitmapX) / bitmapWidth;

File: TMessagesProj/src/main/java/org/telegram/messenger/AwakeService.java
Patch:
@@ -37,7 +37,7 @@ public void onCreate() {
 
     public static void startService() {
         try {
-            if (MessagesController.isScreenOn && ApplicationLoader.lastPauseTime == 0) {
+            if (ApplicationLoader.isScreenOn && ApplicationLoader.lastPauseTime == 0) {
                 return;
             }
             timeout = 10000;

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -2041,13 +2041,14 @@ void processMessage(TLObject message, long messageId, int messageSeqNo, long mes
                                         if (request.serverFailureCount < 1) {
                                             discardResponse = true;
                                             request.runningMinStartTime = request.runningStartTime + 1;
-                                            request.serverFailureCount++;
                                         }
                                     } else {
                                         discardResponse = true;
-                                        request.runningMinStartTime = request.runningStartTime + 1;
+                                        int delay = Math.min(1, request.serverFailureCount * 2);
+                                        request.runningMinStartTime = request.runningStartTime + delay;
                                         request.confirmed = false;
                                     }
+                                    request.serverFailureCount++;
                                 } else if (errorCode == 420) {
                                     if ((request.flags & RPCRequest.RPCRequestClassFailOnServerErrors) == 0) {
                                         double waitTime = 2.0;

File: TMessagesProj/src/main/java/org/telegram/messenger/GcmBroadcastReceiver.java
Patch:
@@ -49,13 +49,13 @@ public void onReceive(final Context context, final Intent intent) {
                 }
             }
 
+            AwakeService.startService();
+
             Utilities.RunOnUIThread(new Runnable() {
                 @Override
                 public void run() {
                     ApplicationLoader.postInitApplication();
 
-                    AwakeService.startService();
-
                     try {
                         String key = intent.getStringExtra("loc_key");
                         if ("DC_UPDATE".equals(key)) {

File: TMessagesProj/src/main/java/org/telegram/messenger/NativeLoader.java
Patch:
@@ -34,7 +34,7 @@ public static synchronized void initNativeLibs(Context context) {
             return;
         }
 
-        if (Build.VERSION.SDK_INT >= 10) {
+        if (Build.VERSION.SDK_INT > 10) {
             try {
                 String folder = null;
                 long libSize = 0;

File: TMessagesProj/src/main/java/org/telegram/objects/PhotoObject.java
Patch:
@@ -60,6 +60,9 @@ public static TLRPC.PhotoSize getClosestPhotoSizeWithSize(ArrayList<TLRPC.PhotoS
         int closestHeight = 9999;
         TLRPC.PhotoSize closestObject = null;
         for (TLRPC.PhotoSize obj : sizes) {
+            if (obj == null) {
+                continue;
+            }
             int diffW = Math.abs(obj.w - width);
             int diffH = Math.abs(obj.h - height);
             if (closestObject == null || closestObject instanceof TLRPC.TL_photoCachedSize || closestWidth > diffW || closestHeight > diffH) {

File: TMessagesProj/src/main/java/org/telegram/ui/UserProfileActivity.java
Patch:
@@ -517,8 +517,8 @@ public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
         } else {
             menu.add(Menu.NONE, share_contact, Menu.NONE, LocaleController.getString("ShareContact", R.string.ShareContact));
             menu.add(Menu.NONE, block_contact, Menu.NONE, LocaleController.getString("BlockContact", R.string.BlockContact));
-            menu.add(Menu.NONE, block_contact, Menu.NONE, LocaleController.getString("EditContact", R.string.EditContact));
-            menu.add(Menu.NONE, block_contact, Menu.NONE, LocaleController.getString("DeleteContact", R.string.DeleteContact));
+            menu.add(Menu.NONE, edit_contact, Menu.NONE, LocaleController.getString("EditContact", R.string.EditContact));
+            menu.add(Menu.NONE, delete_contact, Menu.NONE, LocaleController.getString("DeleteContact", R.string.DeleteContact));
         }
     }
 

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -649,7 +649,7 @@ public void run() {
                 if (phone.startsWith("968")) {
                     for (HashMap.Entry<Integer, Datacenter> entry : datacenters.entrySet()) {
                         Datacenter datacenter = entry.getValue();
-                        datacenter.overridePort = 14;
+                        datacenter.overridePort = 8888;
                         if (datacenter.connection != null) {
                             datacenter.connection.suspendConnection(true);
                         }

File: TMessagesProj/src/main/java/org/telegram/messenger/Datacenter.java
Patch:
@@ -25,7 +25,7 @@ public class Datacenter {
     public ArrayList<String> addresses = new ArrayList<String>();
     public HashMap<String, Integer> ports = new HashMap<String, Integer>();
     public int[] defaultPorts =   new int[] {-1, 80, -1, 443, -1, 443, -1, 80, -1, 443, -1};
-    public int[] defaultPorts14 = new int[] {-1, 14, -1, 443, -1, 14,  -1, 80, -1, 14,  -1};
+    public int[] defaultPorts8888 = new int[] {-1, 8888, -1, 443, -1, 8888,  -1, 80, -1, 8888,  -1};
     public boolean authorized;
     public long authSessionId;
     public long authDownloadSessionId;
@@ -136,8 +136,8 @@ public int getCurrentPort() {
 
         int[] portsArray = defaultPorts;
 
-        if (overridePort == 14) {
-            portsArray = defaultPorts14;
+        if (overridePort == 8888) {
+            portsArray = defaultPorts8888;
         }
 
         if (currentPortNum >= defaultPorts.length) {

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java
Patch:
@@ -131,7 +131,7 @@ public void setMessageObject(MessageObject messageObject) {
             }
             pressedLink = null;
             int maxWidth;
-            if (isChat) {
+            if (isChat && !messageObject.messageOwner.out) {
                 maxWidth = Utilities.displaySize.x - Utilities.dp(122);
                 drawName = true;
             } else {

File: TMessagesProj/src/main/java/org/telegram/ui/DocumentSelectActivity.java
Patch:
@@ -345,7 +345,7 @@ public int compare(File lhs, File rhs) {
 
     private void showErrorBox(String error){
         new AlertDialog.Builder(parentActivity)
-                .setTitle(R.string.AppName)
+                .setTitle(LocaleController.getString("AppName", R.string.AppName))
                 .setMessage(error)
                 .setPositiveButton(R.string.OK, null)
                 .show();

File: TMessagesProj/src/main/java/org/telegram/PhoneFormat/RuleSet.java
Patch:
@@ -30,7 +30,7 @@
 
 public class RuleSet {
     public int matchLen;
-    public ArrayList<PhoneRule> rules;
+    public ArrayList<PhoneRule> rules = new ArrayList<PhoneRule>();
     public boolean hasRuleWithIntlPrefix;
     public boolean hasRuleWithTrunkPrefix;
     public static Pattern pattern = Pattern.compile("[0-9]+");

File: TMessagesProj/src/main/java/org/telegram/messenger/MediaController.java
Patch:
@@ -831,7 +831,7 @@ public void run() {
                     recordDialogId = dialog_id;
                     fileBuffer.rewind();
 
-                    if (android.os.Build.VERSION.SDK_INT >= 16) {
+                    /*if (android.os.Build.VERSION.SDK_INT >= 16) { some devices crash with it
                         AutomaticGainControl agc = null;
                         try {
                             if (AutomaticGainControl.isAvailable()) {
@@ -850,7 +850,7 @@ public void run() {
                             }
                             FileLog.e("tmessages", e);
                         }
-                    }
+                    }*/
 
                     audioRecorder.startRecording();
                 } catch (Exception e) {

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesController.java
Patch:
@@ -4539,7 +4539,7 @@ public void sendAlertToPebble(String message) {
             final String notificationData = new JSONArray().put(jsonData).toString();
 
             i.putExtra("messageType", "PEBBLE_ALERT");
-            i.putExtra("sender", "MyAndroidApp");
+            i.putExtra("sender", LocaleController.formatString("AppName", R.string.AppName));
             i.putExtra("notificationData", notificationData);
 
             ApplicationLoader.applicationContext.sendBroadcast(i);

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -36,6 +36,7 @@ public class ConnectionsManager implements Action.ActionDelegate, TcpConnection.
     public static String HOCKEY_APP_HASH = "your-hockeyapp-api-key-here";
     public static String GCM_SENDER_ID = "760348033672";
     public static String SEND_LOGS_EMAIL = "email@gmail.com";
+    public static final boolean enableAudio = DEBUG_VERSION;
 
     private HashMap<Integer, Datacenter> datacenters = new HashMap<Integer, Datacenter>();
     private HashMap<Long, ArrayList<Long>> processedMessageIdsSet = new HashMap<Long, ArrayList<Long>>();

File: TMessagesProj/src/main/java/org/telegram/objects/PhotoObject.java
Patch:
@@ -62,7 +62,7 @@ public static TLRPC.PhotoSize getClosestPhotoSizeWithSize(ArrayList<TLRPC.PhotoS
         for (TLRPC.PhotoSize obj : sizes) {
             int diffW = Math.abs(obj.w - width);
             int diffH = Math.abs(obj.h - height);
-            if (closestObject == null || closestWidth > diffW || closestHeight > diffH) {
+            if (closestObject == null || closestObject instanceof TLRPC.TL_photoCachedSize || closestWidth > diffW || closestHeight > diffH) {
                 closestObject = obj;
                 closestWidth = diffW;
                 closestHeight = diffH;

File: TMessagesProj/src/main/java/org/telegram/messenger/TcpConnection.java
Patch:
@@ -439,7 +439,7 @@ public void run() {
             }
 
             if (currentPacketLength % 4 != 0 || currentPacketLength > 2 * 1024 * 1024) {
-                //FileLog.e("tmessages", "Invalid packet length");
+                FileLog.e("tmessages", "Invalid packet length");
                 reconnect();
                 return;
             }

File: TMessagesProj/src/main/java/org/telegram/messenger/ContactsController.java
Patch:
@@ -369,7 +369,7 @@ public void performSyncPhoneBook(final HashMap<Integer, Contact> contactHashMap,
             @Override
             public void run() {
 
-                boolean disableDeletion = false;
+                boolean disableDeletion = true; //disable contacts deletion, because phone numbers can't be compared due to different numbers format
                 if (schedule) {
                     try {
                         AccountManager am = AccountManager.get(ApplicationLoader.applicationContext);
@@ -385,7 +385,6 @@ public void run() {
                         }
                     } catch (Exception e) {
                         FileLog.e("tmessages", e);
-                        disableDeletion = true;
                     }
                 }
 

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesStorage.java
Patch:
@@ -69,7 +69,7 @@ public void openDatabase() {
         }
         try {
             database = new SQLiteDatabase(cacheFile.getPath());
-            database.execute("PRAGMA secure_delete = ON");
+            database.executeFast("PRAGMA secure_delete = ON").stepThis().dispose();
             if (createTable) {
                 database.executeFast("CREATE TABLE users(uid INTEGER PRIMARY KEY, name TEXT, status INTEGER, data BLOB)").stepThis().dispose();
                 database.executeFast("CREATE TABLE messages(mid INTEGER PRIMARY KEY, uid INTEGER, read_state INTEGER, send_state INTEGER, date INTEGER, data BLOB, out INTEGER, ttl INTEGER)").stepThis().dispose();

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java
Patch:
@@ -187,11 +187,11 @@ protected void onLayout(boolean changed, int left, int top, int right, int botto
     @Override
     protected void onDraw(Canvas canvas) {
         super.onDraw(canvas);
-        if (currentMessageObject == null || currentMessageObject.textLayoutBlocks == null || currentMessageObject.textLayoutBlocks.isEmpty()) {
+        if (currentMessageObject == null || currentMessageObject.textLayoutBlocks == null || currentMessageObject.textLayoutBlocks.isEmpty() || firstVisibleBlockNum < 0) {
             return;
         }
 
-        for (int a = Math.max(0, (visibleY - textY) / currentMessageObject.blockHeight); a < currentMessageObject.textLayoutBlocks.size(); a++) {
+        for (int a = firstVisibleBlockNum; a <= lastVisibleBlockNum; a++) {
             MessageObject.TextLayoutBlock block = currentMessageObject.textLayoutBlocks.get(a);
             float y = textY + block.textYOffset;
             if (intersect(y, y + currentMessageObject.blockHeight, visibleY, visibleY + visibleHeight)) {

File: TMessagesProj/src/main/java/org/telegram/messenger/ConnectionsManager.java
Patch:
@@ -35,6 +35,7 @@ public class ConnectionsManager implements Action.ActionDelegate, TcpConnection.
     public static String APP_HASH = "5bce48dc7d331e62c955669eb7233217";
     public static String HOCKEY_APP_HASH = "your-hockeyapp-api-key-here";
     public static String GCM_SENDER_ID = "760348033672";
+    public static String SEND_LOGS_EMAIL = "email@gmail.com";
 
     private HashMap<Integer, Datacenter> datacenters = new HashMap<Integer, Datacenter>();
     private HashMap<Long, ArrayList<Long>> processedMessageIdsSet = new HashMap<Long, ArrayList<Long>>();

File: TMessagesProj/src/main/java/org/telegram/objects/MessageObject.java
Patch:
@@ -376,9 +376,9 @@ private void generateLayout() {
         textLayoutBlocks = new ArrayList<TextLayoutBlock>();
 
         if (messageText instanceof Spannable) {
-            if (messageOwner.message != null && messageOwner.message.contains(".")) {
+            if (messageOwner.message != null && messageOwner.message.contains(".") && (messageOwner.message.contains(".com") || messageOwner.message.contains("http") || messageOwner.message.contains(".ru") || messageOwner.message.contains(".org") || messageOwner.message.contains(".net"))) {
                 Linkify.addLinks((Spannable)messageText, Linkify.WEB_URLS);
-            } else if (messageText.length() < 400) {
+            } else if (messageText.length() < 100) {
                 Linkify.addLinks((Spannable)messageText, Linkify.WEB_URLS | Linkify.EMAIL_ADDRESSES | Linkify.PHONE_NUMBERS);
             }
         }

File: TMessagesProj/src/main/java/org/telegram/ui/ChatActivity.java
Patch:
@@ -2897,6 +2897,8 @@ private void updateVisibleRows() {
                     view.setBackgroundColor(0);
                 }
 
+                cell.setMessageObject(cell.getMessageObject());
+
                 cell.setCheckPressed(!disableSelection, disableSelection && selected);
             }
         }

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsActivity.java
Patch:
@@ -456,7 +456,7 @@ private void sendLogs() {
             }
             Intent i = new Intent(Intent.ACTION_SEND_MULTIPLE);
             i.setType("message/rfc822") ;
-            i.putExtra(Intent.EXTRA_EMAIL, new String[]{"drklo.2kb@gmail.com"});
+            i.putExtra(Intent.EXTRA_EMAIL, new String[]{ConnectionsManager.SEND_LOGS_EMAIL});
             i.putExtra(Intent.EXTRA_SUBJECT, "last logs");
             i.putParcelableArrayListExtra(Intent.EXTRA_STREAM, uris);
             startActivity(Intent.createChooser(i, "Select email application."));

File: TMessagesProj/src/main/java/jawnae/pyronet/PyroClientListener.java
Patch:
@@ -21,8 +21,6 @@
 import java.io.IOException;
 import java.nio.ByteBuffer;
 
-import jawnae.pyronet.PyroClient;
-
 public interface PyroClientListener {
     public void connectedClient(PyroClient client);
 

File: TMessagesProj/src/main/java/org/telegram/messenger/ExportAuthorizationAction.java
Patch:
@@ -8,9 +8,6 @@
 
 package org.telegram.messenger;
 
-import org.telegram.TL.TLObject;
-import org.telegram.TL.TLRPC;
-
 import java.util.HashMap;
 
 public class ExportAuthorizationAction extends Action {

File: TMessagesProj/src/main/java/org/telegram/messenger/NetworkMessage.java
Patch:
@@ -8,8 +8,6 @@
 
 package org.telegram.messenger;
 
-import org.telegram.TL.TLRPC;
-
 public class NetworkMessage {
     public TLRPC.TL_protoMessage protoMessage;
     public Object rawRequest;

File: TMessagesProj/src/main/java/org/telegram/messenger/RPCRequest.java
Patch:
@@ -8,9 +8,6 @@
 
 package org.telegram.messenger;
 
-import org.telegram.TL.TLObject;
-import org.telegram.TL.TLRPC;
-
 import java.util.ArrayList;
 
 public class RPCRequest {

File: TMessagesProj/src/main/java/org/telegram/objects/PhotoObject.java
Patch:
@@ -11,7 +11,7 @@
 import android.graphics.Bitmap;
 import android.graphics.BitmapFactory;
 
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.FileLoader;
 
 import java.util.ArrayList;
@@ -62,7 +62,7 @@ public static TLRPC.PhotoSize getClosestPhotoSizeWithSize(ArrayList<TLRPC.PhotoS
         for (TLRPC.PhotoSize obj : sizes) {
             int diffW = Math.abs(obj.w - width);
             int diffH = Math.abs(obj.h - height);
-            if (closestObject == null || closestWidth > diffW && closestHeight > diffH) {
+            if (closestObject == null || closestWidth > diffW || closestHeight > diffH) {
                 closestObject = obj;
                 closestWidth = diffW;
                 closestHeight = diffH;

File: TMessagesProj/src/main/java/org/telegram/ui/ChatProfileChangeNameActivity.java
Patch:
@@ -22,7 +22,7 @@
 import android.widget.EditText;
 import android.widget.TextView;
 
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.MessagesController;
 import org.telegram.messenger.R;
 import org.telegram.messenger.Utilities;

File: TMessagesProj/src/main/java/org/telegram/ui/CountrySelectActivity.java
Patch:
@@ -69,6 +69,9 @@ public static class Country {
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
 
+        searching = false;
+        searchWas = false;
+
         try {
             BufferedReader reader = new BufferedReader(new InputStreamReader(getResources().getAssets().open("countries.txt")));
             String line;

File: TMessagesProj/src/main/java/org/telegram/ui/GroupCreateFinalActivity.java
Patch:
@@ -25,7 +25,7 @@
 import android.widget.ImageButton;
 import android.widget.TextView;
 
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.MessagesController;
 import org.telegram.messenger.NotificationCenter;

File: TMessagesProj/src/main/java/org/telegram/ui/IdenticonActivity.java
Patch:
@@ -22,7 +22,7 @@
 import android.widget.LinearLayout;
 import android.widget.TextView;
 
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.MessagesController;
 import org.telegram.messenger.R;
 import org.telegram.messenger.Utilities;

File: TMessagesProj/src/main/java/org/telegram/ui/LocationActivity.java
Patch:
@@ -28,7 +28,7 @@
 import com.google.android.gms.maps.model.LatLng;
 import com.google.android.gms.maps.model.Marker;
 import com.google.android.gms.maps.model.MarkerOptions;
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLRPC;
 import org.telegram.objects.MessageObject;
 import org.telegram.messenger.MessagesController;
 import org.telegram.messenger.NotificationCenter;

File: TMessagesProj/src/main/java/org/telegram/ui/LoginActivityPhoneView.java
Patch:
@@ -26,8 +26,8 @@
 import android.widget.TextView;
 
 import org.telegram.PhoneFormat.PhoneFormat;
-import org.telegram.TL.TLObject;
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLObject;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.R;
@@ -327,6 +327,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
                 if (error == null) {
                     final TLRPC.TL_auth_sentCode res = (TLRPC.TL_auth_sentCode)response;
                     params.putString("phoneHash", res.phone_code_hash);
+                    params.putInt("calltime", res.send_call_timeout * 1000);
                     if (res.phone_registered) {
                         params.putString("registered", "true");
                     }

File: TMessagesProj/src/main/java/org/telegram/ui/LoginActivityRegisterView.java
Patch:
@@ -19,8 +19,8 @@
 import android.widget.EditText;
 import android.widget.TextView;
 
-import org.telegram.TL.TLObject;
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLObject;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.ContactsController;
 import org.telegram.messenger.MessagesController;

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsBlockedUsers.java
Patch:
@@ -25,8 +25,8 @@
 import android.widget.TextView;
 
 import org.telegram.PhoneFormat.PhoneFormat;
-import org.telegram.TL.TLObject;
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLObject;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.MessagesController;
 import org.telegram.messenger.NotificationCenter;

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsChangeNameActivity.java
Patch:
@@ -16,15 +16,14 @@
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
-import android.view.WindowManager;
 import android.view.animation.Animation;
 import android.view.animation.AnimationUtils;
 import android.view.inputmethod.EditorInfo;
 import android.widget.EditText;
 import android.widget.TextView;
 
-import org.telegram.TL.TLObject;
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLObject;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.MessagesController;
 import org.telegram.messenger.NotificationCenter;

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsNotificationsActivity.java
Patch:
@@ -30,8 +30,8 @@
 import android.widget.TextView;
 import android.widget.Toast;
 
-import org.telegram.TL.TLObject;
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLObject;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.ConnectionsManager;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.MessagesController;

File: TMessagesProj/src/main/java/org/telegram/ui/Views/AvatarUpdater.java
Patch:
@@ -15,7 +15,7 @@
 import android.os.Bundle;
 import android.provider.MediaStore;
 
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.FileLoader;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.NotificationCenter;

File: TMessagesProj/src/main/java/org/telegram/ui/Views/BackupImageView.java
Patch:
@@ -16,7 +16,7 @@
 import android.os.Build;
 import android.widget.ImageView;
 
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.FileLoader;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.Utilities;

File: TMessagesProj/src/main/java/org/telegram/ui/Views/ImageReceiver.java
Patch:
@@ -15,7 +15,7 @@
 import android.os.Build;
 import android.view.View;
 
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.FileLoader;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.Utilities;

File: TMessagesProj/src/main/java/org/telegram/ui/Views/NotificationView.java
Patch:
@@ -23,7 +23,7 @@
 import android.widget.LinearLayout;
 import android.widget.TextView;
 
-import org.telegram.TL.TLRPC;
+import org.telegram.messenger.TLRPC;
 import org.telegram.messenger.FileLog;
 import org.telegram.messenger.MessagesController;
 import org.telegram.messenger.NotificationCenter;

File: TMessagesProj/src/main/java/org/telegram/ui/Views/SectionedBaseAdapter.java
Patch:
@@ -13,7 +13,9 @@
 import android.view.ViewGroup;
 import android.widget.BaseAdapter;
 
-public abstract class SectionedBaseAdapter extends BaseAdapter implements PinnedHeaderListView.PinnedSectionedHeaderAdapter {
+import org.telegram.ui.Adapters.BaseFragmentAdapter;
+
+public abstract class SectionedBaseAdapter extends BaseFragmentAdapter implements PinnedHeaderListView.PinnedSectionedHeaderAdapter {
 
     /**
      * Holds the calculated values of @{link getPositionInSectionForPosition}

File: TMessagesProj/src/main/java/org/telegram/messenger/TcpConnection.java
Patch:
@@ -423,7 +423,7 @@ public void handleDisconnect(PyroClient client, Exception e, boolean timedout) {
         } else {
             FileLog.d("tmessages", "Disconnected " + TcpConnection.this);
         }
-        boolean swirchToNextPort = wasConnected && hasSomeDataSinceLastConnect;
+        boolean switchToNextPort = wasConnected && !hasSomeDataSinceLastConnect && timedout;
         firstPacket = true;
         restOfTheData = null;
         channelToken = 0;
@@ -452,7 +452,7 @@ public void run() {
             }
             if (ConnectionsManager.isNetworkOnline()) {
                 isNextPort = true;
-                if (failedConnectionCount > willRetryConnectCount || swirchToNextPort) {
+                if (failedConnectionCount > willRetryConnectCount || switchToNextPort) {
                     Datacenter datacenter = ConnectionsManager.Instance.datacenterWithId(datacenterId);
                     datacenter.nextAddressOrPort();
                     failedConnectionCount = 0;

File: TMessagesProj/src/main/java/org/telegram/TL/TLClassStore.java
Patch:
@@ -414,6 +414,7 @@ public TLClassStore () {
         classStore.put(TLRPC.TL_messageActionTTLChange.constructor, TLRPC.TL_messageActionTTLChange.class);
         classStore.put(TLRPC.TL_videoEncrypted.constructor, TLRPC.TL_videoEncrypted.class);
         classStore.put(TLRPC.TL_documentEncrypted.constructor, TLRPC.TL_documentEncrypted.class);
+        classStore.put(TLRPC.TL_audioEncrypted.constructor, TLRPC.TL_audioEncrypted.class);
         classStore.put(TLRPC.TL_gzip_packed.constructor, TLRPC.TL_gzip_packed.class);
         classStore.put(TLRPC.Vector.constructor, TLRPC.Vector.class);
         classStore.put(TLRPC.TL_userProfilePhotoOld.constructor, TLRPC.TL_userProfilePhotoOld.class);

File: TMessagesProj/src/main/java/org/telegram/messenger/ExportAuthorizationAction.java
Patch:
@@ -53,7 +53,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
                             public void run() {
                                 beginExport();
                             }
-                        }, retryCount * 1500, false);
+                        }, retryCount * 1500);
                     }
                 }
             }
@@ -84,7 +84,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
                             public void run() {
                                 beginExport();
                             }
-                        }, retryCount * 1500, false);
+                        }, retryCount * 1500);
                     }
                 }
             }

File: TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatOrUserCell.java
Patch:
@@ -393,7 +393,7 @@ public void build(int width, int height) {
                                     if (value == 0) {
                                         value = user.status.expires;
                                     }
-                                    onlineString = getResources().getString(R.string.LastSeen) + " " + Utilities.formatDateOnline(value);
+                                    onlineString = Utilities.formatDateOnline(value);
                                 }
                             }
                         }

File: TMessagesProj/src/main/java/org/telegram/ui/LaunchActivity.java
Patch:
@@ -54,7 +54,7 @@ protected void onCreate(Bundle savedInstanceState) {
                             }
                             String path = null;
                             if (parcelable instanceof Uri) {
-                                path = Utilities.getPath(this, (Uri)parcelable);
+                                path = Utilities.getPath((Uri)parcelable);
                             } else {
                                 path = intent.getParcelableExtra(Intent.EXTRA_STREAM).toString();
                                 if (path.startsWith("content:")) {
@@ -79,7 +79,7 @@ protected void onCreate(Bundle savedInstanceState) {
                             }
                             String path = null;
                             if (parcelable instanceof Uri) {
-                                path = Utilities.getPath(this, (Uri)parcelable);
+                                path = Utilities.getPath((Uri)parcelable);
                             } else {
                                 path = parcelable.toString();
                                 if (path.startsWith("content:")) {

File: TMessagesProj/src/main/java/org/telegram/ui/LoginActivityPhoneView.java
Patch:
@@ -253,7 +253,9 @@ public boolean onEditorAction(TextView textView, int i, KeyEvent keyEvent) {
     public void selectCountry(String name) {
         int index = countriesArray.indexOf(name);
         if (index != -1) {
+            ignoreOnTextChange = true;
             codeField.setText(countriesMap.get(name));
+            countryButton.setText(name);
         }
     }
 

File: TMessagesProj/src/main/java/org/telegram/ui/SettingsWallpapersActivity.java
Patch:
@@ -246,11 +246,11 @@ private void processSelectedBackground() {
                 progressBar.setVisibility(View.VISIBLE);
                 loadingSize = size;
                 selectedColor = 0;
-                FileLoader.Instance.loadFile(null, size, null);
+                FileLoader.Instance.loadFile(null, size, null, null);
                 backgroundImage.setBackgroundColor(0);
             } else {
                 if (loadingFile != null) {
-                    FileLoader.Instance.cancelLoadFile(null, loadingSize, null);
+                    FileLoader.Instance.cancelLoadFile(null, loadingSize, null, null);
                 }
                 loadingFileObject = null;
                 loadingFile = null;
@@ -263,7 +263,7 @@ private void processSelectedBackground() {
             }
         } else {
             if (loadingFile != null) {
-                FileLoader.Instance.cancelLoadFile(null, loadingSize, null);
+                FileLoader.Instance.cancelLoadFile(null, loadingSize, null, null);
             }
             if (selectedBackground == 1000001) {
                 backgroundImage.setImageResource(R.drawable.background_hd);

File: TMessagesProj/src/main/java/org/telegram/messenger/HandshakeAction.java
Patch:
@@ -345,12 +345,12 @@ public void run() {
                 }
 
                 BigInteger p = new BigInteger(1, dhInnerData.dh_prime);
-                BigInteger g_b = BigInteger.valueOf(dhInnerData.g);
                 BigInteger g_a = new BigInteger(1, dhInnerData.g_a);
-                if (!Utilities.isGoodGaAndGb(g_a, g_b, p)) {
+                if (!Utilities.isGoodGaAndGb(g_a, p)) {
                     throw new RuntimeException("bad prime");
                 }
 
+                BigInteger g_b = BigInteger.valueOf(dhInnerData.g);
                 g_b = g_b.modPow(new BigInteger(1, b), p);
                 g_a = g_a.modPow(new BigInteger(1, b), p);
 

File: TMessagesProj/src/main/java/org/telegram/messenger/MessagesController.java
Patch:
@@ -4814,7 +4814,7 @@ public void processAcceptedSecretChat(final TLRPC.EncryptedChat encryptedChat) {
         BigInteger p = new BigInteger(1, MessagesStorage.secretPBytes);
         BigInteger i_authKey = new BigInteger(1, encryptedChat.g_a_or_b);
 
-        if (!Utilities.isGoodGaAndGb(null, i_authKey, p)) {
+        if (!Utilities.isGoodGaAndGb(i_authKey, p)) {
             declineSecretChat(encryptedChat.id);
             return;
         }
@@ -4911,7 +4911,7 @@ public void run(TLObject response, TLRPC.TL_error error) {
                     g_b = g_b.modPow(new BigInteger(1, salt), p);
                     BigInteger g_a = new BigInteger(1, encryptedChat.g_a);
 
-                    if (!Utilities.isGoodGaAndGb(g_a, g_b, p)) {
+                    if (!Utilities.isGoodGaAndGb(g_a, p)) {
                         acceptingChats.remove(encryptedChat.id);
                         declineSecretChat(encryptedChat.id);
                         return;

