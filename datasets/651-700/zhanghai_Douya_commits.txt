File: app/src/main/java/me/zhanghai/android/douya/util/ViewUtils.java
Patch:
@@ -225,7 +225,7 @@ public static ColorStateList getColorStateListFromAttrRes(@AttrRes int attrRes,
             if (resId != 0) {
                 return AppCompatResources.getColorStateList(context, resId);
             }
-            return null;
+            return a.getColorStateList(0);
         } finally {
             a.recycle();
         }

File: app/src/main/java/me/zhanghai/android/douya/network/GsonResponseBodyConverterFactory.java
Patch:
@@ -5,12 +5,12 @@
 
 package me.zhanghai.android.douya.network;
 
+import android.support.annotation.Nullable;
+
 import java.io.IOException;
 import java.lang.annotation.Annotation;
 import java.lang.reflect.Type;
 
-import javax.annotation.Nullable;
-
 import me.zhanghai.android.douya.util.GsonHelper;
 import okhttp3.ResponseBody;
 import retrofit2.Converter;

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiCallAdapter.java
Patch:
@@ -6,13 +6,12 @@
 package me.zhanghai.android.douya.network.api;
 
 import android.support.annotation.NonNull;
+import android.support.annotation.Nullable;
 
 import java.lang.annotation.Annotation;
 import java.lang.reflect.ParameterizedType;
 import java.lang.reflect.Type;
 
-import javax.annotation.Nullable;
-
 import retrofit2.Call;
 import retrofit2.CallAdapter;
 import retrofit2.Retrofit;

File: app/src/main/java/me/zhanghai/android/douya/network/api/ImageTypeUriRequestBody.java
Patch:
@@ -8,12 +8,11 @@
 import android.content.ContentResolver;
 import android.content.Context;
 import android.net.Uri;
+import android.support.annotation.Nullable;
 import android.text.TextUtils;
 
 import java.io.InputStream;
 
-import javax.annotation.Nullable;
-
 import me.zhanghai.android.douya.util.FileTypeUtils;
 import me.zhanghai.android.douya.util.UriUtils;
 import okhttp3.MediaType;

File: app/src/main/java/me/zhanghai/android/douya/settings/ui/SettingsFragment.java
Patch:
@@ -48,6 +48,6 @@ public void onSharedPreferenceChanged(@NonNull SharedPreferences sharedPreferenc
         if (!TextUtils.equals(key, Settings.NIGHT_MODE.getKey())) {
             return;
         }
-        NightModeHelper.updateNightMode((AppCompatActivity) getActivity());
+        NightModeHelper.updateNightMode(requireActivity());
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/ui/WebViewActivity.java
Patch:
@@ -191,8 +191,8 @@ protected void onDestroy() {
     public void onConfigurationChanged(Configuration newConfig) {
 
         // Need to do this before calling super to avoid activity recreation by AppCompat.
-        NightModeHelper.onConfigurationChanged(this);
-        onApplyThemeResource(getTheme(), R.style.Theme_Douya, true);
+        NightModeHelper.onConfigurationChanged(this, this::onApplyThemeResource,
+                R.style.Theme_Douya);
 
         super.onConfigurationChanged(newConfig);
 

File: app/src/main/java/me/zhanghai/android/douya/ui/CounterTextView.java
Patch:
@@ -55,7 +55,7 @@ private void updateText() {
         if (visible) {
             setText(getContext().getString(R.string.counter_format, length, mMaxLength));
             int textColorAttrRes = length <= mMaxLength ? android.R.attr.textColorSecondary
-                    : R.attr.textColorError;
+                    : R.attr.colorError;
             setTextColor(ViewUtils.getColorStateListFromAttrRes(textColorAttrRes, getContext()));
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastActivityDialogFragment.java
Patch:
@@ -142,8 +142,8 @@ private void updateTabTitle() {
         mTabAdapter.setPageTitle(mTabLayout, 0, getTabTitle(mBroadcast.likeCount,
                 R.string.broadcast_likers_title_format, R.string.broadcast_likers_title_empty));
         mTabAdapter.setPageTitle(mTabLayout, 1, getTabTitle(mBroadcast.rebroadcastCount,
-                R.string.broadcast_rebroadcasted_broadcasts_title_format,
-                R.string.broadcast_rebroadcasted_broadcasts_title_empty));
+                R.string.broadcast_rebroadcasts_title_format,
+                R.string.broadcast_rebroadcasts_title_empty));
     }
 
     private CharSequence getTabTitle(int count, int formatResId, int emptyResId) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastActivityDialogFragment.java
Patch:
@@ -104,7 +104,7 @@ public void onActivityCreated(Bundle savedInstanceState) {
 
         mTabAdapter = new TabFragmentPagerAdapter(this);
         mTabAdapter.addTab(() -> BroadcastLikerListFragment.newInstance(mBroadcast), null);
-        mTabAdapter.addTab(() -> BroadcastRebroadcastedBroadcastListFragment.newInstance(
+        mTabAdapter.addTab(() -> BroadcastRebroadcastListFragment.newInstance(
                 mBroadcast), null);
         updateTabTitle();
         mViewPager.setOffscreenPageLimit(mTabAdapter.getCount() - 1);

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Broadcast.java
Patch:
@@ -303,6 +303,8 @@ private void fixAction() {
             action = "说";
         } else {
             action = action
+                    .replaceFirst("^转发", "转播")
+                    .replaceFirst("^转播日记$", "推荐日记")
                     .replaceFirst("^分享", "推荐")
                     .replaceFirst("^推荐链接$", "推荐网页")
                     .replaceFirst("^(想.|在.|.过)这.+", "$1")

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/EditLinkDialogFragment.java
Patch:
@@ -30,7 +30,7 @@
 
 public class EditLinkDialogFragment extends AppCompatDialogFragment {
 
-    private static final String KEY_PREFIX = SendBroadcastFragment.class.getName() + '.';
+    private static final String KEY_PREFIX = EditLinkDialogFragment.class.getName() + '.';
 
     private static final String EXTRA_LINK_INFO = KEY_PREFIX + "link_info";
 

File: app/src/main/java/me/zhanghai/android/douya/util/GsonHelper.java
Patch:
@@ -28,6 +28,7 @@ public class GsonHelper {
     static {
         GsonBuilder builder = new GsonBuilder()
                 .serializeNulls()
+                .registerTypeAdapter(long.class, new LongDeserializer())
                 .registerTypeAdapter(Long.class, new LongDeserializer())
                 .registerTypeAdapter(BaseTimelineItem.class, new BaseTimelineItem.Deserializer())
                 .registerTypeAdapter(CollectableItem.class, new CollectableItem.Deserializer())

File: app/src/main/java/me/zhanghai/android/douya/ui/WebViewActivity.java
Patch:
@@ -472,7 +472,7 @@ private void updateRequestDesktopSite() {
     private void initializeUserAgents() {
         mDefaultUserAgent = mWebView.getSettings().getUserAgentString();
         mDesktopUserAgent = mDefaultUserAgent
-                .replaceFirst("(Linux;.*?)", "(X11; Linux x86_64)")
+                .replaceFirst("\\(Linux;.*?\\)", "(X11; Linux x86_64)")
                 .replace("Mobile Safari/", "Safari/");
     }
 

File: app/src/main/java/me/zhanghai/android/douya/media/PlayMusicService.java
Patch:
@@ -27,7 +27,6 @@
 import com.google.android.exoplayer2.Timeline;
 import com.google.android.exoplayer2.source.MediaSource;
 
-import java.util.ArrayList;
 import java.util.List;
 
 import me.zhanghai.android.douya.R;
@@ -187,7 +186,7 @@ private void onHandleIntent(Intent intent) {
                     PendingIntent.FLAG_UPDATE_CURRENT);
             mMediaPlayback.setSessionActivity(sessionActivity);
             List<MediaMetadataCompat> mediaMetadatas = Functional.map(mMusic.tracks,
-                    (track, index) -> makeMediaMetadata(mMusic, track, index), new ArrayList<>());
+                    (track, index) -> makeMediaMetadata(mMusic, track, index));
             mMediaPlayback.setMediaMetadatas(mediaMetadatas);
             loadMediaMetadataDisplayIconAndAlbumArt(mMusic);
             mMediaPlayback.start();
@@ -347,7 +346,7 @@ private void updateMediaMetadataDisplayIconAndAlbumArt(Bitmap displayIcon, Bitma
                 builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ALBUM_ART, null);
             }
             return builder.build();
-        }, new ArrayList<>());
+        });
         mMediaPlayback.setMediaMetadatas(mediaMetadatas);
     }
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Book.java
Patch:
@@ -61,7 +61,7 @@ public String getYearMonth(Context context) {
     }
 
     public List<String> getPageCountStrings() {
-        return Functional.map(pageCounts, pageCount -> pageCount + "页", new ArrayList<>());
+        return Functional.map(pageCounts, pageCount -> pageCount + "页");
     }
 
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/SimpleGame.java
Patch:
@@ -25,7 +25,7 @@ public class SimpleGame extends CollectableItem {
     public String releaseDate;
 
     public List<String> getPlatformNames() {
-        return Functional.map(platforms, platform -> platform.name, new ArrayList<>());
+        return Functional.map(platforms, platform -> platform.name);
     }
 
     public String getYearMonth(Context context) {

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/SimpleMusic.java
Patch:
@@ -35,7 +35,7 @@ public String getYearMonth(Context context) {
     }
 
     public List<String> getArtistNames() {
-        return Functional.map(artists, artist -> artist.name, new ArrayList<>());
+        return Functional.map(artists, artist -> artist.name);
     }
 
 

File: app/src/main/java/me/zhanghai/android/douya/item/ui/BookDataAdapter.java
Patch:
@@ -248,7 +248,7 @@ private void bindBadgeListHolder(RecyclerView.ViewHolder holder, Book book, Rati
         BadgeListHolder badgeListHolder = (BadgeListHolder) holder;
         badgeListHolder.badgeListLayout.setTop250(null);
         badgeListHolder.badgeListLayout.setRating(rating, book);
-        badgeListHolder.badgeListLayout.setGenre(0, null);
+        badgeListHolder.badgeListLayout.setGenre(0, null, CollectableItem.Type.BOOK);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/item/ui/GameDataAdapter.java
Patch:
@@ -249,7 +249,7 @@ private void bindBadgeListHolder(RecyclerView.ViewHolder holder, Game game, Rati
         badgeListHolder.badgeListLayout.setTop250(null);
         badgeListHolder.badgeListLayout.setRating(rating, game);
         badgeListHolder.badgeListLayout.setGenre(R.drawable.game_badge_white_40dp,
-                CollectionUtils.firstOrNull(game.genres));
+                CollectionUtils.firstOrNull(game.genres), CollectableItem.Type.GAME);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/item/ui/MovieDataAdapter.java
Patch:
@@ -253,7 +253,7 @@ private void bindBadgeListHolder(RecyclerView.ViewHolder holder, Movie movie, Ra
         badgeListHolder.badgeListLayout.setTop250(top250Honor);
         badgeListHolder.badgeListLayout.setRating(rating, movie);
         badgeListHolder.badgeListLayout.setGenre(R.drawable.movie_badge_white_40dp,
-                CollectionUtils.firstOrNull(movie.genres));
+                CollectionUtils.firstOrNull(movie.genres), CollectableItem.Type.MOVIE);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/item/ui/MusicDataAdapter.java
Patch:
@@ -238,7 +238,7 @@ private void bindBadgeListHolder(RecyclerView.ViewHolder holder, Music music, Ra
         badgeListHolder.badgeListLayout.setTop250(null);
         badgeListHolder.badgeListLayout.setRating(rating, music);
         badgeListHolder.badgeListLayout.setGenre(R.drawable.music_badge_white_40dp,
-                CollectionUtils.firstOrNull(music.genres));
+                CollectionUtils.firstOrNull(music.genres), CollectableItem.Type.MUSIC);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/item/ui/RecommendationListAdapter.java
Patch:
@@ -50,6 +50,7 @@ public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
         switch (item.getType()) {
             case BOOK:
             case EVENT:
+            case GAME:
             case MOVIE:
             case TV:
                 ratio = 2f / 3f;

File: app/src/main/java/me/zhanghai/android/douya/item/ui/ItemCollectionActivity.java
Patch:
@@ -51,6 +51,7 @@ protected void onCreate(Bundle savedInstanceState) {
             case APP:
                 break;
             case BOOK:
+                themeRes = R.style.Theme_Douya_Book_DialogWhenLarge;
                 break;
             case EVENT:
                 break;

File: app/src/main/java/me/zhanghai/android/douya/item/ui/ItemCollectionFragment.java
Patch:
@@ -109,7 +109,7 @@ public ItemCollectionFragment() {}
 
     public static ItemCollectionFragment newInstance(CollectableItem item,
                                                      ItemCollectionState state) {
-        //noinnspection deprecation
+        //noinspection deprecation
         ItemCollectionFragment fragment = new ItemCollectionFragment();
         Bundle arguments = FragmentUtils.ensureArguments(fragment);
         arguments.putParcelable(EXTRA_ITEM, item);

File: app/src/main/java/me/zhanghai/android/douya/functional/ObjectsCompat.java
Patch:
@@ -3,7 +3,7 @@
  * All Rights Reserved.
  */
 
-package me.zhanghai.android.douya.util;
+package me.zhanghai.android.douya.functional;
 
 import java.util.Objects;
 

File: app/src/main/java/me/zhanghai/android/douya/functional/compat/Predicate.java
Patch:
@@ -26,6 +26,8 @@
 
 import java.util.Objects;
 
+import me.zhanghai.android.douya.functional.ObjectsCompat;
+
 /**
  * Represents a predicate (boolean-valued function) of one argument.
  *
@@ -113,7 +115,7 @@ default Predicate<T> or(Predicate<? super T> other) {
      */
     static <T> Predicate<T> isEqual(Object targetRef) {
         return (null == targetRef)
-                ? Objects::isNull
+                ? ObjectsCompat::isNull
                 : object -> targetRef.equals(object);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/item/ui/TrackListAdapter.java
Patch:
@@ -60,10 +60,10 @@ public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
         if (!isTrackActive) {
             holder.numberText.setText(String.valueOf(position + 1));
         }
+        boolean isTrackPlaying = isTrackActive && service.isPlaying();
         if (isTrackActive) {
             PlayPauseDrawable playPauseDrawable = (PlayPauseDrawable)
                     holder.playPauseImage.getDrawable();
-            boolean isTrackPlaying = service.isPlaying();
             playPauseDrawable.setNextState(isTrackPlaying ? PlayPauseDrawable.State.Pause
                     : PlayPauseDrawable.State.Play);
         }
@@ -78,8 +78,8 @@ public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
                 R.attr.colorControlActivated : android.R.attr.textColorSecondary,
                 holder.durationText.getContext()));
         if (!TextUtils.isEmpty(track.previewUrl)) {
-            holder.itemView.setOnClickListener(view -> PlayMusicService.start(mMusic, position,
-                    view.getContext()));
+            holder.itemView.setOnClickListener(view ->
+                    PlayMusicService.start(mMusic, position, !isTrackPlaying, view.getContext()));
         }
     }
 

File: app/src/main/java/me/zhanghai/android/douya/media/PlayMusicService.java
Patch:
@@ -131,6 +131,8 @@ public void onDestroy() {
         mMediaPlayback.release();
 
         sInstance = null;
+
+        EventBusUtils.postAsync(new MusicPlayingStateChangedEvent(PlayMusicService.this));
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/util/DrawableUtils.java
Patch:
@@ -33,7 +33,7 @@ public static Drawable makeScrimDrawable(int baseColor, int numStops, int gravit
         int blue = Color.blue(baseColor);
         int alpha = Color.alpha(baseColor);
 
-        for (int i = 0; i < numStops; i++) {
+        for (int i = 0; i < numStops; ++i) {
             float x = i * 1f / (numStops - 1);
             float opacity = MathUtils.constrain((float) Math.pow(x, 3), 0, 1);
             stopColors[i] = Color.argb((int) (alpha * opacity), red, green, blue);

File: app/src/main/java/me/zhanghai/android/douya/app/Notifications.java
Patch:
@@ -17,7 +17,7 @@ interface SEND_BROADCAST {
             String ID = "send_broadcast";
             int NAME_RES = R.string.notification_channel_send_broadcast_name;
             int DESCRIPTION_RES = R.string.notification_channel_send_broadcast_description;
-            int IMPORTANCE = NotificationManagerCompat.IMPORTANCE_DEFAULT;
+            int IMPORTANCE = NotificationManagerCompat.IMPORTANCE_LOW;
         }
 
         interface PLAY_MUSIC {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/SendBroadcastWriter.java
Patch:
@@ -197,7 +197,7 @@ private void createNotificationChannel() {
                 Notifications.Channels.SEND_BROADCAST.ID, channelName,
                 Notifications.Channels.SEND_BROADCAST.IMPORTANCE);
         String channelDescription = context.getString(
-                Notifications.Channels.PLAY_MUSIC.DESCRIPTION_RES);
+                Notifications.Channels.SEND_BROADCAST.DESCRIPTION_RES);
         channel.setDescription(channelDescription);
         NotificationManager notificationManager = (NotificationManager)
                 context.getSystemService(Context.NOTIFICATION_SERVICE);

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/SendBroadcastFragment.java
Patch:
@@ -518,10 +518,10 @@ private void updateSendStatus() {
         getActivity().setTitle(sending ? R.string.broadcast_send_title_sending
                 : R.string.broadcast_send_title);
         boolean enabled = !sending;
-        mTextEdit.setEnabled(enabled);
         if (mSendMenuItem != null) {
             mSendMenuItem.setEnabled(enabled);
         }
+        mTextEdit.setEnabled(enabled);
         if (sending) {
             mTextEdit.setText(manager.getText(mWriterId));
         }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastLikerListResource.java
Patch:
@@ -9,12 +9,9 @@
 import android.support.v4.app.Fragment;
 import android.support.v4.app.FragmentActivity;
 
-import java.util.List;
-
 import me.zhanghai.android.douya.network.api.ApiError;
 import me.zhanghai.android.douya.network.api.ApiRequest;
 import me.zhanghai.android.douya.network.api.ApiService;
-import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 import me.zhanghai.android.douya.network.api.info.frodo.BroadcastLikerList;
 import me.zhanghai.android.douya.user.content.BaseUserListResource;
 import me.zhanghai.android.douya.util.FragmentUtils;

File: app/src/main/java/me/zhanghai/android/douya/account/content/AccountUserResource.java
Patch:
@@ -37,9 +37,9 @@ public static AccountUserResource attachTo(Account account, Fragment fragment, S
         AccountUserResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(account);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/account/content/AuthenticateRequest.java
Patch:
@@ -26,9 +26,9 @@ public static AuthenticateRequest attachTo(Fragment fragment, String tag, int re
         if (instance == null) {
             //noinspection deprecation
             instance = new AuthenticateRequest();
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/ApiV2BroadcastListResource.java
Patch:
@@ -44,9 +44,9 @@ public static ApiV2BroadcastListResource attachTo(String userIdOrUid, String top
         ApiV2BroadcastListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(userIdOrUid, topic);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastAndCommentListResource.java
Patch:
@@ -49,9 +49,9 @@ public static BroadcastAndCommentListResource attachTo(long broadcastId, Broadca
         BroadcastAndCommentListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(broadcastId, broadcast);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastCommentListResource.java
Patch:
@@ -41,9 +41,9 @@ public static BroadcastCommentListResource attachTo(long broadcastId, Fragment f
         BroadcastCommentListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(broadcastId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastLikerListResource.java
Patch:
@@ -40,9 +40,9 @@ public static BroadcastLikerListResource attachTo(long broadcastId, Fragment fra
         BroadcastLikerListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(broadcastId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastRebroadcastedBroadcastListResource.java
Patch:
@@ -40,9 +40,9 @@ public static BroadcastRebroadcastedBroadcastListResource attachTo(long broadcas
                 tag);
         if (instance == null) {
             instance = newInstance(broadcastId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastResource.java
Patch:
@@ -50,9 +50,9 @@ public static BroadcastResource attachTo(long broadcastId, Broadcast broadcast,
         BroadcastResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(broadcastId, broadcast);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/HomeBroadcastListResource.java
Patch:
@@ -45,9 +45,9 @@ public static HomeBroadcastListResource attachTo(Fragment fragment, String tag,
         HomeBroadcastListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance();
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/TimelineBroadcastListResource.java
Patch:
@@ -55,9 +55,9 @@ public static TimelineBroadcastListResource attachTo(String userIdOrUid, String
         TimelineBroadcastListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(userIdOrUid, topic);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/diary/content/UserDiaryListResource.java
Patch:
@@ -47,9 +47,9 @@ public static UserDiaryListResource attachTo(String userIdOrUid, Fragment fragme
         UserDiaryListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(userIdOrUid);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/doulist/content/ItemRelatedDoulistListResource.java
Patch:
@@ -41,9 +41,9 @@ public static ItemRelatedDoulistListResource attachTo(CollectableItem.Type itemT
         ItemRelatedDoulistListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(itemType, itemId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/doumail/content/NotificationCountResource.java
Patch:
@@ -41,9 +41,9 @@ public static NotificationCountResource attachTo(Fragment fragment, String tag,
         NotificationCountResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance();
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/followship/content/FollowerListResource.java
Patch:
@@ -28,9 +28,9 @@ public static FollowerListResource attachTo(String userIdOrUid, Fragment fragmen
         FollowerListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(userIdOrUid);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/followship/content/FollowingListResource.java
Patch:
@@ -28,9 +28,9 @@ public static FollowingListResource attachTo(String userIdOrUid, Fragment fragme
         FollowingListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(userIdOrUid);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/CelebrityListResource.java
Patch:
@@ -44,9 +44,9 @@ public static CelebrityListResource attachTo(CollectableItem.Type itemType, long
         CelebrityListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(itemType, itemId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/ItemAwardListResource.java
Patch:
@@ -45,9 +45,9 @@ public static ItemAwardListResource attachTo(CollectableItem.Type itemType, long
         ItemAwardListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(itemType, itemId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/ItemCollectionListResource.java
Patch:
@@ -55,9 +55,9 @@ public static ItemCollectionListResource attachTo(CollectableItem.Type itemType,
         ItemCollectionListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(itemType, itemId, followingsFirst);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/ItemForumTopicListResource.java
Patch:
@@ -49,9 +49,9 @@ public static ItemForumTopicListResource attachTo(CollectableItem.Type itemType,
         ItemForumTopicListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(itemType, itemId, episode);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/ItemRecommendationListResource.java
Patch:
@@ -45,9 +45,9 @@ public static ItemRecommendationListResource attachTo(CollectableItem.Type itemT
         ItemRecommendationListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(itemType, itemId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/MovieFragmentResource.java
Patch:
@@ -40,9 +40,9 @@ public static MovieFragmentResource attachTo(long movieId, SimpleMovie simpleMov
         MovieFragmentResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(movieId, simpleMovie, movie);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/MovieResource.java
Patch:
@@ -31,9 +31,9 @@ public static MovieResource attachTo(long movieId, SimpleMovie simpleMovie, Movi
         MovieResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(movieId, simpleMovie, movie);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/MusicFragmentResource.java
Patch:
@@ -40,9 +40,9 @@ public static MusicFragmentResource attachTo(long musicId, SimpleMusic simpleMus
         MusicFragmentResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(musicId, simpleMusic, music);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/MusicResource.java
Patch:
@@ -31,9 +31,9 @@ public static MusicResource attachTo(long musicId, SimpleMusic simpleMusic, Musi
         MusicResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(musicId, simpleMusic, music);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/RatingResource.java
Patch:
@@ -40,9 +40,9 @@ public static RatingResource attachTo(CollectableItem.Type itemType, long itemId
         RatingResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(itemType, itemId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/notification/content/NotificationListResource.java
Patch:
@@ -52,9 +52,9 @@ public static NotificationListResource attachTo(Fragment fragment, String tag,
         NotificationListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance();
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/photo/content/ItemPhotoListResource.java
Patch:
@@ -38,9 +38,9 @@ public static ItemPhotoListResource attachTo(CollectableItem.Type itemType, long
         ItemPhotoListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(itemType, itemId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/profile/content/ProfileResource.java
Patch:
@@ -68,9 +68,9 @@ public static ProfileResource attachTo(
         ProfileResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(userIdOrUid, simpleUser, user);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/profile/content/UserItemListResource.java
Patch:
@@ -41,9 +41,9 @@ public static UserItemListResource attachTo(String userIdOrUid, Fragment fragmen
         UserItemListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(userIdOrUid);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/review/content/ItemReviewListResource.java
Patch:
@@ -38,9 +38,9 @@ public static ItemReviewListResource attachTo(CollectableItem.Type itemType, lon
         ItemReviewListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(itemType, itemId);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/review/content/UserReviewListResource.java
Patch:
@@ -35,9 +35,9 @@ public static UserReviewListResource attachTo(String userIdOrUid, Fragment fragm
         UserReviewListResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(userIdOrUid);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/user/content/UserResource.java
Patch:
@@ -50,9 +50,9 @@ public static UserResource attachTo(String userIdOrUid, SimpleUser simpleUser, U
         UserResource instance = FragmentUtils.findByTag(activity, tag);
         if (instance == null) {
             instance = newInstance(userIdOrUid, simpleUser, user);
-            instance.targetAt(fragment, requestCode);
             FragmentUtils.add(instance, activity, tag);
         }
+        instance.targetAt(fragment, requestCode);
         return instance;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/main/ui/MainActivity.java
Patch:
@@ -193,9 +193,9 @@ public void reloadForActiveAccountChange() {
         if (mDoumailUnreadCountFragment != null) {
             FragmentUtils.remove(mDoumailUnreadCountFragment);
         }
-        FragmentUtils.execPendingTransactions(this);
+        FragmentUtils.executePendingTransactions(this);
         addFragments();
-        FragmentUtils.execPendingTransactions(this);
+        FragmentUtils.executePendingTransactions(this);
     }
 
     private void addFragments() {

File: app/src/main/java/me/zhanghai/android/douya/util/FragmentUtils.java
Patch:
@@ -176,11 +176,11 @@ public static void replace(Fragment fragment, Fragment parentFragment) {
         replace(fragment, parentFragment.getChildFragmentManager(), null);
     }
 
-    public static void execPendingTransactions(FragmentActivity activity) {
+    public static void executePendingTransactions(FragmentActivity activity) {
         activity.getSupportFragmentManager().executePendingTransactions();
     }
 
-    public static void execPendingTransactions(Fragment fragment) {
+    public static void executePendingTransactions(Fragment fragment) {
         fragment.getFragmentManager().executePendingTransactions();
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/media/MediaPlayback.java
Patch:
@@ -46,7 +46,8 @@ public MediaPlayback(
         mPlayer.addListener(new Player.DefaultEventListener() {
             @Override
             public void onPlayerStateChanged(boolean playWhenReady, int playbackState) {
-                if (playbackState == Player.STATE_ENDED && getRepeatMode() == Player.REPEAT_MODE_OFF
+                if (playWhenReady && playbackState == Player.STATE_ENDED
+                        && getRepeatMode() == Player.REPEAT_MODE_OFF
                         && getActiveQueueItemIndex() == getQueueSize() - 1) {
                     pause();
                     skipToQueueItem(0);

File: app/src/main/java/me/zhanghai/android/douya/item/ui/MusicIntroductionFragment.java
Patch:
@@ -33,7 +33,6 @@ protected List<Pair<String, String>> makeInformationData() {
         addTextListToData(R.string.item_introduction_music_artist, mItem.getArtistNames(), data);
         addTextListToData(R.string.item_introduction_music_genres, mItem.genres, data);
         addTextListToData(R.string.item_introduction_music_types, mItem.types, data);
-        addTextListToData(R.string.item_introduction_music_release_dates, mItem.releaseDates, data);
         addTextListToData(R.string.item_introduction_music_media, mItem.media, data);
         addTextListToData(R.string.item_introduction_music_release_dates, mItem.releaseDates, data);
         addTextListToData(R.string.item_introduction_music_publisher, mItem.publishers, data);

File: app/src/main/java/me/zhanghai/android/douya/item/ui/BaseItemFragment.java
Patch:
@@ -167,6 +167,7 @@ public void onScrolled(RecyclerView recyclerView, int dx, int dy) {
                 }
                 // FIXME: Animate out backdrop layout later.
                 mBackdropLayout.setTranslationY((float) -mScrollY / 2);
+                mBackdropScrim.setTranslationY((float) mScrollY / 2);
             }
         });
         int colorPrimaryDark = ViewUtils.getColorFromAttrRes(R.attr.colorPrimaryDark, 0, activity);

File: app/src/main/java/me/zhanghai/android/douya/calendar/app/CalendarAppWidgetProvider.java
Patch:
@@ -35,7 +35,7 @@ public void onUpdate(Context context, AppWidgetManager appWidgetManager, int[] a
         views.setTextColor(R.id.day_of_month, calendarDay.getDayOfMonthColor(context));
         views.setTextViewText(R.id.comment, calendarDay.comment);
         PendingIntent moviePendingIntent = PendingIntent.getActivity(context,
-                calendarDay.url.hashCode(), UriHandlerActivity.makeIntent(context),
+                calendarDay.url.hashCode(), UriHandlerActivity.makeIntent(calendarDay.url, context),
                 PendingIntent.FLAG_UPDATE_CURRENT);
         views.setOnClickPendingIntent(R.id.movie, moviePendingIntent);
         views.setTextViewText(R.id.title, calendarDay.getTitleText(context));

File: app/src/main/java/me/zhanghai/android/douya/item/ui/BaseItemDataAdapter.java
Patch:
@@ -176,7 +176,8 @@ protected void bindItemCollectionHolder(RecyclerView.ViewHolder holder, T item)
             context.startActivity(ItemCollectionActivity.makeIntent(item, ItemCollectionState.TODO,
                     context));
         });
-        boolean doingVisible = itemCollection == null || state == ItemCollectionState.TODO;
+        boolean doingVisible = item.getType().hasDoingState() && (itemCollection == null
+                || state == ItemCollectionState.TODO);
         ViewUtils.setVisibleOrGone(itemCollectionHolder.doingButton, doingVisible);
         itemCollectionHolder.doingButton.setOnClickListener(view -> {
             Context context = view.getContext();

File: app/src/main/java/me/zhanghai/android/douya/item/ui/ItemActivities.java
Patch:
@@ -18,9 +18,6 @@ public class ItemActivities {
     private ItemActivities() {}
 
     public static Intent makeIntent(CollectableItem item, Context context) {
-        if (!BuildConfig.DEBUG) {
-            return null;
-        }
         if (item instanceof Movie) {
             return MovieActivity.makeIntent((Movie) item, context);
         } else if (item instanceof SimpleMovie) {

File: app/src/main/java/me/zhanghai/android/douya/item/content/BaseItemResource.java
Patch:
@@ -150,6 +150,7 @@ public void onItemCollected(ItemCollectedEvent event) {
         if (event.itemType == item.getType() && event.itemId == item.id) {
             item.collection = event.collection;
             getListener().onItemChanged(getRequestCode(), item);
+            getListener().onItemCollectionChanged(getRequestCode());
         }
     }
 
@@ -164,6 +165,7 @@ public void onItemUncollected(ItemUncollectedEvent event) {
         if (event.itemType == item.getType() && event.itemId == item.id) {
             item.collection = null;
             getListener().onItemChanged(getRequestCode(), item);
+            getListener().onItemCollectionChanged(getRequestCode());
         }
     }
 
@@ -177,5 +179,6 @@ public interface Listener<ItemType> {
         void onLoadItemFinished(int requestCode);
         void onLoadItemError(int requestCode, ApiError error);
         void onItemChanged(int requestCode, ItemType newItem);
+        void onItemCollectionChanged(int requestCode);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/item/content/MovieFragmentResource.java
Patch:
@@ -71,7 +71,7 @@ protected BaseItemResource<SimpleMovie, Movie> onAttachItemResource(long itemId,
     }
 
     @Override
-    protected CollectableItem.Type getItemType() {
+    protected CollectableItem.Type getDefaultItemType() {
         return CollectableItem.Type.MOVIE;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/item/content/MovieResource.java
Patch:
@@ -49,7 +49,7 @@ public static MovieResource attachTo(long movieId, SimpleMovie simpleMovie, Movi
     public MovieResource() {}
 
     @Override
-    protected CollectableItem.Type getItemType() {
+    protected CollectableItem.Type getDefaultItemType() {
         return CollectableItem.Type.MOVIE;
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/network/api/util/InterceptorUtils.java
Patch:
@@ -30,7 +30,9 @@ public static void addParameters(Request.Builder builder, Request request,
         if (!HttpMethod.requiresRequestBody(method)) {
             HttpUrl.Builder urlBuilder = request.url().newBuilder();
             for (Map.Entry<String, String> parameter : parameters.entrySet()) {
-                urlBuilder.addQueryParameter(parameter.getKey(), parameter.getValue());
+                String parameterName = parameter.getKey();
+                urlBuilder.removeAllQueryParameters(parameterName);
+                urlBuilder.addQueryParameter(parameterName, parameter.getValue());
             }
             builder.url(urlBuilder.build());
         } else {

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiContract.java
Patch:
@@ -40,7 +40,7 @@ interface Frodo {
             String API_HOST = "https://frodo.douban.com/api/v2/";
 
             // API protocol version is derived from user agent string.
-            String USER_AGENT = "api-client/1 com.douban.frodo/5.22.0(129) Android/" +
+            String USER_AGENT = "api-client/1 com.douban.frodo/5.23.0(130) Android/" +
                     Build.VERSION.SDK_INT+ " product/" + Build.PRODUCT + " vendor/" +
                     // Sorry Frodo, but we don't want to hold ACCESS_NETWORK_STATE.
                     Build.MANUFACTURER + " model/" + Build.MODEL + "  rom/android  network/wifi";

File: app/src/main/java/me/zhanghai/android/douya/item/ui/BaseItemDataAdapter.java
Patch:
@@ -211,22 +211,22 @@ protected void bindIntroductionHolder(RecyclerView.ViewHolder holder, T item) {
     protected void bindPhotoListHolder(RecyclerView.ViewHolder holder, T item,
                                        List<Photo> photoList, boolean excludeFirstPhoto) {
         PhotoListHolder photoListHolder = (PhotoListHolder) holder;
+        List<Photo> originalPhotoList = photoList;
         if (excludeFirstPhoto) {
             photoList = photoList.subList(1, photoList.size());
         }
         ViewUtils.setVisibleOrGone(photoListHolder.photoList, !photoList.isEmpty());
         HorizontalImageAdapter adapter = (HorizontalImageAdapter)
                 photoListHolder.photoList.getAdapter();
         adapter.replace(photoList);
-        List<Photo> finalPhotoList = photoList;
         Context context = RecyclerViewUtils.getContext(holder);
         adapter.setOnItemClickListener((parent, itemView, item_, photoPosition) -> {
             if (excludeFirstPhoto) {
                 ++photoPosition;
             }
             // TODO: Use PhotoAlbumGalleryActivity instead.
-            context.startActivity(GalleryActivity.makeImageListIntent(finalPhotoList, photoPosition,
-                    context));
+            context.startActivity(GalleryActivity.makeImageListIntent(originalPhotoList,
+                    photoPosition, context));
         });
         photoListHolder.viewMoreButton.setOnClickListener(view -> {
             // TODO

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiContract.java
Patch:
@@ -44,13 +44,12 @@ interface Frodo {
                     + Build.VERSION.SDK_INT+ " " + Build.PRODUCT + " " + Build.MANUFACTURER + " "
                     + Build.MODEL + "  rom:android";
 
-            String API_KEY = "apiKey";
-            String UDID = "udid";
-            String DEVICE_ID = "device_id";
+            String API_KEY = "apikey";
             String CHANNEL = "channel";
             interface Channels {
                 String DOUBAN = "Douban";
             }
+            String UDID = "udid";
             String OS_ROM = "os_rom";
 
             List<String> SIGNATURE_HOSTS = Arrays.asList("frodo.douban.com", "api.douban.com");

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiContract.java
Patch:
@@ -89,6 +89,7 @@ interface Custom {
                     int INVALID_ERROR_RESPONSE = -1;
                 }
                 interface Base {
+                    int INVALID_REQUEST_997 = 997;
                     int UNKNOWN_V2_ERROR = 999;
                     int NEED_PERMISSION = 1000;
                     int URI_NOT_FOUND = 1001;

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiError.java
Patch:
@@ -33,6 +33,8 @@ public class ApiError extends Throwable {
         ERROR_CODE_STRING_RES_MAP.put(Custom.INVALID_ERROR_RESPONSE,
                 R.string.api_error_invalid_error_response);
 
+        ERROR_CODE_STRING_RES_MAP.put(Base.INVALID_REQUEST_997,
+                R.string.api_error_invalid_request_997);
         ERROR_CODE_STRING_RES_MAP.put(Base.UNKNOWN_V2_ERROR, R.string.api_error_unknown_v2_error);
         ERROR_CODE_STRING_RES_MAP.put(Base.NEED_PERMISSION, R.string.api_error_need_permission);
         ERROR_CODE_STRING_RES_MAP.put(Base.URI_NOT_FOUND, R.string.api_error_uri_not_found);

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileFragment.java
Patch:
@@ -176,10 +176,10 @@ public void onExitAnimationEnd() {
         }
         mAdapter = new ProfileAdapter(this);
         mContentList.setAdapter(mAdapter);
+
+        mContentStateLayout.setLoading();
         if (mResource.isAnyLoaded()) {
             mResource.notifyChangedIfLoaded();
-        } else {
-            mContentStateLayout.setLoading();
         }
     }
 

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileDataAdapter.java
Patch:
@@ -118,7 +118,7 @@ public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
             default:
                 throw new IllegalArgumentException();
         }
-        return new ViewHolder(ViewUtils.inflate(layoutRes, parent));
+        return new ViewHolder(ViewUtils.inflateWithTheme(layoutRes, parent, R.style.Theme_Douya));
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/item/ui/MovieFragment.java
Patch:
@@ -31,11 +31,11 @@
 public class MovieFragment extends BaseItemFragment<SimpleMovie, Movie>
         implements MovieFragmentResource.Listener {
 
+    private MovieAdapter mAdapter;
+
     private boolean mBackdropBound;
     private boolean mExcludeFirstPhoto;
 
-    private MovieAdapter mAdapter;
-
     public static MovieFragment newInstance(long movieId, SimpleMovie simpleMovie, Movie movie) {
         //noinspection deprecation
         MovieFragment fragment = new MovieFragment();

File: app/src/main/java/me/zhanghai/android/douya/item/ui/ItemContentRecyclerView.java
Patch:
@@ -97,7 +97,7 @@ public boolean onTouchEvent(MotionEvent event) {
             mBackdropWrapper.dispatchTouchEvent(event);
         } else {
             int oldAction = event.getAction();
-            event.setAction(MotionEvent.ACTION_CANCEL);
+            event.setAction(MotionEvent.ACTION_CANCEL | (oldAction & ~MotionEvent.ACTION_MASK));
             mBackdropWrapper.dispatchTouchEvent(event);
             event.setAction(oldAction);
         }

File: app/src/main/java/me/zhanghai/android/douya/ui/DispatchTouchEventToParentNestedRecyclerView.java
Patch:
@@ -38,7 +38,7 @@ public boolean onTouchEvent(MotionEvent event) {
             ((View) getParent()).onTouchEvent(event);
         } else {
             int oldAction = event.getAction();
-            event.setAction(MotionEvent.ACTION_CANCEL);
+            event.setAction(MotionEvent.ACTION_CANCEL | (oldAction & ~MotionEvent.ACTION_MASK));
             ((View) getParent()).onTouchEvent(event);
             event.setAction(oldAction);
         }

File: app/src/main/java/me/zhanghai/android/douya/item/ui/MovieFragment.java
Patch:
@@ -133,6 +133,9 @@ private void update(Movie movie, Rating rating, List<Photo> photoList,
         mAdapter.setData(new MovieDataAdapter.Data(movie, rating, photoList, mExcludeFirstPhoto,
                 celebrityList, awardList, itemCollectionList, reviewList, forumTopicList,
                 recommendationList, relatedDoulistList));
+        if (mAdapter.getItemCount() > 0) {
+            mContentStateLayout.setLoaded(true);
+        }
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileFragment.java
Patch:
@@ -277,7 +277,9 @@ public void onChanged(int requestCode, User newUser, List<Broadcast> newBroadcas
                           List<UserItems> newUserItemList, List<SimpleReview> newReviewList) {
         mAdapter.setData(new ProfileDataAdapter.Data(newUser, newBroadcastList, newFollowingList,
                 newDiaryList, newUserItemList, newReviewList));
-        mContentStateLayout.setLoaded(mAdapter.getItemCount() > 0);
+        if (mAdapter.getItemCount() > 0) {
+            mContentStateLayout.setLoaded(true);
+        }
         updateOptionsMenu();
     }
 

File: app/src/main/java/me/zhanghai/android/douya/util/ViewUtils.java
Patch:
@@ -99,7 +99,7 @@ public static void fadeIn(View view, int duration) {
                     .start();
             return;
         }
-        view.setAlpha(0);
+        view.setAlpha(isVisible(view) ? view.getAlpha() : 0);
         view.setVisibility(View.VISIBLE);
         view.animate()
                 .alpha(1)

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/TimelineBroadcastListResource.java
Patch:
@@ -131,6 +131,9 @@ private void onLoadFinished(boolean more, int count, boolean successful,
             for (Broadcast broadcast : response) {
                 EventBusUtils.postAsync(new BroadcastUpdatedEvent(broadcast, this));
             }
+            // Frodo API is sometimes buggy that broadcast list size may not be count. In this case,
+            // we simply load more until no more broadcast is returned.
+            setCanLoadMore(count == 0 || response.size() > 0);
         } else {
             getListener().onLoadBroadcastListFinished(getRequestCode());
             getListener().onLoadBroadcastListError(getRequestCode(), error);

File: app/src/main/java/me/zhanghai/android/douya/main/ui/MainActivity.java
Patch:
@@ -129,9 +129,10 @@ public boolean onCreateOptionsMenu(Menu menu) {
         getMenuInflater().inflate(R.menu.main, menu);
         mNotificationMenuItem = menu.findItem(R.id.action_notification);
         ActionItemBadge.setup(mNotificationMenuItem, R.drawable.notifications_icon_white_24dp,
-                mNotificationListFragment.getUnreadNotificationCount(), this);
+                mNotificationListFragment.getUnreadCount(), this);
         mDoumailMenuItem = menu.findItem(R.id.action_doumail);
-        ActionItemBadge.setup(mDoumailMenuItem, R.drawable.mail_icon_white_24dp, 0, this);
+        ActionItemBadge.setup(mDoumailMenuItem, R.drawable.mail_icon_white_24dp,
+                mDoumailUnreadCountFragment.getUnreadCount(), this);
         return true;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/main/ui/MainActivity.java
Patch:
@@ -100,6 +100,8 @@ protected void onCreate(Bundle savedInstanceState) {
         } else {
             mMainFragment = FragmentUtils.findById(this, R.id.container);
             mNotificationListFragment = FragmentUtils.findById(this, R.id.notification_list_drawer);
+            mDoumailUnreadCountFragment = FragmentUtils.findByTag(this,
+                    FRAGMENT_TAG_DOUMAIL_UNREAD_COUNT);
         }
     }
 

File: app/src/main/java/me/zhanghai/android/douya/main/ui/MainActivity.java
Patch:
@@ -184,6 +184,7 @@ public DrawerLayout getDrawer() {
     public void reloadForActiveAccountChange() {
         FragmentUtils.remove(mMainFragment);
         FragmentUtils.remove(mNotificationListFragment);
+        FragmentUtils.remove(mDoumailUnreadCountFragment);
         FragmentUtils.execPendingTransactions(this);
         addFragments();
         FragmentUtils.execPendingTransactions(this);

File: app/src/main/java/me/zhanghai/android/douya/DouyaApplication.java
Patch:
@@ -40,7 +40,9 @@ public void onCreate() {
         Stetho.initializeWithDefaults(this);
 
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
-            WebView.setWebContentsDebuggingEnabled(BuildConfig.DEBUG);
+            if (BuildConfig.DEBUG) {
+                WebView.setWebContentsDebuggingEnabled(true);
+            }
         }
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/SendBroadcastActivity.java
Patch:
@@ -49,7 +49,7 @@ public static Intent makeIntent(String text, List<Uri> imageUris,
     }
 
     public static Intent makeTopicIntent(String topic, Context context) {
-        String text = !TextUtils.isEmpty(topic) ? DoubanUtils.makeTopicString(topic) : null;
+        String text = !TextUtils.isEmpty(topic) ? DoubanUtils.makeTopicBroadcastText(topic) : null;
         return makeIntent(text, context);
     }
 

File: app/src/main/java/me/zhanghai/android/douya/util/DoubanUtils.java
Patch:
@@ -75,8 +75,7 @@ public static void addMentionString(EditText editText) {
         int selectionEnd = editText.getSelectionEnd();
         int mentionStart;
         int mentionEnd;
-        if (selectionStart != selectionEnd && selectionStart > 0
-                && editable.charAt(selectionStart - 1) == '@') {
+        if (selectionStart > 0 && editable.charAt(selectionStart - 1) == '@') {
             mentionStart = selectionStart - 1;
             mentionEnd = selectionEnd;
             padSpaceAround(editText, mentionStart, mentionEnd);

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/SendBroadcastActivity.java
Patch:
@@ -63,8 +63,10 @@ protected void onCreate(Bundle savedInstanceState) {
         if (savedInstanceState == null) {
             Intent intent = getIntent();
             String text;
+            boolean allowUrlFromText = true;
             if (intent.hasExtra(EXTRA_TEXT)) {
                 text = intent.getStringExtra(EXTRA_TEXT);
+                allowUrlFromText = false;
             } else if (intent.hasExtra(Intent.EXTRA_TEXT)) {
                 ArrayList<CharSequence> textList = intent.getCharSequenceArrayListExtra(
                         Intent.EXTRA_TEXT);
@@ -94,7 +96,7 @@ protected void onCreate(Bundle savedInstanceState) {
             SendBroadcastFragment.LinkInfo linkInfo;
             if (intent.hasExtra(EXTRA_LINK_INFO)) {
                 linkInfo = intent.getParcelableExtra(EXTRA_LINK_INFO);
-            } else if (UrlUtils.isValidUrl(text)) {
+            } else if (allowUrlFromText && UrlUtils.isValidUrl(text)) {
                 linkInfo = new SendBroadcastFragment.LinkInfo(text);
                 text = null;
             } else {

File: app/src/main/java/me/zhanghai/android/douya/ui/HorizontalUploadImageAdapter.java
Patch:
@@ -48,7 +48,7 @@ public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
         holder.uploadImageLayout.loadImage(getItem(position));
         holder.uploadImageLayout.setRemoveButtonOnClickListener(view -> {
             if (mOnRemoveImageListener != null) {
-                mOnRemoveImageListener.onRemoveImage(position);
+                mOnRemoveImageListener.onRemoveImage(holder.getAdapterPosition());
             }
         });
     }

File: app/src/main/java/me/zhanghai/android/douya/app/Notifications.java
Patch:
@@ -16,7 +16,7 @@ interface Channels {
         interface SEND_BROADCAST {
             String ID = "send_broadcast";
             int NAME_RES = R.string.notification_channel_send_broadcast_name;
-            int IMPORTANCE = NotificationManagerCompat.IMPORTANCE_LOW;
+            int IMPORTANCE = NotificationManagerCompat.IMPORTANCE_DEFAULT;
         }
     }
 

File: app/src/main/java/me/zhanghai/android/douya/gallery/ui/GalleryFragment.java
Patch:
@@ -186,6 +186,9 @@ public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {
     }
 
     private void updateOptionsMenu() {
+        if (mSaveMenuItem == null || mShareMenuItem == null) {
+            return;
+        }
         boolean hasFile = mAdapter.getFile(mViewPager.getCurrentItem()) != null;
         mSaveMenuItem.setEnabled(hasFile);
         mShareMenuItem.setEnabled(hasFile);

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/SendBroadcastFragment.java
Patch:
@@ -267,7 +267,7 @@ private void onImagePickedOrCaptured(int resultCode, Intent data) {
         }
         List<Uri> uris = parsePickOrCaptureImageResult(data);
         mCaptureImageOutputFile = null;
-        boolean appendingImages = !uris.isEmpty();
+        boolean appendingImages = !mImageUris.isEmpty();
         mImageUris.addAll(uris);
         mAttachmentLayout.bind(null, mImageUris, appendingImages);
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastLikerListResource.java
Patch:
@@ -80,6 +80,6 @@ protected ApiRequest<BroadcastLikerList> onCreateRequest(Integer start, Integer
     @Override
     protected void onCallRawLoadFinished(boolean more, int count, boolean successful,
                                          BroadcastLikerList response, ApiError error) {
-        onRawLoadFinished(more, count, successful, response.likers, error);
+        onRawLoadFinished(more, count, successful, successful ? response.likers : null, error);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/ui/WebViewActivity.java
Patch:
@@ -56,6 +56,7 @@
 import me.zhanghai.android.douya.util.AppUtils;
 import me.zhanghai.android.douya.util.ArrayUtils;
 import me.zhanghai.android.douya.util.ClipboardUtils;
+import me.zhanghai.android.douya.util.CollectionUtils;
 import me.zhanghai.android.douya.util.NightModeHelper;
 import me.zhanghai.android.douya.util.ShareUtils;
 import me.zhanghai.android.douya.util.StringUtils;
@@ -498,7 +499,8 @@ private void updateUserAgent() {
 
     private String getDoubanDesktopSiteUrl(String url) {
         Uri uri = Uri.parse(url);
-        if (!TextUtils.equals(uri.getHost(), "m.douban.com")) {
+        if (!TextUtils.equals(uri.getHost(), "m.douban.com")
+                || TextUtils.equals(CollectionUtils.firstOrNull(uri.getPathSegments()), "page")) {
             return url;
         }
         return uri.buildUpon()

File: app/src/main/java/me/zhanghai/android/douya/ui/WebViewActivity.java
Patch:
@@ -598,8 +598,8 @@ public void openFileChooser(ValueCallback<Uri> uploadFile, String acceptType) {
                 mUploadFile.onReceiveValue(null);
             }
             mUploadFile = uploadFile;
-            startActivityForResult(WebViewUtils.createFileChooserIntent(acceptType),
-                    REQUEST_CODE_FILE_CHOOSER);
+            AppUtils.startActivityForResultWithChooser(WebViewUtils.createFileChooserIntent(
+                    acceptType), REQUEST_CODE_FILE_CHOOSER, WebViewActivity.this);
         }
 
         // For 16 <= API level <= 19.

File: app/src/main/java/me/zhanghai/android/douya/ui/WebViewActivity.java
Patch:
@@ -370,6 +370,9 @@ private void setupWebView() {
         webSettings.setBuiltInZoomControls(true);
         webSettings.setDisplayZoomControls(false);
         webSettings.setLoadWithOverviewMode(true);
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
+            webSettings.setMixedContentMode(WebSettings.MIXED_CONTENT_COMPATIBILITY_MODE);
+        }
         webSettings.setJavaScriptEnabled(true);
         initializeUserAgents();
         updateUserAgent();

File: app/src/main/java/me/zhanghai/android/douya/gallery/ui/GalleryFragment.java
Patch:
@@ -228,7 +228,7 @@ private void saveImage() {
                 PERMISSIONS_SAVE_IMAGE)) {
             OpenAppDetailsDialogFragment.show(
                     R.string.gallery_save_permission_permanently_denied_message,
-                    R.string.gallery_save_permission_permanently_denied_open_settings, this);
+                    R.string.open_settings, this);
         } else  {
             EffortlessPermissions.requestPermissions(this,
                     R.string.gallery_save_permission_request_message,

File: app/src/main/java/me/zhanghai/android/douya/util/WebViewUtils.java
Patch:
@@ -83,6 +83,6 @@ public static void download(String url, String userAgent, String contentDisposit
         DownloadManager downloadManager = (DownloadManager) context.getSystemService(
                 Context.DOWNLOAD_SERVICE);
         downloadManager.enqueue(request);
-        ToastUtils.show(R.string.downloading_file, context);
+        ToastUtils.show(R.string.webview_downloading, context);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastFragment.java
Patch:
@@ -562,8 +562,8 @@ public void deleteBroadcast() {
 
     private void onViewOnWeb() {
         //noinspection deprecation
-        startActivity(WebViewActivity.makeIntent(mBroadcastAndCommentListResource.getBroadcast(),
-                getActivity()));
+        startActivity(WebViewActivity.makeIntent(
+                mBroadcastAndCommentListResource.getEffectiveBroadcast(), getActivity()));
     }
 
     public void onFinish() {

File: app/src/main/java/me/zhanghai/android/douya/link/DoubanUriHandler.java
Patch:
@@ -36,7 +36,8 @@ public class DoubanUriHandler {
 
     private enum UriType {
 
-        USER_BROADCAST_LIST("people/*/statuses"),
+        // Not handling "people/*/statuses" because Frodo API cannot handle it.
+        USER_BROADCAST_LIST("people/#/statuses"),
         TOPIC_BROADCAST_LIST("update/topic/*"),
         // Handled below.
         //TOPIC_BROADCAST_LIST_FRODO(AUTHORITY_FRODO, "status/topic?name=*"),

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/RebroadcastBroadcastActivity.java
Patch:
@@ -35,7 +35,7 @@ public static Intent makeIntent(Broadcast broadcast, Context context) {
 
     public static Intent makeIntent(Broadcast broadcast, CharSequence text, Context context) {
         return makeIntent(broadcast, context)
-                .putExtra(Intent.EXTRA_TEXT, text);
+                .putExtra(EXTRA_TEXT, text);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/RebroadcastBroadcastFragment.java
Patch:
@@ -130,7 +130,9 @@ public void onActivityCreated(@Nullable Bundle savedInstanceState) {
         AppCompatActivity activity = (AppCompatActivity) getActivity();
         activity.setSupportActionBar(mToolbar);
 
-        mTextEdit.setText(mText);
+        if (savedInstanceState == null) {
+            mTextEdit.setText(mText);
+        }
         //noinspection deprecation
         if (mBroadcastResource.has()) {
             //noinspection deprecation

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/SendCommentActivity.java
Patch:
@@ -10,7 +10,6 @@
 import android.os.Bundle;
 import android.support.v7.app.AppCompatActivity;
 
-import me.zhanghai.android.douya.network.api.info.frodo.Broadcast;
 import me.zhanghai.android.douya.util.FragmentUtils;
 
 public class SendCommentActivity extends AppCompatActivity {
@@ -29,7 +28,7 @@ public static Intent makeIntent(long broadcastId, Context context) {
 
     public static Intent makeIntent(long broadcastId, CharSequence text, Context context) {
         return makeIntent(broadcastId, context)
-                .putExtra(Intent.EXTRA_TEXT, text);
+                .putExtra(EXTRA_TEXT, text);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/link/NotImplementedManager.java
Patch:
@@ -36,7 +36,7 @@ public static void sendBroadcast(String topic, Context context) {
                 && FrodoBridge.sendBroadcast(topic, context)) {
             return;
         }
-        UrlHandler.open("https://www.douban.com/#isay-cont", context);
+        UrlHandler.open("https://www.douban.com/#db-isay", context);
     }
 
     public static void showNotYetImplementedToast(Context context) {

File: app/src/main/java/me/zhanghai/android/douya/glide/DouyaGlideModule.java
Patch:
@@ -25,7 +25,7 @@ public boolean isManifestParsingEnabled() {
     public void applyOptions(Context context, GlideBuilder builder) {
          builder.setDefaultRequestOptions(new RequestOptions()
                  .format(DecodeFormat.PREFER_ARGB_8888)
-                 // Work around crash on Anroid O.
+                 // Work around crash on Android O.
                  // See https://github.com/bumptech/glide/issues/2309
                  .disallowHardwareConfig());
     }

File: app/src/main/java/me/zhanghai/android/douya/link/FrodoBridge.java
Patch:
@@ -116,11 +116,12 @@ private static Intent makeClassIntent(String className) {
                         FRODO_PACKAGE_NAME + className));
     }
 
+    // Different from AppUtils.startActivity(), this one won't show a toast when failed.
     private static boolean startActivity(Intent intent, Context context) {
         try {
             context.startActivity(intent);
             return true;
-        } catch (ActivityNotFoundException e) {
+        } catch (ActivityNotFoundException | IllegalArgumentException e) {
             return false;
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/util/WebViewUtils.java
Patch:
@@ -44,7 +44,7 @@ public static Intent createFileChooserIntent(
         boolean allowMultiple = fileChooserParams.getMode()
                 == WebChromeClient.FileChooserParams.MODE_OPEN_MULTIPLE;
         String[] acceptTypes = fileChooserParams.getAcceptTypes();
-        // Fix for WebView accept types bug.
+        // Work around for WebView accept types bug.
         if (acceptTypes != null && acceptTypes.length == 1 && acceptTypes[0].indexOf(',') != -1) {
             acceptTypes = acceptTypes[0].split(",");
         }

File: app/src/main/java/me/zhanghai/android/douya/account/ui/AuthenticatorFragment.java
Patch:
@@ -133,8 +133,7 @@ public void onActivityCreated(@Nullable Bundle savedInstanceState) {
         mPasswordEdit.setOnEditorActionListener(new TextView.OnEditorActionListener() {
             @Override
             public boolean onEditorAction(TextView textView, int id, KeyEvent keyEvent) {
-                if (id == R.id.ime_login || id == EditorInfo.IME_ACTION_DONE
-                        || id == EditorInfo.IME_NULL) {
+                if (id == EditorInfo.IME_ACTION_DONE || id == EditorInfo.IME_ACTION_UNSPECIFIED) {
                     authenticate();
                     return true;
                 }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/ApiV2BroadcastListResource.java
Patch:
@@ -102,16 +102,17 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean more, int count, boolean successful,
                                   List<Broadcast> response, ApiError error) {
-        getListener().onLoadBroadcastListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadBroadcastListFinished(getRequestCode());
                 getListener().onBroadcastListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 setAndNotifyListener(response, true);
             }
         } else {
+            getListener().onLoadBroadcastListFinished(getRequestCode());
             getListener().onLoadBroadcastListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BaseBroadcastListResource.java
Patch:
@@ -30,14 +30,15 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean more, int count, boolean successful,
                                   List<Broadcast> response, ApiError error) {
-        getListener().onLoadBroadcastListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadBroadcastListFinished(getRequestCode());
                 getListener().onBroadcastListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadBroadcastListFinished(getRequestCode());
                 getListener().onBroadcastListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
@@ -47,6 +48,7 @@ protected void onLoadFinished(boolean more, int count, boolean successful,
                 }
             }
         } else {
+            getListener().onLoadBroadcastListFinished(getRequestCode());
             getListener().onLoadBroadcastListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastResource.java
Patch:
@@ -172,12 +172,13 @@ protected void onLoadStarted() {
 
     @Override
     protected void onLoadFinished(boolean successful, Broadcast response, ApiError error) {
-        getListener().onLoadBroadcastFinished(getRequestCode());
         if (successful) {
             set(response);
+            getListener().onLoadBroadcastFinished(getRequestCode());
             getListener().onBroadcastChanged(getRequestCode(), response);
             EventBusUtils.postAsync(new BroadcastUpdatedEvent(response, this));
         } else {
+            getListener().onLoadBroadcastFinished(getRequestCode());
             getListener().onLoadBroadcastError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/CommentListResource.java
Patch:
@@ -33,18 +33,20 @@ protected void onLoadFinished(boolean more, int count, boolean successful, Comme
 
     private void onLoadFinished(boolean more, int count, boolean successful, List<Comment> response,
                                 ApiError error) {
-        getListener().onLoadCommentListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadCommentListFinished(getRequestCode());
                 getListener().onCommentListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadCommentListFinished(getRequestCode());
                 getListener().onCommentListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
         } else {
+            getListener().onLoadCommentListFinished(getRequestCode());
             getListener().onLoadCommentListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/TimelineBroadcastListResource.java
Patch:
@@ -119,10 +119,10 @@ protected void onLoadFinished(boolean more, int count, boolean successful,
 
     private void onLoadFinished(boolean more, int count, boolean successful,
                                 List<Broadcast> response, ApiError error) {
-        getListener().onLoadBroadcastListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadBroadcastListFinished(getRequestCode());
                 getListener().onBroadcastListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
@@ -132,6 +132,7 @@ private void onLoadFinished(boolean more, int count, boolean successful,
                 EventBusUtils.postAsync(new BroadcastUpdatedEvent(broadcast, this));
             }
         } else {
+            getListener().onLoadBroadcastListFinished(getRequestCode());
             getListener().onLoadBroadcastListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/diary/content/UserDiaryListResource.java
Patch:
@@ -88,21 +88,23 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean more, int count, boolean successful, List<Diary> response,
                                   ApiError error) {
-        getListener().onLoadDiaryListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadDiaryListFinished(getRequestCode());
                 getListener().onDiaryListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadDiaryListFinished(getRequestCode());
                 getListener().onDiaryListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
             for (Diary diary : response) {
                 EventBusUtils.postAsync(new DiaryUpdatedEvent(diary, this));
             }
         } else {
+            getListener().onLoadDiaryListFinished(getRequestCode());
             getListener().onLoadDiaryListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/doulist/content/BaseDoulistResource.java
Patch:
@@ -30,21 +30,23 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean more, int count, boolean successful,
                                   List<Doulist> response, ApiError error) {
-        getListener().onLoadDoulistListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadDoulistListFinished(getRequestCode());
                 getListener().onDoulistListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadDoulistListFinished(getRequestCode());
                 getListener().onDoulistListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
             for (Doulist doulist : response) {
                 EventBusUtils.postAsync(new DoulistUpdatedEvent(doulist, this));
             }
         } else {
+            getListener().onLoadDoulistListFinished(getRequestCode());
             getListener().onLoadDoulistListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/item/content/BaseItemResource.java
Patch:
@@ -113,11 +113,12 @@ protected void onLoadStarted() {
 
     @Override
     protected void onLoadFinished(boolean successful, ItemType response, ApiError error) {
-        getListener().onLoadItemFinished(getRequestCode());
         if (successful) {
             set(response);
+            getListener().onLoadItemFinished(getRequestCode());
             getListener().onItemChanged(getRequestCode(), get());
         } else {
+            getListener().onLoadItemFinished(getRequestCode());
             getListener().onLoadItemError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/item/content/CelebrityListResource.java
Patch:
@@ -102,11 +102,12 @@ private List<SimpleCelebrity> transformResponse(CelebrityList response) {
 
     private void onLoadFinished(boolean successful, List<SimpleCelebrity> response,
                                 ApiError error) {
-        getListener().onLoadCelebrityListFinished(getRequestCode());
         if (successful) {
             set(response);
+            getListener().onLoadCelebrityListFinished(getRequestCode());
             getListener().onCelebrityListChanged(getRequestCode(), response);
         } else {
+            getListener().onLoadCelebrityListFinished(getRequestCode());
             getListener().onLoadCelebrityListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/item/content/ItemAwardListResource.java
Patch:
@@ -89,18 +89,20 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean more, int count, boolean successful,
                                   List<ItemAwardItem> response, ApiError error) {
-        getListener().onLoadAwardListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadAwardListFinished(getRequestCode());
                 getListener().onAwardListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadAwardListFinished(getRequestCode());
                 getListener().onAwardListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
         } else {
+            getListener().onLoadAwardListFinished(getRequestCode());
             getListener().onLoadAwardListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/item/content/ItemCollectionListResource.java
Patch:
@@ -98,18 +98,20 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean more, int count, boolean successful,
                                   List<SimpleItemCollection> response, ApiError error) {
-        getListener().onLoadItemCollectionListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadItemCollectionListFinished(getRequestCode());
                 getListener().onItemCollectionListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadItemCollectionListFinished(getRequestCode());
                 getListener().onItemCollectionListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
         } else {
+            getListener().onLoadItemCollectionListFinished(getRequestCode());
             getListener().onLoadItemCollectionListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/item/content/ItemForumTopicListResource.java
Patch:
@@ -98,18 +98,20 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean more, int count, boolean successful,
                                   List<SimpleItemForumTopic> response, ApiError error) {
-        getListener().onLoadForumTopicListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadForumTopicListFinished(getRequestCode());
                 getListener().onForumTopicListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadForumTopicListFinished(getRequestCode());
                 getListener().onForumTopicListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
         } else {
+            getListener().onLoadForumTopicListFinished(getRequestCode());
             getListener().onLoadForumTopicListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/item/content/ItemRecommendationListResource.java
Patch:
@@ -91,11 +91,12 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean successful, List<CollectableItem> response,
                                   ApiError error) {
-        getListener().onLoadRecommendationListFinished(getRequestCode());
         if (successful) {
             set(response);
+            getListener().onLoadRecommendationListFinished(getRequestCode());
             getListener().onRecommendationListChanged(getRequestCode(), response);
         } else {
+            getListener().onLoadRecommendationListFinished(getRequestCode());
             getListener().onLoadRecommendationListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/item/content/RatingResource.java
Patch:
@@ -83,11 +83,12 @@ protected void onLoadStarted() {
 
     @Override
     protected void onLoadFinished(boolean successful, Rating response, ApiError error) {
-        getListener().onLoadRatingFinished(getRequestCode());
         if (successful) {
             set(response);
+            getListener().onLoadRatingFinished(getRequestCode());
             getListener().onRatingChanged(getRequestCode(), response);
         } else {
+            getListener().onLoadRatingFinished(getRequestCode());
             getListener().onLoadRatingError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/notification/content/NotificationListResource.java
Patch:
@@ -157,17 +157,18 @@ protected void onLoadFinished(boolean more, int count, boolean successful,
 
     private void onLoadFinished(boolean more, int count, boolean successful,
                                 List<Notification> response, ApiError error) {
-        getListener().onLoadNotificationListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadNotificationListFinished(getRequestCode());
                 getListener().onNotificationListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 setAndNotifyListener(response, true);
             }
             EventBusUtils.postAsync(new NotificationListUpdatedEvent(mAccount, get(), this));
         } else {
+            getListener().onLoadNotificationListFinished(getRequestCode());
             getListener().onLoadNotificationListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/photo/content/BasePhotoListResource.java
Patch:
@@ -27,18 +27,20 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean more, int count, boolean successful, List<Photo> response,
                                   ApiError error) {
-        getListener().onLoadPhotoListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadPhotoListFinished(getRequestCode());
                 getListener().onPhotoListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadPhotoListFinished(getRequestCode());
                 getListener().onPhotoListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
         } else {
+            getListener().onLoadPhotoListFinished(getRequestCode());
             getListener().onLoadPhotoListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/profile/content/UserItemListResource.java
Patch:
@@ -85,12 +85,13 @@ protected void onLoadFinished(boolean successful, UserItemList response, ApiErro
     }
 
     private void onLoadFinished(boolean successful, List<UserItems> response, ApiError error) {
-        getListener().onLoadUserItemListFinished(getRequestCode());
         if (successful) {
             set(response);
+            getListener().onLoadUserItemListFinished(getRequestCode());
             getListener().onUserItemListChanged(getRequestCode(),
                     Collections.unmodifiableList(response));
         } else {
+            getListener().onLoadUserItemListFinished(getRequestCode());
             getListener().onLoadUserItemListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/review/content/BaseReviewListResource.java
Patch:
@@ -30,21 +30,23 @@ protected void onLoadStarted() {
     @Override
     protected void onLoadFinished(boolean more, int count, boolean successful,
                                   List<SimpleReview> response, ApiError error) {
-        getListener().onLoadReviewListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadReviewListFinished(getRequestCode());
                 getListener().onReviewListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadReviewListFinished(getRequestCode());
                 getListener().onReviewListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
             for (SimpleReview review : response) {
                 EventBusUtils.postAsync(new ReviewUpdatedEvent(review, this));
             }
         } else {
+            getListener().onLoadReviewListFinished(getRequestCode());
             getListener().onLoadReviewListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/user/content/BaseUserListResource.java
Patch:
@@ -31,18 +31,20 @@ protected abstract void onCallRawLoadFinished(boolean more, int count, boolean s
 
     protected void onRawLoadFinished(boolean more, int count, boolean successful,
                                      List<SimpleUser> response, ApiError error) {
-        getListener().onLoadUserListFinished(getRequestCode());
         if (successful) {
             if (more) {
                 append(response);
+                getListener().onLoadUserListFinished(getRequestCode());
                 getListener().onUserListAppended(getRequestCode(),
                         Collections.unmodifiableList(response));
             } else {
                 set(response);
+                getListener().onLoadUserListFinished(getRequestCode());
                 getListener().onUserListChanged(getRequestCode(),
                         Collections.unmodifiableList(get()));
             }
         } else {
+            getListener().onLoadUserListFinished(getRequestCode());
             getListener().onLoadUserListError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/user/content/UserResource.java
Patch:
@@ -160,13 +160,14 @@ protected void onLoadStarted() {
 
     @Override
     protected void onLoadFinished(boolean successful, User response, ApiError error) {
-        getListener().onLoadUserFinished(getRequestCode());
         if (successful) {
             set(response);
             onLoadSuccess(response);
+            getListener().onLoadUserFinished(getRequestCode());
             getListener().onUserChanged(getRequestCode(), get());
             EventBusUtils.postAsync(new UserUpdatedEvent(response, this));
         } else {
+            getListener().onLoadUserFinished(getRequestCode());
             getListener().onLoadUserError(getRequestCode(), error);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/HomeBroadcastListResource.java
Patch:
@@ -121,7 +121,7 @@ private void onLoadFromCacheFinished(List<Broadcast> broadcastList) {
 
         boolean hasCache = broadcastList != null && !broadcastList.isEmpty();
         if (hasCache) {
-            setAndNotifyListener(broadcastList);
+            setAndNotifyListener(broadcastList, true);
         }
 
         if (!hasCache || Settings.AUTO_REFRESH_HOME.getValue()) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BaseBroadcastListResource.java
Patch:
@@ -55,7 +55,7 @@ protected boolean shouldPostBroadcastUpdatedEvent() {
         return true;
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastUpdated(BroadcastUpdatedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {
@@ -72,7 +72,7 @@ public void onBroadcastUpdated(BroadcastUpdatedEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastDeleted(BroadcastDeletedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastCommentListResource.java
Patch:
@@ -74,7 +74,7 @@ protected ApiRequest<CommentList> onCreateRequest(Integer start, Integer count)
         return ApiService.getInstance().getBroadcastCommentList(mBroadcastId, start, count);
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastCommentSent(BroadcastCommentSentEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/CommentListResource.java
Patch:
@@ -54,7 +54,7 @@ protected void appendAndNotifyListener(List<Comment> commentList) {
         getListener().onCommentListAppended(getRequestCode(), commentList);
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onCommentDeleted(CommentDeletedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/DeleteBroadcastWriter.java
Patch:
@@ -102,7 +102,7 @@ public void onErrorResponse(ApiError error) {
         stopSelf();
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastUpdated(BroadcastUpdatedEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/LikeBroadcastWriter.java
Patch:
@@ -102,7 +102,7 @@ public void onErrorResponse(ApiError error) {
         stopSelf();
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastUpdated(BroadcastUpdatedEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/RebroadcastBroadcastWriter.java
Patch:
@@ -113,7 +113,7 @@ public void onErrorResponse(ApiError error) {
         stopSelf();
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastUpdated(BroadcastUpdatedEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastActivityDialogFragment.java
Patch:
@@ -124,7 +124,7 @@ public void onDestroy() {
         EventBusUtils.unregister(this);
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastUpdated(BroadcastUpdatedEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastFragment.java
Patch:
@@ -469,7 +469,7 @@ private void sendComment(String comment) {
         updateSendCommentStatus();
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastCommentSent(BroadcastCommentSentEvent event) {
 
         if (event.isFromMyself(this)) {
@@ -483,7 +483,7 @@ public void onBroadcastCommentSent(BroadcastCommentSentEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastCommentSendError(BroadcastCommentSendErrorEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLikerListFragment.java
Patch:
@@ -81,7 +81,7 @@ protected void onListUpdated(List<SimpleUser> userList) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastUpdated(BroadcastUpdatedEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastRebroadcastedBroadcastListFragment.java
Patch:
@@ -79,7 +79,7 @@ protected void onListUpdated(List<Broadcast> broadcastList) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastUpdated(BroadcastUpdatedEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/ConfirmUnrebroadcastBroadcastDialogFragment.java
Patch:
@@ -80,7 +80,7 @@ public static void show(Broadcast broadcast, Fragment fragment) {
                 .show(fragment.getChildFragmentManager(), null);
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastUpdated(BroadcastUpdatedEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/RebroadcastBroadcastFragment.java
Patch:
@@ -225,7 +225,7 @@ private void rebroadcast(String text) {
         updateRebroadcastStatus();
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastRebroadcasted(BroadcastRebroadcastedEvent event) {
 
         if (event.isFromMyself(this)) {
@@ -238,7 +238,7 @@ public void onBroadcastRebroadcasted(BroadcastRebroadcastedEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onBroadcastRebroadcastError(BroadcastRebroadcastErrorEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/diary/content/UserDiaryListResource.java
Patch:
@@ -107,7 +107,7 @@ protected void onLoadFinished(boolean more, int count, boolean successful, List<
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onDiaryUpdated(DiaryUpdatedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {
@@ -124,7 +124,7 @@ public void onDiaryUpdated(DiaryUpdatedEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onDiaryDeleted(DiaryDeletedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {

File: app/src/main/java/me/zhanghai/android/douya/doulist/content/BaseDoulistResource.java
Patch:
@@ -49,7 +49,7 @@ protected void onLoadFinished(boolean more, int count, boolean successful,
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onDoulistUpdated(DoulistUpdatedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {
@@ -66,7 +66,7 @@ public void onDoulistUpdated(DoulistUpdatedEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onDoulistDeleted(DoulistDeletedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {

File: app/src/main/java/me/zhanghai/android/douya/followship/content/FollowUserWriter.java
Patch:
@@ -126,7 +126,7 @@ public void onErrorResponse(ApiError error) {
         stopSelf();
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onUserUpdated(UserUpdatedEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/notification/content/NotificationListResource.java
Patch:
@@ -181,7 +181,7 @@ private void onLoadFinished(boolean more, int count, boolean successful,
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onNotificationListUpdated(NotificationListUpdatedEvent event) {
 
         if (event.isFromMyself(this) || mAccount == null) {
@@ -193,7 +193,7 @@ public void onNotificationListUpdated(NotificationListUpdatedEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onNotificationUpdated(NotificationUpdatedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {
@@ -210,7 +210,7 @@ public void onNotificationUpdated(NotificationUpdatedEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onNotificationDeleted(NotificationDeletedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {

File: app/src/main/java/me/zhanghai/android/douya/photo/content/BasePhotoListResource.java
Patch:
@@ -48,7 +48,7 @@ protected void appendAndNotifyListener(List<Photo> photoList) {
         getListener().onPhotoListAppended(getRequestCode(), photoList);
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onPhotoDeleted(PhotoDeletedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {

File: app/src/main/java/me/zhanghai/android/douya/review/content/BaseReviewListResource.java
Patch:
@@ -49,7 +49,7 @@ protected void onLoadFinished(boolean more, int count, boolean successful,
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onReviewUpdated(ReviewUpdatedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {
@@ -66,7 +66,7 @@ public void onReviewUpdated(ReviewUpdatedEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onReviewDeleted(ReviewDeletedEvent event) {
 
         if (event.isFromMyself(this) || isEmpty()) {

File: app/src/main/java/me/zhanghai/android/douya/scalpel/ScalpelHelperFragment.java
Patch:
@@ -98,7 +98,7 @@ private void enable() {
         ScalpelUtils.setEnabled(getActivity(), true);
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onSetEnabled(SetEnabledEvent event) {
         setEnabledForActivity(event.enabled);
     }

File: app/src/main/java/me/zhanghai/android/douya/user/content/UserResource.java
Patch:
@@ -173,7 +173,7 @@ protected void onLoadFinished(boolean successful, User response, ApiError error)
 
     protected void onLoadSuccess(User user) {}
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onUserUpdated(UserUpdatedEvent event) {
 
         if (event.isFromMyself(this)) {
@@ -186,7 +186,7 @@ public void onUserUpdated(UserUpdatedEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onUserWriteStarted(UserWriteStartedEvent event) {
 
         if (event.isFromMyself(this)) {
@@ -199,7 +199,7 @@ public void onUserWriteStarted(UserWriteStartedEvent event) {
         }
     }
 
-    @Subscribe(threadMode = ThreadMode.MAIN)
+    @Subscribe(threadMode = ThreadMode.POSTING)
     public void onUserWriteFinished(UserWriteFinishedEvent event) {
 
         if (event.isFromMyself(this)) {

File: app/src/main/java/me/zhanghai/android/douya/util/TimeUtils.java
Patch:
@@ -33,7 +33,7 @@ public class TimeUtils {
                     .toFormatter()
                     .withChronology(IsoChronology.INSTANCE);
 
-    private static final ZoneId DOUBAN_ZONED_ID = ZoneId.of("Asia/Shanghai");
+    private static final ZoneId DOUBAN_ZONE_ID = ZoneId.of("Asia/Shanghai");
 
     private static final Duration JUST_NOW_DURATION = Duration.ofMinutes(1);
     private static final Duration MINUTE_PATTERN_DURATION = Duration.ofHours(1);
@@ -51,7 +51,8 @@ public static LocalDate parseDoubanDate(String doubanDate) {
      */
     public static ZonedDateTime parseDoubanDateTime(String doubanDateTime) {
         return ZonedDateTime.of(LocalDateTime.parse(doubanDateTime, DOUBAN_DATE_TIME_FORMATTER),
-                DOUBAN_ZONED_ID);
+                DOUBAN_ZONE_ID)
+                .withZoneSameInstant(ZoneId.systemDefault());
     }
 
     public static String formatDateTime(ZonedDateTime dateTime, Context context) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLayout.java
Patch:
@@ -308,7 +308,7 @@ private void bindRebroadcastedAttachmentImages(Broadcast broadcast,
         if (attachment != null) {
             mAttachmentLayout.setVisibility(VISIBLE);
             mAttachmentTitleText.setText(attachment.title);
-            mAttachmentDescriptionText.setText(attachment.text);
+            mAttachmentDescriptionText.setText(attachment.getTextWithEntities());
             if (attachment.image != null && images.isEmpty()) {
                 mAttachmentImage.setVisibility(VISIBLE);
                 ImageUtils.loadImage(mAttachmentImage, attachment.image);

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastAdapter.java
Patch:
@@ -66,7 +66,7 @@ public void onCommentClicked() {
                 // Not setting button disabled because we are using enabled state for indeterminate
                 // state due to network, and we want the click to always open the broadcast for our
                 // user.
-                mListener.onCommentBroadcast(effectiveBroadcast, getSharedView(holder));
+                mListener.onCommentBroadcast(broadcast, getSharedView(holder));
             }
         });
         ViewCompat.setTransitionName(getSharedView(holder), broadcast.makeTransitionName());

File: app/src/main/java/me/zhanghai/android/douya/eventbus/BroadcastUpdatedEvent.java
Patch:
@@ -45,7 +45,7 @@ private void mergeAndRepost(Broadcast oldBroadcast, Object source) {
     @SuppressWarnings("deprecation")
     public Broadcast update(Broadcast oldBroadcast, Object source) {
         if (oldBroadcast.id == broadcast.id) {
-            mergeAndRepost(broadcast, source);
+            mergeAndRepost(oldBroadcast, source);
             return broadcast;
         } else if (oldBroadcast.parentBroadcast != null
                 && oldBroadcast.parentBroadcast.id == broadcast.id) {

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Broadcast.java
Patch:
@@ -166,7 +166,7 @@ private CharSequence appendParentText(CharSequence text, Context context) {
         int parentSpaceStartIndex = builder.length();
         builder.append(" ");
         int parentSpaceEndIndex = builder.length();
-        // For the case when rebroadcasting a broadcast.
+        // HACK: For the case when rebroadcasting a broadcast.
         float spaceWidthEm = builder.length() > 1 ? 0.5f : -0.1f;
         builder.setSpan(new SpaceSpan(spaceWidthEm), parentSpaceStartIndex, parentSpaceEndIndex,
                 Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BaseTimelineBroadcastListFragment.java
Patch:
@@ -125,7 +125,8 @@ public void onLikeBroadcast(Broadcast broadcast, boolean like) {
     @Override
     public void onRebroadcastBroadcast(Broadcast broadcast, boolean quick) {
         if (quick) {
-            RebroadcastBroadcastManager.getInstance().write(broadcast, null, getActivity());
+            RebroadcastBroadcastManager.getInstance().write(broadcast.getEffectiveBroadcast(), null,
+                    getActivity());
         } else {
             startActivity(RebroadcastBroadcastActivity.makeIntent(broadcast, getActivity()));
         }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastAdapter.java
Patch:
@@ -58,7 +58,7 @@ public void onRebroadcastClicked(boolean isLongClick) {
                 if (broadcast.isSimpleRebroadcastByOneself()) {
                     mListener.onUnrebroadcastBroadcast(broadcast, isLongClick);
                 } else {
-                    mListener.onRebroadcastBroadcast(effectiveBroadcast, isLongClick);
+                    mListener.onRebroadcastBroadcast(broadcast, isLongClick);
                 }
             }
             @Override

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/CommentAdapter.java
Patch:
@@ -28,8 +28,8 @@
 public class CommentAdapter extends ClickableSimpleAdapter<Comment, CommentAdapter.ViewHolder> {
 
     public CommentAdapter(List<Comment> commentList,
-                          OnItemClickListener<Comment, CommentAdapter.ViewHolder> onItemClickListener) {
-        super(commentList, onItemClickListener, null);
+                          OnItemClickListener<Comment> onItemClickListener) {
+        super(commentList, onItemClickListener);
 
         setHasStableIds(true);
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/SingleBroadcastAdapter.java
Patch:
@@ -85,7 +85,7 @@ public void onRebroadcastClicked(boolean isLongClick) {
                 if (mBroadcast.isSimpleRebroadcastByOneself()) {
                     mListener.onUnrebroadcast(mBroadcast, isLongClick);
                 } else {
-                    mListener.onRebroadcast(effectiveBroadcast, isLongClick);
+                    mListener.onRebroadcast(mBroadcast, isLongClick);
                 }
             }
             @Override

File: app/src/main/java/me/zhanghai/android/douya/item/ui/MovieAdapter.java
Patch:
@@ -304,11 +304,11 @@ public void onBindViewHolder(RecyclerView.ViewHolder holder, int position) {
                 HorizontalImageAdapter adapter = (HorizontalImageAdapter)
                         photoListHolder.photoList.getAdapter();
                 adapter.replace(photoList);
-                adapter.setOnImageClickListener(photoPosition -> {
-                    // TODO: Use PhotoAlbumGalleryActivity instead.
+                adapter.setOnItemClickListener((parent, itemView, item, photoPosition) -> {
                     if (mData.excludeFirstPhoto) {
                         ++photoPosition;
                     }
+                    // TODO: Use PhotoAlbumGalleryActivity instead.
                     context.startActivity(GalleryActivity.makeIntent(mData.photoList, photoPosition,
                             photoListHolder.photoList.getContext()));
                 });

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Broadcast.java
Patch:
@@ -109,7 +109,7 @@ public String getRebroadcastedBy(Context context) {
     }
 
     public CharSequence getRebroadcastText(Context context) {
-        return !TextUtils.isEmpty(text) ? getTextWithEntities(context) : context.getString(
+        return !TextUtils.isEmpty(text) ? getTextWithEntities(false, context) : context.getString(
                 R.string.broadcast_rebroadcasted_broadcasts_simple_rebroadcast_text);
     }
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/TextEntity.java
Patch:
@@ -11,6 +11,7 @@
 import android.text.Spanned;
 import android.text.TextUtils;
 import android.util.Patterns;
+import android.webkit.URLUtil;
 
 import java.util.List;
 
@@ -51,6 +52,7 @@ public static CharSequence applyEntities(String text, List<TextEntity> entityLis
             builder.append(text.substring(lastTextIndex, entityStart));
             String entityText = entity.title;
             if (Settings.SHOW_LONG_URL_FOR_LINK_ENTITY.getValue()
+                    && URLUtil.isNetworkUrl(entityText)
                     && Patterns.WEB_URL.matcher(entityText).matches()) {
                 entityText = entity.uri;
             }

File: app/src/main/java/me/zhanghai/android/douya/ui/IconSpan.java
Patch:
@@ -34,7 +34,7 @@ public int getSize(@NonNull Paint paint, CharSequence text, int start, int end,
                 width = mDrawable.getIntrinsicWidth();
             }
             mDrawable.setBounds(0, 0, width, height);
-            // fm.ascent and fm.descent define top and boom in draw().
+            // fm.ascent and fm.descent determine top and boom in draw().
             fm.ascent = fm.top;
             fm.descent = fm.bottom;
         }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastAdapter.java
Patch:
@@ -61,7 +61,7 @@ public void onLikeClicked() {
             @Override
             public void onRebroadcastClicked(boolean isLongClick) {
                 if (broadcast.isSimpleRebroadcastByOneself()) {
-                    mListener.onUnrebroadcastBroadcast(broadcast);
+                    mListener.onUnrebroadcastBroadcast(broadcast, isLongClick);
                 } else {
                     mListener.onRebroadcastBroadcast(effectiveBroadcast, isLongClick);
                 }
@@ -91,7 +91,7 @@ public void onViewRecycled(ViewHolder holder) {
     public interface Listener {
         void onLikeBroadcast(Broadcast broadcast, boolean like);
         void onRebroadcastBroadcast(Broadcast broadcast, boolean quick);
-        void onUnrebroadcastBroadcast(Broadcast broadcast);
+        void onUnrebroadcastBroadcast(Broadcast broadcast, boolean quick);
         void onCommentBroadcast(Broadcast broadcast, View sharedView);
         void onOpenBroadcast(Broadcast broadcast, View sharedView);
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BaseBroadcastListFragment.java
Patch:
@@ -233,7 +233,7 @@ public void onRebroadcastBroadcast(Broadcast broadcast, boolean quick) {
 
     @Override
     public void onUnrebroadcastBroadcast(Broadcast broadcast) {
-        DeleteBroadcastManager.getInstance().write(broadcast.id, getActivity());
+        DeleteBroadcastManager.getInstance().write(broadcast, getActivity());
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastFragment.java
Patch:
@@ -527,6 +527,6 @@ private void onDeleteBroadcast() {
     @Override
     public void deleteBroadcast() {
         DeleteBroadcastManager.getInstance().write(
-                mBroadcastAndCommentListResource.getEffectiveBroadcastId(), getActivity());
+                mBroadcastAndCommentListResource.getEffectiveBroadcast(), getActivity());
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Broadcast.java
Patch:
@@ -135,8 +135,8 @@ public String getRebroadcastCountString() {
         return rebroadcastCount == 0 ? null : String.valueOf(rebroadcastCount);
     }
 
-    public void incrementRebroadcastCount() {
-        ++rebroadcastCount;
+    public void decrementRebroadcastCount() {
+        --rebroadcastCount;
     }
 
     public String getCommentCountString() {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/RebroadcastBroadcastManager.java
Patch:
@@ -31,6 +31,9 @@ public void write(Broadcast broadcast, String text, Context context) {
         add(new RebroadcastBroadcastWriter(broadcast, text, this), context);
     }
 
+    /**
+     * @deprecated In most cases you may want to use {@link #isWritingQuickRebroadcast(long)}.
+     */
     public boolean isWriting(long broadcastId) {
         return findWriter(broadcastId) != null;
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/RebroadcastBroadcastWriter.java
Patch:
@@ -83,7 +83,7 @@ public void onResponse(Broadcast response) {
 
         ToastUtils.show(R.string.broadcast_rebroadcast_successful, getContext());
 
-        EventBusUtils.postAsync(new BroadcastUpdatedEvent(response, this));
+        EventBusUtils.postAsync(new BroadcastUpdatedEvent(response.rebroadcastedBroadcast, this));
 
         stopSelf();
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastAdapter.java
Patch:
@@ -50,7 +50,7 @@ public void onBindViewHolder(final ViewHolder holder, int position) {
         Broadcast originalBroadcast = getItem(position);
         holder.rebroadcastedByText.setText(originalBroadcast.getRebroadcastedBy(
                 RecyclerViewUtils.getContext(holder)));
-        final Broadcast broadcast = originalBroadcast.rebroadcastedBroadcast != null ?
+        Broadcast broadcast = originalBroadcast.rebroadcastedBroadcast != null ?
                 originalBroadcast.rebroadcastedBroadcast : originalBroadcast;
         holder.cardView.setOnClickListener(view -> mListener.onOpenBroadcast(broadcast,
                 getSharedView(holder)));
@@ -89,7 +89,7 @@ public void onViewRecycled(ViewHolder holder) {
     public interface Listener {
         void onLikeBroadcast(Broadcast broadcast, boolean like);
         void onRebroadcastBroadcast(Broadcast broadcast, boolean quick);
-/**/        void onCommentBroadcast(Broadcast broadcast, View sharedView);
+        void onCommentBroadcast(Broadcast broadcast, View sharedView);
         void onOpenBroadcast(Broadcast broadcast, View sharedView);
     }
 

File: app/src/main/java/me/zhanghai/android/douya/ui/CardIconButton.java
Patch:
@@ -5,6 +5,7 @@
 
 package me.zhanghai.android.douya.ui;
 
+import android.annotation.SuppressLint;
 import android.annotation.TargetApi;
 import android.content.Context;
 import android.graphics.drawable.Drawable;
@@ -53,7 +54,7 @@ public CardIconButton(Context context, AttributeSet attrs, int defStyleAttr, int
         init(attrs, defStyleAttr, defStyleRes);
     }
 
-    @SuppressWarnings("RestrictedApi")
+    @SuppressLint("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
 
         setClickable(true);

File: app/src/main/java/me/zhanghai/android/douya/ui/ContentStateLayout.java
Patch:
@@ -5,6 +5,7 @@
 
 package me.zhanghai.android.douya.ui;
 
+import android.annotation.SuppressLint;
 import android.annotation.TargetApi;
 import android.content.Context;
 import android.os.Build;
@@ -70,7 +71,7 @@ public ContentStateLayout(Context context, AttributeSet attrs, int defStyleAttr,
         init(attrs, defStyleAttr, defStyleRes);
     }
 
-    @SuppressWarnings("RestrictedApi")
+    @SuppressLint("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(getContext(), attrs,
                 R.styleable.ContentStateLayout, defStyleAttr, defStyleRes);

File: app/src/main/java/me/zhanghai/android/douya/ui/ForegroundHelper.java
Patch:
@@ -5,6 +5,7 @@
 
 package me.zhanghai.android.douya.ui;
 
+import android.annotation.SuppressLint;
 import android.annotation.TargetApi;
 import android.content.Context;
 import android.graphics.Canvas;
@@ -51,7 +52,7 @@ public ForegroundHelper(Delegate delegate) {
         mDelegate = delegate;
     }
 
-    @SuppressWarnings("RestrictedApi")
+    @SuppressLint("RestrictedApi")
     public void init(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) {
 
         // @see View#View(android.content.Context, android.util.AttributeSet, int, int)

File: app/src/main/java/me/zhanghai/android/douya/ui/FriendlyCardView.java
Patch:
@@ -5,6 +5,7 @@
 
 package me.zhanghai.android.douya.ui;
 
+import android.annotation.SuppressLint;
 import android.content.Context;
 import android.support.v7.widget.CardView;
 import android.support.v7.widget.TintTypedArray;
@@ -35,7 +36,7 @@ public FriendlyCardView(Context context, AttributeSet attrs, int defStyleAttr) {
         init(attrs, defStyleAttr);
     }
 
-    @SuppressWarnings("RestrictedApi")
+    @SuppressLint("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr) {
 
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(getContext(), attrs,

File: app/src/main/java/me/zhanghai/android/douya/ui/ImageLayout.java
Patch:
@@ -5,6 +5,7 @@
 
 package me.zhanghai.android.douya.ui;
 
+import android.annotation.SuppressLint;
 import android.annotation.TargetApi;
 import android.content.Context;
 import android.os.Build;
@@ -54,7 +55,7 @@ public ImageLayout(Context context, AttributeSet attrs, int defStyleAttr, int de
         init(attrs, defStyleAttr, defStyleRes);
     }
 
-    @SuppressWarnings("RestrictedApi")
+    @SuppressLint("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
 
         setClickable(true);

File: app/src/main/java/me/zhanghai/android/douya/ui/InsetBackgroundFrameLayout.java
Patch:
@@ -5,6 +5,7 @@
 
 package me.zhanghai.android.douya.ui;
 
+import android.annotation.SuppressLint;
 import android.annotation.TargetApi;
 import android.content.Context;
 import android.graphics.Canvas;
@@ -54,7 +55,7 @@ public InsetBackgroundFrameLayout(Context context, AttributeSet attrs, int defSt
         init(attrs, defStyleAttr, defStyleRes);
     }
 
-    @SuppressWarnings("RestrictedApi")
+    @SuppressLint("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
 
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(getContext(), attrs,

File: app/src/main/java/me/zhanghai/android/douya/ui/MaxDimensionHelper.java
Patch:
@@ -5,6 +5,7 @@
 
 package me.zhanghai.android.douya.ui;
 
+import android.annotation.SuppressLint;
 import android.content.Context;
 import android.support.v7.widget.TintTypedArray;
 import android.util.AttributeSet;
@@ -28,7 +29,7 @@ public MaxDimensionHelper(Delegate delegate) {
         mDelegate = delegate;
     }
 
-    @SuppressWarnings("RestrictedApi")
+    @SuppressLint("RestrictedApi")
     public void init(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) {
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(context, attrs, STYLEABLE,
                 defStyleAttr, defStyleRes);

File: app/src/main/java/me/zhanghai/android/douya/ui/RatioHeightRecyclerView.java
Patch:
@@ -5,6 +5,7 @@
 
 package me.zhanghai.android.douya.ui;
 
+import android.annotation.SuppressLint;
 import android.content.Context;
 import android.os.Build;
 import android.support.v7.widget.RecyclerView;
@@ -38,7 +39,7 @@ public RatioHeightRecyclerView(Context context, AttributeSet attrs, int defStyle
         init(attrs, defStyle);
     }
 
-    @SuppressWarnings("RestrictedApi")
+    @SuppressLint("RestrictedApi")
     private void init(AttributeSet attrs, int defStyle) {
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(getContext(), attrs,
                 R.styleable.RatioHeightRecyclerView, defStyle, 0);

File: app/src/main/java/me/zhanghai/android/douya/ui/TintDrawablesTextView.java
Patch:
@@ -5,6 +5,7 @@
 
 package me.zhanghai.android.douya.ui;
 
+import android.annotation.SuppressLint;
 import android.annotation.TargetApi;
 import android.content.Context;
 import android.content.res.ColorStateList;
@@ -42,7 +43,7 @@ public TintDrawablesTextView(Context context, AttributeSet attrs, int defStyleAt
         init(attrs, defStyleAttr, 0);
     }
 
-    @SuppressWarnings("RestrictedApi")
+    @SuppressLint("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
 
         Context context = getContext();

File: app/src/main/java/me/zhanghai/android/douya/util/DiskCache.java
Patch:
@@ -84,7 +84,7 @@ public <T> T getGsonOrThrow(String key, Type type) throws IOException, JsonParse
         // Gson.fromJson() creates a JsonReader which does its own buffering.
         Reader reader = new InputStreamReader(getInputStreamOrThrow(key));
         try {
-            return GsonHelper.get().fromJson(reader, type);
+            return GsonHelper.GSON.fromJson(reader, type);
         } finally {
             reader.close();
         }
@@ -148,7 +148,7 @@ public <T> void putGsonOrThrow(String key, T value, Type type)
         try {
             Writer writer = new BufferedWriter(new OutputStreamWriter(editor.newOutputStream(0)));
             try {
-                GsonHelper.get().toJson(value, type, writer);
+                GsonHelper.GSON.toJson(value, type, writer);
             } finally {
                 writer.close();
             }

File: app/src/main/java/me/zhanghai/android/douya/settings/info/Settings.java
Patch:
@@ -33,9 +33,9 @@ public interface Settings {
     StringSettingsEntry RECENT_TWO_ACCOUNT_NAME = new StringSettingsEntry(
             R.string.pref_key_recent_two_account_name, R.string.pref_default_value_empty_string);
 
-    BooleanSettingsEntry SHOW_TITLE_FOR_LINK_ENTITY = new BooleanSettingsEntry(
-            R.string.pref_key_show_title_for_link_entity,
-            R.bool.pref_default_value_show_title_for_link_entity);
+    BooleanSettingsEntry SHOW_LONG_URL_FOR_LINK_ENTITY = new BooleanSettingsEntry(
+            R.string.pref_key_show_long_url_for_link_entity,
+            R.bool.pref_default_value_show_long_url_for_link_entity);
 
     enum NightMode {
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Broadcast.java
Patch:
@@ -123,7 +123,7 @@ public String getCommentCountString() {
 
     public boolean canComment() {
         // TODO: Frodo
-        return isRebroadcastAndCommentForbidden;
+        return !isRebroadcastAndCommentForbidden;
     }
 
     public static String makeTransitionName(long id) {

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiService.java
Patch:
@@ -492,7 +492,7 @@ ApiRequest<BroadcastList> getBroadcastRebroadcastedBroadcastList(
         ApiRequest<Broadcast> rebroadcastBroadcast(@Path("broadcastId") long broadcastId,
                                                    @Field("text") String text);
 
-        @POST("status/{broadcastId}/reshare")
+        @POST("status/{broadcastId}/report")
         @FormUrlEncoded
         ApiRequest<Void> reportBroadcast(@Path("broadcastId") long broadcastId,
                                          @Field("reason") int reason);

File: app/src/main/java/me/zhanghai/android/douya/item/ui/BaseItemFragment.java
Patch:
@@ -194,7 +194,9 @@ private boolean hasFirstChildReachedTop() {
                         mToolbar.getBottom());
             }
         });
-        mToolbar.getBackground().setAlpha(0);
+        if (!mResource.isLoaded()) {
+            mToolbar.getBackground().setAlpha(0);
+        }
         mToolbar.setOnDoubleClickListener(view -> {
             mContentList.smoothScrollToPosition(0);
             return true;

File: app/src/main/java/me/zhanghai/android/douya/item/ui/BadgeListLayout.java
Patch:
@@ -160,7 +160,7 @@ public void setRating(Rating rating, CollectableItem item) {
         }
         mRatingLayout.setOnClickListener(view -> {
             // TODO
-            UriHandler.open(item.url + "/collections", view.getContext());
+            UriHandler.open(item.url + "collections", view.getContext());
         });
         boolean hasFollowingsRating = rating.followingsRating != null;
         ViewUtils.setVisibleOrGone(mFollowingsRatingLayout, hasFollowingsRating);
@@ -169,7 +169,7 @@ public void setRating(Rating rating, CollectableItem item) {
                     mFollowingsRatingCountText, mFollowingsRatingCountIconImage);
             mFollowingsRatingLayout.setOnClickListener(view -> {
                 // TODO
-                UriHandler.open(item.url + "/collections?show_followings=on", view.getContext());
+                UriHandler.open(item.url + "collections?show_followings=on", view.getContext());
             });
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/item/content/MovieFragmentResource.java
Patch:
@@ -95,10 +95,10 @@ protected void notifyChanged(int requestCode, Movie newItem, Rating newRating,
                                  List<ItemAwardItem> newAwardList,
                                  List<ItemCollection> newItemCollectionList,
                                  List<SimpleReview> newReviewList,
-                                 List<SimpleItemForumTopic> newItemForumTopicList,
+                                 List<SimpleItemForumTopic> newForumTopicList,
                                  List<CollectableItem> newRecommendationList) {
         getListener().onChanged(requestCode, newItem, newRating, newPhotoList, newCelebrityList,
-                newAwardList, newItemCollectionList, newReviewList, newItemForumTopicList,
+                newAwardList, newItemCollectionList, newReviewList, newForumTopicList,
                 newRecommendationList);
     }
 
@@ -111,7 +111,7 @@ public interface Listener extends BaseItemFragmentResource.Listener<Movie> {
         void onChanged(int requestCode, Movie newMovie, Rating newRating, List<Photo> newPhotoList,
                        List<SimpleCelebrity> newCelebrityList, List<ItemAwardItem> newAwardList,
                        List<ItemCollection> newItemCollectionList, List<SimpleReview> newReviewList,
-                       List<SimpleItemForumTopic> newItemForumTopicList,
+                       List<SimpleItemForumTopic> newForumTopicList,
                        List<CollectableItem> newRecommendationList);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/item/ui/ItemContentRecyclerView.java
Patch:
@@ -74,6 +74,8 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
                 paddingTop = Math.min(paddingTop, mPaddingTopMax);
             }
             paddingTop += mPaddingTopNegativeMargin;
+            // HACK: Fix off-by-one-pixel visual glitch.
+            --paddingTop;
             setPadding(getPaddingLeft(), paddingTop, getPaddingRight(), getPaddingBottom());
         }
         super.onMeasure(widthMeasureSpec, heightMeasureSpec);

File: app/src/main/java/me/zhanghai/android/douya/item/ui/MovieAdapter.java
Patch:
@@ -35,6 +35,7 @@
 import me.zhanghai.android.douya.ui.DividerItemDecoration;
 import me.zhanghai.android.douya.ui.HorizontalImageAdapter;
 import me.zhanghai.android.douya.ui.RatioImageView;
+import me.zhanghai.android.douya.util.CollectionUtils;
 import me.zhanghai.android.douya.util.ImageUtils;
 import me.zhanghai.android.douya.util.StringUtils;
 import me.zhanghai.android.douya.util.ViewUtils;
@@ -215,7 +216,7 @@ public void onBindViewHolder(RecyclerView.ViewHolder holder, int position) {
                 badgeListHolder.badgeListLayout.setTop250(top250Honor);
                 badgeListHolder.badgeListLayout.setRating(mData.rating, mData.movie);
                 badgeListHolder.badgeListLayout.setGenre(R.drawable.movie_badge_white_40dp,
-                        mData.movie.genres.get(0));
+                        CollectionUtils.firstOrNull(mData.movie.genres));
                 break;
             }
             case ITEM_INTRODUCTION: {

File: app/src/main/java/me/zhanghai/android/douya/item/ui/BaseItemFragment.java
Patch:
@@ -194,6 +194,7 @@ private boolean hasFirstChildReachedTop() {
                         mToolbar.getBottom());
             }
         });
+        mToolbar.getBackground().setAlpha(0);
         mToolbar.setOnDoubleClickListener(view -> {
             mContentList.smoothScrollToPosition(0);
             return true;

File: app/src/main/java/me/zhanghai/android/douya/ui/TransparentDoubleClickToolbar.java
Patch:
@@ -10,6 +10,7 @@
 import android.animation.ValueAnimator;
 import android.content.Context;
 import android.support.annotation.Nullable;
+import android.support.v4.view.ViewCompat;
 import android.support.v4.view.animation.FastOutSlowInInterpolator;
 import android.util.AttributeSet;
 import android.view.MotionEvent;
@@ -53,6 +54,7 @@ private void init() {
         ButterKnife.bind(this);
         mTitleTextColor = ViewUtils.getColorFromAttrRes(android.R.attr.textColorPrimary, 0,
                 getContext());
+        ViewCompat.setBackground(this, getBackground().mutate());
     }
 
     public void setTransparent(boolean transparent) {

File: app/src/main/java/me/zhanghai/android/douya/item/ui/MovieAdapter.java
Patch:
@@ -166,6 +166,8 @@ public RecyclerView.ViewHolder onCreateViewHolder(ViewGroup parent, int viewType
 
     @Override
     public void onBindViewHolder(RecyclerView.ViewHolder holder, int position) {
+        // HACK: Make sure we don't click through any view to our backdrop.
+        holder.itemView.setClickable(true);
         final Context context = holder.itemView.getContext();
         switch (position) {
             case ITEM_HEADER: {

File: app/src/main/java/me/zhanghai/android/douya/item/ui/MovieAdapter.java
Patch:
@@ -7,6 +7,7 @@
 
 import android.content.Context;
 import android.content.Intent;
+import android.graphics.Rect;
 import android.support.v4.view.ViewCompat;
 import android.support.v7.widget.LinearLayoutManager;
 import android.support.v7.widget.RecyclerView;
@@ -67,7 +68,7 @@ public class MovieAdapter extends RecyclerView.Adapter<RecyclerView.ViewHolder>
     private RecyclerView.OnScrollListener mOnScrollListener = new RecyclerView.OnScrollListener() {
         @Override
         public void onScrolled(RecyclerView recyclerView, int dx, int dy) {
-            MovieAdapter.this.onScrolled(recyclerView);
+            MovieAdapter.this.onScrolled(recyclerView, dx, dy);
         }
     };
 
@@ -375,7 +376,7 @@ private boolean shouldExcludeFirstPhoto() {
         return mData.movie.trailer == null && !mData.photoList.isEmpty();
     }
 
-    private void onScrolled(RecyclerView recyclerView) {
+    private void onScrolled(RecyclerView recyclerView, int dx, int dy) {
         BackdropHolder backdropHolder = null;
         for (int i = 0, count = recyclerView.getChildCount(); i < count; ++i) {
             View child = recyclerView.getChildAt(i);

File: app/src/main/java/me/zhanghai/android/douya/item/ui/BadgeListLayout.java
Patch:
@@ -175,7 +175,7 @@ public void setRating(Rating rating, CollectableItem item) {
                     mFollowingsRatingCountText, mFollowingsRatingCountIconImage);
             mFollowingsRatingLayout.setOnClickListener(view -> {
                 // TODO
-                UriHandler.open(item.url + "/follows_comments", view.getContext());
+                UriHandler.open(item.url + "/collections?show_followings=on", view.getContext());
             });
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/item/ui/BadgeListLayout.java
Patch:
@@ -196,7 +196,7 @@ private void setRating(SimpleRating rating, TextView ratingText, RatingBar ratin
         String ratingString = getContext().getString(ratingOutOfTen == 10 ?
                 R.string.item_rating_format_ten : R.string.item_rating_format, ratingOutOfTen);
         ratingText.setText(ratingString);
-        float ratingValue = rating.value / rating.max * 5;
+        float ratingValue = (float) Math.round(rating.value / rating.max * 10) / 2;
         ratingBar.setNumStars(Math.round(ratingValue));
         ratingBar.setRating(ratingValue);
         String ratingCount = getContext().getString(R.string.item_rating_count_format,

File: app/src/main/java/me/zhanghai/android/douya/item/ui/RatingLayout.java
Patch:
@@ -63,7 +63,7 @@ public void setRating(SimpleRating rating) {
         float ratingOutOfTen = (float) Math.round(rating.value / rating.max * 10 * 10) / 10;
         String ratingString = getContext().getString(R.string.item_rating_format, ratingOutOfTen);
         mRatingText.setText(ratingString);
-        float ratingValue = rating.value / rating.max * 5;
+        float ratingValue = (float) Math.round(rating.value / rating.max * 10) / 2;
         mRatingBar.setRating(ratingValue);
         String ratingCount = getContext().getString(R.string.item_rating_count_format,
                 rating.count);

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Diary.java
Patch:
@@ -11,6 +11,7 @@
 
 import com.google.gson.annotations.SerializedName;
 
+// TODO: Extend from BaseItem.
 public class Diary implements Parcelable {
 
     public enum Visibility {

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Review.java
Patch:
@@ -13,6 +13,7 @@
 import java.util.ArrayList;
 import java.util.List;
 
+// TODO: Extend from BaseItem.
 public class Review implements Parcelable {
 
     public enum VoteState {

File: app/src/main/java/me/zhanghai/android/douya/item/content/BaseItemFragmentResource.java
Patch:
@@ -263,6 +263,7 @@ public void notifyChangedIfLoaded() {
             ItemType item = getItem();
             Rating rating = mRatingResource.get();
             rating.rating = item.rating;
+            rating.ratingUnavailableReason = item.ratingUnavailableReason;
             notifyChanged(getRequestCode(), item, rating, mPhotoListResource.get(),
                     mReviewListResource.get());
         }

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/apiv2/Image.java
Patch:
@@ -36,9 +36,9 @@ public class Image implements ImageItemWithSize, Parcelable {
      */
     @SerializedName("thumb")
     public String medium;
-    
+
     public String type;
-    
+
     public int width;
 
 
@@ -98,7 +98,7 @@ public int getSmallHeight() {
 
     @Override
     public boolean isAnimated() {
-        return false;
+        return isAnimated;
     }
 
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiService.java
Patch:
@@ -23,6 +23,7 @@
 import me.zhanghai.android.douya.network.api.info.apiv2.User;
 import me.zhanghai.android.douya.network.api.info.apiv2.UserList;
 import me.zhanghai.android.douya.network.api.info.frodo.CollectableItem;
+import me.zhanghai.android.douya.network.api.info.frodo.CompleteCollectableItem;
 import me.zhanghai.android.douya.network.api.info.frodo.DiaryList;
 import me.zhanghai.android.douya.network.api.info.frodo.Movie;
 import me.zhanghai.android.douya.network.api.info.frodo.Notification;
@@ -411,8 +412,8 @@ ApiRequest<ReviewList> getUserReviewList(@Path("userIdOrUid") String userIdOrUid
                                                  @Query("count") Integer count);
 
         @GET("{itemType}/{itemId}")
-        ApiRequest<CollectableItem> getItem(@Path("itemType") String itemType,
-                                                @Path("itemId") long itemId);
+        ApiRequest<CompleteCollectableItem> getItem(@Path("itemType") String itemType,
+                                                    @Path("itemId") long itemId);
 
         @GET("{itemType}/{itemId}/rating")
         ApiRequest<Rating> getItemRating(@Path("itemType") String itemType,

File: app/src/main/java/me/zhanghai/android/douya/util/GsonHelper.java
Patch:
@@ -10,15 +10,16 @@
 import com.google.gson.reflect.TypeToken;
 
 import me.zhanghai.android.douya.network.api.info.frodo.CollectableItem;
+import me.zhanghai.android.douya.network.api.info.frodo.CompleteCollectableItem;
 
 public class GsonHelper {
 
     private static final Gson GSON = new GsonBuilder()
             .serializeNulls()
             .registerTypeAdapter(new TypeToken<CollectableItem>() {}.getType(),
                     new CollectableItem.Deserializer())
-            .registerTypeAdapter(new TypeToken<CollectableItem>() {}.getType(),
-                    new CollectableItem.Serializer())
+            .registerTypeAdapter(new TypeToken<CompleteCollectableItem>() {}.getType(),
+                    new CompleteCollectableItem.Deserializer())
             // TODO
             .create();
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiError.java
Patch:
@@ -185,7 +185,7 @@ public int getErrorStringRes() {
         }
 
         Integer StringRes = ERROR_CODE_STRING_RES_MAP.get(code);
-        return StringRes != null ? StringRes : R.string.api_error_unknown;
+        return StringRes != 0 ? StringRes : R.string.api_error_unknown;
     }
 
     public static int getErrorStringRes(Throwable error) {

File: app/src/main/java/me/zhanghai/android/douya/ui/PolygonShape.java
Patch:
@@ -50,6 +50,8 @@ public void draw(Canvas canvas, Paint paint) {
 
     @Override
     public PolygonShape clone() throws CloneNotSupportedException {
-        return (PolygonShape) super.clone();
+        PolygonShape polygonShape = (PolygonShape) super.clone();
+        polygonShape.mPolygon = new Path(mPolygon);
+        return polygonShape;
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/item/ui/RatingDistributionLayout.java
Patch:
@@ -44,7 +44,7 @@ public RatingDistributionLayout(Context context, AttributeSet attrs) {
     private void init() {
 
         setDividerDrawable(ContextCompat.getDrawable(getContext(),
-                R.drawable.rating_distribution_layout_divider));
+                R.drawable.transparent_divider_vertical_2dp));
         setShowDividers(SHOW_DIVIDER_MIDDLE);
         setColumnShrinkable(1, true);
         setColumnStretchable(1, true);

File: app/src/main/java/me/zhanghai/android/douya/glide/info/InfoLibraryGlideModule.java
Patch:
@@ -7,6 +7,7 @@
 
 import android.content.Context;
 
+import com.bumptech.glide.Glide;
 import com.bumptech.glide.Registry;
 import com.bumptech.glide.annotation.GlideModule;
 import com.bumptech.glide.module.LibraryGlideModule;
@@ -17,7 +18,7 @@
 public final class InfoLibraryGlideModule extends LibraryGlideModule {
 
     @Override
-    public void registerComponents(Context context, Registry registry) {
+    public void registerComponents(Context context, Glide glide, Registry registry) {
         registry.prepend(File.class, ImageInfo.class, new FileImageInfoDecoder());
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/glide/progress/okhttp3/OkHttpLibraryGlideModule.java
Patch:
@@ -7,6 +7,7 @@
 
 import android.content.Context;
 
+import com.bumptech.glide.Glide;
 import com.bumptech.glide.Registry;
 import com.bumptech.glide.annotation.GlideModule;
 import com.bumptech.glide.load.model.GlideUrl;
@@ -26,7 +27,7 @@
 public final class OkHttpLibraryGlideModule extends LibraryGlideModule {
 
     @Override
-    public void registerComponents(Context context, Registry registry) {
+    public void registerComponents(Context context, Glide glide, Registry registry) {
         registry.replace(GlideUrl.class, InputStream.class, new OkHttpUrlLoader.Factory());
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiService.java
Patch:
@@ -83,8 +83,10 @@ private static AuthenticationService createAuthenticationService() {
 
     private static OkHttpClient createApiHttpClient(Interceptor interceptor, String authTokenType) {
         return new OkHttpClient.Builder()
+                // AuthenticationInterceptor may retry the request, so it must be an application
+                // interceptor.
+                .addInterceptor(new ApiAuthenticationInterceptor(authTokenType))
                 .addNetworkInterceptor(interceptor)
-                .addNetworkInterceptor(new ApiAuthenticationInterceptor(authTokenType))
                 .addNetworkInterceptor(new StethoInterceptor())
                 .build();
     }

File: app/src/main/java/me/zhanghai/android/douya/ui/WebViewActivity.java
Patch:
@@ -45,6 +45,7 @@
 import me.zhanghai.android.douya.settings.info.Settings;
 import me.zhanghai.android.douya.util.ClipboardUtils;
 import me.zhanghai.android.douya.util.IntentUtils;
+import me.zhanghai.android.douya.util.NightModeHelper;
 import me.zhanghai.android.douya.util.StringUtils;
 import me.zhanghai.android.douya.util.ToastUtils;
 import me.zhanghai.android.douya.util.UrlUtils;
@@ -100,7 +101,7 @@ protected void onDestroy() {
 
     @Override
     public void onConfigurationChanged(Configuration newConfig) {
-        super.onConfigurationChanged(newConfig);
+        super.onConfigurationChanged(NightModeHelper.onConfigurationChanged(newConfig, this));
 
         Toolbar newToolbar = (Toolbar) LayoutInflater.from(mToolbar.getContext())
                 .inflate(R.layout.webview_acitivity_toolbar, mAppbarWrapperLayout, false);

File: app/src/main/java/me/zhanghai/android/douya/link/DoubanUriHandler.java
Patch:
@@ -104,7 +104,7 @@ public static boolean open(Uri uri, Context context) {
             case MOVIE:
             case MOVIE_FRODO:
                 // FIXME: Not finished, disable for release build.
-                if (BuildConfig.DEBUG) {
+                if (!BuildConfig.DEBUG) {
                     return false;
                 }
                 intent = MovieActivity.makeIntent(UriUtils.parseId(uri), context);

File: app/src/main/java/me/zhanghai/android/douya/gallery/ui/GalleryAdapter.java
Patch:
@@ -228,11 +228,11 @@ private boolean shouldUseLargeImageView(ImageInfo imageInfo) {
         }
         if (imageInfo.width > 2048 || imageInfo.height > 2048) {
             float ratio = (float) imageInfo.width / imageInfo.height;
-            if (ratio > 0.5 && ratio < 2) {
-                return false;
+            if (ratio < 0.5 || ratio > 2) {
+                return true;
             }
         }
-        return true;
+        return false;
     }
 
     private void showError(@Nullable Exception e, int resId, ViewHolder holder) {

File: app/src/main/java/me/zhanghai/android/effortlesspermissions/EffortlessPermissions.java
Patch:
@@ -228,8 +228,8 @@ private static void runAfterPermissionDenied(@NonNull Object object, int request
                         if (!(parameterTypes.length == 0 || (parameterTypes.length == 1
                                 && parameterTypes[0].isAssignableFrom(List.class)))) {
                             throw new RuntimeException("Cannot execute method " + method.getName() +
-                                    " because its parameter list is not empty or contains only a" +
-                                    " List<String>.");
+                                    " because its parameter list is not empty or containing only" +
+                                    " a List<String>.");
                         }
                         try {
                             if (!method.isAccessible()) {

File: app/src/main/java/me/zhanghai/android/douya/ui/LicensesDialogFragment.java
Patch:
@@ -65,6 +65,7 @@ public Dialog onCreateDialog(Bundle savedInstanceState) {
                 R.string.settings_open_source_licenses_html_style_light
                 : R.string.settings_open_source_licenses_html_style_dark;
         return new LicensesDialog.Builder(getActivity())
+                .setThemeResourceId(getTheme())
                 .setTitle(R.string.settings_open_source_licenses_title)
                 .setCloseText(R.string.close)
                 .setNotices(mNotices)

File: app/src/main/java/me/zhanghai/android/douya/ui/ViewStatePagerAdapter.java
Patch:
@@ -68,6 +68,7 @@ public Parcelable saveState() {
     @Override
     public void restoreState(Parcelable state, ClassLoader loader) {
         Bundle bundle = (Bundle) state;
+        bundle.setClassLoader(loader);
         int size = bundle.getInt(STATE_VIEW_STATES_SIZE);
         for (int i = 0; i < size; ++i) {
             mViewStates.put(i, bundle.getSparseParcelableArray(makeViewStateKey(i)));

File: app/src/main/java/me/zhanghai/android/douya/settings/ui/SettingsFragment.java
Patch:
@@ -47,7 +47,6 @@ public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, Strin
         if (!TextUtils.equals(key, Settings.NIGHT_MODE.getKey())) {
             return;
         }
-        NightModeHelper.syncDefaultNightMode();
         NightModeHelper.updateNightMode((AppCompatActivity) getActivity());
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BaseBroadcastListFragment.java
Patch:
@@ -11,6 +11,7 @@
 import android.support.annotation.Nullable;
 import android.support.v4.app.ActivityCompat;
 import android.support.v4.app.Fragment;
+import android.support.v4.widget.FriendlySwipeRefreshLayout;
 import android.support.v4.widget.SwipeRefreshLayout;
 import android.support.v7.widget.RecyclerView;
 import android.support.v7.widget.StaggeredGridLayoutManager;
@@ -33,7 +34,6 @@
 import me.zhanghai.android.douya.network.api.info.apiv2.Broadcast;
 import me.zhanghai.android.douya.ui.AppBarHost;
 import me.zhanghai.android.douya.ui.FriendlyFloatingActionButton;
-import me.zhanghai.android.douya.ui.FriendlySwipeRefreshLayout;
 import me.zhanghai.android.douya.ui.LoadMoreAdapter;
 import me.zhanghai.android.douya.ui.NoChangeAnimationItemAnimator;
 import me.zhanghai.android.douya.ui.OnVerticalScrollWithPagingTouchSlopListener;

File: app/src/main/java/me/zhanghai/android/douya/DouyaApplication.java
Patch:
@@ -30,7 +30,7 @@ public static DouyaApplication getInstance() {
     public void onCreate() {
         super.onCreate();
 
-        NightModeHelper.syncDefaultNightMode();
+        NightModeHelper.setup(this);
 
         AndroidThreeTen.init(this);
         FabricUtils.init(this);

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileIntroductionLayout.java
Patch:
@@ -56,7 +56,9 @@ public void setListener(Listener listener) {
     }
 
     public void bind(String introduction) {
-        introduction = introduction.trim();
+        introduction = introduction
+                .replaceAll("\\A(\\h*\n)*", "")
+                .replaceAll("(\n\\h*)*\n?\\Z", "");
         if (!TextUtils.isEmpty(introduction)) {
             final String finalIntroduction = introduction;
             mTitleText.setOnClickListener(new OnClickListener() {

File: app/src/main/java/me/zhanghai/android/douya/gallery/ui/GalleryAdapter.java
Patch:
@@ -226,7 +226,7 @@ private boolean shouldUseLargeImageView(ImageInfo imageInfo) {
         if (imageInfo.width == 0 || imageInfo.height == 0) {
             return false;
         }
-        float ratio = imageInfo.width / imageInfo.height;
+        float ratio = (float) imageInfo.width / imageInfo.height;
         if (ratio > 0.5 && ratio < 2) {
             return false;
         }

File: app/src/main/java/me/zhanghai/android/douya/DouyaApplication.java
Patch:
@@ -8,10 +8,10 @@
 import android.app.Application;
 
 import com.bumptech.glide.request.target.ViewTarget;
+import com.facebook.stetho.Stetho;
 import com.jakewharton.threetenabp.AndroidThreeTen;
 
 import me.zhanghai.android.douya.fabric.FabricUtils;
-import me.zhanghai.android.douya.util.StethoHelper;
 
 public class DouyaApplication extends Application {
 
@@ -32,6 +32,6 @@ public void onCreate() {
         AndroidThreeTen.init(this);
         FabricUtils.init(this);
         ViewTarget.setTagId(R.id.glide_view_target_tag);
-        StethoHelper.initializeWithDefaults(this);
+        Stetho.initializeWithDefaults(this);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/util/ImageUtils.java
Patch:
@@ -172,6 +172,8 @@ public static void loadImageWithRatio(RatioImageView view,
         GlideApp.with(view.getContext())
                 .load(image.medium)
                 .apply(REQUEST_OPTIONS_LOAD_IMAGE_WITH_RATIO)
+                .transition(DrawableTransitionOptions.withCrossFade(ViewUtils.getShortAnimTime(
+                        view)))
                 .into(view);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/glide/progress/okhttp3/OkHttpUrlLoader.java
Patch:
@@ -38,6 +38,8 @@ public boolean handles(GlideUrl url) {
     public LoadData<InputStream> buildLoadData(GlideUrl model, int width, int height,
                                                Options options) {
         ProgressListener progressListener = options.get(ProgressGlideExtension.OPTION_LISTENER);
+        // Otherwise memory leak happens because options is kept in cache.
+        options.set(ProgressGlideExtension.OPTION_LISTENER, null);
         return new LoadData<>(model, new OkHttpStreamFetcher(client, model, progressListener));
     }
 

File: app/src/main/java/me/zhanghai/android/douya/DouyaApplication.java
Patch:
@@ -11,6 +11,7 @@
 import com.jakewharton.threetenabp.AndroidThreeTen;
 
 import me.zhanghai.android.douya.fabric.FabricUtils;
+import me.zhanghai.android.douya.util.StethoHelper;
 
 public class DouyaApplication extends Application {
 
@@ -29,9 +30,8 @@ public void onCreate() {
         super.onCreate();
 
         AndroidThreeTen.init(this);
-
         FabricUtils.init(this);
-
         ViewTarget.setTagId(R.id.glide_view_target_tag_id);
+        StethoHelper.initializeWithDefaults(this);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/ui/WhiteIndeterminateProgressIconDrawable.java
Patch:
@@ -19,7 +19,7 @@
 import android.support.annotation.NonNull;
 import android.support.annotation.Nullable;
 
-import me.zhanghai.android.materialprogressbar.IndeterminateProgressDrawable;
+import me.zhanghai.android.materialprogressbar.IndeterminateCircularProgressDrawable;
 
 public class WhiteIndeterminateProgressIconDrawable extends Drawable implements Animatable {
 
@@ -148,7 +148,7 @@ public void draw(Canvas canvas) {
         mProgressDrawable.draw(canvas);
     }
 
-    public class ProgressDrawable extends IndeterminateProgressDrawable {
+    public class ProgressDrawable extends IndeterminateCircularProgressDrawable {
 
         public ProgressDrawable(Context context) {
             super(context);

File: app/src/main/java/me/zhanghai/android/douya/link/FrodoBridge.java
Patch:
@@ -29,7 +29,7 @@ public class FrodoBridge {
     private static final String SEARCH_EXTRA_TYPE = "com.douban.frodo.QUERY_TYPE";
     private static final String SEARCH_EXTRA_ENTRY = "search_entry";
 
-    private static final String SEND_STATUS_CLASS_NAME = ".activity.StatusEditActivity";
+    private static final String SEND_STATUS_CLASS_NAME = ".status.activity.StatusEditActivity";
     private static final String SEND_STATUS_EXTRA_HASHTAG_NAME = "hashtag_name";
 
     private FrodoBridge() {}

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileFragment.java
Patch:
@@ -259,7 +259,7 @@ public void onChanged(int requestCode, User newUser, List<Broadcast> newBroadcas
 
     @Override
     public void onEditProfile(User user) {
-        NotImplementedManager.showNotYetImplementedToast(getActivity());
+        NotImplementedManager.editProfile(getActivity());
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/util/TintHelper.java
Patch:
@@ -12,8 +12,8 @@
 import android.support.v4.content.ContextCompat;
 import android.support.v4.graphics.drawable.DrawableCompat;
 import android.support.v7.app.AppCompatActivity;
-import android.support.v7.view.ContextThemeWrapper;
 import android.support.v7.widget.Toolbar;
+import android.view.ContextThemeWrapper;
 import android.view.Menu;
 import android.view.MenuItem;
 import android.view.SubMenu;

File: app/src/main/java/android/support/v7/widget/FriendlySwitchCompat.java
Patch:
@@ -71,7 +71,7 @@
  * @attr ref android.support.v7.appcompat.R.styleable#SwitchCompat_track
  */
 @SuppressLint("PrivateResource")
-@SuppressWarnings({"JavaDoc", "unused"})
+@SuppressWarnings({"JavaDoc", "RestrictedApi", "unused"})
 public class FriendlySwitchCompat extends CompoundButton {
     private static final int THUMB_ANIMATION_DURATION = 250;
 

File: app/src/main/java/me/zhanghai/android/douya/ui/CardIconButton.java
Patch:
@@ -53,6 +53,7 @@ public CardIconButton(Context context, AttributeSet attrs, int defStyleAttr, int
         init(attrs, defStyleAttr, defStyleRes);
     }
 
+    @SuppressWarnings("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
 
         setClickable(true);

File: app/src/main/java/me/zhanghai/android/douya/ui/ContentStateLayout.java
Patch:
@@ -70,6 +70,7 @@ public ContentStateLayout(Context context, AttributeSet attrs, int defStyleAttr,
         init(attrs, defStyleAttr, defStyleRes);
     }
 
+    @SuppressWarnings("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(getContext(), attrs,
                 R.styleable.ContentStateLayout, defStyleAttr, defStyleRes);

File: app/src/main/java/me/zhanghai/android/douya/ui/ForegroundHelper.java
Patch:
@@ -50,6 +50,7 @@ public ForegroundHelper(Delegate delegate) {
         mDelegate = delegate;
     }
 
+    @SuppressWarnings("RestrictedApi")
     public void init(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) {
 
         // TODO: Check for FrameLayout

File: app/src/main/java/me/zhanghai/android/douya/ui/FriendlyCardView.java
Patch:
@@ -35,6 +35,7 @@ public FriendlyCardView(Context context, AttributeSet attrs, int defStyleAttr) {
         init(attrs, defStyleAttr);
     }
 
+    @SuppressWarnings("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr) {
 
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(getContext(), attrs,

File: app/src/main/java/me/zhanghai/android/douya/ui/FriendlySwipeRefreshLayout.java
Patch:
@@ -43,6 +43,7 @@ public FriendlySwipeRefreshLayout(Context context, AttributeSet attrs) {
         init(attrs);
     }
 
+    @SuppressWarnings("RestrictedApi")
     private void init(AttributeSet attrs) {
 
         updateCircleDiameter();

File: app/src/main/java/me/zhanghai/android/douya/ui/ImageLayout.java
Patch:
@@ -55,6 +55,7 @@ public ImageLayout(Context context, AttributeSet attrs, int defStyleAttr, int de
         init(attrs, defStyleAttr, defStyleRes);
     }
 
+    @SuppressWarnings("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
 
         setClickable(true);

File: app/src/main/java/me/zhanghai/android/douya/ui/InsetBackgroundFrameLayout.java
Patch:
@@ -54,6 +54,7 @@ public InsetBackgroundFrameLayout(Context context, AttributeSet attrs, int defSt
         init(attrs, defStyleAttr, defStyleRes);
     }
 
+    @SuppressWarnings("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
 
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(getContext(), attrs,

File: app/src/main/java/me/zhanghai/android/douya/ui/MaxDimensionDispatchInsetsFrameLayout.java
Patch:
@@ -51,7 +51,7 @@ public MaxDimensionDispatchInsetsFrameLayout(Context context, AttributeSet attrs
     }
 
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
-        mMaxDimensionHelper.onInit(getContext(), attrs, defStyleAttr, defStyleRes);
+        mMaxDimensionHelper.init(getContext(), attrs, defStyleAttr, defStyleRes);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/ui/MaxDimensionHelper.java
Patch:
@@ -28,7 +28,8 @@ public MaxDimensionHelper(Delegate delegate) {
         mDelegate = delegate;
     }
 
-    public void onInit(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) {
+    @SuppressWarnings("RestrictedApi")
+    public void init(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) {
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(context, attrs, STYLEABLE,
                 defStyleAttr, defStyleRes);
         mMaxWidth = a.getDimensionPixelSize(STYLEABLE_ANDROID_MAX_WIDTH, -1);

File: app/src/main/java/me/zhanghai/android/douya/ui/RatioHeightRecyclerView.java
Patch:
@@ -38,6 +38,7 @@ public RatioHeightRecyclerView(Context context, AttributeSet attrs, int defStyle
         init(attrs, defStyle);
     }
 
+    @SuppressWarnings("RestrictedApi")
     private void init(AttributeSet attrs, int defStyle) {
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(getContext(), attrs,
                 R.styleable.RatioHeightRecyclerView, defStyle, 0);

File: app/src/main/java/me/zhanghai/android/douya/ui/TintStateListImageView.java
Patch:
@@ -38,6 +38,7 @@ public TintStateListImageView(Context context, AttributeSet attrs, int defStyleA
         init(attrs, defStyleAttr, 0);
     }
 
+    @SuppressWarnings("RestrictedApi")
     private void init(AttributeSet attrs, int defStyleAttr, int defStyleRes) {
         TintTypedArray a = TintTypedArray.obtainStyledAttributes(getContext(), attrs,
                 R.styleable.TintStateListImageView, defStyleAttr, defStyleRes);

File: app/src/main/java/me/zhanghai/android/douya/util/TransitionUtils.java
Patch:
@@ -41,7 +41,7 @@ public static boolean shouldEnableTransition() {
         // But this fix (
         // https://android.googlesource.com/platform/frameworks/base/+/a0a0260e48e1ee4e9b5d98b49571e8d2a6fd6c3a
         // ) should have been incorporated into android-5.0.0_r1. So I really don't know the root
-        // cause now.﻿
+        // cause now.
         // New finding at 2015-12-06: OOM even happens on Android 5.1 (CM).
         // TODO: Allow disabling transition on some pre-marshmallow devices for OOM.
         return Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastLikerListResource.java
Patch:
@@ -12,7 +12,7 @@
 
 import me.zhanghai.android.douya.network.api.ApiRequest;
 import me.zhanghai.android.douya.network.api.ApiRequests;
-import me.zhanghai.android.douya.network.api.info.apiv2.User;
+import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 import me.zhanghai.android.douya.util.FragmentUtils;
 
 public class BroadcastLikerListResource extends BroadcastUserListResource {
@@ -52,7 +52,7 @@ protected BroadcastLikerListResource setArguments(long broadcastId) {
     }
 
     @Override
-    protected ApiRequest<List<User>> onCreateRequest(Integer start, Integer count) {
+    protected ApiRequest<List<SimpleUser>> onCreateRequest(Integer start, Integer count) {
         return ApiRequests.newBroadcastLikerListRequest(getBroadcastId(), start, count);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastRebroadcasterListResource.java
Patch:
@@ -12,7 +12,7 @@
 
 import me.zhanghai.android.douya.network.api.ApiRequest;
 import me.zhanghai.android.douya.network.api.ApiRequests;
-import me.zhanghai.android.douya.network.api.info.apiv2.User;
+import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 import me.zhanghai.android.douya.util.FragmentUtils;
 
 public class BroadcastRebroadcasterListResource extends BroadcastUserListResource {
@@ -53,7 +53,7 @@ protected BroadcastRebroadcasterListResource setArguments(long broadcastId) {
     }
 
     @Override
-    protected ApiRequest<List<User>> onCreateRequest(Integer start, Integer count) {
+    protected ApiRequest<List<SimpleUser>> onCreateRequest(Integer start, Integer count) {
         return ApiRequests.newBroadcastRebroadcasterListRequest(getBroadcastId(), start, count);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastActivity.java
Patch:
@@ -29,7 +29,7 @@ public static Intent makeIntent(long broadcastId, Context context) {
     }
 
     public static Intent makeIntent(Broadcast broadcast, Context context) {
-        return new Intent(context, BroadcastActivity.class)
+        return makeIntent(broadcast.id, context)
                 .putExtra(EXTRA_BROADCAST, broadcast);
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastFragment.java
Patch:
@@ -73,8 +73,8 @@ public class BroadcastFragment extends Fragment implements BroadcastAndCommentLi
 
     private static final String KEY_PREFIX = BroadcastFragment.class.getName() + '.';
 
-    private static final String EXTRA_BROADCAST = KEY_PREFIX + "broadcast";
     private static final String EXTRA_BROADCAST_ID = KEY_PREFIX + "broadcast_id";
+    private static final String EXTRA_BROADCAST = KEY_PREFIX + "broadcast";
     private static final String EXTRA_SHOW_SEND_COMMENT = KEY_PREFIX + "show_send_comment";
     private static final String EXTRA_TITLE = KEY_PREFIX + "title";
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLikerListFragment.java
Patch:
@@ -9,7 +9,7 @@
 
 import me.zhanghai.android.douya.broadcast.content.BroadcastLikerListResource;
 import me.zhanghai.android.douya.network.api.info.apiv2.Broadcast;
-import me.zhanghai.android.douya.network.api.info.apiv2.User;
+import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 import me.zhanghai.android.douya.user.content.BaseUserListResource;
 
 public class BroadcastLikerListFragment extends BroadcastUserListFragment {
@@ -36,7 +36,7 @@ protected BaseUserListResource<?> onAttachUserListResource() {
     }
 
     @Override
-    protected boolean onUpdateBroadcast(Broadcast broadcast, List<User> userList) {
+    protected boolean onUpdateBroadcast(Broadcast broadcast, List<SimpleUser> userList) {
         if (broadcast.likeCount < userList.size()) {
             broadcast.likeCount = userList.size();
             return true;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastListActivity.java
Patch:
@@ -10,7 +10,7 @@
 import android.os.Bundle;
 import android.support.v7.app.AppCompatActivity;
 
-import me.zhanghai.android.douya.network.api.info.apiv2.User;
+import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 import me.zhanghai.android.douya.util.FragmentUtils;
 import me.zhanghai.android.douya.util.TransitionUtils;
 
@@ -27,7 +27,7 @@ public static Intent makeIntent(String userIdOrUid, Context context) {
                 .putExtra(EXTRA_USER_ID_OR_UID, userIdOrUid);
     }
 
-    public static Intent makeIntent(User user, Context context) {
+    public static Intent makeIntent(SimpleUser user, Context context) {
         return new Intent(context, BroadcastListActivity.class)
                 .putExtra(EXTRA_USER, user);
     }
@@ -52,7 +52,7 @@ protected void onCreate(Bundle savedInstanceState) {
         if (savedInstanceState == null) {
             Intent intent = getIntent();
             String userIdOrUid = intent.getStringExtra(EXTRA_USER_ID_OR_UID);
-            User user = intent.getParcelableExtra(EXTRA_USER);
+            SimpleUser user = intent.getParcelableExtra(EXTRA_USER);
             String topic = intent.getStringExtra(EXTRA_TOPIC);
             FragmentUtils.add(BroadcastListActivityFragment.newInstance(userIdOrUid, user, topic),
                     this, android.R.id.content);

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastRebroadcasterListFragment.java
Patch:
@@ -9,7 +9,7 @@
 
 import me.zhanghai.android.douya.broadcast.content.BroadcastRebroadcasterListResource;
 import me.zhanghai.android.douya.network.api.info.apiv2.Broadcast;
-import me.zhanghai.android.douya.network.api.info.apiv2.User;
+import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 import me.zhanghai.android.douya.user.content.BaseUserListResource;
 
 public class BroadcastRebroadcasterListFragment extends BroadcastUserListFragment {
@@ -36,7 +36,7 @@ protected BaseUserListResource<?> onAttachUserListResource() {
     }
 
     @Override
-    protected boolean onUpdateBroadcast(Broadcast broadcast, List<User> userList) {
+    protected boolean onUpdateBroadcast(Broadcast broadcast, List<SimpleUser> userList) {
         if (broadcast.rebroadcastCount < userList.size()) {
             broadcast.rebroadcastCount = userList.size();
             return true;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastUserListFragment.java
Patch:
@@ -15,7 +15,7 @@
 import me.zhanghai.android.douya.eventbus.BroadcastUpdatedEvent;
 import me.zhanghai.android.douya.eventbus.EventBusUtils;
 import me.zhanghai.android.douya.network.api.info.apiv2.Broadcast;
-import me.zhanghai.android.douya.network.api.info.apiv2.User;
+import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 import me.zhanghai.android.douya.user.ui.BaseUserAdapter;
 import me.zhanghai.android.douya.user.ui.DialogUserAdapter;
 import me.zhanghai.android.douya.user.ui.UserListFragment;
@@ -58,7 +58,7 @@ public void onStop() {
     }
 
     @Override
-    protected void onUserListUpdated(List<User> userList) {
+    protected void onUserListUpdated(List<SimpleUser> userList) {
         if (onUpdateBroadcast(mBroadcast, userList)) {
             EventBusUtils.postAsync(new BroadcastUpdatedEvent(mBroadcast, this));
         }
@@ -69,7 +69,7 @@ protected BaseUserAdapter onCreateAdapter() {
         return new DialogUserAdapter();
     }
 
-    protected abstract boolean onUpdateBroadcast(Broadcast broadcast, List<User> userList);
+    protected abstract boolean onUpdateBroadcast(Broadcast broadcast, List<SimpleUser> userList);
 
     @Subscribe(threadMode = ThreadMode.MAIN)
     public void onBroadcastUpdated(BroadcastUpdatedEvent event) {

File: app/src/main/java/me/zhanghai/android/douya/eventbus/UserWriteFinishedEvent.java
Patch:
@@ -5,11 +5,11 @@
 
 package me.zhanghai.android.douya.eventbus;
 
-public class UserInfoWriteStartedEvent extends Event {
+public class UserWriteFinishedEvent extends Event {
 
     public String userIdOrUid;
 
-    public UserInfoWriteStartedEvent(String userIdOrUid, Object source) {
+    public UserWriteFinishedEvent(String userIdOrUid, Object source) {
         super(source);
 
         this.userIdOrUid = userIdOrUid;

File: app/src/main/java/me/zhanghai/android/douya/eventbus/UserWriteStartedEvent.java
Patch:
@@ -5,11 +5,11 @@
 
 package me.zhanghai.android.douya.eventbus;
 
-public class UserInfoWriteFinishedEvent extends Event {
+public class UserWriteStartedEvent extends Event {
 
     public String userIdOrUid;
 
-    public UserInfoWriteFinishedEvent(String userIdOrUid, Object source) {
+    public UserWriteStartedEvent(String userIdOrUid, Object source) {
         super(source);
 
         this.userIdOrUid = userIdOrUid;

File: app/src/main/java/me/zhanghai/android/douya/navigation/ui/NavigationViewAdapter.java
Patch:
@@ -153,7 +153,7 @@ public void onAccountListChanged() {
         notifyAccountListViewChanged();
     }
 
-    public void onUserInfoChanged() {
+    public void onUserChanged() {
         notifyAccountListViewChanged();
     }
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiContract.java
Patch:
@@ -88,8 +88,8 @@ interface UserReviewList {
                 String COUNT = "count";
             }
 
-            interface Item {
-                String URL_FORMAT = API_HOST + "subject/%d";
+            interface Movie {
+                String URL_FORMAT = API_HOST + "movie/%d";
             }
 
             interface ItemReviewList {
@@ -121,7 +121,7 @@ interface Versions {
                 }
             }
 
-            interface UserInfo {
+            interface User {
 
                 String URL_FORMAT = API_HOST + "lifestream/user/%s";
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/apiv2/Broadcast.java
Patch:
@@ -24,7 +24,7 @@ public class Broadcast implements Parcelable {
 
     public Attachment attachment;
 
-    public User author;
+    public SimpleUser author;
 
     @SerializedName("can_reply")
     public int canCommentInt;
@@ -191,7 +191,7 @@ public Broadcast() {}
     protected Broadcast(Parcel in) {
         action = in.readString();
         attachment = in.readParcelable(Attachment.class.getClassLoader());
-        author = in.readParcelable(User.class.getClassLoader());
+        author = in.readParcelable(SimpleUser.class.getClassLoader());
         canCommentInt = in.readInt();
         commentCount = in.readInt();
         createdAt = in.readString();

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/apiv2/Comment.java
Patch:
@@ -17,7 +17,7 @@
 
 public class Comment implements Parcelable {
 
-    public User author;
+    public SimpleUser author;
 
     public String content;
 
@@ -60,7 +60,7 @@ public Comment[] newArray(int size) {
     public Comment() {}
 
     protected Comment(Parcel in) {
-        author = in.readParcelable(User.class.getClassLoader());
+        author = in.readParcelable(SimpleUser.class.getClassLoader());
         content = in.readString();
         createdAt = in.readString();
         entities = in.createTypedArrayList(Entity.CREATOR);

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/apiv2/Photo.java
Patch:
@@ -22,7 +22,7 @@ public class Photo implements Parcelable {
 
     public String alt;
 
-    public User author;
+    public SimpleUser author;
 
     public ArrayList<Comment> comments = new ArrayList<>();
 
@@ -99,7 +99,7 @@ protected Photo(Parcel in) {
         albumId = in.readString();
         albumTitle = in.readString();
         alt = in.readString();
-        author = in.readParcelable(User.class.getClassLoader());
+        author = in.readParcelable(SimpleUser.class.getClassLoader());
         comments = in.createTypedArrayList(Comment.CREATOR);
         commentCount = in.readInt();
         cover = in.readString();

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/apiv2/UserList.java
Patch:
@@ -12,7 +12,7 @@
 
 public class UserList extends BaseList implements Parcelable {
 
-    public ArrayList<User> users = new ArrayList<>();
+    public ArrayList<SimpleUser> users = new ArrayList<>();
 
 
     public static final Creator<UserList> CREATOR = new Creator<UserList>() {
@@ -31,7 +31,7 @@ public UserList() {}
     protected UserList(Parcel in) {
         super(in);
 
-        users = in.createTypedArrayList(User.CREATOR);
+        users = in.createTypedArrayList(SimpleUser.CREATOR);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/CollectableItem.java
Patch:
@@ -21,7 +21,7 @@
 import me.zhanghai.android.douya.R;
 
 /**
- * {@code LegacySubject}, for those that can have a rating.
+ * {@code LegacySubject} in Frodo, for those that can have a rating.
  */
 public class CollectableItem extends BaseItem {
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Diary.java
Patch:
@@ -48,7 +48,7 @@ public static Visibility ofString(String apiString) {
     @SerializedName("allow_donate")
     public boolean allowDonate;
 
-    public User author;
+    public SimpleUser author;
 
     @SerializedName("comments_count")
     public int commentCount;
@@ -116,7 +116,7 @@ protected Diary(Parcel in) {
         abstract_ = in.readString();
         allowComment = in.readByte() != 0;
         allowDonate = in.readByte() != 0;
-        author = in.readParcelable(User.class.getClassLoader());
+        author = in.readParcelable(SimpleUser.class.getClassLoader());
         commentCount = in.readInt();
         cover = in.readString();
         creationTime = in.readString();

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Photo.java
Patch:
@@ -14,7 +14,7 @@ public class Photo extends BaseItem {
     @SerializedName("allow_comment")
     public boolean isCommentAllowed;
 
-    public User author;
+    public SimpleUser author;
 
     @SerializedName("create_time")
     public String creationTime;
@@ -55,7 +55,7 @@ protected Photo(Parcel in) {
         super(in);
 
         isCommentAllowed = in.readByte() != 0;
-        author = in.readParcelable(User.class.getClassLoader());
+        author = in.readParcelable(SimpleUser.class.getClassLoader());
         creationTime = in.readString();
         commentCount = in.readInt();
         description = in.readString();

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Review.java
Patch:
@@ -99,7 +99,7 @@ public static VoteState ofApiInt(int apiInt) {
     public int uselessCount;
 
     @SerializedName("user")
-    public User author;
+    public SimpleUser author;
 
     /**
      * @deprecated Use {@link #getVoteState()} instead.
@@ -151,7 +151,7 @@ protected Review(Parcel in) {
         url = in.readString();
         usefulCount = in.readInt();
         uselessCount = in.readInt();
-        author = in.readParcelable(User.class.getClassLoader());
+        author = in.readParcelable(SimpleUser.class.getClassLoader());
         //noinspection deprecation
         voteState = in.readInt();
     }

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileFollowshipLayout.java
Patch:
@@ -19,8 +19,8 @@
 import me.zhanghai.android.douya.R;
 import me.zhanghai.android.douya.followship.ui.FollowerListActivity;
 import me.zhanghai.android.douya.followship.ui.FollowingListActivity;
+import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 import me.zhanghai.android.douya.network.api.info.apiv2.User;
-import me.zhanghai.android.douya.network.api.info.apiv2.UserInfo;
 import me.zhanghai.android.douya.ui.FriendlyCardView;
 import me.zhanghai.android.douya.util.ImageUtils;
 import me.zhanghai.android.douya.util.ViewUtils;
@@ -63,7 +63,7 @@ private void init() {
         ButterKnife.bind(this);
     }
 
-    public void bind(final UserInfo userInfo, List<User> followingList) {
+    public void bind(final User userInfo, List<SimpleUser> followingList) {
 
         final Context context = getContext();
         OnClickListener viewFollowingListListener = new OnClickListener() {
@@ -77,7 +77,7 @@ public void onClick(View view) {
         mViewMoreText.setOnClickListener(viewFollowingListListener);
 
         int i = 0;
-        for (final User user : followingList) {
+        for (final SimpleUser user : followingList) {
 
             if (i >= USER_COUNT_MAX) {
                 break;

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileIntroductionLayout.java
Patch:
@@ -15,7 +15,7 @@
 import butterknife.BindView;
 import butterknife.ButterKnife;
 import me.zhanghai.android.douya.R;
-import me.zhanghai.android.douya.network.api.info.apiv2.UserInfo;
+import me.zhanghai.android.douya.network.api.info.apiv2.User;
 import me.zhanghai.android.douya.ui.FriendlyCardView;
 import me.zhanghai.android.douya.util.ViewUtils;
 
@@ -76,8 +76,8 @@ public void onClick(View view) {
         }
     }
 
-    public void bind(UserInfo userInfo) {
-        bind(userInfo.introduction);
+    public void bind(User user) {
+        bind(user.introduction);
     }
 
     private void onCopyText(String text) {

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileItemsLayout.java
Patch:
@@ -17,7 +17,7 @@
 import butterknife.BindView;
 import butterknife.ButterKnife;
 import me.zhanghai.android.douya.R;
-import me.zhanghai.android.douya.network.api.info.apiv2.UserInfo;
+import me.zhanghai.android.douya.network.api.info.apiv2.User;
 import me.zhanghai.android.douya.network.api.info.frodo.CollectableItem;
 import me.zhanghai.android.douya.network.api.info.frodo.ItemCollectionState;
 import me.zhanghai.android.douya.network.api.info.frodo.UserItems;
@@ -131,9 +131,9 @@ public void onClick(View view) {
         }
     }
 
-    public void bind(UserInfo userInfo, List<UserItems> userItemList) {
+    public void bind(User user, List<UserItems> userItemList) {
 
-        mUserIdOrUid = userInfo.getIdOrUid();
+        mUserIdOrUid = user.getIdOrUid();
 
         UserItems primaryItems = null;
         UserItems secondaryItems = null;

File: app/src/main/java/me/zhanghai/android/douya/user/ui/BaseUserAdapter.java
Patch:
@@ -15,14 +15,14 @@
 import butterknife.BindView;
 import butterknife.ButterKnife;
 import me.zhanghai.android.douya.R;
-import me.zhanghai.android.douya.network.api.info.apiv2.User;
+import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 import me.zhanghai.android.douya.profile.ui.ProfileActivity;
 import me.zhanghai.android.douya.ui.SimpleAdapter;
 import me.zhanghai.android.douya.util.ImageUtils;
 import me.zhanghai.android.douya.util.RecyclerViewUtils;
 import me.zhanghai.android.douya.util.ViewUtils;
 
-public abstract class BaseUserAdapter extends SimpleAdapter<User, BaseUserAdapter.ViewHolder> {
+public abstract class BaseUserAdapter extends SimpleAdapter<SimpleUser, BaseUserAdapter.ViewHolder> {
 
     public BaseUserAdapter() {
         setHasStableIds(true);
@@ -42,7 +42,7 @@ public ViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {
     @Override
     public void onBindViewHolder(final ViewHolder holder, int position) {
         final Context context = RecyclerViewUtils.getContext(holder);
-        final User user = getItem(position);
+        final SimpleUser user = getItem(position);
         holder.itemView.setOnClickListener(new View.OnClickListener() {
             @Override
             public void onClick(View view) {

File: app/src/main/java/me/zhanghai/android/douya/util/DoubanUtils.java
Patch:
@@ -12,7 +12,7 @@
 import java.util.Map;
 
 import me.zhanghai.android.douya.R;
-import me.zhanghai.android.douya.network.api.info.apiv2.User;
+import me.zhanghai.android.douya.network.api.info.apiv2.SimpleUser;
 
 public class DoubanUtils {
 
@@ -70,7 +70,7 @@ public static String getAtUserString(String userIdOrUid) {
         return '@' + userIdOrUid + ' ';
     }
 
-    public static String getAtUserString(User user) {
+    public static String getAtUserString(SimpleUser user) {
         //noinspection deprecation
         return getAtUserString(user.uid);
     }

File: app/src/main/java/me/zhanghai/android/douya/content/MoreRawListResourceFragment.java
Patch:
@@ -12,7 +12,7 @@ public abstract class MoreRawListResourceFragment<ResourceType, ResponseType>
 
     @Override
     protected int getSize(List<ResourceType> resource) {
-        return get().size();
+        return resource.size();
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/account/content/AuthenticateRequest.java
Patch:
@@ -78,10 +78,10 @@ public static class RequestState {
         public String username;
         public String password;
 
-        public RequestState(String authTokenType, String password, String username) {
+        public RequestState(String authTokenType, String username, String password) {
             this.authTokenType = authTokenType;
-            this.password = password;
             this.username = username;
+            this.password = password;
         }
     }
 

File: app/src/main/java/me/zhanghai/android/douya/account/content/AccountUserInfoResource.java
Patch:
@@ -55,7 +55,7 @@ public static AccountUserInfoResource attachTo(Account account, Fragment fragmen
     @SuppressWarnings("deprecation")
     public AccountUserInfoResource() {}
 
-    private void setArguments(Account account) {
+    protected void setArguments(Account account) {
         FragmentUtils.ensureArguments(this).putParcelable(EXTRA_ACCOUNT, account);
         User user = makePartialUser(account);
         setArguments(user.getIdOrUid(), user, AccountUtils.getUserInfo(account));

File: app/src/main/java/me/zhanghai/android/douya/account/ui/AddAccountActivity.java
Patch:
@@ -20,8 +20,9 @@
 
 public class AddAccountActivity extends AppCompatActivity {
 
-    public static final String EXTRA_ON_ADDED_INTENT = AddAccountActivity.class.getName()
-            + ".on_added_intent";
+    private static final String KEY_PREFIX = AddAccountActivity.class.getName() + '.';
+
+    private static final String EXTRA_ON_ADDED_INTENT = KEY_PREFIX + "on_added_intent";
 
     @Override
     protected void onCreate(Bundle savedInstanceState) {

File: app/src/main/java/me/zhanghai/android/douya/account/ui/AuthenticatorActivity.java
Patch:
@@ -22,8 +22,8 @@ public class AuthenticatorActivity extends AppCompatAccountAuthenticatorActivity
     private static final String KEY_PREFIX = AuthenticatorActivity.class.getName() + '.';
 
     // NOTE: EXTRA_AUTH_MODE and must be supplied.
-    public static final String EXTRA_AUTH_MODE = KEY_PREFIX + "auth_mode";
-    public static final String EXTRA_USERNAME = KEY_PREFIX + "username";
+    private static final String EXTRA_AUTH_MODE = KEY_PREFIX + "auth_mode";
+    private static final String EXTRA_USERNAME = KEY_PREFIX + "username";
 
     public static final String AUTH_MODE_NEW = "new";
     public static final String AUTH_MODE_ADD = "add";

File: app/src/main/java/me/zhanghai/android/douya/account/util/AccountUtils.java
Patch:
@@ -321,9 +321,7 @@ public static void selectAccount(Activity activity, Intent onSelectedIntent) {
             throw new IllegalStateException("Should have checked for hasAccount()");
         }
 
-        Intent intent = new Intent(activity, SelectAccountActivity.class);
-        intent.putExtra(SelectAccountActivity.EXTRA_ON_SELECTED_INTENT, onSelectedIntent);
-        activity.startActivity(intent);
+        activity.startActivity(SelectAccountActivity.makeIntent(onSelectedIntent, activity));
     }
 
     public static boolean ensureActiveAccountAvailability(Activity activity) {

File: app/src/main/java/me/zhanghai/android/douya/app/TargetedRetainedFragment.java
Patch:
@@ -19,9 +19,9 @@ public class TargetedRetainedFragment extends RetainedFragment {
 
     private static final String KEY_PREFIX = TargetedRetainedFragment.class.getName() + '.';
 
-    public static final String EXTRA_TARGETED_AT_ACTIVITY = KEY_PREFIX + "targeted_at_activity";
-    public static final String EXTRA_TARGET_FRAGMENT_WHO = KEY_PREFIX + "target_fragment_who";
-    public static final String EXTRA_REQUEST_CODE = KEY_PREFIX + "request_code";
+    private static final String EXTRA_TARGETED_AT_ACTIVITY = KEY_PREFIX + "targeted_at_activity";
+    private static final String EXTRA_TARGET_FRAGMENT_WHO = KEY_PREFIX + "target_fragment_who";
+    private static final String EXTRA_REQUEST_CODE = KEY_PREFIX + "request_code";
 
     private boolean mTargetedAtActivity;
     private Fragment mTargetFragment;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastAndCommentListResource.java
Patch:
@@ -25,8 +25,8 @@ public class BroadcastAndCommentListResource extends TargetedRetainedFragment
 
     private static final String KEY_PREFIX = BroadcastAndCommentListResource.class.getName() + '.';
 
-    public static final String EXTRA_BROADCAST_ID = KEY_PREFIX + "broadcast_id";
-    public static final String EXTRA_BROADCAST = KEY_PREFIX + "broadcast";
+    private static final String EXTRA_BROADCAST_ID = KEY_PREFIX + "broadcast_id";
+    private static final String EXTRA_BROADCAST = KEY_PREFIX + "broadcast";
 
     private static final int BROADCAST_ID_INVALID = -1;
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastCommentListResource.java
Patch:
@@ -24,7 +24,7 @@ public class BroadcastCommentListResource extends CommentListResource {
 
     private static final String KEY_PREFIX = BroadcastCommentListResource.class.getName() + '.';
 
-    public static final String EXTRA_BROADCAST_ID = KEY_PREFIX + "broadcast_id";
+    private static final String EXTRA_BROADCAST_ID = KEY_PREFIX + "broadcast_id";
 
     private long mBroadcastId;
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastListResource.java
Patch:
@@ -33,8 +33,8 @@ public class BroadcastListResource extends MoreRawListResourceFragment<Broadcast
     // Not static because we are to be subclassed.
     private final String KEY_PREFIX = getClass().getName() + '.';
 
-    public final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
-    public final String EXTRA_TOPIC = KEY_PREFIX + "topic";
+    private final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
+    private final String EXTRA_TOPIC = KEY_PREFIX + "topic";
 
     private String mUserIdOrUid;
     private String mTopic;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastActivityDialogFragment.java
Patch:
@@ -36,7 +36,7 @@ public class BroadcastActivityDialogFragment extends AppCompatDialogFragment {
 
     private static final String KEY_PREFIX = BroadcastActivityDialogFragment.class.getName() + '.';
 
-    public static final String EXTRA_BROADCAST = KEY_PREFIX + "broadcast";
+    private static final String EXTRA_BROADCAST = KEY_PREFIX + "broadcast";
 
     @BindView(R.id.tab)
     TabLayout mTabLayout;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastUserListFragment.java
Patch:
@@ -26,7 +26,7 @@ public abstract class BroadcastUserListFragment extends UserListFragment {
     // Not static because we are to be subclassed.
     private final String KEY_PREFIX = getClass().getName() + '.';
 
-    public final String EXTRA_BROADCAST = KEY_PREFIX + "broadcast";
+    private final String EXTRA_BROADCAST = KEY_PREFIX + "broadcast";
 
     private Broadcast mBroadcast;
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/CommentActionDialogFragment.java
Patch:
@@ -24,9 +24,9 @@ public class CommentActionDialogFragment extends AppCompatDialogFragment {
 
     private static final String KEY_PREFIX = CommentActionDialogFragment.class.getName() + '.';
 
-    public static final String EXTRA_COMMENT = KEY_PREFIX + "comment";
-    public static final String EXTRA_CAN_REPLY_TO = KEY_PREFIX + "can_reply_to";
-    public static final String EXTRA_CAN_DELETE = KEY_PREFIX + "can_delete";
+    private static final String EXTRA_COMMENT = KEY_PREFIX + "comment";
+    private static final String EXTRA_CAN_REPLY_TO = KEY_PREFIX + "can_reply_to";
+    private static final String EXTRA_CAN_DELETE = KEY_PREFIX + "can_delete";
 
     private Comment mComment;
     private boolean mCanReplyTo;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/ConfirmDeleteCommentDialogFragment.java
Patch:
@@ -22,7 +22,7 @@ public class ConfirmDeleteCommentDialogFragment extends AppCompatDialogFragment
     private static final String KEY_PREFIX = ConfirmDeleteCommentDialogFragment.class.getName()
             + '.';
 
-    public static final String EXTRA_COMMENT = KEY_PREFIX + "comment";
+    private static final String EXTRA_COMMENT = KEY_PREFIX + "comment";
 
     private Comment mComment;
 

File: app/src/main/java/me/zhanghai/android/douya/followship/content/FollowshipUserListResource.java
Patch:
@@ -13,7 +13,7 @@ public abstract class FollowshipUserListResource extends UserListResource {
     // Not static because we are to be subclassed.
     private final String KEY_PREFIX = getClass().getName() + '.';
 
-    public final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
+    private final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
 
     protected void setArguments(String userIdOrUid) {
         FragmentUtils.ensureArguments(this)

File: app/src/main/java/me/zhanghai/android/douya/followship/ui/FollowshipListFragment.java
Patch:
@@ -17,7 +17,7 @@ public abstract class FollowshipListFragment extends UserListFragment {
     // Not static because we are to be subclassed.
     private final String KEY_PREFIX = getClass().getName() + '.';
 
-    public final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
+    private final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
 
     private String mUserIdOrUid;
 

File: app/src/main/java/me/zhanghai/android/douya/item/ui/ItemCollectionFragment.java
Patch:
@@ -33,7 +33,7 @@ public class ItemCollectionFragment extends Fragment {
 
     private static final String KEY_PREFIX = ItemCollectionFragment.class.getName() + '.';
 
-    public static final String EXTRA_COLLECTION = KEY_PREFIX + "collection";
+    private static final String EXTRA_COLLECTION = KEY_PREFIX + "collection";
 
     @BindView(R.id.toolbar)
     Toolbar mToolbar;

File: app/src/main/java/me/zhanghai/android/douya/profile/content/ProfileResource.java
Patch:
@@ -34,9 +34,9 @@ public class ProfileResource extends TargetedRetainedFragment implements UserInf
 
     private static final String KEY_PREFIX = ProfileResource.class.getName() + '.';
 
-    public static final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
-    public static final String EXTRA_USER = KEY_PREFIX + "user";
-    public static final String EXTRA_USER_INFO = KEY_PREFIX + "user_info";
+    private static final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
+    private static final String EXTRA_USER = KEY_PREFIX + "user";
+    private static final String EXTRA_USER_INFO = KEY_PREFIX + "user_info";
 
     private String mUserIdOrUid;
     private User mUser;

File: app/src/main/java/me/zhanghai/android/douya/review/content/ItemReviewListResource.java
Patch:
@@ -18,7 +18,7 @@ public class ItemReviewListResource extends BaseReviewListResource {
 
     private static final String KEY_PREFIX = ItemReviewListResource.class.getName() + '.';
 
-    public static final String EXTRA_ITEM_ID = KEY_PREFIX + "item_id";
+    private static final String EXTRA_ITEM_ID = KEY_PREFIX + "item_id";
 
     private long mItemId;
 
@@ -52,7 +52,7 @@ public static ItemReviewListResource attachTo(long itemId, Fragment fragment) {
      */
     public ItemReviewListResource() {}
 
-    private void setArguments(long itemId) {
+    protected void setArguments(long itemId) {
         FragmentUtils.ensureArguments(this)
                 .putLong(EXTRA_ITEM_ID, itemId);
     }

File: app/src/main/java/me/zhanghai/android/douya/review/content/UserReviewListResource.java
Patch:
@@ -18,7 +18,7 @@ public class UserReviewListResource extends BaseReviewListResource {
 
     private static final String KEY_PREFIX = UserReviewListResource.class.getName() + '.';
 
-    public final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
+    private final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
 
     private String mUserIdOrUid;
 
@@ -52,7 +52,7 @@ public static UserReviewListResource attachTo(String userIdOrUid, Fragment fragm
      */
     public UserReviewListResource() {}
 
-    private void setArguments(String userIdOrUid) {
+    protected void setArguments(String userIdOrUid) {
         FragmentUtils.ensureArguments(this)
                 .putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
     }

File: app/src/main/java/me/zhanghai/android/douya/ui/CopyTextDialogFragment.java
Patch:
@@ -23,7 +23,7 @@ public class CopyTextDialogFragment extends AppCompatDialogFragment {
 
     private static final String KEY_PREFIX = CopyTextDialogFragment.class.getName() + '.';
 
-    public static final String EXTRA_TEXT = KEY_PREFIX + "text";
+    private static final String EXTRA_TEXT = KEY_PREFIX + "text";
 
     private String mText;
 

File: app/src/main/java/me/zhanghai/android/douya/ui/GalleryActivity.java
Patch:
@@ -27,8 +27,8 @@ public class GalleryActivity extends AppCompatActivity {
 
     private static final String KEY_PREFIX = GalleryActivity.class.getSimpleName() + '.';
 
-    public static final String EXTRA_IMAGE_LIST = KEY_PREFIX + "image_list";
-    public static final String EXTRA_POSITION = KEY_PREFIX + "position";
+    private static final String EXTRA_IMAGE_LIST = KEY_PREFIX + "image_list";
+    private static final String EXTRA_POSITION = KEY_PREFIX + "position";
 
     @BindInt(android.R.integer.config_mediumAnimTime)
     int mToolbarHideDuration;

File: app/src/main/java/me/zhanghai/android/douya/ui/SimpleDialogFragment.java
Patch:
@@ -11,19 +11,19 @@
 import android.content.DialogInterface;
 import android.os.Bundle;
 import android.support.annotation.NonNull;
-import android.support.v4.app.DialogFragment;
 import android.support.v4.app.Fragment;
 import android.support.v4.app.FragmentActivity;
 import android.support.v4.app.FragmentManager;
 import android.support.v7.app.AlertDialog;
+import android.support.v7.app.AppCompatDialogFragment;
 import android.util.TypedValue;
 import android.view.KeyEvent;
 
 import me.zhanghai.android.douya.R;
 import me.zhanghai.android.douya.util.FragmentUtils;
 
 @SuppressWarnings("unused")
-public class SimpleDialogFragment extends DialogFragment {
+public class SimpleDialogFragment extends AppCompatDialogFragment {
 
     private static final String ARGUMENT_REQUEST_CODE = "request_code";
     private static final String ARGUMENT_THEME = "theme";

File: app/src/main/java/me/zhanghai/android/douya/account/ui/AuthenticatorActivity.java
Patch:
@@ -239,7 +239,7 @@ private void attemptStartAuth() {
 
     private void onStartAuth() {
 
-        TokenRequest request = TokenRequests.newRequest(mUsername, mPassword);
+        TokenRequest request = TokenRequests.newRequest(AUTH_TOKEN_TYPE, mUsername, mPassword);
         RequestFragment.startRequest(request, null, this, REQUEST_CODE_AUTH);
 
         mUsernameLayout.setError(null);

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileFragment.java
Patch:
@@ -207,8 +207,8 @@ public void onPrepareOptionsMenu(Menu menu) {
     public boolean onOptionsItemSelected(MenuItem item) {
         switch (item.getItemId()) {
             case R.id.action_send_doumail:
-                // HACK
-                startActivity(ItemCollectionActivity.makeIntent(null, getActivity()));
+                // HACK: For testing
+                //startActivity(ItemCollectionActivity.makeIntent(null, getActivity()));
                 // TODO
                 NotImplementedManager.showNotYetImplementedToast(getActivity());
                 return true;

File: app/src/main/java/me/zhanghai/android/douya/account/ui/AuthenticatorActivity.java
Patch:
@@ -40,7 +40,7 @@ public class AuthenticatorActivity extends AppCompatAccountAuthenticatorActivity
 
     private static final String KEY_PREFIX = AuthenticatorActivity.class.getName() + '.';
 
-    // NOTE: EXTRA_AUTH_MODE and EXTRA_AUTH_TOKEN_TYPE must be supplied.
+    // NOTE: EXTRA_AUTH_MODE and must be supplied.
     public static final String EXTRA_AUTH_MODE = KEY_PREFIX + "auth_mode";
     public static final String EXTRA_USERNAME = KEY_PREFIX + "username";
     // NOTE: EXTRA_PASSWORD should be the original password without obfuscation.

File: app/src/main/java/me/zhanghai/android/douya/util/ViewUtils.java
Patch:
@@ -261,7 +261,6 @@ public static boolean hasW960Dp(Context context) {
 
     public static void hideTextInputLayoutErrorOnTextChange(EditText editText,
                                                             final TextInputLayout textInputLayout) {
-
         editText.addTextChangedListener(new TextWatcher() {
             @Override
             public void beforeTextChanged(CharSequence s, int start, int count, int after) {}

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLayout.java
Patch:
@@ -41,6 +41,7 @@
 import me.zhanghai.android.douya.ui.OnHorizontalScrollListener;
 import me.zhanghai.android.douya.ui.TimeActionTextView;
 import me.zhanghai.android.douya.util.CheatSheetUtils;
+import me.zhanghai.android.douya.util.DoubanUtils;
 import me.zhanghai.android.douya.util.DrawableUtils;
 import me.zhanghai.android.douya.util.ImageUtils;
 import me.zhanghai.android.douya.util.ViewCompat;
@@ -175,8 +176,8 @@ public void bindBroadcast(final Broadcast broadcast) {
             mAvatarImage.setOnClickListener(new OnClickListener() {
                 @Override
                 public void onClick(View view) {
-                    // FIXME
-                    UriHandler.open("https://www.douban.com/interest/1/1/", context);
+                    UriHandler.open(DoubanUtils.getInterestTypeUrl(broadcast.interestType),
+                            context);
                 }
             });
         } else {

File: app/src/main/java/me/zhanghai/android/douya/navigation/ui/NavigationAccountListLayout.java
Patch:
@@ -89,7 +89,7 @@ private void init() {
         ColorStateList iconTintList = ViewUtils.getColorStateListFromAttrRes(
                 android.R.attr.textColorSecondary, context);
         for (TextView menuItem : mMenuItems) {
-            Drawable icon = TextViewCompat.getCompoundDrawablesRelative(menuItem)[0];
+            Drawable icon = menuItem.getCompoundDrawables()[0];
             icon = DrawableCompat.wrap(icon);
             DrawableCompat.setTintList(icon, iconTintList);
             TextViewCompat.setCompoundDrawablesRelative(menuItem, icon, null, null, null);

File: app/src/main/java/me/zhanghai/android/douya/notification/ui/NotificationAdapter.java
Patch:
@@ -65,7 +65,7 @@ public void onBindViewHolder(final ViewHolder holder, int position) {
             @Override
             public void onClick(View view) {
                 if (mListener != null) {
-                    mListener.markNotificationAsRead(notification);
+                    mListener.onMarkNotificationAsRead(notification);
                 }
                 UriHandler.open(notification.targetUri, context);
             }
@@ -76,7 +76,7 @@ public void onClick(View view) {
     }
 
     public interface Listener {
-        void markNotificationAsRead(Notification notification);
+        void onMarkNotificationAsRead(Notification notification);
     }
 
     static class ViewHolder extends RecyclerView.ViewHolder {

File: app/src/main/java/me/zhanghai/android/douya/notification/ui/NotificationListFragment.java
Patch:
@@ -159,7 +159,7 @@ private void updateRefreshing() {
     }
 
     @Override
-    public void markNotificationAsRead(Notification notification) {
+    public void onMarkNotificationAsRead(Notification notification) {
         notification.read = true;
         EventBusUtils.postAsync(new NotificationUpdatedEvent(notification, this));
     }

File: app/src/main/java/me/zhanghai/android/douya/account/util/AccountUtils.java
Patch:
@@ -324,7 +324,7 @@ public static void selectAccount(Activity activity, Intent onSelectedIntent) {
         activity.startActivity(intent);
     }
 
-    public static boolean ensureAccountAvailability(Activity activity) {
+    public static boolean ensureActiveAccountAvailability(Activity activity) {
         boolean accountAvailable = true;
         if (!hasAccount()) {
             accountAvailable = false;

File: app/src/main/java/me/zhanghai/android/douya/main/ui/MainActivity.java
Patch:
@@ -69,7 +69,7 @@ protected void onCreate(Bundle savedInstanceState) {
 
         super.onCreate(savedInstanceState);
 
-        if (!AccountUtils.ensureAccountAvailability(this)) {
+        if (!AccountUtils.ensureActiveAccountAvailability(this)) {
             return;
         }
 

File: app/src/main/java/me/zhanghai/android/douya/navigation/ui/NavigationAccountListLayout.java
Patch:
@@ -42,7 +42,7 @@ public class NavigationAccountListLayout extends LinearLayout {
     LinearLayout mAccountList;
     @BindView(R.id.divider)
     View mDividerView;
-    @BindViews({R.id.add_account, R.id.manage_accounts})
+    @BindViews({R.id.add_account, R.id.remove_current_account, R.id.manage_accounts})
     TextView[] mMenuItems;
     @BindView(R.id.add_account)
     TextView mAddAccountItem;

File: app/src/main/java/me/zhanghai/android/douya/navigation/ui/NavigationFragment.java
Patch:
@@ -270,6 +270,7 @@ public void onRemoveCurrentAccount() {
     public void removeCurrentAccount() {
         mHeaderLayout.setShowingAccountList(false);
         AccountUtils.removeAccount(AccountUtils.getActiveAccount());
+        // FIXME: Select new active account.
     }
 
     private void openSettings() {

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileBroadcastsLayout.java
Patch:
@@ -93,6 +93,7 @@ public void onClick(View view) {
                 ViewUtils.inflateInto(R.layout.profile_broadcast_item, mBroadcastList);
             }
             View broadcastLayout = mBroadcastList.getChildAt(i);
+            broadcastLayout.setVisibility(VISIBLE);
             BroadcastLayoutHolder holder = (BroadcastLayoutHolder) broadcastLayout.getTag();
             if (holder == null) {
                 holder = new BroadcastLayoutHolder(broadcastLayout);
@@ -144,7 +145,7 @@ public void onClick(View view) {
         }
 
         for (int count = mBroadcastList.getChildCount(); i < count; ++i) {
-            ViewUtils.setVisibleOrGone(mBroadcastList.getChildAt(i), false);
+            mBroadcastList.getChildAt(i).setVisibility(GONE);
         }
     }
 

File: app/src/main/java/android/support/v7/widget/FriendlySwitchCompat.java
Patch:
@@ -274,7 +274,8 @@ public FriendlySwitchCompat(Context context, AttributeSet attrs, int defStyleAtt
      * @attr ref android.support.v7.appcompat.R.styleable#SwitchCompat_switchTextAppearance
      */
     public void setSwitchTextAppearance(Context context, int resid) {
-        TypedArray appearance = context.obtainStyledAttributes(resid, R.styleable.TextAppearance);
+        TintTypedArray appearance = TintTypedArray.obtainStyledAttributes(context, resid,
+                R.styleable.TextAppearance);
 
         ColorStateList colors;
         int ts;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/CommentAdapter.java
Patch:
@@ -49,9 +49,9 @@ public ViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {
 
     @Override
     public void onBindViewHolder(ViewHolder holder, int position) {
-        final Context context = RecyclerViewUtils.getContext(holder);
         final Comment comment = getItem(position);
-        ImageUtils.loadAvatar(holder.avatarImage, comment.author.avatar, context);
+        ImageUtils.loadAvatar(holder.avatarImage, comment.author.avatar);
+        final Context context = RecyclerViewUtils.getContext(holder);
         holder.avatarImage.setOnClickListener(new View.OnClickListener() {
             @Override
             public void onClick(View view) {

File: app/src/main/java/me/zhanghai/android/douya/navigation/ui/NavigationHeaderLayout.java
Patch:
@@ -105,7 +105,7 @@ public NavigationHeaderLayout(Context context, AttributeSet attrs, int defStyleA
     }
 
     private void init() {
-        inflate(getContext(), R.layout.navigation_header_layout, this);
+        ViewUtils.inflateInto(R.layout.navigation_header_layout, this);
     }
 
     @Override
@@ -214,7 +214,7 @@ private void bindAvatarImage(ImageView avatarImage, String avatarUrl) {
             }
         }
 
-        ImageUtils.loadNavigationAvatar(avatarImage, avatarUrl, getContext());
+        ImageUtils.loadNavigationAvatar(avatarImage, avatarUrl);
     }
 
     private void setAvatarImageFrom(ImageView toAvatarImage, ImageView fromAvatarImage) {

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileBroadcastsLayout.java
Patch:
@@ -62,7 +62,7 @@ public ProfileBroadcastsLayout(Context context, AttributeSet attrs, int defStyle
     }
 
     private void init() {
-        inflate(getContext(), R.layout.profile_broadcasts_layout, this);
+        ViewUtils.inflateInto(R.layout.profile_broadcasts_layout, this);
         ButterKnife.bind(this);
     }
 
@@ -116,7 +116,7 @@ public void onClick(View view) {
                 }
                 if (!TextUtils.isEmpty(imageUrl)) {
                     holder.image.setVisibility(VISIBLE);
-                    ImageUtils.loadImage(holder.image, imageUrl, context);
+                    ImageUtils.loadImage(holder.image, imageUrl);
                 } else {
                     holder.image.setVisibility(GONE);
                 }

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileDiariesLayout.java
Patch:
@@ -59,7 +59,7 @@ public ProfileDiariesLayout(Context context, AttributeSet attrs, int defStyleAtt
     }
 
     private void init() {
-        inflate(getContext(), R.layout.profile_diaries_layout, this);
+        ViewUtils.inflateInto(R.layout.profile_diaries_layout, this);
         ButterKnife.bind(this);
     }
 
@@ -99,7 +99,7 @@ public void onClick(View view) {
 
             if (!TextUtils.isEmpty(diary.cover)) {
                 holder.coverImage.setVisibility(VISIBLE);
-                ImageUtils.loadImage(holder.coverImage, diary.cover, context);
+                ImageUtils.loadImage(holder.coverImage, diary.cover);
             } else {
                 holder.coverImage.setVisibility(GONE);
             }

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileHeaderLayout.java
Patch:
@@ -287,9 +287,9 @@ public void setMaxHeight(int maxHeight) {
     }
 
     public void bindUser(User user) {
-        final Context context = getContext();
         final String largeAvatar = user.getLargeAvatarOrAvatar();
-        ImageUtils.loadProfileAvatarAndFadeIn(mAvatarImage, largeAvatar, context);
+        ImageUtils.loadProfileAvatarAndFadeIn(mAvatarImage, largeAvatar);
+        final Context context = getContext();
         mAvatarImage.setOnClickListener(new OnClickListener() {
             @Override
             public void onClick(View view) {
@@ -309,7 +309,7 @@ public void bindUserInfo(final UserInfo userInfo) {
         if (!ViewUtils.isVisible(mAvatarImage)) {
             // HACK: Don't load avatar again if already loaded by bindUser().
             final String largeAvatar = userInfo.getLargeAvatarOrAvatar();
-            ImageUtils.loadProfileAvatarAndFadeIn(mAvatarImage, largeAvatar, context);
+            ImageUtils.loadProfileAvatarAndFadeIn(mAvatarImage, largeAvatar);
             mAvatarImage.setOnClickListener(new OnClickListener() {
                 @Override
                 public void onClick(View view) {

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileIntroductionLayout.java
Patch:
@@ -47,7 +47,7 @@ public ProfileIntroductionLayout(Context context, AttributeSet attrs, int defSty
     }
 
     private void init() {
-        inflate(getContext(), R.layout.profile_introduction_layout, this);
+        ViewUtils.inflateInto(R.layout.profile_introduction_layout, this);
         ButterKnife.bind(this);
     }
 

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileItemAdapter.java
Patch:
@@ -46,7 +46,6 @@ public ViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {
 
     @Override
     public void onBindViewHolder(final ViewHolder holder, int position) {
-        final Context context = RecyclerViewUtils.getContext(holder);
         final Item item = getItem(position);
         float ratio = 1;
         switch (item.getType()) {
@@ -57,14 +56,15 @@ public void onBindViewHolder(final ViewHolder holder, int position) {
                 break;
         }
         holder.itemLayout.setRatio(ratio);
+        final Context context = RecyclerViewUtils.getContext(holder);
         holder.itemLayout.setOnClickListener(new View.OnClickListener() {
             @Override
             public void onClick(View view) {
                 // TODO
                 UriHandler.open(item.url, context);
             }
         });
-        ImageUtils.loadImage(holder.coverImage, item.cover.getLarge(), context);
+        ImageUtils.loadImage(holder.coverImage, item.cover.getLarge());
         holder.titleText.setText(item.title);
         // FIXME: This won't work properly if items are changed.
         ViewUtils.setVisibleOrGone(holder.dividerSpace, position != getItemCount() - 1);

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileItemsLayout.java
Patch:
@@ -63,7 +63,7 @@ public ProfileItemsLayout(Context context, AttributeSet attrs, int defStyleAttr)
 
     private void init() {
 
-        inflate(getContext(), R.layout.profile_items_layout, this);
+        ViewUtils.inflateInto(R.layout.profile_items_layout, this);
         ButterKnife.bind(this);
 
         mItemList.setHasFixedSize(true);

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileReviewsLayout.java
Patch:
@@ -59,7 +59,7 @@ public ProfileReviewsLayout(Context context, AttributeSet attrs, int defStyleAtt
     }
 
     private void init() {
-        inflate(getContext(), R.layout.profile_reviews_layout, this);
+        ViewUtils.inflateInto(R.layout.profile_reviews_layout, this);
         ButterKnife.bind(this);
     }
 
@@ -103,7 +103,7 @@ public void onClick(View view) {
             }
             if (!TextUtils.isEmpty(coverUrl)) {
                 holder.coverImage.setVisibility(VISIBLE);
-                ImageUtils.loadImage(holder.coverImage, coverUrl, context);
+                ImageUtils.loadImage(holder.coverImage, coverUrl);
             } else {
                 holder.coverImage.setVisibility(GONE);
             }

File: app/src/main/java/me/zhanghai/android/douya/ui/AppBarWrapperLayout.java
Patch:
@@ -9,7 +9,6 @@
 import android.animation.ObjectAnimator;
 import android.annotation.TargetApi;
 import android.content.Context;
-import android.content.res.TypedArray;
 import android.os.Build;
 import android.os.Parcel;
 import android.os.Parcelable;
@@ -75,7 +74,7 @@ private void init() {
     protected void onFinishInflate() {
         super.onFinishInflate();
 
-        inflate(getContext(), R.layout.appbar_shadow_compat, this);
+        ViewUtils.inflateInto(R.layout.appbar_shadow_compat, this);
 
         if (getChildCount() != 2) {
             throw new IllegalStateException("One and only one AppBar view should be wrapped " +

File: app/src/main/java/me/zhanghai/android/douya/ui/ForegroundHelper.java
Patch:
@@ -7,7 +7,6 @@
 
 import android.annotation.TargetApi;
 import android.content.Context;
-import android.content.res.TypedArray;
 import android.graphics.Canvas;
 import android.graphics.Rect;
 import android.graphics.drawable.Drawable;
@@ -16,6 +15,7 @@
 import android.support.v4.graphics.drawable.DrawableCompat;
 import android.support.v4.view.GravityCompat;
 import android.support.v4.view.ViewCompat;
+import android.support.v7.widget.TintTypedArray;
 import android.util.AttributeSet;
 import android.view.Gravity;
 import android.view.View;
@@ -60,7 +60,8 @@ public void init(Context context, AttributeSet attrs, int defStyleAttr, int defS
             return;
         }
 
-        TypedArray a = context.obtainStyledAttributes(attrs, STYLEABLE, defStyleAttr, defStyleRes);
+        TintTypedArray a = TintTypedArray.obtainStyledAttributes(context, attrs, STYLEABLE,
+                defStyleAttr, defStyleRes);
 
         mForegroundGravity = a.getInt(STYLEABLE_ANDROID_FOREGROUND_GRAVITY, mForegroundGravity);
 

File: app/src/main/java/me/zhanghai/android/douya/ui/MaxDimensionHelper.java
Patch:
@@ -6,7 +6,7 @@
 package me.zhanghai.android.douya.ui;
 
 import android.content.Context;
-import android.content.res.TypedArray;
+import android.support.v7.widget.TintTypedArray;
 import android.util.AttributeSet;
 import android.view.View;
 
@@ -29,7 +29,8 @@ public MaxDimensionHelper(Delegate delegate) {
     }
 
     public void onInit(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) {
-        TypedArray a = context.obtainStyledAttributes(attrs, STYLEABLE, defStyleAttr, defStyleRes);
+        TintTypedArray a = TintTypedArray.obtainStyledAttributes(context, attrs, STYLEABLE,
+                defStyleAttr, defStyleRes);
         mMaxWidth = a.getDimensionPixelSize(STYLEABLE_ANDROID_MAX_WIDTH, -1);
         mMaxHeight = a.getDimensionPixelSize(STYLEABLE_ANDROID_MAX_HEIGHT, -1);
         a.recycle();

File: app/src/main/java/me/zhanghai/android/douya/user/ui/BaseUserAdapter.java
Patch:
@@ -51,7 +51,7 @@ public void onClick(View view) {
                 context.startActivity(ProfileActivity.makeIntent(user, context));
             }
         });
-        ImageUtils.loadAvatar(holder.avatarImage, user.avatar, context);
+        ImageUtils.loadAvatar(holder.avatarImage, user.avatar);
         holder.nameText.setText(user.name);
         //noinspection deprecation
         holder.descriptionText.setText(user.uid);

File: app/src/main/java/me/zhanghai/android/douya/account/ui/SelectAccountActivity.java
Patch:
@@ -56,7 +56,7 @@ public void onCancel(int requestCode) {
         if (savedInstanceState == null) {
             SimpleDialogFragment.makeSingleChoice(R.string.auth_select_account, accountNames, -1,
                     this)
-                    .show(getSupportFragmentManager());
+                    .show(this);
         }
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastListResource.java
Patch:
@@ -166,6 +166,7 @@ public void load(boolean loadMore, int count) {
         mLoadingMore = loadMore;
         getListener().onLoadBroadcastListStarted(getRequestCode());
 
+        onStartLoad();
         Long untilId = null;
         if (loadMore && mBroadcastList != null) {
             int size = mBroadcastList.size();
@@ -183,6 +184,8 @@ public void load(boolean loadMore) {
         load(loadMore, DEFAULT_COUNT_PER_LOAD);
     }
 
+    protected void onStartLoad() {}
+
     protected void loadOnStart() {
         load(false);
     }

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiContract.java
Patch:
@@ -213,6 +213,9 @@ interface Response {
         interface Error {
             String CODE = "code";
             interface Codes {
+                interface Custom {
+                    int INVALID_ERROR_RESPONSE = -1;
+                }
                 interface Base {
                     int UNKNOWN_V2_ERROR = 999;
                     int NEED_PERMISSION = 1000;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BaseBroadcastListFragment.java
Patch:
@@ -205,7 +205,6 @@ private void updateRefreshing() {
         boolean loading = mBroadcastListResource.isLoading();
         boolean empty = mBroadcastListResource.isEmpty();
         boolean loadingMore = mBroadcastListResource.isLoadingMore();
-        mSwipeRefreshLayout.setEnabled(!loading);
         mSwipeRefreshLayout.setRefreshing(loading && (mSwipeRefreshLayout.isRefreshing() || !empty)
                 && !loadingMore);
         ViewUtils.setVisibleOrGone(mProgress, loading && empty);

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastFragment.java
Patch:
@@ -394,7 +394,6 @@ private void updateRefreshing() {
         boolean loadingBroadcast = mBroadcastAndCommentListResource.isLoadingBroadcast();
         boolean hasBroadcast = mBroadcastAndCommentListResource.hasBroadcast();
         boolean loadingCommentList = mBroadcastAndCommentListResource.isLoadingCommentList();
-        mSwipeRefreshLayout.setEnabled(!loadingBroadcast);
         mSwipeRefreshLayout.setRefreshing(loadingBroadcast
                 && (mSwipeRefreshLayout.isRefreshing() || hasBroadcast));
         ViewUtils.setVisibleOrGone(mProgress, loadingBroadcast && !hasBroadcast);

File: app/src/main/java/me/zhanghai/android/douya/notification/ui/NotificationListFragment.java
Patch:
@@ -270,7 +270,6 @@ private void onLoadNotificationListResponse(boolean successful, NotificationList
     }
 
     private void setRefreshing(boolean refreshing, boolean loadMore) {
-        mSwipeRefreshLayout.setEnabled(!refreshing);
         if (!refreshing) {
             mSwipeRefreshLayout.setRefreshing(false);
         }

File: app/src/main/java/me/zhanghai/android/douya/user/ui/UserListFragment.java
Patch:
@@ -144,7 +144,6 @@ private void updateRefreshing() {
         boolean loading = mUserListResource.isLoading();
         boolean empty = mUserListResource.isEmpty();
         boolean loadingMore = mUserListResource.isLoadingMore();
-        mSwipeRefreshLayout.setEnabled(!loading);
         mSwipeRefreshLayout.setRefreshing(loading && (mSwipeRefreshLayout.isRefreshing() || !empty)
                 && !loadingMore);
         ViewUtils.setVisibleOrGone(mProgress, loading && empty);

File: app/src/main/java/me/zhanghai/android/douya/ui/FullscreenNavigationView.java
Patch:
@@ -39,6 +39,7 @@ public FullscreenNavigationView(Context context, AttributeSet attrs, int defStyl
         init();
     }
 
+    @TargetApi(Build.VERSION_CODES.KITKAT_WATCH)
     private void init() {
 
         // Required to revert the value of fitsSystemWindows set in super constructor.

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/UserInfo.java
Patch:
@@ -72,7 +72,7 @@ public static VerificationType ofApiInt(int apiInt) {
     public int albumCount;
 
     @SerializedName("profile_banner")
-    public String profileCover;
+    public String profileBackdrop;
 
     @SerializedName("reg_time")
     public String registrationTime;
@@ -133,7 +133,7 @@ protected UserInfo(Parcel in) {
         diaryCount = in.readInt();
         doulistCount = in.readInt();
         albumCount = in.readInt();
-        profileCover = in.readString();
+        profileBackdrop = in.readString();
         registrationTime = in.readString();
         comment = in.readString();
         setiChannelCount = in.readInt();
@@ -166,7 +166,7 @@ public void writeToParcel(Parcel dest, int flags) {
         dest.writeInt(diaryCount);
         dest.writeInt(doulistCount);
         dest.writeInt(albumCount);
-        dest.writeString(profileCover);
+        dest.writeString(profileBackdrop);
         dest.writeString(registrationTime);
         dest.writeString(comment);
         dest.writeInt(setiChannelCount);

File: app/src/main/java/me/zhanghai/android/douya/ui/FullscreenNavigationView.java
Patch:
@@ -52,9 +52,7 @@ public WindowInsets onApplyWindowInsets(View view, WindowInsets insets) {
                     if (getHeaderCount() == 0) {
                         return FullscreenNavigationView.this.onApplyWindowInsets(insets);
                     }
-                    View firstHeaderView = getHeaderView(0);
-                    firstHeaderView.setFitsSystemWindows(true);
-                    return firstHeaderView.onApplyWindowInsets(insets);
+                    return getHeaderView(0).onApplyWindowInsets(insets);
                 }
             });
         }

File: app/src/main/java/me/zhanghai/android/douya/account/content/AccountUserInfoResource.java
Patch:
@@ -98,8 +98,8 @@ public void onCreate(Bundle savedInstanceState) {
     }
 
     @Override
-    protected void onSetUserInfo(UserInfo userInfo) {
-        super.onSetUserInfo(userInfo);
+    protected void onUserInfoLoaded(UserInfo userInfo) {
+        super.onUserInfoLoaded(userInfo);
 
         AccountUtils.setUserInfo(mAccount, userInfo, getActivity());
     }

File: app/src/main/java/me/zhanghai/android/douya/ui/FriendlyCardView.java
Patch:
@@ -45,5 +45,8 @@ private void init(Context context, AttributeSet attrs, int defStyleAttr) {
 
         setUseCompatPadding(true);
         setPreventCornerOverlap(false);
+
+        // User should never click through a card.
+        setClickable(true);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileIntroductionLayout.java
Patch:
@@ -55,19 +55,19 @@ public void setListener(Listener listener) {
 
     public void bind(String introduction) {
         introduction = introduction.trim();
-        final String trimmedIntroduction = introduction;
         if (!TextUtils.isEmpty(introduction)) {
+            final String finalIntroduction = introduction;
             mTitleText.setOnClickListener(new OnClickListener() {
                 @Override
                 public void onClick(View view) {
-                    onCopyText(trimmedIntroduction);
+                    onCopyText(finalIntroduction);
                 }
             });
             mContentText.setText(introduction);
             mContentText.setOnLongClickListener(new OnLongClickListener() {
                 @Override
                 public boolean onLongClick(View view) {
-                    onCopyText(trimmedIntroduction);
+                    onCopyText(finalIntroduction);
                     return true;
                 }
             });

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastUserListResource.java
Patch:
@@ -16,7 +16,8 @@ public abstract class BroadcastUserListResource extends RawUserListResource {
     public final String EXTRA_BROADCAST_ID = KEY_PREFIX + "broadcast_id";
 
     protected void setArguments(long broadcastId) {
-        FragmentUtils.ensureArguments(this).putLong(EXTRA_BROADCAST_ID, broadcastId);
+        FragmentUtils.ensureArguments(this)
+                .putLong(EXTRA_BROADCAST_ID, broadcastId);
     }
 
     protected long getBroadcastId() {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastActivityDialogFragment.java
Patch:
@@ -59,7 +59,8 @@ public BroadcastActivityDialogFragment() {}
     public static BroadcastActivityDialogFragment newInstance(Broadcast broadcast) {
         //noinspection deprecation
         BroadcastActivityDialogFragment fragment = new BroadcastActivityDialogFragment();
-        FragmentUtils.ensureArguments(fragment).putParcelable(EXTRA_BROADCAST, broadcast);
+        FragmentUtils.ensureArguments(fragment)
+                .putParcelable(EXTRA_BROADCAST, broadcast);
         return fragment;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastUserListFragment.java
Patch:
@@ -29,7 +29,8 @@ public abstract class BroadcastUserListFragment extends UserListFragment {
     private Broadcast mBroadcast;
 
     protected void setArguments(Broadcast broadcast) {
-        FragmentUtils.ensureArguments(this).putParcelable(EXTRA_BROADCAST, broadcast);
+        FragmentUtils.ensureArguments(this)
+                .putParcelable(EXTRA_BROADCAST, broadcast);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/ConfirmDeleteCommentDialogFragment.java
Patch:
@@ -34,8 +34,8 @@ public ConfirmDeleteCommentDialogFragment() {}
     public static ConfirmDeleteCommentDialogFragment newInstance(Comment comment) {
         //noinspection deprecation
         ConfirmDeleteCommentDialogFragment fragment = new ConfirmDeleteCommentDialogFragment();
-        Bundle arguments = FragmentUtils.ensureArguments(fragment);
-        arguments.putParcelable(EXTRA_COMMENT, comment);
+        FragmentUtils.ensureArguments(fragment)
+                .putParcelable(EXTRA_COMMENT, comment);
         return fragment;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/diary/content/UserDiaryListResource.java
Patch:
@@ -92,7 +92,8 @@ private static UserDiaryListResource attachTo(String userIdOrUid, FragmentActivi
     public UserDiaryListResource() {}
 
     private void setArguments(String userIdOrUid) {
-        FragmentUtils.ensureArguments(this).putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
+        FragmentUtils.ensureArguments(this)
+                .putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/followship/content/FollowshipUserListResource.java
Patch:
@@ -16,7 +16,8 @@ public abstract class FollowshipUserListResource extends UserListResource {
     public final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
 
     protected void setArguments(String userIdOrUid) {
-        FragmentUtils.ensureArguments(this).putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
+        FragmentUtils.ensureArguments(this)
+                .putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
     }
 
     protected String getUserIdOrUid() {

File: app/src/main/java/me/zhanghai/android/douya/followship/ui/FollowshipListActivityFragment.java
Patch:
@@ -33,7 +33,8 @@ public abstract class FollowshipListActivityFragment extends Fragment {
     private String mUserIdOrUid;
 
     protected void setArguments(String userIdOrUid) {
-        FragmentUtils.ensureArguments(this).putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
+        FragmentUtils.ensureArguments(this)
+                .putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/followship/ui/FollowshipListFragment.java
Patch:
@@ -22,7 +22,8 @@ public abstract class FollowshipListFragment extends UserListFragment {
     private String mUserIdOrUid;
 
     protected void setArguments(String userIdOrUid) {
-        FragmentUtils.ensureArguments(this).putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
+        FragmentUtils.ensureArguments(this)
+                .putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/profile/content/UserItemListResource.java
Patch:
@@ -84,7 +84,8 @@ private static UserItemListResource attachTo(String userIdOrUid, FragmentActivit
     public UserItemListResource() {}
 
     protected void setArguments(String userIdOrUid) {
-        FragmentUtils.ensureArguments(this).putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
+        FragmentUtils.ensureArguments(this)
+                .putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/review/content/ItemReviewListResource.java
Patch:
@@ -83,7 +83,8 @@ private static ItemReviewListResource attachTo(long itemId, FragmentActivity act
     public ItemReviewListResource() {}
 
     private void setArguments(long itemId) {
-        FragmentUtils.ensureArguments(this).putLong(EXTRA_ITEM_ID, itemId);
+        FragmentUtils.ensureArguments(this)
+                .putLong(EXTRA_ITEM_ID, itemId);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/review/content/UserReviewListResource.java
Patch:
@@ -85,7 +85,8 @@ private static UserReviewListResource attachTo(String userIdOrUid, FragmentActiv
     public UserReviewListResource() {}
 
     private void setArguments(String userIdOrUid) {
-        FragmentUtils.ensureArguments(this).putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
+        FragmentUtils.ensureArguments(this)
+                .putString(EXTRA_USER_ID_OR_UID, userIdOrUid);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/util/SpanUtils.java
Patch:
@@ -71,10 +71,10 @@ public final boolean acceptMatch(CharSequence s, int start, int end) {
     private static final String[] EMAIL_SCHEMES = { "mailto:" };
 
     /**
-     * Modified from {@link Patterns#PHONE}, with required tel scheme added.
+     * Modified from {@link Patterns#PHONE}, with required tel/sms/smsto scheme added.
      */
     public static final Pattern PHONE_URI_PATTERN = Pattern.compile(
-            "tel:"
+            "(tel|sms|smsto):"
                     + "(\\+[0-9]+[\\- \\.]*)?"
                     + "(\\([0-9]+\\)[\\- \\.]*)?"
                     + "([0-9][0-9\\- \\.]+[0-9])");

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLayout.java
Patch:
@@ -10,6 +10,7 @@
 import android.os.Build;
 import android.support.v4.content.ContextCompat;
 import android.support.v7.widget.LinearLayoutManager;
+import android.support.v7.widget.RecyclerView;
 import android.text.TextUtils;
 import android.util.AttributeSet;
 import android.view.View;
@@ -27,6 +28,7 @@
 import me.zhanghai.android.douya.R;
 import me.zhanghai.android.douya.broadcast.content.LikeBroadcastManager;
 import me.zhanghai.android.douya.broadcast.content.RebroadcastBroadcastManager;
+import me.zhanghai.android.douya.link.UriHandler;
 import me.zhanghai.android.douya.network.api.info.apiv2.Attachment;
 import me.zhanghai.android.douya.network.api.info.apiv2.Broadcast;
 import me.zhanghai.android.douya.network.api.info.apiv2.Image;
@@ -37,8 +39,6 @@
 import me.zhanghai.android.douya.ui.HorizontalImageAdapter;
 import me.zhanghai.android.douya.ui.ImageLayout;
 import me.zhanghai.android.douya.ui.OnHorizontalScrollListener;
-import me.zhanghai.android.douya.ui.RatioHeightRecyclerView;
-import me.zhanghai.android.douya.link.UriHandler;
 import me.zhanghai.android.douya.ui.TimeActionTextView;
 import me.zhanghai.android.douya.util.CheatSheetUtils;
 import me.zhanghai.android.douya.util.DrawableUtils;
@@ -77,7 +77,7 @@ public class BroadcastLayout extends LinearLayout {
     @BindView(R.id.image_list_description)
     TextView mImageListDescriptionText;
     @BindView(R.id.image_list)
-    RatioHeightRecyclerView mImageList;
+    RecyclerView mImageList;
     @BindView(R.id.text_space)
     Space mTextSpace;
     @BindView(R.id.text)

File: app/src/main/java/me/zhanghai/android/douya/ui/RatioHeightRecyclerView.java
Patch:
@@ -13,6 +13,9 @@
 
 import me.zhanghai.android.douya.R;
 
+/**
+ * @deprecated Use {@link NestedRatioHeightRecyclerView} instead for most of the time.
+ */
 public class RatioHeightRecyclerView extends RecyclerView {
 
     private float mRatio;

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileContentLayout.java
Patch:
@@ -66,7 +66,8 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
 
         if (mUseWideLayout) {
             int width = MeasureSpec.getSize(widthMeasureSpec);
-            int paddingLeft = width * 2 / 5 - mScreenEdgeHorizontalMargin;
+            int paddingLeft = ProfileUtils.getAppBarWidth(width, getContext())
+                    - mScreenEdgeHorizontalMargin;
             setPadding(paddingLeft, getPaddingTop(), getPaddingRight(), getPaddingBottom());
             int height = MeasureSpec.getSize(heightMeasureSpec);
             View contentView = getContentView();

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileFragment.java
Patch:
@@ -156,8 +156,7 @@ public void onClick(View view) {
         mHeaderLayout.setListener(this);
 
         if (ViewUtils.hasSw600Dp(activity)) {
-            int columnCount = ViewUtils.hasW960Dp(activity) ? 3 : 2;
-            mContentList.setLayoutManager(new StaggeredGridLayoutManager(columnCount,
+            mContentList.setLayoutManager(new StaggeredGridLayoutManager(2,
                     StaggeredGridLayoutManager.VERTICAL));
         } else {
             mContentList.setLayoutManager(new LinearLayoutManager(activity));

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileHeaderLayout.java
Patch:
@@ -168,9 +168,10 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
         appBarLayoutLayoutParams.topMargin = dismissViewHeight;
         // So that the layout remains stable.
         appBarLayoutLayoutParams.height = getAppBarMaxHeight();
+        int appBarWidth = ProfileUtils.getAppBarWidth(width, getContext());
         if (mUseWideLayout) {
             mAppBarLayout.setPadding(mAppBarLayout.getPaddingLeft(), mAppBarLayout.getPaddingTop(),
-                    width * 3 / 5, mAppBarLayout.getPaddingBottom());
+                    width - appBarWidth, mAppBarLayout.getPaddingBottom());
         }
 
         int largeAvatarSizeHalf = mLargeAvatarSize / 2;
@@ -179,8 +180,7 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
         float avatarHorizontalFraction = avatarMarginTop < smallAvatarMarginTop ?
                 MathUtils.unlerp(smallAvatarMarginTop, -largeAvatarSizeHalf, avatarMarginTop) : 0;
         avatarMarginTop = Math.max(smallAvatarMarginTop, avatarMarginTop) + mInsetTop;
-        int avatarHorizontalCenter = (mUseWideLayout ? width * 2 / 5 : width) / 2;
-        int avatarMarginLeft = MathUtils.lerp(avatarHorizontalCenter - largeAvatarSizeHalf,
+        int avatarMarginLeft = MathUtils.lerp(appBarWidth / 2 - largeAvatarSizeHalf,
                 mScreenEdgeHorizontalMargin, avatarHorizontalFraction);
         MarginLayoutParams avatarContainerLayoutParams =
                 (MarginLayoutParams) mAvatarContainerLayout.getLayoutParams();

File: app/src/main/java/me/zhanghai/android/douya/settings/ui/ConfirmEnableScalpelDialogFragment.java
Patch:
@@ -44,7 +44,7 @@ public void onClick(DialogInterface dialog, int which) {
     }
 
     private Listener getListener() {
-        return (Listener) getActivity();
+        return (Listener) getParentFragment();
     }
 
     public static void show(Fragment fragment) {

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileItemsLayout.java
Patch:
@@ -73,8 +73,7 @@ private void init() {
         mItemList.setAdapter(mItemAdapter);
     }
 
-    protected void bind(final UserInfo userInfo, UserItems primaryItems, UserItems secondaryItems,
-                        UserItems tertiaryItems) {
+    protected void bind(UserItems primaryItems, UserItems secondaryItems, UserItems tertiaryItems) {
 
         final Context context = getContext();
         CollectedItem.State state = primaryItems.getState();
@@ -163,7 +162,7 @@ public void bind(UserInfo userInfo, List<UserItems> userItemList) {
             //noinspection deprecation
             primaryItems.state = CollectedItem.State.DONE.getApiString();
         }
-        bind(userInfo, primaryItems, secondaryItems, tertiaryItems);
+        bind(primaryItems, secondaryItems, tertiaryItems);
     }
 
     protected String getUserIdOrUid() {

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ConfirmUnfollowUserDialogFragment.java
Patch:
@@ -44,7 +44,9 @@ public void onClick(DialogInterface dialog, int which) {
     }
 
     private Listener getListener() {
-        return (Listener) getParentFragment();
+        // FIXME
+//        return (Listener) getParentFragment();
+        return (Listener) getActivity();
     }
 
     // FIXME: Show on ProfileFragment instead.

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileActivity.java
Patch:
@@ -133,6 +133,7 @@ public void onClick(View view) {
         } else if (mProfileResource.hasUser()) {
             mHeaderLayout.bindUser(mProfileResource.getUser());
         }
+        mHeaderLayout.setListener(this);
 
         if (mProfileResource.isLoaded()) {
             mProfileResource.notifyChangedIfLoaded();

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastAdapter.java
Patch:
@@ -82,8 +82,7 @@ public void onCommentClicked() {
     private static View getSharedView(ViewHolder holder) {
         Context context = holder.itemView.getContext();
         // HACK: Transition is so hard to work with, but this gives a better effect.
-        View view = ViewUtils.hasSw600dp(context) ? holder.cardView : holder.broadcastLayout;
-        return view;
+        return ViewUtils.hasSw600dp(context) ? holder.cardView : holder.broadcastLayout;
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLayout.java
Patch:
@@ -83,11 +83,11 @@ public class BroadcastLayout extends LinearLayout {
     @BindView(R.id.text)
     TextView mTextText;
     @BindView(R.id.like)
-    public CardIconButton mLikeButton;
+    CardIconButton mLikeButton;
     @BindView(R.id.comment)
     public CardIconButton mCommentButton;
     @BindView(R.id.rebroadcast)
-    public CardIconButton mRebroadcastButton;
+    CardIconButton mRebroadcastButton;
 
     private HorizontalImageAdapter mImageListAdapter;
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/Image.java
Patch:
@@ -29,12 +29,12 @@ public class Image implements Parcelable {
 
     public String getNormal() {
         //noinspection deprecation
-        return TextUtils.isEmpty(normal) ? large : normal;
+        return !TextUtils.isEmpty(normal) ? normal : large;
     }
 
     public String getLarge() {
         //noinspection deprecation
-        return TextUtils.isEmpty(large) ? normal : large;
+        return !TextUtils.isEmpty(large) ? large : normal;
     }
 
     public static final Parcelable.Creator<Image> CREATOR = new Parcelable.Creator<Image>() {

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileItemAdapter.java
Patch:
@@ -77,7 +77,7 @@ public void onClick(View view) {
                 UriHandler.open(item.url, context);
             }
         });
-        ImageUtils.loadImage(holder.coverImage, item.cover, context);
+        ImageUtils.loadImage(holder.coverImage, item.cover.getLarge(), context);
         holder.titleText.setText(item.title);
         // FIXME: This won't work properly if items are changed.
         ViewUtils.setVisibleOrGone(holder.dividerSpace, position != getItemCount() - 1);

File: app/src/main/java/me/zhanghai/android/douya/util/ImageUtils.java
Patch:
@@ -72,7 +72,7 @@ public static void loadImage(ImageView view,
                                  me.zhanghai.android.douya.network.api.info.frodo.Image image,
                                  Context context) {
         Glide.with(context)
-                .load(image.large)
+                .load(image.getLarge())
                 .placeholder(android.R.color.transparent)
                 .into(view);
     }

File: app/src/main/java/me/zhanghai/android/douya/util/SpanUtils.java
Patch:
@@ -34,7 +34,7 @@ public class SpanUtils {
                     + "(?:\\:\\d{1,5})?)"
                     + "(\\/(?:(?:[" + Patterns.GOOD_IRI_CHAR + "\\;\\/\\?\\:\\@\\&\\=\\#\\~"
                     + "\\-\\.\\+\\!\\*\\'\\(\\)\\,\\_])|(?:\\%[a-fA-F0-9]{2}))*)?"
-                    + "(?:/|\\b|$)");
+                    + "(?=\\W|$)");
 
     private static final String[] WEB_URL_SCHEMES = { "http://", "https://", "ftp://", "rtsp://" };
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiContract.java
Patch:
@@ -76,7 +76,7 @@ interface DiaryList {
             }
 
             interface UserItemList {
-                String URL_FORMAT = "user/%s/itemlist";
+                String URL_FORMAT = API_HOST + "user/%s/itemlist";
             }
         }
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/UserItemList.java
Patch:
@@ -15,7 +15,7 @@
 public class UserItemList implements Parcelable {
 
     @SerializedName("itemlist")
-    public ArrayList<UserItemListItem> list = new ArrayList<>();
+    public ArrayList<UserItem> list = new ArrayList<>();
 
 
     public static final Parcelable.Creator<UserItemList> CREATOR =
@@ -33,7 +33,7 @@ public UserItemList[] newArray(int size) {
     public UserItemList() {}
 
     protected UserItemList(Parcel in) {
-        list = in.createTypedArrayList(UserItemListItem.CREATOR);
+        list = in.createTypedArrayList(UserItem.CREATOR);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileActivity.java
Patch:
@@ -27,6 +27,7 @@
 import me.zhanghai.android.douya.network.api.info.apiv2.User;
 import me.zhanghai.android.douya.network.api.info.apiv2.UserInfo;
 import me.zhanghai.android.douya.network.api.info.frodo.Diary;
+import me.zhanghai.android.douya.network.api.info.frodo.UserItem;
 import me.zhanghai.android.douya.profile.content.ProfileResource;
 import me.zhanghai.android.douya.ui.ContentStateLayout;
 import me.zhanghai.android.douya.util.LogUtils;
@@ -198,7 +199,8 @@ public void onUserInfoChanged(int requestCode, UserInfo newUserInfo) {
 
     @Override
     public void onChanged(int requestCode, UserInfo newUserInfo, List<Broadcast> newBroadcastList,
-                          List<User> newFollowingList, List<Diary> newDiaryList) {
+                          List<User> newFollowingList, List<Diary> newDiaryList,
+                          List<UserItem> newUserItemList) {
         mIntroductionLayout.bind(newUserInfo);
         mBroadcastsLayout.bind(newUserInfo, newBroadcastList);
         mFollowshipLayout.bind(newUserInfo, newFollowingList);

File: app/src/main/java/me/zhanghai/android/douya/util/SpanUtils.java
Patch:
@@ -23,7 +23,7 @@
 public class SpanUtils {
 
     /**
-     * Modified from {@link Patterns#WEB_URL}, with ftp added.
+     * Modified from {@link Patterns#WEB_URL}, with ftp scheme added and an optional trailing slash.
      */
     @SuppressWarnings("deprecation")
     public static final Pattern WEB_URL_PATTERN = Pattern.compile(
@@ -34,7 +34,7 @@ public class SpanUtils {
                     + "(?:\\:\\d{1,5})?)"
                     + "(\\/(?:(?:[" + Patterns.GOOD_IRI_CHAR + "\\;\\/\\?\\:\\@\\&\\=\\#\\~"
                     + "\\-\\.\\+\\!\\*\\'\\(\\)\\,\\_])|(?:\\%[a-fA-F0-9]{2}))*)?"
-                    + "(?:\\b|$)");
+                    + "(?:/|\\b|$)");
 
     private static final String[] WEB_URL_SCHEMES = { "http://", "https://", "ftp://", "rtsp://" };
 

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/frodo/DiaryList.java
Patch:
@@ -14,7 +14,7 @@
 public class DiaryList extends BaseList {
 
     @SerializedName("notes")
-    public ArrayList<Diary> diaries;
+    public ArrayList<Diary> diaries = new ArrayList<>();
 
 
     public static final Creator<DiaryList> CREATOR = new Creator<DiaryList>() {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/CommentAdapter.java
Patch:
@@ -55,7 +55,7 @@ public void onBindViewHolder(ViewHolder holder, int position) {
         holder.avatarImage.setOnClickListener(new View.OnClickListener() {
             @Override
             public void onClick(View view) {
-                ProfileActivity.makeIntent(comment.author, context);
+                context.startActivity(ProfileActivity.makeIntent(comment.author, context));
             }
         });
         holder.nameText.setText(comment.author.name);

File: app/src/main/java/me/zhanghai/android/douya/user/ui/BaseUserAdapter.java
Patch:
@@ -57,7 +57,7 @@ public void onBindViewHolder(final ViewHolder holder, int position) {
         holder.itemView.setOnClickListener(new View.OnClickListener() {
             @Override
             public void onClick(View view) {
-                ProfileActivity.makeIntent(user, context);
+                context.startActivity(ProfileActivity.makeIntent(user, context));
             }
         });
         ImageUtils.loadAvatar(holder.avatarImage, user.avatar, context);

File: app/src/main/java/me/zhanghai/android/douya/profile/content/UserInfoResource.java
Patch:
@@ -27,9 +27,9 @@ public class UserInfoResource extends ResourceFragment
 
     private static final String KEY_PREFIX = UserInfoResource.class.getName() + '.';
 
-    public static final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
-    public static final String EXTRA_USER = KEY_PREFIX + "user";
-    public static final String EXTRA_USER_INFO = KEY_PREFIX + "user_info";
+    private static final String EXTRA_USER_ID_OR_UID = KEY_PREFIX + "user_id_or_uid";
+    private static final String EXTRA_USER = KEY_PREFIX + "user";
+    private static final String EXTRA_USER_INFO = KEY_PREFIX + "user_info";
 
     private String mUserIdOrUid;
     private User mUser;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastListActivityFragment.java
Patch:
@@ -65,7 +65,7 @@ public void onCreate(@Nullable Bundle savedInstanceState) {
         Bundle arguments = getArguments();
         mUser = arguments.getParcelable(EXTRA_USER);
         if (mUser != null) {
-            mUserIdOrUid = mUser.uid;
+            mUserIdOrUid = mUser.getIdOrUid();
         } else {
             mUserIdOrUid = arguments.getString(EXTRA_USER_ID_OR_UID);
         }

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/apiv2/BaseList.java
Patch:
@@ -8,7 +8,7 @@
 import android.os.Parcel;
 import android.os.Parcelable;
 
-public class BaseList implements Parcelable {
+public abstract class BaseList implements Parcelable {
 
     public int count;
 

File: app/src/main/java/me/zhanghai/android/douya/profile/content/ProfileResource.java
Patch:
@@ -158,11 +158,11 @@ private void ensureUserInfoAndUserAndIdOrUidFromArguments() {
             mUserInfo = arguments.getParcelable(EXTRA_USER_INFO);
             if (mUserInfo != null) {
                 mUser = mUserInfo;
-                mUserIdOrUid = mUserInfo.uid;
+                mUserIdOrUid = mUserInfo.getIdOrUid();
             } else {
                 mUser = arguments.getParcelable(EXTRA_USER);
                 if (mUser != null) {
-                    mUserIdOrUid = mUser.uid;
+                    mUserIdOrUid = mUser.getIdOrUid();
                 } else {
                     mUserIdOrUid = arguments.getString(EXTRA_USER_ID_OR_UID);
                 }
@@ -185,7 +185,7 @@ public void onLoadUserInfoError(int requestCode, VolleyError error) {
     public void onUserInfoChanged(int requestCode, UserInfo newUserInfo) {
         mUserInfo = newUserInfo;
         mUser = newUserInfo;
-        mUserIdOrUid = newUserInfo.uid;
+        mUserIdOrUid = newUserInfo.getIdOrUid();
         getListener().onUserInfoChanged(getRequestCode(), newUserInfo);
         notifyChangedIfLoaded();
     }

File: app/src/main/java/me/zhanghai/android/douya/profile/content/UserInfoResource.java
Patch:
@@ -156,11 +156,11 @@ private void ensureUserInfoAndUserAndIdOrUidFromArguments() {
             mUserInfo = arguments.getParcelable(EXTRA_USER_INFO);
             if (mUserInfo != null) {
                 mUser = mUserInfo;
-                mUserIdOrUid = mUserInfo.uid;
+                mUserIdOrUid = mUserInfo.getIdOrUid();
             } else {
                 mUser = arguments.getParcelable(EXTRA_USER);
                 if (mUser != null) {
-                    mUserIdOrUid = mUser.uid;
+                    mUserIdOrUid = mUser.getIdOrUid();
                 } else {
                     mUserIdOrUid = arguments.getString(EXTRA_USER_ID_OR_UID);
                 }
@@ -240,7 +240,7 @@ public void onEventMainThread(UserInfoUpdatedEvent event) {
     private void setUserInfo(UserInfo userInfo) {
         mUserInfo = userInfo;
         mUser = mUserInfo;
-        mUserIdOrUid = mUserInfo.uid;
+        mUserIdOrUid = mUserInfo.getIdOrUid();
         getListener().onUserInfoChanged(getRequestCode(), mUserInfo);
     }
 

File: app/src/main/java/me/zhanghai/android/douya/user/ui/BaseUserAdapter.java
Patch:
@@ -62,6 +62,7 @@ public void onClick(View view) {
         });
         ImageUtils.loadAvatar(holder.avatarImage, user.avatar, context);
         holder.nameText.setText(user.name);
+        //noinspection deprecation
         holder.descriptionText.setText(user.uid);
     }
 

File: app/src/main/java/me/zhanghai/android/douya/util/DoubanUtils.java
Patch:
@@ -11,11 +11,12 @@ public class DoubanUtils {
 
     private DoubanUtils() {}
 
-    public static String getAtUserString(String idOrUid) {
-        return '@' + idOrUid + ' ';
+    public static String getAtUserString(String userIdOrUid) {
+        return '@' + userIdOrUid + ' ';
     }
 
     public static String getAtUserString(User user) {
+        //noinspection deprecation
         return getAtUserString(user.uid);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileActivity.java
Patch:
@@ -118,7 +118,7 @@ public void onClick(View view) {
         }
 
         if (mProfileResource.isLoaded()) {
-            mProfileResource.notifyChangedIfAllLoaded();
+            mProfileResource.notifyChangedIfLoaded();
         } else {
             mContentStateLayout.setLoading();
         }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastListActivityFragment.java
Patch:
@@ -118,7 +118,7 @@ public boolean onOptionsItemSelected(MenuItem item) {
     private String getTitle() {
         // TODO: Load user.
         if (mUser != null) {
-            return mUser.name;
+            return getString(R.string.broadcast_list_title_user_format, mUser.name);
         } else if (!TextUtils.isEmpty(mTopic)) {
             return getString(R.string.broadcast_list_title_topic_format, mTopic);
         } else {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastFragment.java
Patch:
@@ -38,6 +38,7 @@
 import butterknife.ButterKnife;
 import me.zhanghai.android.customtabshelper.CustomTabsHelperFragment;
 import me.zhanghai.android.douya.R;
+import me.zhanghai.android.douya.broadcast.content.BroadcastAndCommentListResource;
 import me.zhanghai.android.douya.broadcast.content.BroadcastCommentCountFixer;
 import me.zhanghai.android.douya.broadcast.content.DeleteBroadcastCommentManager;
 import me.zhanghai.android.douya.broadcast.content.DeleteBroadcastManager;

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileHeaderLayout.java
Patch:
@@ -269,7 +269,7 @@ public void bindUserInfo(UserInfo userInfo) {
         mJoinedAtLocationText.setJoinedAtAndLocation(userInfo.createdAt, userInfo.locationName);
         int followDrawableId;
         int followStringId;
-        if (userInfo.isFollowing) {
+        if (userInfo.isFollowed) {
             if (userInfo.isFollower) {
                 followDrawableId = R.drawable.mutual_icon_white_24dp;
                 followStringId = R.string.profile_following_mutual;

File: app/src/main/java/me/zhanghai/android/douya/link/FrodoBridge.java
Patch:
@@ -28,13 +28,13 @@ private static Intent makeSendBroadcastIntent(String hashTagName) {
                 .putExtra(SEND_STATUS_EXTRA_HASHTAG_NAME, hashTagName);
     }
 
-    public static Intent makeIntent(String className) {
+    private static Intent makeIntent(String className) {
         return new Intent()
                 .setComponent(new ComponentName(FRODO_PACKAGE_NAME,
                         FRODO_PACKAGE_NAME + className));
     }
 
-    public static boolean startActivity(Intent intent, Context context) {
+    private static boolean startActivity(Intent intent, Context context) {
         try {
             context.startActivity(intent);
             return true;

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLayout.java
Patch:
@@ -201,6 +201,8 @@ public void onClick(View view) {
                             UriHandler.open(attachmentUrl, context);
                         }
                     });
+                } else {
+                    mAttachmentLayout.setOnClickListener(null);
                 }
             } else {
                 mAttachmentLayout.setVisibility(View.GONE);

File: app/src/main/java/me/zhanghai/android/douya/ui/LoadMoreAdapter.java
Patch:
@@ -62,6 +62,7 @@ public LoadMoreViewAdapter(int loadMoreLayoutResId) {
 
         // We need to postpone this until the super call of our parent is completed.
         public void setParentAdapter(final LoadMoreAdapter parentAdapter) {
+            setShowingItem(parentAdapter.getItemCount() > 0);
             parentAdapter.registerAdapterDataObserver(new RecyclerView.AdapterDataObserver() {
                 @Override
                 public void onItemRangeChanged(int positionStart, int itemCount) {

File: app/src/main/java/me/zhanghai/android/douya/profile/content/UserInfoResource.java
Patch:
@@ -162,7 +162,7 @@ private void ensureUserInfoAndUserAndIdOrUidFromArguments() {
                 if (mUser != null) {
                     mUserIdOrUid = mUser.uid;
                 } else {
-                    mUserIdOrUid = arguments.getParcelable(EXTRA_USER_ID_OR_UID);
+                    mUserIdOrUid = arguments.getString(EXTRA_USER_ID_OR_UID);
                 }
             }
         }

File: app/src/main/java/me/zhanghai/android/douya/network/api/info/User.java
Patch:
@@ -44,6 +44,7 @@ public class User implements Parcelable {
     public String uid;
 
     public String getLargeAvatarOrAvatar() {
+        //noinspection deprecation
         return !TextUtils.equals(largeAvatar, LARGE_AVATAR_DEFAULT)? largeAvatar : avatar;
     }
 
@@ -72,6 +73,7 @@ protected User(Parcel in) {
         avatar = in.readString();
         id = in.readLong();
         isSuicided = in.readByte() != 0;
+        //noinspection deprecation
         largeAvatar = in.readString();
         name = in.readString();
         type = in.readString();
@@ -89,6 +91,7 @@ public void writeToParcel(Parcel dest, int flags) {
         dest.writeString(avatar);
         dest.writeLong(id);
         dest.writeByte(isSuicided ? (byte) 1 : (byte) 0);
+        //noinspection deprecation
         dest.writeString(largeAvatar);
         dest.writeString(name);
         dest.writeString(type);

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/CommentListResource.java
Patch:
@@ -97,8 +97,8 @@ public void onVolleyResponse(int requestCode, final boolean successful,
         postOnResumed(new Runnable() {
             @Override
             public void run() {
-                onLoadFinished(successful, result.comments, error, requestState.loadMore,
-                        requestState.count);
+                onLoadFinished(successful, result != null ? result.comments : null, error,
+                        requestState.loadMore, requestState.count);
             }
         });
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/ConfirmDeleteBroadcastDialogFragment.java
Patch:
@@ -43,7 +43,7 @@ public void onClick(DialogInterface dialog, int which) {
     }
 
     private Listener getListener() {
-        return (Listener) getActivity();
+        return (Listener) getParentFragment();
     }
 
     public static void show(Fragment fragment) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/ConfirmDeleteCommentDialogFragment.java
Patch:
@@ -19,7 +19,8 @@
 
 public class ConfirmDeleteCommentDialogFragment extends AppCompatDialogFragment {
 
-    private static final String KEY_PREFIX = ConfirmDeleteCommentDialogFragment.class.getName() + '.';
+    private static final String KEY_PREFIX = ConfirmDeleteCommentDialogFragment.class.getName()
+            + '.';
 
     public static final String EXTRA_COMMENT = KEY_PREFIX + "comment";
 
@@ -61,7 +62,7 @@ public void onClick(DialogInterface dialog, int which) {
     }
 
     private Listener getListener() {
-        return (Listener) getActivity();
+        return (Listener) getParentFragment();
     }
 
     public static void show(Comment comment, Fragment fragment) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BaseBroadcastListFragment.java
Patch:
@@ -239,7 +239,8 @@ public void onOpenBroadcast(Broadcast broadcast, View sharedView) {
 
     private void openBroadcast(Broadcast broadcast, View sharedView, boolean showSendComment) {
         Activity activity = getActivity();
-        Intent intent = BroadcastActivity.makeIntent(broadcast, showSendComment, getActivity());
+        Intent intent = BroadcastActivity.makeIntent(broadcast, showSendComment,
+                activity.getTitle().toString(), activity);
         Bundle options = TransitionUtils.makeActivityOptionsBundle(activity, sharedView);
         ActivityCompat.startActivity(activity, intent, options);
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastFragment.java
Patch:
@@ -491,7 +491,8 @@ private void updateSendCommentStatus() {
         boolean enabled = canSendComment && !sendingComment;
         mCommentEdit.setEnabled(enabled);
         mSendButton.setEnabled(enabled);
-        mCommentEdit.setHint(canSendComment ? R.string.broadcast_send_comment_hint
+        boolean hasBroadcast = mBroadcastAndCommentListResource.hasBroadcast();
+        mCommentEdit.setHint(!hasBroadcast || canSendComment ? R.string.broadcast_send_comment_hint
                 : R.string.broadcast_send_comment_hint_disabled);
         if (sendingComment) {
             mCommentEdit.setText(manager.getComment(broadcastId));

File: app/src/main/java/me/zhanghai/android/douya/ui/MergeAdapter.java
Patch:
@@ -32,7 +32,7 @@ public MergeAdapter(RecyclerView.Adapter... adapters) {
         for (RecyclerView.Adapter adapter : mAdapters) {
             if (!adapter.hasStableIds()) {
                 hasStableIds = false;
-                LogUtils.w("not all the adapters have stable ids: " + adapter);
+                LogUtils.w("not all adapters have stable ids: " + adapter);
             }
         }
         super.setHasStableIds(hasStableIds);

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BaseBroadcastListFragment.java
Patch:
@@ -237,9 +237,9 @@ public void onOpenBroadcast(Broadcast broadcast, View sharedView) {
         openBroadcast(broadcast, sharedView, false);
     }
 
-    private void openBroadcast(Broadcast broadcast, View sharedView, boolean comment) {
+    private void openBroadcast(Broadcast broadcast, View sharedView, boolean showSendComment) {
         Activity activity = getActivity();
-        Intent intent = BroadcastActivity.makeIntent(broadcast, comment, getActivity());
+        Intent intent = BroadcastActivity.makeIntent(broadcast, showSendComment, getActivity());
         Bundle options = TransitionUtils.makeActivityOptionsBundle(activity, sharedView);
         ActivityCompat.startActivity(activity, intent, options);
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastActivityDialogFragment.java
Patch:
@@ -12,7 +12,6 @@
 import android.support.annotation.Nullable;
 import android.support.design.widget.TabLayout;
 import android.support.v4.app.Fragment;
-import android.support.v4.app.FragmentActivity;
 import android.support.v4.view.ViewPager;
 import android.support.v7.app.AppCompatDialog;
 import android.support.v7.app.AppCompatDialogFragment;
@@ -162,8 +161,8 @@ private CharSequence getTabTitle(int count, int formatResId, int emptyResId) {
         return count > 0 ? getString(formatResId, count) : getString(emptyResId);
     }
 
-    public static void show(Broadcast broadcast, FragmentActivity activity) {
+    public static void show(Broadcast broadcast, Fragment fragment) {
         BroadcastActivityDialogFragment.newInstance(broadcast)
-                .show(activity.getSupportFragmentManager(), null);
+                .show(fragment.getChildFragmentManager(), null);
     }
 }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/ConfirmDeleteCommentDialogFragment.java
Patch:
@@ -9,7 +9,7 @@
 import android.content.DialogInterface;
 import android.os.Bundle;
 import android.support.annotation.NonNull;
-import android.support.v4.app.FragmentActivity;
+import android.support.v4.app.Fragment;
 import android.support.v7.app.AlertDialog;
 import android.support.v7.app.AppCompatDialogFragment;
 
@@ -64,9 +64,9 @@ private Listener getListener() {
         return (Listener) getActivity();
     }
 
-    public static void show(Comment comment, FragmentActivity activity) {
+    public static void show(Comment comment, Fragment fragment) {
         ConfirmDeleteCommentDialogFragment.newInstance(comment)
-                .show(activity.getSupportFragmentManager(), null);
+                .show(fragment.getChildFragmentManager(), null);
     }
 
     public interface Listener {

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileHeaderLayout.java
Patch:
@@ -248,7 +248,7 @@ public void setMaxHeight(int maxHeight) {
     }
 
     public void bindUser(User user) {
-        ImageUtils.loadProfileAvatar(mAvatarImage, user.largeAvatar, getContext());
+        ImageUtils.loadProfileAvatar(mAvatarImage, user.getLargeAvatarOrAvatar(), getContext());
         mToolbarUsernameText.setText(user.name);
         mUsernameText.setText(user.name);
         mSignatureText.setText(null);
@@ -261,7 +261,7 @@ public void bindUserInfo(UserInfo userInfo) {
         Context context = getContext();
         if (!ViewUtils.isVisible(mAvatarImage)) {
             // HACK: Don't load avatar again if already loaded by bindUser().
-            ImageUtils.loadProfileAvatar(mAvatarImage, userInfo.largeAvatar, context);
+            ImageUtils.loadProfileAvatar(mAvatarImage, userInfo.getLargeAvatarOrAvatar(), context);
         }
         mToolbarUsernameText.setText(userInfo.name);
         mUsernameText.setText(userInfo.name);

File: app/src/main/java/me/zhanghai/android/douya/ui/FlexibleSpaceLayout.java
Patch:
@@ -521,7 +521,6 @@ private float View_getScrollFactor() {
                 throw new IllegalStateException(
                         "Expected theme to define listPreferredItemHeight.");
             }
-
         }
         return mView_verticalScrollFactor;
     }

File: app/src/main/java/me/zhanghai/android/douya/account/ui/AppCompatAccountAuthenticatorActivity.java
Patch:
@@ -25,7 +25,7 @@
  * is never set or if it is set to null then error {@link AccountManager#ERROR_CODE_CANCELED}
  * will be called on the response.
  */
-public class AppCompatAccountAuthenticatorActivity extends AppCompatActivity {
+public abstract class AppCompatAccountAuthenticatorActivity extends AppCompatActivity {
     private AccountAuthenticatorResponse mAccountAuthenticatorResponse = null;
     private Bundle mResultBundle = null;
 

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileHeaderLayout.java
Patch:
@@ -103,6 +103,7 @@ public ProfileHeaderLayout(Context context, AttributeSet attrs, int defStyleAttr
         init();
     }
 
+    @TargetApi(Build.VERSION_CODES.LOLLIPOP)
     private void init() {
         // HACK: We need to delegate the outline so that elevation can work.
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {

File: app/src/main/java/me/zhanghai/android/douya/ui/HorizontalImageAdapter.java
Patch:
@@ -41,13 +41,13 @@ public ViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {
     }
 
     @Override
-    public void onBindViewHolder(ViewHolder holder, final int position) {
+    public void onBindViewHolder(final ViewHolder holder, final int position) {
         holder.imageLayout.loadImage(getItem(position));
         holder.imageLayout.setOnClickListener(new View.OnClickListener() {
             @Override
             public void onClick(View view) {
                 if (mOnImageClickListener != null) {
-                    mOnImageClickListener.onImageClick(position);
+                    mOnImageClickListener.onImageClick(holder.getAdapterPosition());
                 }
             }
         });

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastAdapter.java
Patch:
@@ -80,13 +80,13 @@ public void onClick(View view) {
                 mListener.onCommentBroadcast(broadcast, getSharedView(holder));
             }
         });
+        ViewCompat.setTransitionName(getSharedView(holder), broadcast.makeTransitionName());
     }
 
     private static View getSharedView(ViewHolder holder) {
         Context context = holder.itemView.getContext();
         // HACK: Transition is so hard to work with, but this gives a better effect.
         View view = ViewUtils.hasSw600dp(context) ? holder.cardView : holder.broadcastLayout;
-        ViewCompat.setTransitionName(view, context.getString(R.string.transition_name_broadcast));
         return view;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastActivityDialogFragment.java
Patch:
@@ -24,9 +24,9 @@
 
 import butterknife.Bind;
 import butterknife.ButterKnife;
-import de.greenrobot.event.EventBus;
 import me.zhanghai.android.douya.R;
 import me.zhanghai.android.douya.eventbus.BroadcastUpdatedEvent;
+import me.zhanghai.android.douya.eventbus.EventBusUtils;
 import me.zhanghai.android.douya.network.api.info.Broadcast;
 import me.zhanghai.android.douya.ui.TabFragmentPagerAdapter;
 import me.zhanghai.android.douya.util.FragmentUtils;
@@ -131,14 +131,14 @@ public void onClick(View view) {
     public void onStart(){
         super.onStart();
 
-        EventBus.getDefault().register(this);
+        EventBusUtils.register(this);
     }
 
     @Override
     public void onStop() {
         super.onStop();
 
-        EventBus.getDefault().unregister(this);
+        EventBusUtils.unregister(this);
     }
 
     @Keep

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/CommentAdapter.java
Patch:
@@ -36,7 +36,7 @@ public CommentAdapter(List<Comment> commentList,
 
     @Override
     public long getItemId(int position) {
-        return getList().get(position).id;
+        return getItem(position).id;
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/main/ui/MainActivity.java
Patch:
@@ -168,7 +168,6 @@ private void onShowSettings() {
 
     public void setToolbar(Toolbar toolbar) {
         setSupportActionBar(toolbar);
-        getSupportActionBar().setDisplayHomeAsUpEnabled(true);
         TransitionUtils.setupTransitionForAppBar(this);
     }
 

File: app/src/main/java/me/zhanghai/android/douya/notification/ui/NotificationAdapter.java
Patch:
@@ -45,7 +45,7 @@ public NotificationAdapter(List<Notification> notificationList, Context context)
 
     @Override
     public long getItemId(int position) {
-        return getList().get(position).id;
+        return getItem(position).id;
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/settings/ui/AboutActivity.java
Patch:
@@ -38,7 +38,6 @@ protected void onCreate(Bundle savedInstanceState) {
 
         setSupportActionBar(mToolbar);
         ActionBar actionBar = getSupportActionBar();
-        actionBar.setDisplayHomeAsUpEnabled(true);
         actionBar.setTitle("");
 
         // Seems that ScrollView intercepts touch event, so we have to set the onTouchListener on a

File: app/src/main/java/me/zhanghai/android/douya/settings/ui/SettingsActivity.java
Patch:
@@ -33,7 +33,6 @@ protected void onCreate(Bundle savedInstanceState) {
         ButterKnife.bind(this);
 
         setSupportActionBar(mToolbar);
-        getSupportActionBar().setDisplayHomeAsUpEnabled(true);
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/ui/GalleryActivity.java
Patch:
@@ -54,7 +54,6 @@ protected void onCreate(Bundle savedInstanceState) {
         ButterKnife.bind(this);
 
         setSupportActionBar(mToolbar);
-        getSupportActionBar().setDisplayHomeAsUpEnabled(true);
 
         mSystemUiHelper = new SystemUiHelper(this, SystemUiHelper.LEVEL_IMMERSIVE,
                 SystemUiHelper.FLAG_IMMERSIVE_STICKY,

File: app/src/main/java/me/zhanghai/android/douya/ui/WebViewActivity.java
Patch:
@@ -149,7 +149,6 @@ protected void reloadWebView() {
 
     private void setupToolbar() {
         setSupportActionBar(mToolbar);
-        getSupportActionBar().setDisplayHomeAsUpEnabled(true);
     }
 
     private void setProgressVisible(boolean visible) {

File: app/src/main/java/me/zhanghai/android/douya/user/ui/UserAdapter.java
Patch:
@@ -34,7 +34,7 @@ public UserAdapter(List<User> userList) {
 
     @Override
     public long getItemId(int position) {
-        return getList().get(position).id;
+        return getItem(position).id;
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/account/ui/AuthenticatorActivity.java
Patch:
@@ -236,12 +236,12 @@ private void attemptStartAuth() {
     private void onStartAuth() {
 
         TokenRequest request = new TokenRequest(mUsername, mPassword);
-        RequestFragment.startRequest(REQUEST_CODE_AUTH, request, null, this);
+        RequestFragment.startRequest(request, null, this, REQUEST_CODE_AUTH);
 
         mUsernameLayout.setError(null);
         mPasswordLayout.setError(null);
         mLoginButton.setEnabled(false);
-        ViewUtils.crossfade(mFormLayout, mProgress);
+        ViewUtils.crossfade(mFormLayout, mProgress, false);
         mShowingProgress = true;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/link/DoubanUriHandler.java
Patch:
@@ -70,9 +70,9 @@ public static boolean open(Uri uri, Context context) {
             case BROADCAST_FRODO:
                 intent = BroadcastActivity.makeIntent(UriUtils.parseId(uri), context);
                 break;
-//            case USER:
-//                intent = ProfileActivity.makeIntent(uri.getLastPathSegment(), context);
-//                break;
+            case USER:
+                intent = ProfileActivity.makeIntent(uri.getLastPathSegment(), context);
+                break;
             default:
                 return false;
         }

File: app/src/main/java/me/zhanghai/android/douya/notification/ui/NotificationListFragment.java
Patch:
@@ -231,7 +231,7 @@ private void loadNotificationList(boolean loadMore) {
         ApiRequest<NotificationList> request = ApiRequests.newNotificationListRequest(start, count,
                 getActivity());
         LoadNotificationListState state = new LoadNotificationListState(loadMore, count);
-        RequestFragment.startRequest(REQUEST_CODE_LOAD_NOTIFICATION_LIST, request, state, this);
+        RequestFragment.startRequest(request, state, this, REQUEST_CODE_LOAD_NOTIFICATION_LIST);
 
         mLoadingNotificationList = true;
         setRefreshing(true, loadMore);

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileActivity.java
Patch:
@@ -266,7 +266,7 @@ private void loadUserInfo() {
         mLoadingUserInfo = true;
 
         ApiRequest<UserInfo> request = ApiRequests.newUserInfoRequest(mUserIdOrUid, this);
-        RequestFragment.startRequest(REQUEST_CODE_LOAD_USER_INFO, request, null, this);
+        RequestFragment.startRequest(request, null, this, REQUEST_CODE_LOAD_USER_INFO);
     }
 
     private void onLoadUserInfoResponse(boolean successful, UserInfo result, VolleyError error) {
@@ -306,7 +306,7 @@ private void loadBroadcastList() {
 
         ApiRequest<List<Broadcast>> request = ApiRequests.newBroadcastListRequest(mUserIdOrUid,
                 null, null, BROADCAST_COUNT_PER_LOAD, this);
-        RequestFragment.startRequest(REQUEST_CODE_LOAD_BROADCAST_LIST, request, null, this);
+        RequestFragment.startRequest(request, null, this, REQUEST_CODE_LOAD_BROADCAST_LIST);
     }
 
     private void onLoadBroadcastListResponse(boolean successful, List<Broadcast> result,

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileBroadcastsLayout.java
Patch:
@@ -25,7 +25,7 @@
 import me.zhanghai.android.douya.network.api.info.Photo;
 import me.zhanghai.android.douya.ui.FriendlyCardView;
 import me.zhanghai.android.douya.ui.TimeActionTextView;
-import me.zhanghai.android.douya.util.ContentStateLayout;
+import me.zhanghai.android.douya.ui.ContentStateLayout;
 import me.zhanghai.android.douya.util.ImageUtils;
 import me.zhanghai.android.douya.util.ViewUtils;
 

File: app/src/main/java/me/zhanghai/android/douya/ui/ContentStateLayout.java
Patch:
@@ -3,7 +3,7 @@
  * All Rights Reserved.
  */
 
-package me.zhanghai.android.douya.util;
+package me.zhanghai.android.douya.ui;
 
 import android.annotation.TargetApi;
 import android.content.Context;
@@ -19,6 +19,7 @@
 import java.lang.annotation.RetentionPolicy;
 
 import me.zhanghai.android.douya.R;
+import me.zhanghai.android.douya.util.ViewUtils;
 
 public class ContentStateLayout extends FrameLayout {
 
@@ -142,7 +143,7 @@ private void setViewVisible(View view, boolean visible, boolean animate) {
         if (animate) {
             ViewUtils.fadeToVisibility(view, visible);
         } else {
-            ViewUtils.setVisibleOrInvisible(view, visible);
+            ViewUtils.setVisibleOrGone(view, visible);
         }
     }
 

File: app/src/main/java/me/zhanghai/android/douya/link/DoubanUriHandler.java
Patch:
@@ -68,10 +68,10 @@ public static boolean open(Uri uri, Context context) {
         switch (uriType) {
             case BROADCAST:
             case BROADCAST_FRODO:
-                intent = BroadcastActivity.makeIntent(context, UriUtils.parseId(uri));
+                intent = BroadcastActivity.makeIntent(UriUtils.parseId(uri), context);
                 break;
 //            case USER:
-//                intent = ProfileActivity.makeIntent(context, uri.getLastPathSegment());
+//                intent = ProfileActivity.makeIntent(uri.getLastPathSegment(), context);
 //                break;
             default:
                 return false;

File: app/src/main/java/me/zhanghai/android/douya/app/TargetedRetainedFragment.java
Patch:
@@ -86,8 +86,7 @@ protected Fragment getTargetFragmentFriendly() {
             throw new IllegalStateException("Target fragment not set");
         }
         if (mTargetFragment == null) {
-            mTargetFragment = FriendlyFragment.findByWho(getActivity().getSupportFragmentManager(),
-                    mTargetFragmentWho);
+            mTargetFragment = FriendlyFragment.findByWho(getActivity(), mTargetFragmentWho);
         }
         if (mTargetFragment == null) {
             throw new IllegalStateException("Target fragment not found");

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastLikerListResource.java
Patch:
@@ -13,6 +13,7 @@
 import me.zhanghai.android.douya.network.api.ApiRequest;
 import me.zhanghai.android.douya.network.api.ApiRequests;
 import me.zhanghai.android.douya.network.api.info.User;
+import me.zhanghai.android.douya.util.FragmentUtils;
 
 public class BroadcastLikerListResource extends BroadcastUserListResource {
 
@@ -46,15 +47,15 @@ public static BroadcastLikerListResource attachTo(long broadcastId, Fragment fra
     private static BroadcastLikerListResource attachTo(long broadcastId, FragmentActivity activity,
                                                       String tag, boolean targetAtActivity,
                                                       Fragment targetFragment, int requestCode) {
-        BroadcastLikerListResource resource = findByTag(activity, tag);
+        BroadcastLikerListResource resource = FragmentUtils.findByTag(activity, tag);
         if (resource == null) {
             resource = newInstance(broadcastId);
             if (targetAtActivity) {
                 resource.targetAtActivity(requestCode);
             } else {
                 resource.targetAtFragment(targetFragment, requestCode);
             }
-            resource.addTo(activity, tag);
+            FragmentUtils.add(resource, activity, tag);
         }
         return resource;
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/BroadcastRebroadcasterListResource.java
Patch:
@@ -13,6 +13,7 @@
 import me.zhanghai.android.douya.network.api.ApiRequest;
 import me.zhanghai.android.douya.network.api.ApiRequests;
 import me.zhanghai.android.douya.network.api.info.User;
+import me.zhanghai.android.douya.util.FragmentUtils;
 
 public class BroadcastRebroadcasterListResource extends BroadcastUserListResource {
 
@@ -51,15 +52,15 @@ private static BroadcastRebroadcasterListResource attachTo(long broadcastId,
                                                                String tag, boolean targetAtActivity,
                                                                Fragment targetFragment,
                                                                int requestCode) {
-        BroadcastRebroadcasterListResource resource = findByTag(activity, tag);
+        BroadcastRebroadcasterListResource resource = FragmentUtils.findByTag(activity, tag);
         if (resource == null) {
             resource = newInstance(broadcastId);
             if (targetAtActivity) {
                 resource.targetAtActivity(requestCode);
             } else {
                 resource.targetAtFragment(targetFragment, requestCode);
             }
-            resource.addTo(activity, tag);
+            FragmentUtils.add(resource, activity, tag);
         }
         return resource;
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/content/HomeBroadcastListResource.java
Patch:
@@ -14,6 +14,7 @@
 import me.zhanghai.android.douya.network.api.info.Broadcast;
 import me.zhanghai.android.douya.settings.info.Settings;
 import me.zhanghai.android.douya.util.Callback;
+import me.zhanghai.android.douya.util.FragmentUtils;
 
 public class HomeBroadcastListResource extends BroadcastListResource {
 
@@ -51,15 +52,15 @@ public static HomeBroadcastListResource attachTo(Fragment fragment) {
     private static HomeBroadcastListResource attachTo(FragmentActivity activity, String tag,
                                                       boolean targetAtActivity,
                                                       Fragment targetFragment, int requestCode) {
-        HomeBroadcastListResource resource = findByTag(activity, tag);
+        HomeBroadcastListResource resource = FragmentUtils.findByTag(activity, tag);
         if (resource == null) {
             resource = newInstance();
             if (targetAtActivity) {
                 resource.targetAtActivity(requestCode);
             } else {
                 resource.targetAtFragment(targetFragment, requestCode);
             }
-            resource.addTo(activity, tag);
+            FragmentUtils.add(resource, activity, tag);
         }
         return resource;
     }

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLikerListFragment.java
Patch:
@@ -21,8 +21,9 @@ public BroadcastLikerListFragment() {}
 
     public static BroadcastLikerListFragment newInstance(Broadcast broadcast) {
         //noinspection deprecation
-        return (BroadcastLikerListFragment) new BroadcastLikerListFragment()
-                .setArguments(broadcast);
+        BroadcastLikerListFragment fragment = new BroadcastLikerListFragment();
+        fragment.setArguments(broadcast);
+        return fragment;
     }
 
     @Override

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/CommentActionDialogFragment.java
Patch:
@@ -16,6 +16,7 @@
 
 import me.zhanghai.android.douya.R;
 import me.zhanghai.android.douya.network.api.info.Comment;
+import me.zhanghai.android.douya.util.FragmentUtils;
 
 /**
  * Simple dialog for comment action. Requires the host activity to implement
@@ -42,11 +43,10 @@ public static CommentActionDialogFragment newInstance(Comment comment, boolean c
                                                           boolean canDelete) {
         //noinspection deprecation
         CommentActionDialogFragment fragment = new CommentActionDialogFragment();
-        Bundle arguments = new Bundle();
+        Bundle arguments = FragmentUtils.ensureArguments(fragment);
         arguments.putParcelable(EXTRA_COMMENT, comment);
         arguments.putBoolean(EXTRA_CAN_REPLY_TO, canReplyTo);
         arguments.putBoolean(EXTRA_CAN_DELETE, canDelete);
-        fragment.setArguments(arguments);
         return fragment;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/ConfirmDeleteCommentDialogFragment.java
Patch:
@@ -15,6 +15,7 @@
 
 import me.zhanghai.android.douya.R;
 import me.zhanghai.android.douya.network.api.info.Comment;
+import me.zhanghai.android.douya.util.FragmentUtils;
 
 public class ConfirmDeleteCommentDialogFragment extends AppCompatDialogFragment {
 
@@ -32,9 +33,8 @@ public ConfirmDeleteCommentDialogFragment() {}
     public static ConfirmDeleteCommentDialogFragment newInstance(Comment comment) {
         //noinspection deprecation
         ConfirmDeleteCommentDialogFragment fragment = new ConfirmDeleteCommentDialogFragment();
-        Bundle arguments = new Bundle();
+        Bundle arguments = FragmentUtils.ensureArguments(fragment);
         arguments.putParcelable(EXTRA_COMMENT, comment);
-        fragment.setArguments(arguments);
         return fragment;
     }
 

File: app/src/main/java/me/zhanghai/android/douya/main/ui/MainActivity.java
Patch:
@@ -34,6 +34,7 @@
 import me.zhanghai.android.douya.ui.ActionItemBadge;
 import me.zhanghai.android.douya.ui.AppBarWrapperLayout;
 import me.zhanghai.android.douya.ui.TabFragmentPagerAdapter;
+import me.zhanghai.android.douya.util.FragmentUtils;
 import me.zhanghai.android.douya.util.TransitionUtils;
 
 public class MainActivity extends AppCompatActivity
@@ -114,9 +115,7 @@ public boolean onNavigationItemSelected(MenuItem menuItem) {
         mNotificationListFragment.setUnreadNotificationCountListener(this);
 
         if (savedInstanceState == null) {
-            getSupportFragmentManager().beginTransaction()
-                    .add(R.id.container, HomeFragment.newInstance())
-                    .commit();
+            FragmentUtils.add(HomeFragment.newInstance(), this, R.id.container);
         }
     }
 

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileActivity.java
Patch:
@@ -313,7 +313,8 @@ private void onLoadBroadcastListResponse(boolean successful, List<Broadcast> res
                                              VolleyError error) {
 
         if (successful) {
-            mBroadcastsLayout.bind(mUserIdOrUid, result);
+            mBroadcastList = result;
+            mBroadcastsLayout.bind(mUserIdOrUid, mBroadcastList);
         } else {
             mBroadcastsLayout.setError();
             LogUtils.e(error.toString());

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileBroadcastsLayout.java
Patch:
@@ -101,6 +101,7 @@ public void onClick(View view) {
             if (holder == null) {
                 holder = new BroadcastLayoutHolder(broadcastLayout);
                 broadcastLayout.setTag(holder);
+                ViewUtils.setTextViewLinkClickable(holder.textText);
             }
 
             // HACK: Should not change on rebind.

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastAdapter.java
Patch:
@@ -35,7 +35,7 @@ public BroadcastAdapter(List<Broadcast> broadcastList, Listener listener) {
         setHasStableIds(true);
     }
 
-// FIXME: Move this to a common place.
+    // FIXME: Move this to a common place.
     public Broadcast findBroadcastById(long broadcastId) {
         int count = getItemCount();
         for (int i = 0; i < count; ++i) {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastListFragment.java
Patch:
@@ -55,7 +55,7 @@
 import me.zhanghai.android.douya.util.TransitionUtils;
 import me.zhanghai.android.douya.util.ViewUtils;
 
-// TODO: Separate into HomeBroadcastListFragment and BroadcastListFragment.
+// TODO: Split into HomeBroadcastListFragment and BroadcastListFragment.
 public class BroadcastListFragment extends Fragment implements BroadcastListResource.Listener,
         RequestFragment.Listener, BroadcastAdapter.Listener {
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastActivityDialogFragment.java
Patch:
@@ -99,7 +99,7 @@ public void onViewCreated(View view, @Nullable Bundle savedInstanceState) {
     public void onActivityCreated(Bundle savedInstanceState) {
         super.onActivityCreated(savedInstanceState);
 
-        mTabAdapter = new TabFragmentPagerAdapter(getChildFragmentManager());
+        mTabAdapter = new TabFragmentPagerAdapter(this);
         mTabAdapter.addTab(new TabFragmentPagerAdapter.FragmentCreator() {
             @Override
             public Fragment createFragment() {

File: app/src/main/java/me/zhanghai/android/douya/home/HomeFragment.java
Patch:
@@ -68,7 +68,7 @@ public void onActivityCreated(Bundle savedInstanceState) {
         MainActivity activity = (MainActivity) getActivity();
         activity.setToolbar(mToolbar);
 
-        mTabAdapter = new TabFragmentPagerAdapter(getChildFragmentManager());
+        mTabAdapter = new TabFragmentPagerAdapter(this);
         mTabAdapter.addTab(new TabFragmentPagerAdapter.FragmentCreator() {
             @Override
             public Fragment createFragment() {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastListFragment.java
Patch:
@@ -193,9 +193,7 @@ public void onSaveInstanceState(Bundle outState) {
     public void onDestroy() {
         super.onDestroy();
 
-        if (isRemoving()) {
-            mBroadcastListResource.remove();
-        }
+        mBroadcastListResource.detach();
     }
 
     private ViewState onSaveViewState() {

File: app/src/main/java/me/zhanghai/android/douya/user/ui/UserListFragment.java
Patch:
@@ -115,9 +115,7 @@ public void onSaveInstanceState(Bundle outState) {
     public void onDestroy() {
         super.onDestroy();
 
-        if (isRemoving()) {
-            mUserListResource.remove();
-        }
+        mUserListResource.detach();
     }
 
     protected abstract UserListResource onAttachUserListResource();

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLayout.java
Patch:
@@ -163,14 +163,14 @@ public void bindBroadcast(final Broadcast broadcast) {
         mAvatarImage.setOnClickListener(new OnClickListener() {
             @Override
             public void onClick(View view) {
-                context.startActivity(ProfileActivity.makeIntent(context, broadcast.author));
+                context.startActivity(ProfileActivity.makeIntent(broadcast.author, context));
             }
         });
         mNameText.setText(broadcast.author.name);
         mTimeActionText.setDoubanTimeAndAction(broadcast.createdAt, broadcast.action);
 
         boolean isRebind = mBoundBroadcastId != null && mBoundBroadcastId == broadcast.id;
-        // Attachment and text should not change on rebind.
+        // HACK: Attachment and text should not change on rebind.
         if (!isRebind) {
 
             Attachment attachment = broadcast.attachment;

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileActivity.java
Patch:
@@ -273,7 +273,8 @@ private void setLoadingUserInfo(boolean loading) {
     @Keep
     public void onEventMainThread(UserInfoUpdatedEvent event) {
         UserInfo userInfo = event.userInfo;
-        if (TextUtils.equals(mUserIdOrUid, String.valueOf(userInfo.id))) {
+        if (TextUtils.equals(mUserIdOrUid, String.valueOf(userInfo.id))
+                || TextUtils.equals(mUserIdOrUid, userInfo.uid)) {
             setUserInfo(userInfo);
         }
     }

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileHeaderLayout.java
Patch:
@@ -3,7 +3,7 @@
  * All Rights Reserved.
  */
 
-package me.zhanghai.android.douya.ui;
+package me.zhanghai.android.douya.profile.ui;
 
 import android.annotation.TargetApi;
 import android.content.Context;
@@ -26,6 +26,7 @@
 import me.zhanghai.android.douya.R;
 import me.zhanghai.android.douya.network.api.info.User;
 import me.zhanghai.android.douya.network.api.info.UserInfo;
+import me.zhanghai.android.douya.ui.FlexibleSpaceHeaderView;
 import me.zhanghai.android.douya.util.ImageUtils;
 import me.zhanghai.android.douya.util.MathUtils;
 import me.zhanghai.android.douya.util.ViewCompat;

File: app/src/main/java/me/zhanghai/android/douya/profile/ui/ProfileLayout.java
Patch:
@@ -3,15 +3,14 @@
  * All Rights Reserved.
  */
 
-package me.zhanghai.android.douya.ui;
+package me.zhanghai.android.douya.profile.ui;
 
 import android.animation.Animator;
 import android.animation.AnimatorListenerAdapter;
 import android.animation.ObjectAnimator;
 import android.app.Activity;
 import android.content.Context;
 import android.graphics.drawable.ColorDrawable;
-import android.support.v4.view.ViewCompat;
 import android.support.v4.view.animation.FastOutLinearInInterpolator;
 import android.support.v4.view.animation.LinearOutSlowInInterpolator;
 import android.util.AttributeSet;
@@ -22,6 +21,8 @@
 import butterknife.BindInt;
 import butterknife.ButterKnife;
 import me.zhanghai.android.douya.R;
+import me.zhanghai.android.douya.ui.FlexibleSpaceLayout;
+import me.zhanghai.android.douya.ui.IntProperty;
 import me.zhanghai.android.douya.util.ViewUtils;
 
 public class ProfileLayout extends FlexibleSpaceLayout {

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastLayout.java
Patch:
@@ -28,6 +28,7 @@
 import me.zhanghai.android.douya.network.api.info.Broadcast;
 import me.zhanghai.android.douya.network.api.info.Image;
 import me.zhanghai.android.douya.network.api.info.Photo;
+import me.zhanghai.android.douya.profile.ui.ProfileActivity;
 import me.zhanghai.android.douya.ui.CardIconButton;
 import me.zhanghai.android.douya.ui.GalleryActivity;
 import me.zhanghai.android.douya.ui.HorizontalImageAdapter;
@@ -162,7 +163,7 @@ public void bindBroadcast(final Broadcast broadcast) {
         mAvatarImage.setOnClickListener(new OnClickListener() {
             @Override
             public void onClick(View view) {
-                UriHandler.open(broadcast.author.alt, context);
+                context.startActivity(ProfileActivity.makeIntent(context, broadcast.author));
             }
         });
         mNameText.setText(broadcast.author.name);

File: app/src/main/java/me/zhanghai/android/douya/ui/FlexibleSpaceScrollLayout.java
Patch:
@@ -132,7 +132,6 @@ public void scrollTo(int scroll) {
         if (mScroll == scroll) {
             return;
         }
-        // FIXME: mScrollingChildIndex == -1
         for (int indexMax = mScrollableChildren.size() - 1, step = scroll - mScroll > 0 ? 1 : -1; ;
              mScrollingChildIndex += step) {
             mScroll += scrollChildBy(mScrollableChildren.get(mScrollingChildIndex),

File: app/src/main/java/me/zhanghai/android/douya/ui/ProfileScrollLayout.java
Patch:
@@ -26,7 +26,7 @@
 public class ProfileScrollLayout extends FlexibleSpaceScrollLayout {
 
     @BindInt(android.R.integer.config_shortAnimTime)
-    int mOffsetAnimationTime;
+    int mShortAnimationTime;
     @BindColor(R.color.dark_70_percent)
     int mBackgroundColor;
 
@@ -181,7 +181,7 @@ public void run() {
 
     private void animateEnter() {
         ObjectAnimator animator = ObjectAnimator.ofInt(this, OFFSET, getHeight(), 0);
-        animator.setDuration(mOffsetAnimationTime);
+        animator.setDuration(mShortAnimationTime);
         animator.setInterpolator(new LinearOutSlowInInterpolator());
         animator.addListener(new AnimatorListenerAdapter() {
             @Override
@@ -205,7 +205,7 @@ public void exit() {
 
     private void animateExit() {
         ObjectAnimator animator = ObjectAnimator.ofInt(this, OFFSET, getOffset(), getHeight());
-        animator.setDuration(mOffsetAnimationTime);
+        animator.setDuration(mShortAnimationTime);
         animator.setInterpolator(new FastOutLinearInInterpolator());
         animator.addListener(new AnimatorListenerAdapter() {
             @Override

File: app/src/main/java/me/zhanghai/android/douya/ui/FriendlyCardView.java
Patch:
@@ -20,19 +20,19 @@ public class FriendlyCardView extends CardView {
     public FriendlyCardView(Context context) {
         super(context);
 
-        init(context, null, 0);
+        init(getContext(), null, 0);
     }
 
     public FriendlyCardView(Context context, AttributeSet attrs) {
         super(context, attrs);
 
-        init(context, attrs, 0);
+        init(getContext(), attrs, 0);
     }
 
     public FriendlyCardView(Context context, AttributeSet attrs, int defStyleAttr) {
         super(context, attrs, defStyleAttr);
 
-        init(context, attrs, defStyleAttr);
+        init(getContext(), attrs, defStyleAttr);
     }
 
     private void init(Context context, AttributeSet attrs, int defStyleAttr) {

File: app/src/main/java/me/zhanghai/android/douya/ui/RatioHeightRecyclerView.java
Patch:
@@ -20,19 +20,19 @@ public class RatioHeightRecyclerView extends RecyclerView {
     public RatioHeightRecyclerView(Context context) {
         super(context);
 
-        init(context, null, 0);
+        init(getContext(), null, 0);
     }
 
     public RatioHeightRecyclerView(Context context, AttributeSet attrs) {
         super(context, attrs);
 
-        init(context, attrs, 0);
+        init(getContext(), attrs, 0);
     }
 
     public RatioHeightRecyclerView(Context context, AttributeSet attrs, int defStyle) {
         super(context, attrs, defStyle);
 
-        init(context, attrs, defStyle);
+        init(getContext(), attrs, defStyle);
     }
 
     private void init(Context context, AttributeSet attrs, int defStyle) {

File: app/src/main/java/me/zhanghai/android/douya/ui/FlexibleSpaceScrollLayout.java
Patch:
@@ -362,7 +362,10 @@ public void computeScroll() {
             int scrollerCurrY = mScroller.getCurrY();
             scrollTo(scrollerCurrY);
             if (mScroll > oldScroll && scrollerCurrY > mScroll) {
+                // We did scroll down for some y and the target y is beyond our range.
                 mEdgeEffectBottom.onAbsorb((int) mScroller.getCurrVelocity());
+            }
+            if (scrollerCurrY < 0 || scrollerCurrY > mScroll) {
                 abortScrollerAnimation();
             }
             ViewCompat.postInvalidateOnAnimation(this);

File: app/src/main/java/me/zhanghai/android/douya/ui/ProfileScrollLayout.java
Patch:
@@ -101,7 +101,8 @@ public void offsetTo(int offset) {
     }
 
     private void updateBackground(int offset) {
-        float fraction = Math.max(0, 1 - (float) offset / (getHeight() - getPaddingTop()));
+        float fraction = Math.max(0, 1 - (float) offset
+                / (getHeight() - getPaddingTop() - getPaddingBottom()));
         mBackgroundDrawable.setAlpha((int) (fraction * 0xFF));
     }
 

File: app/src/main/java/me/zhanghai/android/douya/broadcast/ui/BroadcastListFragment.java
Patch:
@@ -11,7 +11,6 @@
 import android.os.Handler;
 import android.support.annotation.Keep;
 import android.support.annotation.Nullable;
-import android.support.design.widget.FloatingActionButton;
 import android.support.v4.app.ActivityCompat;
 import android.support.v4.app.Fragment;
 import android.support.v4.widget.SwipeRefreshLayout;
@@ -47,6 +46,7 @@
 import me.zhanghai.android.douya.network.api.info.Broadcast;
 import me.zhanghai.android.douya.settings.info.Settings;
 import me.zhanghai.android.douya.ui.AppBarManager;
+import me.zhanghai.android.douya.ui.FriendlyFloatingActionButton;
 import me.zhanghai.android.douya.ui.LoadMoreAdapter;
 import me.zhanghai.android.douya.ui.NoChangeAnimationItemAnimator;
 import me.zhanghai.android.douya.ui.OnVerticalScrollWithPagingSlopListener;
@@ -84,7 +84,7 @@ public class BroadcastListFragment extends Fragment implements RequestFragment.L
     @Bind(R.id.progress)
     ProgressBar mProgress;
     @Bind(R.id.send)
-    FloatingActionButton mSendFab;
+    FriendlyFloatingActionButton mSendFab;
 
     private RetainDataFragment mRetainDataFragment;
 

File: app/src/main/java/me/zhanghai/android/douya/ui/FlexibleSpaceScrollLayout.java
Patch:
@@ -136,7 +136,8 @@ public void scrollTo(int scroll) {
                     scroll - mScroll);
             if (mScroll == scroll) {
                 break;
-            } else if (mScrollingChildIndex == 0 || mScrollingChildIndex == indexMax) {
+            } else if ((step < 0 && mScrollingChildIndex == 0)
+                    || (step > 0 && mScrollingChildIndex == indexMax)) {
                 break;
             }
         }

File: app/src/main/java/me/zhanghai/android/douya/network/api/ApiRequests.java
Patch:
@@ -55,9 +55,9 @@ public static ApiRequest<NotificationList> newNotificationListRequest(Integer st
             protected Response<NotificationList> parseNetworkResponse(NetworkResponse response) {
                 Response<NotificationList> superResponse = super.parseNetworkResponse(response);
                 if (superResponse.isSuccess()) {
-                    // Fix for Frodo API text.
+                    // Fix for Frodo API.
                     for (Notification notification : superResponse.result.notifications) {
-                        notification.fixText();
+                        notification.fix();
                     }
                 }
                 return superResponse;

