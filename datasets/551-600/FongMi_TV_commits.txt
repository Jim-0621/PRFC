File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -35,12 +35,12 @@ private static ObjectKey getSignature(String url) {
     }
 
     public static void load(String url, CustomTarget<Bitmap> target) {
-        if (!TextUtils.isEmpty(url)) Glide.with(App.get()).asBitmap().load(getUrl(url)).skipMemoryCache(true).dontAnimate().signature(getSignature(url)).into(target);
+        if (!TextUtils.isEmpty(url)) Glide.with(App.get()).asBitmap().load(getUrl(url)).override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight()).skipMemoryCache(true).dontAnimate().signature(getSignature(url)).into(target);
     }
 
     public static void load(String url, int error, CustomTarget<Drawable> target) {
         if (TextUtils.isEmpty(url)) target.onLoadFailed(ResUtil.getDrawable(error));
-        else Glide.with(App.get()).asDrawable().load(getUrl(url)).error(error).skipMemoryCache(true).dontAnimate().signature(getSignature(url)).into(target);
+        else Glide.with(App.get()).asDrawable().load(getUrl(url)).override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight()).error(error).skipMemoryCache(true).dontAnimate().signature(getSignature(url)).into(target);
     }
 
     public static void rect(String text, String url, ImageView view) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1058,7 +1058,8 @@ public void onPlayerEvent(PlayerEvent event) {
     }
 
     private void setPosition() {
-        if (mHistory != null) mPlayers.seekTo(mHistory.getOpening() > 0 ? mHistory.getOpening() : mHistory.getPosition());
+        if (mHistory == null) return;
+        mPlayers.seekTo(Math.max(mHistory.getOpening(), mHistory.getPosition()));
     }
 
     private void checkEnded() {
@@ -1236,9 +1237,9 @@ private void onPaused() {
     }
 
     private void onPlay() {
+        if (mHistory != null && mPlayers.isEnded()) mPlayers.seekTo(mHistory.getOpening());
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
         if (!mPlayers.isEmpty() && mPlayers.isIdle()) mPlayers.prepare();
-        if (mHistory != null && mPlayers.isEnded()) setPosition();
         mPlayers.play();
         hideCenter();
     }

File: app/src/main/java/com/fongmi/android/tv/utils/Clock.java
Patch:
@@ -14,9 +14,9 @@ public class Clock {
 
     private SimpleDateFormat format;
     private Callback callback;
-    private final Date date;
     private TextView view;
     private Timer timer;
+    private Date date;
 
     public static Clock create() {
         return new Clock();
@@ -69,6 +69,7 @@ public Clock stop() {
     }
 
     public void release() {
+        if (date != null) date = null;
         if (timer != null) timer.cancel();
         if (callback != null) callback = null;
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1107,7 +1107,8 @@ public void onPlayerEvent(PlayerEvent event) {
     }
 
     private void setPosition() {
-        if (mHistory != null) mPlayers.seekTo(mHistory.getOpening() > 0 ? mHistory.getOpening() : mHistory.getPosition());
+        if (mHistory == null) return;
+        mPlayers.seekTo(Math.max(mHistory.getOpening(), mHistory.getPosition()));
     }
 
     private void checkPortrait() {
@@ -1287,9 +1288,9 @@ private void onPaused() {
     }
 
     private void onPlay() {
+        if (mHistory != null && mPlayers.isEnded()) mPlayers.seekTo(mHistory.getOpening());
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
         if (!mPlayers.isEmpty() && mPlayers.isIdle()) mPlayers.prepare();
-        if (mHistory != null && mPlayers.isEnded()) setPosition();
         checkPlayImg(true);
         mPlayers.play();
     }

File: app/src/main/java/com/fongmi/android/tv/ui/dialog/TrackDialog.java
Patch:
@@ -15,6 +15,7 @@
 import androidx.media3.common.Tracks;
 import androidx.viewbinding.ViewBinding;
 
+import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.bean.Sub;
 import com.fongmi.android.tv.bean.Track;
@@ -133,7 +134,7 @@ public void onItemClick(Track item) {
     public void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
         super.onActivityResult(requestCode, resultCode, data);
         if (resultCode != Activity.RESULT_OK || requestCode != FileChooser.REQUEST_PICK_FILE) return;
-        player.setSub(Sub.from(FileChooser.getPathFromUri(getContext(), data.getData())));
+        App.post(() -> player.setSub(Sub.from(FileChooser.getPathFromUri(App.get(), data.getData()))), 250);
         dismiss();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1235,7 +1235,7 @@ private void onPaused() {
 
     private void onPlay() {
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
-        if (mPlayers.isEnded()) mPlayers.seekTo(mHistory != null ? mHistory.getOpening() : C.TIME_UNSET);
+        if (mHistory != null && mPlayers.isEnded()) mPlayers.seekTo(mHistory.getOpening());
         if (mPlayers.isIdle()) mPlayers.prepare();
         mPlayers.play();
         hideCenter();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1286,7 +1286,7 @@ private void onPaused() {
 
     private void onPlay() {
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
-        if (mPlayers.isEnded()) mPlayers.seekTo(mHistory != null ? mHistory.getOpening() : C.TIME_UNSET);
+        if (mHistory != null && mPlayers.isEnded()) mPlayers.seekTo(mHistory.getOpening());
         if (mPlayers.isIdle()) mPlayers.prepare();
         checkPlayImg(true);
         mPlayers.play();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1235,7 +1235,7 @@ private void onPaused() {
 
     private void onPlay() {
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
-        if (mPlayers.isEnded()) mPlayers.seekTo(mHistory.getOpening());
+        if (mPlayers.isEnded()) mPlayers.seekTo(mHistory != null ? mHistory.getOpening() : C.TIME_UNSET);
         if (mPlayers.isIdle()) mPlayers.prepare();
         mPlayers.play();
         hideCenter();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1286,7 +1286,7 @@ private void onPaused() {
 
     private void onPlay() {
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
-        if (mPlayers.isEnded()) mPlayers.seekTo(mHistory.getOpening());
+        if (mPlayers.isEnded()) mPlayers.seekTo(mHistory != null ? mHistory.getOpening() : C.TIME_UNSET);
         if (mPlayers.isIdle()) mPlayers.prepare();
         checkPlayImg(true);
         mPlayers.play();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1039,6 +1039,7 @@ public void onSubtitleClick() {
     @Override
     public void onTimeChanged() {
         long position, duration;
+        mPlayers.setPosition(mPlayers.getPosition());
         mHistory.setPosition(position = mPlayers.getPosition());
         mHistory.setDuration(duration = mPlayers.getDuration());
         if (position >= 0 && duration > 0 && !Setting.isIncognito()) App.execute(() -> mHistory.update());
@@ -1285,7 +1286,8 @@ private void onPaused() {
 
     private void onPlay() {
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
-        if (mPlayers.isEnd()) mPlayers.seekTo(mHistory.getOpening());
+        if (mPlayers.isEnded()) mPlayers.seekTo(mHistory.getOpening());
+        if (mPlayers.isIdle()) mPlayers.prepare();
         checkPlayImg(true);
         mPlayers.play();
     }

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -565,7 +565,7 @@ public void onVideoSizeChanged(@NonNull VideoSize videoSize) {
 
     @Override
     public void onTracksChanged(@NonNull Tracks tracks) {
-        PlayerEvent.track();
+        if (!tracks.isEmpty()) PlayerEvent.track();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomWebView.java
Patch:
@@ -183,7 +183,7 @@ private boolean isAd(String host) {
     private boolean isVideoFormat(String url) {
         try {
             Logger.t(TAG).d(url);
-            if (url.equals(this.url)) return false;
+            if (!detect && url.equals(this.url)) return false;
             Spider spider = VodConfig.get().getSite(key).spider();
             if (spider.manualVideoCheck()) return spider.isVideoFormat(url);
             return Sniffer.isVideoFormat(url);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -508,8 +508,6 @@ private void getPlayer(Flag flag, Episode episode, boolean replay) {
         mViewModel.playerContent(getKey(), flag.getFlag(), episode.getUrl());
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
         updateHistory(episode, replay);
-        mPlayers.clear();
-        mPlayers.stop();
         showProgress();
         setMetadata();
         hideCenter();
@@ -750,6 +748,8 @@ private void onReset() {
     }
 
     private void onReset(boolean replay) {
+        mPlayers.stop();
+        mPlayers.clear();
         mClock.setCallback(null);
         if (mFlagAdapter.size() == 0) return;
         if (mEpisodeAdapter.size() == 0) return;

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -525,8 +525,6 @@ private void getPlayer(Flag flag, Episode episode, boolean replay) {
         mViewModel.playerContent(getKey(), flag.getFlag(), episode.getUrl());
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
         updateHistory(episode, replay);
-        mPlayers.clear();
-        mPlayers.stop();
         showProgress();
         setMetadata();
     }
@@ -752,6 +750,8 @@ private void onReset() {
     }
 
     private void onReset(boolean replay) {
+        mPlayers.stop();
+        mPlayers.clear();
         mClock.setCallback(null);
         if (mFlagAdapter.isEmpty()) return;
         if (mEpisodeAdapter.isEmpty()) return;

File: app/src/main/java/com/fongmi/android/tv/bean/EpgData.java
Patch:
@@ -86,8 +86,8 @@ public boolean isFuture() {
 
     public String format(String group) {
         String pattern = group.split("\\)")[1].split("\\}")[0];
-        if (group.contains("(b)")) return new SimpleDateFormat(pattern, Locale.getDefault()).format(getStartTime());
-        if (group.contains("(e)")) return new SimpleDateFormat(pattern, Locale.getDefault()).format(getEndTime());
+        if (group.contains("(b")) return new SimpleDateFormat(pattern, Locale.getDefault()).format(getStartTime());
+        if (group.contains("(e")) return new SimpleDateFormat(pattern, Locale.getDefault()).format(getEndTime());
         return "";
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/adapter/RestoreAdapter.java
Patch:
@@ -40,12 +40,13 @@ public void addAll() {
         notifyDataSetChanged();
     }
 
-    public void remove(File item) {
+    public int remove(File item) {
         int position = mItems.indexOf(item);
-        if (position == -1) return;
+        if (position == -1) return -1;
         Path.clear(item);
         mItems.remove(position);
         notifyItemRemoved(position);
+        return getItemCount();
     }
 
     @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/dialog/HistoryDialog.java
Patch:
@@ -44,7 +44,8 @@ public void show() {
     }
 
     private void setRecyclerView() {
-        binding.recycler.setHasFixedSize(true);
+        binding.recycler.setItemAnimator(null);
+        binding.recycler.setHasFixedSize(false);
         binding.recycler.setAdapter(adapter.addAll(type));
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/dialog/RestoreDialog.java
Patch:
@@ -41,6 +41,7 @@ public void show(Callback callback) {
 
     private void setRecyclerView() {
         binding.recycler.setAdapter(adapter);
+        binding.recycler.setItemAnimator(null);
         binding.recycler.setHasFixedSize(false);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
     }
@@ -62,7 +63,6 @@ public void onItemClick(File item) {
 
     @Override
     public void onDeleteClick(File item) {
-        if (adapter.getItemCount() == 1) dialog.dismiss();
-        adapter.remove(item);
+        if (adapter.remove(item) == 0) dialog.dismiss();
     }
 }
\ No newline at end of file

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -409,7 +409,7 @@ private void setMediaItem(Result result, int timeout) {
     }
 
     private void setMediaItem(Map<String, String> headers, String url, String format, Drm drm, List<Sub> subs, int timeout) {
-        if (exoPlayer != null) exoPlayer.setMediaItem(ExoUtil.getMediaItem(this.headers = checkUa(headers), UrlUtil.uri(this.url = url), this.format = format, this.drm = drm, checkSub(this.subs = subs)), position);
+        if (exoPlayer != null) exoPlayer.setMediaItem(ExoUtil.getMediaItem(this.headers = checkUa(headers), UrlUtil.uri(this.url = url), this.format = format, this.drm = drm, checkSub(this.subs = subs), decode), position);
         if (exoPlayer != null) exoPlayer.prepare();
         App.post(runnable, timeout);
         session.setActive(true);

File: app/src/main/java/com/fongmi/android/tv/player/exo/ExoUtil.java
Patch:
@@ -108,7 +108,7 @@ public static String getMimeType(int errorCode) {
         return null;
     }
 
-    public static MediaItem getMediaItem(Map<String, String> headers, Uri uri, String mimeType, Drm drm, List<Sub> subs) {
+    public static MediaItem getMediaItem(Map<String, String> headers, Uri uri, String mimeType, Drm drm, List<Sub> subs, int decode) {
         MediaItem.Builder builder = new MediaItem.Builder().setUri(uri);
         builder.setRequestMetadata(getRequestMetadata(headers, uri));
         builder.setSubtitleConfigurations(getSubtitleConfigs(subs));
@@ -117,6 +117,7 @@ public static MediaItem getMediaItem(Map<String, String> headers, Uri uri, Strin
         builder.setForceUseRtpTcp(Setting.getRtsp() == 1);
         builder.setAds(Sniffer.getRegex(uri));
         builder.setMediaId(uri.toString());
+        builder.setDecode(decode);
         return builder.build();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/RestoreDialog.java
Patch:
@@ -40,6 +40,7 @@ protected ViewBinding getBinding(@NonNull LayoutInflater inflater, @Nullable Vie
 
     @Override
     protected void initView() {
+        binding.recycler.setItemAnimator(null);
         binding.recycler.setHasFixedSize(false);
         binding.recycler.setAdapter(adapter = new RestoreAdapter(this));
     }

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -523,6 +523,7 @@ public void checkData(Intent data) {
     @Override
     public void onParseSuccess(Map<String, String> headers, String url, String from) {
         if (!TextUtils.isEmpty(from)) Notify.show(ResUtil.getString(R.string.parse_from, from));
+        if (headers != null) headers.remove(HttpHeaders.RANGE);
         setMediaItem(headers, url);
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/config/LiveConfig.java
Patch:
@@ -245,8 +245,8 @@ public void setKeep(List<Group> items) {
     }
 
     public int[] find(List<Group> items) {
-        if (home == null || home.getKeep().isEmpty()) return new int[]{1, 0};
-        String[] splits = home.getKeep().split(AppDatabase.SYMBOL);
+        String[] splits = getHome().getKeep().split(AppDatabase.SYMBOL);
+        if (splits.length < 2) return new int[]{1, 0};
         for (int i = 0; i < items.size(); i++) {
             Group group = items.get(i);
             if (group.getName().equals(splits[0])) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/adapter/RestoreAdapter.java
Patch:
@@ -36,7 +36,7 @@ public void addAll() {
         File[] files = Path.tv().listFiles();
         if (files == null || files.length == 0) return;
         for (File file : files) if (file.getName().startsWith("tv") && file.getName().endsWith(".bk.gz")) mItems.add(file);
-        Collections.sort(mItems, Collections.reverseOrder());
+        Collections.sort(mItems, (f1, f2) -> Long.compare(f2.lastModified(), f1.lastModified()));
         notifyDataSetChanged();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/RestoreAdapter.java
Patch:
@@ -50,7 +50,7 @@ private void addAll() {
             File[] files = Path.tv().listFiles();
             if (files == null || files.length == 0) return;
             for (File file : files) if (file.getName().startsWith("tv") && file.getName().endsWith(".bk.gz")) mItems.add(file);
-            Collections.sort(mItems, Collections.reverseOrder());
+            Collections.sort(mItems, (f1, f2) -> Long.compare(f2.lastModified(), f1.lastModified()));
             callback.success();
         });
     }

File: app/src/main/java/com/fongmi/android/tv/db/dao/BaseDao.java
Patch:
@@ -32,9 +32,10 @@ public void insertOrUpdate(T item) {
 
     @Transaction
     public void insertOrUpdate(List<T> items) {
+        if (items.isEmpty()) return;
         List<Long> result = insert(items);
         List<T> list = new ArrayList<>();
         for (int i = 0; i < result.size(); i++) if (result.get(i) == -1) list.add(items.get(i));
-        if (list.size() > 0) update(list);
+        if (!list.isEmpty()) update(list);
     }
 }

File: app/src/main/java/com/fongmi/android/tv/player/exo/ExoUtil.java
Patch:
@@ -90,7 +90,7 @@ public static void setSubtitleView(PlayerView exo) {
         exo.getSubtitleView().setStyle(getCaptionStyle());
         exo.getSubtitleView().setApplyEmbeddedFontSizes(false);
         exo.getSubtitleView().setApplyEmbeddedStyles(!Setting.isCaption());
-        if (Setting.getSubtitlePosition() != 0) exo.getSubtitleView().setTranslationY(Setting.getSubtitlePosition());
+        if (Setting.getSubtitlePosition() != 0) exo.getSubtitleView().setBottomPosition(Setting.getSubtitlePosition());
         if (Setting.getSubtitleTextSize() != 0) exo.getSubtitleView().setFractionalTextSize(Setting.getSubtitleTextSize());
     }
 

File: catvod/src/main/java/com/github/catvod/utils/Prefers.java
Patch:
@@ -18,7 +18,7 @@
 
 public class Prefers {
 
-    private static final List<String> floats = Arrays.asList("speed");
+    private static final List<String> floats = Arrays.asList("speed", "subtitle_position", "subtitle_text_size");
 
     private static SharedPreferences getPrefers() {
         return PreferenceManager.getDefaultSharedPreferences(Init.context());

File: app/src/main/java/com/fongmi/android/tv/api/config/LiveConfig.java
Patch:
@@ -251,7 +251,7 @@ public int[] find(List<Group> items) {
             Group group = items.get(i);
             if (group.getName().equals(splits[0])) {
                 int j = group.find(splits[1]);
-                if (j != -1 && !splits[2].isEmpty()) group.getChannel().get(j).setLine(splits[2]);
+                if (j != -1 && splits.length > 2) group.getChannel().get(j).setLine(splits[2]);
                 if (j != -1) return new int[]{i, j};
             }
         }

File: tvbus/src/main/java/com/tvbus/engine/TVCore.java
Patch:
@@ -3,15 +3,14 @@
 import android.content.Context;
 
 import com.github.catvod.Init;
-import com.github.catvod.utils.Github;
 
 public class TVCore {
 
     private long handle;
 
     public TVCore(String so) {
         try {
-            System.load(Github.getSo(so));
+            System.load(so);
             handle = initialise();
         } catch (Throwable ignored) {
         }

File: app/src/main/java/com/fongmi/android/tv/bean/Part.java
Patch:
@@ -7,7 +7,8 @@
 public class Part {
 
     public static List<String> get(String source) {
-        List<String> items = new ArrayList<>(Arrays.asList(source.trim()));
+        List<String> items = new ArrayList<>();
+        items.add(source.trim());
         if (source.contains("：")) {
             for (String split : source.split("：")) items.add(split.trim().contains(" ") ? split.split(" ")[0].trim() : split.trim());
         } else if (source.contains("第") && source.contains("季")) {

File: app/src/main/java/com/fongmi/android/tv/api/config/LiveConfig.java
Patch:
@@ -245,7 +245,7 @@ public void setKeep(List<Group> items) {
     }
 
     public int[] find(List<Group> items) {
-        if (home.getKeep().isEmpty()) return new int[]{1, 0};
+        if (home == null || home.getKeep().isEmpty()) return new int[]{1, 0};
         String[] splits = home.getKeep().split(AppDatabase.SYMBOL);
         for (int i = 0; i < items.size(); i++) {
             Group group = items.get(i);

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -73,7 +73,7 @@ private static void json(Live live, String text) {
     }
 
     private static void spider(Live live) throws Exception {
-        String text = live.spider().liveContent(UrlUtil.convert(live.getUrl()));
+        String text = live.spider().liveContent(live.getUrl());
         if (Json.valid(text)) json(live, text);
         else text(live, text);
     }

File: app/src/main/java/com/fongmi/android/tv/bean/Live.java
Patch:
@@ -356,6 +356,7 @@ public Live sync() {
         if (item == null) return this;
         setBoot(item.isBoot());
         setPass(item.isPass());
+        setKeep(item.getKeep());
         return this;
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -82,6 +82,7 @@ private static void m3u(Live live, String text) {
         Setting setting = Setting.create();
         Catchup catchup = Catchup.create();
         Channel channel = Channel.create("");
+        text = text.replace("\r\n", "\n").replace("\r", "");
         for (String line : text.split("\n")) {
             if (Thread.interrupted()) break;
             if (setting.find(line)) {
@@ -132,6 +133,7 @@ private static void xtream(Live live) {
 
     private static void txt(Live live, String text) {
         Setting setting = Setting.create();
+        text = text.replace("\r\n", "\n").replace("\r", "");
         for (String line : text.split("\n")) {
             if (Thread.interrupted()) break;
             String[] split = line.split(",");
@@ -151,7 +153,7 @@ private static void txt(Live live, String text) {
 
     private static String getText(Live live) {
         if (live.isXtream() && !XtreamParser.isGetUrl(live.getUrl())) return "";
-        return getText(live.getUrl(), live.getHeaders()).replace("\r\n", "\n");
+        return getText(live.getUrl(), live.getHeaders());
     }
 
     private static String getText(String url, Map<String, String> header) {

File: app/src/main/java/com/fongmi/android/tv/api/config/LiveConfig.java
Patch:
@@ -114,7 +114,7 @@ public void load(Callback callback) {
 
     private void loadConfig(Callback callback) {
         try {
-            boolean xtream = XtreamParser.isVerify(config.getUrl());
+            boolean xtream = XtreamParser.isApiUrl(config.getUrl());
             parseConfig(xtream ? "" : Decoder.getJson(config.getUrl()), callback);
         } catch (Throwable e) {
             if (TextUtils.isEmpty(config.getUrl())) App.post(() -> callback.error(""));

File: app/src/main/java/com/fongmi/android/tv/bean/Live.java
Patch:
@@ -336,7 +336,7 @@ public Live check() {
         boolean xtream = XtreamParser.isVerify(uri);
         if (xtream) setUsername(uri.getQueryParameter("username"));
         if (xtream) setPassword(uri.getQueryParameter("password"));
-        if (xtream && getEpg().isEmpty()) setEpg(XtreamParser.getEpgUrl(this));
+        if (isXtream() && getEpg().isEmpty()) setEpg(XtreamParser.getEpgUrl(this));
         return this;
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -146,8 +146,7 @@ private static void txt(Live live, String text) {
     }
 
     private static String getText(Live live) {
-        if (XtreamParser.isApiUrl(live.getUrl())) return "";
-        return getText(live.getUrl(), live.getHeaders()).replace("\r\n", "\n");
+        return live.isXtream() ? "" : getText(live.getUrl(), live.getHeaders()).replace("\r\n", "\n");
     }
 
     private static String getText(String url, Map<String, String> header) {

File: app/src/main/java/com/fongmi/android/tv/api/config/LiveConfig.java
Patch:
@@ -114,7 +114,7 @@ public void load(Callback callback) {
 
     private void loadConfig(Callback callback) {
         try {
-            boolean xtream = XtreamParser.isApiUrl(config.getUrl());
+            boolean xtream = XtreamParser.isVerify(config.getUrl());
             parseConfig(xtream ? "" : Decoder.getJson(config.getUrl()), callback);
         } catch (Throwable e) {
             if (TextUtils.isEmpty(config.getUrl())) App.post(() -> callback.error(""));

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -52,8 +52,8 @@ public static void start(Live live) throws Exception {
     public static void text(Live live, String text) {
         int number = 0;
         if (!live.getGroups().isEmpty()) return;
-        if (text.isEmpty() && live.isXtream()) xtream(live);
-        else if (M3U.matcher(text).find()) m3u(live, text);
+        if (M3U.matcher(text).find()) m3u(live, text);
+        else if (live.isXtream()) xtream(live);
         else txt(live, text);
         for (Group group : live.getGroups()) {
             for (Channel channel : group.getChannel()) {

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -117,6 +117,7 @@ private static void xtream(Live live) {
             categoryMap.put(category.getCategoryId(), category.getCategoryName());
         }
         for (XStream stream : streamList) {
+            if (!categoryMap.containsKey(stream.getCategoryId())) continue;
             Group group = live.find(Group.create(categoryMap.get(stream.getCategoryId()), live.isPass()));
             Channel channel = group.find(Channel.create(stream.getName()));
             channel.getUrls().add(XtreamParser.getTsUrl(live, stream.getStreamId()));

File: app/src/main/java/com/fongmi/android/tv/api/config/LiveConfig.java
Patch:
@@ -8,6 +8,7 @@
 import com.fongmi.android.tv.Setting;
 import com.fongmi.android.tv.api.Decoder;
 import com.fongmi.android.tv.api.LiveParser;
+import com.fongmi.android.tv.api.XtreamParser;
 import com.fongmi.android.tv.api.loader.BaseLoader;
 import com.fongmi.android.tv.bean.Channel;
 import com.fongmi.android.tv.bean.Config;
@@ -113,7 +114,8 @@ public void load(Callback callback) {
 
     private void loadConfig(Callback callback) {
         try {
-            parseConfig(Decoder.getJson(config.getUrl()), callback);
+            boolean xtream = XtreamParser.isApiUrl(Uri.parse(config.getUrl()));
+            parseConfig(xtream ? "" : Decoder.getJson(config.getUrl()), callback);
         } catch (Throwable e) {
             if (TextUtils.isEmpty(config.getUrl())) App.post(() -> callback.error(""));
             else App.post(() -> callback.error(Notify.getError(R.string.error_config_get, e)));

File: app/src/main/java/com/fongmi/android/tv/player/exo/MediaSourceFactory.java
Patch:
@@ -1,6 +1,5 @@
 package com.fongmi.android.tv.player.exo;
 
-import static androidx.media3.extractor.ts.DefaultTsPayloadReaderFactory.FLAG_DETECT_ACCESS_UNITS;
 import static androidx.media3.extractor.ts.DefaultTsPayloadReaderFactory.FLAG_ENABLE_HDMV_DTS_AUDIO_STREAMS;
 
 import android.net.Uri;
@@ -84,7 +83,7 @@ private MediaSource createConcatenatingMediaSource(MediaItem mediaItem) {
     }
 
     private ExtractorsFactory getExtractorsFactory() {
-        if (extractorsFactory == null) extractorsFactory = new DefaultExtractorsFactory().setTsExtractorFlags(FLAG_DETECT_ACCESS_UNITS | FLAG_ENABLE_HDMV_DTS_AUDIO_STREAMS).setTsExtractorTimestampSearchBytes(TsExtractor.DEFAULT_TIMESTAMP_SEARCH_BYTES * 3);
+        if (extractorsFactory == null) extractorsFactory = new DefaultExtractorsFactory().setTsExtractorFlags(FLAG_ENABLE_HDMV_DTS_AUDIO_STREAMS).setTsExtractorTimestampSearchBytes(TsExtractor.DEFAULT_TIMESTAMP_SEARCH_BYTES * 3);
         return extractorsFactory;
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/exo/MediaSourceFactory.java
Patch:
@@ -1,6 +1,5 @@
 package com.fongmi.android.tv.player.exo;
 
-import static androidx.media3.extractor.ts.DefaultTsPayloadReaderFactory.FLAG_ALLOW_NON_IDR_KEYFRAMES;
 import static androidx.media3.extractor.ts.DefaultTsPayloadReaderFactory.FLAG_DETECT_ACCESS_UNITS;
 import static androidx.media3.extractor.ts.DefaultTsPayloadReaderFactory.FLAG_ENABLE_HDMV_DTS_AUDIO_STREAMS;
 
@@ -85,7 +84,7 @@ private MediaSource createConcatenatingMediaSource(MediaItem mediaItem) {
     }
 
     private ExtractorsFactory getExtractorsFactory() {
-        if (extractorsFactory == null) extractorsFactory = new DefaultExtractorsFactory().setTsExtractorFlags(FLAG_ALLOW_NON_IDR_KEYFRAMES | FLAG_DETECT_ACCESS_UNITS | FLAG_ENABLE_HDMV_DTS_AUDIO_STREAMS).setTsExtractorTimestampSearchBytes(TsExtractor.DEFAULT_TIMESTAMP_SEARCH_BYTES * 3);
+        if (extractorsFactory == null) extractorsFactory = new DefaultExtractorsFactory().setTsExtractorFlags(FLAG_DETECT_ACCESS_UNITS | FLAG_ENABLE_HDMV_DTS_AUDIO_STREAMS).setTsExtractorTimestampSearchBytes(TsExtractor.DEFAULT_TIMESTAMP_SEARCH_BYTES * 3);
         return extractorsFactory;
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/exo/MediaSourceFactory.java
Patch:
@@ -85,7 +85,7 @@ private MediaSource createConcatenatingMediaSource(MediaItem mediaItem) {
     }
 
     private ExtractorsFactory getExtractorsFactory() {
-        if (extractorsFactory == null) extractorsFactory = new DefaultExtractorsFactory().setTsExtractorFlags(FLAG_ALLOW_NON_IDR_KEYFRAMES & FLAG_DETECT_ACCESS_UNITS & FLAG_ENABLE_HDMV_DTS_AUDIO_STREAMS).setTsExtractorTimestampSearchBytes(TsExtractor.DEFAULT_TIMESTAMP_SEARCH_BYTES * 3);
+        if (extractorsFactory == null) extractorsFactory = new DefaultExtractorsFactory().setTsExtractorFlags(FLAG_ALLOW_NON_IDR_KEYFRAMES | FLAG_DETECT_ACCESS_UNITS | FLAG_ENABLE_HDMV_DTS_AUDIO_STREAMS).setTsExtractorTimestampSearchBytes(TsExtractor.DEFAULT_TIMESTAMP_SEARCH_BYTES * 3);
         return extractorsFactory;
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ParseJob.java
Patch:
@@ -211,7 +211,7 @@ public void onParseError() {
 
     private void stopWeb() {
         for (CustomWebView webView : webViews) webView.stop(false);
-        webViews.clear();
+        if (!webViews.isEmpty()) webViews.clear();
     }
 
     public void stop() {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -159,7 +159,6 @@ public void setPosition(long position) {
     public void reset() {
         position = C.TIME_UNSET;
         removeTimeoutCheck();
-        stopParse();
         retry = 0;
     }
 
@@ -316,6 +315,7 @@ public void pause() {
     }
 
     public void stop() {
+        if (parseJob != null) parseJob.stop();
         if (exoPlayer != null) exoPlayer.stop();
         if (exoPlayer != null) exoPlayer.clearMediaItems();
     }

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -292,6 +292,7 @@ private void headers(String line) {
         private void headers(String[] params) {
             if (header == null) header = new HashMap<>();
             for (String param : params) {
+                if (!param.contains("=")) continue;
                 String[] a = param.split("=");
                 header.put(a[0].trim(), a[1].trim().replace("\"", ""));
             }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -613,7 +613,6 @@ private void setInfo() {
         mBinding.widget.line.setText(mChannel.getLineText());
         mBinding.widget.number.setText(mChannel.getNumber());
         mBinding.widget.numberPip.setText(mChannel.getNumber());
-        mBinding.widget.name.setMaxEms(mChannel.getName().length());
         mBinding.widget.line.setVisibility(mChannel.getLineVisible());
         mBinding.control.action.line.setText(mBinding.widget.line.getText());
         mBinding.control.action.line.setVisibility(mBinding.widget.line.getVisibility());
@@ -993,12 +992,12 @@ public void onVolumeEnd() {
 
     @Override
     public void onFlingUp() {
-        if (mPlayers.isLive()) prevChannel();
+        prevChannel();
     }
 
     @Override
     public void onFlingDown() {
-        if (mPlayers.isLive()) nextChannel();
+        nextChannel();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/api/EpgParser.java
Patch:
@@ -68,7 +68,9 @@ private static void readXml(Live live, File file) throws Exception {
         for (Group group : live.getGroups()) for (Channel channel : group.getChannel()) exist.add(channel.getTvgName());
         for (Tv.Channel channel : tv.getChannel()) mapping.put(channel.getId(), channel.getDisplayName());
         for (Tv.Programme programme : tv.getProgramme()) {
-            String key = mapping.get(programme.getChannel());
+            String key = programme.getChannel();
+            String name = mapping.get(programme.getChannel());
+            if (!exist.contains(key) && exist.contains(name)) key = name;
             Date startDate = formatFull.parse(programme.getStart());
             Date endDate = formatFull.parse(programme.getStop());
             if (!exist.contains(key)) continue;

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -42,15 +42,15 @@ private static String extract(String line, Pattern pattern) {
     }
 
     public static void start(Live live) throws Exception {
-        if (live.getGroups().size() > 0) return;
+        if (!live.getGroups().isEmpty()) return;
         if (live.getType() == 0) text(live, getText(live));
         if (live.getType() == 1) json(live, getText(live));
         if (live.getType() == 3) spider(live, getText(live));
     }
 
     public static void text(Live live, String text) {
         int number = 0;
-        if (live.getGroups().size() > 0) return;
+        if (!live.getGroups().isEmpty()) return;
         if (M3U.matcher(text).find()) m3u(live, text);
         else if (live.isXtream()) xtream(live);
         else txt(live, text);
@@ -150,7 +150,7 @@ private static String getText(String url, Map<String, String> header) {
         if (url.startsWith("file")) return Path.read(url);
         if (url.startsWith("http")) return OkHttp.string(url, header);
         if (url.startsWith("assets") || url.startsWith("proxy")) return getText(UrlUtil.convert(url), header);
-        if (url.length() > 0 && url.length() % 4 == 0) return getText(new String(Base64.decode(url, Base64.DEFAULT)), header);
+        if (!url.isEmpty() && url.length() % 4 == 0) return getText(new String(Base64.decode(url, Base64.DEFAULT)), header);
         return "";
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -327,6 +327,7 @@ private void onCheck(ErrorEvent event) {
 
     private void onError(ErrorEvent event) {
         showError(event.getMsg());
+        mPlayers.resetTrack();
         onStopped();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -752,6 +752,7 @@ private void onCheck(ErrorEvent event) {
 
     private void onError(ErrorEvent event) {
         showError(event.getMsg());
+        mPlayers.resetTrack();
         mPlayers.reset();
         mPlayers.stop();
         startFlow();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1128,6 +1128,7 @@ private void onError(ErrorEvent event) {
         Track.delete(getHistoryKey());
         showError(event.getMsg());
         mClock.setCallback(null);
+        mPlayers.resetTrack();
         mPlayers.reset();
         mPlayers.stop();
         startFlow();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -805,6 +805,7 @@ private void onCheck(ErrorEvent event) {
 
     private void onError(ErrorEvent event) {
         showError(event.getMsg());
+        mPlayers.resetTrack();
         mPlayers.reset();
         mPlayers.stop();
         startFlow();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1163,6 +1163,7 @@ private void onError(ErrorEvent event) {
         Track.delete(getHistoryKey());
         showError(event.getMsg());
         mClock.setCallback(null);
+        mPlayers.resetTrack();
         mPlayers.reset();
         mPlayers.stop();
         startFlow();

File: chaquo/src/main/java/com/fongmi/chaquo/Spider.java
Patch:
@@ -34,8 +34,8 @@ public void init(Context context) {
 
     @Override
     public void init(Context context, String extend) {
-        List<PyObject> items = app.callAttr("getDependence", obj).asList();
-        for (PyObject item : items) download(item + ".py");
+        PyObject dependence = app.callAttr("getDependence", obj);
+        if (dependence != null) for (PyObject item : dependence.asList()) download(item + ".py");
         app.callAttr("init", obj, extend);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -398,7 +398,8 @@ public void onItemClick(Func item) {
 
     @Override
     public void onItemClick(Vod item) {
-        if (getHome().isIndex()) CollectActivity.start(getActivity(), item.getVodName());
+        if (item.isAction()) mViewModel.action(getHome().getKey(), item.getAction());
+        else if (getHome().isIndex()) CollectActivity.start(getActivity(), item.getVodName());
         else VideoActivity.start(this, item.getVodId(), item.getVodName(), item.getVodPic());
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -321,7 +321,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) mPlayers.init(mBinding.exo);
+        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) onDecode();
         else onError(event);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -746,7 +746,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) mPlayers.init(mBinding.exo);
+        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) onDecode();
         else onError(event);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1120,7 +1120,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) mPlayers.init(mBinding.exo);
+        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) onDecode();
         else onError(event);
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -799,7 +799,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) mPlayers.init(mBinding.exo);
+        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) onDecode();
         else onError(event);
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1154,7 +1154,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) mPlayers.init(mBinding.exo);
+        else if (event.getCode() == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) onDecode();
         else onError(event);
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Result.java
Patch:
@@ -118,6 +118,7 @@ public static Result empty() {
 
     public static Result error(String msg) {
         Result result = new Result();
+        result.setParse(0);
         result.setMsg(msg);
         return result;
     }

File: app/src/main/java/com/fongmi/android/tv/player/extractor/Youtube.java
Patch:
@@ -4,6 +4,7 @@
 import android.util.Base64;
 
 import com.fongmi.android.tv.bean.Episode;
+import com.fongmi.android.tv.exception.ExtractException;
 import com.fongmi.android.tv.player.Source;
 import com.github.catvod.net.OkHttp;
 import com.github.kiulian.downloader.YoutubeDownloader;
@@ -48,6 +49,7 @@ public String fetch(String url) throws Exception {
         String videoId = matcher.group();
         RequestVideoInfo request = new RequestVideoInfo(videoId);
         VideoInfo info = getDownloader().getVideoInfo(request).data();
+        if (info == null || info.details() == null) throw new ExtractException("");
         return info.details().isLive() ? info.details().liveUrl() : getMpdWithBase64(info);
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Channel.java
Patch:
@@ -325,8 +325,8 @@ public void live(Live live) {
         if (!live.getOrigin().isEmpty() && getOrigin().isEmpty()) setOrigin(live.getOrigin());
         if (!live.getCatchup().isEmpty() && getCatchup().isEmpty()) setCatchup(live.getCatchup());
         if (!live.getReferer().isEmpty() && getReferer().isEmpty()) setReferer(live.getReferer());
-        if (live.getEpg().contains("{") && !getEpg().isEmpty() && !getEpg().startsWith("http")) setEpg(live.getEpg().replace("{name}", getTvgName()).replace("{epg}", getEpg()));
-        if (live.getLogo().contains("{") && !getLogo().isEmpty() && !getLogo().startsWith("http")) setLogo(live.getLogo().replace("{name}", getTvgName()).replace("{logo}", getLogo()));
+        if (live.getEpg().contains("{") && !getEpg().startsWith("http")) setEpg(live.getEpg().replace("{name}", getTvgName()).replace("{epg}", getEpg()));
+        if (live.getLogo().contains("{") && !getLogo().startsWith("http")) setLogo(live.getLogo().replace("{name}", getTvgName()).replace("{logo}", getLogo()));
     }
 
     public void setLine(String line) {

File: app/src/main/java/com/fongmi/android/tv/ui/dialog/SubtitleDialog.java
Patch:
@@ -68,6 +68,7 @@ private void onSmall(View view) {
     }
 
     private void onReset(View view) {
+        Setting.putSubtitleTextSize(0);
         subtitleView.setUserDefaultTextSize();
         subtitleView.setBottomPaddingFraction(SubtitleView.DEFAULT_BOTTOM_PADDING_FRACTION);
     }

File: app/src/main/java/com/fongmi/android/tv/utils/Util.java
Patch:
@@ -68,7 +68,8 @@ public static float getBrightness(Activity activity) {
 
     public static CharSequence getClipText() {
         ClipboardManager manager = (ClipboardManager) App.get().getSystemService(Context.CLIPBOARD_SERVICE);
-        return manager.getText();
+        if (manager.getPrimaryClip() == null || manager.getPrimaryClip().getItemCount() == 0) return "";
+        return manager.getPrimaryClip().getItemAt(0).getText();
     }
 
     public static void copy(String text) {

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -194,8 +194,9 @@ public void playerContent(String key, String flag, String id) {
     public void action(String key, String action) {
         execute(this.action, () -> {
             Site site = VodConfig.get().getSite(key);
-            if (site.getType() != 3) return Result.empty();
-            return Result.fromJson(site.recent().spider().action(action));
+            if (site.getType() == 3) return Result.fromJson(site.recent().spider().action(action));
+            if (site.getType() == 4) return Result.fromJson(OkHttp.string(action));
+            return Result.empty();
         });
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -140,6 +140,7 @@ public Map<String, String> getHeaders() {
     }
 
     public void setSub(Sub sub) {
+        setPosition(getPosition());
         this.sub = sub;
         setMediaItem();
     }
@@ -373,7 +374,7 @@ private Map<String, String> checkUa(Map<String, String> headers) {
     }
 
     private List<Sub> checkSub(List<Sub> subs) {
-        if (sub == null) return subs;
+        if (sub == null || subs.contains(sub)) return subs;
         subs.add(0, sub);
         return subs;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -195,7 +195,7 @@ private void onChoose() {
     }
 
     private void onDecode() {
-        mPlayers.toggleDecode();
+        mPlayers.toggleDecode(mBinding.exo);
         setDecode();
         onReset();
     }
@@ -347,7 +347,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else mPlayers.toggleDecode();
+        else mPlayers.toggleDecode(mBinding.exo);
         mPlayers.setMediaItem();
         setDecode();
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -385,7 +385,7 @@ private void onChoose() {
     }
 
     private void onDecode() {
-        mPlayers.toggleDecode();
+        mPlayers.toggleDecode(mBinding.exo);
         setDecode();
         fetch();
     }
@@ -749,7 +749,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else mPlayers.toggleDecode();
+        else mPlayers.toggleDecode(mBinding.exo);
         mPlayers.setMediaItem();
         setDecode();
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -843,7 +843,7 @@ private void onChoose() {
     }
 
     private void onDecode() {
-        mPlayers.toggleDecode();
+        mPlayers.toggleDecode(mBinding.exo);
         setDecode();
         onRefresh();
     }
@@ -1143,7 +1143,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else mPlayers.toggleDecode();
+        else mPlayers.toggleDecode(mBinding.exo);
         mPlayers.setMediaItem();
         setDecode();
     }

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -277,8 +277,9 @@ public String toggleSpeed() {
         return setSpeed(speed);
     }
 
-    public void toggleDecode() {
+    public void toggleDecode(PlayerView exo) {
         Setting.putDecode(decode = isHard() ? SOFT : HARD);
+        init(exo);
     }
 
     public String getPositionTime(long time) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -416,7 +416,7 @@ private void onChange() {
     }
 
     private void onDecode() {
-        mPlayers.toggleDecode();
+        mPlayers.toggleDecode(mBinding.exo);
         setR1Callback();
         setDecode();
         fetch();
@@ -808,7 +808,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else mPlayers.toggleDecode();
+        else mPlayers.toggleDecode(mBinding.exo);
         mPlayers.setMediaItem();
         setDecode();
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -773,7 +773,7 @@ private boolean onResetToggle() {
     }
 
     private void onDecode() {
-        mPlayers.toggleDecode();
+        mPlayers.toggleDecode(mBinding.exo);
         setR1Callback();
         setDecode();
         onRefresh();
@@ -1163,7 +1163,7 @@ public void onErrorEvent(ErrorEvent event) {
     private void onCheck(ErrorEvent event) {
         if (event.getCode() == PlaybackException.ERROR_CODE_IO_UNSPECIFIED || event.getCode() >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && event.getCode() <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) mPlayers.setFormat(ExoUtil.getMimeType(event.getCode()));
         else if (event.getCode() == PlaybackException.ERROR_CODE_BEHIND_LIVE_WINDOW) mPlayers.seekTo(C.TIME_UNSET);
-        else mPlayers.toggleDecode();
+        else mPlayers.toggleDecode(mBinding.exo);
         mPlayers.setMediaItem();
         setDecode();
     }

File: app/src/main/java/com/fongmi/android/tv/player/ParseJob.java
Patch:
@@ -171,7 +171,8 @@ private void checkResult(Result result) {
     private boolean isPass(Map<String, String> headers, String url) {
         try {
             if (url.length() < 40) return false;
-            return OkHttp.newCall(url, Headers.of(headers)).execute().code() == 200;
+            int code = OkHttp.newCall(url, Headers.of(headers)).execute().code();
+            return code == 200 || code == 302;
         } catch (Exception e) {
             return false;
         }
@@ -197,7 +198,7 @@ private void startWeb(String key, String from, Map<String, String> headers, Stri
 
     private Map<String, String> getHeader(JsonObject object) {
         Map<String, String> headers = new HashMap<>();
-        for (Map.Entry<String, JsonElement> entry : object.entrySet()) if (entry.getKey().equalsIgnoreCase(HttpHeaders.USER_AGENT) || entry.getKey().equalsIgnoreCase(HttpHeaders.REFERER) || entry.getKey().equalsIgnoreCase("ua")) headers.put(UrlUtil.fixHeader(entry.getKey()), object.get(entry.getKey()).getAsString());
+        for (Map.Entry<String, JsonElement> entry : object.entrySet()) if (!entry.getValue().isJsonNull() && (entry.getKey().equalsIgnoreCase(HttpHeaders.USER_AGENT) || entry.getKey().equalsIgnoreCase(HttpHeaders.REFERER) || entry.getKey().equalsIgnoreCase("ua"))) headers.put(UrlUtil.fixHeader(entry.getKey()), entry.getValue().getAsString());
         if (headers.isEmpty()) return parse.getHeaders();
         return headers;
     }

File: app/src/main/java/com/fongmi/android/tv/event/ErrorEvent.java
Patch:
@@ -53,8 +53,8 @@ public int getCode() {
         return code;
     }
 
-    public boolean isDecode() {
-        return code / 1000 == 4;
+    public boolean isExo() {
+        return code / 1000 == 3 || code / 1000 == 4;
     }
 
     public String getMsg() {

File: app/src/main/java/com/fongmi/android/tv/player/exo/ExoUtil.java
Patch:
@@ -89,16 +89,15 @@ public static String getMimeType(String path) {
         return MimeTypes.APPLICATION_SUBRIP;
     }
 
-    public static String getMimeType(String format, int errorCode) {
-        if (format != null) return format;
+    public static String getMimeType(int errorCode) {
         if (errorCode == PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED || errorCode == PlaybackException.ERROR_CODE_PARSING_MANIFEST_MALFORMED) return MimeTypes.APPLICATION_OCTET;
         if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED || errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED || errorCode == PlaybackException.ERROR_CODE_IO_UNSPECIFIED) return MimeTypes.APPLICATION_M3U8;
         return null;
     }
 
     public static int getRetry(int errorCode) {
         if (errorCode == PlaybackException.ERROR_CODE_IO_UNSPECIFIED) return 2;
-        if (errorCode == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) return 1;
+        if (errorCode == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) return 2;
         if (errorCode >= PlaybackException.ERROR_CODE_DECODER_QUERY_FAILED && errorCode <= PlaybackException.ERROR_CODE_DECODING_FORMAT_UNSUPPORTED) return 2;
         if (errorCode >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && errorCode <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) return 2;
         return 1;

File: app/src/main/java/com/fongmi/android/tv/player/exo/ExoUtil.java
Patch:
@@ -98,7 +98,8 @@ public static String getMimeType(String format, int errorCode) {
 
     public static int getRetry(int errorCode) {
         if (errorCode == PlaybackException.ERROR_CODE_IO_UNSPECIFIED) return 2;
-        if (errorCode >= PlaybackException.ERROR_CODE_DECODER_INIT_FAILED && errorCode <= PlaybackException.ERROR_CODE_DECODING_FORMAT_UNSUPPORTED) return 2;
+        if (errorCode == PlaybackException.ERROR_CODE_DECODER_INIT_FAILED) return 1;
+        if (errorCode >= PlaybackException.ERROR_CODE_DECODER_QUERY_FAILED && errorCode <= PlaybackException.ERROR_CODE_DECODING_FORMAT_UNSUPPORTED) return 2;
         if (errorCode >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && errorCode <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED) return 2;
         return 1;
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/InfoDialog.java
Patch:
@@ -64,7 +64,7 @@ private void initView() {
         binding.title.setText(title);
         binding.url.setText(fixUrl());
         binding.header.setText(header);
-        binding.title.setSingleLine(title.equals(url));
+        binding.title.setSingleLine(title.toString().contains(url));
         binding.url.setVisibility(TextUtils.isEmpty(url) ? View.GONE : View.VISIBLE);
         binding.header.setVisibility(TextUtils.isEmpty(header) ? View.GONE : View.VISIBLE);
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/InfoDialog.java
Patch:
@@ -64,6 +64,7 @@ private void initView() {
         binding.title.setText(title);
         binding.url.setText(fixUrl());
         binding.header.setText(header);
+        binding.title.setSingleLine(title.equals(url));
         binding.url.setVisibility(TextUtils.isEmpty(url) ? View.GONE : View.VISIBLE);
         binding.header.setVisibility(TextUtils.isEmpty(header) ? View.GONE : View.VISIBLE);
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -333,7 +333,7 @@ private void setTrackVisible(boolean visible) {
     }
 
     private void setMetadata() {
-        mPlayers.setMetadata(mBinding.widget.title.getText().toString(), "", "");
+        mPlayers.setMetadata(mBinding.widget.title.getText().toString(), "", "", mBinding.exo.getDefaultArtwork());
     }
 
     @Subscribe(threadMode = ThreadMode.MAIN)

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -721,7 +721,7 @@ private void setTrackVisible(boolean visible) {
     private void setMetadata() {
         String title = mBinding.widget.name.getText().toString();
         String artist = mBinding.widget.play.getText().toString();
-        mPlayers.setMetadata(title, artist, mChannel.getLogo());
+        mPlayers.setMetadata(title, artist, mChannel.getLogo(), mBinding.exo.getDefaultArtwork());
     }
 
     @Subscribe(threadMode = ThreadMode.MAIN)

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1128,7 +1128,7 @@ private void setMetadata() {
         String title = mHistory.getVodName();
         String episode = getEpisode().getName();
         String artist = title.equals(episode) ? "" : getString(R.string.play_now, episode);
-        mPlayers.setMetadata(title, artist, mHistory.getVodPic());
+        mPlayers.setMetadata(title, artist, mHistory.getVodPic(), mBinding.exo.getDefaultArtwork());
     }
 
     @Subscribe(threadMode = ThreadMode.MAIN)

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -780,7 +780,7 @@ private void setTrackVisible(boolean visible) {
     private void setMetadata() {
         String title = mBinding.widget.name.getText().toString();
         String artist = mBinding.widget.play.getText().toString();
-        mPlayers.setMetadata(title, artist, mChannel.getLogo());
+        mPlayers.setMetadata(title, artist, mChannel.getLogo(), mBinding.exo.getDefaultArtwork());
     }
 
     @Subscribe(threadMode = ThreadMode.MAIN)

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1147,7 +1147,7 @@ private void setMetadata() {
         String title = mHistory.getVodName();
         String episode = getEpisode().getName();
         String artist = title.equals(episode) ? "" : getString(R.string.play_now, episode);
-        mPlayers.setMetadata(title, artist, mHistory.getVodPic());
+        mPlayers.setMetadata(title, artist, mHistory.getVodPic(), mBinding.exo.getDefaultArtwork());
     }
 
     @Subscribe(threadMode = ThreadMode.MAIN)

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -146,8 +146,8 @@ public void setPosition(long position) {
         this.position = position;
     }
 
-    public int addCount() {
-        return ++count;
+    public boolean canToggle() {
+        return ++count <= 2;
     }
 
     public void reset() {
@@ -193,7 +193,7 @@ public long getBuffered() {
         return exoPlayer == null ? 0 : exoPlayer.getBufferedPosition();
     }
 
-    public boolean error() {
+    public boolean retried() {
         return ++retry > ExoUtil.getRetry(error);
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -278,7 +278,6 @@ public String toggleSpeed() {
     public void toggleDecode(PlayerView exo) {
         Setting.putDecode(decode = isHard() ? SOFT : HARD);
         setup(exo);
-        reset();
     }
 
     public String getPositionTime(long time) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -343,7 +343,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (mPlayers.isHard() && event.getCode() / 1000 == 4) {
+        if (event.getCode() / 1000 == 4 && mPlayers.addCount() <= 2) {
             onDecode();
         } else {
             onError(event);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -731,7 +731,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (mPlayers.isHard() && event.getCode() / 1000 == 4) {
+        if (event.getCode() / 1000 == 4 && mPlayers.addCount() <= 2) {
             onDecode();
         } else {
             onError(event);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1136,7 +1136,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (mPlayers.isHard() && event.getCode() / 1000 == 4) {
+        if (event.getCode() / 1000 == 4 && mPlayers.addCount() <= 2) {
             onDecode();
         } else {
             onError(event);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -790,7 +790,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (mPlayers.isHard() && event.getCode() / 1000 == 4) {
+        if (event.getCode() / 1000 == 4 && mPlayers.addCount() <= 2) {
             onDecode();
         } else {
             onError(event);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1159,7 +1159,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (mPlayers.isHard() && event.getCode() / 1000 == 4) {
+        if (event.getCode() / 1000 == 4 && mPlayers.addCount() <= 2) {
             onDecode();
         } else {
             onError(event);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -1065,8 +1065,8 @@ public void onPictureInPictureModeChanged(boolean isInPictureInPictureMode) {
             hideUI();
         } else {
             hideInfo();
+            stopService();
             setForeground(true);
-            PlaybackService.stop();
             setSubtitle(Setting.getSubtitle());
             if (isStop()) finish();
         }
@@ -1138,9 +1138,9 @@ public void onBackPressed() {
     @Override
     protected void onDestroy() {
         super.onDestroy();
+        stopService();
         mClock.release();
         mPlayers.release();
-        PlaybackService.stop();
         App.removeCallbacks(mR0, mR1, mR2, mR3);
         mViewModel.url.removeObserver(mObserveUrl);
         mViewModel.epg.removeObserver(mObserveEpg);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1506,8 +1506,8 @@ public void onPictureInPictureModeChanged(boolean isInPictureInPictureMode) {
             hideControl();
             hideSheet();
         } else {
+            stopService();
             setForeground(true);
-            PlaybackService.stop();
             setSubtitle(Setting.getSubtitle());
             if (isStop()) finish();
         }
@@ -1579,6 +1579,7 @@ public void onBackPressed() {
     protected void onDestroy() {
         super.onDestroy();
         stopSearch();
+        stopService();
         mClock.release();
         mPlayers.release();
         Timer.get().reset();

File: youtube/src/main/java/com/github/kiulian/downloader/parser/ParserImpl.java
Patch:
@@ -424,11 +424,11 @@ private void loadPlaylistContinuation(String continuation, String ctp, List<Play
         }
         String html = response.data();
         try {
-            JsonObject content;
+            JsonObject content = new JsonObject();
             JsonObject jsonResponse = JsonParser.parseString(html).getAsJsonObject();
             if (jsonResponse.has("continuationContents")) {
                 content = jsonResponse.getAsJsonObject("continuationContents").getAsJsonObject("playlistVideoListContinuation");
-            } else {
+            } else if (jsonResponse.has("onResponseReceivedActions")) {
                 content = jsonResponse.getAsJsonArray("onResponseReceivedActions").get(0).getAsJsonObject().getAsJsonObject("appendContinuationItemsAction");
             }
             populatePlaylist(content, videos, clientVersion);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -542,6 +542,7 @@ private void setPlayer(Result result) {
 
     private void setFlagActivated(Flag item) {
         if (mFlagAdapter.size() == 0 || item.isActivated()) return;
+        if (mFlagAdapter.indexOf(item) == -1) item.setFlag(((Flag) mFlagAdapter.get(0)).getFlag());
         for (int i = 0; i < mFlagAdapter.size(); i++) ((Flag) mFlagAdapter.get(i)).setActivated(item);
         mBinding.flag.setSelectedPosition(mFlagAdapter.indexOf(item));
         notifyItemChanged(mBinding.flag, mFlagAdapter);

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/FlagAdapter.java
Patch:
@@ -49,6 +49,7 @@ public Flag getActivated() {
     }
 
     public void setActivated(Flag flag) {
+        if (!mItems.contains(flag)) flag.setFlag(mItems.get(0).getFlag());
         for (Flag item : mItems) item.setActivated(flag);
         notifyItemRangeChanged(0, getItemCount());
     }

File: catvod/src/main/java/com/github/catvod/utils/Trans.java
Patch:
@@ -33,7 +33,7 @@ private void init() {
         char[] UTF8T = "萬與醜專業叢東絲丟兩嚴喪個爿豐臨為麗舉麼義烏樂喬習鄉書買亂爭於虧雲亙亞產畝親褻嚲億僅從侖倉儀們價眾優夥會傴傘偉傳傷倀倫傖偽佇體餘傭僉俠侶僥偵側僑儈儕儂俁儔儼倆儷儉債傾傯僂僨償儻儐儲儺兒兌兗黨蘭關興茲養獸囅內岡冊寫軍農塚馮衝決況凍淨淒涼淩減湊凜幾鳳鳧憑凱擊氹鑿芻劃劉則剛創刪別剗剄劊劌剴劑剮劍剝劇勸辦務勱動勵勁勞勢勳猛勩勻匭匱區醫華協單賣盧鹵臥衛卻巹廠廳歷厲壓厭厙廁廂厴廈廚廄廝縣參靉靆雙發變敘疊葉號歎嘰籲後嚇呂嗎唚噸聽啟吳嘸囈嘔嚦唄員咼嗆嗚詠哢嚨嚀噝吒噅鹹呱響啞噠嘵嗶噦嘩噲嚌噥喲嘜嗊嘮啢嗩唕喚呼嘖嗇囀齧囉嘽嘯噴嘍嚳囁嗬噯噓嚶囑嚕劈囂謔團園囪圍圇國圖圓聖壙場阪壞塊堅壇壢壩塢墳墜壟壟壚壘墾坰堊墊埡墶壋塏堖塒塤堝墊垵塹墮壪牆壯聲殼壺壼處備復夠頭誇夾奪奩奐奮獎奧妝婦媽嫵嫗媯姍婁婭嬈嬌孌娛媧嫻嫿嬰嬋嬸媼嬡嬪嬙嬤孫學孿寧寶實寵審憲宮寬賓寢對尋導壽將爾塵堯尷屍盡層屭屜屆屬屢屨嶼歲豈嶇崗峴嶴嵐島嶺崠巋嶨嶧峽嶢嶠崢巒嶗崍嶮嶄嶸嶔崳嶁脊巔鞏巰幣帥師幃帳簾幟帶幀幫幬幘幗冪襆幹並廣莊慶廬廡庫應廟龐廢廎廩開異棄張彌弳彎彈強歸當錄彠彥徹徑徠禦憶懺憂愾懷態慫憮慪悵愴憐總懟懌戀懇惡慟懨愷惻惱惲悅愨懸慳憫驚懼慘懲憊愜慚憚慣湣慍憤憒願懾憖怵懣懶懍戇戔戲戧戰戩戶紮撲扡執擴捫掃揚擾撫拋摶摳掄搶護報擔擬攏揀擁攔擰撥擇掛摯攣掗撾撻挾撓擋撟掙擠揮撏撈損撿換搗據撚擄摑擲撣摻摜摣攬撳攙擱摟攪攜攝攄擺搖擯攤攖撐攆擷擼攛擻攢敵斂數齋斕斗斬斷無舊時曠暘曇晝曨顯晉曬曉曄暈暉暫曖劄術樸機殺雜權條來楊榪傑極構樅樞棗櫪梘棖槍楓梟櫃檸檉梔柵標棧櫛櫳棟櫨櫟欄樹棲樣欒棬椏橈楨檔榿橋樺檜槳樁夢檮棶檢欞槨櫝槧欏橢樓欖櫬櫚櫸檟檻檳櫧橫檣櫻櫫櫥櫓櫞簷檁歡歟歐殲歿殤殘殞殮殫殯毆毀轂畢斃氈毿氌氣氫氬氳彙漢汙湯洶遝溝沒灃漚瀝淪滄渢溈滬濔濘淚澩瀧瀘濼瀉潑澤涇潔灑窪浹淺漿澆湞溮濁測澮濟瀏滻渾滸濃潯濜塗湧濤澇淶漣潿渦溳渙滌潤澗漲澀澱淵淥漬瀆漸澠漁瀋滲溫遊灣濕潰濺漵漊潷滾滯灩灄滿瀅濾濫灤濱灘澦瀠瀟瀲濰潛瀦瀾瀨瀕灝滅燈靈災燦煬爐燉煒熗點煉熾爍爛烴燭煙煩燒燁燴燙燼熱煥燜燾煆糊溜愛爺牘犛牽犧犢強狀獷獁猶狽麅獮獰獨狹獅獪猙獄猻獫獵獼玀豬貓蝟獻獺璣璵瑒瑪瑋環現瑲璽瑉玨琺瓏璫琿璡璉瑣瓊瑤璦璿瓔瓚甕甌電畫暢佘疇癤療瘧癘瘍鬁瘡瘋皰屙癰痙癢瘂癆瘓癇癡癉瘮瘞瘺癟癱癮癭癩癬癲臒皚皺皸盞鹽監蓋盜盤瞘眥矓著睜睞瞼瞞矚矯磯礬礦碭碼磚硨硯碸礪礱礫礎硜矽碩硤磽磑礄確鹼礙磧磣堿镟滾禮禕禰禎禱禍稟祿禪離禿稈種積稱穢穠穭稅穌穩穡窮竊竅窯竄窩窺竇窶豎競篤筍筆筧箋籠籩築篳篩簹箏籌簽簡籙簀篋籜籮簞簫簣簍籃籬籪籟糴類秈糶糲粵糞糧糝餱緊縶糸糾紆紅紂纖紇約級紈纊紀紉緯紜紘純紕紗綱納紝縱綸紛紙紋紡紵紖紐紓線紺絏紱練組紳細織終縐絆紼絀紹繹經紿綁絨結絝繞絰絎繪給絢絳絡絕絞統綆綃絹繡綌綏絛繼綈績緒綾緓續綺緋綽緔緄繩維綿綬繃綢綯綹綣綜綻綰綠綴緇緙緗緘緬纜緹緲緝縕繢緦綞緞緶線緱縋緩締縷編緡緣縉縛縟縝縫縗縞纏縭縊縑繽縹縵縲纓縮繆繅纈繚繕繒韁繾繰繯繳纘罌網羅罰罷羆羈羥羨翹翽翬耮耬聳恥聶聾職聹聯聵聰肅腸膚膁腎腫脹脅膽勝朧腖臚脛膠脈膾髒臍腦膿臠腳脫腡臉臘醃膕齶膩靦膃騰臏臢輿艤艦艙艫艱豔艸藝節羋薌蕪蘆蓯葦藶莧萇蒼苧蘇檾蘋莖蘢蔦塋煢繭荊薦薘莢蕘蓽蕎薈薺蕩榮葷滎犖熒蕁藎蓀蔭蕒葒葤藥蒞蓧萊蓮蒔萵薟獲蕕瑩鶯蓴蘀蘿螢營縈蕭薩蔥蕆蕢蔣蔞藍薊蘺蕷鎣驀薔蘞藺藹蘄蘊藪槁蘚虜慮虛蟲虯蟣雖蝦蠆蝕蟻螞蠶蠔蜆蠱蠣蟶蠻蟄蛺蟯螄蠐蛻蝸蠟蠅蟈蟬蠍螻蠑螿蟎蠨釁銜補襯袞襖嫋褘襪襲襏裝襠褌褳襝褲襇褸襤繈襴見觀覎規覓視覘覽覺覬覡覿覥覦覯覲覷觴觸觶讋譽謄訁計訂訃認譏訐訌討讓訕訖訓議訊記訒講諱謳詎訝訥許訛論訩訟諷設訪訣證詁訶評詛識詗詐訴診詆謅詞詘詔詖譯詒誆誄試詿詩詰詼誠誅詵話誕詬詮詭詢詣諍該詳詫諢詡譸誡誣語誚誤誥誘誨誑說誦誒請諸諏諾讀諑誹課諉諛誰諗調諂諒諄誶談誼謀諶諜謊諫諧謔謁謂諤諭諼讒諮諳諺諦謎諞諝謨讜謖謝謠謗諡謙謐謹謾謫譾謬譚譖譙讕譜譎讞譴譫讖穀豶貝貞負貟貢財責賢敗賬貨質販貪貧貶購貯貫貳賤賁貰貼貴貺貸貿費賀貽賊贄賈賄貲賃賂贓資賅贐賕賑賚賒賦賭齎贖賞賜贔賙賡賠賧賴賵贅賻賺賽賾贗讚贇贈贍贏贛赬趙趕趨趲躉躍蹌蹠躒踐躂蹺蹕躚躋踴躊蹤躓躑躡蹣躕躥躪躦軀車軋軌軒軑軔轉軛輪軟轟軲軻轤軸軹軼軤軫轢軺輕軾載輊轎輈輇輅較輒輔輛輦輩輝輥輞輬輟輜輳輻輯轀輸轡轅轄輾轆轍轔辭辯辮邊遼達遷過邁運還這進遠違連遲邇逕跡適選遜遞邐邏遺遙鄧鄺鄔郵鄒鄴鄰鬱郤郟鄶鄭鄆酈鄖鄲醞醱醬釅釃釀釋里钜鑒鑾鏨釓釔針釘釗釙釕釷釺釧釤鈒釩釣鍆釹鍚釵鈃鈣鈈鈦鈍鈔鍾鈉鋇鋼鈑鈐鑰欽鈞鎢鉤鈧鈁鈥鈄鈕鈀鈺錢鉦鉗鈷缽鈳鉕鈽鈸鉞鑽鉬鉭鉀鈿鈾鐵鉑鈴鑠鉛鉚鈰鉉鉈鉍鈹鐸鉶銬銠鉺銪鋏鋣鐃銍鐺銅鋁銱銦鎧鍘銖銑鋌銩銛鏵銓鉿銚鉻銘錚銫鉸銥鏟銃鐋銨銀銣鑄鐒鋪鋙錸鋱鏈鏗銷鎖鋰鋥鋤鍋鋯鋨鏽銼鋝鋒鋅鋶鐦鐧銳銻鋃鋟鋦錒錆鍺錯錨錡錁錕錩錫錮鑼錘錐錦鍁錈錇錟錠鍵鋸錳錙鍥鍈鍇鏘鍶鍔鍤鍬鍾鍛鎪鍠鍰鎄鍍鎂鏤鎡鏌鎮鎛鎘鑷鐫鎳鎿鎦鎬鎊鎰鎔鏢鏜鏍鏰鏞鏡鏑鏃鏇鏐鐔钁鐐鏷鑥鐓鑭鐠鑹鏹鐙鑊鐳鐶鐲鐮鐿鑔鑣鑞鑲長門閂閃閆閈閉問闖閏闈閑閎間閔閌悶閘鬧閨聞闥閩閭闓閥閣閡閫鬮閱閬闍閾閹閶鬩閿閽閻閼闡闌闃闠闊闋闔闐闒闕闞闤隊陽陰陣階際陸隴陳陘陝隉隕險隨隱隸雋難雛讎靂霧霽黴靄靚靜靨韃鞽韉韝韋韌韍韓韙韞韜韻頁頂頃頇項順須頊頑顧頓頎頒頌頏預顱領頗頸頡頰頲頜潁熲頦頤頻頮頹頷頴穎顆題顒顎顓顏額顳顢顛顙顥纇顫顬顰顴風颺颭颮颯颶颸颼颻飀飄飆飆飛饗饜飣饑飥餳飩餼飪飫飭飯飲餞飾飽飼飿飴餌饒餉餄餎餃餏餅餑餖餓餘餒餕餜餛餡館餷饋餶餿饞饁饃餺餾饈饉饅饊饌饢馬馭馱馴馳驅馹駁驢駔駛駟駙駒騶駐駝駑駕驛駘驍罵駰驕驊駱駭駢驫驪騁驗騂駸駿騏騎騍騅騌驌驂騙騭騤騷騖驁騮騫騸驃騾驄驏驟驥驦驤髏髖髕鬢魘魎魚魛魢魷魨魯魴魺鮁鮃鯰鱸鮋鮓鮒鮊鮑鱟鮍鮐鮭鮚鮳鮪鮞鮦鰂鮜鱠鱭鮫鮮鮺鯗鱘鯁鱺鰱鰹鯉鰣鰷鯀鯊鯇鮶鯽鯒鯖鯪鯕鯫鯡鯤鯧鯝鯢鯰鯛鯨鯵鯴鯔鱝鰈鰏鱨鯷鰮鰃鰓鱷鰍鰒鰉鰁鱂鯿鰠鼇鰭鰨鰥鰩鰟鰜鰳鰾鱈鱉鰻鰵鱅鰼鱖鱔鱗鱒鱯鱤鱧鱣鳥鳩雞鳶鳴鳲鷗鴉鶬鴇鴆鴣鶇鸕鴨鴞鴦鴒鴟鴝鴛鴬鴕鷥鷙鴯鴰鵂鴴鵃鴿鸞鴻鵐鵓鸝鵑鵠鵝鵒鷳鵜鵡鵲鶓鵪鶤鵯鵬鵮鶉鶊鵷鷫鶘鶡鶚鶻鶿鶥鶩鷊鷂鶲鶹鶺鷁鶼鶴鷖鸚鷓鷚鷯鷦鷲鷸鷺鸇鷹鸌鸏鸛鸘鹺麥麩黃黌黶黷黲黽黿鼂鼉鞀鼴齇齊齏齒齔齕齗齟齡齙齠齜齦齬齪齲齷龍龔龕龜誌制谘範鬆冇嚐嘗鬨準鐘彆閒乾儘臟拚作".toCharArray();
         char[] UTF8S = "万与丑专业丛东丝丢两严丧个丬丰临为丽举么义乌乐乔习乡书买乱争于亏云亘亚产亩亲亵亸亿仅从仑仓仪们价众优伙会伛伞伟传伤伥伦伧伪伫体余佣佥侠侣侥侦侧侨侩侪侬俣俦俨俩俪俭债倾偬偻偾偿傥傧储傩儿兑兖党兰关兴兹养兽冁内冈册写军农冢冯冲决况冻净凄凉凌减凑凛几凤凫凭凯击凼凿刍划刘则刚创删别刬刭刽刿剀剂剐剑剥剧劝办务劢动励劲劳势勋勐勚匀匦匮区医华协单卖卢卤卧卫却卺厂厅历厉压厌厍厕厢厣厦厨厩厮县参叆叇双发变叙叠叶号叹叽吁后吓吕吗吣吨听启吴呒呓呕呖呗员呙呛呜咏咔咙咛咝咤咴咸哌响哑哒哓哔哕哗哙哜哝哟唛唝唠唡唢唣唤唿啧啬啭啮啰啴啸喷喽喾嗫呵嗳嘘嘤嘱噜噼嚣嚯团园囱围囵国图圆圣圹场坂坏块坚坛坜坝坞坟坠垄垅垆垒垦垧垩垫垭垯垱垲垴埘埙埚埝埯堑堕塆墙壮声壳壶壸处备复够头夸夹夺奁奂奋奖奥妆妇妈妩妪妫姗娄娅娆娇娈娱娲娴婳婴婵婶媪嫒嫔嫱嬷孙学孪宁宝实宠审宪宫宽宾寝对寻导寿将尔尘尧尴尸尽层屃屉届属屡屦屿岁岂岖岗岘岙岚岛岭岽岿峃峄峡峣峤峥峦崂崃崄崭嵘嵚嵛嵝嵴巅巩巯币帅师帏帐帘帜带帧帮帱帻帼幂幞干并广庄庆庐庑库应庙庞废庼廪开异弃张弥弪弯弹强归当录彟彦彻径徕御忆忏忧忾怀态怂怃怄怅怆怜总怼怿恋恳恶恸恹恺恻恼恽悦悫悬悭悯惊惧惨惩惫惬惭惮惯愍愠愤愦愿慑慭憷懑懒懔戆戋戏戗战戬户扎扑扦执扩扪扫扬扰抚抛抟抠抡抢护报担拟拢拣拥拦拧拨择挂挚挛挜挝挞挟挠挡挢挣挤挥挦捞损捡换捣据捻掳掴掷掸掺掼揸揽揿搀搁搂搅携摄摅摆摇摈摊撄撑撵撷撸撺擞攒敌敛数斋斓斗斩断无旧时旷旸昙昼昽显晋晒晓晔晕晖暂暧札术朴机杀杂权条来杨杩杰极构枞枢枣枥枧枨枪枫枭柜柠柽栀栅标栈栉栊栋栌栎栏树栖样栾桊桠桡桢档桤桥桦桧桨桩梦梼梾检棂椁椟椠椤椭楼榄榇榈榉槚槛槟槠横樯樱橥橱橹橼檐檩欢欤欧歼殁殇残殒殓殚殡殴毁毂毕毙毡毵氇气氢氩氲汇汉污汤汹沓沟没沣沤沥沦沧沨沩沪沵泞泪泶泷泸泺泻泼泽泾洁洒洼浃浅浆浇浈浉浊测浍济浏浐浑浒浓浔浕涂涌涛涝涞涟涠涡涢涣涤润涧涨涩淀渊渌渍渎渐渑渔渖渗温游湾湿溃溅溆溇滗滚滞滟滠满滢滤滥滦滨滩滪潆潇潋潍潜潴澜濑濒灏灭灯灵灾灿炀炉炖炜炝点炼炽烁烂烃烛烟烦烧烨烩烫烬热焕焖焘煅煳熘爱爷牍牦牵牺犊强状犷犸犹狈狍狝狞独狭狮狯狰狱狲猃猎猕猡猪猫猬献獭玑玙玚玛玮环现玱玺珉珏珐珑珰珲琎琏琐琼瑶瑷璇璎瓒瓮瓯电画畅畲畴疖疗疟疠疡疬疮疯疱疴痈痉痒痖痨痪痫痴瘅瘆瘗瘘瘪瘫瘾瘿癞癣癫癯皑皱皲盏盐监盖盗盘眍眦眬着睁睐睑瞒瞩矫矶矾矿砀码砖砗砚砜砺砻砾础硁硅硕硖硗硙硚确硷碍碛碜碱碹磙礼祎祢祯祷祸禀禄禅离秃秆种积称秽秾稆税稣稳穑穷窃窍窑窜窝窥窦窭竖竞笃笋笔笕笺笼笾筑筚筛筜筝筹签简箓箦箧箨箩箪箫篑篓篮篱簖籁籴类籼粜粝粤粪粮糁糇紧絷纟纠纡红纣纤纥约级纨纩纪纫纬纭纮纯纰纱纲纳纴纵纶纷纸纹纺纻纼纽纾线绀绁绂练组绅细织终绉绊绋绌绍绎经绐绑绒结绔绕绖绗绘给绚绛络绝绞统绠绡绢绣绤绥绦继绨绩绪绫绬续绮绯绰绱绲绳维绵绶绷绸绹绺绻综绽绾绿缀缁缂缃缄缅缆缇缈缉缊缋缌缍缎缏缐缑缒缓缔缕编缗缘缙缚缛缜缝缞缟缠缡缢缣缤缥缦缧缨缩缪缫缬缭缮缯缰缱缲缳缴缵罂网罗罚罢罴羁羟羡翘翙翚耢耧耸耻聂聋职聍联聩聪肃肠肤肷肾肿胀胁胆胜胧胨胪胫胶脉脍脏脐脑脓脔脚脱脶脸腊腌腘腭腻腼腽腾膑臜舆舣舰舱舻艰艳艹艺节芈芗芜芦苁苇苈苋苌苍苎苏苘苹茎茏茑茔茕茧荆荐荙荚荛荜荞荟荠荡荣荤荥荦荧荨荩荪荫荬荭荮药莅莜莱莲莳莴莶获莸莹莺莼萚萝萤营萦萧萨葱蒇蒉蒋蒌蓝蓟蓠蓣蓥蓦蔷蔹蔺蔼蕲蕴薮藁藓虏虑虚虫虬虮虽虾虿蚀蚁蚂蚕蚝蚬蛊蛎蛏蛮蛰蛱蛲蛳蛴蜕蜗蜡蝇蝈蝉蝎蝼蝾螀螨蟏衅衔补衬衮袄袅袆袜袭袯装裆裈裢裣裤裥褛褴襁襕见观觃规觅视觇览觉觊觋觌觍觎觏觐觑觞触觯詟誉誊讠计订讣认讥讦讧讨让讪讫训议讯记讱讲讳讴讵讶讷许讹论讻讼讽设访诀证诂诃评诅识诇诈诉诊诋诌词诎诏诐译诒诓诔试诖诗诘诙诚诛诜话诞诟诠诡询诣诤该详诧诨诩诪诫诬语诮误诰诱诲诳说诵诶请诸诹诺读诼诽课诿谀谁谂调谄谅谆谇谈谊谋谌谍谎谏谐谑谒谓谔谕谖谗谘谙谚谛谜谝谞谟谠谡谢谣谤谥谦谧谨谩谪谫谬谭谮谯谰谱谲谳谴谵谶谷豮贝贞负贠贡财责贤败账货质贩贪贫贬购贮贯贰贱贲贳贴贵贶贷贸费贺贻贼贽贾贿赀赁赂赃资赅赆赇赈赉赊赋赌赍赎赏赐赑赒赓赔赕赖赗赘赙赚赛赜赝赞赟赠赡赢赣赪赵赶趋趱趸跃跄跖跞践跶跷跸跹跻踊踌踪踬踯蹑蹒蹰蹿躏躜躯车轧轨轩轪轫转轭轮软轰轱轲轳轴轵轶轷轸轹轺轻轼载轾轿辀辁辂较辄辅辆辇辈辉辊辋辌辍辎辏辐辑辒输辔辕辖辗辘辙辚辞辩辫边辽达迁过迈运还这进远违连迟迩迳迹适选逊递逦逻遗遥邓邝邬邮邹邺邻郁郄郏郐郑郓郦郧郸酝酦酱酽酾酿释里鉅鉴銮錾钆钇针钉钊钋钌钍钎钏钐钑钒钓钔钕钖钗钘钙钚钛钝钞钟钠钡钢钣钤钥钦钧钨钩钪钫钬钭钮钯钰钱钲钳钴钵钶钷钸钹钺钻钼钽钾钿铀铁铂铃铄铅铆铈铉铊铋铍铎铏铐铑铒铕铗铘铙铚铛铜铝铞铟铠铡铢铣铤铥铦铧铨铪铫铬铭铮铯铰铱铲铳铴铵银铷铸铹铺铻铼铽链铿销锁锂锃锄锅锆锇锈锉锊锋锌锍锎锏锐锑锒锓锔锕锖锗错锚锜锞锟锠锡锢锣锤锥锦锨锩锫锬锭键锯锰锱锲锳锴锵锶锷锸锹锺锻锼锽锾锿镀镁镂镃镆镇镈镉镊镌镍镎镏镐镑镒镕镖镗镙镚镛镜镝镞镟镠镡镢镣镤镥镦镧镨镩镪镫镬镭镮镯镰镱镲镳镴镶长门闩闪闫闬闭问闯闰闱闲闳间闵闶闷闸闹闺闻闼闽闾闿阀阁阂阃阄阅阆阇阈阉阊阋阌阍阎阏阐阑阒阓阔阕阖阗阘阙阚阛队阳阴阵阶际陆陇陈陉陕陧陨险随隐隶隽难雏雠雳雾霁霉霭靓静靥鞑鞒鞯鞴韦韧韨韩韪韫韬韵页顶顷顸项顺须顼顽顾顿颀颁颂颃预颅领颇颈颉颊颋颌颍颎颏颐频颒颓颔颕颖颗题颙颚颛颜额颞颟颠颡颢颣颤颥颦颧风飏飐飑飒飓飔飕飖飗飘飙飚飞飨餍饤饥饦饧饨饩饪饫饬饭饮饯饰饱饲饳饴饵饶饷饸饹饺饻饼饽饾饿馀馁馂馃馄馅馆馇馈馉馊馋馌馍馎馏馐馑馒馓馔馕马驭驮驯驰驱驲驳驴驵驶驷驸驹驺驻驼驽驾驿骀骁骂骃骄骅骆骇骈骉骊骋验骍骎骏骐骑骒骓骔骕骖骗骘骙骚骛骜骝骞骟骠骡骢骣骤骥骦骧髅髋髌鬓魇魉鱼鱽鱾鱿鲀鲁鲂鲄鲅鲆鲇鲈鲉鲊鲋鲌鲍鲎鲏鲐鲑鲒鲓鲔鲕鲖鲗鲘鲙鲚鲛鲜鲝鲞鲟鲠鲡鲢鲣鲤鲥鲦鲧鲨鲩鲪鲫鲬鲭鲮鲯鲰鲱鲲鲳鲴鲵鲶鲷鲸鲹鲺鲻鲼鲽鲾鲿鳀鳁鳂鳃鳄鳅鳆鳇鳈鳉鳊鳋鳌鳍鳎鳏鳐鳑鳒鳓鳔鳕鳖鳗鳘鳙鳛鳜鳝鳞鳟鳠鳡鳢鳣鸟鸠鸡鸢鸣鸤鸥鸦鸧鸨鸩鸪鸫鸬鸭鸮鸯鸰鸱鸲鸳鸴鸵鸶鸷鸸鸹鸺鸻鸼鸽鸾鸿鹀鹁鹂鹃鹄鹅鹆鹇鹈鹉鹊鹋鹌鹍鹎鹏鹐鹑鹒鹓鹔鹕鹖鹗鹘鹚鹛鹜鹝鹞鹟鹠鹡鹢鹣鹤鹥鹦鹧鹨鹩鹪鹫鹬鹭鹯鹰鹱鹲鹳鹴鹾麦麸黄黉黡黩黪黾鼋鼌鼍鼗鼹齄齐齑齿龀龁龂龃龄龅龆龇龈龉龊龋龌龙龚龛龟志制咨范松冇尝尝闹准钟彆闲干尽脏拼作".toCharArray();
         String[] zhuyin = new String[]{"ㄅ", "ㄆ", "ㄇ", "ㄈ", "ㄉ", "ㄊ", "ㄋ", "ㄌ", "ㄍ", "ㄎ", "ㄏ", "ㄐ", "ㄑ", "ㄒ", "ㄓ", "ㄔ", "ㄕ", "ㄖ", "ㄗ", "ㄘ", "ㄙ", "ㄚ", "ㄛ", "ㄜ", "ㄝ", "ㄞ", "ㄟ", "ㄠ", "ㄡ", "ㄢ", "ㄣ", "ㄤ", "ㄥ", "ㄦ", "ㄧ", "ㄨ", "ㄩ"};
-        String[] pinyin = new String[]{"b", "p", "m", "f", "d", "t", "n", "l", "g", "k", "h", "j", "q", "x", "z", "c", "s", "r", "z", "c", "s", "a", "o", "e", "e", "ai", "ei", "ao", "ou", "an", "en", "ang", "eng", "er", "y", "w", "yu"};
+        String[] pinyin = new String[]{"b", "p", "m", "f", "d", "t", "n", "l", "g", "k", "h", "j", "q", "x", "z", "c", "s", "r", "z", "c", "s", "a", "o", "e", "e", "a", "e", "a", "o", "a", "e", "a", "e", "e", "y", "w", "y};
         for (int i = 0, n = UTF8T.length; i < n; ++i) {
             s2t.put(UTF8S[i], UTF8T[i]);
             t2s.put(UTF8T[i], UTF8S[i]);

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomKeyboard.java
Patch:
@@ -44,7 +44,7 @@ public void onIconClick(int resId) {
         int cursor = binding.keyword.getSelectionStart();
         switch (resId) {
             case R.drawable.ic_keyboard:
-                binding.fake.requestFocus();
+                binding.keyword.requestFocus();
                 adapter.toggle();
                 binding.keyboard.postDelayed(() -> binding.keyboard.findViewHolderForLayoutPosition(6).itemView.requestFocus(), 0);
                 break;

File: app/src/main/java/com/fongmi/android/tv/Setting.java
Patch:
@@ -6,6 +6,7 @@
 
 import com.fongmi.android.tv.player.Players;
 import com.github.catvod.utils.Prefers;
+import com.github.catvod.utils.Util;
 
 public class Setting {
 
@@ -50,7 +51,7 @@ public static void putHot(String hot) {
     }
 
     public static String getUa() {
-        return Prefers.getString("ua");
+        return Prefers.getString("ua", Util.CHROME);
     }
 
     public static void putUa(String ua) {

File: youtube/src/main/java/com/github/kiulian/downloader/parser/ParserImpl.java
Patch:
@@ -65,7 +65,7 @@ public Response<VideoInfo> parseVideo(RequestVideoInfo request) {
     private VideoInfo parseVideo(String videoId, YoutubeCallback<VideoInfo> callback) throws YoutubeException {
         // try to spoof android
         // workaround for issue https://github.com/sealedtx/java-youtube-downloader/issues/97
-        VideoInfo videoInfo = parseVideoWeb(videoId, callback);
+        VideoInfo videoInfo = parseVideoAndroid(videoId, callback);
         if (videoInfo == null) {
             videoInfo = parseVideoWeb(videoId, callback);
         }

File: app/src/main/java/com/fongmi/android/tv/model/LiveViewModel.java
Patch:
@@ -89,8 +89,6 @@ public void getUrl(Channel item) {
 
     public void getUrl(Channel item, EpgData data) {
         execute(URL, () -> {
-            item.setMsg(null);
-            Source.get().stop();
             item.setUrl(item.getCatchup().format(item.getCurrent(), data));
             return item;
         });

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -260,6 +260,7 @@ private Result fetchPic(Site site, Result result) throws Exception {
         ArrayList<String> ids = new ArrayList<>();
         if (site.getCategories().isEmpty()) for (Vod item : result.getList()) ids.add(item.getVodId());
         else for (Vod item : result.getList()) if (site.getCategories().contains(item.getTypeName())) ids.add(item.getVodId());
+        if (ids.isEmpty()) return result.clear();
         ArrayMap<String, String> params = new ArrayMap<>();
         params.put("ac", site.getType() == 0 ? "videolist" : "detail");
         params.put("ids", TextUtils.join(",", ids));

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -189,8 +189,8 @@ public void playerContent(String key, String flag, String id) {
                 result.setFlag(flag);
                 result.setHeader(site.getHeader());
                 result.setPlayUrl(site.getPlayUrl());
-                result.setUrl(Source.get().fetch(result));
                 result.setParse(Sniffer.isVideoFormat(url.v()) && result.getPlayUrl().isEmpty() ? 0 : 1);
+                result.setUrl(Source.get().fetch(result));
                 SpiderDebug.log(result.toString());
                 return result;
             }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -58,7 +58,6 @@
 import com.fongmi.android.tv.impl.SubtitleCallback;
 import com.fongmi.android.tv.model.SiteViewModel;
 import com.fongmi.android.tv.player.Players;
-import com.fongmi.android.tv.player.Source;
 import com.fongmi.android.tv.player.exo.ExoUtil;
 import com.fongmi.android.tv.ui.adapter.QualityAdapter;
 import com.fongmi.android.tv.ui.base.BaseActivity;
@@ -583,7 +582,6 @@ private void setQualityVisible(boolean visible) {
 
     private void setQualityActivated(Result result) {
         try {
-            result.setUrl(Source.get().fetch(result));
             mPlayers.start(result, isUseParse(), getSite().isChangeable() ? getSite().getTimeout() : -1);
         } catch (Exception e) {
             ErrorEvent.extract(e.getMessage());

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -189,6 +189,7 @@ public void playerContent(String key, String flag, String id) {
                 result.setFlag(flag);
                 result.setHeader(site.getHeader());
                 result.setPlayUrl(site.getPlayUrl());
+                result.setUrl(Source.get().fetch(result));
                 result.setParse(Sniffer.isVideoFormat(url.v()) && result.getPlayUrl().isEmpty() ? 0 : 1);
                 SpiderDebug.log(result.toString());
                 return result;

File: app/src/main/java/com/fongmi/android/tv/player/Source.java
Patch:
@@ -9,7 +9,6 @@
 import com.fongmi.android.tv.player.extractor.Thunder;
 import com.fongmi.android.tv.player.extractor.Video;
 import com.fongmi.android.tv.player.extractor.Youtube;
-import com.fongmi.android.tv.player.extractor.ZLive;
 import com.fongmi.android.tv.utils.UrlUtil;
 
 import java.util.ArrayList;
@@ -36,7 +35,6 @@ public Source() {
         extractors.add(new TVBus());
         extractors.add(new Video());
         extractors.add(new Youtube());
-        extractors.add(new ZLive());
     }
 
     private Extractor getExtractor(String url) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -63,7 +63,6 @@
 import com.fongmi.android.tv.impl.SubtitleCallback;
 import com.fongmi.android.tv.model.SiteViewModel;
 import com.fongmi.android.tv.player.Players;
-import com.fongmi.android.tv.player.Source;
 import com.fongmi.android.tv.player.exo.ExoUtil;
 import com.fongmi.android.tv.service.PlaybackService;
 import com.fongmi.android.tv.ui.adapter.EpisodeAdapter;
@@ -572,7 +571,6 @@ public void onItemClick(Episode item) {
     @Override
     public void onItemClick(Result result) {
         try {
-            result.setUrl(Source.get().fetch(result));
             mPlayers.start(result, isUseParse(), getSite().isChangeable() ? getSite().getTimeout() : -1);
         } catch (Exception e) {
             ErrorEvent.extract(e.getMessage());

File: app/src/main/java/com/fongmi/android/tv/bean/Drm.java
Patch:
@@ -44,7 +44,7 @@ private UUID getUUID() {
 
     private String getUri() {
         if (getKey().startsWith("http")) return getKey();
-        return Server.get().getAddress("license/") + Util.base64(getKey());
+        return Server.get().getAddress("license/") + Util.base64(getKey(), Util.URL_SAFE);
     }
 
     public MediaItem.DrmConfiguration get() {

File: app/src/main/java/com/fongmi/android/tv/bean/Parse.java
Patch:
@@ -1,7 +1,6 @@
 package com.fongmi.android.tv.bean;
 
 import android.text.TextUtils;
-import android.util.Base64;
 
 import androidx.annotation.NonNull;
 
@@ -128,7 +127,7 @@ public boolean equals(Object obj) {
     public String extUrl() {
         int index = getUrl().indexOf("?");
         if (getExt().isEmpty() || index == -1) return getUrl();
-        return getUrl().substring(0, index + 1) + "cat_ext=" + Util.base64(getExt().toString(), Base64.DEFAULT | Base64.URL_SAFE | Base64.NO_WRAP) + "&" + getUrl().substring(index + 1);
+        return getUrl().substring(0, index + 1) + "cat_ext=" + Util.base64(getExt().toString(), Util.URL_SAFE) + "&" + getUrl().substring(index + 1);
     }
 
     public HashMap<String, String> mixMap() {

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -102,7 +102,7 @@ public void categoryContent(String key, String tid, String page, boolean filter,
             } else {
                 ArrayMap<String, String> params = new ArrayMap<>();
                 if (site.getType() == 1 && !extend.isEmpty()) params.put("f", App.gson().toJson(extend));
-                else if (site.getType() == 4) params.put("ext", Util.base64(App.gson().toJson(extend)));
+                if (site.getType() == 4) params.put("ext", Util.base64(App.gson().toJson(extend), Util.URL_SAFE));
                 params.put("ac", site.getType() == 0 ? "videolist" : "detail");
                 params.put("t", tid);
                 params.put("pg", page);

File: app/src/main/java/com/fongmi/android/tv/server/Nano.java
Patch:
@@ -61,7 +61,7 @@ public Response serve(IHTTPSession session) {
         if (url.startsWith("/proxy")) return proxy(session);
         if (url.startsWith("/tvbus")) return success(LiveConfig.getResp());
         if (url.startsWith("/device")) return success(Device.get().toString());
-        if (url.startsWith("/license")) return success(Util.decode(url.substring(9)));
+        if (url.startsWith("/license")) return success(new String(Util.decode(url.substring(9), Util.URL_SAFE)));
         for (Process process : process) if (process.isRequest(session, url)) return process.doResponse(session, url, files);
         return getAssets(url.substring(1));
     }

File: quickjs/src/main/java/com/fongmi/quickjs/bean/Res.java
Patch:
@@ -1,9 +1,9 @@
 package com.fongmi.quickjs.bean;
 
 import android.text.TextUtils;
-import android.util.Base64;
 
 import com.github.catvod.utils.Json;
+import com.github.catvod.utils.Util;
 import com.google.gson.Gson;
 import com.google.gson.JsonElement;
 import com.google.gson.annotations.SerializedName;
@@ -57,7 +57,7 @@ public String getContentType() {
     }
 
     public ByteArrayInputStream getStream() {
-        if (getBuffer() == 2) return new ByteArrayInputStream(Base64.decode(getContent(), Base64.DEFAULT));
+        if (getBuffer() == 2) return new ByteArrayInputStream(Util.decode(getContent()));
         return new ByteArrayInputStream(getContent().getBytes());
     }
 }

File: quickjs/src/main/java/com/fongmi/quickjs/crawler/Spider.java
Patch:
@@ -1,7 +1,6 @@
 package com.fongmi.quickjs.crawler;
 
 import android.content.Context;
-import android.util.Base64;
 
 import androidx.media3.common.util.UriUtil;
 
@@ -14,6 +13,7 @@
 import com.fongmi.quickjs.utils.Module;
 import com.github.catvod.utils.Asset;
 import com.github.catvod.utils.Json;
+import com.github.catvod.utils.Util;
 import com.whl.quickjs.wrapper.JSArray;
 import com.whl.quickjs.wrapper.JSMethod;
 import com.whl.quickjs.wrapper.JSObject;
@@ -260,7 +260,7 @@ private ByteArrayInputStream getStream(Object o, boolean base64) {
         } else {
             String content = o.toString();
             if (base64 && content.contains("base64,")) content = content.split("base64,")[1];
-            return new ByteArrayInputStream(base64 ? Base64.decode(content, Base64.DEFAULT) : content.getBytes());
+            return new ByteArrayInputStream(base64 ? Util.decode(content) : content.getBytes());
         }
     }
 }

File: quickjs/src/main/java/com/fongmi/quickjs/utils/Crypto.java
Patch:
@@ -38,7 +38,7 @@ public static String aes(String mode, boolean encrypt, String input, boolean inB
             SecretKeySpec keySpec = new SecretKeySpec(keyBuf, "AES");
             if (iv == null) cipher.init(encrypt ? Cipher.ENCRYPT_MODE : Cipher.DECRYPT_MODE, keySpec);
             else cipher.init(encrypt ? Cipher.ENCRYPT_MODE : Cipher.DECRYPT_MODE, keySpec, new IvParameterSpec(ivBuf));
-            byte[] inBuf = inBase64 ? Base64.decode(input.replaceAll("_", "/").replaceAll("-", "+"), Base64.DEFAULT) : input.getBytes("UTF-8");
+            byte[] inBuf = inBase64 ? Base64.decode(input, Base64.DEFAULT | Base64.URL_SAFE) : input.getBytes("UTF-8");
             return outBase64 ? Base64.encodeToString(cipher.doFinal(inBuf), Base64.NO_WRAP) : new String(cipher.doFinal(inBuf), "UTF-8");
         } catch (Exception e) {
             e.printStackTrace();
@@ -51,7 +51,7 @@ public static String rsa(String mode, boolean pub, boolean encrypt, String input
             Key rsaKey = generateKey(pub, key);
             int len = getModulusLength(rsaKey);
             byte[] outBytes = new byte[0];
-            byte[] inBytes = inBase64 ? Base64.decode(input.replaceAll("_", "/").replaceAll("-", "+"), Base64.DEFAULT) : input.getBytes("UTF-8");
+            byte[] inBytes = inBase64 ? Base64.decode(input, Base64.DEFAULT | Base64.URL_SAFE) : input.getBytes("UTF-8");
             Cipher cipher = Cipher.getInstance("RSA/ECB/PKCS1Padding");
             cipher.init(encrypt ? Cipher.ENCRYPT_MODE : Cipher.DECRYPT_MODE, rsaKey);
             int blockLen = encrypt ? len / 8 - 11 : len / 8;

File: app/src/mobile/java/com/fongmi/android/tv/bean/CastVideo.java
Patch:
@@ -14,7 +14,7 @@ public static CastVideo get(String name, String url) {
     }
 
     private CastVideo(String name, String url) {
-        if (url.startsWith("file")) url = Server.get().getAddress() + "/" + url.replace(Path.rootPath(), "");
+        if (url.startsWith("file")) url = Server.get().getAddress() + "/" + url.replace(Path.rootPath(), "").replace("://", "");
         if (url.contains("127.0.0.1")) url = url.replace("127.0.0.1", Util.getIp());
         this.name = name;
         this.url = url;

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/CastDialog.java
Patch:
@@ -77,7 +77,7 @@ public CastDialog history(History history) {
         String id = history.getVodId();
         String fd = history.getVodId();
         if (fd.startsWith("/")) fd = Server.get().getAddress() + "/file" + fd.replace(Path.rootPath(), "");
-        if (fd.startsWith("file")) fd = Server.get().getAddress() + "/" + fd.replace(Path.rootPath(), "");
+        if (fd.startsWith("file")) fd = Server.get().getAddress() + "/" + fd.replace(Path.rootPath(), "").replace("://", "");
         if (fd.contains("127.0.0.1")) fd = fd.replace("127.0.0.1", Util.getIp());
         body.add("history", history.toString().replace(id, fd));
         return this;

File: app/src/main/java/com/fongmi/android/tv/bean/Parse.java
Patch:
@@ -1,6 +1,7 @@
 package com.fongmi.android.tv.bean;
 
 import android.text.TextUtils;
+import android.util.Base64;
 
 import androidx.annotation.NonNull;
 
@@ -127,7 +128,7 @@ public boolean equals(Object obj) {
     public String extUrl() {
         int index = getUrl().indexOf("?");
         if (getExt().isEmpty() || index == -1) return getUrl();
-        return getUrl().substring(0, index + 1) + "cat_ext=" + Util.base64(getExt().toString()) + "&" + getUrl().substring(index + 1);
+        return getUrl().substring(0, index + 1) + "cat_ext=" + Util.base64(getExt().toString(), Base64.DEFAULT | Base64.URL_SAFE | Base64.NO_WRAP) + "&" + getUrl().substring(index + 1);
     }
 
     public HashMap<String, String> mixMap() {

File: app/src/main/java/com/fongmi/android/tv/server/Nano.java
Patch:
@@ -10,6 +10,7 @@
 import com.fongmi.android.tv.server.process.Local;
 import com.fongmi.android.tv.server.process.Process;
 import com.github.catvod.utils.Asset;
+import com.github.catvod.utils.Util;
 import com.google.common.net.HttpHeaders;
 
 import java.io.InputStream;
@@ -70,7 +71,7 @@ public Response serve(IHTTPSession session) {
         if (url.startsWith("/proxy")) return proxy(session);
         if (url.startsWith("/tvbus")) return success(LiveConfig.getResp());
         if (url.startsWith("/device")) return success(Device.get().toString());
-        if (url.startsWith("/license")) return success(new String(Base64.decode(url.substring(9), Base64.DEFAULT)));
+        if (url.startsWith("/license")) return success(Util.decode(url.substring(9)));
         for (Process process : process) if (process.isRequest(session, url)) return process.doResponse(session, url, files);
         return getAssets(url.substring(1));
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -376,7 +376,7 @@ private void setVideoView() {
     }
 
     private void setSubtitleView() {
-        mBinding.exo.getSubtitleView().setFixedTextSize(Dimension.SP, 14);
+        setSubtitle(Setting.getSubtitle());
         mBinding.exo.getSubtitleView().setStyle(ExoUtil.getCaptionStyle());
         mBinding.exo.getSubtitleView().setApplyEmbeddedStyles(!Setting.isCaption());
     }
@@ -839,7 +839,6 @@ private void enterFullscreen() {
         setRequestedOrientation(mPlayers.isPortrait() ? ActivityInfo.SCREEN_ORIENTATION_USER_PORTRAIT : ActivityInfo.SCREEN_ORIENTATION_SENSOR_LANDSCAPE);
         mBinding.control.full.setVisibility(View.GONE);
         setRotate(mPlayers.isPortrait(), true);
-        setSubtitle(Setting.getSubtitle());
         Util.hideSystemUI(this);
         App.post(mR3, 2000);
         hideControl();
@@ -853,7 +852,6 @@ private void exitFullscreen() {
         mBinding.video.setLayoutParams(mFrameParams);
         setRotate(false, false);
         App.post(mR3, 2000);
-        setSubtitle(14);
         hideControl();
     }
 
@@ -1503,6 +1501,7 @@ public void onPictureInPictureModeChanged(boolean isInPictureInPictureMode) {
         } else {
             setForeground(true);
             PlaybackService.stop();
+            setSubtitle(Setting.getSubtitle());
             if (isStop()) finish();
         }
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -527,7 +527,7 @@ public void onItemClick(Group item) {
 
     @Override
     public void onItemClick(Channel item) {
-        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel.equals(item) && mChannel.getGroup().equals(mGroup)) {
+        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel != null && mChannel.equals(item) && mChannel.getGroup().equals(mGroup)) {
             showEpg(item);
         } else {
             mGroup.setPosition(mBinding.channel.getSelectedPosition());

File: app/src/main/java/com/fongmi/android/tv/model/LiveViewModel.java
Patch:
@@ -6,6 +6,7 @@
 import com.fongmi.android.tv.Constant;
 import com.fongmi.android.tv.api.EpgParser;
 import com.fongmi.android.tv.api.LiveParser;
+import com.fongmi.android.tv.api.config.LiveConfig;
 import com.fongmi.android.tv.api.config.VodConfig;
 import com.fongmi.android.tv.bean.Channel;
 import com.fongmi.android.tv.bean.Epg;
@@ -97,6 +98,7 @@ public void getUrl(Channel item, EpgData data) {
     private void verify(Live item) {
         Iterator<Group> iterator = item.getGroups().iterator();
         while (iterator.hasNext()) if (iterator.next().isEmpty()) iterator.remove();
+        LiveConfig.get().setKeep(item);
     }
 
     private void execute(int type, Callable<?> callable) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -569,7 +569,7 @@ public void onItemClick(Group item) {
 
     @Override
     public void onItemClick(Channel item) {
-        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel.equals(item) && mChannel.getGroup().equals(mGroup)) {
+        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel != null && mChannel.equals(item) && mChannel.getGroup().equals(mGroup)) {
             showEpg(item);
         } else {
             mGroup.setPosition(mChannelAdapter.setSelected(item.group(mGroup)));

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -252,9 +252,7 @@ private void getLive() {
 
     private void setGroup(Live live) {
         List<Group> items = new ArrayList<>();
-        items.add(Group.create(R.string.keep));
         for (Group group : live.getGroups()) (group.isHidden() ? mHides : items).add(group);
-        LiveConfig.get().setKeep(items);
         mGroupAdapter.setItems(items, null);
         setPosition(LiveConfig.get().find(items));
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -275,10 +275,8 @@ private void getLive() {
 
     private void setGroup(Live live) {
         List<Group> items = new ArrayList<>();
-        items.add(Group.create(R.string.keep));
         for (Group group : live.getGroups()) (group.isHidden() ? mHides : items).add(group);
         mGroupAdapter.addAll(items);
-        LiveConfig.get().setKeep(items);
         setPosition(LiveConfig.get().find(items));
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -409,7 +409,7 @@ public void showUI() {
 
     @Override
     public void showEpg(Channel item) {
-        if (mChannel == null || mChannel.getData().getList().isEmpty() || mEpgDataAdapter.size() == 0 || !mChannel.equals(item)) return;
+        if (mChannel == null || mChannel.getData().getList().isEmpty() || mEpgDataAdapter.size() == 0 || !mChannel.equals(item) || !mChannel.getGroup().equals(mGroup)) return;
         mBinding.widget.epgData.setSelectedPosition(mChannel.getData().getSelected());
         mBinding.widget.epg.setVisibility(View.VISIBLE);
         mBinding.widget.epg.requestFocus();
@@ -529,7 +529,7 @@ public void onItemClick(Group item) {
 
     @Override
     public void onItemClick(Channel item) {
-        if (item.getData().getList().size() > 0 && item.isSelected() && item.equals(mChannel)) {
+        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel.equals(item) && mChannel.getGroup().equals(mGroup)) {
             showEpg(item);
         } else {
             mGroup.setPosition(mBinding.channel.getSelectedPosition());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -447,7 +447,7 @@ private void showUI() {
     }
 
     private void showEpg(Channel item) {
-        if (mChannel == null || mChannel.getData().getList().isEmpty() || mEpgDataAdapter.getItemCount() == 0 || !mChannel.equals(item)) return;
+        if (mChannel == null || mChannel.getData().getList().isEmpty() || mEpgDataAdapter.getItemCount() == 0 || !mChannel.equals(item) || !mChannel.getGroup().equals(mGroup)) return;
         mBinding.widget.epgData.scrollToPosition(item.getData().getSelected());
         mBinding.widget.epg.setVisibility(View.VISIBLE);
         hideUI();
@@ -571,7 +571,7 @@ public void onItemClick(Group item) {
 
     @Override
     public void onItemClick(Channel item) {
-        if (item.getData().getList().size() > 0 && item.isSelected() && item.equals(mChannel)) {
+        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel.equals(item) && mChannel.getGroup().equals(mGroup)) {
             showEpg(item);
         } else {
             mGroup.setPosition(mChannelAdapter.setSelected(item.group(mGroup)));

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -267,9 +267,9 @@ public String toggleSpeed() {
     }
 
     public void toggleDecode(PlayerView exo) {
-        decode = isHard(decode) ? SOFT : HARD;
-        Setting.putDecode(decode);
+        Setting.putDecode(decode = isHard() ? SOFT : HARD);
         setup(exo);
+        reset();
     }
 
     public String getPositionTime(long time) {

File: app/src/main/java/com/fongmi/android/tv/player/exo/ExoUtil.java
Patch:
@@ -86,12 +86,12 @@ public static String getMimeType(String path) {
     public static String getMimeType(String format, int errorCode) {
         if (format != null) return format;
         if (errorCode == PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED || errorCode == PlaybackException.ERROR_CODE_PARSING_MANIFEST_MALFORMED) return MimeTypes.APPLICATION_OCTET;
-        if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED || errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED) return MimeTypes.APPLICATION_M3U8;
+        if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED || errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED || errorCode == PlaybackException.ERROR_CODE_IO_UNSPECIFIED) return MimeTypes.APPLICATION_M3U8;
         return null;
     }
 
     public static int getRetry(int errorCode) {
-        return errorCode >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && errorCode <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED ? 2 : errorCode > 999 ? 1 : 0;
+        return errorCode >= PlaybackException.ERROR_CODE_PARSING_CONTAINER_MALFORMED && errorCode <= PlaybackException.ERROR_CODE_PARSING_MANIFEST_UNSUPPORTED || errorCode == PlaybackException.ERROR_CODE_IO_UNSPECIFIED ? 2 : errorCode > 999 ? 1 : 0;
     }
 
     public static MediaItem getMediaItem(Map<String, String> headers, Uri uri, String mimeType, Drm drm, List<Sub> subs, int decode) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -270,7 +270,7 @@ private Group setWidth(Group group) {
         int padding = ResUtil.dp2px(60);
         if (group.isKeep()) group.setWidth(0);
         if (group.getWidth() == 0) for (Channel item : group.getChannel()) group.setWidth(Math.max(group.getWidth(), (item.getLogo().isEmpty() ? 0 : logo) + ResUtil.getTextWidth(item.getNumber() + item.getName(), 16)));
-        mBinding.channel.getLayoutParams().width = group.getWidth() == 0 ? 0 : Math.min(group.getWidth() + padding, ResUtil.getScreenWidth() / 3);
+        mBinding.channel.getLayoutParams().width = group.getWidth() == 0 ? 0 : Math.min(group.getWidth() + padding, ResUtil.getScreenWidth() / 2);
         return group;
     }
 
@@ -279,7 +279,7 @@ private void setWidth(Epg epg) {
         if (epg.getList().isEmpty()) return;
         int minWidth = ResUtil.getTextWidth(epg.getList().get(0).getTime(), 16);
         if (epg.getWidth() == 0) for (EpgData item : epg.getList()) epg.setWidth(Math.max(epg.getWidth(), ResUtil.getTextWidth(item.getTitle(), 16)));
-        mBinding.widget.epgData.getLayoutParams().width = epg.getWidth() == 0 ? 0 : Math.min(Math.max(epg.getWidth(), minWidth) + padding, ResUtil.getScreenWidth() / 3);
+        mBinding.widget.epgData.getLayoutParams().width = epg.getWidth() == 0 ? 0 : Math.min(Math.max(epg.getWidth(), minWidth) + padding, ResUtil.getScreenWidth() / 2);
     }
 
     private void setPosition(int[] position) {

File: app/src/main/java/com/fongmi/android/tv/player/exo/ExoUtil.java
Patch:
@@ -47,7 +47,8 @@ public static TrackSelector buildTrackSelector() {
     }
 
     public static RenderersFactory buildRenderersFactory(int decode) {
-        return new NextRenderersFactory(App.get()).setEnableDecoderFallback(true).setExtensionRendererMode(Players.isSoft(decode) ? DefaultRenderersFactory.EXTENSION_RENDERER_MODE_PREFER : DefaultRenderersFactory.EXTENSION_RENDERER_MODE_ON);
+        if (Players.isHard(decode)) return new DefaultRenderersFactory(App.get()).setEnableDecoderFallback(true).setExtensionRendererMode(DefaultRenderersFactory.EXTENSION_RENDERER_MODE_ON);
+        else return new NextRenderersFactory(App.get()).setEnableDecoderFallback(true).setExtensionRendererMode(DefaultRenderersFactory.EXTENSION_RENDERER_MODE_PREFER);
     }
 
     public static MediaSource.Factory buildMediaSourceFactory() {

File: app/src/main/java/com/fongmi/android/tv/event/ErrorEvent.java
Patch:
@@ -54,7 +54,7 @@ public int getCode() {
     }
 
     public String getMsg() {
-        if (type == Type.URL) return ResUtil.getString(R.string.error_play_url);
+        if (type == Type.URL) return ResUtil.getString(R.string.error_play_url, code);
         if (type == Type.FLAG) return ResUtil.getString(R.string.error_play_flag);
         if (type == Type.PARSE) return ResUtil.getString(R.string.error_play_parse);
         if (type == Type.TIMEOUT) return ResUtil.getString(R.string.error_play_timeout);

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -13,6 +13,7 @@
 
 import androidx.annotation.NonNull;
 import androidx.media3.common.AudioAttributes;
+import androidx.media3.common.C;
 import androidx.media3.common.PlaybackException;
 import androidx.media3.common.Player;
 import androidx.media3.exoplayer.ExoPlayer;
@@ -92,6 +93,7 @@ private Players(Activity activity) {
         builder = new StringBuilder();
         runnable = ErrorEvent::timeout;
         formatter = new Formatter(builder, Locale.getDefault());
+        position = C.TIME_UNSET;
         createSession(activity);
     }
 
@@ -145,6 +147,7 @@ public void setPosition(long position) {
     }
 
     public void reset() {
+        position = C.TIME_UNSET;
         removeTimeoutCheck();
         stopParse();
         error = 0;

File: app/src/main/java/com/fongmi/android/tv/bean/Config.java
Patch:
@@ -9,6 +9,8 @@
 
 import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.db.AppDatabase;
+import com.fongmi.android.tv.utils.FileUtil;
+import com.github.catvod.utils.Path;
 import com.github.catvod.utils.Prefers;
 import com.google.gson.annotations.SerializedName;
 import com.google.gson.reflect.TypeToken;
@@ -192,6 +194,7 @@ public static void delete(String url) {
     }
 
     public static void delete(String url, int type) {
+        if (type == 2) Path.clear(FileUtil.getWall(0));
         if (type == 2) AppDatabase.get().getConfigDao().delete(type);
         else AppDatabase.get().getConfigDao().delete(url, type);
     }

File: app/src/main/java/com/fongmi/android/tv/api/EpgParser.java
Patch:
@@ -64,7 +64,7 @@ private static void readXml(Live live, File file) throws Exception {
         SimpleDateFormat formatDate = new SimpleDateFormat("yyyy-MM-dd", Locale.getDefault());
         SimpleDateFormat formatFull = new SimpleDateFormat("yyyyMMddHHmmss Z", Locale.getDefault());
         String today = formatDate.format(new Date());
-        Tv tv = new Persister().read(Tv.class, Path.read(file));
+        Tv tv = new Persister().read(Tv.class, Path.read(file), false);
         for (Group group : live.getGroups()) for (Channel channel : group.getChannel()) exist.add(channel.getTvgName());
         for (Tv.Channel channel : tv.getChannel()) mapping.put(channel.getId(), channel.getDisplayName());
         for (Tv.Programme programme : tv.getProgramme()) {

File: app/src/main/java/com/fongmi/android/tv/bean/Result.java
Patch:
@@ -98,7 +98,7 @@ public static Result fromJson(String str) {
 
     public static Result fromXml(String str) {
         try {
-            return new Persister().read(Result.class, str).trans();
+            return new Persister().read(Result.class, str, false).trans();
         } catch (Exception e) {
             return empty();
         }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -371,6 +371,7 @@ private void onPlay() {
 
     private void onStopped() {
         setState(RenderState.STOPPED);
+        mPlayers.reset();
         mPlayers.stop();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -428,6 +428,7 @@ private void getDetail(Vod item) {
         getIntent().putExtra("id", item.getVodId());
         mBinding.scroll.scrollTo(0, 0);
         mClock.setCallback(null);
+        mPlayers.reset();
         mPlayers.stop();
         getDetail();
     }
@@ -526,6 +527,7 @@ private void getPlayer(Flag flag, Episode episode, boolean replay) {
         mViewModel.playerContent(getKey(), flag.getFlag(), episode.getUrl());
         updateHistory(episode, replay);
         mPlayers.clear();
+        mPlayers.stop();
         showProgress();
         setMetadata();
         hideCenter();
@@ -1149,6 +1151,7 @@ private void onError(ErrorEvent event) {
         Track.delete(getHistoryKey());
         showError(event.getMsg());
         mClock.setCallback(null);
+        mPlayers.reset();
         mPlayers.stop();
         startFlow();
     }

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -294,7 +294,6 @@ public void pause() {
     }
 
     public void stop() {
-        reset();
         session.setActive(false);
         if (player != null) player.stop();
         if (player != null) player.clearMediaItems();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -425,6 +425,7 @@ private void getDetail(Vod item) {
         mBinding.swipeLayout.setEnabled(false);
         mBinding.scroll.scrollTo(0, 0);
         mClock.setCallback(null);
+        mPlayers.reset();
         mPlayers.stop();
         getDetail();
     }
@@ -526,6 +527,7 @@ private void getPlayer(Flag flag, Episode episode, boolean replay) {
         getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
         updateHistory(episode, replay);
         mPlayers.clear();
+        mPlayers.stop();
         showProgress();
         setMetadata();
     }
@@ -1160,6 +1162,7 @@ private void onError(ErrorEvent event) {
         Track.delete(getHistoryKey());
         showError(event.getMsg());
         mClock.setCallback(null);
+        mPlayers.reset();
         mPlayers.stop();
         startFlow();
     }

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -385,7 +385,7 @@ private void setMediaSource(Channel channel, int timeout) {
     }
 
     private void setMediaSource(Result result, int timeout) {
-        setMediaSource(result.getHeaders(), result.getRealUrl(), result.getFormat(), result.getDrm(), checkSub(result.getSubs()), timeout);
+        setMediaSource(result.getHeaders(), result.getRealUrl(), result.getFormat(), result.getDrm(), result.getSubs(), timeout);
     }
 
     private void setMediaSource(Map<String, String> headers, String url, String format, Drm drm, List<Sub> subs, int timeout) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -532,7 +532,7 @@ public void onItemClick(Group item) {
 
     @Override
     public void onItemClick(Channel item) {
-        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel != null) {
+        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel != null && mChannel.equals(item)) {
             showEpg(item);
         } else {
             mGroup.setPosition(mBinding.channel.getSelectedPosition());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -574,7 +574,7 @@ public void onItemClick(Group item) {
 
     @Override
     public void onItemClick(Channel item) {
-        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel != null) {
+        if (item.getData().getList().size() > 0 && item.isSelected() && mChannel != null && mChannel.equals(item)) {
             showEpg(item);
         } else {
             mGroup.setPosition(mChannelAdapter.setSelected(item.group(mGroup)));

File: app/src/main/java/com/fongmi/android/tv/bean/Keep.java
Patch:
@@ -156,7 +156,7 @@ private static void startSync(List<Config> configs, List<Keep> targets) {
         for (Keep target : targets) {
             for (Config config : configs) {
                 if (target.getCid() == config.getId()) {
-                    target.save(Config.find(config, 0).getId());
+                    target.save(Config.find(config).getId());
                 }
             }
         }

File: app/src/main/java/com/fongmi/android/tv/db/dao/ConfigDao.java
Patch:
@@ -15,7 +15,7 @@ public abstract class ConfigDao extends BaseDao<Config> {
     public abstract List<Config> findByType(int type);
 
     @SuppressWarnings(RoomWarnings.CURSOR_MISMATCH)
-    @Query("SELECT id, url, type, time FROM Config WHERE type = :type ORDER BY time DESC")
+    @Query("SELECT id, name, url, type, time FROM Config WHERE type = :type ORDER BY time DESC")
     public abstract List<Config> findUrlByType(int type);
 
     @Query("SELECT * FROM Config WHERE id = :id")

File: app/src/main/java/com/fongmi/android/tv/server/process/Action.java
Patch:
@@ -184,7 +184,7 @@ private void syncKeep(Map<String, String> params, boolean force) {
         List<Keep> targets = Keep.arrayFrom(params.get("targets"));
         List<Config> configs = Config.arrayFrom(params.get("configs"));
         if (TextUtils.isEmpty(VodConfig.getUrl()) && configs.size() > 0) {
-            VodConfig.load(Config.find(configs.get(0), 0), getCallback(configs, targets));
+            VodConfig.load(Config.find(configs.get(0)), getCallback(configs, targets));
         } else {
             if (force) Keep.deleteAll();
             Keep.sync(configs, targets);

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -207,11 +207,11 @@ public boolean isEmpty() {
     }
 
     public boolean isLive() {
-        return getDuration() < 5 * 60 * 1000;
+        return getDuration() < 5 * 60 * 1000 || player.isCurrentMediaItemLive();
     }
 
     public boolean isVod() {
-        return getDuration() > 5 * 60 * 1000;
+        return getDuration() > 5 * 60 * 1000 && !player.isCurrentMediaItemLive();
     }
 
     public boolean isPortrait() {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -308,6 +308,7 @@ public void release() {
         stopParse();
         releasePlayer();
         session.release();
+        removeTimeoutCheck();
         App.execute(() -> Source.get().stop());
     }
 
@@ -366,25 +367,23 @@ public void setMediaSource(String url) {
     }
 
     private void setMediaSource(Result result, int timeout) {
-        Logger.t(TAG).d(error + "," + result.getRealUrl());
         if (player != null) player.setMediaSource(ExoUtil.getSource(result, sub, error), position);
         setTimeoutCheck(result.getHeaders(), result.getRealUrl(), timeout);
     }
 
     private void setMediaSource(Channel channel, int timeout) {
-        Logger.t(TAG).d(error + "," + channel.getUrl());
         if (player != null) player.setMediaSource(ExoUtil.getSource(channel, error));
         setTimeoutCheck(channel.getHeaders(), channel.getUrl(), timeout);
     }
 
     private void setMediaSource(Map<String, String> headers, String url) {
-        Logger.t(TAG).d(error + "," + url);
         if (player != null) player.setMediaSource(ExoUtil.getSource(headers, url, sub, error), position);
         setTimeoutCheck(headers, url, Constant.TIMEOUT_PLAY);
     }
 
     private void setTimeoutCheck(Map<String, String> headers, String url, int timeout) {
         if (player != null) player.prepare();
+        Logger.t(TAG).d(error + "," + url);
         App.post(runnable, timeout);
         this.headers = headers;
         PlayerEvent.state(0);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -335,7 +335,7 @@ private void setMetadata() {
     @Subscribe(threadMode = ThreadMode.MAIN)
     public void onErrorEvent(ErrorEvent event) {
         if (event.getCode() / 1000 == 4 && Players.isHard()) onDecode();
-        else if (mPlayers.addRetry() > 1) onError(event);
+        else if (mPlayers.addRetry() > 2) onError(event);
         else onReset();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -711,7 +711,7 @@ private void setMetadata() {
     @Subscribe(threadMode = ThreadMode.MAIN)
     public void onErrorEvent(ErrorEvent event) {
         if (event.getCode() / 1000 == 4 && Players.isHard()) onDecode();
-        else if (mPlayers.addRetry() > 1) onError(event);
+        else if (mPlayers.addRetry() > 2) onError(event);
         else fetch();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1131,7 +1131,7 @@ private void setMetadata() {
     public void onErrorEvent(ErrorEvent event) {
         if (isBackground()) return;
         if (event.getCode() / 1000 == 4 && Players.isHard()) onDecode();
-        else if (mPlayers.addRetry() > 1) onError(event);
+        else if (mPlayers.addRetry() > 2) onError(event);
         else onRefresh();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -770,7 +770,7 @@ private void setMetadata() {
     @Subscribe(threadMode = ThreadMode.MAIN)
     public void onErrorEvent(ErrorEvent event) {
         if (event.getCode() / 1000 == 4 && Players.isHard()) onDecode();
-        else if (mPlayers.addRetry() > 1) onError(event);
+        else if (mPlayers.addRetry() > 2) onError(event);
         else fetch();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1141,7 +1141,7 @@ private void setMetadata() {
     public void onErrorEvent(ErrorEvent event) {
         if (isRedirect()) return;
         if (event.getCode() / 1000 == 4 && Players.isHard()) onDecode();
-        else if (mPlayers.addRetry() > 1) onError(event);
+        else if (mPlayers.addRetry() > 2) onError(event);
         else onRefresh();
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ParseJob.java
Patch:
@@ -111,7 +111,6 @@ private void doInBackground(String key, String webUrl, String flag) throws Throw
     private void jsonParse(Parse item, String webUrl, boolean error) throws Exception {
         String body = OkHttp.newCall(item.getUrl() + webUrl, Headers.of(item.getHeaders())).execute().body().string();
         JsonObject object = Json.parse(body).getAsJsonObject();
-        object = object.has("data") ? object.getAsJsonObject("data") : object;
         boolean illegal = body.contains("不存在") || body.contains("已过期");
         String url = illegal ? "" : Json.safeString(object, "url");
         checkResult(getHeader(object), url, item.getName(), error);

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -75,9 +75,9 @@ private static void m3u(Live live, String text) {
             if (setting.find(line)) {
                 setting.check(line);
             } else if (line.startsWith("#EXTM3U")) {
-                live.setEpg(extract(line, TVG_URL));
                 catchup.setType(extract(line, CATCHUP));
                 catchup.setSource(extract(line, CATCHUP_SOURCE));
+                if (live.getEpg().isEmpty()) live.setEpg(extract(line, TVG_URL));
             } else if (line.startsWith("#EXTINF:")) {
                 Group group = live.find(Group.create(extract(line, GROUP), live.isPass()));
                 channel = group.find(Channel.create(extract(line, NAME)));

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -5,6 +5,7 @@
 import android.content.Context;
 import android.content.Intent;
 import android.content.ServiceConnection;
+import android.graphics.drawable.BitmapDrawable;
 import android.os.IBinder;
 import android.support.v4.media.MediaMetadataCompat;
 import android.view.KeyEvent;
@@ -332,8 +333,9 @@ private void setTrackVisible(boolean visible) {
     private void setMetadata() {
         String title = mBinding.widget.title.getText().toString();
         MediaMetadataCompat.Builder builder = new MediaMetadataCompat.Builder();
+        BitmapDrawable drawable = ((BitmapDrawable) mBinding.exo.getDefaultArtwork());
         builder.putString(MediaMetadataCompat.METADATA_KEY_TITLE, title);
-        //builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, getIjk().getDefaultArtwork());
+        builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, drawable.getBitmap());
         builder.putLong(MediaMetadataCompat.METADATA_KEY_DURATION, mPlayers.getDuration());
         mPlayers.setMetadata(builder.build());
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -3,6 +3,7 @@
 import android.annotation.SuppressLint;
 import android.content.Context;
 import android.content.Intent;
+import android.graphics.drawable.BitmapDrawable;
 import android.graphics.drawable.Drawable;
 import android.support.v4.media.MediaMetadataCompat;
 import android.view.KeyEvent;
@@ -707,9 +708,10 @@ private void setMetadata() {
         String title = mBinding.widget.name.getText().toString();
         String artist = mBinding.widget.play.getText().toString();
         MediaMetadataCompat.Builder builder = new MediaMetadataCompat.Builder();
+        BitmapDrawable drawable = ((BitmapDrawable) mBinding.exo.getDefaultArtwork());
         builder.putString(MediaMetadataCompat.METADATA_KEY_TITLE, title);
         builder.putString(MediaMetadataCompat.METADATA_KEY_ARTIST, artist);
-        //builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, getIjk().getDefaultArtwork());
+        builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, drawable.getBitmap());
         builder.putLong(MediaMetadataCompat.METADATA_KEY_DURATION, mPlayers.getDuration());
         mPlayers.setMetadata(builder.build());
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -4,6 +4,7 @@
 import android.annotation.SuppressLint;
 import android.app.Activity;
 import android.content.Intent;
+import android.graphics.drawable.BitmapDrawable;
 import android.graphics.drawable.Drawable;
 import android.net.Uri;
 import android.support.v4.media.MediaMetadataCompat;
@@ -1126,9 +1127,10 @@ private void setMetadata() {
         String artist = mEpisodeAdapter.size() == 0 ? "" : getEpisode().getName();
         artist = title.equals(artist) ? "" : getString(R.string.play_now, artist);
         MediaMetadataCompat.Builder builder = new MediaMetadataCompat.Builder();
+        BitmapDrawable drawable = ((BitmapDrawable) mBinding.exo.getDefaultArtwork());
         builder.putString(MediaMetadataCompat.METADATA_KEY_TITLE, title);
         builder.putString(MediaMetadataCompat.METADATA_KEY_ARTIST, artist);
-        //builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, getIjk().getDefaultArtwork());
+        builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, drawable.getBitmap());
         builder.putLong(MediaMetadataCompat.METADATA_KEY_DURATION, mPlayers.getDuration());
         mPlayers.setMetadata(builder.build());
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -5,6 +5,7 @@
 import android.content.Intent;
 import android.content.pm.ActivityInfo;
 import android.content.res.Configuration;
+import android.graphics.drawable.BitmapDrawable;
 import android.graphics.drawable.Drawable;
 import android.os.Build;
 import android.os.Bundle;
@@ -767,9 +768,10 @@ private void setMetadata() {
         String title = mBinding.widget.name.getText().toString();
         String artist = mBinding.widget.play.getText().toString();
         MediaMetadataCompat.Builder builder = new MediaMetadataCompat.Builder();
+        BitmapDrawable drawable = ((BitmapDrawable) mBinding.exo.getDefaultArtwork());
         builder.putString(MediaMetadataCompat.METADATA_KEY_TITLE, title);
         builder.putString(MediaMetadataCompat.METADATA_KEY_ARTIST, artist);
-        //builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, getIjk().getDefaultArtwork());
+        builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, drawable.getBitmap());
         builder.putLong(MediaMetadataCompat.METADATA_KEY_DURATION, mPlayers.getDuration());
         mPlayers.setMetadata(builder.build());
         ActionEvent.update();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -7,6 +7,7 @@
 import android.content.Intent;
 import android.content.pm.ActivityInfo;
 import android.content.res.Configuration;
+import android.graphics.drawable.BitmapDrawable;
 import android.graphics.drawable.Drawable;
 import android.net.Uri;
 import android.os.Build;
@@ -1136,9 +1137,10 @@ private void setMetadata() {
         String artist = mEpisodeAdapter.isEmpty() ? "" : getEpisode().getName();
         artist = title.equals(artist) ? "" : getString(R.string.play_now, artist);
         MediaMetadataCompat.Builder builder = new MediaMetadataCompat.Builder();
+        BitmapDrawable drawable = ((BitmapDrawable) mBinding.exo.getDefaultArtwork());
         builder.putString(MediaMetadataCompat.METADATA_KEY_TITLE, title);
         builder.putString(MediaMetadataCompat.METADATA_KEY_ARTIST, artist);
-        //builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, getIjk().getDefaultArtwork());
+        builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, drawable.getBitmap());
         builder.putLong(MediaMetadataCompat.METADATA_KEY_DURATION, mPlayers.getDuration());
         mPlayers.setMetadata(builder.build());
         ActionEvent.update();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1030,6 +1030,7 @@ private void checkHistory(Vod item) {
         if (Setting.isIncognito() && mHistory.getKey().equals(getHistoryKey())) mHistory.delete();
         mBinding.control.opening.setText(mHistory.getOpening() == 0 ? getString(R.string.play_op) : mPlayers.stringToTime(mHistory.getOpening()));
         mBinding.control.ending.setText(mHistory.getEnding() == 0 ? getString(R.string.play_ed) : mPlayers.stringToTime(mHistory.getEnding()));
+        mHistory.setVodPic(item.getVodPic());
         mPlayers.setPlayer(getPlayer());
         setScale(getScale());
         setPlayerView();
@@ -1040,7 +1041,6 @@ private History createHistory(Vod item) {
         History history = new History();
         history.setKey(getHistoryKey());
         history.setCid(VodConfig.getCid());
-        history.setVodPic(item.getVodPic());
         history.setVodName(item.getVodName());
         history.findEpisode(item.getVodFlags());
         return history;

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1017,6 +1017,7 @@ private void checkHistory(Vod item) {
         if (Setting.isIncognito() && mHistory.getKey().equals(getHistoryKey())) mHistory.delete();
         mBinding.control.action.opening.setText(mHistory.getOpening() == 0 ? getString(R.string.play_op) : mPlayers.stringToTime(mHistory.getOpening()));
         mBinding.control.action.ending.setText(mHistory.getEnding() == 0 ? getString(R.string.play_ed) : mPlayers.stringToTime(mHistory.getEnding()));
+        mHistory.setVodPic(item.getVodPic());
         mPlayers.setPlayer(getPlayer());
         setScale(getScale());
         setPlayerView();
@@ -1027,7 +1028,6 @@ private History createHistory(Vod item) {
         History history = new History();
         history.setKey(getHistoryKey());
         history.setCid(VodConfig.getCid());
-        history.setVodPic(item.getVodPic());
         history.setVodName(item.getVodName());
         history.findEpisode(item.getVodFlags());
         return history;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -110,7 +110,7 @@ private void setRecyclerView() {
 
     private List<Class> getTypes(Result result) {
         List<Class> items = new ArrayList<>();
-        for (String cate : getSite().getCategories()) for (Class item : result.getTypes()) if (Trans.s2t(cate).equals(item.getTypeName())) items.add(item);
+        for (String cate : getSite().getCategories()) for (Class item : result.getTypes()) if (cate.equals(item.getTypeName())) items.add(item);
         return items;
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/config/VodConfig.java
Patch:
@@ -187,7 +187,7 @@ private void initSite(JsonObject object) {
             if (sites.contains(site)) continue;
             site.setApi(parseApi(site.getApi()));
             site.setExt(parseExt(site.getExt()));
-            sites.add(site.sync());
+            sites.add(site.trans().sync());
         }
         for (Site site : sites) {
             if (site.getKey().equals(config.getHome())) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -52,7 +52,6 @@
 import com.fongmi.android.tv.utils.ResUtil;
 import com.fongmi.android.tv.utils.UrlUtil;
 import com.github.catvod.net.OkHttp;
-import com.github.catvod.utils.Trans;
 import com.google.common.net.HttpHeaders;
 
 import org.greenrobot.eventbus.EventBus;
@@ -160,7 +159,7 @@ private void updateHot() {
     private Result handle(Result result) {
         List<Class> types = new ArrayList<>();
         for (Class type : result.getTypes()) if (result.getFilters().containsKey(type.getTypeId())) type.setFilters(result.getFilters().get(type.getTypeId()));
-        for (String cate : getSite().getCategories()) for (Class type : result.getTypes()) if (Trans.s2t(cate).equals(type.getTypeName())) types.add(type);
+        for (String cate : getSite().getCategories()) for (Class type : result.getTypes()) if (cate.equals(type.getTypeName())) types.add(type);
         result.setTypes(types);
         return result;
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -1077,6 +1077,7 @@ public void onSeek(int time) {
 
     @Override
     public void onSeekEnd(int time) {
+        if (!mPlayers.isVod()) return;
         mBinding.widget.seek.setVisibility(View.GONE);
         mPlayers.seekTo(time);
         showProgress();

File: app/src/leanback/java/com/fongmi/android/tv/ui/base/BaseActivity.java
Patch:
@@ -16,7 +16,6 @@
 import androidx.viewbinding.ViewBinding;
 
 import com.bumptech.glide.Glide;
-import com.bumptech.glide.request.RequestOptions;
 import com.bumptech.glide.request.target.CustomTarget;
 import com.bumptech.glide.request.transition.Transition;
 import com.bumptech.glide.signature.ObjectKey;
@@ -111,7 +110,7 @@ private void refreshWall() {
     }
 
     private void loadWall(File file) {
-        Glide.with(App.get()).load(file).centerCrop().signature(new ObjectKey(file.lastModified())).apply(new RequestOptions().override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight())).into(new CustomTarget<Drawable>() {
+        Glide.with(App.get()).load(file).centerCrop().override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight()).signature(new ObjectKey(com.github.catvod.utils.Util.md5(file))).into(new CustomTarget<Drawable>() {
             @Override
             public void onResourceReady(@NonNull Drawable drawable, @Nullable Transition<? super Drawable> transition) {
                 getWindow().setBackgroundDrawable(drawable);

File: app/src/mobile/java/com/fongmi/android/tv/ui/base/BaseActivity.java
Patch:
@@ -18,7 +18,6 @@
 import androidx.viewbinding.ViewBinding;
 
 import com.bumptech.glide.Glide;
-import com.bumptech.glide.request.RequestOptions;
 import com.bumptech.glide.request.target.CustomTarget;
 import com.bumptech.glide.request.transition.Transition;
 import com.bumptech.glide.signature.ObjectKey;
@@ -28,6 +27,7 @@
 import com.fongmi.android.tv.event.RefreshEvent;
 import com.fongmi.android.tv.utils.FileUtil;
 import com.fongmi.android.tv.utils.ResUtil;
+import com.github.catvod.utils.Util;
 
 import org.greenrobot.eventbus.EventBus;
 import org.greenrobot.eventbus.Subscribe;
@@ -137,7 +137,7 @@ private void refreshWall() {
     }
 
     private void loadWall(File file) {
-        Glide.with(App.get()).load(file).centerCrop().signature(new ObjectKey(file.lastModified())).apply(new RequestOptions().override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight())).into(new CustomTarget<Drawable>() {
+        Glide.with(App.get()).load(file).centerCrop().override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight()).signature(new ObjectKey(Util.md5(file))).into(new CustomTarget<Drawable>() {
             @Override
             public void onResourceReady(@NonNull Drawable drawable, @Nullable Transition<? super Drawable> transition) {
                 getWindow().setBackgroundDrawable(drawable);

File: catvod/src/main/java/com/github/catvod/utils/Util.java
Patch:
@@ -77,9 +77,9 @@ public static String md5(File file) {
         try {
             MessageDigest digest = MessageDigest.getInstance("MD5");
             FileInputStream fis = new FileInputStream(file);
-            byte[] byteArray = new byte[1024];
+            byte[] bytes = new byte[4096];
             int count;
-            while ((count = fis.read(byteArray)) != -1) digest.update(byteArray, 0, count);
+            while ((count = fis.read(bytes)) != -1) digest.update(bytes, 0, count);
             fis.close();
             StringBuilder sb = new StringBuilder();
             for (byte b : digest.digest()) sb.append(Integer.toString((b & 0xff) + 0x100, 16).substring(1));

File: app/src/leanback/java/com/fongmi/android/tv/ui/base/BaseActivity.java
Patch:
@@ -16,10 +16,10 @@
 import androidx.viewbinding.ViewBinding;
 
 import com.bumptech.glide.Glide;
-import com.bumptech.glide.load.engine.DiskCacheStrategy;
 import com.bumptech.glide.request.RequestOptions;
 import com.bumptech.glide.request.target.CustomTarget;
 import com.bumptech.glide.request.transition.Transition;
+import com.bumptech.glide.signature.ObjectKey;
 import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.Setting;
@@ -111,7 +111,7 @@ private void refreshWall() {
     }
 
     private void loadWall(File file) {
-        Glide.with(App.get()).load(file).centerCrop().skipMemoryCache(true).diskCacheStrategy(DiskCacheStrategy.NONE).apply(new RequestOptions().override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight())).into(new CustomTarget<Drawable>() {
+        Glide.with(App.get()).load(file).centerCrop().signature(new ObjectKey(file.lastModified())).apply(new RequestOptions().override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight())).into(new CustomTarget<Drawable>() {
             @Override
             public void onResourceReady(@NonNull Drawable drawable, @Nullable Transition<? super Drawable> transition) {
                 getWindow().setBackgroundDrawable(drawable);

File: app/src/mobile/java/com/fongmi/android/tv/ui/base/BaseActivity.java
Patch:
@@ -18,10 +18,10 @@
 import androidx.viewbinding.ViewBinding;
 
 import com.bumptech.glide.Glide;
-import com.bumptech.glide.load.engine.DiskCacheStrategy;
 import com.bumptech.glide.request.RequestOptions;
 import com.bumptech.glide.request.target.CustomTarget;
 import com.bumptech.glide.request.transition.Transition;
+import com.bumptech.glide.signature.ObjectKey;
 import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.Setting;
@@ -137,7 +137,7 @@ private void refreshWall() {
     }
 
     private void loadWall(File file) {
-        Glide.with(App.get()).load(file).centerCrop().skipMemoryCache(true).diskCacheStrategy(DiskCacheStrategy.NONE).apply(new RequestOptions().override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight())).into(new CustomTarget<Drawable>() {
+        Glide.with(App.get()).load(file).centerCrop().signature(new ObjectKey(file.lastModified())).apply(new RequestOptions().override(ResUtil.getScreenWidth(), ResUtil.getScreenHeight())).into(new CustomTarget<Drawable>() {
             @Override
             public void onResourceReady(@NonNull Drawable drawable, @Nullable Transition<? super Drawable> transition) {
                 getWindow().setBackgroundDrawable(drawable);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -196,7 +196,9 @@ private void setRecyclerView() {
 
     private void setPlayerView() {
         getIjk().setPlayer(mPlayers.getPlayer());
+        mBinding.control.speed.setText(mPlayers.getSpeedText());
         mBinding.control.player.setText(mPlayers.getPlayerText());
+        mBinding.control.speed.setEnabled(mPlayers.canAdjustSpeed());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
         mBinding.control.decode.setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
@@ -210,7 +212,6 @@ private void setVideoView() {
         mPlayers.set(getExo(), getIjk());
         setScale(Setting.getLiveScale());
         setSubtitle(Setting.getSubtitle());
-        mBinding.control.speed.setText(mPlayers.getSpeedText());
         mBinding.control.invert.setActivated(Setting.isInvert());
         mBinding.control.across.setActivated(Setting.isAcross());
         mBinding.control.change.setActivated(Setting.isChange());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -218,7 +218,9 @@ private void setRecyclerView() {
 
     private void setPlayerView() {
         getIjk().setPlayer(mPlayers.getPlayer());
+        mBinding.control.action.speed.setText(mPlayers.getSpeedText());
         mBinding.control.action.player.setText(mPlayers.getPlayerText());
+        mBinding.control.action.speed.setEnabled(mPlayers.canAdjustSpeed());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
         mBinding.control.action.decode.setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
@@ -235,7 +237,6 @@ private void setVideoView() {
         setSubtitle(Setting.getSubtitle());
         getExo().getSubtitleView().setStyle(ExoUtil.getCaptionStyle());
         getIjk().getSubtitleView().setStyle(ExoUtil.getCaptionStyle());
-        mBinding.control.action.speed.setText(mPlayers.getSpeedText());
         mBinding.control.action.invert.setActivated(Setting.isInvert());
         mBinding.control.action.across.setActivated(Setting.isAcross());
         mBinding.control.action.change.setActivated(Setting.isChange());

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1199,6 +1199,7 @@ private void nextPlayer() {
     }
 
     private void onError(ErrorEvent event) {
+        Track.delete(getHistoryKey());
         showError(event.getMsg());
         mClock.setCallback(null);
         mPlayers.stop();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1218,6 +1218,7 @@ private void nextPlayer() {
 
     private void onError(ErrorEvent event) {
         mBinding.swipeLayout.setEnabled(true);
+        Track.delete(getHistoryKey());
         showError(event.getMsg());
         mClock.setCallback(null);
         mPlayers.stop();

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomSeekView.java
Patch:
@@ -90,10 +90,10 @@ private void refresh() {
             timeBar.setBufferedPosition(buffered);
         }
         if (player.isEmpty()) {
-            timeBar.setPosition(0);
-            timeBar.setDuration(0);
             positionView.setText("00:00");
             durationView.setText("00:00");
+            timeBar.setPosition(currentDuration = 0);
+            timeBar.setDuration(currentDuration = 0);
         }
         removeCallbacks(refresh);
         if (player.isPlaying()) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/CustomKeyDownLive.java
Patch:
@@ -47,7 +47,7 @@ private CustomKeyDownLive(Activity activity, View videoView) {
     public boolean onTouchEvent(MotionEvent e) {
         if (changeBright && e.getAction() == MotionEvent.ACTION_UP) listener.onBrightEnd();
         if (changeVolume && e.getAction() == MotionEvent.ACTION_UP) listener.onVolumeEnd();
-        return detector.onTouchEvent(e);
+        return e.getPointerCount() == 1 && detector.onTouchEvent(e);
     }
 
     public void setLock(boolean lock) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/CustomKeyDownVod.java
Patch:
@@ -47,7 +47,7 @@ public boolean onTouchEvent(MotionEvent e) {
         if (changeSpeed && e.getAction() == MotionEvent.ACTION_UP) listener.onSpeedEnd();
         if (changeBright && e.getAction() == MotionEvent.ACTION_UP) listener.onBrightEnd();
         if (changeVolume && e.getAction() == MotionEvent.ACTION_UP) listener.onVolumeEnd();
-        return detector.onTouchEvent(e);
+        return e.getPointerCount() == 1 && detector.onTouchEvent(e);
     }
 
     public void setLock(boolean lock) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -216,7 +216,7 @@ private void onDecode() {
     }
 
     private void onTrack(View view) {
-        TrackDialog.create().player(mPlayers).type(Integer.parseInt(view.getTag().toString())).show(this);
+        TrackDialog.create().player(mPlayers).vod(true).type(Integer.parseInt(view.getTag().toString())).show(this);
         hideControl();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -878,7 +878,7 @@ private void onDecode() {
     }
 
     private void onTrack(View view) {
-        TrackDialog.create().player(mPlayers).type(Integer.parseInt(view.getTag().toString())).show(this);
+        TrackDialog.create().player(mPlayers).vod(true).type(Integer.parseInt(view.getTag().toString())).show(this);
         hideControl();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -734,7 +734,7 @@ private void onRotate() {
     }
 
     private void onTrack(View view) {
-        TrackDialog.create().player(mPlayers).type(Integer.parseInt(view.getTag().toString())).show(this);
+        TrackDialog.create().player(mPlayers).vod(true).type(Integer.parseInt(view.getTag().toString())).show(this);
         hideControl();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -285,7 +285,7 @@ private void setLoading(boolean loading) {
     }
 
     private void setLogo() {
-        Glide.with(this).load(VodConfig.get().getConfig().getLogo()).circleCrop().override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL).listener(getListener()).into(mBinding.logo);
+        Glide.with(App.get()).load(VodConfig.get().getConfig().getLogo()).circleCrop().override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL).listener(getListener()).into(mBinding.logo);
     }
 
     private RequestListener<Drawable> getListener() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -253,7 +253,7 @@ public Result getResult() {
     }
 
     private void setLogo() {
-        Glide.with(this).load(VodConfig.get().getConfig().getLogo()).circleCrop().override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL).error(R.drawable.ic_logo).listener(getListener()).into(mBinding.logo);
+        Glide.with(App.get()).load(VodConfig.get().getConfig().getLogo()).circleCrop().override(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL).error(R.drawable.ic_logo).listener(getListener()).into(mBinding.logo);
     }
 
     private RequestListener<Drawable> getListener() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -253,22 +253,22 @@ public Result getResult() {
     }
 
     private void setLogo() {
-        Glide.with(this).load(VodConfig.get().getConfig().getLogo()).circleCrop().placeholder(R.drawable.ic_logo).error(R.drawable.ic_logo).listener(getListener()).into(mBinding.logo);
+        Glide.with(this).load(VodConfig.get().getConfig().getLogo()).circleCrop().error(R.drawable.ic_logo).listener(getListener()).into(mBinding.logo);
     }
 
     private RequestListener<Drawable> getListener() {
         return new RequestListener<>() {
             @Override
             public boolean onLoadFailed(@Nullable GlideException e, Object model, @NonNull Target<Drawable> target, boolean isFirstResource) {
-                mBinding.logo.getLayoutParams().height = ResUtil.dp2px(24);
                 mBinding.logo.getLayoutParams().width = ResUtil.dp2px(24);
+                mBinding.logo.getLayoutParams().height = ResUtil.dp2px(24);
                 return false;
             }
 
             @Override
             public boolean onResourceReady(@NonNull Drawable resource, @NonNull Object model, Target<Drawable> target, @NonNull DataSource dataSource, boolean isFirstResource) {
-                mBinding.logo.getLayoutParams().height = ResUtil.dp2px(36);
                 mBinding.logo.getLayoutParams().width = ResUtil.dp2px(36);
+                mBinding.logo.getLayoutParams().height = ResUtil.dp2px(36);
                 return false;
             }
         };

File: app/src/leanback/java/com/fongmi/android/tv/ui/dialog/SiteDialog.java
Patch:
@@ -61,7 +61,7 @@ private boolean list() {
     }
 
     private int getCount() {
-        return list() ? 1 : Math.max(1, Math.min((int) (Math.ceil(adapter.getItemCount() / 20.0f)), 3));
+        return list() ? 1 : Math.max(2, Math.min((int) (Math.ceil(adapter.getItemCount() / 20.0f)), 3));
     }
 
     private int getIcon() {

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomWebView.java
Patch:
@@ -26,6 +26,7 @@
 import com.fongmi.android.tv.impl.ParseCallback;
 import com.fongmi.android.tv.utils.Sniffer;
 import com.github.catvod.crawler.Spider;
+import com.github.catvod.net.OkCookieJar;
 import com.google.common.net.HttpHeaders;
 import com.orhanobut.logger.Logger;
 
@@ -95,7 +96,7 @@ private void start(String url, Map<String, String> headers) {
 
     private void checkHeader(String url, Map<String, String> headers) {
         for (String key : headers.keySet()) {
-            if (HttpHeaders.COOKIE.equalsIgnoreCase(key)) CookieManager.getInstance().setCookie(url, headers.get(key));
+            if (HttpHeaders.COOKIE.equalsIgnoreCase(key)) OkCookieJar.sync(url, headers.get(key));
             if (HttpHeaders.USER_AGENT.equalsIgnoreCase(key)) getSettings().setUserAgentString(headers.get(key));
         }
     }

File: quickjs/src/main/java/com/fongmi/quickjs/utils/Connect.java
Patch:
@@ -1,6 +1,7 @@
 package com.fongmi.quickjs.utils;
 
 import com.fongmi.quickjs.bean.Req;
+import com.github.catvod.net.OkCookieJar;
 import com.github.catvod.net.OkHttp;
 import com.github.catvod.utils.Json;
 import com.github.catvod.utils.Util;
@@ -25,6 +26,7 @@
 public class Connect {
 
     public static Call to(String url, Req req) {
+        OkCookieJar.sync(url, req.getHeader().get(HttpHeaders.COOKIE));
         OkHttpClient client = OkHttp.client(req.isRedirect(), req.getTimeout());
         return client.newCall(getRequest(url, req, Headers.of(req.getHeader())));
     }

File: app/src/main/java/com/fongmi/android/tv/utils/M3U8.java
Patch:
@@ -32,16 +32,15 @@ public static String get(String url, Map<String, String> headers) {
         try {
             if (TextUtils.isEmpty(url)) return "";
             Response response = OkHttp.newCall(url, getHeader(headers)).execute();
-            if (response.header(HttpHeaders.ACCEPT_RANGES) != null) return "";
+            if (response.header(HttpHeaders.ACCEPT_RANGES) != null && !url.contains(".m3u8")) return "";
             String result = response.body().string();
             Matcher matcher = Pattern.compile("#EXT-X-STREAM-INF(.*)\\n?(.*)").matcher(result.replaceAll("\r\n", "\n"));
             if (matcher.find() && matcher.groupCount() > 1) return get(UriUtil.resolve(url, matcher.group(2)), headers);
             StringBuilder sb = new StringBuilder();
             for (String line : result.split("\n")) sb.append(shouldResolve(line) ? resolve(url, line) : line).append("\n");
             List<String> ads = Sniffer.getRegex(Uri.parse(url));
             return clean(sb.toString(), ads);
-        } catch (Exception e) {
-            e.printStackTrace();
+        } catch (Throwable ignored) {
             return "";
         }
     }

File: app/src/main/java/com/fongmi/android/tv/api/config/LiveConfig.java
Patch:
@@ -177,7 +177,7 @@ private void setKeep(List<Group> items) {
 
     private int[] getKeep(List<Group> items) {
         String[] splits = Setting.getKeep().split(AppDatabase.SYMBOL);
-        if (splits.length < 4 || !home.getName().equals(splits[0])) return new int[]{1, 0};
+        if (splits.length < 4 || !getHome().getName().equals(splits[0])) return new int[]{1, 0};
         for (int i = 0; i < items.size(); i++) {
             Group group = items.get(i);
             if (group.getName().equals(splits[1])) {

File: app/src/main/java/com/fongmi/android/tv/bean/Device.java
Patch:
@@ -34,7 +34,7 @@ public class Device {
 
     public static Device get() {
         Device device = new Device();
-        device.setUuid(Util.getDeviceId());
+        device.setUuid(Util.getAndroidId());
         device.setName(Util.getDeviceName());
         device.setIp(Server.get().getAddress());
         device.setType(Product.getDeviceType());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -802,7 +802,7 @@ private void onDecode() {
     private void onEnding() {
         long current = mPlayers.getPosition();
         long duration = mPlayers.getDuration();
-        if (current < 0 || current < duration / 2) return;
+        if (current < 0 || duration < 0 || current < duration / 2) return;
         mHistory.setEnding(duration - current);
         mBinding.control.action.ending.setText(mPlayers.stringToTime(mHistory.getEnding()));
         setR1Callback();
@@ -818,7 +818,7 @@ private boolean onEndingReset() {
     private void onOpening() {
         long current = mPlayers.getPosition();
         long duration = mPlayers.getDuration();
-        if (current < 0 || current > duration / 2) return;
+        if (current < 0 || duration < 0 || current > duration / 2) return;
         mHistory.setOpening(current);
         mBinding.control.action.opening.setText(mPlayers.stringToTime(mHistory.getOpening()));
         setR1Callback();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -886,7 +886,7 @@ private void enterFullscreen() {
     private void exitFullscreen() {
         if (!isFullscreen()) return;
         setRequestedOrientation(isPort() ? ActivityInfo.SCREEN_ORIENTATION_USER_PORTRAIT : ActivityInfo.SCREEN_ORIENTATION_FULL_USER);
-        mBinding.episode.scrollToPosition(mEpisodeAdapter.getPosition());
+        App.post(() -> mBinding.episode.scrollToPosition(mEpisodeAdapter.getPosition()), 50);
         mBinding.control.full.setVisibility(View.VISIBLE);
         mBinding.video.setLayoutParams(mFrameParams);
         setRotate(false, false);

File: catvod/src/main/java/com/github/catvod/net/OkCookieJar.java
Patch:
@@ -30,7 +30,7 @@ public synchronized List<Cookie> loadForRequest(@NonNull HttpUrl url) {
     }
 
     @Override
-    public synchronized void saveFromResponse(@NonNull HttpUrl url, List<Cookie> cookies) {
+    public synchronized void saveFromResponse(@NonNull HttpUrl url, @NonNull List<Cookie> cookies) {
         try {
             for (Cookie cookie : cookies) CookieManager.getInstance().setCookie(url.toString(), cookie.toString());
         } catch (Throwable ignored) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/FlagPresenter.java
Patch:
@@ -6,6 +6,7 @@
 import androidx.annotation.NonNull;
 import androidx.leanback.widget.Presenter;
 
+import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.bean.Flag;
 import com.fongmi.android.tv.databinding.AdapterFlagBinding;
 
@@ -16,6 +17,7 @@ public class FlagPresenter extends Presenter {
 
     public FlagPresenter(OnClickListener listener) {
         this.mListener = listener;
+        this.nextFocusDown = R.id.episode;
     }
 
     public interface OnClickListener {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomEditText.java
Patch:
@@ -43,8 +43,8 @@ public boolean isFocused() {
 
     @Override
     public boolean onKeyDown(int keyCode, KeyEvent event) {
-        View view = focusSearch(event);
-        if (view != null) view.requestFocus();
+        View v = focusSearch(event);
+        if (v != null) return v.requestFocus();
         return super.onKeyDown(keyCode, event);
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/config/VodConfig.java
Patch:
@@ -374,6 +374,6 @@ public void setHome(Site home) {
     private void setWall(String wall) {
         this.wall = wall;
         boolean load = !TextUtils.isEmpty(wall) && WallConfig.get().needSync(wall);
-        if (load) WallConfig.get().config(Config.find(wall, config.getName(), 2).save());
+        if (load) WallConfig.get().config(Config.find(wall, config.getName(), 2).update());
     }
 }
\ No newline at end of file

File: app/src/main/java/com/fongmi/android/tv/db/AppDatabase.java
Patch:
@@ -80,9 +80,9 @@ public static void restore(com.fongmi.android.tv.impl.Callback callback) {
             File wal = new File(Path.tv(), NAME + "-wal");
             File shm = new File(Path.tv(), NAME + "-shm");
             File pref = new File(Path.tv(), NAME + "-pref");
-            if (db.exists()) Path.move(db, App.get().getDatabasePath(db.getName()).getAbsoluteFile());
-            if (wal.exists()) Path.move(wal, App.get().getDatabasePath(wal.getName()).getAbsoluteFile());
-            if (shm.exists()) Path.move(shm, App.get().getDatabasePath(shm.getName()).getAbsoluteFile());
+            if (db.exists()) Path.copy(db, App.get().getDatabasePath(db.getName()).getAbsoluteFile());
+            if (wal.exists()) Path.copy(wal, App.get().getDatabasePath(wal.getName()).getAbsoluteFile());
+            if (shm.exists()) Path.copy(shm, App.get().getDatabasePath(shm.getName()).getAbsoluteFile());
             if (pref.exists()) Prefers.restore(pref);
             App.post(callback::success);
         });

File: catvod/src/main/java/com/github/catvod/utils/Prefers.java
Patch:
@@ -100,8 +100,6 @@ public static void restore(File file) {
             for (Map.Entry<String, ?> entry : map.entrySet()) Prefers.put(entry.getKey(), convert(entry));
         } catch (Exception e) {
             e.printStackTrace();
-        } finally {
-            Path.clear(file);
         }
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/cast/CastVideo.java
Patch:
@@ -1,5 +1,7 @@
 package com.fongmi.android.tv.cast;
 
+import android.net.Uri;
+
 import com.fongmi.android.tv.server.Server;
 import com.github.catvod.utils.Path;
 import com.github.catvod.utils.Util;
@@ -15,6 +17,7 @@ public static CastVideo get(String name, String url) {
 
     private CastVideo(String name, String url) {
         if (url.startsWith("file")) url = Server.get().getAddress() + "/" + url.replace(Path.rootPath(), "");
+        if (url.startsWith("http://127.0.0.1:7777")) url = Uri.parse(url).getQueryParameter("url");
         if (url.contains("127.0.0.1")) url = url.replace("127.0.0.1", Util.getIp());
         this.name = name;
         this.url = url;

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/CastDialog.java
Patch:
@@ -1,5 +1,6 @@
 package com.fongmi.android.tv.ui.dialog;
 
+import android.net.Uri;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
@@ -78,6 +79,7 @@ public CastDialog history(History history) {
         String fd = history.getVodId();
         if (fd.startsWith("/")) fd = Server.get().getAddress() + "/file" + fd.replace(Path.rootPath(), "");
         if (fd.startsWith("file")) fd = Server.get().getAddress() + "/" + fd.replace(Path.rootPath(), "");
+        if (fd.startsWith("http://127.0.0.1:7777")) fd = Uri.parse(fd).getQueryParameter("url");
         if (fd.contains("127.0.0.1")) fd = fd.replace("127.0.0.1", Util.getIp());
         body.add("history", history.toString().replace(id, fd));
         return this;

File: app/src/main/java/com/fongmi/android/tv/api/config/VodConfig.java
Patch:
@@ -249,6 +249,7 @@ public void setRecent(Site site) {
     }
 
     public void setRecent(String jar) {
+        if (jarLoader == null) jarLoader = new JarLoader();
         jarLoader.parseJar(Util.md5(jar), jar);
         jarLoader.setRecent(jar);
     }

File: app/src/main/java/com/fongmi/android/tv/bean/History.java
Patch:
@@ -272,7 +272,8 @@ private void checkParam(History item) {
 
     private void merge(List<History> items, boolean force) {
         for (History item : items) {
-            if (!force && (getKey().equals(item.getKey()) || Math.abs(item.getDuration() - getDuration()) > 10 * 60 * 1000)) continue;
+            if (getDuration() > 0 && item.getDuration() > 0 && Math.abs(getDuration() - item.getDuration()) > 10 * 60 * 1000) continue;
+            if (!force && getKey().equals(item.getKey())) continue;
             checkParam(item);
             item.delete();
         }

File: app/src/main/java/com/fongmi/android/tv/utils/Download.java
Patch:
@@ -40,10 +40,10 @@ public void start() {
 
     private void doInBackground() {
         try {
-            Path.clear(file);
+            Path.create(file);
             Response response = OkHttp.newCall(url).execute();
             download(response.body().byteStream(), Double.parseDouble(response.header(HttpHeaders.CONTENT_LENGTH, "1")));
-            if (callback != null) App.post(() -> callback.success(Path.chmod(file)));
+            if (callback != null) App.post(() -> callback.success(file));
         } catch (Exception e) {
             if (callback != null) App.post(() -> callback.error(e.getMessage()));
         }

File: app/src/main/java/com/fongmi/android/tv/bean/Channel.java
Patch:
@@ -333,6 +333,7 @@ public Map<String, String> getHeaders() {
 
     public Channel copy(Channel item) {
         setPlayerType(item.getPlayerType());
+        setCatchup(item.getCatchup());
         setReferer(item.getReferer());
         setHeader(item.getHeader());
         setNumber(item.getNumber());

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -291,7 +291,7 @@ private Group setWidth(Group group) {
         int padding = ResUtil.dp2px(60);
         if (group.isKeep()) group.setWidth(0);
         if (group.getWidth() == 0) for (Channel item : group.getChannel()) group.setWidth(Math.max(group.getWidth(), (item.getLogo().isEmpty() ? 0 : logo) + ResUtil.getTextWidth(item.getNumber() + item.getName(), 16)));
-        mBinding.channel.getLayoutParams().width = group.getWidth() == 0 ? 0 : Math.min(group.getWidth() + padding, ResUtil.getScreenWidth() / 2);
+        mBinding.channel.getLayoutParams().width = group.getWidth() == 0 ? 0 : Math.min(group.getWidth() + padding, ResUtil.getScreenWidth() / 3);
         return group;
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/dialog/LiveDialog.java
Patch:
@@ -49,7 +49,6 @@ private void setRecyclerView() {
         binding.recycler.setHasFixedSize(true);
         binding.recycler.setItemAnimator(null);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
-        binding.recycler.setLayoutManager(new GridLayoutManager(dialog.getContext(), 1));
         binding.recycler.post(() -> binding.recycler.scrollToPosition(LiveConfig.getHomeIndex()));
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/extractor/JianPian.java
Patch:
@@ -46,7 +46,9 @@ private void start(String url) {
     @Override
     public void stop() {
         try {
-            if (p2p != null) p2p.P2Pdoxpause(path.getBytes("GBK"));
+            if (p2p == null || path == null) return;
+            p2p.P2Pdoxpause(path.getBytes("GBK"));
+            path = null;
         } catch (Exception e) {
             e.printStackTrace();
         }

File: app/src/main/java/com/fongmi/android/tv/api/Decoder.java
Patch:
@@ -34,7 +34,7 @@ public static String getJson(String url) throws Exception {
 
     private static String fix(String url, String data) {
         if (url.startsWith("file") || url.startsWith("assets")) url = UrlUtil.convert(url);
-        data = data.replace("./", url.substring(0, url.lastIndexOf("/") + 1));
+        data = data.replace("./", url.substring(0, url.split("\\?")[0].lastIndexOf("/") + 1));
         return data;
     }
 

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -253,7 +253,7 @@ private String fetchExt(Site site) throws IOException {
     }
 
     private Result fetchPic(Site site, Result result) throws Exception {
-        if (result.getList().isEmpty() || result.getList().get(0).getVodPic().length() > 0) return result;
+        if (site.getType() > 2 || result.getList().isEmpty() || result.getList().get(0).getVodPic().length() > 0) return result;
         ArrayList<String> ids = new ArrayList<>();
         for (Vod item : result.getList()) ids.add(item.getVodId());
         ArrayMap<String, String> params = new ArrayMap<>();

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/GroupAdapter.java
Patch:
@@ -24,6 +24,8 @@ public GroupAdapter(OnClickListener listener) {
 
     public interface OnClickListener {
 
+        void setWidth(Group item);
+
         void onItemClick(Group item);
     }
 
@@ -59,6 +61,7 @@ public int indexOf(Group group) {
     public void setSelected(int position) {
         for (int i = 0; i < mItems.size(); i++) mItems.get(i).setSelected(i == position);
         notifyItemRangeChanged(0, getItemCount());
+        mListener.setWidth(mItems.get(position));
     }
 
     public void setSelected(Group group) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -275,15 +275,15 @@ private void setGroup(Live live) {
 
     private void setWidth(Live live) {
         int padding = ResUtil.dp2px(48);
-        for (Group item : live.getGroups()) live.setWidth(Math.max(live.getWidth(), ResUtil.getTextWidth(item.getName(), 16)));
-        mBinding.group.getLayoutParams().width = live.getWidth() == 0 ? 0 : Math.min(live.getWidth() + padding, ResUtil.dp2px(180));
+        if (live.getWidth() == 0) for (Group item : live.getGroups()) live.setWidth(Math.max(live.getWidth(), ResUtil.getTextWidth(item.getName(), 16)));
+        mBinding.group.getLayoutParams().width = live.getWidth() == 0 ? 0 : Math.min(live.getWidth() + padding, ResUtil.getScreenWidth() / 4);
         mBinding.divide.setVisibility(live.getWidth() == 0 ? View.GONE : View.VISIBLE);
     }
 
     private void setWidth(Group group) {
         int logo = ResUtil.dp2px(60);
         int padding = ResUtil.dp2px(60);
-        for (Channel item : group.getChannel()) group.setWidth(Math.max(group.getWidth(), (item.getLogo().isEmpty() ? 0 : logo) + ResUtil.getTextWidth(item.getNumber() + item.getName(), 16)));
+        if (group.getWidth() == 0) for (Channel item : group.getChannel()) group.setWidth(Math.max(group.getWidth(), (item.getLogo().isEmpty() ? 0 : logo) + ResUtil.getTextWidth(item.getNumber() + item.getName(), 16)));
         mBinding.channel.getLayoutParams().width = Math.min(group.getWidth() + padding, ResUtil.getScreenWidth() / 2);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/ChannelPresenter.java
Patch:
@@ -36,6 +36,7 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         item.loadLogo(holder.binding.logo);
         holder.binding.name.setText(item.getName());
         holder.binding.number.setText(item.getNumber());
+        holder.binding.getRoot().setSelected(item.isSelected());
         setOnClickListener(holder, view -> mListener.onItemClick(item));
         holder.view.setOnLongClickListener(view -> mListener.onLongClick(item));
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1717,7 +1717,7 @@ protected void onDestroy() {
         Timer.get().reset();
         Source.get().stop();
         RefreshEvent.history();
-        App.removeCallbacks(mR1, mR2, mR3, mR4);
+        App.removeCallbacks(mR0, mR1, mR2, mR3, mR4);
         mViewModel.result.removeObserver(mObserveDetail);
         mViewModel.player.removeObserver(mObservePlayer);
         mViewModel.search.removeObserver(mObserveSearch);

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/ChannelPresenter.java
Patch:
@@ -36,7 +36,6 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         item.loadLogo(holder.binding.logo);
         holder.binding.name.setText(item.getName());
         holder.binding.number.setText(item.getNumber());
-        holder.binding.getRoot().setSelected(item.isSelected());
         setOnClickListener(holder, view -> mListener.onItemClick(item));
         holder.view.setOnLongClickListener(view -> mListener.onLongClick(item));
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -160,6 +160,7 @@ protected void initView(Bundle savedInstanceState) {
         mKeyDown = CustomKeyDownLive.create(this, mBinding.video);
         mClock = Clock.create(mBinding.widget.time);
         setPadding(mBinding.control.getRoot());
+        setPadding(mBinding.widget.epg, true);
         setPadding(mBinding.recycler, true);
         mPlayers = new Players().init(this);
         mObserveEpg = this::setEpg;
@@ -1025,6 +1026,7 @@ public void onSingleTap() {
     @Override
     public void onDoubleTap() {
         if (isVisible(mBinding.recycler)) hideUI();
+        else if (isVisible(mBinding.widget.epg)) hideEpg();
         else if (isVisible(mBinding.control.getRoot())) hideControl();
         else showControl();
     }

File: catvod/src/main/java/com/github/catvod/utils/Json.java
Patch:
@@ -18,7 +18,7 @@ public class Json {
     public static JsonElement parse(String json) {
         try {
             return JsonParser.parseString(json);
-        } catch (Exception e) {
+        } catch (Throwable e) {
             return new JsonParser().parse(json);
         }
     }

File: app/src/main/java/com/fongmi/android/tv/player/ParseJob.java
Patch:
@@ -11,6 +11,7 @@
 import com.github.catvod.net.OkHttp;
 import com.github.catvod.utils.Json;
 import com.google.common.net.HttpHeaders;
+import com.google.gson.JsonElement;
 import com.google.gson.JsonObject;
 
 import java.util.ArrayList;
@@ -187,7 +188,7 @@ private void startWeb(String key, String from, Map<String, String> headers, Stri
 
     private Map<String, String> getHeader(JsonObject object) {
         Map<String, String> headers = new HashMap<>();
-        for (String key : object.keySet()) if (key.equalsIgnoreCase(HttpHeaders.USER_AGENT) || key.equalsIgnoreCase(HttpHeaders.REFERER)) headers.put(UrlUtil.fixHeader(key), object.get(key).getAsString());
+        for (Map.Entry<String, JsonElement> entry : object.entrySet()) if (entry.getKey().equalsIgnoreCase(HttpHeaders.USER_AGENT) || entry.getKey().equalsIgnoreCase(HttpHeaders.REFERER)) headers.put(UrlUtil.fixHeader(entry.getKey()), object.get(entry.getKey()).getAsString());
         if (headers.isEmpty()) return parse.getHeaders();
         return headers;
     }

File: catvod/src/main/java/com/github/catvod/utils/Json.java
Patch:
@@ -72,14 +72,14 @@ public static JsonObject safeObject(JsonElement element) {
     public static Map<String, String> toMap(JsonElement element) {
         Map<String, String> map = new HashMap<>();
         JsonObject object = safeObject(element);
-        for (String key : object.keySet()) map.put(key, safeString(object, key));
+        for (Map.Entry<String, JsonElement> entry : object.entrySet()) map.put(entry.getKey(), safeString(object, entry.getKey()));
         return map;
     }
 
     public static ArrayMap<String, String> toArrayMap(JsonElement element) {
         ArrayMap<String, String> map = new ArrayMap<>();
         JsonObject object = safeObject(element);
-        for (String key : object.keySet()) map.put(key, safeString(object, key));
+        for (Map.Entry<String, JsonElement> entry : object.entrySet()) map.put(entry.getKey(), safeString(object, entry.getKey()));
         return map;
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -12,7 +12,6 @@
 import com.github.catvod.net.OkHttp;
 import com.github.catvod.utils.Json;
 import com.github.catvod.utils.Path;
-import com.google.gson.JsonParser;
 
 import java.util.Arrays;
 import java.util.HashMap;
@@ -240,8 +239,8 @@ private void type(String line) {
 
         private void header(String line) {
             try {
-                if (line.contains("#EXTHTTP:")) header = Json.toMap(JsonParser.parseString(line.split("#EXTHTTP:")[1].trim()));
-                if (line.contains("header=")) header = Json.toMap(JsonParser.parseString(line.split("header=")[1].trim()));
+                if (line.contains("#EXTHTTP:")) header = Json.toMap(Json.parse(line.split("#EXTHTTP:")[1].trim()));
+                if (line.contains("header=")) header = Json.toMap(Json.parse(line.split("header=")[1].trim()));
             } catch (Exception e) {
                 header = null;
             }

File: app/src/main/java/com/fongmi/android/tv/api/config/LiveConfig.java
Patch:
@@ -20,7 +20,6 @@
 import com.github.catvod.utils.Json;
 import com.google.gson.JsonElement;
 import com.google.gson.JsonObject;
-import com.google.gson.JsonParser;
 
 import java.util.ArrayList;
 import java.util.List;
@@ -112,7 +111,7 @@ private void parseConfig(String text, Callback callback) {
         if (Json.invalid(text)) {
             parseText(text, callback);
         } else {
-            checkJson(JsonParser.parseString(text).getAsJsonObject(), callback);
+            checkJson(Json.parse(text).getAsJsonObject(), callback);
         }
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/config/VodConfig.java
Patch:
@@ -23,7 +23,6 @@
 import com.github.catvod.utils.Json;
 import com.google.gson.JsonElement;
 import com.google.gson.JsonObject;
-import com.google.gson.JsonParser;
 
 import org.json.JSONObject;
 
@@ -129,7 +128,7 @@ public void load(Callback callback) {
 
     private void loadConfig(Callback callback) {
         try {
-            checkJson(JsonParser.parseString(Decoder.getJson(config.getUrl())).getAsJsonObject(), callback);
+            checkJson(Json.parse(Decoder.getJson(config.getUrl())).getAsJsonObject(), callback);
         } catch (Throwable e) {
             if (TextUtils.isEmpty(config.getUrl())) App.post(() -> callback.error(""));
             else loadCache(callback, e);
@@ -138,7 +137,7 @@ private void loadConfig(Callback callback) {
     }
 
     private void loadCache(Callback callback, Throwable e) {
-        if (!TextUtils.isEmpty(config.getJson())) checkJson(JsonParser.parseString(config.getJson()).getAsJsonObject(), callback);
+        if (!TextUtils.isEmpty(config.getJson())) checkJson(Json.parse(config.getJson()).getAsJsonObject(), callback);
         else App.post(() -> callback.error(Notify.getError(R.string.error_config_get, e)));
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ParseJob.java
Patch:
@@ -12,7 +12,6 @@
 import com.github.catvod.utils.Json;
 import com.google.common.net.HttpHeaders;
 import com.google.gson.JsonObject;
-import com.google.gson.JsonParser;
 
 import java.util.ArrayList;
 import java.util.HashMap;
@@ -107,7 +106,7 @@ private void doInBackground(String key, String webUrl, String flag) throws Throw
 
     private void jsonParse(Parse item, String webUrl, boolean error) throws Exception {
         String body = OkHttp.newCall(item.getUrl() + webUrl, Headers.of(item.getHeaders())).execute().body().string();
-        JsonObject object = JsonParser.parseString(body).getAsJsonObject();
+        JsonObject object = Json.parse(body).getAsJsonObject();
         object = object.has("data") ? object.getAsJsonObject("data") : object;
         boolean illegal = body.contains("不存在") || body.contains("已过期");
         String url = illegal ? "" : Json.safeString(object, "url");

File: app/src/main/java/com/fongmi/android/tv/player/extractor/BiliBili.java
Patch:
@@ -4,9 +4,9 @@
 
 import com.fongmi.android.tv.player.Source;
 import com.github.catvod.net.OkHttp;
+import com.github.catvod.utils.Json;
 import com.github.catvod.utils.Util;
 import com.google.common.net.HttpHeaders;
-import com.google.gson.JsonParser;
 
 import okhttp3.Headers;
 
@@ -22,7 +22,7 @@ public String fetch(String url) throws Exception {
         String room = Uri.parse(url).getPath().replace("/", "");
         String api = String.format("https://api.live.bilibili.com/room/v1/Room/playUrl?cid=%s&qn=20000&platform=h5", room);
         String result = OkHttp.newCall(api, Headers.of(HttpHeaders.USER_AGENT, Util.CHROME)).execute().body().string();
-        return JsonParser.parseString(result).getAsJsonObject().get("data").getAsJsonObject().get("durl").getAsJsonArray().get(0).getAsJsonObject().get("url").getAsString();
+        return Json.parse(result).getAsJsonObject().get("data").getAsJsonObject().get("durl").getAsJsonArray().get(0).getAsJsonObject().get("url").getAsString();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -26,7 +26,6 @@
 import com.fongmi.android.tv.Setting;
 import com.github.catvod.utils.Json;
 import com.google.common.net.HttpHeaders;
-import com.google.gson.JsonParser;
 
 import java.io.ByteArrayOutputStream;
 import java.util.Map;
@@ -88,7 +87,7 @@ public static Object getUrl(String url) {
     }
 
     private static void addHeader(LazyHeaders.Builder builder, String header) {
-        Map<String, String> map = Json.toMap(JsonParser.parseString(header));
+        Map<String, String> map = Json.toMap(Json.parse(header));
         for (Map.Entry<String, String> entry : map.entrySet()) builder.addHeader(UrlUtil.fixHeader(entry.getKey()), entry.getValue());
     }
 

File: pyramid/src/main/java/com/undcover/freedom/pyramid/Spider.java
Patch:
@@ -11,7 +11,6 @@
 import com.google.common.net.HttpHeaders;
 import com.google.gson.Gson;
 import com.google.gson.JsonObject;
-import com.google.gson.JsonParser;
 
 import java.io.ByteArrayInputStream;
 import java.util.HashMap;
@@ -91,7 +90,7 @@ public boolean isVideoFormat(String url) {
     @Override
     public Object[] proxyLocal(Map<String, String> params) throws Exception {
         List<PyObject> list = app.callAttr("localProxy", obj, gson.toJson(params)).asList();
-        JsonObject action = JsonParser.parseString(list.get(2).toString()).getAsJsonObject();
+        JsonObject action = Json.parse(list.get(2).toString()).getAsJsonObject();
         Map<String, String> headers = Json.toMap(action.get("header"));
         String url = action.get("url").getAsString();
         String content = list.get(3).toString();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -275,7 +275,7 @@ private void setGroup(Live live) {
 
     private void setWidth(Live live) {
         for (Group item : live.getGroups()) live.setWidth(Math.max(live.getWidth(), ResUtil.getTextWidth(item.getName(), 16)));
-        mBinding.group.getLayoutParams().width = live.getWidth() == 0 ? 0 : Math.min(live.getWidth() + ResUtil.dp2px(50), ResUtil.dp2px(200));
+        mBinding.group.getLayoutParams().width = live.getWidth() == 0 ? 0 : Math.min(live.getWidth() + ResUtil.dp2px(50), ResUtil.dp2px(180));
         mBinding.channel.getLayoutParams().width = live.getLogo().isEmpty() ? ResUtil.dp2px(200) : ResUtil.dp2px(260);
         mBinding.divide.setVisibility(live.getWidth() == 0 ? View.GONE : View.VISIBLE);
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -304,7 +304,7 @@ private void setGroup(Live live) {
     private void setWidth(Live live) {
         for (Group item : live.getGroups()) live.setWidth(Math.max(live.getWidth(), ResUtil.getTextWidth(item.getName(), 14)));
         mBinding.group.getLayoutParams().width = live.getWidth() == 0 ? 0 : Math.min(live.getWidth() + ResUtil.dp2px(44), ResUtil.dp2px(180));
-        mBinding.channel.getLayoutParams().width = live.getLogo().isEmpty() ? ResUtil.dp2px(180) : ResUtil.dp2px(236);
+        mBinding.channel.getLayoutParams().width = live.getLogo().isEmpty() ? ResUtil.dp2px(200) : ResUtil.dp2px(260);
         mBinding.divide.setVisibility(live.getWidth() == 0 ? View.GONE : View.VISIBLE);
     }
 

File: catvod/src/main/java/com/github/catvod/utils/Path.java
Patch:
@@ -101,7 +101,9 @@ public static File js(String name) {
     }
 
     public static File jar(String name) {
-        return new File(jar(), Util.md5(name).concat(".jar"));
+        File file = new File(jar(), Util.md5(name).concat(".jar"));
+        file.setReadOnly();
+        return file;
     }
 
     public static File thunder(String name) {

File: app/src/main/java/com/fongmi/android/tv/bean/Flag.java
Patch:
@@ -112,8 +112,8 @@ public Episode find(String remarks, boolean strict) {
         if (getEpisodes().size() == 1) return getEpisodes().get(0);
         for (Episode item : getEpisodes()) if (item.rule1(remarks)) return item;
         for (Episode item : getEpisodes()) if (item.rule2(number)) return item;
-        for (Episode item : getEpisodes()) if (item.rule3(remarks)) return item;
-        for (Episode item : getEpisodes()) if (item.rule4(remarks)) return item;
+        if (number == -1) for (Episode item : getEpisodes()) if (item.rule3(remarks)) return item;
+        if (number == -1) for (Episode item : getEpisodes()) if (item.rule4(remarks)) return item;
         if (getPosition() != -1) return getEpisodes().get(getPosition());
         return strict ? null : getEpisodes().get(0);
     }

File: app/src/main/java/com/fongmi/android/tv/utils/Util.java
Patch:
@@ -79,7 +79,7 @@ public static void copy(String text) {
     public static int getDigit(String text) {
         try {
             if (text.startsWith("上") || text.startsWith("下")) return -1;
-            return Integer.parseInt(text.replaceAll("(mp4|H264|H265|720p|1080p|2160p|4k|4K)", "").replaceAll("\\D+", ""));
+            return Integer.parseInt(text.replaceAll("(?i)(mp4|H264|H265|720p|1080p|2160p|4K)", "").replaceAll("\\D+", ""));
         } catch (Exception e) {
             return -1;
         }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -746,13 +746,14 @@ private void onLoop() {
     }
 
     private void onDanmu() {
+        if (mPlayers.isEnd()) return;
         Setting.putDanmu(!Setting.isDanmu());
         mBinding.control.danmu.setActivated(Setting.isDanmu());
         showDanmu();
     }
 
     private void showDanmu() {
-        if (!mPlayers.isEnd() && Setting.isDanmu()) mBinding.danmaku.show();
+        if (Setting.isDanmu()) mBinding.danmaku.show();
         else mBinding.danmaku.hide();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -723,13 +723,14 @@ private void onKeep() {
     }
 
     private void onDanmu() {
+        if (mPlayers.isEnd()) return;
         Setting.putDanmu(!Setting.isDanmu());
         checkDanmuImg();
         showDanmu();
     }
 
     private void showDanmu() {
-        if (!mPlayers.isEnd() && Setting.isDanmu()) mBinding.danmaku.show();
+        if (Setting.isDanmu()) mBinding.danmaku.show();
         else mBinding.danmaku.hide();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -752,7 +752,7 @@ private void onDanmu() {
     }
 
     private void showDanmu() {
-        if (Setting.isDanmu()) mBinding.danmaku.show();
+        if (!mPlayers.isEnd() && Setting.isDanmu()) mBinding.danmaku.show();
         else mBinding.danmaku.hide();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -729,7 +729,7 @@ private void onDanmu() {
     }
 
     private void showDanmu() {
-        if (Setting.isDanmu()) mBinding.danmaku.show();
+        if (!mPlayers.isEnd() && Setting.isDanmu()) mBinding.danmaku.show();
         else mBinding.danmaku.hide();
     }
 

File: app/src/main/java/com/fongmi/android/tv/Setting.java
Patch:
@@ -322,7 +322,7 @@ public static boolean isBackgroundOff() {
     }
 
     public static boolean isBackgroundOn() {
-        return getBackground() == 1;
+        return getBackground() == 1 || getBackground() == 2;
     }
 
     public static boolean isBackgroundPiP() {

File: app/src/main/java/com/fongmi/android/tv/server/process/Action.java
Patch:
@@ -190,7 +190,7 @@ private void syncKeep(Map<String, String> params) {
         List<Config> configs = Config.arrayFrom(params.get("configs"));
         List<Keep> targets = Keep.arrayFrom(params.get("targets"));
         boolean replace = Objects.equals(params.get("mode"), "1");
-        if (VodConfig.getUrl().isEmpty() && configs.size() > 0) {
+        if (TextUtils.isEmpty(VodConfig.getUrl()) && configs.size() > 0) {
             VodConfig.load(Config.find(configs.get(0), 0), getCallback(configs, targets));
         } else {
             if (replace) Keep.deleteAll();

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/CastDialog.java
Patch:
@@ -69,8 +69,8 @@ public static CastDialog create() {
     public CastDialog() {
         client = OkHttp.client(Constant.TIMEOUT_SYNC);
         body = new FormBody.Builder();
-        body.add("url", VodConfig.getUrl());
         body.add("device", Device.get().toString());
+        if (VodConfig.getUrl() != null) body.add("url", VodConfig.getUrl());
     }
 
     public CastDialog history(History history) {

File: app/src/main/java/com/fongmi/android/tv/utils/M3U8.java
Patch:
@@ -1,6 +1,7 @@
 package com.fongmi.android.tv.utils;
 
 import android.net.Uri;
+import android.text.TextUtils;
 
 import androidx.media3.common.util.UriUtil;
 
@@ -29,10 +30,11 @@ public class M3U8 {
 
     public static String get(String url, Map<String, String> headers) {
         try {
+            if (TextUtils.isEmpty(url)) return "";
             Response response = OkHttp.newCall(url, getHeader(headers)).execute();
             if (response.header(HttpHeaders.ACCEPT_RANGES) != null) return "";
             String result = response.body().string();
-            Matcher matcher = Pattern.compile("#EXT-X-STREAM-INF(.*)\\n?(.*)").matcher(result);
+            Matcher matcher = Pattern.compile("#EXT-X-STREAM-INF(.*)\\n?(.*)").matcher(result.replaceAll("\r\n", "\n"));
             if (matcher.find() && matcher.groupCount() > 1) return get(UriUtil.resolve(url, matcher.group(2)), headers);
             StringBuilder sb = new StringBuilder();
             for (String line : result.split("\n")) sb.append(shouldResolve(line) ? resolve(url, line) : line).append("\n");

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/InfoDialog.java
Patch:
@@ -72,7 +72,7 @@ private void initView() {
         binding.url.setText(url);
         binding.title.setText(title);
         binding.header.setText(header);
-        binding.vid.setText("Vid : ".concat(vid));
+        if (!TextUtils.isEmpty(vid)) binding.vid.setText("id : ".concat(vid));
         binding.vid.setVisibility(TextUtils.isEmpty(vid) ? View.GONE : View.VISIBLE);
         binding.url.setVisibility(TextUtils.isEmpty(url) ? View.GONE : View.VISIBLE);
         binding.header.setVisibility(TextUtils.isEmpty(header) ? View.GONE : View.VISIBLE);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -189,7 +189,8 @@ private void onRestore() {
         PermissionX.init(this).permissions(Manifest.permission.WRITE_EXTERNAL_STORAGE).request((allGranted, grantedList, deniedList) -> AppDatabase.restore(new Callback() {
             @Override
             public void success() {
-                initConfig();
+                if (allGranted) initConfig();
+                else mBinding.progressLayout.showContent();
             }
         }));
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -130,7 +130,8 @@ private void onRestore() {
         PermissionX.init(this).permissions(Manifest.permission.WRITE_EXTERNAL_STORAGE).request((allGranted, grantedList, deniedList) -> AppDatabase.restore(new Callback() {
             @Override
             public void success() {
-                initConfig();
+                if (allGranted) initConfig();
+                else RefreshEvent.empty();
             }
         }));
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingPlayerActivity.java
Patch:
@@ -50,6 +50,7 @@ protected ViewBinding getBinding() {
     @Override
     protected void initView() {
         setVisible();
+        mBinding.player.requestFocus();
         mBinding.uaText.setText(Setting.getUa());
         mBinding.tunnelText.setText(getSwitch(Setting.isTunnel()));
         mBinding.bufferText.setText(String.valueOf(Setting.getBuffer()));

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/DanmuSizeDialog.java
Patch:
@@ -33,7 +33,7 @@ public void show() {
     }
 
     private void initDialog() {
-        AlertDialog dialog = new MaterialAlertDialogBuilder(binding.getRoot().getContext()).setTitle(R.string.setting_danmu_speed).setView(binding.getRoot()).setPositiveButton(R.string.dialog_positive, this::onPositive).setNegativeButton(R.string.dialog_negative, this::onNegative).create();
+        AlertDialog dialog = new MaterialAlertDialogBuilder(binding.getRoot().getContext()).setTitle(R.string.setting_danmu_size).setView(binding.getRoot()).setPositiveButton(R.string.dialog_positive, this::onPositive).setNegativeButton(R.string.dialog_negative, this::onNegative).create();
         dialog.getWindow().setDimAmount(0);
         dialog.show();
     }

File: catvod/src/main/java/com/github/catvod/net/OkHttp.java
Patch:
@@ -141,7 +141,7 @@ private static HttpUrl buildUrl(String url, ArrayMap<String, String> params) {
     }
 
     private static OkHttpClient.Builder getBuilder() {
-        OkHttpClient.Builder builder = new OkHttpClient.Builder().cookieJar(CookieJar.get()).addInterceptor(new DefaultInterceptor()).connectTimeout(TIMEOUT, TimeUnit.MILLISECONDS).readTimeout(TIMEOUT, TimeUnit.MILLISECONDS).writeTimeout(TIMEOUT, TimeUnit.MILLISECONDS).dns(dns()).hostnameVerifier((hostname, session) -> true).sslSocketFactory(new SSLCompat(), SSLCompat.TM);
+        OkHttpClient.Builder builder = new OkHttpClient.Builder().addInterceptor(new DefaultInterceptor()).connectTimeout(TIMEOUT, TimeUnit.MILLISECONDS).readTimeout(TIMEOUT, TimeUnit.MILLISECONDS).writeTimeout(TIMEOUT, TimeUnit.MILLISECONDS).dns(dns()).hostnameVerifier((hostname, session) -> true).sslSocketFactory(new SSLCompat(), SSLCompat.TM);
         builder.proxySelector(get().proxy ? selector() : defaultSelector);
         return builder;
     }

File: catvod/src/main/java/com/github/catvod/net/interceptor/DefaultInterceptor.java
Patch:
@@ -3,6 +3,7 @@
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
 
+import com.github.catvod.Proxy;
 import com.github.catvod.utils.Util;
 import com.google.common.net.HttpHeaders;
 
@@ -50,7 +51,8 @@ public BufferedSource source() {
     private Request getRequest(@NonNull Request request) {
         String url = request.url().toString();
         Request.Builder builder = request.newBuilder();
-        if (url.contains("+") && (url.contains("127.0.0.1") || url.contains("/file/"))) builder.url(url.replace("+", "%2B"));
+        boolean local = url.contains(":" + Proxy.getPort() + "/");
+        if (url.contains("+") && local) builder.url(url.replace("+", "%2B"));
         if (url.contains("gitcode.net")) builder.addHeader(HttpHeaders.USER_AGENT, Util.CHROME);
         return builder.build();
     }

File: catvod/src/main/java/com/github/catvod/net/interceptor/DefaultInterceptor.java
Patch:
@@ -50,7 +50,7 @@ public BufferedSource source() {
     private Request getRequest(@NonNull Request request) {
         String url = request.url().toString();
         Request.Builder builder = request.newBuilder();
-        if (url.contains("+") && url.contains("127.0.0.1")) builder.url(url.replace("+", "%2B"));
+        if (url.contains("+") && (url.contains("127.0.0.1") || url.contains("/file/"))) builder.url(url.replace("+", "%2B"));
         if (url.contains("gitcode.net")) builder.addHeader(HttpHeaders.USER_AGENT, Util.CHROME);
         return builder.build();
     }

File: catvod/src/main/java/com/github/catvod/net/interceptor/DefaultInterceptor.java
Patch:
@@ -50,7 +50,7 @@ public BufferedSource source() {
     private Request getRequest(@NonNull Request request) {
         String url = request.url().toString();
         Request.Builder builder = request.newBuilder();
-        if (url.contains("+")) builder.url(url.replace("+", "%2B"));
+        if (url.contains("+") && url.contains("127.0.0.1")) builder.url(url.replace("+", "%2B"));
         if (url.contains("gitcode.net")) builder.addHeader(HttpHeaders.USER_AGENT, Util.CHROME);
         return builder.build();
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/KeepActivity.java
Patch:
@@ -77,7 +77,8 @@ public void onRefreshEvent(RefreshEvent event) {
     @Override
     public void onItemClick(Keep item) {
         Config config = Config.find(item.getCid());
-        if (item.getCid() != VodConfig.getCid()) loadConfig(config, item);
+        if (config == null) CollectActivity.start(this, item.getVodName());
+        else if (item.getCid() != VodConfig.getCid()) loadConfig(config, item);
         else VideoActivity.start(this, item.getSiteKey(), item.getVodId(), item.getVodName(), item.getVodPic());
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/KeepActivity.java
Patch:
@@ -102,7 +102,8 @@ public void onRefreshEvent(RefreshEvent event) {
     @Override
     public void onItemClick(Keep item) {
         Config config = Config.find(item.getCid());
-        if (item.getCid() != VodConfig.getCid()) loadConfig(config, item);
+        if (config == null) CollectActivity.start(this, item.getVodName());
+        else if (item.getCid() != VodConfig.getCid()) loadConfig(config, item);
         else VideoActivity.start(this, item.getSiteKey(), item.getVodId(), item.getVodName(), item.getVodPic());
     }
 

File: catvod/src/main/java/com/github/catvod/net/OkhttpInterceptor.java
Patch:
@@ -51,7 +51,7 @@ private Request getRequest(@NonNull Chain chain) {
         Request request = chain.request();
         String url = request.url().toString();
         Request.Builder builder = request.newBuilder();
-        if (url.contains("/file/")) builder.url(url.replace("+", "%2B"));
+        if (url.contains("+")) builder.url(url.replace("+", "%2B"));
         if (url.contains("gitcode.net")) builder.addHeader(HttpHeaders.USER_AGENT, Util.CHROME);
         return builder.build();
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -376,6 +376,7 @@ private boolean onChoose() {
         if (mPlayers.isEmpty()) return false;
         Intent intent = new Intent(Intent.ACTION_VIEW);
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
+        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
         intent.putExtra("headers", mPlayers.getHeaderArray());
         intent.putExtra("title", mBinding.widget.name.getText());
         intent.setDataAndType(mPlayers.getUri(), "video/*");

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -876,6 +876,7 @@ private boolean onChoose() {
         if (mPlayers.isEmpty()) return false;
         Intent intent = new Intent(Intent.ACTION_VIEW);
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
+        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
         intent.putExtra("return_result", true);
         intent.putExtra("headers", mPlayers.getHeaderArray());
         intent.putExtra("position", (int) mPlayers.getPosition());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -433,6 +433,7 @@ private boolean onChoose() {
         if (mPlayers.isEmpty()) return false;
         Intent intent = new Intent(Intent.ACTION_VIEW);
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
+        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
         intent.putExtra("headers", mPlayers.getHeaderArray());
         intent.putExtra("title", mBinding.control.title.getText());
         intent.setDataAndType(mPlayers.getUri(), "video/*");

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -887,6 +887,7 @@ private boolean onChoose() {
         if (mPlayers.isEmpty()) return false;
         Intent intent = new Intent(Intent.ACTION_VIEW);
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
+        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
         intent.putExtra("return_result", true);
         intent.putExtra("headers", mPlayers.getHeaderArray());
         intent.putExtra("position", (int) mPlayers.getPosition());

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -4,7 +4,6 @@
 import android.content.Context;
 import android.content.Intent;
 import android.graphics.drawable.Drawable;
-import android.net.Uri;
 import android.support.v4.media.MediaMetadataCompat;
 import android.view.KeyEvent;
 import android.view.View;
@@ -379,7 +378,7 @@ private boolean onChoose() {
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
         intent.putExtra("headers", mPlayers.getHeaderArray());
         intent.putExtra("title", mBinding.widget.name.getText());
-        intent.setDataAndType(Uri.parse(mPlayers.getUrl()), "video/*");
+        intent.setDataAndType(mPlayers.getUri(), "video/*");
         startActivity(Util.getChooser(intent));
         return true;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -880,7 +880,7 @@ private boolean onChoose() {
         intent.putExtra("headers", mPlayers.getHeaderArray());
         intent.putExtra("position", (int) mPlayers.getPosition());
         intent.putExtra("title", mBinding.widget.title.getText());
-        intent.setDataAndType(Uri.parse(mPlayers.getUrl()), "video/*");
+        intent.setDataAndType(mPlayers.getUri(), "video/*");
         startActivityForResult(Util.getChooser(intent), 1001);
         return true;
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -6,7 +6,6 @@
 import android.content.pm.ActivityInfo;
 import android.content.res.Configuration;
 import android.graphics.drawable.Drawable;
-import android.net.Uri;
 import android.os.Build;
 import android.os.Bundle;
 import android.support.v4.media.MediaMetadataCompat;
@@ -436,7 +435,7 @@ private boolean onChoose() {
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
         intent.putExtra("headers", mPlayers.getHeaderArray());
         intent.putExtra("title", mBinding.control.title.getText());
-        intent.setDataAndType(Uri.parse(mPlayers.getUrl()), "video/*");
+        intent.setDataAndType(mPlayers.getUri(), "video/*");
         startActivity(Util.getChooser(intent));
         setRedirect(true);
         return true;

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -891,7 +891,7 @@ private boolean onChoose() {
         intent.putExtra("headers", mPlayers.getHeaderArray());
         intent.putExtra("position", (int) mPlayers.getPosition());
         intent.putExtra("title", mBinding.control.title.getText());
-        intent.setDataAndType(Uri.parse(mPlayers.getUrl()), "video/*");
+        intent.setDataAndType(mPlayers.getUri(), "video/*");
         startActivityForResult(Util.getChooser(intent), 1001);
         setRedirect(true);
         return true;

File: app/src/main/java/com/fongmi/android/tv/api/Decoder.java
Patch:
@@ -33,7 +33,7 @@ public static String getJson(String url) throws Exception {
     }
 
     private static String fix(String url, String data) {
-        if (url.startsWith("file") || url.startsWith("assets")) return UrlUtil.convert(url);
+        if (url.startsWith("file") || url.startsWith("assets")) url = UrlUtil.convert(url);
         data = data.replace("./", url.substring(0, url.lastIndexOf("/") + 1));
         return data;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -125,7 +125,7 @@ private int getPlayerType(int playerType) {
     }
 
     private int getTimeout() {
-        return getHome() != null ? getHome().getTimeout() : Constant.TIMEOUT_PLAY;
+        return getHome().isEmpty() ? Constant.TIMEOUT_PLAY : getHome().getTimeout();
     }
 
     @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -135,7 +135,7 @@ private int getPlayerType(int playerType) {
     }
 
     private int getTimeout() {
-        return getHome() != null ? getHome().getTimeout() : Constant.TIMEOUT_PLAY;
+        return getHome().isEmpty() ? Constant.TIMEOUT_PLAY : getHome().getTimeout();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/player/ParseJob.java
Patch:
@@ -55,7 +55,7 @@ private void setParse(Result result, boolean useParse) {
         if (useParse) parse = ApiConfig.get().getParse();
         if (result.getPlayUrl().startsWith("json:")) parse = Parse.get(1, result.getPlayUrl().substring(5));
         if (result.getPlayUrl().startsWith("parse:")) parse = ApiConfig.get().getParse(result.getPlayUrl().substring(6));
-        if (parse == null) parse = Parse.get(0, result.getPlayUrl());
+        if (parse.isEmpty()) parse.setUrl(result.getPlayUrl());
         parse.setHeader(result.getHeader());
         parse.setClick(getClick(result));
     }
@@ -99,7 +99,7 @@ private void doInBackground(String key, String webUrl, String flag) throws Throw
             case 3: //Json聚合
                 jsonMix(webUrl, flag);
                 break;
-            case 4: //上帝模式
+            case 4: //超級解析
                 godParse(webUrl, flag);
                 break;
         }

File: app/src/main/java/com/fongmi/android/tv/player/extractor/JianPian.java
Patch:
@@ -15,7 +15,7 @@ public class JianPian implements Source.Extractor {
 
     @Override
     public boolean match(String scheme, String host) {
-        return scheme.equals("tvbox-xg") || scheme.equals("jianpian");
+        return scheme.equals("tvbox-xg") || scheme.equals("jianpian") || scheme.equals("ftp");
     }
 
     private void init() {

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -19,7 +19,7 @@
 public class Sniffer {
 
     public static final Pattern CLICKER = Pattern.compile("\\[a=cr:(\\{.*?\\})\\/](.*?)\\[\\/a]");
-    public static final Pattern AI_PUSH = Pattern.compile("(http|https|rtmp|rtsp|smb|thunder|magnet|ed2k|mitv|tvbox-xg|jianpian|video):[^\\s]+", Pattern.MULTILINE);
+    public static final Pattern AI_PUSH = Pattern.compile("(http|https|rtmp|rtsp|smb|ftp|thunder|magnet|ed2k|mitv|tvbox-xg|jianpian|video):[^\\s]+", Pattern.MULTILINE);
     public static final Pattern SNIFFER = Pattern.compile("http((?!http).){12,}?\\.(m3u8|mp4|mkv|flv|mp3|m4a|aac)\\?.*|http((?!http).){12,}\\.(m3u8|mp4|mkv|flv|mp3|m4a|aac)|http((?!http).)*?video/tos*");
 
     public static final List<String> THUNDER = Arrays.asList("thunder", "magnet", "ed2k");

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -121,7 +121,7 @@ private Live getHome() {
     }
 
     private int getPlayerType(int playerType) {
-        return playerType != -1 ? playerType : getHome() != null && getHome().getPlayerType() != -1 ? getHome().getPlayerType() : Setting.getLivePlayer();
+        return playerType != -1 ? playerType : Setting.getLivePlayer();
     }
 
     private int getTimeout() {
@@ -709,7 +709,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getHome() != null && getHome().getPlayerType() == -1 && event.isUrl() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (mChannel != null && mChannel.getPlayerType() == -1 && event.isUrl() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -131,7 +131,7 @@ private Live getHome() {
     }
 
     private int getPlayerType(int playerType) {
-        return playerType != -1 ? playerType : getHome() != null && getHome().getPlayerType() != -1 ? getHome().getPlayerType() : Setting.getLivePlayer();
+        return playerType != -1 ? playerType : Setting.getLivePlayer();
     }
 
     private int getTimeout() {
@@ -484,6 +484,7 @@ private void hideError() {
     }
 
     private void showControl() {
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N && isInPictureInPictureMode()) return;
         mBinding.control.info.setVisibility(mPlayers.isEmpty() ? View.GONE : View.VISIBLE);
         mBinding.control.cast.setVisibility(mPlayers.isEmpty() ? View.GONE : View.VISIBLE);
         mBinding.control.right.rotate.setVisibility(isLock() ? View.GONE : View.VISIBLE);
@@ -779,7 +780,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getHome() != null && getHome().getPlayerType() == -1 && event.isUrl() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (mChannel != null && mChannel.getPlayerType() == -1 && event.isUrl() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -9,6 +9,7 @@
 import android.content.res.Configuration;
 import android.graphics.drawable.Drawable;
 import android.net.Uri;
+import android.os.Build;
 import android.os.Bundle;
 import android.provider.Settings;
 import android.support.v4.media.MediaMetadataCompat;
@@ -979,6 +980,7 @@ private void hideError() {
     }
 
     private void showControl() {
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N && isInPictureInPictureMode()) return;
         mBinding.control.danmu.setVisibility(isLock() || !mBinding.danmaku.isPrepared() ? View.GONE : View.VISIBLE);
         mBinding.control.setting.setVisibility(mHistory == null || isFullscreen() ? View.GONE : View.VISIBLE);
         mBinding.control.right.rotate.setVisibility(isFullscreen() && !isLock() ? View.VISIBLE : View.GONE);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingActivity.java
Patch:
@@ -191,12 +191,12 @@ private void setConfig() {
             case 1:
                 setCacheText();
                 Notify.dismiss();
-                mBinding.liveUrl.setText(LiveConfig.getUrl());
+                mBinding.liveUrl.setText(LiveConfig.getDesc());
                 break;
             case 2:
                 setCacheText();
                 Notify.dismiss();
-                mBinding.wallUrl.setText(WallConfig.getUrl());
+                mBinding.wallUrl.setText(WallConfig.getDesc());
                 break;
         }
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -709,7 +709,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getHome() != null && getHome().getPlayerType() == -1 && event.isFormat() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (getHome() != null && getHome().getPlayerType() == -1 && event.isUrl() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1041,7 +1041,7 @@ private void checkFlag(Vod item) {
         boolean empty = item.getVodFlags().isEmpty();
         mBinding.flag.setVisibility(empty ? View.GONE : View.VISIBLE);
         if (empty) {
-            ErrorEvent.episode();
+            ErrorEvent.flag();
         } else {
             setFlagActivated(mHistory.getFlag());
             if (mHistory.isRevSort()) reverseEpisode(true);
@@ -1212,7 +1212,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getSite().getPlayerType() == -1 && event.isFormat() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (getSite().getPlayerType() == -1 && event.isUrl() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -199,7 +199,7 @@ private void checkFlag(Vod item) {
         boolean empty = item.getVodFlags().isEmpty();
         mBinding.flag.setVisibility(empty ? View.GONE : View.VISIBLE);
         if (empty) {
-            ErrorEvent.episode();
+            ErrorEvent.flag();
         } else {
             onItemClick(mHistory.getFlag());
             if (mHistory.isRevSort()) reverseEpisode(true);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -779,7 +779,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getHome() != null && getHome().getPlayerType() == -1 && event.isFormat() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (getHome() != null && getHome().getPlayerType() == -1 && event.isUrl() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -486,7 +486,7 @@ private void setEmpty(boolean finish) {
     }
 
     private void showEmpty() {
-        showError(getString(R.string.error_play_url));
+        showError(getString(R.string.error_detail));
         mBinding.swipeLayout.setEnabled(true);
         mBinding.progressLayout.showEmpty();
         stopSearch();
@@ -1062,7 +1062,7 @@ private void checkFlag(Vod item) {
         boolean empty = item.getVodFlags().isEmpty();
         mBinding.flag.setVisibility(empty ? View.GONE : View.VISIBLE);
         if (empty) {
-            ErrorEvent.episode();
+            ErrorEvent.flag();
         } else {
             onItemClick(mHistory.getFlag());
             if (mHistory.isRevSort()) reverseEpisode(true);
@@ -1273,7 +1273,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getSite().getPlayerType() == -1 && event.isFormat() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (getSite().getPlayerType() == -1 && event.isUrl() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -591,7 +591,7 @@ public void onParseError() {
 
     @Override
     public void onEvents(@NonNull Player player, @NonNull Player.Events events) {
-        if (!events.containsAny(EVENT_PLAYBACK_STATE_CHANGED, EVENT_PLAY_WHEN_READY_CHANGED, EVENT_IS_PLAYING_CHANGED, EVENT_TIMELINE_CHANGED, EVENT_PLAYBACK_PARAMETERS_CHANGED, EVENT_POSITION_DISCONTINUITY, EVENT_REPEAT_MODE_CHANGED, EVENT_SHUFFLE_MODE_ENABLED_CHANGED, EVENT_MEDIA_METADATA_CHANGED)) return;
+        if (!events.containsAny(Player.EVENT_PLAYBACK_STATE_CHANGED, Player.EVENT_PLAY_WHEN_READY_CHANGED, Player.EVENT_IS_PLAYING_CHANGED, Player.EVENT_TIMELINE_CHANGED, Player.EVENT_PLAYBACK_PARAMETERS_CHANGED, Player.EVENT_POSITION_DISCONTINUITY, Player.EVENT_REPEAT_MODE_CHANGED, Player.EVENT_SHUFFLE_MODE_ENABLED_CHANGED, Player.EVENT_MEDIA_METADATA_CHANGED)) return;
         setPlaybackState(isPlaying() ? PlaybackStateCompat.STATE_PLAYING : PlaybackStateCompat.STATE_PAUSED);
     }
 

File: catvod/src/main/java/com/github/catvod/utils/Path.java
Patch:
@@ -189,6 +189,8 @@ public static void copy(InputStream in, OutputStream out) throws IOException {
         while ((amountRead = in.read(buffer)) != -1) {
             out.write(buffer, 0, amountRead);
         }
+        in.close();
+        out.close();
     }
 
     public static void newFile(File file) {

File: catvod/src/main/java/com/github/catvod/utils/Path.java
Patch:
@@ -189,6 +189,8 @@ public static void copy(InputStream in, OutputStream out) throws IOException {
         while ((amountRead = in.read(buffer)) != -1) {
             out.write(buffer, 0, amountRead);
         }
+        in.close();
+        out.close();
     }
 
     public static void newFile(File file) {

File: catvod/src/main/java/com/github/catvod/net/OkHttp.java
Patch:
@@ -90,7 +90,6 @@ public static OkHttpClient client(boolean redirect, int timeout) {
 
     public static String string(String url) {
         try {
-            if (url.contains("/file://")) url = url.replace("+", "%2B");
             return url.startsWith("http") ? newCall(url).execute().body().string() : "";
         } catch (Exception e) {
             e.printStackTrace();

File: app/src/main/java/com/fongmi/android/tv/server/Server.java
Patch:
@@ -40,7 +40,7 @@ public String getAddress(boolean local) {
     }
 
     public void go() {
-        new Thread(Go_proxy_video::start);
+        new Thread(Go_proxy_video::start).start();
     }
 
     public void start() {

File: app/src/main/java/com/fongmi/android/tv/server/Nano.java
Patch:
@@ -89,6 +89,7 @@ private void parse(IHTTPSession session, Map<String, String> files) {
             if (boundary != null) session.getHeaders().put("content-type", "multipart/form-data; charset=utf-8; " + boundary);
         }
         try {
+            session.parseBody(session.getParms());
             session.parseBody(files);
         } catch (Exception ignored) {
         }

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -240,7 +240,7 @@ public Spider getSpider(Site site) {
 
     public void setRecent(Site site) {
         boolean js = site.getApi().contains(".js");
-        boolean py = site.getApi().startsWith("py_");
+        boolean py = site.getApi().contains(".py");
         boolean csp = site.getApi().startsWith("csp_");
         if (js) jsLoader.setRecent(site.getKey());
         else if (py) pyLoader.setRecent(site.getKey());

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -39,7 +39,7 @@ public static boolean isThunder(String url) {
     }
 
     public static boolean isTorrent(String url) {
-        return url.split(";")[0].endsWith(".torrent");
+        return !url.startsWith("magnet") && url.split(";")[0].endsWith(".torrent");
     }
 
     public static boolean isVideoFormat(String url) {

File: app/src/main/java/com/fongmi/android/tv/server/process/Cache.java
Patch:
@@ -28,7 +28,7 @@ public NanoHTTPD.Response doResponse(NanoHTTPD.IHTTPSession session, String path
         String key = params.get("key");
         switch (Objects.requireNonNullElse(params.get("do"), "")) {
             case "get":
-                return Nano.success(getKey(rule, key));
+                return Nano.success(Prefers.getString(getKey(rule, key)));
             case "set":
                 Prefers.put(getKey(rule, key), params.get("value"));
                 return Nano.success();

File: app/src/main/java/com/fongmi/android/tv/server/Nano.java
Patch:
@@ -6,6 +6,7 @@
 import com.fongmi.android.tv.api.LiveConfig;
 import com.fongmi.android.tv.bean.Device;
 import com.fongmi.android.tv.server.process.Action;
+import com.fongmi.android.tv.server.process.Cache;
 import com.fongmi.android.tv.server.process.Local;
 import com.fongmi.android.tv.server.process.Process;
 import com.fongmi.android.tv.utils.M3U8;
@@ -37,6 +38,7 @@ public Nano(int port) {
     private void addProcess() {
         process = new ArrayList<>();
         process.add(new Action());
+        process.add(new Cache());
         process.add(new Local());
     }
 

File: app/src/main/java/com/fongmi/android/tv/server/process/Cache.java
Patch:
@@ -20,8 +20,7 @@ public NanoHTTPD.Response doResponse(NanoHTTPD.IHTTPSession session, String path
         Map<String, String> params = session.getParms();
         switch (Objects.requireNonNullElse(params.get("do"), "")) {
             case "get":
-                Prefers.getString("cache_" + params.get("key"));
-                return Nano.success();
+                return Nano.success(Prefers.getString("cache_" + params.get("key")));
             case "set":
                 Prefers.put("cache_" + params.get("key"), params.get("value"));
                 return Nano.success();

File: catvod/src/main/java/com/github/catvod/net/OkHttp.java
Patch:
@@ -32,6 +32,7 @@ public class OkHttp {
     private static final int CACHE = 100 * 1024 * 1024;
     private static final ProxySelector defaultSelector;
 
+    private boolean proxy;
     private DnsOverHttps dns;
     private OkHttpClient client;
     private OkProxySelector selector;
@@ -61,6 +62,7 @@ public void setDoh(Doh doh) {
     public void setProxy(String proxy) {
         ProxySelector.setDefault(TextUtils.isEmpty(proxy) ? defaultSelector : selector());
         if (!TextUtils.isEmpty(proxy)) selector().setProxy(proxy);
+        this.proxy = !TextUtils.isEmpty(proxy);
         client = null;
     }
 
@@ -140,7 +142,7 @@ private static HttpUrl buildUrl(String url, ArrayMap<String, String> params) {
 
     private static OkHttpClient.Builder getBuilder() {
         OkHttpClient.Builder builder = new OkHttpClient.Builder().addInterceptor(new OkhttpInterceptor()).connectTimeout(TIMEOUT, TimeUnit.MILLISECONDS).readTimeout(TIMEOUT, TimeUnit.MILLISECONDS).writeTimeout(TIMEOUT, TimeUnit.MILLISECONDS).dns(dns()).hostnameVerifier((hostname, session) -> true).sslSocketFactory(new SSLCompat(), SSLCompat.TM);
-        builder.proxySelector(ProxySelector.getDefault());
+        builder.proxySelector(get().proxy ? selector() : defaultSelector);
         return builder;
     }
 }

File: catvod/src/main/java/com/github/catvod/net/OkProxySelector.java
Patch:
@@ -9,12 +9,13 @@
 import java.net.InetSocketAddress;
 import java.net.PasswordAuthentication;
 import java.net.Proxy;
+import java.net.ProxySelector;
 import java.net.SocketAddress;
 import java.net.URI;
 import java.util.Collections;
 import java.util.List;
 
-public class OkProxySelector extends java.net.ProxySelector {
+public class OkProxySelector extends ProxySelector {
 
     private List<String> hosts;
     private Proxy proxy;

File: catvod/src/main/java/com/github/catvod/net/OkProxySelector.java
Patch:
@@ -14,7 +14,7 @@
 import java.util.Collections;
 import java.util.List;
 
-public class ProxySelector extends java.net.ProxySelector {
+public class OkProxySelector extends java.net.ProxySelector {
 
     private List<String> hosts;
     private Proxy proxy;

File: app/src/main/java/com/fongmi/android/tv/server/Nano.java
Patch:
@@ -10,7 +10,6 @@
 import com.fongmi.android.tv.server.process.Process;
 import com.fongmi.android.tv.utils.M3U8;
 import com.github.catvod.Init;
-import com.github.catvod.net.OkHttp;
 import com.google.common.net.HttpHeaders;
 
 import java.io.ByteArrayInputStream;
@@ -94,7 +93,7 @@ private void parse(IHTTPSession session, Map<String, String> files) {
     }
 
     private Response go() {
-        if (OkHttp.string("http://127.0.0.1:7777").isEmpty()) Server.get().go();
+        Server.get().go();
         return success();
     }
 

File: app/src/main/java/com/fongmi/android/tv/utils/FileChooser.java
Patch:
@@ -47,7 +47,7 @@ public void show(String[] mimeTypes) {
     }
 
     public void show(String mimeType, String[] mimeTypes, int code) {
-        Intent intent = new Intent(Util.isTvBox() ? Intent.ACTION_OPEN_DOCUMENT : Intent.ACTION_GET_CONTENT);
+        Intent intent = new Intent(Util.isTvBox() ? Intent.ACTION_GET_CONTENT : Intent.ACTION_OPEN_DOCUMENT);
         intent.setType(mimeType);
         intent.addCategory(Intent.CATEGORY_OPENABLE);
         intent.putExtra(Intent.EXTRA_MIME_TYPES, mimeTypes);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1151,6 +1151,7 @@ public void onPlayerEvent(PlayerEvent event) {
                 hideProgress();
                 mPlayers.reset();
                 setDefaultTrack();
+                mPlayers.prepared();
                 setTrackVisible(true);
                 mHistory.setPlayer(mPlayers.getPlayer());
                 mBinding.widget.size.setText(mPlayers.getSizeText());
@@ -1182,7 +1183,6 @@ private void setTrackVisible(boolean visible) {
     private void setDefaultTrack() {
         if (isInitTrack()) {
             setInitTrack(false);
-            mPlayers.prepared();
             mPlayers.setTrack(Track.find(getHistoryKey()));
         }
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1187,6 +1187,7 @@ public void onPlayerEvent(PlayerEvent event) {
                 hideProgress();
                 mPlayers.reset();
                 setDefaultTrack();
+                mPlayers.prepared();
                 setTrackVisible(true);
                 checkPlayImg(mPlayers.isPlaying());
                 mHistory.setPlayer(mPlayers.getPlayer());
@@ -1229,7 +1230,6 @@ private void setTrackVisible(boolean visible) {
     private void setDefaultTrack() {
         if (isInitTrack()) {
             setInitTrack(false);
-            mPlayers.prepared();
             mPlayers.setTrack(Track.find(getHistoryKey()));
         }
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -149,9 +149,8 @@ public class VideoActivity extends BaseActivity implements CustomKeyDownVod.List
     private View mFocus2;
 
     public static void push(FragmentActivity activity, String text) {
-        String url = Sniffer.getUrl(text);
-        if (url.length() > 0) start(activity, url);
-        else file(activity, FileChooser.getPathFromUri(activity, Uri.parse(text)));
+        if (FileChooser.isValid(activity, Uri.parse(text))) file(activity, FileChooser.getPathFromUri(activity, Uri.parse(text)));
+        else start(activity, Sniffer.getUrl(text));
     }
 
     public static void file(FragmentActivity activity, String path) {

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -31,7 +31,7 @@ public static String getUrl(String text) {
         if (Json.valid(text)) return text;
         Matcher m = AI_PUSH.matcher(text);
         if (m.find()) return m.group(0);
-        return "";
+        return text;
     }
 
     public static boolean isThunder(String url) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -159,9 +159,8 @@ public class VideoActivity extends BaseActivity implements Clock.Callback, Custo
     private PiP mPiP;
 
     public static void push(FragmentActivity activity, String text) {
-        String url = Sniffer.getUrl(text);
-        if (url.length() > 0) start(activity, url);
-        else file(activity, FileChooser.getPathFromUri(activity, Uri.parse(text)));
+        if (FileChooser.isValid(activity, Uri.parse(text))) file(activity, FileChooser.getPathFromUri(activity, Uri.parse(text)));
+        else start(activity, Sniffer.getUrl(text));
     }
 
     public static void file(FragmentActivity activity, String path) {

File: app/src/main/java/com/fongmi/android/tv/utils/FileChooser.java
Patch:
@@ -19,6 +19,7 @@
 import java.io.File;
 import java.io.FileOutputStream;
 import java.io.InputStream;
+import java.net.URLDecoder;
 
 public class FileChooser {
 
@@ -63,7 +64,7 @@ public static String getPathFromUri(Context context, Uri uri) {
         if (DocumentsContract.isDocumentUri(context, uri)) path = getPathFromDocumentUri(context, uri);
         else if (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme())) path = getDataColumn(context, uri);
         else if (ContentResolver.SCHEME_FILE.equalsIgnoreCase(uri.getScheme())) path = uri.getPath();
-        return path != null ? path : createFileFromUri(context, uri);
+        return path != null ? URLDecoder.decode(path) : createFileFromUri(context, uri);
     }
 
     private static String getPathFromDocumentUri(Context context, Uri uri) {

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -31,7 +31,7 @@ public static String getUrl(String text) {
         if (Json.valid(text)) return text;
         Matcher m = AI_PUSH.matcher(text);
         if (m.find()) return m.group(0);
-        return text;
+        return "";
     }
 
     public static boolean isThunder(String url) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -268,10 +268,11 @@ public void goBack() {
         onRefresh();
     }
 
-    public void goRoot() {
-        if (mPages.isEmpty()) return;
+    public boolean goRoot() {
+        if (mPages.isEmpty()) return false;
         mPages.clear();
         getVideo();
+        return true;
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -5,6 +5,7 @@
 
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Rule;
+import com.github.catvod.utils.Json;
 import com.github.catvod.utils.Util;
 import com.orhanobut.logger.Logger;
 
@@ -25,6 +26,7 @@ public class Sniffer {
     public static final List<String> THUNDER = Arrays.asList("thunder", "magnet", "ed2k");
 
     public static String getUrl(String text) {
+        if (Json.valid(text)) return text;
         Matcher m = Pattern.compile("(http|https|rtmp|rtsp|smb|thunder|magnet|ed2k|mitv|tvbox-xg|jianpian):[^\\s]+", Pattern.MULTILINE).matcher(text);
         if (m.find()) return m.group(0);
         return text;

File: app/src/main/java/com/fongmi/android/tv/bean/Channel.java
Patch:
@@ -303,8 +303,8 @@ public Channel copy(Channel item) {
 
     public Result result() {
         Result result = new Result();
-        result.setHeader(getHeader());
         result.setUrl(Url.create().add(getUrl()));
+        result.setHeader(Json.toObject(getHeaders()));
         return result;
     }
 

File: catvod/src/main/java/com/github/catvod/utils/Trans.java
Patch:
@@ -51,10 +51,12 @@ public static boolean pass() {
     }
 
     public static String s2t(String text) {
+        if (TextUtils.isEmpty(text)) return "";
         return s2t(pass(), text);
     }
 
     public static String t2s(String text) {
+        if (TextUtils.isEmpty(text)) return "";
         return t2s(pass(), text);
     }
 

File: app/src/main/java/com/fongmi/android/tv/model/LiveViewModel.java
Patch:
@@ -71,6 +71,7 @@ public void getEpg(Channel item) {
 
     public void getUrl(Channel item) {
         execute(URL, () -> {
+            item.setMsg(null);
             Source.get().stop();
             item.setUrl(Source.get().fetch(item));
             //checkPLTV(item);

File: app/src/main/java/com/fongmi/android/tv/player/extractor/TVBus.java
Patch:
@@ -86,7 +86,7 @@ public void onPrepared(String result) {
     public void onStop(String result) {
         JsonObject json = App.gson().fromJson(result, JsonObject.class);
         hls = json.get("errno").getAsString();
-        onNotify();
+        if (hls.startsWith("-")) onNotify();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/player/extractor/TVBus.java
Patch:
@@ -77,7 +77,8 @@ public void exit() {
     @Override
     public void onPrepared(String result) {
         JsonObject json = App.gson().fromJson(result, JsonObject.class);
-        hls = json.has("hls") ? json.get("hls").getAsString() : "-9999";
+        if (json.get("hls") == null) return;
+        hls = json.get("hls").getAsString();
         onNotify();
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -366,7 +366,7 @@ public void setHome(Site home) {
 
     private void setWall(String wall) {
         this.wall = wall;
-        boolean load = !TextUtils.isEmpty(wall) && WallConfig.get().isSame(wall);
+        boolean load = !TextUtils.isEmpty(wall) && WallConfig.get().needSync(wall);
         if (load) WallConfig.get().config(Config.find(wall, config.getName(), 2).update());
     }
 }
\ No newline at end of file

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -27,7 +27,7 @@ public class Sniffer {
     public static String getUrl(String text) {
         Matcher m = Pattern.compile("(http|https|rtmp|rtsp|smb|thunder|magnet|ed2k|mitv|tvbox-xg|jianpian):[^\\s]+", Pattern.MULTILINE).matcher(text);
         if (m.find()) return m.group(0);
-        return "";
+        return text;
     }
 
     public static boolean isThunder(String url) {

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -232,6 +232,7 @@ private void setHome(Live home, boolean check) {
         this.home.setActivated(true);
         config.home(home.getName()).update();
         for (Live item : getLives()) item.setActivated(home);
+        if (App.activity() != null && App.activity() instanceof LiveActivity) return;
         if (check) if (home.isBoot() || Setting.isBootLive()) App.post(this::bootLive);
     }
 }

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -116,12 +116,12 @@ private void parseConfig(String text, Callback callback) {
     }
 
     private void parseText(String text, Callback callback) {
-        Live live = new Live(config.getUrl());
+        Live live = new Live(config.getUrl()).sync();
         LiveParser.text(live, text);
-        App.post(callback::success);
         lives.remove(live);
-        lives.add(live.sync());
+        lives.add(live);
         setHome(live, true);
+        App.post(callback::success);
     }
 
     private void checkJson(JsonObject object, Callback callback) {

File: app/src/main/java/com/fongmi/android/tv/bean/Live.java
Patch:
@@ -218,6 +218,7 @@ public Live boot(boolean boot) {
     }
 
     public Live pass(boolean pass) {
+        getGroups().clear();
         setPass(pass);
         return this;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -352,6 +352,7 @@ private void onChange() {
     }
 
     private boolean onChoose() {
+        if (mPlayers.isEmpty()) return false;
         Intent intent = new Intent(Intent.ACTION_VIEW);
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
         intent.putExtra("headers", mPlayers.getHeaderArray());

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -874,6 +874,7 @@ private void setEnding(long ending) {
     }
 
     private boolean onChoose() {
+        if (mPlayers.isEmpty()) return false;
         Intent intent = new Intent(Intent.ACTION_VIEW);
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
         intent.putExtra("return_result", true);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -407,6 +407,7 @@ private void onDecode() {
     }
 
     private boolean onChoose() {
+        if (mPlayers.isEmpty()) return false;
         Intent intent = new Intent(Intent.ACTION_VIEW);
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
         intent.putExtra("headers", mPlayers.getHeaderArray());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -880,6 +880,7 @@ private void onEpisodes() {
     }
 
     private boolean onChoose() {
+        if (mPlayers.isEmpty()) return false;
         Intent intent = new Intent(Intent.ACTION_VIEW);
         intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
         intent.putExtra("return_result", true);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -459,8 +459,8 @@ private void hideError() {
     }
 
     private void showControl() {
-        mBinding.control.info.setVisibility(mPlayers.getUrl() == null ? View.GONE : View.VISIBLE);
-        mBinding.control.cast.setVisibility(mPlayers.getUrl() == null ? View.GONE : View.VISIBLE);
+        mBinding.control.info.setVisibility(mPlayers.isEmpty() ? View.GONE : View.VISIBLE);
+        mBinding.control.cast.setVisibility(mPlayers.isEmpty() ? View.GONE : View.VISIBLE);
         mBinding.control.right.rotate.setVisibility(isLock() ? View.GONE : View.VISIBLE);
         mBinding.control.right.back.setVisibility(isLock() ? View.GONE : View.VISIBLE);
         mBinding.control.bottom.setVisibility(isLock() ? View.GONE : View.VISIBLE);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -731,6 +731,7 @@ private void showDanmu() {
     private void checkPlay() {
         setR1Callback();
         if (mPlayers.isPlaying()) onPaused();
+        else if (mPlayers.isEmpty()) onRefresh();
         else onPlay();
     }
 
@@ -981,9 +982,9 @@ private void showControl() {
         mBinding.control.right.back.setVisibility(isFullscreen() && !isLock() ? View.VISIBLE : View.GONE);
         mBinding.control.parse.setVisibility(isFullscreen() && isUseParse() ? View.VISIBLE : View.GONE);
         mBinding.control.action.getRoot().setVisibility(isFullscreen() ? View.VISIBLE : View.GONE);
-        mBinding.control.info.setVisibility(mPlayers.getUrl() == null ? View.GONE : View.VISIBLE);
-        mBinding.control.cast.setVisibility(mPlayers.getUrl() == null ? View.GONE : View.VISIBLE);
         mBinding.control.right.lock.setVisibility(isFullscreen() ? View.VISIBLE : View.GONE);
+        mBinding.control.info.setVisibility(mPlayers.isEmpty() ? View.GONE : View.VISIBLE);
+        mBinding.control.cast.setVisibility(mPlayers.isEmpty() ? View.GONE : View.VISIBLE);
         mBinding.control.center.setVisibility(isLock() ? View.GONE : View.VISIBLE);
         mBinding.control.bottom.setVisibility(isLock() ? View.GONE : View.VISIBLE);
         mBinding.control.top.setVisibility(isLock() ? View.GONE : View.VISIBLE);

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/misc/ITrackInfo.java
Patch:
@@ -26,6 +26,8 @@ public interface ITrackInfo {
 
     String getLanguage();
 
+    String getMimeType();
+
     int getTrackType();
 
     int getChannelCount();

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -157,7 +157,7 @@ public IjkVideoView ijk() {
     }
 
     public Map<String, String> getHeaders() {
-        return checkUa(headers);
+        return headers == null ? new HashMap<>() : checkUa(headers);
     }
 
     public String[] getHeaderArray() {

File: catvod/src/main/java/com/github/catvod/utils/Github.java
Patch:
@@ -6,7 +6,7 @@
 
 public class Github {
 
-    public static final String URL = "https://mirror.ghproxy.com/https://raw.githubusercontent.com/FongMi/Release/main";
+    public static final String URL = "https://my.t4tv.hz.cz";
     private static String ABI;
 
     public static void setAbi(String abi) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -196,7 +196,7 @@ private void onRetry(View view) {
     }
 
     private void onFilter(View view) {
-        FilterDialog.create().filter(mAdapter.get(mBinding.pager.getCurrentItem()).getFilters()).show(this);
+        if (mAdapter.getItemCount() > 0) FilterDialog.create().filter(mAdapter.get(mBinding.pager.getCurrentItem()).getFilters()).show(this);
     }
 
     private void onHot(View view) {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -280,7 +280,7 @@ public String setSpeed(float speed) {
     public String addSpeed() {
         float speed = getSpeed();
         float addon = speed >= 2 ? 1f : 0.25f;
-        speed = speed == 5 ? 0.25f : speed + addon;
+        speed = speed >= 5 ? 0.25f : Math.min(speed + addon, 5.0f);
         return setSpeed(speed);
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/ControlDialog.java
Patch:
@@ -85,7 +85,7 @@ protected ViewBinding getBinding(@NonNull LayoutInflater inflater, @Nullable Vie
     protected void initView() {
         if (players == null) dismiss();
         if (players == null) return;
-        binding.speed.setValue(Math.max(players.getSpeed(), 1.0f));
+        binding.speed.setValue(Math.max(players.getSpeed(), 0.5f));
         binding.player.setText(parent.control.action.player.getText());
         binding.decode.setText(parent.control.action.decode.getText());
         binding.ending.setText(parent.control.action.ending.getText());

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/PushActivity.java
Patch:
@@ -38,7 +38,7 @@ protected void initView() {
     }
 
     private void onClip(View view) {
-        String text = Sniffer.getUrl(Util.getClipText().toString());
-        if (!TextUtils.isEmpty(text)) VideoActivity.start(this, text, false);
+        CharSequence text = Util.getClipText();
+        if (!TextUtils.isEmpty(text)) VideoActivity.start(this, Sniffer.getUrl(text.toString()), false);
     }
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/dialog/LinkDialog.java
Patch:
@@ -47,8 +47,8 @@ private void initDialog() {
     }
 
     private void initView() {
-        String text = Sniffer.getUrl(Util.getClipText().toString());
-        if (!TextUtils.isEmpty(text)) binding.text.setText(text);
+        CharSequence text = Util.getClipText();
+        if (!TextUtils.isEmpty(text)) binding.text.setText(Sniffer.getUrl(text.toString()));
     }
 
     private void initEvent() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -253,8 +253,10 @@ private void setGroup(Live live) {
     }
 
     private void setWidth(Live live) {
+        int base = ResUtil.dp2px(live.hasLogo() ? 98 : 50);
         for (Group group : live.getGroups()) live.setWidth(Math.max(live.getWidth(), ResUtil.getTextWidth(group.getName(), 16)));
-        mBinding.group.getLayoutParams().width = Math.min(live.getWidth() + ResUtil.dp2px(live.hasLogo() ? 98 : 50), ResUtil.dp2px(260));
+        mBinding.group.getLayoutParams().width = live.getWidth() == 0 ? 0 : Math.min(live.getWidth() + base, ResUtil.dp2px(200));
+        mBinding.divide.setVisibility(live.getWidth() == 0 ? View.GONE : View.VISIBLE);
     }
 
     private void setPosition(int[] position) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -272,8 +272,10 @@ private void setGroup(Live live) {
     }
 
     private void setWidth(Live live) {
+        int base = ResUtil.dp2px(live.hasLogo() ? 90 : 45);
         for (Group group : live.getGroups()) live.setWidth(Math.max(live.getWidth(), ResUtil.getTextWidth(group.getName(), 14)));
-        mBinding.group.getLayoutParams().width = Math.min(live.getWidth() + ResUtil.dp2px(live.hasLogo() ? 90 : 45), ResUtil.dp2px(260));
+        mBinding.group.getLayoutParams().width = live.getWidth() == 0 ? 0 : Math.min(live.getWidth() + base, ResUtil.dp2px(200));
+        mBinding.divide.setVisibility(live.getWidth() == 0 ? View.GONE : View.VISIBLE);
     }
 
     private void setPosition(int[] position) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -213,10 +213,10 @@ private void setVideoView() {
         mBinding.control.invert.setActivated(Setting.isInvert());
         mBinding.control.across.setActivated(Setting.isAcross());
         mBinding.control.change.setActivated(Setting.isChange());
-        mBinding.control.home.setVisibility(LiveConfig.isOnly() ? View.GONE : View.VISIBLE);
         findViewById(R.id.timeBar).setNextFocusUpId(R.id.player);
         getExo().getSubtitleView().setStyle(ExoUtil.getCaptionStyle());
         getIjk().getSubtitleView().setStyle(ExoUtil.getCaptionStyle());
+        mBinding.control.home.setVisibility(LiveConfig.isOnly() ? View.GONE : View.VISIBLE);
     }
 
     private void setScale(int scale) {
@@ -236,6 +236,7 @@ private void setViewModel() {
     }
 
     private void getLive() {
+        mBinding.control.home.setText(getHome().getName());
         mPlayers.setPlayer(getPlayerType(-1));
         mViewModel.getLive(getHome());
         setPlayerView();
@@ -249,7 +250,6 @@ private void setGroup(Live live) {
         for (Group group : live.getGroups()) (group.isHidden() ? mHides : items).add(group);
         mGroupAdapter.setItems(items, null);
         setPosition(LiveConfig.get().find(items));
-        mBinding.control.home.setText(live.getName());
     }
 
     private void setWidth(Live live) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -255,6 +255,7 @@ private void setViewModel() {
     }
 
     private void getLive() {
+        mBinding.control.action.home.setText(getHome().getName());
         mPlayers.setPlayer(getPlayerType(-1));
         mViewModel.getLive(getHome());
         setPlayerView();
@@ -268,7 +269,6 @@ private void setGroup(Live live) {
         for (Group group : live.getGroups()) (group.isHidden() ? mHides : items).add(group);
         mGroupAdapter.addAll(items);
         setPosition(LiveConfig.get().find(items));
-        mBinding.control.action.home.setText(live.getName());
     }
 
     private void setWidth(Live live) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -740,12 +740,14 @@ private void nextChannel() {
     }
 
     private void prevLine() {
+        if (mChannel == null) return;
         mChannel.prevLine();
         showInfo();
         fetch();
     }
 
     private void nextLine(boolean show) {
+        if (mChannel == null) return;
         mChannel.nextLine();
         if (show) showInfo();
         else setInfo();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -834,12 +834,14 @@ private void nextChannel() {
     }
 
     private void prevLine() {
+        if (mChannel == null) return;
         mChannel.prevLine();
         showInfo();
         fetch();
     }
 
     private void nextLine(boolean show) {
+        if (mChannel == null) return;
         mChannel.nextLine();
         if (show) showInfo();
         else setInfo();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -97,7 +97,7 @@ protected void initView() {
         DLNARendererService.Companion.start(this, R.drawable.ic_logo);
         mClock = Clock.create(mBinding.time).format("MM/dd HH:mm:ss");
         mBinding.progressLayout.showProgress();
-        Updater.get().release().start();
+        Updater.get().release().start(this);
         Server.get().start();
         setRecyclerView();
         setViewModel();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingActivity.java
Patch:
@@ -258,11 +258,11 @@ private boolean onPlayerSetting(View view) {
     }
 
     private void onVersion(View view) {
-        Updater.get().force().release().start();
+        Updater.get().force().release().start(this);
     }
 
     private boolean onVersionDev(View view) {
-        Updater.get().force().dev().start();
+        Updater.get().force().dev().start(this);
         return true;
     }
 

File: app/src/main/java/com/fongmi/android/tv/utils/M3U8.java
Patch:
@@ -20,6 +20,7 @@ public class M3U8 {
 
     private static final String TAG_DISCONTINUITY = "#EXT-X-DISCONTINUITY";
     private static final String TAG_MEDIA_DURATION = "#EXTINF";
+    private static final String TAG_ENDLIST = "#EXT-X-ENDLIST";
     private static final String TAG_KEY = "#EXT-X-KEY";
 
     private static final Pattern REGEX_X_DISCONTINUITY = Pattern.compile("#EXT-X-DISCONTINUITY[\\s\\S]*?(?=#EXT-X-DISCONTINUITY|$)");
@@ -59,7 +60,7 @@ private static String scan(String line, List<String> ads) {
             BigDecimal t = BigDecimal.ZERO;
             Matcher m2 = REGEX_MEDIA_DURATION.matcher(group);
             while (m2.find()) t = t.add(new BigDecimal(m2.group(1)));
-            for (String ad : ads) if (t.toString().startsWith(ad)) line = line.replace(group + "\n" + TAG_DISCONTINUITY, "");
+            for (String ad : ads) if (t.toString().startsWith(ad)) line = line.replace(group.replace(TAG_ENDLIST, ""), "");
         }
         return line;
     }

File: app/src/main/java/com/fongmi/android/tv/server/Nano.java
Patch:
@@ -20,7 +20,6 @@
 import java.util.HashMap;
 import java.util.List;
 import java.util.Map;
-import java.util.TreeMap;
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 
@@ -101,9 +100,8 @@ private Response m3u8(IHTTPSession session) {
 
     private Response proxy(IHTTPSession session) {
         try {
-            Map<String, String> params = new TreeMap<>(String.CASE_INSENSITIVE_ORDER);
+            Map<String, String> params = session.getParms();
             params.putAll(session.getHeaders());
-            params.putAll(session.getParms());
             Object[] rs = ApiConfig.get().proxyLocal(params);
             return rs[0] instanceof Response ? (Response) rs[0] : newChunkedResponse(Response.Status.lookup((Integer) rs[0]), (String) rs[1], (InputStream) rs[2]);
         } catch (Exception e) {

File: app/src/main/java/com/fongmi/android/tv/utils/M3U8.java
Patch:
@@ -59,7 +59,7 @@ private static String scan(String line, List<String> ads) {
             BigDecimal t = BigDecimal.ZERO;
             Matcher m2 = REGEX_MEDIA_DURATION.matcher(group);
             while (m2.find()) t = t.add(new BigDecimal(m2.group(1)));
-            for (String ad : ads) if (t.toString().startsWith(ad)) line = line.replace(group, "");
+            for (String ad : ads) if (t.toString().startsWith(ad)) line = line.replace(group + "\n" + TAG_DISCONTINUITY, "");
         }
         return line;
     }

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -42,7 +42,6 @@
 import com.fongmi.android.tv.bean.Drm;
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.bean.Sub;
-import com.fongmi.android.tv.utils.Sniffer;
 import com.fongmi.android.tv.utils.UrlUtil;
 import com.github.catvod.net.OkHttp;
 import com.github.catvod.utils.Path;

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -176,6 +176,7 @@ public boolean onNavigationItemSelected(@NonNull MenuItem item) {
         if (mBinding.navigation.getSelectedItemId() == item.getItemId()) return false;
         if (item.getItemId() == R.id.vod) return mManager.change(0);
         if (item.getItemId() == R.id.setting) return mManager.change(1);
+        if (item.getItemId() == R.id.live) return openLive();
         return false;
     }
 

File: app/src/main/java/com/fongmi/android/tv/ui/dialog/TrackDialog.java
Patch:
@@ -79,6 +79,7 @@ protected void initView() {
         binding.recycler.setAdapter(adapter.addAll(getTrack()));
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
         binding.recycler.post(() -> binding.recycler.scrollToPosition(adapter.getSelected()));
+        binding.recycler.setVisibility(adapter.getItemCount() == 0 ? View.GONE : View.VISIBLE);
         binding.choose.setVisibility(type == C.TRACK_TYPE_TEXT && player.isExo() ? View.VISIBLE : View.GONE);
         binding.size.setVisibility(type == C.TRACK_TYPE_TEXT ? View.VISIBLE : View.GONE);
         binding.title.setText(ResUtil.getStringArray(R.array.select_track)[type - 1]);

File: app/src/main/java/com/fongmi/android/tv/utils/FileChooser.java
Patch:
@@ -49,9 +49,11 @@ public void show(String[] mimeTypes) {
     public void show(String mimeType, String[] mimeTypes, int code) {
         Intent intent = new Intent(Intent.ACTION_OPEN_DOCUMENT);
         intent.setType(mimeType);
+        intent.addCategory(Intent.CATEGORY_OPENABLE);
         intent.putExtra(Intent.EXTRA_LOCAL_ONLY, true);
         intent.putExtra(Intent.EXTRA_MIME_TYPES, mimeTypes);
         intent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, false);
+        intent.putExtra("android.content.extra.SHOW_ADVANCED", true);
         if (intent.resolveActivity(App.get().getPackageManager()) == null) return;
         if (fragment != null) fragment.startActivityForResult(Intent.createChooser(intent, ""), code);
     }

File: app/src/main/java/com/fongmi/android/tv/utils/FileChooser.java
Patch:
@@ -39,7 +39,7 @@ public void show() {
     }
 
     public void show(String mimeType) {
-        show(mimeType, null, REQUEST_PICK_FILE);
+        show(mimeType, new String[]{"*/*"}, REQUEST_PICK_FILE);
     }
 
     public void show(String[] mimeTypes) {

File: app/src/main/java/com/fongmi/android/tv/ui/dialog/TrackDialog.java
Patch:
@@ -21,6 +21,7 @@
 import com.fongmi.android.tv.player.Players;
 import com.fongmi.android.tv.player.TrackNameProvider;
 import com.fongmi.android.tv.ui.adapter.TrackAdapter;
+import com.fongmi.android.tv.ui.custom.SpaceItemDecoration;
 import com.fongmi.android.tv.utils.FileChooser;
 import com.fongmi.android.tv.utils.ResUtil;
 import com.google.android.material.bottomsheet.BottomSheetDialogFragment;
@@ -35,8 +36,8 @@ public final class TrackDialog extends BaseDialog implements TrackAdapter.OnClic
     private final TrackNameProvider provider;
     private final TrackAdapter adapter;
     private DialogTrackBinding binding;
+    private FragmentActivity activity;
     private Listener listener;
-    private Activity activity;
     private Players player;
     private int type;
 
@@ -75,6 +76,7 @@ protected ViewBinding getBinding(@NonNull LayoutInflater inflater, @Nullable Vie
     protected void initView() {
         binding.recycler.setHasFixedSize(true);
         binding.recycler.setAdapter(adapter.addAll(getTrack()));
+        binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
         binding.recycler.post(() -> binding.recycler.scrollToPosition(adapter.getSelected()));
         binding.choose.setVisibility(type == C.TRACK_TYPE_TEXT && player.isExo() ? View.VISIBLE : View.GONE);
         binding.size.setVisibility(type == C.TRACK_TYPE_TEXT ? View.VISIBLE : View.GONE);

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -177,6 +177,7 @@ public void playerContent(String key, String flag, String id) {
                 Result result = new Result();
                 result.setParse(0);
                 result.setFlag(flag);
+                result.setUrl(Url.create().add(id));
                 result.setUrl(Source.get().fetch(result));
                 return result;
             } else {

File: app/src/main/java/com/fongmi/android/tv/utils/M3U8.java
Patch:
@@ -59,7 +59,7 @@ private static String scan(String line, List<String> ads) {
             BigDecimal t = BigDecimal.ZERO;
             Matcher m2 = REGEX_MEDIA_DURATION.matcher(group);
             while (m2.find()) t = t.add(new BigDecimal(m2.group(1)));
-            for (String ad : ads) if (t.toString().startsWith(ad)) line = line.replaceAll(group, "");
+            for (String ad : ads) if (t.toString().startsWith(ad)) line = line.replace(group, "");
         }
         return line;
     }

File: app/src/main/java/com/fongmi/android/tv/db/AppDatabase.java
Patch:
@@ -48,7 +48,7 @@ public static synchronized AppDatabase get() {
     }
 
     public static String getDate() {
-        return Setting.isBackupAuto() ? ResUtil.getString(R.string.setting_backup_auto) : getBackupKey().exists() ? Util.format(new SimpleDateFormat("yyyyMMdd", Locale.getDefault()), getBackupKey().lastModified()) : "";
+        return Setting.isBackupAuto() ? ResUtil.getString(R.string.setting_backup_auto) : getBackupKey().exists() ? Util.format(new SimpleDateFormat("MMddHHmmss", Locale.getDefault()), new File(Path.tv(), NAME).lastModified()) : "";
     }
 
     public static File getBackupKey() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingPlayerActivity.java
Patch:
@@ -47,6 +47,7 @@ protected void initView() {
         mBinding.captionText.setText(getSwitch(Setting.isCaption()));
         mBinding.bufferText.setText(String.valueOf(Setting.getBuffer()));
         mBinding.subtitleText.setText(String.valueOf(Setting.getSubtitle()));
+        mBinding.caption.setVisibility(Setting.hasCaption() ? View.VISIBLE : View.GONE);
         mBinding.http.setVisibility(Players.isExo(Setting.getPlayer()) ? View.VISIBLE : View.GONE);
         mBinding.buffer.setVisibility(Players.isExo(Setting.getPlayer()) ? View.VISIBLE : View.GONE);
         mBinding.tunnel.setVisibility(Players.isExo(Setting.getPlayer()) ? View.VISIBLE : View.GONE);

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingPlayerFragment.java
Patch:
@@ -72,6 +72,7 @@ protected void initEvent() {
     }
 
     private void setVisible() {
+        mBinding.caption.setVisibility(Setting.hasCaption() ? View.VISIBLE : View.GONE);
         mBinding.http.setVisibility(Players.isExo(Setting.getPlayer()) ? View.VISIBLE : View.GONE);
         mBinding.buffer.setVisibility(Players.isExo(Setting.getPlayer()) ? View.VISIBLE : View.GONE);
         mBinding.tunnel.setVisibility(Players.isExo(Setting.getPlayer()) ? View.VISIBLE : View.GONE);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -8,7 +8,7 @@
 import android.net.Uri;
 import android.support.v4.media.MediaMetadataCompat;
 import android.text.Html;
-import android.text.SpannableString;
+import android.text.SpannableStringBuilder;
 import android.text.Spanned;
 import android.text.TextUtils;
 import android.text.style.ClickableSpan;
@@ -541,7 +541,7 @@ private void setText(TextView view, int resId, String text) {
         view.setTag(text);
     }
 
-    private SpannableString getSpan(int resId, String text) {
+    private SpannableStringBuilder getSpan(int resId, String text) {
         if (resId > 0) text = getString(resId, text);
         Map<String, String> map = new HashMap<>();
         Matcher m = Sniffer.CLICKER.matcher(text);
@@ -550,7 +550,7 @@ private SpannableString getSpan(int resId, String text) {
             text = text.replace(m.group(), key);
             map.put(key, m.group(1));
         }
-        SpannableString span = new SpannableString(text);
+        SpannableStringBuilder span = SpannableStringBuilder.valueOf(text);
         for (String s : map.keySet()) {
             int index = text.indexOf(s);
             Result result = Result.type(map.get(s));

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -13,7 +13,7 @@
 import android.provider.Settings;
 import android.support.v4.media.MediaMetadataCompat;
 import android.text.Html;
-import android.text.SpannableString;
+import android.text.SpannableStringBuilder;
 import android.text.Spanned;
 import android.text.TextUtils;
 import android.text.style.ClickableSpan;
@@ -518,7 +518,7 @@ private void setText(TextView view, int resId, String text) {
         view.setTag(text);
     }
 
-    private SpannableString getSpan(int resId, String text) {
+    private SpannableStringBuilder getSpan(int resId, String text) {
         if (resId > 0) text = getString(resId, text);
         Map<String, String> map = new HashMap<>();
         Matcher m = Sniffer.CLICKER.matcher(text);
@@ -527,7 +527,7 @@ private SpannableString getSpan(int resId, String text) {
             text = text.replace(m.group(), key);
             map.put(key, m.group(1));
         }
-        SpannableString span = new SpannableString(text);
+        SpannableStringBuilder span = new SpannableStringBuilder(text);
         for (String s : map.keySet()) {
             int index = text.indexOf(s);
             Result result = Result.type(map.get(s));

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -53,7 +53,7 @@ public static void start(Activity activity, String key, Result result) {
         Intent intent = new Intent(activity, VodActivity.class);
         intent.putExtra("key", key);
         intent.putExtra("result", result);
-        for (Map.Entry<String, List<Filter>> entry : result.getFilters().entrySet()) Prefers.put("filter_" + entry.getKey(), App.gson().toJson(entry.getValue()));
+        for (Map.Entry<String, List<Filter>> entry : result.getFilters().entrySet()) Prefers.put("filter_" + key + "_" + entry.getKey(), App.gson().toJson(entry.getValue()));
         activity.startActivity(intent);
     }
 
@@ -66,7 +66,7 @@ private Result getResult() {
     }
 
     private List<Filter> getFilter(String typeId) {
-        return Filter.arrayFrom(Prefers.getString("filter_" + typeId));
+        return Filter.arrayFrom(Prefers.getString("filter_" + getKey() + "_" + typeId));
     }
 
     private Site getSite() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -80,7 +80,7 @@ private String getTypeId() {
     }
 
     private List<Filter> getFilter() {
-        return Filter.arrayFrom(Prefers.getString("filter_" + getTypeId()));
+        return Filter.arrayFrom(Prefers.getString("filter_" + getKey() + "_" + getTypeId()));
     }
 
     private HashMap<String, String> getExtend() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CastActivity.java
Patch:
@@ -401,8 +401,8 @@ public void onTrackClick(Track item) {
 
     @Override
     public void onTimeChanged() {
-        App.post(() -> position = mPlayers.getPosition());
-        App.post(() -> duration = mPlayers.getDuration());
+        position = mPlayers.getPosition();
+        duration = mPlayers.getDuration();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/db/AppDatabase.java
Patch:
@@ -51,6 +51,7 @@ public static String getDate() {
 
     public static void backup(com.fongmi.android.tv.impl.Callback callback) {
         App.execute(() -> {
+            if (get().isOpen()) get().close();
             File db = App.get().getDatabasePath(NAME).getAbsoluteFile();
             File wal = App.get().getDatabasePath(NAME + "-wal").getAbsoluteFile();
             File shm = App.get().getDatabasePath(NAME + "-shm").getAbsoluteFile();
@@ -64,6 +65,7 @@ public static void backup(com.fongmi.android.tv.impl.Callback callback) {
 
     public static void restore(com.fongmi.android.tv.impl.Callback callback) {
         App.execute(() -> {
+            if (get().isOpen()) get().close();
             File db = new File(Path.tv(), NAME);
             File wal = new File(Path.tv(), NAME + "-wal");
             File shm = new File(Path.tv(), NAME + "-shm");

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -205,8 +205,8 @@ public void success() {
 
     private void setFocus() {
         setLoading(false);
-        mBinding.recycler.requestFocus();
         App.post(() -> mBinding.title.setFocusable(true), 500);
+        if (!mBinding.title.hasFocus()) mBinding.recycler.requestFocus();
     }
 
     private void getVideo() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomTitleView.java
Patch:
@@ -47,9 +47,7 @@ private boolean hasEvent(KeyEvent event) {
     @Override
     protected void onFocusChanged(boolean focused, int direction, Rect previouslyFocusedRect) {
         super.onFocusChanged(focused, direction, previouslyFocusedRect);
-        App.post(() -> coolDown = false, 500);
         if (focused) startAnimation(flicker);
-        if (focused) coolDown = true;
         else clearAnimation();
     }
 
@@ -67,7 +65,7 @@ private boolean onKeyDown(KeyEvent event) {
             listener.setSite(getSite(true));
         } else if (event.getAction() == KeyEvent.ACTION_DOWN && KeyUtil.isRightKey(event)) {
             listener.setSite(getSite(false));
-        } else if (event.getAction() == KeyEvent.ACTION_UP && KeyUtil.isUpKey(event)) {
+        } else if (event.getAction() == KeyEvent.ACTION_DOWN && KeyUtil.isUpKey(event)) {
             onKeyUp();
         }
         return true;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -453,7 +453,7 @@ public void onBackPressed() {
         } else if (!confirm) {
             setConfirm();
         } else {
-            super.onBackPressed();
+            finish();
         }
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -196,7 +196,7 @@ public void onBackPressed() {
             mBinding.navigation.setSelectedItemId(R.id.vod);
         } else if (mManager.canBack(0)) {
             if (!confirm) setConfirm();
-            else super.onBackPressed();
+            else finish();
         }
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/cast/CastDevice.java
Patch:
@@ -51,9 +51,8 @@ public Device remove(org.fourthline.cling.model.meta.Device<?, ?, ?> device) {
         return create(device);
     }
 
-    public void clear() {
+    public void disconnect() {
         for (org.fourthline.cling.model.meta.Device<?, ?, ?> device : devices) DLNACastManager.INSTANCE.disconnectDevice(device);
-        devices.clear();
     }
 
     public org.fourthline.cling.model.meta.Device<?, ?, ?> find(com.fongmi.android.tv.bean.Device item) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/CastDialog.java
Patch:
@@ -58,7 +58,6 @@ public class CastDialog extends BaseDialog implements DeviceAdapter.OnClickListe
     private DeviceAdapter adapter;
     private DeviceControl control;
     private CastVideo video;
-    private long position;
     private boolean fm;
 
     public static CastDialog create() {
@@ -79,7 +78,6 @@ public CastDialog history(History history) {
         if (fd.startsWith("file")) fd = Server.get().getAddress() + "/" + fd.replace(Path.rootPath(), "");
         if (fd.contains("127.0.0.1")) fd = fd.replace("127.0.0.1", Server.get().getIP());
         body.add("history", history.toString().replace(id, fd));
-        position = history.getPosition();
         return this;
     }
 
@@ -125,6 +123,7 @@ private void setRecyclerView() {
 
     private void getDevice() {
         if (fm) adapter.addAll(Device.getAll());
+        adapter.addAll(CastDevice.get().getAll());
     }
 
     private void initDLNA() {
@@ -203,7 +202,7 @@ public void onItemClick(Device item) {
     @Override
     public void onDestroyView() {
         super.onDestroyView();
-        CastDevice.get().clear();
+        CastDevice.get().disconnect();
         EventBus.getDefault().unregister(this);
         DLNACastManager.INSTANCE.unregisterListener(this);
         DLNACastManager.INSTANCE.unbindCastService(App.get());

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -11,6 +11,7 @@
 import android.text.TextUtils;
 
 import androidx.annotation.NonNull;
+import androidx.media3.common.AudioAttributes;
 import androidx.media3.common.PlaybackException;
 import androidx.media3.common.Player;
 import androidx.media3.exoplayer.ExoPlayer;
@@ -120,7 +121,8 @@ public void set(PlayerView exo, IjkVideoView ijk) {
     }
 
     private void setupExo(PlayerView view) {
-        exoPlayer = new ExoPlayer.Builder(App.get()).setLoadControl(ExoUtil.buildLoadControl()).setRenderersFactory(ExoUtil.buildRenderersFactory()).setTrackSelector(ExoUtil.buildTrackSelector()).build();
+        exoPlayer = new ExoPlayer.Builder(App.get()).setLooper(App.looper()).setLoadControl(ExoUtil.buildLoadControl()).setRenderersFactory(ExoUtil.buildRenderersFactory()).setTrackSelector(ExoUtil.buildTrackSelector()).build();
+        exoPlayer.setAudioAttributes(AudioAttributes.DEFAULT, true);
         exoPlayer.addAnalyticsListener(new EventLogger());
         exoPlayer.addAnalyticsListener(this);
         exoPlayer.setPlayWhenReady(true);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -189,7 +189,7 @@ public static void start(Activity activity, String key, String id, String name,
     }
 
     public static void start(Activity activity, String key, String id, String name, String pic, boolean collect, String mark) {
-        Intent intent = new Intent(activity, VideoActivity.class);
+        Intent intent = new Intent(activity, VideoActivity.class).addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
         intent.putExtra("collect", collect);
         intent.putExtra("mark", mark);
         intent.putExtra("name", name);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -81,6 +81,7 @@
 import com.fongmi.android.tv.utils.ResUtil;
 import com.fongmi.android.tv.utils.Sniffer;
 import com.fongmi.android.tv.utils.Traffic;
+import com.fongmi.android.tv.utils.Util;
 import com.github.bassaer.library.MDColor;
 import com.github.catvod.net.OkHttp;
 import com.github.catvod.utils.Trans;
@@ -859,12 +860,13 @@ private void setEnding(long ending) {
 
     private boolean onChoose() {
         Intent intent = new Intent(Intent.ACTION_VIEW);
+        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
         intent.putExtra("return_result", true);
         intent.putExtra("headers", mPlayers.getHeaderArray());
         intent.putExtra("position", (int) mPlayers.getPosition());
         intent.putExtra("title", mBinding.widget.title.getText());
         intent.setDataAndType(Uri.parse(mPlayers.getUrl()), "video/*");
-        startActivityForResult(Intent.createChooser(intent, null), 1001);
+        startActivityForResult(Util.getChooser(intent), 1001);
         return true;
     }
 

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomRecyclerView.java
Patch:
@@ -69,13 +69,14 @@ public boolean dispatchTouchEvent(MotionEvent event) {
             case MotionEvent.ACTION_DOWN:
                 x1 = event.getX();
                 y1 = event.getY();
+                getParent().requestDisallowInterceptTouchEvent(true);
                 break;
             case MotionEvent.ACTION_MOVE:
                 float x2 = event.getX();
                 float y2 = event.getY();
                 float offsetX = Math.abs(x2 - x1);
                 float offsetY = Math.abs(y2 - y1);
-                if (Math.abs(offsetX) >= Math.abs(offsetY)) getParent().requestDisallowInterceptTouchEvent(false);
+                if (Math.abs(offsetX) > Math.abs(offsetY)) getParent().requestDisallowInterceptTouchEvent(false);
                 break;
         }
         return super.dispatchTouchEvent(event);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -183,7 +183,7 @@ public PageAdapter(@NonNull FragmentManager fm) {
         @Override
         public Fragment getItem(int position) {
             Class type = (Class) mAdapter.get(position);
-            return VodFragment.newInstance(getKey(), type.getTypeId(), type.getStyle(), type.getExtend(), type.getTypeFlag().equals("1"));
+            return VodFragment.newInstance(getKey(), type.getTypeId(), type.getStyle(), type.getExtend(false), type.getTypeFlag().equals("1"));
         }
 
         @Override

File: app/src/main/java/com/fongmi/android/tv/bean/Class.java
Patch:
@@ -133,9 +133,9 @@ public Style getStyle() {
         return Style.get(getLand(), getCircle(), getRatio());
     }
 
-    public HashMap<String, String> getExtend() {
+    public HashMap<String, String> getExtend(boolean change) {
         HashMap<String, String> extend = new HashMap<>();
-        for (Filter filter : getFilters()) if (filter.getInit() != null) extend.put(filter.getKey(), filter.setActivated(filter.getInit()));
+        for (Filter filter : getFilters()) if (filter.getInit() != null) extend.put(filter.getKey(), change ? filter.setActivated(filter.getInit()) : filter.getInit());
         return extend;
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -302,7 +302,7 @@ public PageAdapter(@NonNull FragmentManager fm) {
         @Override
         public Fragment getItem(int position) {
             Class type = mAdapter.get(position);
-            return TypeFragment.newInstance(getSite().getKey(), type.getTypeId(), type.getStyle(), type.getExtend(), type.getTypeFlag().equals("1"));
+            return TypeFragment.newInstance(getSite().getKey(), type.getTypeId(), type.getStyle(), type.getExtend(true), type.getTypeFlag().equals("1"));
         }
 
         @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -53,7 +53,7 @@ public static void start(Activity activity, String key, Result result) {
         Intent intent = new Intent(activity, VodActivity.class);
         intent.putExtra("key", key);
         intent.putExtra("result", result);
-        for (Map.Entry<String, List<Filter>> entry : result.getFilters().entrySet()) Prefers.put(entry.getKey(), App.gson().toJson(entry.getValue()));
+        for (Map.Entry<String, List<Filter>> entry : result.getFilters().entrySet()) Prefers.put("filter_" + entry.getKey(), App.gson().toJson(entry.getValue()));
         activity.startActivity(intent);
     }
 
@@ -66,7 +66,7 @@ private Result getResult() {
     }
 
     private List<Filter> getFilter(String typeId) {
-        return Filter.arrayFrom(Prefers.getString(typeId));
+        return Filter.arrayFrom(Prefers.getString("filter_" + typeId));
     }
 
     private Site getSite() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -80,7 +80,7 @@ private String getTypeId() {
     }
 
     private List<Filter> getFilter() {
-        return Filter.arrayFrom(Prefers.getString(getTypeId()));
+        return Filter.arrayFrom(Prefers.getString("filter_" + getTypeId()));
     }
 
     private HashMap<String, String> getExtend() {

File: thunder/src/main/java/com/xunlei/downloadlib/XLDownloadManager.java
Patch:
@@ -49,7 +49,7 @@ public void release() {
     }
 
     private String getPeerId() {
-        String uuid = Prefers.getString("phoneId5", "");
+        String uuid = Prefers.getString("phoneId5");
         if (uuid.isEmpty()) Prefers.put("phoneId5", uuid = XLUtil.getPeerId());
         return uuid;
     }

File: danmaku/src/main/java/master/flame/danmaku/danmaku/model/ICacheManager.java
Patch:
@@ -22,4 +22,6 @@
 public interface ICacheManager {
 
     void addDanmaku(BaseDanmaku danmaku);
+
+    void buildDanmakuCache(BaseDanmaku danmaku);
 }

File: danmaku/src/main/java/master/flame/danmaku/danmaku/model/android/DrawingCacheHolder.java
Patch:
@@ -56,6 +56,7 @@ public void erase() {
     }
 
     public synchronized void recycle() {
+        canvas = null;
         Bitmap bitmapReserve = bitmap;
         bitmap = null;
         width = height = 0;

File: danmaku/src/main/java/master/flame/danmaku/danmaku/util/DanmakuUtils.java
Patch:
@@ -84,7 +84,7 @@ public static int compare(BaseDanmaku obj1, BaseDanmaku obj2) {
         else if (val < 0) return -1;
         int r = obj1.index - obj2.index;
         if (r != 0) return r < 0 ? -1 : 1;
-        r = obj1.hashCode() - obj1.hashCode();
+        r = obj1.hashCode() - obj2.hashCode();
         return r;
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -1,7 +1,7 @@
 package com.fongmi.android.tv.ui.activity;
 
 import android.annotation.SuppressLint;
-import android.app.Activity;
+import android.content.Context;
 import android.content.Intent;
 import android.graphics.drawable.Drawable;
 import android.view.KeyEvent;
@@ -100,8 +100,8 @@ public class LiveActivity extends BaseActivity implements GroupPresenter.OnClick
     private int toggleCount;
     private int count;
 
-    public static void start(Activity activity) {
-        if (!LiveConfig.isEmpty()) activity.startActivity(new Intent(activity, LiveActivity.class));
+    public static void start(Context context) {
+        if (!LiveConfig.isEmpty()) context.startActivity(new Intent(context, LiveActivity.class).addFlags(Intent.FLAG_ACTIVITY_NEW_TASK));
     }
 
     private PlayerView getExo() {

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -155,8 +155,8 @@ private void add(Live live) {
     }
 
     private void bootLive() {
-        LiveActivity.start(App.activity());
         Setting.putBootLive(false);
+        LiveActivity.start(App.get());
     }
 
     public void parse(JsonObject object) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -1,7 +1,7 @@
 package com.fongmi.android.tv.ui.activity;
 
 import android.annotation.SuppressLint;
-import android.app.Activity;
+import android.content.Context;
 import android.content.Intent;
 import android.content.pm.ActivityInfo;
 import android.content.res.Configuration;
@@ -110,8 +110,8 @@ public class LiveActivity extends BaseActivity implements CustomKeyDownLive.List
     private int passCount;
     private PiP mPiP;
 
-    public static void start(Activity activity) {
-        if (!LiveConfig.isEmpty()) activity.startActivity(new Intent(activity, LiveActivity.class));
+    public static void start(Context context) {
+        if (!LiveConfig.isEmpty()) context.startActivity(new Intent(context, LiveActivity.class).addFlags(Intent.FLAG_ACTIVITY_NEW_TASK));
     }
 
     private PlayerView getExo() {

File: app/src/main/java/com/fongmi/android/tv/utils/UrlUtil.java
Patch:
@@ -37,6 +37,7 @@ public static String path(Uri uri) {
     }
 
     public static String convert(String baseUrl, String path) {
+        if (path.startsWith("clan")) return fixUrl(path);
         return path.isEmpty() ? "" : UriUtil.resolve(baseUrl, path);
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -274,7 +274,7 @@ public void onItemClick(int position, Collect item) {
     @Override
     public void onItemClick(Vod item) {
         if (item.isFolder()) FolderActivity.start(this, item.getSiteKey(), Result.folder(item));
-        else VideoActivity.start(this, item.getSiteKey(), item.getVodId(), item.getVodName(), item.getVodPic());
+        else VideoActivity.start(this, item.getSiteKey(), item.getVodId(), item.getVodName(), item.getVodPic(), true);
     }
 
     @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -215,7 +215,7 @@ public void onItemClick(Vod item) {
             getVideo(item.getVodId(), "1");
         } else {
             if (item.isManga()) DetailActivity.start(getActivity(), getKey(), item.getVodId(), item.getVodName(), item.getVodPic());
-            else VideoActivity.start(getActivity(), getKey(), item.getVodId(), item.getVodName(), item.getVodPic(), isFolder() ? item.getVodName() : null);
+            else VideoActivity.start(getActivity(), getKey(), item.getVodId(), item.getVodName(), item.getVodPic(), false, isFolder() ? item.getVodName() : null);
         }
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/ConfigDialog.java
Patch:
@@ -23,6 +23,7 @@
 import com.fongmi.android.tv.ui.custom.CustomTextListener;
 import com.fongmi.android.tv.utils.QRCode;
 import com.fongmi.android.tv.utils.ResUtil;
+import com.fongmi.android.tv.utils.UrlUtil;
 import com.fongmi.android.tv.utils.Utils;
 import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 import com.permissionx.guolindev.PermissionX;
@@ -131,7 +132,7 @@ private void detect(String s) {
     }
 
     private void onPositive(View view) {
-        String text = Utils.checkClan(binding.text.getText().toString().trim());
+        String text = UrlUtil.checkClan(binding.text.getText().toString().trim());
         if (text.isEmpty()) Config.delete(url, type);
         callback.setConfig(Config.find(text, type));
         dialog.dismiss();

File: app/src/main/java/com/fongmi/android/tv/bean/Danmu.java
Patch:
@@ -21,6 +21,7 @@ public static Danmu fromXml(String str) {
         try {
             return new Persister().read(Danmu.class, str);
         } catch (Exception e) {
+            e.printStackTrace();
             return new Danmu();
         }
     }
@@ -34,7 +35,7 @@ public static class Data {
         @Attribute(name = "p", required = false)
         public String param;
 
-        @Text
+        @Text(required = false)
         public String text;
 
         public String getParam() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -539,6 +539,7 @@ private SpannableString getSpan(int resId, String text) {
         SpannableString span = new SpannableString(text);
         for (String s : map.keySet()) {
             int index = text.indexOf(s);
+            if (index == -1) continue;
             span.setSpan(getClickableSpan(map.get(s)), index, index + s.length(), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);
         }
         return span;

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -518,6 +518,7 @@ private SpannableString getSpan(int resId, String text) {
         SpannableString span = new SpannableString(text);
         for (String s : map.keySet()) {
             int index = text.indexOf(s);
+            if (index == -1) continue;
             span.setSpan(getClickableSpan(map.get(s)), index, index + s.length(), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);
         }
         return span;

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -62,7 +62,7 @@ public class ExoUtil {
     private static Cache cache;
 
     public static LoadControl buildLoadControl() {
-        return new DefaultLoadControl(Setting.getBuffer());
+        return new DefaultLoadControl();
     }
 
     public static TrackSelector buildTrackSelector() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -81,6 +81,7 @@
 import com.fongmi.android.tv.utils.Utils;
 import com.github.bassaer.library.MDColor;
 import com.github.catvod.net.OkHttp;
+import com.github.catvod.utils.Trans;
 import com.permissionx.guolindev.PermissionX;
 
 import org.greenrobot.eventbus.Subscribe;
@@ -547,7 +548,7 @@ private String findClicker(String text, Map<String, String> map) {
         Matcher m = Sniffer.CLICKER.matcher(text);
         while (m.find()) {
             String val = m.group(1);
-            String key = m.group(2);
+            String key = Trans.s2t(m.group(2));
             text = text.replace(m.group(), key);
             map.put(key, val);
         }

File: app/src/main/java/com/fongmi/android/tv/bean/Result.java
Patch:
@@ -128,7 +128,7 @@ public static Result folder(Vod item) {
     public static Result type(String json) {
         Result result = new Result();
         result.setTypes(List.of(Class.objectFrom(json)));
-        return result;
+        return result.trans();
     }
 
     public static Result list(List<Vod> items) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -93,6 +93,7 @@
 import com.fongmi.android.tv.utils.Utils;
 import com.github.bassaer.library.MDColor;
 import com.github.catvod.net.OkHttp;
+import com.github.catvod.utils.Trans;
 import com.github.catvod.utils.Util;
 import com.google.android.material.bottomsheet.BottomSheetDialogFragment;
 import com.permissionx.guolindev.PermissionX;
@@ -526,7 +527,7 @@ private String findClicker(String text, Map<String, String> map) {
         Matcher m = Sniffer.CLICKER.matcher(text);
         while (m.find()) {
             String val = m.group(1);
-            String key = m.group(2);
+            String key = Trans.s2t(m.group(2));
             text = text.replace(m.group(), key);
             map.put(key, val);
         }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1576,6 +1576,7 @@ public void onDoubleTap() {
     @Override
     protected void onUserLeaveHint() {
         super.onUserLeaveHint();
+        if (isRedirect()) return;
         mPiP.enter(this, getScale() == 2);
         if (isLock()) App.post(this::onLock, 500);
     }

File: catvod/src/main/java/com/github/catvod/utils/Crypto.java
Patch:
@@ -1,4 +1,4 @@
-package com.fongmi.quickjs.utils;
+package com.github.catvod.utils;
 
 import android.util.Base64;
 

File: quickjs/src/main/java/com/fongmi/quickjs/method/Global.java
Patch:
@@ -5,7 +5,7 @@
 
 import com.fongmi.quickjs.bean.Req;
 import com.fongmi.quickjs.utils.Connect;
-import com.fongmi.quickjs.utils.Crypto;
+import com.github.catvod.utils.Crypto;
 import com.fongmi.quickjs.utils.JSUtil;
 import com.fongmi.quickjs.utils.Parser;
 import com.fongmi.quickjs.utils.Proxy;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -168,7 +168,7 @@ private void setFabVisible(int position) {
         } else if (mAdapter.get(position).getFilters().size() > 0) {
             mBinding.link.setVisibility(View.GONE);
             mBinding.filter.show();
-        } else if (position == 0) {
+        } else if (position == 0 || mAdapter.get(position).getFilters().isEmpty()) {
             mBinding.link.show();
             mBinding.filter.setVisibility(View.GONE);
         }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -525,11 +525,10 @@ private int getMaxLines() {
 
     private void setText(TextView view, int resId, String text) {
         view.setTag(text);
-        view.setLinksClickable(true);
         view.setLinkTextColor(MDColor.YELLOW_500);
-        view.setMovementMethod(LinkMovementMethod.getInstance());
         view.setVisibility(text.isEmpty() ? View.GONE : View.VISIBLE);
         view.setText(getSpan(resId, text), TextView.BufferType.SPANNABLE);
+        if (Sniffer.CLICKER.matcher(text).find()) view.setMovementMethod(LinkMovementMethod.getInstance());
     }
 
     private SpannableString getSpan(int resId, String text) {
@@ -688,7 +687,7 @@ private void exitFullscreen() {
 
     private void onDesc() {
         CharSequence desc = mBinding.content.getText();
-        if (desc.length() > 0) DescDialog.show(this, desc);
+        if (desc.length() > 3) DescDialog.show(this, desc.subSequence(3, desc.length()));
     }
 
     private void onKeep() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -183,7 +183,7 @@ public PageAdapter(@NonNull FragmentManager fm) {
         @Override
         public Fragment getItem(int position) {
             Class type = (Class) mAdapter.get(position);
-            return VodFragment.newInstance(getKey(), type.getTypeId(), type.getFilters(), type.getExtend(), type.getTypeFlag().equals("1"));
+            return VodFragment.newInstance(getKey(), type.getTypeId(), type.getExtend(), type.getTypeFlag().equals("1"));
         }
 
         @Override

File: app/src/main/java/com/fongmi/android/tv/Setting.java
Patch:
@@ -215,7 +215,7 @@ public static void putHttp(int http) {
     }
 
     public static int getBuffer() {
-        return Math.max(Prefers.getInt("exo_buffer"), 1);
+        return Math.min(Math.max(Prefers.getInt("exo_buffer"), 1), 30);
     }
 
     public static void putBuffer(int buffer) {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -489,6 +489,7 @@ private boolean isIllegal(String url) {
         Uri uri = Uri.parse(Util.fixUrl(url));
         String host = Util.host(uri);
         String scheme = Util.scheme(uri);
+        if (scheme.equals("data")) return false;
         return scheme.isEmpty() || scheme.equals("file") ? !Path.exists(url) : host.isEmpty();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -576,6 +576,7 @@ private void setQualityVisible(boolean visible) {
 
     private void setQualityActivated(Result result) {
         mPlayers.start(result, isUseParse(), getSite().isChangeable() ? getSite().getTimeout() : -1);
+        mBinding.danmaku.hide();
     }
 
     private void reverseEpisode(boolean scroll) {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -570,8 +570,7 @@ public void onCompletion(IMediaPlayer mp) {
     public void prepared() {
         App.post(() -> {
             if (danmuView == null) return;
-            if (!Setting.isDanmu()) danmuView.hide();
-            if (isPlaying() && danmuView.isPrepared()) danmuView.start(getPosition());
+            if (isPlaying() && danmuView.isPrepared()) danmuView.start(getPosition(), Setting.isDanmu());
         });
     }
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -563,6 +563,7 @@ public void onItemClick(Episode item) {
     @Override
     public void onItemClick(Result result) {
         mPlayers.start(result, isUseParse(), getSite().isChangeable() ? getSite().getTimeout() : -1);
+        mBinding.danmaku.hide();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/bean/Class.java
Patch:
@@ -68,7 +68,9 @@ public List<Filter> getFilters() {
     }
 
     public void setFilters(List<Filter> filters) {
+        if (filters == null || filters.isEmpty()) return;
         this.filters = filters;
+        this.setFilter(false);
     }
 
     public void setFilter(Boolean filter) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -593,9 +593,8 @@ private void seamless(Flag flag) {
         setQualityVisible(episode != null && episode.isActivated() && mQualityAdapter.getItemCount() > 1);
         if (episode == null || episode.isActivated()) return;
         if (Setting.getFlag() == 1) {
-            episode.setActivated(true);
-            mBinding.episode.scrollToPosition(mEpisodeAdapter.getPosition());
-            episode.setActivated(false);
+            episode.setSelected(true);
+            mBinding.episode.scrollToPosition(mEpisodeAdapter.getPosition(episode));
         } else {
             mHistory.setVodRemarks(episode.getName());
             onItemClick(episode);

File: app/src/mobile/java/com/fongmi/android/tv/ui/holder/EpisodeGridHolder.java
Patch:
@@ -20,7 +20,7 @@ public EpisodeGridHolder(@NonNull AdapterEpisodeGridBinding binding, EpisodeAdap
 
     @Override
     public void initView(Episode item) {
-        binding.text.setSelected(item.isActivated());
+        binding.text.setSelected(item.isSelected());
         binding.text.setActivated(item.isActivated());
         binding.text.setText(item.getDesc().concat(item.getName()));
         binding.text.setOnClickListener(v -> listener.onItemClick(item));

File: app/src/mobile/java/com/fongmi/android/tv/ui/holder/EpisodeHoriHolder.java
Patch:
@@ -22,7 +22,7 @@ public EpisodeHoriHolder(@NonNull AdapterEpisodeHoriBinding binding, EpisodeAdap
     @Override
     public void initView(Episode item) {
         binding.text.setMaxEms(Product.getEms());
-        binding.text.setSelected(item.isActivated());
+        binding.text.setSelected(item.isSelected());
         binding.text.setActivated(item.isActivated());
         binding.text.setText(item.getDesc().concat(item.getName()));
         binding.text.setOnClickListener(v -> listener.onItemClick(item));

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -117,7 +117,7 @@ public static MediaSource getSource(Map<String, String> headers, String url, int
     }
 
     private static MediaSource getSource(Map<String, String> headers, String url, String format, List<Sub> subs, Drm drm, int errorCode) {
-        Uri uri = Uri.parse(url.trim().replace("\\", ""));
+        Uri uri = Uri.parse(url);
         String mimeType = getMimeType(format, errorCode);
         if (uri.getUserInfo() != null) headers.put(HttpHeaders.AUTHORIZATION, Util.basic(uri));
         return new DefaultMediaSourceFactory(getDataSourceFactory(headers), getExtractorsFactory()).createMediaSource(getMediaItem(uri, mimeType, subs, drm));

File: app/src/main/java/com/fongmi/android/tv/player/IjkUtil.java
Patch:
@@ -24,7 +24,7 @@ public static MediaSource getSource(Channel channel) {
     }
 
     public static MediaSource getSource(Map<String, String> headers, String url) {
-        Uri uri = Uri.parse(url.trim().replace("\\", ""));
+        Uri uri = Uri.parse(url);
         boolean local = Sniffer.getRegex(uri).size() > 0;
         if (local) uri = Uri.parse(Server.get().getAddress().concat("/m3u8?url=").concat(URLEncoder.encode(url)));
         return new MediaSource(Utils.checkUa(headers), uri);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -201,7 +201,7 @@ private void checkFlag(Vod item) {
         if (empty) {
             ErrorEvent.episode();
         } else {
-            onItemClick(mHistory.getFlag(), true);
+            onItemClick(mHistory.getFlag());
             if (mHistory.isRevSort()) reverseEpisode(true);
         }
     }
@@ -222,7 +222,7 @@ private void checkKeepImg() {
     }
 
     @Override
-    public void onItemClick(Flag item, boolean force) {
+    public void onItemClick(Flag item) {
         if (item.isActivated()) return;
         mFlagAdapter.setActivated(item);
         mBinding.flag.scrollToPosition(mFlagAdapter.getPosition());

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/FlagAdapter.java
Patch:
@@ -26,7 +26,7 @@ public FlagAdapter(OnClickListener listener) {
 
     public interface OnClickListener {
 
-        void onItemClick(Flag item, boolean force);
+        void onItemClick(Flag item);
     }
 
     public void addAll(List<Flag> items) {
@@ -81,7 +81,7 @@ public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
         Flag item = mItems.get(position);
         holder.binding.text.setText(item.getShow());
         holder.binding.text.setActivated(item.isActivated());
-        holder.binding.text.setOnClickListener(v -> mListener.onItemClick(item, false));
+        holder.binding.text.setOnClickListener(v -> mListener.onItemClick(item));
     }
 
     static class ViewHolder extends RecyclerView.ViewHolder {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -32,6 +32,7 @@
 import com.fongmi.android.tv.utils.Notify;
 import com.fongmi.android.tv.utils.ResUtil;
 import com.fongmi.android.tv.utils.Utils;
+import com.github.catvod.utils.Path;
 import com.orhanobut.logger.Logger;
 
 import java.util.Formatter;
@@ -488,7 +489,8 @@ private boolean isIllegal(String url) {
         Uri uri = Uri.parse(url);
         String host = com.github.catvod.utils.Util.host(uri);
         String scheme = com.github.catvod.utils.Util.scheme(uri);
-        return !scheme.equals("file") && (host.isEmpty() || scheme.isEmpty());
+        if (scheme.isEmpty()) return !Path.exists(url);
+        return !scheme.equals("file") && host.isEmpty();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -486,7 +486,9 @@ private boolean hasDanmu() {
 
     private boolean isIllegal(String url) {
         Uri uri = Uri.parse(url);
-        return TextUtils.isEmpty(uri.getScheme()) || TextUtils.isEmpty(uri.getHost());
+        String host = com.github.catvod.utils.Util.host(uri);
+        String scheme = com.github.catvod.utils.Util.scheme(uri);
+        return !scheme.equals("file") && (host.isEmpty() || scheme.isEmpty());
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/server/process/Local.java
Patch:
@@ -7,6 +7,7 @@
 
 import java.io.File;
 import java.io.FileInputStream;
+import java.io.FileNotFoundException;
 import java.text.SimpleDateFormat;
 import java.util.Arrays;
 import java.util.Date;
@@ -41,7 +42,8 @@ private NanoHTTPD.Response getFile(String url) {
         try {
             File file = Path.root(url.substring(6));
             if (file.isFile()) return Nano.newChunkedResponse(NanoHTTPD.Response.Status.OK, "application/octet-stream", new FileInputStream(file));
-            else return Nano.success(listFiles(file));
+            if (file.isDirectory()) return Nano.success(listFiles(file));
+            throw new FileNotFoundException();
         } catch (Exception e) {
             return Nano.error(e.getMessage());
         }

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomKeyDownVod.java
Patch:
@@ -37,7 +37,7 @@ public static CustomKeyDownVod create(Activity activity, View videoView) {
     }
 
     private CustomKeyDownVod(Activity activity, View videoView) {
-        this.manager = (AudioManager) App.get().getSystemService(Context.AUDIO_SERVICE);
+        this.manager = (AudioManager) activity.getSystemService(Context.AUDIO_SERVICE);
         this.detector = new GestureDetector(activity, this);
         this.listener = (Listener) activity;
         this.videoView = videoView;

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/CustomKeyDownLive.java
Patch:
@@ -37,7 +37,7 @@ public static CustomKeyDownLive create(Activity activity, View videoView) {
     }
 
     private CustomKeyDownLive(Activity activity, View videoView) {
-        this.manager = (AudioManager) App.get().getSystemService(Context.AUDIO_SERVICE);
+        this.manager = (AudioManager) activity.getSystemService(Context.AUDIO_SERVICE);
         this.detector = new GestureDetector(activity, this);
         this.listener = (Listener) activity;
         this.videoView = videoView;

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/CustomKeyDownVod.java
Patch:
@@ -36,7 +36,7 @@ public static CustomKeyDownVod create(Activity activity, View videoView) {
     }
 
     private CustomKeyDownVod(Activity activity, View videoView) {
-        this.manager = (AudioManager) App.get().getSystemService(Context.AUDIO_SERVICE);
+        this.manager = (AudioManager) activity.getSystemService(Context.AUDIO_SERVICE);
         this.detector = new GestureDetector(activity, this);
         this.listener = (Listener) activity;
         this.videoView = videoView;

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomScroller.java
Patch:
@@ -27,7 +27,7 @@ public void onScrollStateChanged(@NonNull RecyclerView view, int newState) {
     }
 
     private boolean isBottom(RecyclerView view) {
-        if (view.getLayoutManager() == null || view.getLayoutManager().getItemCount() == 0) return false;
+        if (view == null || view.getLayoutManager() == null || view.getLayoutManager().getItemCount() == 0) return false;
         View lastChild = view.getLayoutManager().getChildAt(view.getLayoutManager().getChildCount() - 1);
         int lastPosition = view.getLayoutManager().getPosition(lastChild);
         return lastPosition == view.getLayoutManager().getItemCount() - 1;

File: catvod/src/main/java/com/github/catvod/net/ProxySelector.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.net.Uri;
 
+import com.github.catvod.utils.Util;
 import com.orhanobut.logger.Logger;
 
 import java.io.IOException;
@@ -32,7 +33,7 @@ public void setProxy(String proxy) {
     public List<Proxy> select(URI uri) {
         Logger.t(TAG).d(uri.getHost());
         if (proxy == null || hosts == null || hosts.isEmpty() || uri.getHost() == null || "127.0.0.1".equals(uri.getHost())) return Collections.singletonList(Proxy.NO_PROXY);
-        for (String host : hosts) if (uri.getHost().contains(host) || uri.getHost().matches(host)) return Collections.singletonList(proxy);
+        for (String host : hosts) if (Util.containOrMatch(uri.getHost(), host)) return Collections.singletonList(proxy);
         return Collections.singletonList(Proxy.NO_PROXY);
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -170,7 +170,7 @@ private static synchronized ExtractorsFactory getExtractorsFactory() {
     }
 
     private static synchronized HttpDataSource.Factory getHttpDataSourceFactory() {
-        if (httpDataSourceFactory == null) httpDataSourceFactory = Setting.getHttp() == 0 ? new DefaultHttpDataSource.Factory().setAllowCrossProtocolRedirects(true).setProxy(OkHttp.selector().getProxy()) : new OkHttpDataSource.Factory((Call.Factory) OkHttp.client());
+        if (httpDataSourceFactory == null) httpDataSourceFactory = Setting.getHttp() == 0 ? new DefaultHttpDataSource.Factory().setAllowCrossProtocolRedirects(true) : new OkHttpDataSource.Factory((Call.Factory) OkHttp.client());
         return httpDataSourceFactory;
     }
 

File: catvod/src/main/java/com/github/catvod/net/OkHttp.java
Patch:
@@ -52,6 +52,7 @@ public void setDoh(Doh doh) {
     }
 
     public void setProxy(String proxy) {
+        ProxySelector.setDefault(selector());
         selector().setProxy(proxy);
         client = null;
     }

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -232,9 +232,9 @@ public Spider getCSP(Site site) {
         boolean js = site.getApi().contains(".js");
         boolean py = site.getApi().startsWith("py_");
         boolean csp = site.getApi().startsWith("csp_");
-        if (py) return pyLoader.getSpider(site.getKey(), site.getApi(), site.getExt());
-        else if (js) return jsLoader.getSpider(site.getKey(), site.getApi(), site.getExt(), site.getJar());
-        else if (csp) return jarLoader.getSpider(site.getKey(), site.getApi(), site.getExt(), site.getJar());
+        if (py) return pyLoader.getSpider(site.getKey(), site.getApi(), site.getExt(), site.isProxy());
+        else if (js) return jsLoader.getSpider(site.getKey(), site.getApi(), site.getExt(), site.getJar(), site.isProxy());
+        else if (csp) return jarLoader.getSpider(site.getKey(), site.getApi(), site.getExt(), site.getJar(), site.isProxy());
         else return new SpiderNull();
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/JarLoader.java
Patch:
@@ -101,14 +101,14 @@ public DexClassLoader getLoader(String key, String jar) {
         return loaders.get(key);
     }
 
-    public Spider getSpider(String key, String api, String ext, String jar) {
+    public Spider getSpider(String key, String api, String ext, String jar, boolean proxy) {
         try {
             String jaKey = Util.md5(jar);
             String spKey = jaKey + key;
             if (spiders.containsKey(spKey)) return spiders.get(spKey);
             if (!loaders.containsKey(jaKey)) parseJar(jaKey, jar);
             Spider spider = (Spider) loaders.get(jaKey).loadClass("com.github.catvod.spider." + api.split("csp_")[1]).newInstance();
-            spider.init(App.get(), ext);
+            spider.proxy(proxy).init(App.get(), ext);
             spiders.put(spKey, spider);
             return spider;
         } catch (Throwable e) {

File: app/src/main/java/com/fongmi/android/tv/api/JsLoader.java
Patch:
@@ -39,11 +39,11 @@ private DexClassLoader dex(String key, String jar) {
         }
     }
 
-    public Spider getSpider(String key, String api, String ext, String jar) {
+    public Spider getSpider(String key, String api, String ext, String jar, boolean proxy) {
         try {
             if (spiders.containsKey(key)) return spiders.get(key);
             Spider spider = new com.fongmi.quickjs.crawler.Spider(key, api, dex(key, jar));
-            spider.init(App.get(), ext);
+            spider.proxy(proxy).init(App.get(), ext);
             spiders.put(key, spider);
             return spider;
         } catch (Throwable e) {

File: app/src/main/java/com/fongmi/android/tv/api/PyLoader.java
Patch:
@@ -37,12 +37,12 @@ private void init() {
         }
     }
 
-    public Spider getSpider(String key, String api, String ext) {
+    public Spider getSpider(String key, String api, String ext, boolean proxy) {
         try {
             if (spiders.containsKey(key)) return spiders.get(key);
             Method method = loader.getClass().getMethod("spider", Context.class, String.class, String.class);
             Spider spider = (Spider) method.invoke(loader, App.get(), api.split("py_")[1], ext);
-            spider.init(App.get(), ext);
+            spider.proxy(proxy).init(App.get(), ext);
             spiders.put(key, spider);
             return spider;
         } catch (Throwable e) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -370,6 +370,7 @@ private void setDanmuView() {
         HashMap<Integer, Integer> maxLines = new HashMap<>();
         maxLines.put(BaseDanmaku.TYPE_FIX_TOP, 3);
         maxLines.put(BaseDanmaku.TYPE_SCROLL_RL, 3);
+        maxLines.put(BaseDanmaku.TYPE_SCROLL_LR, 3);
         maxLines.put(BaseDanmaku.TYPE_FIX_BOTTOM, 1);
         mDanmakuContext.setDanmakuStyle(IDisplay.DANMAKU_STYLE_STROKEN, 3).setMaximumLines(maxLines).setDanmakuMargin(12).setScaleTextSize(0.8f);
         mBinding.control.danmu.setActivated(Setting.isDanmu());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -397,6 +397,7 @@ private void setDanmuView() {
         HashMap<Integer, Integer> maxLines = new HashMap<>();
         maxLines.put(BaseDanmaku.TYPE_FIX_TOP, 2);
         maxLines.put(BaseDanmaku.TYPE_SCROLL_RL, 2);
+        maxLines.put(BaseDanmaku.TYPE_SCROLL_LR, 2);
         maxLines.put(BaseDanmaku.TYPE_FIX_BOTTOM, 1);
         mDanmakuContext.setDanmakuStyle(IDisplay.DANMAKU_STYLE_STROKEN, 3).setMaximumLines(maxLines).setDanmakuMargin(8).setScaleTextSize(0.8f);
         checkDanmuImg();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -535,7 +535,7 @@ private void setEpisodeAdapter(List<Episode> items) {
     private void seamless(Flag flag, boolean force) {
         if (Setting.getFlag() == 1 && (mHistory.isNew() || !force)) return;
         Episode episode = flag.find(mHistory.getVodRemarks(), getMark().isEmpty());
-        setQualityVisible(episode != null && episode.isActivated() && mQualityAdapter.getItemCount() > 0);
+        setQualityVisible(episode != null && episode.isActivated() && mQualityAdapter.getItemCount() > 1);
         if (episode == null || episode.isActivated()) return;
         mHistory.setVodRemarks(episode.getName());
         setEpisodeActivated(episode);

File: app/src/main/java/com/fongmi/android/tv/player/IjkUtil.java
Patch:
@@ -25,7 +25,8 @@ public static MediaSource getSource(Channel channel) {
 
     public static MediaSource getSource(Map<String, String> headers, String url) {
         Uri uri = Uri.parse(url.trim().replace("\\", ""));
-        if (Sniffer.isAds(uri)) uri = Uri.parse(Server.get().getAddress().concat("/m3u8?url=").concat(URLEncoder.encode(url)));
+        boolean local = Sniffer.getRegex(uri).size() > 0;
+        if (local) uri = Uri.parse(Server.get().getAddress().concat("/m3u8?url=").concat(URLEncoder.encode(url)));
         return new MediaSource(Utils.checkUa(headers), uri);
     }
 }

File: app/src/main/java/com/fongmi/android/tv/server/Nano.java
Patch:
@@ -1,6 +1,5 @@
 package com.fongmi.android.tv.server;
 
-import android.net.Uri;
 import android.util.Base64;
 
 import com.fongmi.android.tv.api.ApiConfig;
@@ -10,7 +9,6 @@
 import com.fongmi.android.tv.server.process.Local;
 import com.fongmi.android.tv.server.process.Process;
 import com.fongmi.android.tv.utils.M3U8;
-import com.fongmi.android.tv.utils.Sniffer;
 import com.github.catvod.Init;
 
 import java.io.ByteArrayInputStream;
@@ -89,7 +87,6 @@ private Response m3u8(IHTTPSession session) {
         try {
             String url = session.getParms().get("url");
             String result = M3U8.get(url, session.getHeaders());
-            for (String ad : Sniffer.getRegex(Uri.parse(url))) result = result.replaceAll(ad, "");
             return newChunkedResponse(Response.Status.OK, MIME_PLAINTEXT, new ByteArrayInputStream(result.getBytes(StandardCharsets.UTF_8)));
         } catch (Exception e) {
             return error(e.getMessage());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -590,7 +590,7 @@ private void setEpisodeAdapter(List<Episode> items) {
     private void seamless(Flag flag, boolean force) {
         if (Setting.getFlag() == 1 && (mHistory.isNew() || !force)) return;
         Episode episode = flag.find(mHistory.getVodRemarks(), getMark().isEmpty());
-        setQualityVisible(episode != null && episode.isActivated() && mQualityAdapter.getItemCount() > 0);
+        setQualityVisible(episode != null && episode.isActivated() && mQualityAdapter.getItemCount() > 1);
         if (episode == null || episode.isActivated()) return;
         mHistory.setVodRemarks(episode.getName());
         onItemClick(episode);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SearchActivity.java
Patch:
@@ -115,6 +115,7 @@ private void getSuggest(String text) {
         OkHttp.newCall("https://suggest.video.iqiyi.com/?if=mobile&key=" + text).enqueue(new Callback() {
             @Override
             public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {
+                if (mBinding.keyword.getText().toString().trim().isEmpty()) return;
                 List<String> items = Suggest.get(response.body().string());
                 App.post(() -> mWordAdapter.addAll(items));
             }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -212,6 +212,7 @@ private void getSuggest(String text) {
         OkHttp.newCall("https://suggest.video.iqiyi.com/?if=mobile&key=" + text).enqueue(new Callback() {
             @Override
             public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {
+                if (mBinding.keyword.getText().toString().trim().isEmpty()) return;
                 List<String> items = Suggest.get(response.body().string());
                 App.post(() -> mWordAdapter.addAll(items));
             }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -637,7 +637,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getHome().getPlayerType() == -1 && event.isFormat() && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (getHome().getPlayerType() == -1 && event.isFormat() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -556,7 +556,7 @@ private void setEpisodeActivated(Episode item) {
     private void setQualityVisible(boolean visible) {
         mFlagPresenter.setNextFocusDown(visible ? R.id.quality : R.id.episode);
         mEpisodePresenter.setNextFocusUp(visible ? R.id.quality : R.id.flag);
-        mBinding.quality.setVisibility(visible?View.VISIBLE:View.GONE);
+        mBinding.quality.setVisibility(visible ? View.VISIBLE : View.GONE);
         notifyItemChanged(mBinding.episode, mEpisodeAdapter);
         notifyItemChanged(mBinding.flag, mFlagAdapter);
     }
@@ -1088,7 +1088,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getSite().getPlayerType() == -1 && event.isFormat() && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (getSite().getPlayerType() == -1 && event.isFormat() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -732,7 +732,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getHome().getPlayerType() == -1 && event.isFormat() && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (getHome().getPlayerType() == -1 && event.isFormat() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1184,7 +1184,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getSite().getPlayerType() == -1 && event.isFormat() && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
+        if (getSite().getPlayerType() == -1 && event.isFormat() && event.getRetry() > 0 && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/main/java/com/fongmi/android/tv/bean/Url.java
Patch:
@@ -58,7 +58,7 @@ public boolean isEmpty() {
         return getValues().isEmpty() || TextUtils.isEmpty(v());
     }
 
-    public boolean isOnly() {
-        return getValues().size() <= 1;
+    public boolean isMulti() {
+        return getValues().size() > 1;
     }
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -837,8 +837,8 @@ public boolean isRotate() {
 
     public void setRotate(boolean rotate) {
         this.rotate = rotate;
-        if (rotate) resetPadding(mBinding.control.getRoot());
-        else setPadding(mBinding.control.getRoot());
+        if (rotate) noPadding(mBinding.control.getRoot());
+        if (!rotate) setPadding(mBinding.control.getRoot());
     }
 
     public boolean isStop() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/base/BaseActivity.java
Patch:
@@ -79,7 +79,7 @@ protected void setPadding(ViewGroup layout) {
         layout.setPadding(padding, 0, padding, 0);
     }
 
-    protected void resetPadding(ViewGroup layout) {
+    protected void noPadding(ViewGroup layout) {
         layout.setPadding(0, 0, 0, 0);
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -534,7 +534,6 @@ private void setPlayer(Result result) {
     private void checkDanmu(String danmu) {
         mBinding.danmaku.release();
         mBinding.danmaku.setVisibility(danmu.isEmpty() ? View.GONE : View.VISIBLE);
-        mBinding.control.danmu.setVisibility(danmu.isEmpty() ? View.GONE : View.VISIBLE);
         if (danmu.length() > 0) mBinding.danmaku.prepare(new Parser(danmu), mDanmakuContext);
     }
 
@@ -914,6 +913,7 @@ private void hideError() {
     }
 
     private void showControl() {
+        mBinding.control.danmu.setVisibility(isLock() || !mBinding.danmaku.isPrepared() ? View.GONE : View.VISIBLE);
         mBinding.control.setting.setVisibility(mHistory == null || isFullscreen() ? View.GONE : View.VISIBLE);
         mBinding.control.right.rotate.setVisibility(isFullscreen() && !isLock() ? View.VISIBLE : View.GONE);
         mBinding.control.keep.setVisibility(mHistory == null || isFullscreen() ? View.GONE : View.VISIBLE);
@@ -925,7 +925,6 @@ private void showControl() {
         mBinding.control.cast.setVisibility(getUrl() == null ? View.GONE : View.VISIBLE);
         mBinding.control.center.setVisibility(isLock() ? View.GONE : View.VISIBLE);
         mBinding.control.bottom.setVisibility(isLock() ? View.GONE : View.VISIBLE);
-        mBinding.control.danmu.setVisibility(isLock() ? View.GONE : View.VISIBLE);
         mBinding.control.top.setVisibility(isLock() ? View.GONE : View.VISIBLE);
         mBinding.control.getRoot().setVisibility(View.VISIBLE);
         checkPlayImg(mPlayers.isPlaying());

File: app/src/main/java/com/fongmi/android/tv/gson/FilterAdapter.java
Patch:
@@ -22,8 +22,8 @@ public LinkedHashMap<String, List<Filter>> deserialize(JsonElement json, Type ty
         for (String key : filters.keySet()) {
             List<Filter> items = new ArrayList<>();
             JsonElement element = filters.get(key);
-            if (element.isJsonObject()) items.add(Filter.objectFrom(element).trans());
-            else for (JsonElement item : element.getAsJsonArray()) items.add(Filter.objectFrom(item).trans());
+            if (element.isJsonObject()) items.add(Filter.objectFrom(element).check().trans());
+            else for (JsonElement item : element.getAsJsonArray()) items.add(Filter.objectFrom(item).check().trans());
             filterMap.put(key, items);
         }
         return filterMap;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -368,8 +368,9 @@ private void checkCast() {
     }
 
     private void checkId() {
-        if (getId().startsWith("push://")) getIntent().putExtra("key", "push_agent").putExtra("id", getId().substring(7));
-        if (TextUtils.isEmpty(getId()) || getId().startsWith("msearch:")) setEmpty();
+        String id = Objects.toString(getId(), "");
+        if (id.startsWith("push://")) getIntent().putExtra("key", "push_agent").putExtra("id", id.substring(7));
+        if (id.isEmpty() || id.startsWith("msearch:")) setEmpty();
         else getDetail();
     }
 

File: app/src/main/java/com/fongmi/android/tv/Setting.java
Patch:
@@ -207,7 +207,7 @@ public static void putFlag(int mode) {
     }
 
     public static int getBackground() {
-        return Prefers.getInt("background");
+        return Prefers.getInt("background", 2);
     }
 
     public static void putBackground(int background) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -262,7 +262,7 @@ protected void initView() {
         mKeyDown = CustomKeyDownVod.create(this, mBinding.video);
         mFrameParams = mBinding.video.getLayoutParams();
         mClock = Clock.create(mBinding.widget.time);
-        mPlayers = new Players().init();
+        mPlayers = new Players().init(this);
         mBroken = new ArrayList<>();
         mR1 = this::hideControl;
         mR2 = this::setTraffic;
@@ -861,7 +861,7 @@ private void setR1Callback() {
     }
 
     private void setArtwork(String url) {
-        ImgUtil.load(url, R.drawable.radio, new CustomTarget() {
+        ImgUtil.load(url, R.drawable.radio, new CustomTarget<>() {
             @Override
             public void onResourceReady(@NonNull Drawable resource, @Nullable Transition<? super Drawable> transition) {
                 getExo().setDefaultArtwork(resource);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -706,6 +706,7 @@ private void setMetadata() {
         builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, getIjk().getDefaultArtwork());
         builder.putLong(MediaMetadataCompat.METADATA_KEY_DURATION, mPlayers.getDuration());
         mPlayers.setMetadata(builder.build());
+        ActionEvent.update();
     }
 
     @Subscribe(threadMode = ThreadMode.MAIN)

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1117,6 +1117,7 @@ private void setMetadata() {
         builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, getIjk().getDefaultArtwork());
         builder.putLong(MediaMetadataCompat.METADATA_KEY_DURATION, mPlayers.getDuration());
         mPlayers.setMetadata(builder.build());
+        ActionEvent.update();
     }
 
     @Subscribe(threadMode = ThreadMode.MAIN)

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -1474,7 +1474,7 @@ public void onWindowFocusChanged(boolean hasFocus) {
     protected void onStart() {
         super.onStart();
         if (Setting.isBackgroundOff()) mPlayers.play();
-        if (Setting.isBackgroundOff()) mClock.start();
+        mClock.stop().start();
         setStop(false);
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -49,7 +49,6 @@ public class Players implements Player.Listener, IMediaPlayer.Listener, Analytic
     public static final int SOFT = 0;
     public static final int HARD = 1;
 
-    private MediaMetadataCompat metadata;
     private MediaSessionCompat session;
     private IjkVideoView ijkPlayer;
     private StringBuilder builder;
@@ -129,7 +128,6 @@ public MediaSessionCompat getSession() {
     }
 
     public void setMetadata(MediaMetadataCompat metadata) {
-        this.metadata = metadata;
         session.setMetadata(metadata);
         ActionEvent.update();
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -491,6 +491,7 @@ public void onResourceReady(@NonNull Drawable resource, @Nullable Transition<? s
             public void onLoadFailed(@Nullable Drawable error) {
                 getExo().setDefaultArtwork(error);
                 getIjk().setDefaultArtwork(error);
+                setMetadata();
             }
         });
     }
@@ -698,8 +699,8 @@ private void setTrackVisible(boolean visible) {
 
     private void setMetadata() {
         MediaMetadataCompat.Builder builder = new MediaMetadataCompat.Builder();
-        builder.putString(MediaMetadataCompat.METADATA_KEY_TITLE, mChannel.getName());
-        builder.putString(MediaMetadataCompat.METADATA_KEY_ARTIST, mChannel.getData().getEpg());
+        builder.putString(MediaMetadataCompat.METADATA_KEY_TITLE, mChannel == null ? "" : mChannel.getName());
+        builder.putString(MediaMetadataCompat.METADATA_KEY_ARTIST, mChannel == null ? "" : mChannel.getData().getEpg());
         builder.putBitmap(MediaMetadataCompat.METADATA_KEY_ART, getIjk().getDefaultArtwork());
         builder.putLong(MediaMetadataCompat.METADATA_KEY_DURATION, mPlayers.getDuration());
         mPlayers.setMetadata(builder.build());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -934,6 +934,7 @@ public void onLoadFailed(@Nullable Drawable error) {
                 getIjk().setDefaultArtwork(error);
                 hideProgress();
                 hidePreview();
+                setMetadata();
             }
         });
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -140,7 +140,7 @@ private void setViewType() {
     }
 
     private void setViewType(int viewType) {
-        int count = Product.getColumn() - 1;
+        int count = Product.getColumn(this) - 1;
         mSearchAdapter.setViewType(viewType, count);
         mSearchAdapter.setSize(Product.getSpec(this, ResUtil.dp2px((count + 2) * 16), count + 1));
         ((GridLayoutManager) mBinding.recycler.getLayoutManager()).setSpanCount(mSearchAdapter.isGrid() ? count : 1);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/HistoryActivity.java
Patch:
@@ -50,7 +50,7 @@ protected void initEvent() {
     private void setRecyclerView() {
         mBinding.recycler.setHasFixedSize(true);
         mBinding.recycler.getItemAnimator().setChangeDuration(0);
-        mBinding.recycler.setLayoutManager(new GridLayoutManager(this, Product.getColumn()));
+        mBinding.recycler.setLayoutManager(new GridLayoutManager(this, Product.getColumn(this)));
         mBinding.recycler.setAdapter(mAdapter = new HistoryAdapter(this));
         mAdapter.setSize(Product.getSpec(getActivity()));
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/KeepActivity.java
Patch:
@@ -54,7 +54,7 @@ protected void initEvent() {
     private void setRecyclerView() {
         mBinding.recycler.setHasFixedSize(true);
         mBinding.recycler.getItemAnimator().setChangeDuration(0);
-        mBinding.recycler.setLayoutManager(new GridLayoutManager(this, Product.getColumn()));
+        mBinding.recycler.setLayoutManager(new GridLayoutManager(this, Product.getColumn(this)));
         mBinding.recycler.setAdapter(mAdapter = new KeepAdapter(this));
         mAdapter.setSize(Product.getSpec(getActivity()));
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -301,7 +301,7 @@ private void onShare() {
     private void onRotate() {
         setR1Callback();
         setRotate(!isRotate());
-        setRequestedOrientation(ResUtil.isLand() ? ActivityInfo.SCREEN_ORIENTATION_USER_PORTRAIT : ActivityInfo.SCREEN_ORIENTATION_SENSOR_LANDSCAPE);
+        setRequestedOrientation(ResUtil.isLand(this) ? ActivityInfo.SCREEN_ORIENTATION_USER_PORTRAIT : ActivityInfo.SCREEN_ORIENTATION_SENSOR_LANDSCAPE);
     }
 
     private void onTrack(View view) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/EpisodeGridDialog.java
Patch:
@@ -67,7 +67,7 @@ protected void initView() {
 
     private void setSpanCount() {
         int total = 0;
-        int row = ResUtil.isLand() ? 5 : 10;
+        int row = ResUtil.isLand(getActivity()) ? 5 : 10;
         for (Episode item : episodes) total += item.getName().length();
         int offset = (int) Math.ceil((double) total / episodes.size());
         if (offset >= 12) spanCount = 1;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -125,7 +125,7 @@ private void setRecyclerView() {
 
     private void setStyle(Style style) {
         mBinding.recycler.setAdapter(mAdapter = new VodAdapter(this, style, Product.getSpec(getActivity(), style)));
-        mBinding.recycler.setLayoutManager(style.isList() ? new LinearLayoutManager(getActivity()) : new GridLayoutManager(getContext(), Product.getColumn(style)));
+        mBinding.recycler.setLayoutManager(style.isList() ? new LinearLayoutManager(getActivity()) : new GridLayoutManager(getContext(), Product.getColumn(getActivity(), style)));
     }
 
     private void setViewModel() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/VideoActivity.java
Patch:
@@ -817,7 +817,7 @@ private void enterFullscreen() {
 
     private void exitFullscreen() {
         if (!isFullscreen()) return;
-        setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_FULL_USER);
+        setRequestedOrientation(isPort() ? ActivityInfo.SCREEN_ORIENTATION_USER_PORTRAIT : ActivityInfo.SCREEN_ORIENTATION_FULL_USER);
         mBinding.episode.scrollToPosition(mEpisodeAdapter.getPosition());
         mBinding.control.full.setVisibility(View.VISIBLE);
         mBinding.video.setLayoutParams(mFrameParams);

File: app/src/main/java/com/fongmi/android/tv/bean/Collect.java
Patch:
@@ -29,11 +29,11 @@ public Collect(Site site, List<Vod> list) {
     }
 
     public Site getSite() {
-        return site;
+        return site == null ? new Site() : site;
     }
 
     public List<Vod> getList() {
-        return list;
+        return list == null ? new ArrayList<>() : list;
     }
 
     public boolean isActivated() {

File: app/src/main/java/com/fongmi/android/tv/bean/Url.java
Patch:
@@ -59,6 +59,6 @@ public boolean isEmpty() {
     }
 
     public boolean isOnly() {
-        return getValues().size() == 1;
+        return getValues().size() <= 1;
     }
 }

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -511,7 +511,6 @@ public boolean onError(IMediaPlayer mp, int what, int extra) {
 
     @Override
     public void onTimedText(IMediaPlayer mp, IjkTimedText text) {
-        mSubtitleView.setCues(SubtitleParser.parse(text.getText()));
     }
 
     @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -402,6 +402,7 @@ private void getDetail() {
 
     private void getDetail(Vod item) {
         getIntent().putExtra("key", item.getSiteKey());
+        getIntent().putExtra("pic", item.getVodPic());
         getIntent().putExtra("id", item.getVodId());
         mBinding.scroll.scrollTo(0, 0);
         mClock.setCallback(null);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -405,6 +405,7 @@ private void getDetail() {
 
     private void getDetail(Vod item) {
         getIntent().putExtra("key", item.getSiteKey());
+        getIntent().putExtra("pic", item.getVodPic());
         getIntent().putExtra("id", item.getVodId());
         mBinding.swipeLayout.setRefreshing(true);
         mBinding.swipeLayout.setEnabled(false);
@@ -477,7 +478,6 @@ private void setOther(TextView view, Vod item) {
     private void getPlayer(Flag flag, Episode episode, boolean replay) {
         mBinding.control.title.setText(getString(R.string.detail_title, mBinding.name.getText(), episode.getName()));
         mViewModel.playerContent(getKey(), flag.getFlag(), episode.getUrl());
-        mBinding.qualityText.setVisibility(View.GONE);
         updateHistory(episode, replay);
         showProgress();
         hidePreview();
@@ -501,6 +501,7 @@ public void onItemClick(Flag item, boolean force) {
         if (item.isActivated()) return;
         mFlagAdapter.setActivated(item);
         mBinding.flag.scrollToPosition(mFlagAdapter.getPosition());
+        mBinding.qualityText.setVisibility(View.GONE);
         mBinding.quality.setVisibility(View.GONE);
         setEpisodeAdapter(item.getEpisodes());
         seamless(item, force);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -418,7 +418,6 @@ private void setDetail(Result result) {
     private void getPlayer(Flag flag, Episode episode, boolean replay) {
         mBinding.widget.title.setText(getString(R.string.detail_title, mBinding.name.getText(), episode.getName()));
         mViewModel.playerContent(getKey(), flag.getFlag(), episode.getUrl());
-        mBinding.quality.setVisibility(View.GONE);
         updateHistory(episode, replay);
         showProgress();
         hidePreview();
@@ -497,6 +496,7 @@ private void setFlagActivated(Flag item, boolean force) {
         for (int i = 0; i < mFlagAdapter.size(); i++) ((Flag) mFlagAdapter.get(i)).setActivated(item);
         mBinding.flag.setSelectedPosition(mFlagAdapter.indexOf(item));
         notifyItemChanged(mBinding.flag, mFlagAdapter);
+        mBinding.quality.setVisibility(View.GONE);
         setEpisodeAdapter(item.getEpisodes());
         seamless(item, force);
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -478,7 +478,6 @@ private void getPlayer(Flag flag, Episode episode, boolean replay) {
         mBinding.control.title.setText(getString(R.string.detail_title, mBinding.name.getText(), episode.getName()));
         mViewModel.playerContent(getKey(), flag.getFlag(), episode.getUrl());
         mBinding.qualityText.setVisibility(View.GONE);
-        mBinding.quality.setVisibility(View.GONE);
         updateHistory(episode, replay);
         showProgress();
         hidePreview();
@@ -502,6 +501,7 @@ public void onItemClick(Flag item, boolean force) {
         if (item.isActivated()) return;
         mFlagAdapter.setActivated(item);
         mBinding.flag.scrollToPosition(mFlagAdapter.getPosition());
+        mBinding.quality.setVisibility(View.GONE);
         setEpisodeAdapter(item.getEpisodes());
         seamless(item, force);
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -1406,6 +1406,7 @@ public void onPictureInPictureModeChanged(boolean isInPictureInPictureMode) {
         if (isInPictureInPictureMode) {
             mReceiver.register(this);
             enterFullscreen();
+            setSubtitle(12);
             hideControl();
             hideSheet();
         } else {

File: quickjs/src/main/java/com/fongmi/quickjs/crawler/Spider.java
Patch:
@@ -42,7 +42,7 @@ public class Spider extends com.github.catvod.crawler.Spider {
     private final String key;
     private final String api;
 
-    public Spider(String api, DexClassLoader dex) throws Exception {
+    public Spider(String key, String api, DexClassLoader dex) throws Exception {
         this.key = "__" + UUID.randomUUID().toString().replace("-", "") + "__";
         this.executor = Executors.newSingleThreadExecutor();
         this.api = api;

File: app/src/main/java/com/fongmi/android/tv/utils/FileChooser.java
Patch:
@@ -58,7 +58,7 @@ public static String getPathFromUri(Context context, Uri uri) {
         if (DocumentsContract.isDocumentUri(context, uri)) path = getPathFromDocumentUri(context, uri);
         else if (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme())) path = getDataColumn(context, uri);
         else if (ContentResolver.SCHEME_FILE.equalsIgnoreCase(uri.getScheme())) path = uri.getPath();
-        return path != null ? path.replace(Path.rootPath(), "") : createFileFromUri(context, uri);
+        return path != null ? path : createFileFromUri(context, uri);
     }
 
     private static String getPathFromDocumentUri(Context context, Uri uri) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingFragment.java
Patch:
@@ -40,6 +40,7 @@
 import com.fongmi.android.tv.utils.Utils;
 import com.github.catvod.bean.Doh;
 import com.github.catvod.net.OkHttp;
+import com.github.catvod.utils.Path;
 import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 import com.permissionx.guolindev.PermissionX;
 
@@ -342,6 +343,6 @@ public void onHiddenChanged(boolean hidden) {
     public void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
         super.onActivityResult(requestCode, resultCode, data);
         if (resultCode != Activity.RESULT_OK || requestCode != FileChooser.REQUEST_PICK_FILE) return;
-        setConfig(Config.find("file:/" + FileChooser.getPathFromUri(getContext(), data.getData()), type));
+        setConfig(Config.find("file:/" + FileChooser.getPathFromUri(getContext(), data.getData()).replace(Path.rootPath(), ""), type));
     }
 }

File: app/src/main/java/com/fongmi/android/tv/utils/FileChooser.java
Patch:
@@ -58,7 +58,7 @@ public static String getPathFromUri(Context context, Uri uri) {
         if (DocumentsContract.isDocumentUri(context, uri)) path = getPathFromDocumentUri(context, uri);
         else if (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme())) path = getDataColumn(context, uri);
         else if (ContentResolver.SCHEME_FILE.equalsIgnoreCase(uri.getScheme())) path = uri.getPath();
-        return path != null ? path : createFileFromUri(context, uri);
+        return path != null ? path.replace(Path.rootPath(), "") : createFileFromUri(context, uri);
     }
 
     private static String getPathFromDocumentUri(Context context, Uri uri) {

File: catvod/src/main/java/com/github/catvod/utils/Path.java
Patch:
@@ -113,7 +113,7 @@ public static File thunder(String name) {
     public static File local(String path) {
         File file1 = new File(path.replace("file:/", ""));
         File file2 = new File(path.replace("file:/", rootPath()));
-        return file1.exists() ? file1 : file2.exists() ? file2 : new File(path);
+        return file2.exists() ? file2 : file1.exists() ? file1 : new File(path);
     }
 
     public static String asset(String fileName) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -51,6 +51,7 @@
 import com.fongmi.android.tv.utils.Notify;
 import com.fongmi.android.tv.utils.ResUtil;
 import com.fongmi.android.tv.utils.Utils;
+import com.github.catvod.utils.Util;
 import com.google.common.collect.Lists;
 
 import org.greenrobot.eventbus.Subscribe;
@@ -106,7 +107,7 @@ private void checkAction(Intent intent) {
         if (Intent.ACTION_SEND.equals(intent.getAction())) {
             DetailActivity.push(this, Uri.parse(intent.getStringExtra(Intent.EXTRA_TEXT)));
         } else if (Intent.ACTION_VIEW.equals(intent.getAction()) && intent.getData() != null) {
-            if ("text/plain".equals(intent.getType()) || intent.getData().getPath().endsWith(".m3u")) {
+            if ("text/plain".equals(intent.getType()) || Util.path(intent.getData()).endsWith(".m3u")) {
                 loadLive("file:/" + FileChooser.getPathFromUri(this, intent.getData()));
             } else {
                 DetailActivity.push(this, intent.getData());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -30,6 +30,7 @@
 import com.fongmi.android.tv.ui.fragment.VodFragment;
 import com.fongmi.android.tv.utils.FileChooser;
 import com.fongmi.android.tv.utils.Notify;
+import com.github.catvod.utils.Util;
 import com.google.android.material.navigation.NavigationBarView;
 
 import org.greenrobot.eventbus.Subscribe;
@@ -69,7 +70,7 @@ private void checkAction(Intent intent) {
         if (Intent.ACTION_SEND.equals(intent.getAction())) {
             DetailActivity.push(this, Uri.parse(intent.getStringExtra(Intent.EXTRA_TEXT)));
         } else if (Intent.ACTION_VIEW.equals(intent.getAction()) && intent.getData() != null) {
-            if ("text/plain".equals(intent.getType()) || intent.getData().getPath().endsWith(".m3u")) {
+            if ("text/plain".equals(intent.getType()) || Util.path(intent.getData()).endsWith(".m3u")) {
                 loadLive("file:/" + FileChooser.getPathFromUri(this, intent.getData()));
             } else {
                 DetailActivity.push(this, intent.getData());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -63,8 +63,8 @@
 import com.fongmi.android.tv.ui.adapter.EpisodeAdapter;
 import com.fongmi.android.tv.ui.adapter.FlagAdapter;
 import com.fongmi.android.tv.ui.adapter.ParseAdapter;
-import com.fongmi.android.tv.ui.adapter.QuickAdapter;
 import com.fongmi.android.tv.ui.adapter.QualityAdapter;
+import com.fongmi.android.tv.ui.adapter.QuickAdapter;
 import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.base.ViewType;
 import com.fongmi.android.tv.ui.custom.CustomKeyDownVod;

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/CastDialog.java
Patch:
@@ -68,7 +68,9 @@ public CastDialog() {
 
     public CastDialog history(History history) {
         String id = history.getVodId();
-        String fd = id.startsWith("file") ? Server.get().getAddress() + "/" + id.replace(Path.rootPath(), "") : id;
+        String fd = history.getVodId();
+        if (id.startsWith("/")) fd = Server.get().getAddress() + "/file://" + fd.replace(Path.rootPath(), "");
+        if (id.startsWith("file")) fd = Server.get().getAddress() + "/" + fd.replace(Path.rootPath(), "");
         if (fd.contains("127.0.0.1")) fd = fd.replace("127.0.0.1", Server.get().getIP());
         body.add("history", history.toString().replace(id, fd));
         return this;

File: app/src/mobile/java/com/fongmi/android/tv/cast/CastVideo.java
Patch:
@@ -4,6 +4,7 @@
 
 import com.android.cast.dlna.core.ICast;
 import com.fongmi.android.tv.server.Server;
+import com.github.catvod.utils.Path;
 
 import java.util.UUID;
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/CastDialog.java
Patch:
@@ -30,6 +30,7 @@
 import com.fongmi.android.tv.ui.adapter.DeviceAdapter;
 import com.fongmi.android.tv.utils.Notify;
 import com.github.catvod.net.OkHttp;
+import com.github.catvod.utils.Path;
 import com.google.android.material.bottomsheet.BottomSheetDialogFragment;
 
 import org.greenrobot.eventbus.EventBus;

File: app/src/mobile/java/com/fongmi/android/tv/cast/CastVideo.java
Patch:
@@ -17,7 +17,7 @@ public static CastVideo get(String name, String url) {
     }
 
     private CastVideo(String name, String url) {
-        if (url.startsWith("file")) url = Server.get().getAddress() + "/" + url;
+        if (url.startsWith("file")) url = Server.get().getAddress() + "/" + url.replace(Path.rootPath(), "");
         if (url.contains("127.0.0.1")) url = url.replace("127.0.0.1", Server.get().getIP());
         this.name = name;
         this.url = url;

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/CastDialog.java
Patch:
@@ -67,7 +67,7 @@ public CastDialog() {
 
     public CastDialog history(History history) {
         String id = history.getVodId();
-        String fd = id.startsWith("file") ? Server.get().getAddress() + "/" + id : id;
+        String fd = id.startsWith("file") ? Server.get().getAddress() + "/" + id.replace(Path.rootPath(), "") : id;
         if (fd.contains("127.0.0.1")) fd = fd.replace("127.0.0.1", Server.get().getIP());
         body.add("history", history.toString().replace(id, fd));
         return this;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -403,6 +403,7 @@ private void setDetail(Result result) {
     private void getPlayer(Flag flag, Episode episode, boolean replay) {
         mBinding.widget.title.setText(getString(R.string.detail_title, mBinding.name.getText(), episode.getName()));
         mViewModel.playerContent(getKey(), flag.getFlag(), episode.getUrl());
+        mBinding.quality.setVisibility(View.GONE);
         updateHistory(episode, replay);
         showProgress();
         hidePreview();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -457,6 +457,8 @@ private void setOther(TextView view, Vod item) {
     private void getPlayer(Flag flag, Episode episode, boolean replay) {
         mBinding.control.title.setText(getString(R.string.detail_title, mBinding.name.getText(), episode.getName()));
         mViewModel.playerContent(getKey(), flag.getFlag(), episode.getUrl());
+        mBinding.qualityText.setVisibility(View.GONE);
+        mBinding.quality.setVisibility(View.GONE);
         updateHistory(episode, replay);
         showProgress();
         hidePreview();

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -26,6 +26,7 @@
 import com.github.catvod.net.OkHttp;
 import com.github.catvod.utils.Trans;
 import com.github.catvod.utils.Util;
+import com.google.common.net.HttpHeaders;
 
 import java.io.IOException;
 import java.util.ArrayList;
@@ -39,6 +40,7 @@
 import java.util.concurrent.TimeUnit;
 
 import okhttp3.FormBody;
+import okhttp3.Headers;
 import okhttp3.Response;
 
 public class SiteViewModel extends ViewModel {
@@ -92,7 +94,7 @@ public void homeContent() {
                     return Result.fromJson(homeContent);
                 }
             } else {
-                String homeContent = OkHttp.newCall(site.getApi()).execute().body().string();
+                String homeContent = OkHttp.newCall(site.getApi(), Headers.of(HttpHeaders.ACCEPT, OkHttp.ACCEPT)).execute().body().string();
                 SpiderDebug.log(homeContent);
                 return fetchPic(site, Result.fromType(site.getType(), homeContent));
             }

File: catvod/src/main/java/com/github/catvod/net/OkHttp.java
Patch:
@@ -24,6 +24,7 @@
 
 public class OkHttp {
 
+    public static final String ACCEPT = "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7";
     private static final int TIMEOUT = 30 * 1000;
     private static final int CACHE = 100 * 1024 * 1024;
 
@@ -67,7 +68,7 @@ public static OkHttpClient client(int timeout) {
     public static Call newCall(String url) {
         Uri uri = Uri.parse(url);
         if (uri.getUserInfo() != null) return newCall(url, Headers.of(HttpHeaders.AUTHORIZATION, Util.basic(uri)));
-        return client().newCall(new Request.Builder().url(url).headers(Headers.of()).build());
+        return client().newCall(new Request.Builder().url(url).build());
     }
 
     public static Call newCall(OkHttpClient client, String url) {
@@ -79,7 +80,7 @@ public static Call newCall(String url, Headers headers) {
     }
 
     public static Call newCall(String url, ArrayMap<String, String> params) {
-        return client().newCall(new Request.Builder().url(buildUrl(url, params)).build());
+        return client().newCall(new Request.Builder().url(buildUrl(url, params)).headers(Headers.of(HttpHeaders.ACCEPT, ACCEPT)).build());
     }
 
     public static Call newCall(String url, ArrayMap<String, String> params, Headers headers) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -379,6 +379,8 @@ private void checkCast() {
     }
 
     private void checkId() {
+        if (getId().startsWith("push://")) getIntent().putExtra("key", "push_agent");
+        if (getId().startsWith("push://")) getIntent().putExtra("id", getId().substring(7));
         if (TextUtils.isEmpty(getId()) || getId().startsWith("msearch:")) setEmpty();
         else getDetail();
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -368,6 +368,8 @@ private void setViewModel() {
     }
 
     private void checkId() {
+        if (getId().startsWith("push://")) getIntent().putExtra("key", "push_agent");
+        if (getId().startsWith("push://")) getIntent().putExtra("id", getId().substring(7));
         if (TextUtils.isEmpty(getId()) || getId().startsWith("msearch:")) setEmpty();
         else getDetail();
     }

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -111,6 +111,7 @@ public int getPlayer() {
     }
 
     public void setPlayer(int player) {
+        if (this.player != player) stop();
         this.player = player;
     }
 
@@ -210,12 +211,10 @@ public String toggleSpeed() {
     }
 
     public void togglePlayer() {
-        stop();
         setPlayer(isExo() ? SYS : ++player);
     }
 
     public void nextPlayer() {
-        stop();
         setPlayer(isExo() ? IJK : EXO);
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/Source.java
Patch:
@@ -3,6 +3,7 @@
 import com.fongmi.android.tv.player.extractor.BiliBili;
 import com.fongmi.android.tv.player.extractor.Force;
 import com.fongmi.android.tv.player.extractor.JianPian;
+import com.fongmi.android.tv.player.extractor.Push;
 import com.fongmi.android.tv.player.extractor.TVBus;
 import com.fongmi.android.tv.player.extractor.Thunder;
 import com.fongmi.android.tv.player.extractor.Youtube;
@@ -29,6 +30,7 @@ public Source() {
         extractors.add(new BiliBili());
         extractors.add(new Force());
         extractors.add(new JianPian());
+        extractors.add(new Push());
         extractors.add(new Thunder());
         extractors.add(new TVBus());
         extractors.add(new Youtube());

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -221,7 +221,9 @@ private void setViewModel() {
     }
 
     private void getLive() {
+        mPlayers.setPlayer(getPlayerType(-1));
         mViewModel.getLive(getHome());
+        setPlayerView();
         setDecodeView();
         showProgress();
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -223,7 +223,9 @@ private void setViewModel() {
     }
 
     private void getLive() {
+        mPlayers.setPlayer(getPlayerType(-1));
         mViewModel.getLive(getHome());
+        setPlayerView();
         setDecodeView();
         showProgress();
     }

File: app/src/main/java/com/fongmi/android/tv/bean/Live.java
Patch:
@@ -174,6 +174,6 @@ public boolean equals(Object obj) {
         if (this == obj) return true;
         if (!(obj instanceof Live)) return false;
         Live it = (Live) obj;
-        return getName().equals(it.getName()) && getUrl().equals(it.getUrl());
+        return getName().equals(it.getName());
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -28,8 +28,8 @@
 import com.fongmi.android.tv.ui.fragment.VodFragment;
 import com.fongmi.android.tv.ui.presenter.TypePresenter;
 import com.fongmi.android.tv.utils.ResUtil;
-import com.github.catvod.utils.Trans;
 import com.fongmi.android.tv.utils.Utils;
+import com.github.catvod.utils.Trans;
 
 import java.util.ArrayList;
 import java.util.List;

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -262,6 +262,7 @@ public JSONObject jsonExtMix(String flag, String key, String name, LinkedHashMap
 
     public List<Doh> getDoh() {
         List<Doh> items = Doh.get(App.get());
+        if (doh == null) return items;
         items.removeAll(doh);
         items.addAll(doh);
         return items;

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -79,7 +79,8 @@ public static Object getUrl(String url) {
         if (url.contains("@Cookie=")) builder.addHeader(HttpHeaders.COOKIE, param = url.split("@Cookie=")[1].split("@")[0]);
         if (url.contains("@Referer=")) builder.addHeader(HttpHeaders.REFERER, param = url.split("@Referer=")[1].split("@")[0]);
         if (url.contains("@User-Agent=")) builder.addHeader(HttpHeaders.USER_AGENT, param = url.split("@User-Agent=")[1].split("@")[0]);
-        return new GlideUrl(param == null ? url : url.split("@")[0], builder.build());
+        url = param == null ? url : url.split("@")[0];
+        return TextUtils.isEmpty(url) ? null : new GlideUrl(url, builder.build());
     }
 
     private static void addHeader(LazyHeaders.Builder builder, String header) {

File: app/src/leanback/java/com/fongmi/android/tv/Product.java
Patch:
@@ -14,9 +14,7 @@ public static int getColumn() {
     }
 
     public static int getColumn(Vod.Style style) {
-        if (style.isLand()) return getColumn() - 1;
-        if (style.isFull()) return 3;
-        return getColumn();
+        return style.isLand() ? getColumn() - 1 : getColumn();
     }
 
     public static int[] getSpec(Vod.Style style) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/base/ViewType.java
Patch:
@@ -4,6 +4,5 @@ public class ViewType {
 
     public static final int RECT = 0;
     public static final int OVAL = 1;
-    public static final int FULL = 2;
-    public static final int LIST = 3;
+    public static final int LIST = 2;
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/base/ViewType.java
Patch:
@@ -4,9 +4,8 @@ public class ViewType {
 
     public static final int RECT = 0;
     public static final int OVAL = 1;
-    public static final int FULL = 2;
-    public static final int LIST = 3;
-    public static final int GRID = 4;
+    public static final int LIST = 2;
+    public static final int GRID = 3;
 
     public static final int DARK = 0;
     public static final int LIGHT = 1;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -116,7 +116,7 @@ private void setRecyclerView() {
 
     private void setStyle(Vod.Style style) {
         mBinding.recycler.setAdapter(mAdapter = new VodAdapter(this, style, Product.getSpec(getActivity(), style)));
-        mBinding.recycler.setLayoutManager(mAdapter.isLinear() ? new LinearLayoutManager(getActivity()) : new GridLayoutManager(getContext(), Product.getColumn(style)));
+        mBinding.recycler.setLayoutManager(style.isList() ? new LinearLayoutManager(getActivity()) : new GridLayoutManager(getContext(), Product.getColumn(style)));
     }
 
     private void setViewModel() {

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -64,6 +64,7 @@ public static List<String> getRegex(String key) {
     }
 
     public static List<String> getRegex(Uri uri) {
+        if (uri.getHost() == null) return Collections.emptyList();
         String hosts = TextUtils.join(",", Arrays.asList(Util.host(uri), Util.host(uri.getQueryParameter("url"))));
         for (Rule rule : ApiConfig.get().getRules()) for (String host : rule.getHosts()) if (hosts.contains(host)) return rule.getRegex();
         return Collections.emptyList();

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -122,7 +122,7 @@ public void detailContent(String key, String id) {
                 if (!result.getList().isEmpty()) result.getList().get(0).setVodFlags();
                 if (!result.getList().isEmpty()) checkThunder(result.getList().get(0).getVodFlags());
                 return result;
-            } else if (key.equals("push_agent")) {
+            } else if (site.isEmpty() && key.equals("push_agent")) {
                 Vod vod = new Vod();
                 vod.setVodId(id);
                 vod.setVodName(id);
@@ -170,7 +170,7 @@ public void playerContent(String key, String flag, String id) {
                 if (result.getFlag().isEmpty()) result.setFlag(flag);
                 result.setUrl(Source.get().fetch(result.getUrl()));
                 return result;
-            } else if (key.equals("push_agent")) {
+            } else if (site.isEmpty() && key.equals("push_agent")) {
                 Result result = new Result();
                 result.setParse(0);
                 result.setFlag(flag);

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomScroller.java
Patch:
@@ -41,8 +41,8 @@ public int addPage() {
         return ++page;
     }
 
-    public int getPage() {
-        return page;
+    public boolean first() {
+        return page == 1;
     }
 
     public boolean isLoading() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -169,7 +169,7 @@ private void checkPosition() {
         if (mPage != null && mPage.getPosition() > 0) mBinding.recycler.hideHeader();
         if (mPage != null && mPage.getPosition() < 1) mBinding.recycler.showHeader();
         if (mPage != null) mBinding.recycler.setSelectedPosition(mPage.getPosition());
-        else if (mScroller.getPage() == 1 && !mOpen) mBinding.recycler.moveToTop();
+        else if (mScroller.first() && !mOpen) mBinding.recycler.moveToTop();
         mPage = null;
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/CustomScroller.java
Patch:
@@ -33,8 +33,8 @@ public int addPage() {
         return ++page;
     }
 
-    public int getPage() {
-        return page;
+    public boolean first() {
+        return page == 1;
     }
 
     public void setPage(int page) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -138,7 +138,7 @@ private void getVideo(String typeId, String page) {
 
     private void setAdapter(Result result) {
         int size = result.getList().size();
-        mBinding.progressLayout.showContent(isFolder(), size);
+        mBinding.progressLayout.showContent(mScroller.first(), size);
         mBinding.swipeLayout.setRefreshing(false);
         mScroller.endLoading(result);
         addVideo(result.getList());
@@ -155,7 +155,7 @@ private void addVideo(List<Vod> items) {
 
     private void checkPosition() {
         if (mPage != null) scrollToPosition(mPage.getPosition());
-        else if (mScroller.getPage() == 1) mBinding.recycler.scrollToPosition(0);
+        else if (mScroller.first()) mBinding.recycler.scrollToPosition(0);
         mPage = null;
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Site.java
Patch:
@@ -148,7 +148,7 @@ public String getExt() {
     }
 
     public void setExt(String ext) {
-        this.ext = ext;
+        this.ext = ext.trim();
     }
 
     public String getJar() {

File: app/src/mobile/java/com/fongmi/android/tv/Product.java
Patch:
@@ -42,6 +42,6 @@ private static int[] getSpec(Context context, int space, int column, Vod.Style s
     }
 
     public static int getEms() {
-        return Math.min(ResUtil.getScreenWidth() / ResUtil.sp2px(18), 35);
+        return Math.min(ResUtil.getScreenWidth() / ResUtil.sp2px(20), 25);
     }
 }

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -65,7 +65,7 @@ public static void loadLive(String url, ImageView view) {
         else Glide.with(App.get()).asBitmap().load(url).skipMemoryCache(true).dontAnimate().signature(new ObjectKey(url)).error(R.drawable.ic_img_empty).into(view);
     }
 
-    private static Object getUrl(String url) {
+    public static Object getUrl(String url) {
         String param = null;
         url = Utils.convert(url);
         if (url.startsWith("data:")) return url;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -111,13 +111,11 @@ protected void initData() {
 
     private void setRecyclerView() {
         mBinding.recycler.setHasFixedSize(true);
-        mBinding.recycler.setAdapter(mAdapter = new VodAdapter(this));
         setStyle(getStyle());
     }
 
     private void setStyle(Vod.Style style) {
-        mAdapter.setStyle(style);
-        mAdapter.setSize(Product.getSpec(getActivity(), style));
+        mBinding.recycler.setAdapter(mAdapter = new VodAdapter(this, style, Product.getSpec(getActivity(), style)));
         mBinding.recycler.setLayoutManager(mAdapter.isLinear() ? new LinearLayoutManager(getActivity()) : new GridLayoutManager(getContext(), Product.getColumn(style)));
     }
 

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/IjkMediaPlayer.java
Patch:
@@ -192,7 +192,7 @@ private static void initNativeOnce() {
             if (!mIsNativeInitialized) {
                 native_init();
                 native_setDot(0);
-                native_setLogLevel(IjkMediaPlayer.IJK_LOG_SILENT);
+                native_setLogLevel(IjkMediaPlayer.IJK_LOG_DEBUG);
                 mIsNativeInitialized = true;
             }
         }

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -358,6 +358,8 @@ public int getSelectedTrack(int type) {
 
     public void selectTrack(int type, int track) {
         int selected = getSelectedTrack(type);
+        long position = getCurrentPosition();
+        boolean text = type == ITrackInfo.MEDIA_TRACK_TYPE_TEXT;
         List<ITrackInfo> trackInfos = getTrackInfo();
         for (int index = 0; index < trackInfos.size(); index++) {
             ITrackInfo trackInfo = trackInfos.get(index);
@@ -366,6 +368,7 @@ public void selectTrack(int type, int track) {
                 mSubtitleView.setText("");
                 mPlayer.selectTrack(index);
                 updateForCurrentTrackSelections();
+                if (text && position > 0) seekTo(position);
             }
         }
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -1237,7 +1237,6 @@ public void onSpeedUp() {
 
     @Override
     public void onSpeedEnd() {
-        if (!mPlayers.isPlaying()) return;
         mBinding.control.speed.setText(mPlayers.setSpeed(mHistory.getSpeed()));
         mBinding.widget.speed.setVisibility(View.GONE);
         mBinding.widget.speed.clearAnimation();

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -174,7 +174,7 @@ private void checkPosition() {
     }
 
     private void checkPage(int count) {
-        if (mScroller.isDisable() || count == 0 || mAdapter.size() >= 4 || isFolder()) return;
+        if (mScroller.isDisable() || count == 0 || mAdapter.size() >= 5 || isFolder()) return;
         getVideo(getTypeId(), String.valueOf(mScroller.addPage()));
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -1270,7 +1270,6 @@ public void onSpeedUp() {
 
     @Override
     public void onSpeedEnd() {
-        if (!mPlayers.isPlaying()) return;
         mBinding.control.action.speed.setText(mPlayers.setSpeed(mHistory.getSpeed()));
         mBinding.widget.speed.setVisibility(View.GONE);
         mBinding.widget.speed.clearAnimation();

File: app/src/main/java/com/fongmi/android/tv/player/Source.java
Patch:
@@ -36,8 +36,8 @@ public Source() {
     }
 
     public String fetch(String url) throws Exception {
-        String host = Util.host(url).trim();
-        String scheme = Util.scheme(url).trim();
+        String host = Util.host(url);
+        String scheme = Util.scheme(url);
         for (Extractor extractor : extractors) if (extractor.match(scheme, host)) return extractor.fetch(url.trim());
         return url;
     }

File: catvod/src/main/java/com/github/catvod/utils/Util.java
Patch:
@@ -46,12 +46,12 @@ public static String substring(String text, int num) {
 
     public static String scheme(String url) {
         String scheme = Uri.parse(url).getScheme();
-        return scheme == null ? "" : scheme.toLowerCase();
+        return scheme == null ? "" : scheme.toLowerCase().trim();
     }
 
     public static String host(String url) {
         String host = Uri.parse(url).getHost();
-        return host == null ? "" : host.toLowerCase();
+        return host == null ? "" : host.toLowerCase().trim();
     }
 
     public static String md5(String src) {

File: app/src/main/java/com/fongmi/android/tv/bean/Vod.java
Patch:
@@ -456,7 +456,7 @@ public boolean equals(Object obj) {
             public static class Sorter implements Comparator<Episode> {
 
                 public static List<Episode> sort(List<Episode> items) {
-                    Collections.sort(items, new Sorter());
+                    if (items.size() > 1) Collections.sort(items, new Sorter());
                     return items;
                 }
 

File: app/src/main/java/com/fongmi/android/tv/player/extractor/Magnet.java
Patch:
@@ -51,7 +51,8 @@ public List<Vod.Flag.Episode> call() {
     public static void addAll(List<Vod.Flag.Episode> items, Future<List<Vod.Flag.Episode>> future) {
         try {
             items.addAll(Vod.Flag.Episode.Sorter.sort(future.get()));
-        } catch (Exception ignored) {
+        } catch (Exception e) {
+            e.printStackTrace();
         }
     }
 }

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -141,7 +141,7 @@ public void parseConfig(JsonObject object, Callback callback) {
         if (!object.has("lives")) return;
         for (JsonElement element : Json.safeListElement(object, "lives")) parse(Live.objectFrom(element).check());
         if (home == null) setHome(lives.isEmpty() ? new Live() : lives.get(0));
-        if (home.isBoot()) App.post(Product::bootLive);
+        if (home.isBoot() || Setting.isBootLive()) App.post(Product::bootLive);
         if (callback != null) App.post(callback::success);
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Core.java
Patch:
@@ -5,6 +5,7 @@
 
 import androidx.annotation.Nullable;
 
+import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.utils.Utils;
 import com.google.gson.annotations.SerializedName;
 
@@ -60,7 +61,7 @@ public String getSo() {
     }
 
     public PackageManager getPackageManager() {
-        return null;
+        return App.get().getPackageManager();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/player/extractor/TVBus.java
Patch:
@@ -1,10 +1,10 @@
 package com.fongmi.android.tv.player.extractor;
 
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.Setting;
 import com.fongmi.android.tv.api.LiveConfig;
 import com.fongmi.android.tv.bean.Core;
 import com.fongmi.android.tv.player.Source;
-import com.fongmi.android.tv.utils.Notify;
 import com.google.gson.JsonObject;
 import com.tvbus.engine.Listener;
 import com.tvbus.engine.TVCore;
@@ -51,8 +51,8 @@ private void onNotify() {
     }
 
     private void change() {
-        App.post(() -> Notify.show("內核已切換，正在重新啟動。"));
-        App.post(() -> System.exit(0), 1000);
+        App.post(() -> System.exit(0), 250);
+        Setting.putBootLive(true);
     }
 
     @Override

File: app/src/mobile/java/com/fongmi/android/tv/Product.java
Patch:
@@ -3,6 +3,7 @@
 import android.content.Context;
 
 import com.fongmi.android.tv.bean.Vod;
+import com.fongmi.android.tv.ui.activity.LiveActivity;
 import com.fongmi.android.tv.utils.ResUtil;
 
 public class Product {
@@ -20,6 +21,7 @@ public static int getColumn(Vod.Style style) {
     }
 
     public static void bootLive() {
+        LiveActivity.start(App.activity());
     }
 
     public static int[] getSpec(Context context) {

File: quickjs/src/main/java/com/fongmi/quickjs/utils/JSUtil.java
Patch:
@@ -19,7 +19,7 @@ public static JSArray toArray(QuickJSContext ctx, List<String> items) {
     public static JSArray toArray(QuickJSContext ctx, byte[] bytes) {
         JSArray array = ctx.createNewJSArray();
         if (bytes == null || bytes.length == 0) return array;
-        for (int i = 0; i < bytes.length; i++) array.set(bytes[i], i);
+        for (int i = 0; i < bytes.length; i++) array.set((int) bytes[i], i);
         return array;
     }
 

File: app/src/main/java/com/fongmi/android/tv/App.java
Patch:
@@ -22,9 +22,6 @@
 import com.orhanobut.logger.Logger;
 import com.orhanobut.logger.PrettyFormatStrategy;
 
-import org.conscrypt.Conscrypt;
-
-import java.security.Security;
 import java.util.concurrent.ExecutorService;
 import java.util.concurrent.Executors;
 

File: app/src/main/java/com/fongmi/android/tv/Setting.java
Patch:
@@ -102,8 +102,8 @@ public static void putHot(String hot) {
         Prefers.put("hot", hot);
     }
 
-    public static int getViewType() {
-        return Prefers.getInt("viewType");
+    public static int getViewType(int viewType) {
+        return Prefers.getInt("viewType", viewType);
     }
 
     public static void putViewType(int viewType) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -132,7 +132,7 @@ private void setRecyclerView() {
     }
 
     private void setViewType() {
-        setViewType(Setting.getViewType());
+        setViewType(Setting.getViewType(ViewType.GRID));
     }
 
     private void setViewType(int viewType) {

File: app/src/main/java/com/fongmi/android/tv/Setting.java
Patch:
@@ -2,7 +2,6 @@
 
 
 import com.fongmi.android.tv.player.Players;
-import com.fongmi.android.tv.utils.Sniffer;
 import com.github.catvod.utils.Prefers;
 
 public class Setting {
@@ -160,7 +159,7 @@ public static void putUpdate(boolean update) {
     }
 
     public static String getUa() {
-        return Prefers.getString("ua", Sniffer.CHROME);
+        return Prefers.getString("ua");
     }
 
     public static void putUa(String ua) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/holder/VodFolderHolder.java
Patch:
@@ -3,14 +3,14 @@
 import android.widget.ImageView;
 
 import androidx.annotation.NonNull;
-import androidx.leanback.widget.Presenter;
 
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.AdapterVodFolderBinding;
+import com.fongmi.android.tv.ui.base.BaseVodHolder;
 import com.fongmi.android.tv.ui.presenter.VodPresenter;
 import com.fongmi.android.tv.utils.ImgUtil;
 
-public class VodFolderHolder extends Presenter.ViewHolder {
+public class VodFolderHolder extends BaseVodHolder {
 
     private final VodPresenter.OnClickListener listener;
     public final AdapterVodFolderBinding binding;
@@ -21,6 +21,7 @@ public VodFolderHolder(@NonNull AdapterVodFolderBinding binding, VodPresenter.On
         this.listener = listener;
     }
 
+    @Override
     public void initView(Vod item) {
         binding.name.setText(item.getVodName());
         binding.remark.setText(item.getVodRemarks());

File: app/src/mobile/java/com/fongmi/android/tv/ui/holder/VodGridHolder.java
Patch:
@@ -20,8 +20,8 @@ public VodGridHolder(@NonNull AdapterVodGridBinding binding, VodAdapter.OnClickL
     }
 
     public VodGridHolder size(int[] size) {
-        this.itemView.getLayoutParams().width = size[0];
-        this.itemView.getLayoutParams().height = size[1];
+        itemView.getLayoutParams().width = size[0];
+        itemView.getLayoutParams().height = size[1];
         return this;
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/holder/VodOvalHolder.java
Patch:
@@ -20,8 +20,8 @@ public VodOvalHolder(@NonNull AdapterVodOvalBinding binding, VodAdapter.OnClickL
     }
 
     public VodOvalHolder size(int[] size) {
-        this.binding.image.getLayoutParams().width = size[0];
-        this.binding.image.getLayoutParams().height = size[1];
+        binding.image.getLayoutParams().width = size[0];
+        binding.image.getLayoutParams().height = size[1];
         return this;
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/holder/VodFolderHolder.java
Patch:
@@ -3,14 +3,14 @@
 import android.widget.ImageView;
 
 import androidx.annotation.NonNull;
-import androidx.recyclerview.widget.RecyclerView;
 
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.AdapterVodFolderBinding;
 import com.fongmi.android.tv.ui.adapter.VodAdapter;
+import com.fongmi.android.tv.ui.base.BaseVodHolder;
 import com.fongmi.android.tv.utils.ImgUtil;
 
-public class VodFolderHolder extends RecyclerView.ViewHolder {
+public class VodFolderHolder extends BaseVodHolder {
 
     private final VodAdapter.OnClickListener listener;
     private final AdapterVodFolderBinding binding;
@@ -21,6 +21,7 @@ public VodFolderHolder(@NonNull AdapterVodFolderBinding binding, VodAdapter.OnCl
         this.listener = listener;
     }
 
+    @Override
     public void initView(Vod item) {
         binding.name.setText(item.getVodName());
         binding.remark.setText(item.getVodRemarks());

File: app/src/mobile/java/com/fongmi/android/tv/ui/holder/VodListHolder.java
Patch:
@@ -1,14 +1,14 @@
 package com.fongmi.android.tv.ui.holder;
 
 import androidx.annotation.NonNull;
-import androidx.recyclerview.widget.RecyclerView;
 
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.AdapterVodListBinding;
 import com.fongmi.android.tv.ui.adapter.VodAdapter;
+import com.fongmi.android.tv.ui.base.BaseVodHolder;
 import com.fongmi.android.tv.utils.ImgUtil;
 
-public class VodListHolder extends RecyclerView.ViewHolder {
+public class VodListHolder extends BaseVodHolder {
 
     private final VodAdapter.OnClickListener listener;
     private final AdapterVodListBinding binding;
@@ -19,6 +19,7 @@ public VodListHolder(@NonNull AdapterVodListBinding binding, VodAdapter.OnClickL
         this.listener = listener;
     }
 
+    @Override
     public void initView(Vod item) {
         binding.name.setText(item.getVodName());
         binding.year.setText(item.getVodYear());

File: app/src/main/java/com/fongmi/android/tv/player/extractor/JianPian.java
Patch:
@@ -62,7 +62,5 @@ public void stop() {
 
     @Override
     public void exit() {
-        path = null;
-        p2p = null;
     }
 }

File: app/src/main/java/com/fongmi/android/tv/player/extractor/Magnet.java
Patch:
@@ -44,7 +44,7 @@ public List<Vod.Flag.Episode> call() {
 
     public static void addAll(List<Vod.Flag.Episode> items, Future<List<Vod.Flag.Episode>> future) {
         try {
-            items.addAll(future.get());
+            items.addAll(Vod.Flag.Episode.Sorter.sort(future.get()));
         } catch (Exception ignored) {
         }
     }

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -40,7 +40,6 @@
 import com.fongmi.android.tv.bean.Drm;
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.bean.Sub;
-import com.fongmi.android.tv.utils.Sniffer;
 import com.fongmi.android.tv.utils.Utils;
 import com.github.catvod.net.OkHttp;
 import com.github.catvod.utils.Path;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -436,6 +436,7 @@ private void setDetail(Vod item) {
         mBinding.video.requestFocus();
         setArtwork(item.getVodPic());
         getPart(item.getVodName());
+        App.removeCallbacks(mR3);
         checkHistory(item);
         checkFlag(item);
         checkKeep();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -422,6 +422,7 @@ private void setDetail(Vod item) {
         mFlagAdapter.addAll(item.getVodFlags());
         setOther(mBinding.other, item);
         setArtwork(item.getVodPic());
+        App.removeCallbacks(mR4);
         checkHistory(item);
         checkFlag(item);
         checkKeepImg();

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -104,6 +104,7 @@ public IjkVideoView(Context context, AttributeSet attrs, int defStyleAttr) {
     private void initAttr(Context context, AttributeSet attrs, int defStyleAttr) {
         TypedArray a = context.getTheme().obtainStyledAttributes(attrs, R.styleable.IjkVideoView, defStyleAttr, 0);
         try {
+            mDefaultArtwork = context.getDrawable(a.getResourceId(R.styleable.IjkVideoView_default_artwork, 0));
             mKeepContentOnPlayerReset = a.getBoolean(R.styleable.IjkVideoView_keep_content_on_player_reset, mKeepContentOnPlayerReset);
         } finally {
             a.recycle();
@@ -366,6 +367,7 @@ public void selectTrack(int type, int track) {
                 mSubtitleView.setText("");
                 mPlayer.selectTrack(index);
                 if (position != 0) seekTo(position);
+                updateForCurrentTrackSelections();
             }
         }
     }
@@ -381,6 +383,7 @@ public void deselectTrack(int type, int track) {
                 mSubtitleView.setText("");
                 mPlayer.deselectTrack(track);
                 if (position != 0) seekTo(position);
+                updateForCurrentTrackSelections();
             }
         }
     }

File: app/src/main/java/com/fongmi/android/tv/bean/Result.java
Patch:
@@ -106,7 +106,7 @@ public static Result error(String msg) {
         Result result = new Result();
         result.setError(true);
         result.setMsg(msg);
-        return new Result();
+        return result;
     }
 
     public static Result folder(Vod item) {

File: thunder/src/main/java/com/xunlei/downloadlib/parameter/ErrorCode.java
Patch:
@@ -20,7 +20,7 @@ public static String get(int code) {
             case 111154:
                 return "版權限制";
             case 114101:
-                return "地址失效";
+                return "已失效";
             default:
                 return "ErrorCode=" + code;
         }

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/IjkMediaPlayer.java
Patch:
@@ -453,8 +453,8 @@ public List<ITrackInfo> getTrackInfo() {
     }
 
     @Override
-    public int getSelectedTrack(int trackType) {
-        switch (trackType) {
+    public int getSelectedTrack(int type) {
+        switch (type) {
             case ITrackInfo.MEDIA_TRACK_TYPE_VIDEO:
                 return (int) _getPropertyLong(FFP_PROP_INT64_SELECTED_VIDEO_STREAM, -1);
             case ITrackInfo.MEDIA_TRACK_TYPE_AUDIO:

File: app/src/main/java/com/fongmi/android/tv/bean/History.java
Patch:
@@ -65,8 +65,7 @@ public static History objectFrom(String str) {
     }
 
     public static List<History> arrayFrom(String str) {
-        Type listType = new TypeToken<List<History>>() {
-        }.getType();
+        Type listType = new TypeToken<List<History>>() {}.getType();
         List<History> items = new Gson().fromJson(str, listType);
         return items == null ? Collections.emptyList() : items;
     }

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -163,7 +163,7 @@ private static synchronized HttpDataSource.Factory getHttpDataSourceFactory() {
 
     private static synchronized DataSource.Factory getDataSourceFactory(Map<String, String> headers) {
         if (dataSourceFactory == null) dataSourceFactory = buildReadOnlyCacheDataSource(new DefaultDataSource.Factory(App.get(), getHttpDataSourceFactory()), getCache());
-        httpDataSourceFactory.setDefaultRequestProperties(Utils.checkHeaders(headers));
+        httpDataSourceFactory.setDefaultRequestProperties(Utils.checkUa(headers));
         return dataSourceFactory;
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/IjkUtil.java
Patch:
@@ -21,6 +21,6 @@ public static MediaSource getSource(Result result) {
     public static MediaSource getSource(Map<String, String> headers, String url) {
         Uri uri = Uri.parse(url.trim().replace("\\", ""));
         if (Sniffer.isAds(uri)) uri = Uri.parse(Server.get().getAddress().concat("/m3u8?url=").concat(URLEncoder.encode(url)));
-        return new MediaSource(Utils.checkHeaders(headers), uri);
+        return new MediaSource(Utils.checkUa(headers), uri);
     }
 }

File: app/src/main/java/com/fongmi/android/tv/utils/Utils.java
Patch:
@@ -95,7 +95,7 @@ public static CharSequence getClipText() {
         return ((ClipboardManager) App.get().getSystemService(Context.CLIPBOARD_SERVICE)).getText();
     }
 
-    public static Map<String, String> checkHeaders(Map<String, String> headers) {
+    public static Map<String, String> checkUa(Map<String, String> headers) {
         if (Setting.getUa().isEmpty() || headers.containsKey(HttpHeaders.USER_AGENT) || headers.containsKey(HttpHeaders.USER_AGENT.toLowerCase())) return headers;
         headers.put(HttpHeaders.USER_AGENT, Setting.getUa());
         return headers;

File: app/src/main/java/com/fongmi/android/tv/bean/Vod.java
Patch:
@@ -450,7 +450,7 @@ public boolean equals(Object obj) {
                 if (this == obj) return true;
                 if (!(obj instanceof Episode)) return false;
                 Episode it = (Episode) obj;
-                return getUrl().equals(it.getUrl()) || getName().equals(it.getName());
+                return (!TextUtils.isEmpty(getUrl()) && !TextUtils.isEmpty(it.getUrl()) && getUrl().equals(it.getUrl())) || (!TextUtils.isEmpty(getName()) && !TextUtils.isEmpty(it.getName()) && getName().equals(it.getName()));
             }
 
             static class Sorter implements Comparator<Episode> {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -154,7 +154,7 @@ private void checkPosition() {
     }
 
     private void checkPage(int count) {
-        if (!mScroller.isEnable() || count == 0 || mAdapter.getItemCount() >= 40 || isFolder() || isHome()) return;
+        if (mScroller.isDisable() || count == 0 || mAdapter.getItemCount() >= 40 || isFolder() || isHome()) return;
         getVideo(getTypeId(), String.valueOf(mScroller.addPage()));
     }
 

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -193,7 +193,6 @@ public void searchContent(Site site, String keyword) throws Throwable {
         } else {
             ArrayMap<String, String> params = new ArrayMap<>();
             params.put("wd", Trans.t2s(keyword));
-            if (site.getType() != 0) params.put("ac", "detail");
             String body = OkHttp.newCall(site.getApi(), params).execute().body().string();
             SpiderDebug.log(site.getName() + "," + body);
             Result result = site.getType() == 0 ? Result.fromXml(body) : Result.fromJson(body);
@@ -214,7 +213,6 @@ public void searchContent(Site site, String keyword, String page) {
                 ArrayMap<String, String> params = new ArrayMap<>();
                 params.put("wd", Trans.t2s(keyword));
                 params.put("pg", page);
-                if (site.getType() != 0) params.put("ac", "detail");
                 String body = OkHttp.newCall(site.getApi(), params).execute().body().string();
                 SpiderDebug.log(site.getName() + "," + body);
                 Result result = site.getType() == 0 ? Result.fromXml(body) : Result.fromJson(body);

File: app/src/mobile/java/com/fongmi/android/tv/Product.java
Patch:
@@ -2,7 +2,6 @@
 
 import android.content.Context;
 
-import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.ResUtil;
 
 public class Product {
@@ -12,7 +11,7 @@ public static int getDeviceType() {
     }
 
     public static int getColumn() {
-        return Math.abs(Prefers.getSize() - 5);
+        return Math.abs(Setting.getSize() - 5);
     }
 
     public static void bootLive() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/base/BaseActivity.java
Patch:
@@ -11,10 +11,10 @@
 import androidx.viewbinding.ViewBinding;
 
 import com.fongmi.android.tv.R;
+import com.fongmi.android.tv.Setting;
 import com.fongmi.android.tv.api.WallConfig;
 import com.fongmi.android.tv.event.RefreshEvent;
 import com.fongmi.android.tv.utils.FileUtil;
-import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.ResUtil;
 
 import org.greenrobot.eventbus.EventBus;
@@ -67,7 +67,7 @@ protected boolean isGone(View view) {
     private void setWall() {
         try {
             if (!customWall()) return;
-            File file = FileUtil.getWall(Prefers.getWall());
+            File file = FileUtil.getWall(Setting.getWall());
             if (file.exists() && file.length() > 0) getWindow().setBackgroundDrawable(WallConfig.drawable(Drawable.createFromPath(file.getAbsolutePath())));
             else getWindow().setBackgroundDrawableResource(ResUtil.getDrawable(file.getName()));
         } catch (Exception e) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/UaDialog.java
Patch:
@@ -9,9 +9,9 @@
 import androidx.fragment.app.Fragment;
 
 import com.fongmi.android.tv.R;
+import com.fongmi.android.tv.Setting;
 import com.fongmi.android.tv.databinding.DialogUaBinding;
 import com.fongmi.android.tv.impl.UaCallback;
-import com.fongmi.android.tv.utils.Prefers;
 import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 
 public class UaDialog {
@@ -42,7 +42,7 @@ private void initDialog() {
     }
 
     private void initView() {
-        String ua = Prefers.getUa();
+        String ua = Setting.getUa();
         binding.text.setText(ua);
         binding.text.setSelection(TextUtils.isEmpty(ua) ? 0 : ua.length());
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -16,6 +16,7 @@
 import androidx.viewpager.widget.ViewPager;
 
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.Setting;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Class;
 import com.fongmi.android.tv.bean.Hot;
@@ -39,7 +40,6 @@
 import com.fongmi.android.tv.ui.custom.dialog.ReceiveDialog;
 import com.fongmi.android.tv.ui.custom.dialog.SiteDialog;
 import com.fongmi.android.tv.utils.FileChooser;
-import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.Trans;
 import com.github.catvod.net.OkHttp;
 import com.google.common.net.HttpHeaders;
@@ -126,7 +126,7 @@ private void setViewModel() {
     }
 
     private void initHot() {
-        mHots = Hot.get(Prefers.getHot());
+        mHots = Hot.get(Setting.getHot());
         App.post(mRunnable = this::updateHot, 0);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -466,7 +466,7 @@ private void setEpisodeAdapter(List<Vod.Flag.Episode> items) {
 
     private void seamless(Vod.Flag flag, boolean force) {
         if (!force && !getSite().isChangeable()) return;
-        Vod.Flag.Episode episode = flag.find(mHistory.getVodRemarks());
+        Vod.Flag.Episode episode = flag.find(mHistory.getVodRemarks(), getMark() == null);
         if (episode == null || episode.isActivated()) return;
         mHistory.setVodRemarks(episode.getName());
         setEpisodeActivated(episode);

File: app/src/main/java/com/fongmi/android/tv/bean/History.java
Patch:
@@ -316,7 +316,7 @@ public void findEpisode(List<Vod.Flag> flags) {
         for (History item : find()) {
             if (getPosition() > 0) break;
             for (Vod.Flag flag : flags) {
-                Vod.Flag.Episode episode = flag.find(item.getVodRemarks());
+                Vod.Flag.Episode episode = flag.find(item.getVodRemarks(), true);
                 if (episode == null) continue;
                 setVodFlag(flag.getFlag());
                 setPosition(item.getPosition());

File: app/src/main/java/com/fongmi/android/tv/player/extractor/Thunder.java
Patch:
@@ -30,14 +30,14 @@ public String fetch(String url) throws Exception {
     }
 
     private String addTorrentTask(Uri uri) {
-        File file = new File(uri.getPath());
+        File torrent = new File(uri.getPath());
         String name = uri.getQueryParameter("name");
         int index = Integer.parseInt(uri.getQueryParameter("index"));
-        taskId = XLTaskHelper.get().addTorrentTask(file, Objects.requireNonNull(file.getParentFile()), index);
+        taskId = XLTaskHelper.get().addTorrentTask(torrent, Objects.requireNonNull(torrent.getParentFile()), index);
         while (true) {
             XLTaskInfo taskInfo = XLTaskHelper.get().getBtSubTaskInfo(taskId, index).mTaskInfo;
             if (taskInfo.mTaskStatus == 3) App.post(() -> Notify.show(taskInfo.getErrorMsg()));
-            if (taskInfo.mTaskStatus != 0) return XLTaskHelper.get().getLocalUrl(new File(file.getParent(), name));
+            if (taskInfo.mTaskStatus != 0) return XLTaskHelper.get().getLocalUrl(new File(torrent.getParent(), name));
             else SystemClock.sleep(50);
         }
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -134,7 +134,6 @@ private void setAdapter(Result result) {
         mBinding.progressLayout.showContent(isFolder(), size);
         mBinding.swipeLayout.setRefreshing(false);
         mScroller.endLoading(size == 0);
-        mAdapter.addAll(result.getList());
         addVideo(result.getList());
         checkPosition();
         checkPage(size);

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -222,7 +222,7 @@ private void checkThunder(List<Vod.Flag> flags) throws Exception {
                 if (!scheme.equals("magnet") && !scheme.equals("thunder")) continue;
                 magnets.add(Magnet.get(episode.getUrl()));
             }
-            for (Future<List<TorrentFileInfo>> future : Executors.newCachedThreadPool().invokeAll(magnets, 3000, TimeUnit.MILLISECONDS)) {
+            for (Future<List<TorrentFileInfo>> future : Executors.newCachedThreadPool().invokeAll(magnets, 5000, TimeUnit.MILLISECONDS)) {
                 List<TorrentFileInfo> files = future.get();
                 if (files.size() > 0) flag.getEpisodes().clear();
                 for (TorrentFileInfo file : files) flag.getEpisodes().add(Vod.Flag.Episode.create(file.getFileName(), file.getPlayUrl()));

File: app/src/mobile/java/com/fongmi/android/tv/Updater.java
Patch:
@@ -10,11 +10,12 @@
 import com.fongmi.android.tv.databinding.DialogUpdateBinding;
 import com.fongmi.android.tv.utils.Download;
 import com.fongmi.android.tv.utils.FileUtil;
-import com.fongmi.android.tv.utils.Github;
 import com.fongmi.android.tv.utils.Notify;
 import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.ResUtil;
 import com.github.catvod.net.OkHttp;
+import com.github.catvod.utils.Github;
+import com.github.catvod.utils.Path;
 import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 
 import org.json.JSONObject;

File: app/src/mobile/java/com/fongmi/android/tv/cast/CastVideo.java
Patch:
@@ -4,7 +4,7 @@
 
 import com.android.cast.dlna.core.ICast;
 import com.fongmi.android.tv.server.Server;
-import com.fongmi.android.tv.utils.FileUtil;
+import com.github.catvod.utils.Path;
 
 import java.util.UUID;
 
@@ -18,7 +18,7 @@ public static CastVideo get(String name, String url) {
     }
 
     private CastVideo(String name, String url) {
-        if (url.startsWith("file")) url = Server.get().getAddress() + "/" + url.replace(FileUtil.getRootPath(), "");
+        if (url.startsWith("file")) url = Server.get().getAddress() + "/" + url.replace(Path.rootPath(), "");
         this.name = name;
         this.url = url;
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -74,6 +74,7 @@
 import com.fongmi.android.tv.utils.ResUtil;
 import com.fongmi.android.tv.utils.Traffic;
 import com.fongmi.android.tv.utils.Utils;
+import com.github.catvod.utils.Util;
 import com.google.android.material.bottomsheet.BottomSheetDialogFragment;
 import com.permissionx.guolindev.PermissionX;
 
@@ -434,7 +435,7 @@ private void setOther(TextView view, Vod item) {
         if (!item.getVodArea().isEmpty()) sb.append(getString(R.string.detail_area, item.getVodArea())).append("  ");
         if (!item.getTypeName().isEmpty()) sb.append(getString(R.string.detail_type, item.getTypeName())).append("  ");
         view.setVisibility(sb.length() == 0 ? View.GONE : View.VISIBLE);
-        view.setText(Utils.substring(sb.toString(), 2));
+        view.setText(Util.substring(sb.toString(), 2));
     }
 
     private void getPlayer(Vod.Flag flag, Vod.Flag.Episode episode, boolean replay) {
@@ -1392,8 +1393,8 @@ public void onBackPressed() {
     protected void onDestroy() {
         super.onDestroy();
         mPlayers.release();
+        Source.get().stop();
         Clock.get().release();
-        Source.get().destroy();
         RefreshEvent.history();
         PlaybackService.stop();
         App.removeCallbacks(mR1, mR2, mR3, mR4);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -921,7 +921,7 @@ public void onBackPressed() {
     protected void onDestroy() {
         super.onDestroy();
         mPlayers.release();
-        Source.get().destroy();
+        Source.get().stop();
         PlaybackService.stop();
         App.removeCallbacks(mR1, mR2, mR3);
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -166,7 +166,7 @@ protected void onDestroy() {
         WallConfig.get().clear();
         LiveConfig.get().clear();
         ApiConfig.get().clear();
-        Source.get().release();
+        Source.get().exit();
         Server.get().stop();
     }
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/CastDialog.java
Patch:
@@ -28,9 +28,9 @@
 import com.fongmi.android.tv.server.Server;
 import com.fongmi.android.tv.ui.activity.ScanActivity;
 import com.fongmi.android.tv.ui.adapter.DeviceAdapter;
-import com.fongmi.android.tv.utils.FileUtil;
 import com.fongmi.android.tv.utils.Notify;
 import com.github.catvod.net.OkHttp;
+import com.github.catvod.utils.Path;
 import com.google.android.material.bottomsheet.BottomSheetDialogFragment;
 
 import org.greenrobot.eventbus.EventBus;
@@ -68,7 +68,7 @@ public CastDialog() {
 
     public CastDialog history(History history) {
         String id = history.getVodId();
-        String fd = id.startsWith("file") ? Server.get().getAddress() + "/" + id.replace(FileUtil.getRootPath(), "") : id;
+        String fd = id.startsWith("file") ? Server.get().getAddress() + "/" + id.replace(Path.rootPath(), "") : id;
         body.add("history", history.toString().replace(id, fd));
         return this;
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingFragment.java
Patch:
@@ -11,7 +11,6 @@
 import androidx.annotation.Nullable;
 import androidx.viewbinding.ViewBinding;
 
-import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.BuildConfig;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.Updater;
@@ -41,6 +40,7 @@
 import com.fongmi.android.tv.utils.Utils;
 import com.github.catvod.bean.Doh;
 import com.github.catvod.net.OkHttp;
+import com.github.catvod.utils.Path;
 import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 import com.permissionx.guolindev.PermissionX;
 
@@ -311,9 +311,9 @@ private void setDoh(View view) {
     }
 
     private void setDoh(Doh doh) {
+        OkHttp.get().setDoh(doh);
         Notify.progress(getActivity());
         Prefers.putDoh(doh.toString());
-        OkHttp.get().setDoh(App.get(), doh);
         mBinding.dohText.setText(doh.getName());
         ApiConfig.load(Config.vod(), getCallback());
     }
@@ -343,6 +343,6 @@ public void onHiddenChanged(boolean hidden) {
     public void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
         super.onActivityResult(requestCode, resultCode, data);
         if (resultCode != Activity.RESULT_OK || requestCode != FileChooser.REQUEST_PICK_FILE) return;
-        setConfig(Config.find("file:/" + FileChooser.getPathFromUri(getContext(), data.getData()).replace(FileUtil.getRootPath(), ""), type));
+        setConfig(Config.find("file:/" + FileChooser.getPathFromUri(getContext(), data.getData()).replace(Path.rootPath(), ""), type));
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/DohDialog.java
Patch:
@@ -6,7 +6,6 @@
 
 import androidx.appcompat.app.AlertDialog;
 
-import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.databinding.DialogDohBinding;
 import com.fongmi.android.tv.impl.DohCallback;
 import com.fongmi.android.tv.ui.adapter.DohAdapter;
@@ -47,7 +46,7 @@ private void setRecyclerView() {
         binding.recycler.setAdapter(adapter);
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
-        App.post(() -> binding.recycler.scrollToPosition(adapter.getSelect()), 16);
+        binding.recycler.post(() -> binding.recycler.scrollToPosition(adapter.getSelect()));
     }
 
     private void setDialog() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/LiveDialog.java
Patch:
@@ -45,7 +45,7 @@ private void setRecyclerView() {
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
         binding.recycler.setLayoutManager(new GridLayoutManager(dialog.getContext(), 1));
-        App.post(() -> binding.recycler.scrollToPosition(LiveConfig.getHomeIndex()), 16);
+        binding.recycler.post(() -> binding.recycler.scrollToPosition(LiveConfig.getHomeIndex()));
     }
 
     private void setDialog() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/SiteDialog.java
Patch:
@@ -10,7 +10,6 @@
 import androidx.recyclerview.widget.GridLayoutManager;
 import androidx.recyclerview.widget.RecyclerView;
 
-import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Site;
@@ -95,7 +94,7 @@ private void setRecyclerView() {
         if (decoration != null) binding.recycler.removeItemDecoration(decoration);
         binding.recycler.addItemDecoration(decoration = new SpaceItemDecoration(getCount(), 16));
         binding.recycler.setLayoutManager(new GridLayoutManager(dialog.getContext(), getCount()));
-        if (!binding.mode.hasFocus()) App.post(() -> binding.recycler.scrollToPosition(ApiConfig.getHomeIndex()), 16);
+        if (!binding.mode.hasFocus()) binding.recycler.post(() -> binding.recycler.scrollToPosition(ApiConfig.getHomeIndex()));
     }
 
     private void setDialog() {

File: app/src/main/java/com/fongmi/android/tv/ui/custom/dialog/TrackDialog.java
Patch:
@@ -10,7 +10,6 @@
 import androidx.media3.common.Tracks;
 import androidx.viewbinding.ViewBinding;
 
-import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.bean.Track;
 import com.fongmi.android.tv.databinding.DialogTrackBinding;
 import com.fongmi.android.tv.player.Players;
@@ -68,7 +67,7 @@ protected void initView() {
         binding.recycler.setHasFixedSize(true);
         binding.recycler.setAdapter(adapter.addAll(getTrack()));
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
-        App.post(() -> binding.recycler.scrollToPosition(adapter.getSelected()), 16);
+        binding.recycler.post(() -> binding.recycler.scrollToPosition(adapter.getSelected()));
     }
 
     private List<Track> getTrack() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/LiveDialog.java
Patch:
@@ -6,6 +6,7 @@
 import androidx.appcompat.app.AlertDialog;
 import androidx.fragment.app.Fragment;
 
+import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.api.LiveConfig;
 import com.fongmi.android.tv.bean.Live;
 import com.fongmi.android.tv.databinding.DialogLiveBinding;
@@ -54,7 +55,7 @@ private void setRecyclerView() {
         binding.recycler.setAdapter(adapter);
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 8));
-        App.post(() -> binding.recycler.scrollToPosition(LiveConfig.getHomeIndex()), 16);
+        binding.recycler.post(() -> binding.recycler.scrollToPosition(LiveConfig.getHomeIndex()));
     }
 
     private void setDialog() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/SiteDialog.java
Patch:
@@ -71,7 +71,7 @@ private void setRecyclerView() {
         binding.recycler.setItemAnimator(null);
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 8));
-        App.post(() -> binding.recycler.scrollToPosition(ApiConfig.getHomeIndex()), 16);
+        binding.recycler.post(() -> binding.recycler.scrollToPosition(ApiConfig.getHomeIndex()));
     }
 
     private void setDialog() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/DohDialog.java
Patch:
@@ -6,6 +6,7 @@
 
 import androidx.appcompat.app.AlertDialog;
 
+import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.databinding.DialogDohBinding;
 import com.fongmi.android.tv.impl.DohCallback;
 import com.fongmi.android.tv.ui.adapter.DohAdapter;
@@ -46,7 +47,7 @@ private void setRecyclerView() {
         binding.recycler.setAdapter(adapter);
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
-        binding.recycler.scrollToPosition(adapter.getSelect());
+        App.post(() -> binding.recycler.scrollToPosition(adapter.getSelect()), 16);
     }
 
     private void setDialog() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/LiveDialog.java
Patch:
@@ -7,6 +7,7 @@
 import androidx.appcompat.app.AlertDialog;
 import androidx.recyclerview.widget.GridLayoutManager;
 
+import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.api.LiveConfig;
 import com.fongmi.android.tv.bean.Live;
 import com.fongmi.android.tv.databinding.DialogLiveBinding;
@@ -44,7 +45,7 @@ private void setRecyclerView() {
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
         binding.recycler.setLayoutManager(new GridLayoutManager(dialog.getContext(), 1));
-        binding.recycler.scrollToPosition(LiveConfig.getHomeIndex());
+        App.post(() -> binding.recycler.scrollToPosition(LiveConfig.getHomeIndex()), 16);
     }
 
     private void setDialog() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/SiteDialog.java
Patch:
@@ -10,6 +10,7 @@
 import androidx.recyclerview.widget.GridLayoutManager;
 import androidx.recyclerview.widget.RecyclerView;
 
+import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Site;
@@ -94,7 +95,7 @@ private void setRecyclerView() {
         if (decoration != null) binding.recycler.removeItemDecoration(decoration);
         binding.recycler.addItemDecoration(decoration = new SpaceItemDecoration(getCount(), 16));
         binding.recycler.setLayoutManager(new GridLayoutManager(dialog.getContext(), getCount()));
-        if (!binding.mode.hasFocus()) binding.recycler.scrollToPosition(ApiConfig.getHomeIndex());
+        if (!binding.mode.hasFocus()) App.post(() -> binding.recycler.scrollToPosition(ApiConfig.getHomeIndex()), 16);
     }
 
     private void setDialog() {

File: app/src/main/java/com/fongmi/android/tv/ui/custom/dialog/TrackDialog.java
Patch:
@@ -10,6 +10,7 @@
 import androidx.media3.common.Tracks;
 import androidx.viewbinding.ViewBinding;
 
+import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.bean.Track;
 import com.fongmi.android.tv.databinding.DialogTrackBinding;
 import com.fongmi.android.tv.player.Players;
@@ -65,9 +66,9 @@ protected ViewBinding getBinding(@NonNull LayoutInflater inflater, @Nullable Vie
     @Override
     protected void initView() {
         binding.recycler.setHasFixedSize(true);
-        binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
         binding.recycler.setAdapter(adapter.addAll(getTrack()));
-        binding.recycler.scrollToPosition(adapter.getSelected());
+        binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
+        App.post(() -> binding.recycler.scrollToPosition(adapter.getSelected()), 16);
     }
 
     private List<Track> getTrack() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/LiveDialog.java
Patch:
@@ -54,7 +54,7 @@ private void setRecyclerView() {
         binding.recycler.setAdapter(adapter);
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 8));
-        binding.recycler.scrollToPosition(LiveConfig.getHomeIndex());
+        App.post(() -> binding.recycler.scrollToPosition(LiveConfig.getHomeIndex()), 16);
     }
 
     private void setDialog() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/SiteDialog.java
Patch:
@@ -71,7 +71,7 @@ private void setRecyclerView() {
         binding.recycler.setItemAnimator(null);
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 8));
-        binding.recycler.scrollToPosition(ApiConfig.getHomeIndex());
+        App.post(() -> binding.recycler.scrollToPosition(ApiConfig.getHomeIndex()), 16);
     }
 
     private void setDialog() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/SiteDialog.java
Patch:
@@ -116,8 +116,7 @@ private void setType(int type) {
         binding.search.setActivated(type == 1);
         binding.change.setActivated(type == 2);
         binding.record.setActivated(type == 3);
-        binding.check.setEnabled(type != 0);
-        adapter.setType(type);
+        adapter.setType(this.type = type);
     }
 
     private void setMode(View view) {
@@ -127,7 +126,8 @@ private void setMode(View view) {
 
     @Override
     public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
-        if (isChecked) adapter.selectAll();
+        if (type == 0) buttonView.setChecked(!isChecked);
+        else if (isChecked) adapter.selectAll();
         else adapter.cancelAll();
     }
 

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -1,12 +1,14 @@
 package com.fongmi.android.tv.utils;
 
 import android.net.Uri;
+import android.text.TextUtils;
 
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Rule;
 import com.github.catvod.crawler.SpiderDebug;
 
 import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.Collections;
 import java.util.HashMap;
 import java.util.List;
@@ -53,9 +55,7 @@ public static List<String> getRegex() {
 
     public static List<String> getRegex(Uri uri) {
         if (uri.getHost() == null) return Collections.emptyList();
-        List<String> hosts = new ArrayList<>();
-        hosts.add(uri.getHost());
-        hosts.add(uri.getQueryParameter("url"));
+        String hosts = TextUtils.join(",", Arrays.asList(uri.getHost(), uri.getQueryParameter("url")));
         for (Rule rule : ApiConfig.get().getRules()) for (String host : rule.getHosts()) if (hosts.contains(host)) return rule.getRegex();
         return Collections.emptyList();
     }

File: quickjs/src/main/java/com/fongmi/quickjs/bean/Req.java
Patch:
@@ -22,7 +22,7 @@ public class Req {
     @SerializedName("method")
     private String method;
     @SerializedName("body")
-    private JsonElement body;
+    private String body;
     @SerializedName("data")
     private JsonElement data;
     @SerializedName("headers")
@@ -52,7 +52,7 @@ public String getMethod() {
         return TextUtils.isEmpty(method) ? "get" : method;
     }
 
-    public JsonElement getBody() {
+    public String getBody() {
         return body;
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/adapter/SiteAdapter.java
Patch:
@@ -35,11 +35,11 @@ public void setType(int type) {
     }
 
     public void selectAll() {
-        setEnable(true);
+        setEnable(type != 3);
     }
 
     public void cancelAll() {
-        setEnable(false);
+        setEnable(type == 3);
     }
 
     @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/adapter/SiteAdapter.java
Patch:
@@ -72,7 +72,7 @@ private int getVisible(Site item) {
     private boolean getChecked(Site item) {
         if (type == 1) return item.isSearchable();
         if (type == 2) return item.isChangeable();
-        if (type == 3) return item.isRecordable();
+        if (type == 3) return !item.isRecordable();
         return false;
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/LiveDialog.java
Patch:
@@ -40,11 +40,11 @@ public void show() {
     }
 
     private int getSpanCount() {
-        return adapter.getItemCount() >= 8 ? 2 : 1;
+        return Math.max(1, Math.min(adapter.getItemCount() / 20, 3));
     }
 
     private float getWidth() {
-        return getSpanCount() == 2 ? 0.6f : 0.4f;
+        return 0.4f + (getSpanCount() - 1) * 0.2f;
     }
 
     private void setRecyclerView() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/SiteDialog.java
Patch:
@@ -59,11 +59,11 @@ public void show() {
     }
 
     private int getSpanCount() {
-        return adapter.getItemCount() >= 10 ? 2 : 1;
+        return Math.max(1, Math.min(adapter.getItemCount() / 20, 3));
     }
 
     private float getWidth() {
-        return getSpanCount() == 2 ? 0.6f : 0.4f;
+        return 0.4f + (getSpanCount() - 1) * 0.2f;
     }
 
     private void setRecyclerView() {

File: app/src/main/java/com/fongmi/android/tv/bean/History.java
Patch:
@@ -276,9 +276,7 @@ private void merge(List<History> items, boolean force) {
         }
     }
 
-    public void update(long position, long duration) {
-        setPosition(position);
-        setDuration(duration);
+    public void update() {
         merge(find(), false);
         save();
     }

File: app/src/main/java/com/fongmi/android/tv/player/IjkUtil.java
Patch:
@@ -7,6 +7,7 @@
 import com.fongmi.android.tv.utils.Sniffer;
 import com.fongmi.android.tv.utils.Utils;
 
+import java.net.URLEncoder;
 import java.util.Map;
 
 import tv.danmaku.ijk.media.player.MediaSource;
@@ -19,7 +20,7 @@ public static MediaSource getSource(Result result) {
 
     public static MediaSource getSource(Map<String, String> headers, String url) {
         Uri uri = Uri.parse(url.trim().replace("\\", ""));
-        if (Sniffer.isAds(uri)) uri = Uri.parse(Server.get().getAddress().concat("/m3u8?url=").concat(url));
+        if (Sniffer.isAds(uri)) uri = Uri.parse(Server.get().getAddress().concat("/m3u8?url=").concat(URLEncoder.encode(url)));
         return new MediaSource(Utils.checkHeaders(headers), uri);
     }
 }

File: app/src/main/java/com/fongmi/android/tv/server/Nano.java
Patch:
@@ -15,9 +15,11 @@
 import com.google.gson.JsonArray;
 import com.google.gson.JsonObject;
 
+import java.io.ByteArrayInputStream;
 import java.io.File;
 import java.io.FileInputStream;
 import java.io.InputStream;
+import java.nio.charset.StandardCharsets;
 import java.text.SimpleDateFormat;
 import java.util.ArrayList;
 import java.util.Arrays;
@@ -126,7 +128,7 @@ private Response doM3u8(IHTTPSession session) {
             String url = session.getParms().get("url");
             String result = M3U8.get(url, session.getHeaders());
             for (String ad : Sniffer.getRegex(Uri.parse(url))) result = result.replaceAll(ad, "");
-            return newFixedLengthResponse(Response.Status.OK, NanoHTTPD.MIME_PLAINTEXT, result);
+            return newChunkedResponse(Response.Status.OK, NanoHTTPD.MIME_PLAINTEXT, new ByteArrayInputStream(result.getBytes(StandardCharsets.UTF_8)));
         } catch (Exception e) {
             return createErrorResponse(e.getMessage());
         }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -15,6 +15,7 @@
 import androidx.viewbinding.ViewBinding;
 
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.Constant;
 import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.api.ApiConfig;
@@ -178,7 +179,7 @@ private void search() {
         mBinding.view.setVisibility(View.VISIBLE);
         mBinding.result.setVisibility(View.VISIBLE);
         if (mExecutor != null) mExecutor.shutdownNow();
-        mExecutor = Executors.newCachedThreadPool();
+        mExecutor = Executors.newFixedThreadPool(Constant.THREAD_POOL * 2);
         String keyword = mBinding.keyword.getText().toString().trim();
         for (Site site : mSites) mExecutor.execute(() -> search(site, keyword));
         App.post(() -> mRecordAdapter.add(keyword), 250);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -1058,7 +1058,7 @@ private boolean isPass(Site item) {
     private void startSearch(String keyword) {
         mSearchAdapter.clear();
         List<Site> sites = new ArrayList<>();
-        mExecutor = Executors.newCachedThreadPool();
+        mExecutor = Executors.newFixedThreadPool(Constant.THREAD_POOL * 2);
         for (Site item : ApiConfig.get().getSites()) if (isPass(item)) sites.add(item);
         for (Site site : sites) mExecutor.execute(() -> search(site, keyword));
     }

File: quickjs/src/main/java/com/fongmi/quickjs/method/Global.java
Patch:
@@ -161,7 +161,7 @@ private void schedule(JSFunction func, int delay) {
         timer.schedule(new TimerTask() {
             @Override
             public void run() {
-                if (!executor.isShutdown()) executor.submit(() -> { func.call(); });
+                if (!executor.isShutdown()) executor.submit(() -> {func.call();});
             }
         }, delay);
     }
@@ -183,8 +183,8 @@ private Request getRequest(String url, Req req, Headers headers) {
     }
 
     private RequestBody getPostBody(Req req, String contentType) {
-        if (!req.getData().isEmpty()) return RequestBody.create(req.getData(), MediaType.get("application/json"));
-        if (!req.getBody().isEmpty() && contentType != null) return RequestBody.create(req.getBody(), MediaType.get(contentType));
+        if (req.getData() != null) return RequestBody.create(gson.toJson(req.getData()), MediaType.get("application/json"));
+        if (req.getBody() != null && contentType != null) return RequestBody.create(gson.toJson(req.getBody()), MediaType.get(contentType));
         return RequestBody.create("", null);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -342,6 +342,7 @@ private void setDecodeView() {
 
     private void setVideoView() {
         mPlayers.set(getExo(), getIjk());
+        getExo().getSubtitleView().setUserDefaultTextSize();
         getExo().getSubtitleView().setStyle(ExoUtil.getCaptionStyle());
         getIjk().getSubtitleView().setTextSize(TypedValue.COMPLEX_UNIT_SP, 16);
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -338,6 +338,7 @@ private void setDecodeView() {
     private void setVideoView() {
         mPlayers.set(getExo(), getIjk());
         if (ResUtil.isLand(this)) enterFullscreen();
+        getExo().getSubtitleView().setUserDefaultTextSize();
         getExo().getSubtitleView().setStyle(ExoUtil.getCaptionStyle());
         getIjk().getSubtitleView().setTextSize(TypedValue.COMPLEX_UNIT_SP, 14);
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -998,6 +998,7 @@ private void initSearch(String keyword, boolean auto) {
 
     private boolean isPass(Site item) {
         if (isAutoMode() && !item.isChangeable()) return false;
+        if (isAutoMode() && item.getKey().equals(getKey())) return false;
         return item.isSearchable();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -1050,6 +1050,7 @@ private void initSearch(String keyword, boolean auto) {
 
     private boolean isPass(Site item) {
         if (isAutoMode() && !item.isChangeable()) return false;
+        if (isAutoMode() && item.getKey().equals(getKey())) return false;
         return item.isSearchable();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -186,8 +186,8 @@ public void onLoadMore(String page) {
     @Override
     public void onItemClick(Vod item) {
         if (item.isFolder()) getVideo(item.getVodId(), "1");
-        if (item.isFolder()) mPages.add(Page.get(item.getVodId(), findPosition()));
         else DetailActivity.start(getActivity(), getKey(), item.getVodId(), item.getVodName());
+        if (item.isFolder()) mPages.add(Page.get(item.getVodId(), findPosition()));
     }
 
     @Override
@@ -199,8 +199,7 @@ public boolean onLongClick(Vod item) {
     @Override
     public boolean canBack() {
         if (mPages.isEmpty()) return true;
-        mPage = getLastPage();
-        mPages.remove(mPage);
+        mPages.remove(mPage = getLastPage());
         onRefresh();
         return false;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -1013,6 +1013,7 @@ private void setSearch(List<Vod> items) {
         mSearchAdapter.addAll(mSearchAdapter.size(), items);
         mBinding.search.setVisibility(View.VISIBLE);
         if (isInitAuto()) nextSite();
+        if (items.isEmpty()) return;
         App.removeCallbacks(mR3);
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -1068,6 +1068,7 @@ private void setSearch(Result result) {
         mBinding.search.setVisibility(View.VISIBLE);
         mSearchAdapter.addAll(items);
         if (isInitAuto()) nextSite();
+        if (items.isEmpty()) return;
         App.removeCallbacks(mR4);
     }
 

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -156,6 +156,7 @@ public void playerContent(String key, String flag, String id) {
                 SpiderDebug.log(body);
                 Result result = Result.fromJson(body);
                 if (result.getFlag().isEmpty()) result.setFlag(flag);
+                result.setUrl(Source.getUrl(result.getUrl()));
                 return result;
             } else if (key.equals("push_agent")) {
                 Result result = new Result();

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -244,7 +244,7 @@ public void setRecent(Site site) {
         boolean py = site.getApi().startsWith("py_");
         boolean csp = site.getApi().startsWith("csp_");
         if (js) jsLoader.setRecent(site.getKey());
-        else if (py) pyLoader.setRecent(site.getJar());
+        else if (py) pyLoader.setRecent(site.getKey());
         else if (csp) jarLoader.setRecent(site.getJar());
     }
 

File: pyramid/src/main/java/com/undcover/freedom/pyramid/Spider.java
Patch:
@@ -81,7 +81,7 @@ public boolean isVideoFormat(String url) {
 
     @Override
     public Object[] proxyLocal(Map<?, ?> params) throws Exception {
-        List<PyObject> list = app.callAttr("localProxy", params).asList();
+        List<PyObject> list = app.callAttr("localProxy", obj, gson.toJson(params)).asList();
         int code = list.get(0).toInt();
         String type = list.get(1).toString();
         String action = list.get(2).toString();

File: app/src/main/java/com/fongmi/android/tv/player/source/Source.java
Patch:
@@ -5,7 +5,7 @@
 public class Source {
 
     private static String getScheme(Uri uri) {
-        return uri.getScheme().toLowerCase();
+        return uri.getScheme() == null ? "" : uri.getScheme().toLowerCase();
     }
 
     private static boolean isHttp(Uri uri) {
@@ -33,7 +33,7 @@ private static boolean isBiliBili(Uri uri) {
     }
 
     private static boolean isJianPian(Uri uri) {
-        return uri.getScheme().equals("tvbox-xg");
+        return getScheme(uri).equals("tvbox-xg");
     }
 
     public static String getUrl(String url) throws Exception {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -295,7 +295,7 @@ public void start(Channel channel) {
     public void start(Result result, boolean useParse, int timeout) {
         if (result.getUrl().isEmpty()) {
             ErrorEvent.url();
-        } else if (result.getParse() == 1 || result.getJx() == 1) {
+        } else if (result.getParse(1) == 1 || result.getJx() == 1) {
             stopParse();
             parseJob = ParseJob.create(this).start(result, useParse);
         } else {

File: catvod/src/main/java/com/github/catvod/spider/Proxy.java
Patch:
@@ -19,12 +19,12 @@ static void adjustPort() throws Exception {
         }
     }
 
-    public static String getUrl(String type) {
+    public static String getUrl() {
         try {
             adjustPort();
-            return "http://127.0.0.1:" + port + "/proxy?do=" + type;
+            return "http://127.0.0.1:" + port + "/proxy";
         } catch (Exception e) {
-            return "http://127.0.0.1:9978/proxy?do=" + type;
+            return "http://127.0.0.1:9978/proxy";
         }
     }
 }

File: drpy/src/main/java/com/hiker/drpy/method/Global.java
Patch:
@@ -69,7 +69,7 @@ public void setProperty() {
     @Keep
     @JSMethod
     public String getProxy(boolean local) {
-        return Proxy.getUrl("js");
+        return Proxy.getUrl() + "?do=js";
     }
 
     @Keep

File: pyramid/src/main/java/com/undcover/freedom/pyramid/Spider.java
Patch:
@@ -110,6 +110,6 @@ private ArrayMap<String, String> getParam(JSONObject object) {
     }
 
     private String replaceUrl(String content) {
-        return content.replace("http://127.0.0.1:UndCover/proxy", Proxy.getUrl("py"));
+        return content.replace("http://127.0.0.1:UndCover/proxy", Proxy.getUrl());
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -391,12 +391,13 @@ private void setEmpty() {
             showEmpty();
         } else {
             checkSearch(false);
-            App.post(mR3, 5000);
+            App.post(mR3, 10000);
         }
     }
 
     private void showEmpty() {
         mBinding.progressLayout.showEmpty();
+        stopSearch();
     }
 
     private void setDetail(Vod item) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -382,15 +382,15 @@ private void setEmpty() {
             showEmpty();
         } else {
             checkSearch(false);
-            App.post(mR4, 5000);
+            App.post(mR4, 10000);
         }
     }
 
     private void showEmpty() {
-        if (!mBinding.progressLayout.isProgress()) return;
         showError(getString(R.string.error_play_url));
         mBinding.swipeLayout.setEnabled(true);
         mBinding.progressLayout.showEmpty();
+        stopSearch();
     }
 
     private void setDetail(Vod item) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -122,6 +122,7 @@ public static void push(FragmentActivity activity, Uri uri) {
     }
 
     public static void file(FragmentActivity activity, String path) {
+        if (TextUtils.isEmpty(path)) return;
         String name = new File(path).getName();
         if (Utils.hasPermission(activity)) start(activity, "push_agent", "file://" + path, name, true);
         else PermissionX.init(activity).permissions(Manifest.permission.WRITE_EXTERNAL_STORAGE).request((allGranted, grantedList, deniedList) -> start(activity, "push_agent", "file://" + path, name, true));

File: app/src/main/java/com/fongmi/android/tv/utils/FileChooser.java
Patch:
@@ -56,7 +56,7 @@ public static String getPathFromUri(Context context, Uri uri) {
         if (DocumentsContract.isDocumentUri(context, uri)) path = getPathFromDocumentUri(context, uri);
         else if (ContentResolver.SCHEME_CONTENT.equals(uri.getScheme())) path = getDataColumn(context, uri);
         else if (ContentResolver.SCHEME_FILE.equalsIgnoreCase(uri.getScheme())) path = uri.getPath();
-        return path != null ? path : createFileFromUri(context, uri).getAbsolutePath();
+        return path != null ? path : createFileFromUri(context, uri);
     }
 
     private static String getPathFromDocumentUri(Context context, Uri uri) {
@@ -100,7 +100,7 @@ private static String getPath(Context context, String[] split) {
         }
     }
 
-    private static File createFileFromUri(Context context, Uri uri) {
+    private static String createFileFromUri(Context context, Uri uri) {
         String[] projection = {MediaStore.MediaColumns.DISPLAY_NAME};
         Cursor cursor = context.getContentResolver().query(uri, projection, null, null, null);
         try (cursor) {
@@ -115,7 +115,7 @@ private static File createFileFromUri(Context context, Uri uri) {
             while ((count = is.read(buffer)) != -1) os.write(buffer, 0, count);
             os.close();
             is.close();
-            return file;
+            return file.getAbsolutePath();
         } catch (Exception e) {
             return null;
         }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -133,6 +133,7 @@ public static void push(FragmentActivity activity, Uri uri) {
     }
 
     public static void file(FragmentActivity activity, String path) {
+        if (TextUtils.isEmpty(path)) return;
         String name = new File(path).getName();
         if (Utils.hasPermission(activity)) start(activity, "push_agent", "file://" + path, name);
         else PermissionX.init(activity).permissions(Manifest.permission.WRITE_EXTERNAL_STORAGE).request((allGranted, grantedList, deniedList) -> start(activity, "push_agent", "file://" + path, name));

File: app/src/main/java/com/fongmi/android/tv/bean/Live.java
Patch:
@@ -117,7 +117,7 @@ public JsonElement getHeader() {
     }
 
     public int getPlayerType() {
-        return playerType == null ? -1 : playerType;
+        return playerType == null ? -1 : Math.min(playerType, 2);
     }
 
     public List<Channel> getChannels() {

File: app/src/main/java/com/fongmi/android/tv/bean/Site.java
Patch:
@@ -105,7 +105,7 @@ public String getPlayUrl() {
     }
 
     public int getPlayerType() {
-        return playerType == null ? -1 : playerType;
+        return playerType == null ? -1 : Math.min(playerType, 2);
     }
 
     public Integer getSearchable() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -380,6 +380,7 @@ private void setEmpty() {
             showEmpty();
         } else {
             checkSearch(false);
+            App.post(mR4, 5000);
         }
     }
 
@@ -1024,7 +1025,6 @@ private void initSearch(String keyword, boolean auto) {
         setAutoMode(auto);
         setInitAuto(auto);
         startSearch(keyword);
-        App.post(mR4, 10000);
     }
 
     private void startSearch(String keyword) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/ControlDialog.java
Patch:
@@ -1,5 +1,6 @@
 package com.fongmi.android.tv.ui.custom.dialog;
 
+import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
@@ -83,6 +84,8 @@ protected ViewBinding getBinding(@NonNull LayoutInflater inflater, @Nullable Vie
 
     @Override
     protected void initView() {
+        if (players == null) dismiss();
+        if (players == null) return;
         binding.speed.setValue(Math.max(players.getSpeed(), 1.0f));
         binding.player.setText(detail.control.action.player.getText());
         binding.decode.setText(detail.control.action.decode.getText());

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/AndroidMediaPlayer.java
Patch:
@@ -89,7 +89,7 @@ public void start() throws IllegalStateException {
 
     @Override
     public void stop() throws IllegalStateException {
-        mMediaPlayer.stop();
+        if (mMediaPlayer.isPlaying()) mMediaPlayer.stop();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -114,9 +114,7 @@ private static MediaSource getSource(Map<String, String> headers, String url, St
     private static MediaItem getMediaItem(Uri uri, String mimeType, List<Sub> subs) {
         MediaItem.Builder builder = new MediaItem.Builder().setUri(uri);
         if (subs.size() > 0) builder.setSubtitleConfigurations(getSubtitles(subs));
-        builder.setAllowChunklessPreparation(Players.isHard());
         if (mimeType != null) builder.setMimeType(mimeType);
-        builder.setAds(Sniffer.getAdsRegex(uri));
         return builder.build();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -578,7 +578,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getHome().getPlayerType() == -1 && event.isFormat() && getToggleCount() < 2) {
+        if (getHome().getPlayerType() == -1 && event.isFormat() && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -614,7 +614,7 @@ public void onErrorEvent(ErrorEvent event) {
     }
 
     private void checkError(ErrorEvent event) {
-        if (getHome().getPlayerType() == -1 && event.isFormat() && getToggleCount() < 2) {
+        if (getHome().getPlayerType() == -1 && event.isFormat() && getToggleCount() < 2 && mPlayers.getPlayer() != Players.SYS) {
             toggleCount++;
             nextPlayer();
         } else {

File: app/src/mobile/java/com/fongmi/android/tv/ui/base/BaseActivity.java
Patch:
@@ -5,6 +5,7 @@
 import android.graphics.drawable.Drawable;
 import android.os.Bundle;
 import android.view.View;
+import android.view.Window;
 import android.view.WindowManager;
 
 import androidx.appcompat.app.AppCompatActivity;
@@ -76,8 +77,9 @@ private void setWall() {
     }
 
     private void setTransparent(Activity activity) {
-        activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
         activity.getWindow().clearFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS);
+        activity.getWindow().addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
+        activity.getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN | View.SYSTEM_UI_FLAG_LAYOUT_STABLE);
         activity.getWindow().setStatusBarColor(Color.TRANSPARENT);
     }
 

File: drpy/src/main/java/com/hiker/drpy/method/Global.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.text.TextUtils;
 import android.util.Base64;
+import android.util.Log;
 
 import androidx.annotation.Keep;
 
@@ -158,7 +159,7 @@ private Call call(String url, JSONObject object, Headers headers) {
         int redirect = object.optInt("redirect", 1);
         int timeout = object.optInt("timeout", OkHttp.TIMEOUT);
         OkHttpClient client = redirect == 1 ? OkHttp.client() : OkHttp.noRedirect();
-        client.newBuilder().connectTimeout(timeout, TimeUnit.MILLISECONDS);
+        client = client.newBuilder().connectTimeout(timeout, TimeUnit.MILLISECONDS).readTimeout(timeout, TimeUnit.MILLISECONDS).writeTimeout(timeout, TimeUnit.MILLISECONDS).build();
         return client.newCall(getRequest(url, object, headers));
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Site.java
Patch:
@@ -125,7 +125,7 @@ public void setFilterable(Integer filterable) {
     }
 
     public Integer getChangeable() {
-        return changeable == null ? 1 : changeable;
+        return changeable == null ? 0 : changeable;
     }
 
     public void setChangeable(Integer changeable) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -890,7 +890,7 @@ private void setDefaultTrack() {
 
     @Subscribe(threadMode = ThreadMode.MAIN)
     public void onErrorEvent(ErrorEvent event) {
-        if (!event.isRetry() || mPlayers.addRetry() > 3) checkError(event);
+        if (!event.isRetry() || mPlayers.addRetry() > 1) checkError(event);
         else onRefresh();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -573,7 +573,7 @@ private void setTrackVisible(boolean visible) {
 
     @Subscribe(threadMode = ThreadMode.MAIN)
     public void onErrorEvent(ErrorEvent event) {
-        if (!event.isRetry() || mPlayers.addRetry() > 3) checkError(event);
+        if (!event.isRetry() || mPlayers.addRetry() > 1) checkError(event);
         else fetch();
     }
 

File: app/src/main/java/com/fongmi/android/tv/event/ErrorEvent.java
Patch:
@@ -18,8 +18,8 @@ public static void parse() {
         EventBus.getDefault().post(new ErrorEvent(Type.PARSE, false));
     }
 
-    public static void format(boolean retry) {
-        EventBus.getDefault().post(new ErrorEvent(Type.FORMAT, retry));
+    public static void format() {
+        EventBus.getDefault().post(new ErrorEvent(Type.FORMAT, true));
     }
 
     public static void episode() {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -400,7 +400,7 @@ public void onParseError() {
     @Override
     public void onPlayerError(@NonNull PlaybackException error) {
         this.errorCode = error.errorCode;
-        ErrorEvent.format(true);
+        ErrorEvent.format();
     }
 
     @Override
@@ -433,7 +433,7 @@ public void onInfo(IMediaPlayer mp, int what, int extra) {
 
     @Override
     public boolean onError(IMediaPlayer mp, int what, int extra) {
-        ErrorEvent.format(false);
+        ErrorEvent.format();
         return true;
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -945,7 +945,7 @@ private void setDefaultTrack() {
 
     @Subscribe(threadMode = ThreadMode.MAIN)
     public void onErrorEvent(ErrorEvent event) {
-        if (!event.isRetry() || mPlayers.addRetry() > 3) checkError(event);
+        if (!event.isRetry() || mPlayers.addRetry() > 1) checkError(event);
         else onRefresh();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -609,7 +609,7 @@ private void setTrackVisible(boolean visible) {
 
     @Subscribe(threadMode = ThreadMode.MAIN)
     public void onErrorEvent(ErrorEvent event) {
-        if (!event.isRetry() || mPlayers.addRetry() > 3) checkError(event);
+        if (!event.isRetry() || mPlayers.addRetry() > 1) checkError(event);
         else fetch();
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Config.java
Patch:
@@ -37,8 +37,7 @@ public class Config {
     private String parse;
 
     public static List<Config> arrayFrom(String str) {
-        Type listType = new TypeToken<List<Config>>() {
-        }.getType();
+        Type listType = new TypeToken<List<Config>>() {}.getType();
         List<Config> items = new Gson().fromJson(str, listType);
         return items == null ? Collections.emptyList() : items;
     }

File: app/src/mobile/java/com/fongmi/android/tv/service/PlaybackService.java
Patch:
@@ -23,10 +23,10 @@ public static void stop() {
     }
 
     @Override
-    public void onCreate() {
-        super.onCreate();
+    public int onStartCommand(Intent intent, int flags, int startId) {
         NotificationCompat.Builder builder = new NotificationCompat.Builder(this, Notify.DEFAULT).setVisibility(NotificationCompat.VISIBILITY_PUBLIC).setSmallIcon(R.drawable.ic_logo);
         startForeground(9527, builder.build());
+        return START_STICKY;
     }
 
     @Nullable

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -1341,6 +1341,7 @@ protected void onDestroy() {
         mPlayers.release();
         Clock.get().release();
         RefreshEvent.history();
+        PlaybackService.stop();
         App.removeCallbacks(mR1, mR2, mR3);
         mViewModel.result.removeObserver(mObserveDetail);
         mViewModel.player.removeObserver(mObservePlayer);

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -918,6 +918,7 @@ protected void onDestroy() {
         Force.get().stop();
         ZLive.get().stop();
         TVBus.get().stop();
+        PlaybackService.stop();
         App.removeCallbacks(mR1, mR2, mR3);
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -544,6 +544,7 @@ private void onVideo() {
 
     private void onChange() {
         mBroken.add(getId());
+        setAutoMode(true);
         checkSearch();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -481,6 +481,7 @@ private void onReverse() {
 
     private boolean onChange() {
         mBroken.add(getId());
+        setAutoMode(true);
         checkSearch();
         return true;
     }

File: drpy/src/main/java/com/hiker/drpy/method/Global.java
Patch:
@@ -149,9 +149,7 @@ private void schedule(JSFunction func, int delay) {
         timer.schedule(new TimerTask() {
             @Override
             public void run() {
-                executor.submit(() -> {
-                    func.call();
-                });
+                if (!executor.isShutdown()) executor.submit(() -> { func.call(); });
             }
         }, delay);
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -326,6 +326,7 @@ private void setViewModel() {
             mBinding.control.parse.setVisibility(isFullscreen() && isUseParse() ? View.VISIBLE : View.GONE);
             int timeout = getSite().isChangeable() ? Constant.TIMEOUT_PLAY : -1;
             mPlayers.start(result, isUseParse(), timeout);
+            mBinding.swipeLayout.setRefreshing(false);
         });
         mViewModel.result.observe(this, result -> {
             mBinding.swipeLayout.setRefreshing(false);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -103,7 +103,7 @@ private void checkAction(Intent intent) {
         boolean push = ApiConfig.hasPush() && intent.getAction() != null;
         if (push && intent.getAction().equals(Intent.ACTION_SEND) && intent.getType().equals("text/plain")) {
             DetailActivity.push(this, Uri.parse(intent.getStringExtra(Intent.EXTRA_TEXT)));
-        } else if (push && intent.getAction().equals(Intent.ACTION_VIEW) && intent.getData().getScheme() != null) {
+        } else if (push && intent.getAction().equals(Intent.ACTION_VIEW) && intent.getData() != null && intent.getData().getScheme() != null) {
             DetailActivity.push(this, intent.getData());
         }
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -62,7 +62,7 @@ private void checkAction(Intent intent) {
         boolean push = ApiConfig.hasPush() && intent.getAction() != null;
         if (push && intent.getAction().equals(Intent.ACTION_SEND) && intent.getType().equals("text/plain")) {
             DetailActivity.push(this, Uri.parse(intent.getStringExtra(Intent.EXTRA_TEXT)));
-        } else if (push && intent.getAction().equals(Intent.ACTION_VIEW) && intent.getData().getScheme() != null) {
+        } else if (push && intent.getAction().equals(Intent.ACTION_VIEW) && intent.getData() != null && intent.getData().getScheme() != null) {
             DetailActivity.push(this, intent.getData());
         }
     }

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/IjkMediaPlayer.java
Patch:
@@ -178,7 +178,7 @@ public static void loadLibrariesOnce(IjkLibLoader libLoader) {
         synchronized (IjkMediaPlayer.class) {
             if (!mIsLibLoaded) {
                 if (libLoader == null) libLoader = sLocalLibLoader;
-                libLoader.loadLibrary("ffmpeg");
+                libLoader.loadLibrary("ijkffmpeg");
                 libLoader.loadLibrary("ijksdl");
                 libLoader.loadLibrary("player");
                 mIsLibLoaded = true;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -103,7 +103,7 @@ private void checkAction(Intent intent) {
         boolean push = ApiConfig.hasPush() && intent.getAction() != null;
         if (push && intent.getAction().equals(Intent.ACTION_SEND) && intent.getType().equals("text/plain")) {
             DetailActivity.push(this, Uri.parse(intent.getStringExtra(Intent.EXTRA_TEXT)));
-        } else if (push && intent.getAction().equals(Intent.ACTION_VIEW)) {
+        } else if (push && intent.getAction().equals(Intent.ACTION_VIEW) && intent.getData().getScheme() != null) {
             DetailActivity.push(this, intent.getData());
         }
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -62,7 +62,7 @@ private void checkAction(Intent intent) {
         boolean push = ApiConfig.hasPush() && intent.getAction() != null;
         if (push && intent.getAction().equals(Intent.ACTION_SEND) && intent.getType().equals("text/plain")) {
             DetailActivity.push(this, Uri.parse(intent.getStringExtra(Intent.EXTRA_TEXT)));
-        } else if (push && intent.getAction().equals(Intent.ACTION_VIEW)) {
+        } else if (push && intent.getAction().equals(Intent.ACTION_VIEW) && intent.getData().getScheme() != null) {
             DetailActivity.push(this, intent.getData());
         }
     }

File: app/src/main/java/com/fongmi/android/tv/event/ErrorEvent.java
Patch:
@@ -53,7 +53,7 @@ public boolean isRetry() {
     }
 
     public boolean isFormat() {
-        return getType() == Type.FORMAT;
+        return Type.FORMAT.equals(getType());
     }
 
     public String getMsg() {

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/MediaSource.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.net.Uri;
 
+import java.util.HashMap;
 import java.util.Map;
 
 public class MediaSource {
@@ -15,7 +16,7 @@ public MediaSource(Map<String, String> headers, Uri uri) {
     }
 
     public Map<String, String> getHeaders() {
-        return headers;
+        return headers == null ? new HashMap<>() : headers;
     }
 
     public Uri getUri() {

File: app/src/main/java/com/fongmi/android/tv/server/process/ActionRequestProcess.java
Patch:
@@ -149,7 +149,7 @@ private void syncKeep(Map<String, String> params) {
         List<Config> configs = Config.arrayFrom(params.get("configs"));
         List<Keep> targets = Keep.arrayFrom(params.get("targets"));
         boolean replace = Objects.equals(params.get("mode"), "1");
-        if (ApiConfig.getUrl() == null && configs.size() > 0) {
+        if (ApiConfig.getUrl().isEmpty() && configs.size() > 0) {
             ApiConfig.load(Config.find(configs.get(0), 0), getCallback(configs, targets));
         } else {
             if (replace) Keep.deleteAll();

File: app/src/main/java/com/fongmi/android/tv/player/IjkUtil.java
Patch:
@@ -19,7 +19,7 @@ public static MediaSource getSource(Result result) {
 
     public static MediaSource getSource(Map<String, String> headers, String url) {
         Uri uri = Uri.parse(url.trim().replace("\\", ""));
-        if (Sniffer.isAds(uri)) uri = Uri.parse(Server.get().getAddress(true).concat("/m3u8?url=").concat(url));
+        if (Sniffer.isAds(uri)) uri = Uri.parse(Server.get().getAddress().concat("/m3u8?url=").concat(url));
         return new MediaSource(Utils.checkHeaders(headers), uri);
     }
 }

File: app/src/main/java/com/fongmi/android/tv/server/Nano.java
Patch:
@@ -29,7 +29,6 @@
 import java.util.regex.Pattern;
 
 import fi.iki.elonen.NanoHTTPD;
-import okhttp3.Headers;
 
 public class Nano extends NanoHTTPD {
 
@@ -123,7 +122,7 @@ private Response doFile(String url) {
     private Response doM3u8(IHTTPSession session) {
         try {
             String url = session.getParms().get("url");
-            String result = M3U8.get(url, Headers.of(session.getHeaders()));
+            String result = M3U8.get(url, session.getHeaders());
             for (String ad : Sniffer.getAdsRegex(Uri.parse(url))) result = result.replaceAll(ad, "");
             return newFixedLengthResponse(Response.Status.OK, NanoHTTPD.MIME_PLAINTEXT, result);
         } catch (Exception e) {

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -29,7 +29,7 @@ public static void start(Live live) {
         if (live.getGroups().size() > 0) return;
         if (live.getType() == 0) text(live, getText(live.getUrl()));
         if (live.getType() == 1) json(live, getText(live.getUrl()));
-        if (live.getType() == 2) proxy(live, getText(live.getUrl()));
+        if (live.getType() == 2) proxy(live, getText(Utils.checkProxy(live.getUrl())));
     }
 
     public static void text(Live live, String text) {

File: app/src/main/java/com/fongmi/android/tv/bean/Live.java
Patch:
@@ -3,7 +3,6 @@
 import android.net.Uri;
 import android.text.TextUtils;
 
-import com.fongmi.android.tv.utils.Utils;
 import com.google.gson.Gson;
 import com.google.gson.JsonElement;
 import com.google.gson.annotations.SerializedName;
@@ -152,7 +151,7 @@ public Live check() {
     }
 
     private void setProxy() {
-        this.url = Utils.checkProxy(getChannels().get(0).getUrls().get(0));
+        this.url = getChannels().get(0).getUrls().get(0);
         this.name = getChannels().get(0).getName();
         this.type = 2;
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/CastDialog.java
Patch:
@@ -131,8 +131,8 @@ private void onRefresh() {
     }
 
     private void onRefresh(boolean clear) {
+        if (fm) ScanTask.create(this).start(adapter.getIps());
         DLNACastManager.getInstance().search(null, 15);
-        ScanTask.create(this).start(adapter.getIps());
         if (clear) adapter.clear();
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -113,10 +113,7 @@ private static MediaSource getSource(Map<String, String> headers, String url, Li
     private static MediaItem getMediaItem(Uri uri, List<Sub> subs, int errorCode) {
         MediaItem.Builder builder = new MediaItem.Builder().setUri(uri);
         if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED || errorCode == PlaybackException.ERROR_CODE_IO_UNSPECIFIED) builder.setMimeType(MimeTypes.APPLICATION_M3U8);
-        else if (errorCode == PlaybackException.ERROR_CODE_PARSING_MANIFEST_MALFORMED) builder.setMimeType(MimeTypes.APPLICATION_OCTET);
         if (subs.size() > 0) builder.setSubtitleConfigurations(getSubtitles(subs));
-        builder.setAllowChunklessPreparation(Players.isHard());
-        builder.setAds(Sniffer.getAdsRegex(uri));
         return builder.build();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/ControlDialog.java
Patch:
@@ -83,7 +83,7 @@ protected ViewBinding getBinding(@NonNull LayoutInflater inflater, @Nullable Vie
 
     @Override
     protected void initView() {
-        binding.speed.setValue(players.getSpeed());
+        binding.speed.setValue(Math.max(players.getSpeed(), 1.0f));
         binding.player.setText(detail.control.action.player.getText());
         binding.decode.setText(detail.control.action.decode.getText());
         binding.ending.setText(detail.control.action.ending.getText());

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/IjkMediaPlayer.java
Patch:
@@ -588,7 +588,7 @@ public void setSpeed(float speed) {
 
     @Override
     public float getSpeed() {
-        return _getPropertyFloat(FFP_PROP_FLOAT_PLAYBACK_RATE, 0);
+        return _getPropertyFloat(FFP_PROP_FLOAT_PLAYBACK_RATE, 1.0f);
     }
 
     public int getVideoDecoder() {

File: app/src/main/java/com/fongmi/android/tv/bean/Track.java
Patch:
@@ -6,6 +6,7 @@
 import androidx.room.PrimaryKey;
 
 import com.fongmi.android.tv.db.AppDatabase;
+import com.fongmi.android.tv.player.Players;
 
 import java.util.List;
 
@@ -92,11 +93,11 @@ public void setSelected(boolean selected) {
     }
 
     public boolean isExo(int player) {
-        return getPlayer() == player && player == 0;
+        return getPlayer() == player && player == Players.EXO;
     }
 
     public boolean isIjk(int player) {
-        return getPlayer() == player && player == 1;
+        return getPlayer() == player && player != Players.EXO;
     }
 
     public Track toggle() {

File: app/src/main/java/com/fongmi/android/tv/utils/Prefers.java
Patch:
@@ -5,6 +5,7 @@
 import androidx.preference.PreferenceManager;
 
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.player.Players;
 
 public class Prefers {
 
@@ -92,7 +93,7 @@ public static void putReset(int reset) {
     }
 
     public static int getPlayer() {
-        return getInt("player", 2);
+        return getInt("player", Players.EXO);
     }
 
     public static void putPlayer(int player) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -286,6 +286,7 @@ private void setRecyclerView() {
     }
 
     private void setPlayerView() {
+        getIjk().setPlayer(mPlayers.getPlayer());
         mBinding.control.player.setText(mPlayers.getPlayerText());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
@@ -643,7 +644,6 @@ private void setEnding(long ending) {
 
     private void onPlayer() {
         mPlayers.togglePlayer();
-        mPlayers.set(getExo(), getIjk());
         Prefers.putPlayer(mPlayers.getPlayer());
         mHistory.setPlayer(mPlayers.getPlayer());
         setPlayerView();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -178,6 +178,7 @@ private void setRecyclerView() {
     }
 
     private void setPlayerView() {
+        getIjk().setPlayer(mPlayers.getPlayer());
         mBinding.control.player.setText(mPlayers.getPlayerText());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
@@ -307,7 +308,6 @@ private void onAcross() {
 
     private void onPlayer() {
         mPlayers.togglePlayer();
-        mPlayers.set(getExo(), getIjk());
         Prefers.putLivePlayer(mPlayers.getPlayer());
         setPlayerView();
         getUrl();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -281,6 +281,7 @@ private void setRecyclerView() {
     }
 
     private void setPlayerView() {
+        getIjk().setPlayer(mPlayers.getPlayer());
         mBinding.control.action.player.setText(mPlayers.getPlayerText());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
@@ -594,7 +595,6 @@ private boolean onResetToggle() {
 
     private void onPlayer() {
         mPlayers.togglePlayer();
-        mPlayers.set(getExo(), getIjk());
         Prefers.putPlayer(mPlayers.getPlayer());
         mHistory.setPlayer(mPlayers.getPlayer());
         setPlayerView();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -179,6 +179,7 @@ private void setRecyclerView() {
     }
 
     private void setPlayerView() {
+        getIjk().setPlayer(mPlayers.getPlayer());
         mBinding.control.action.player.setText(mPlayers.getPlayerText());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
@@ -308,7 +309,6 @@ private void onAcross() {
 
     private void onPlayer() {
         mPlayers.togglePlayer();
-        mPlayers.set(getExo(), getIjk());
         Prefers.putLivePlayer(mPlayers.getPlayer());
         setPlayerView();
         setR1Callback();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -287,7 +287,6 @@ private void setRecyclerView() {
 
     private void setPlayerView() {
         mBinding.control.player.setText(mPlayers.getPlayerText());
-        if (mPlayers.isIjk()) getIjk().setPlayer(mPlayers.getPlayer());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
         mBinding.control.reset.setText(ResUtil.getStringArray(R.array.select_reset)[Prefers.getReset()]);
@@ -644,6 +643,7 @@ private void setEnding(long ending) {
 
     private void onPlayer() {
         mPlayers.togglePlayer();
+        mPlayers.set(getExo(), getIjk());
         Prefers.putPlayer(mPlayers.getPlayer());
         mHistory.setPlayer(mPlayers.getPlayer());
         setPlayerView();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -179,7 +179,6 @@ private void setRecyclerView() {
 
     private void setPlayerView() {
         mBinding.control.player.setText(mPlayers.getPlayerText());
-        if (mPlayers.isIjk()) getIjk().setPlayer(mPlayers.getPlayer());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
     }
@@ -308,6 +307,7 @@ private void onAcross() {
 
     private void onPlayer() {
         mPlayers.togglePlayer();
+        mPlayers.set(getExo(), getIjk());
         Prefers.putLivePlayer(mPlayers.getPlayer());
         setPlayerView();
         getUrl();

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -81,6 +81,7 @@ private void setupExo(PlayerView view) {
     private void setupIjk(IjkVideoView view) {
         ijkPlayer = view.render(Prefers.getRender()).decode(decode);
         ijkPlayer.addListener(this);
+        ijkPlayer.setPlayer(player);
     }
 
     public ExoPlayer exo() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -281,7 +281,6 @@ private void setRecyclerView() {
     }
 
     private void setPlayerView() {
-        if (mPlayers.isIjk()) getIjk().setPlayer(mPlayers.getPlayer());
         mBinding.control.action.player.setText(mPlayers.getPlayerText());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
@@ -595,6 +594,7 @@ private boolean onResetToggle() {
 
     private void onPlayer() {
         mPlayers.togglePlayer();
+        mPlayers.set(getExo(), getIjk());
         Prefers.putPlayer(mPlayers.getPlayer());
         mHistory.setPlayer(mPlayers.getPlayer());
         setPlayerView();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -179,7 +179,6 @@ private void setRecyclerView() {
     }
 
     private void setPlayerView() {
-        if (mPlayers.isIjk()) getIjk().setPlayer(mPlayers.getPlayer());
         mBinding.control.action.player.setText(mPlayers.getPlayerText());
         getExo().setVisibility(mPlayers.isExo() ? View.VISIBLE : View.GONE);
         getIjk().setVisibility(mPlayers.isIjk() ? View.VISIBLE : View.GONE);
@@ -309,6 +308,7 @@ private void onAcross() {
 
     private void onPlayer() {
         mPlayers.togglePlayer();
+        mPlayers.set(getExo(), getIjk());
         Prefers.putLivePlayer(mPlayers.getPlayer());
         setPlayerView();
         setR1Callback();

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/AbstractMediaPlayer.java
Patch:
@@ -6,8 +6,9 @@ public abstract class AbstractMediaPlayer implements IMediaPlayer {
 
     private Listener mListener;
 
-    public final void setListener(Listener listener) {
+    public final IMediaPlayer setListener(Listener listener) {
         mListener = listener;
+        return this;
     }
 
     public void resetListeners() {

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/IMediaPlayer.java
Patch:
@@ -126,7 +126,7 @@ public interface IMediaPlayer {
     @Deprecated
     boolean isPlayable();
 
-    void setListener(Listener listener);
+    IMediaPlayer setListener(Listener listener);
 
     /*--------------------
      * Listeners

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -41,6 +41,7 @@
 import com.fongmi.android.tv.utils.FileUtil;
 import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.Sniffer;
+import com.fongmi.android.tv.utils.Utils;
 import com.github.catvod.net.OkHttp;
 import com.google.common.net.HttpHeaders;
 
@@ -154,7 +155,7 @@ private static synchronized HttpDataSource.Factory getHttpDataSourceFactory() {
 
     private static synchronized DataSource.Factory getDataSourceFactory(Map<String, String> headers) {
         if (dataSourceFactory == null) dataSourceFactory = buildReadOnlyCacheDataSource(new DefaultDataSource.Factory(App.get(), getHttpDataSourceFactory()), getCache());
-        httpDataSourceFactory.setDefaultRequestProperties(headers);
+        httpDataSourceFactory.setDefaultRequestProperties(Utils.checkHeaders(headers));
         return dataSourceFactory;
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/IjkUtil.java
Patch:
@@ -5,6 +5,7 @@
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.server.Server;
 import com.fongmi.android.tv.utils.Sniffer;
+import com.fongmi.android.tv.utils.Utils;
 
 import java.util.Map;
 
@@ -19,6 +20,6 @@ public static MediaSource getSource(Result result) {
     public static MediaSource getSource(Map<String, String> headers, String url) {
         Uri uri = Uri.parse(url.trim().replace("\\", ""));
         if (Sniffer.isAds(uri)) uri = Uri.parse(Server.get().getAddress(true).concat("/m3u8?url=").concat(url));
-        return new MediaSource(headers, uri);
+        return new MediaSource(Utils.checkHeaders(headers), uri);
     }
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -860,6 +860,7 @@ public void onPlayerEvent(PlayerEvent event) {
                 setTrackVisible(true);
                 checkPlayImg(mPlayers.isPlaying());
                 mBinding.control.size.setText(mPlayers.getSizeText());
+                if (isVisible(mBinding.control.getRoot())) showControl();
                 break;
             case Player.STATE_ENDED:
                 checkEnded();

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -163,7 +163,7 @@ public void onLoadMore(String page) {
     @Override
     public void onItemClick(Vod item) {
         if (item.isFolder()) getVideo(item.getVodId(), "1");
-        else DetailActivity.start(getActivity(), item.getVodId(), item.getVodName());
+        else DetailActivity.start(getActivity(), getKey(), item.getVodId(), item.getVodName());
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -99,7 +99,7 @@ private static MediaSource getSource(Map<String, String> headers, String url, Li
     private static MediaItem getMediaItem(Uri uri, List<Sub> subs, int errorCode) {
         MediaItem.Builder builder = new MediaItem.Builder().setUri(uri);
         if (errorCode == PlaybackException.ERROR_CODE_PARSING_MANIFEST_MALFORMED) builder.setMimeType(MimeTypes.APPLICATION_OCTET);
-        else if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED) builder.setMimeType(MimeTypes.APPLICATION_M3U8);
+        else if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED || errorCode == PlaybackException.ERROR_CODE_IO_UNSPECIFIED) builder.setMimeType(MimeTypes.APPLICATION_M3U8);
         if (subs.size() > 0) builder.setSubtitleConfigurations(getSubtitles(subs));
         builder.setAllowChunklessPreparation(Prefers.getDecode() == 1);
         return builder.setAds(getAdsRegex(uri)).build();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -144,9 +144,8 @@ public void onItemClick(Class item) {
     }
 
     @Override
-    public boolean onLongClick(Class item) {
+    public void onRefresh(Class item) {
         getFragment().onRefresh();
-        return true;
     }
 
     @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/TypePresenter.java
Patch:
@@ -23,7 +23,7 @@ public interface OnClickListener {
 
         void onItemClick(Class item);
 
-        boolean onLongClick(Class item);
+        void onRefresh(Class item);
     }
 
     @Override
@@ -38,7 +38,7 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         holder.binding.text.setText(item.getTypeName());
         holder.binding.text.setCompoundDrawablePadding(ResUtil.dp2px(4));
         holder.binding.text.setCompoundDrawablesRelativeWithIntrinsicBounds(0, 0, getIcon(item), 0);
-        holder.view.setOnLongClickListener(view -> mListener.onLongClick(item));
+        holder.binding.text.setListener(() -> mListener.onRefresh(item));
         setOnClickListener(holder, view -> mListener.onItemClick(item));
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/Updater.java
Patch:
@@ -78,7 +78,7 @@ public void start() {
     }
 
     private boolean need(int code, String name) {
-        return Prefers.getUpdate() && branch.equals(Github.DEV) ? !name.equals(BuildConfig.VERSION_NAME) && code >= BuildConfig.VERSION_CODE : code > BuildConfig.VERSION_CODE;
+        return Prefers.getUpdate() && (branch.equals(Github.DEV) ? !name.equals(BuildConfig.VERSION_NAME) && code >= BuildConfig.VERSION_CODE : code > BuildConfig.VERSION_CODE);
     }
 
     private void doInBackground() {

File: app/src/leanback/java/com/fongmi/android/tv/Updater.java
Patch:
@@ -77,7 +77,7 @@ public void start() {
     }
 
     private boolean need(int code, String name) {
-        return Prefers.getUpdate() && branch.equals(Github.DEV) ? !name.equals(BuildConfig.VERSION_NAME) && code >= BuildConfig.VERSION_CODE : code > BuildConfig.VERSION_CODE;
+        return Prefers.getUpdate() && (branch.equals(Github.DEV) ? !name.equals(BuildConfig.VERSION_NAME) && code >= BuildConfig.VERSION_CODE : code > BuildConfig.VERSION_CODE);
     }
 
     private void doInBackground() {

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -48,7 +48,7 @@ public static void text(Live live, String text) {
     private static void json(Live live, String text) {
         live.getGroups().addAll(Group.arrayFrom(text));
         for (Group group : live.getGroups()) {
-            for (Channel channel : group.getChannel()) {
+            for (Channel channel : group.live(live).getChannel()) {
                 channel.live(live);
             }
         }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -649,7 +649,7 @@ public void setUITimer() {
     public boolean nextGroup(boolean skip) {
         int position = mBinding.group.getSelectedPosition() + 1;
         if (position > mGroupAdapter.size() - 1) position = 0;
-        if (mGroup == mGroupAdapter.get(position)) return false;
+        if (mGroup.equals(mGroupAdapter.get(position))) return false;
         mGroup = (Group) mGroupAdapter.get(position);
         mBinding.group.setSelectedPosition(position);
         if (skip && mGroup.skip()) return nextGroup(true);
@@ -662,7 +662,7 @@ public boolean nextGroup(boolean skip) {
     public boolean prevGroup(boolean skip) {
         int position = mBinding.group.getSelectedPosition() - 1;
         if (position < 0) position = mGroupAdapter.size() - 1;
-        if (mGroup == mGroupAdapter.get(position)) return false;
+        if (mGroup.equals(mGroupAdapter.get(position))) return false;
         mGroup = (Group) mGroupAdapter.get(position);
         mBinding.group.setSelectedPosition(position);
         if (skip && mGroup.skip()) return prevGroup(true);

File: app/src/main/java/com/fongmi/android/tv/model/LiveViewModel.java
Patch:
@@ -44,7 +44,7 @@ public void getLive(Live item) {
 
     private void verify(Live item) {
         Iterator<Group> iterator = item.getGroups().iterator();
-        while (iterator.hasNext()) if (iterator.next().getChannel().isEmpty()) iterator.remove();
+        while (iterator.hasNext()) if (iterator.next().isEmpty()) iterator.remove();
     }
 
     public void getUrl(Channel item) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -700,14 +700,14 @@ private void hideError() {
     }
 
     private void showControl() {
+        mBinding.control.setting.setVisibility(mHistory == null || isFullscreen() ? View.GONE : View.VISIBLE);
         mBinding.control.share.setVisibility(getUrl() == null || isFullscreen() ? View.GONE : View.VISIBLE);
         mBinding.control.cast.setVisibility(getUrl() == null || isFullscreen() ? View.GONE : View.VISIBLE);
         mBinding.control.keep.setVisibility(mHistory == null || isFullscreen() ? View.GONE : View.VISIBLE);
         mBinding.control.parse.setVisibility(isFullscreen() && isUseParse() ? View.VISIBLE : View.GONE);
         mBinding.control.rotate.setVisibility(isFullscreen() && !isLock() ? View.VISIBLE : View.GONE);
         mBinding.control.back.setVisibility(isFullscreen() && !isLock() ? View.VISIBLE : View.GONE);
         mBinding.control.action.getRoot().setVisibility(isFullscreen() ? View.VISIBLE : View.GONE);
-        mBinding.control.setting.setVisibility(isFullscreen() ? View.GONE : View.VISIBLE);
         mBinding.control.lock.setVisibility(isFullscreen() ? View.VISIBLE : View.GONE);
         mBinding.control.center.setVisibility(isLock() ? View.GONE : View.VISIBLE);
         mBinding.control.bottom.setVisibility(isLock() ? View.GONE : View.VISIBLE);

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomScroller.java
Patch:
@@ -23,6 +23,7 @@ public void onScrollStateChanged(@NonNull RecyclerView view, int newState) {
     }
 
     private boolean isBottom(RecyclerView view) {
+        if (view.getLayoutManager() == null || view.getLayoutManager().getItemCount() == 0) return false;
         View lastChild = view.getLayoutManager().getChildAt(view.getLayoutManager().getChildCount() - 1);
         int lastPosition = view.getLayoutManager().getPosition(lastChild);
         return lastPosition == view.getLayoutManager().getItemCount() - 1;

File: app/src/main/java/com/fongmi/android/tv/bean/Group.java
Patch:
@@ -110,7 +110,7 @@ public boolean isKeep() {
     }
 
     public boolean skip() {
-        return isKeep();
+        return isKeep() || getChannel().isEmpty();
     }
 
     public void loadLogo(ImageView view) {

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -29,6 +29,7 @@ public static boolean isVideoFormat(String url, Map<String, String> headers) {
 
     private static boolean matchOrContain(String url) {
         Uri uri = Uri.parse(url);
+        if (uri.getHost() == null) return false;
         for (Rule rule : ApiConfig.get().getRules()) for (String host : rule.getHosts()) if (uri.getHost().contains(host)) for (String regex : rule.getRegex()) return Pattern.compile(regex).matcher(url).find() || url.contains(regex);
         return false;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -1109,7 +1109,6 @@ protected void onResume() {
     @Override
     protected void onPause() {
         super.onPause();
-        RefreshEvent.history();
         onPause(false);
         Clock.stop();
     }
@@ -1132,6 +1131,7 @@ public void onBackPressed() {
     protected void onDestroy() {
         super.onDestroy();
         mPlayers.release();
+        RefreshEvent.history();
         App.removeCallbacks(mR1, mR2);
     }
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/CastDialog.java
Patch:
@@ -13,6 +13,7 @@
 import com.android.cast.dlna.dmc.OnDeviceRegistryListener;
 import com.android.cast.dlna.dmc.control.ICastInterface;
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.Constant;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Device;
@@ -57,7 +58,7 @@ public static CastDialog create() {
     }
 
     public CastDialog() {
-        client = OkHttp.client(1000);
+        client = OkHttp.client(Constant.TIMEOUT_SYNC);
         body = new FormBody.Builder();
         body.add("url", ApiConfig.getUrl());
         body.add("device", Device.get().toString());

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/SyncDialog.java
Patch:
@@ -10,6 +10,7 @@
 import androidx.viewbinding.ViewBinding;
 
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.Constant;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Config;
@@ -51,7 +52,7 @@ public static SyncDialog create() {
     }
 
     public SyncDialog() {
-        client = OkHttp.client(1000);
+        client = OkHttp.client(Constant.TIMEOUT_SYNC);
         body = new FormBody.Builder();
     }
 

File: catvod/src/main/java/com/github/catvod/bean/Doh.java
Patch:
@@ -3,14 +3,14 @@
 import android.content.Context;
 import android.text.TextUtils;
 
+import androidx.annotation.NonNull;
+
 import com.github.catvod.crawler.R;
 import com.google.gson.Gson;
 import com.google.gson.JsonElement;
 import com.google.gson.annotations.SerializedName;
 import com.google.gson.reflect.TypeToken;
 
-import org.jetbrains.annotations.NotNull;
-
 import java.lang.reflect.Type;
 import java.net.InetAddress;
 import java.util.ArrayList;
@@ -85,7 +85,7 @@ public boolean equals(Object obj) {
         return getUrl().equals(it.getUrl());
     }
 
-    @NotNull
+    @NonNull
     @Override
     public String toString() {
         return new Gson().toJson(this);

File: app/src/main/java/com/fongmi/android/tv/bean/Site.java
Patch:
@@ -198,7 +198,7 @@ public Site sync() {
         Site item = find(getKey());
         if (item == null) return this;
         setChangeable(item.getChangeable());
-        if (getSearchable() != 0) setSearchable(item.getSearchable());
+        if (getSearchable() != 0) setSearchable(Math.max(1, item.getSearchable()));
         return this;
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -97,7 +97,7 @@ private static MediaItem getMediaItem(Uri uri, List<Sub> subs, int errorCode) {
         MediaItem.Builder builder = new MediaItem.Builder().setUri(uri);
         if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED) builder.setMimeType(MimeTypes.APPLICATION_M3U8);
         if (subs.size() > 0) builder.setSubtitleConfigurations(getSubtitles(subs));
-        return builder.setAds(getAdsRegex(uri)).build();
+        return builder.build();
     }
 
     private static List<String> getAdsRegex(Uri uri) {

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -142,6 +142,7 @@ public void playerContent(String key, String flag, String id) {
                 ApiConfig.get().setJar(site.getJar());
                 Result result = Result.objectFrom(playerContent);
                 if (result.getFlag().isEmpty()) result.setFlag(flag);
+                if (result.getAds().isEmpty()) result.setAds(site.getAds());
                 result.setKey(key);
                 return result;
             } else if (site.getType() == 4) {
@@ -152,6 +153,7 @@ public void playerContent(String key, String flag, String id) {
                 SpiderDebug.log(body);
                 Result result = Result.fromJson(body);
                 if (result.getFlag().isEmpty()) result.setFlag(flag);
+                if (result.getAds().isEmpty()) result.setAds(site.getAds());
                 return result;
             } else {
                 String url = id;
@@ -160,6 +162,7 @@ public void playerContent(String key, String flag, String id) {
                 Result result = new Result();
                 result.setUrl(url);
                 result.setFlag(flag);
+                result.setAds(site.getAds());
                 result.setPlayUrl(site.getPlayUrl());
                 result.setParse(Utils.isVideoFormat(url) && result.getPlayUrl().isEmpty() ? 0 : 1);
                 return result;

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -254,7 +254,6 @@ public int getCurrentPosition() {
     public void seekTo(int positionMs) {
         if (!isInPlaybackState()) return;
         onInfo(mPlayer, IMediaPlayer.MEDIA_INFO_BUFFERING_START, 0);
-        Log.e("DDD", "SEEKTO");
         mPlayer.seekTo(positionMs);
         mStartPosition = 0;
     }

File: app/src/main/java/com/fongmi/android/tv/bean/Live.java
Patch:
@@ -9,6 +9,7 @@
 import com.google.gson.annotations.SerializedName;
 import com.google.gson.reflect.TypeToken;
 
+import java.io.File;
 import java.lang.reflect.Type;
 import java.util.ArrayList;
 import java.util.Collections;
@@ -61,7 +62,7 @@ public Live() {
     }
 
     public Live(String url) {
-        this.name = Uri.parse(url).getLastPathSegment();
+        this.name = url.startsWith("file") ? new File(url).getName() : Uri.parse(url).getLastPathSegment();
         this.url = url;
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/HistoryActivity.java
Patch:
@@ -10,6 +10,7 @@
 
 import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.R;
+import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.History;
 import com.fongmi.android.tv.databinding.ActivityHistoryBinding;
 import com.fongmi.android.tv.event.RefreshEvent;
@@ -37,6 +38,7 @@ protected ViewBinding getBinding() {
 
     @Override
     protected void initView(Bundle savedInstanceState) {
+        mBinding.sync.setVisibility(ApiConfig.getUrl() == null ? View.GONE : View.VISIBLE);
         setRecyclerView();
         getHistory();
     }

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -176,7 +176,7 @@ private int[] getKeep(List<Group> items) {
     }
 
     public void setKeep(Channel channel) {
-        if (channel.getGroup().isHidden() || home == null) return;
+        if (home == null || channel.getGroup().isHidden() || channel.getUrls().isEmpty()) return;
         Prefers.putKeep(home.getName() + AppDatabase.SYMBOL + channel.getGroup().getName() + AppDatabase.SYMBOL + channel.getName() + AppDatabase.SYMBOL + channel.getCurrent());
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Channel.java
Patch:
@@ -197,15 +197,15 @@ public void prevLine() {
     }
 
     public String getCurrent() {
-        return getUrls().get(getLine());
+        return getUrls().isEmpty() ? "" : getUrls().get(getLine());
     }
 
     public boolean isOnly() {
         return getUrls().size() == 1;
     }
 
     public boolean isLast() {
-        return getLine() == getUrls().size() - 1;
+        return getUrls().isEmpty() || getLine() == getUrls().size() - 1;
     }
 
     public String getLineText() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SearchActivity.java
Patch:
@@ -29,11 +29,13 @@
 import com.fongmi.android.tv.ui.custom.dialog.SiteDialog;
 import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.Utils;
+import com.google.common.net.HttpHeaders;
 
 import java.io.IOException;
 import java.util.List;
 
 import okhttp3.Call;
+import okhttp3.Headers;
 import okhttp3.Response;
 
 public class SearchActivity extends BaseActivity implements WordAdapter.OnClickListener, RecordAdapter.OnClickListener, CustomKeyboard.Callback, SiteCallback {
@@ -98,7 +100,7 @@ private void setRecyclerView() {
     private void getHot() {
         mBinding.hint.setText(R.string.search_hot);
         mWordAdapter.addAll(Hot.get(Prefers.getHot()));
-        OkHttp.newCall("https://api.web.360kan.com/v1/rank?cat=1").enqueue(new Callback() {
+        OkHttp.newCall("https://api.web.360kan.com/v1/rank?cat=1", Headers.of(HttpHeaders.REFERER, "https://www.360kan.com/rank/general")).enqueue(new Callback() {
             @Override
             public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {
                 List<String> items = Hot.get(response.body().string());

File: app/src/main/java/com/fongmi/android/tv/bean/Hot.java
Patch:
@@ -20,7 +20,7 @@ public static List<String> get(String str) {
         try {
             List<String> items = new ArrayList<>();
             for (Data item : objectFrom(str).getData()) items.add(item.getTitle());
-            Prefers.putHot(str);
+            if (items.size() > 0) Prefers.putHot(str);
             return items;
         } catch (Exception e) {
             return new ArrayList<>();

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -42,6 +42,7 @@
 import com.fongmi.android.tv.ui.custom.dialog.SiteDialog;
 import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.Trans;
+import com.google.common.net.HttpHeaders;
 
 import org.greenrobot.eventbus.EventBus;
 import org.greenrobot.eventbus.Subscribe;
@@ -53,6 +54,7 @@
 import java.util.Random;
 
 import okhttp3.Call;
+import okhttp3.Headers;
 import okhttp3.Response;
 
 public class VodFragment extends BaseFragment implements SiteCallback, FilterCallback, TypeAdapter.OnClickListener {
@@ -129,7 +131,7 @@ private void initHot() {
     }
 
     private void getHot() {
-        OkHttp.newCall("https://api.web.360kan.com/v1/rank?cat=1").enqueue(new Callback() {
+        OkHttp.newCall("https://api.web.360kan.com/v1/rank?cat=1", Headers.of(HttpHeaders.REFERER, "https://www.360kan.com/rank/general")).enqueue(new Callback() {
             @Override
             public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {
                 mHots = Hot.get(response.body().string());

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -417,7 +417,7 @@ private void resetPass() {
     @Override
     public void onItemClick(Group item) {
         mChannelAdapter.setItems(item.getChannel(), null);
-        mBinding.channel.setSelectedPosition(item.getPosition());
+        mBinding.channel.setSelectedPosition(Math.max(item.getPosition(), 0));
         if (!item.isKeep() || ++count < 5 || mHides.isEmpty()) return;
         PassDialog.create().show(this);
         App.removeCallbacks(mR0);

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -54,7 +54,7 @@ public class ExoUtil {
     private static Cache cache;
 
     public static LoadControl buildLoadControl() {
-        return new DefaultLoadControl.Builder().setBufferDurationsMs(DefaultLoadControl.DEFAULT_MIN_BUFFER_MS, DefaultLoadControl.DEFAULT_MAX_BUFFER_MS * 6, DefaultLoadControl.DEFAULT_BUFFER_FOR_PLAYBACK_MS, DefaultLoadControl.DEFAULT_BUFFER_FOR_PLAYBACK_AFTER_REBUFFER_MS).build();
+        return new DefaultLoadControl();
     }
 
     public static TrackSelector buildTrackSelector() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/CustomKeyDownLive.java
Patch:
@@ -87,9 +87,8 @@ public boolean onDoubleTap(@NonNull MotionEvent e) {
 
     @Override
     public boolean onSingleTapConfirmed(@NonNull MotionEvent e) {
-        if (lock) return true;
         int half = ResUtil.getScreenWidthNav() / 2;
-        if (e.getX() > half) listener.onDoubleTap();
+        if (e.getX() > half || lock) listener.onDoubleTap();
         else listener.onSingleTap();
         return true;
     }

File: app/src/main/java/com/fongmi/android/tv/bean/Vod.java
Patch:
@@ -228,7 +228,7 @@ public Flag(String flag) {
         }
 
         public String getShow() {
-            return TextUtils.isEmpty(show) ? "" : show;
+            return TextUtils.isEmpty(show) ? getFlag() : show;
         }
 
         public String getFlag() {

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomRecyclerView.java
Patch:
@@ -47,7 +47,8 @@ public void scrollToPosition(int position) {
 
     @Override
     protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
-        if (maxHeight > 0) heightMeasureSpec = MeasureSpec.makeMeasureSpec(maxHeight, MeasureSpec.AT_MOST);
+        int newHeight = MeasureSpec.makeMeasureSpec(maxHeight, MeasureSpec.AT_MOST);
+        if (heightMeasureSpec > newHeight) heightMeasureSpec = newHeight;
         super.onMeasure(widthMeasureSpec, heightMeasureSpec);
     }
 }

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -163,7 +163,7 @@ private void parseConfig(JsonObject object, Callback callback) {
             jarLoader.parseJar("", Json.safeString(object, "spider"));
             config.json(object.toString()).update();
             App.post(callback::success);
-        } catch (Exception e) {
+        } catch (Throwable e) {
             e.printStackTrace();
             App.post(() -> callback.error(R.string.error_config_parse));
         }

File: app/src/main/java/com/fongmi/android/tv/api/JarLoader.java
Patch:
@@ -43,7 +43,7 @@ public void setJar(String jar) {
         this.jar = jar;
     }
 
-    private void load(String key, File file) throws Exception {
+    private void load(String key, File file) throws Throwable {
         DexClassLoader loader = new DexClassLoader(file.getAbsolutePath(), FileUtil.getCachePath(), null, App.get().getClassLoader());
         Class<?> classInit = loader.loadClass("com.github.catvod.spider.Init");
         Method method = classInit.getMethod("init", Context.class);
@@ -69,7 +69,7 @@ private File download(String jar) {
         }
     }
 
-    public void parseJar(String key, String jar) throws Exception {
+    public void parseJar(String key, String jar) throws Throwable {
         String[] texts = jar.split(";md5;");
         String md5 = !jar.startsWith("file") && texts.length > 1 ? texts[1].trim() : "";
         jar = texts[0];

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -493,6 +493,7 @@ public void onResponse(@NonNull Call call, @NonNull Response response) throws IO
     }
 
     private void getUrl() {
+        if (mChannel == null) return;
         LiveConfig.get().setKeep(mChannel);
         mViewModel.getUrl(mChannel);
         showProgress();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -27,6 +27,7 @@
 import com.fongmi.android.tv.bean.Group;
 import com.fongmi.android.tv.bean.Keep;
 import com.fongmi.android.tv.bean.Live;
+import com.fongmi.android.tv.bean.Track;
 import com.fongmi.android.tv.databinding.ActivityLiveBinding;
 import com.fongmi.android.tv.event.ErrorEvent;
 import com.fongmi.android.tv.event.PlayerEvent;

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/PassDialog.java
Patch:
@@ -20,8 +20,8 @@
 
 public class PassDialog extends BaseDialog {
 
-    private final PassCallback callback;
     private DialogPassBinding binding;
+    private PassCallback callback;
 
     public static PassDialog create() {
         return new PassDialog();

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/SiteDialog.java
Patch:
@@ -51,7 +51,7 @@ public SiteDialog change() {
     public SiteDialog all() {
         this.presenter.search(true);
         this.presenter.change(true);
-        this.width = 0.5f;
+        this.width = 0.45f;
         return this;
     }
 
@@ -71,7 +71,7 @@ private void setDialog() {
         if (adapter.size() == 0) return;
         WindowManager.LayoutParams params = dialog.getWindow().getAttributes();
         params.width = (int) (ResUtil.getScreenWidth() * width);
-        params.height = (int) (ResUtil.getScreenHeight() * 0.745f);
+        params.height = (int) (ResUtil.getScreenHeight() * 0.736f);
         dialog.getWindow().setAttributes(params);
         dialog.getWindow().setDimAmount(0);
         dialog.show();

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/LinkDialog.java
Patch:
@@ -14,7 +14,7 @@
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.databinding.DialogLinkBinding;
 import com.fongmi.android.tv.ui.activity.DetailActivity;
-import com.fongmi.android.tv.utils.FileChooser;
+import com.fongmi.android.tv.ui.custom.FileChooser;
 import com.fongmi.android.tv.utils.Utils;
 import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -20,10 +20,10 @@
 import com.fongmi.android.tv.net.Callback;
 import com.fongmi.android.tv.server.Server;
 import com.fongmi.android.tv.ui.base.BaseActivity;
+import com.fongmi.android.tv.ui.custom.FileChooser;
 import com.fongmi.android.tv.ui.custom.FragmentStateManager;
 import com.fongmi.android.tv.ui.fragment.SettingFragment;
 import com.fongmi.android.tv.ui.fragment.VodFragment;
-import com.fongmi.android.tv.utils.FileChooser;
 import com.fongmi.android.tv.utils.Notify;
 import com.google.android.material.navigation.NavigationBarView;
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/dialog/ConfigDialog.java
Patch:
@@ -15,7 +15,7 @@
 import com.fongmi.android.tv.bean.Config;
 import com.fongmi.android.tv.databinding.DialogConfigBinding;
 import com.fongmi.android.tv.impl.ConfigCallback;
-import com.fongmi.android.tv.utils.FileChooser;
+import com.fongmi.android.tv.ui.custom.FileChooser;
 import com.fongmi.android.tv.utils.Utils;
 import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingFragment.java
Patch:
@@ -26,7 +26,7 @@
 import com.fongmi.android.tv.impl.SiteCallback;
 import com.fongmi.android.tv.net.Callback;
 import com.fongmi.android.tv.ui.base.BaseFragment;
-import com.fongmi.android.tv.utils.FileChooser;
+import com.fongmi.android.tv.ui.custom.FileChooser;
 import com.fongmi.android.tv.ui.custom.dialog.ConfigDialog;
 import com.fongmi.android.tv.ui.custom.dialog.HistoryDialog;
 import com.fongmi.android.tv.ui.custom.dialog.LiveDialog;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -35,11 +35,11 @@
 import com.fongmi.android.tv.ui.activity.KeepActivity;
 import com.fongmi.android.tv.ui.adapter.TypeAdapter;
 import com.fongmi.android.tv.ui.base.BaseFragment;
+import com.fongmi.android.tv.ui.custom.FileChooser;
 import com.fongmi.android.tv.ui.custom.dialog.FilterDialog;
 import com.fongmi.android.tv.ui.custom.dialog.LinkDialog;
 import com.fongmi.android.tv.ui.custom.dialog.ReceiveDialog;
 import com.fongmi.android.tv.ui.custom.dialog.SiteDialog;
-import com.fongmi.android.tv.utils.FileChooser;
 import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.Trans;
 import com.google.android.material.bottomsheet.BottomSheetDialogFragment;

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -7,7 +7,6 @@
 import androidx.media3.common.MimeTypes;
 import androidx.media3.common.PlaybackException;
 import androidx.media3.common.Tracks;
-import androidx.media3.common.util.Util;
 import androidx.media3.database.DatabaseProvider;
 import androidx.media3.database.StandaloneDatabaseProvider;
 import androidx.media3.datasource.DataSource;
@@ -35,6 +34,7 @@
 import com.fongmi.android.tv.bean.Sub;
 import com.fongmi.android.tv.utils.FileUtil;
 import com.fongmi.android.tv.utils.Prefers;
+import com.fongmi.android.tv.utils.Sniffer;
 import com.google.common.net.HttpHeaders;
 
 import java.util.ArrayList;
@@ -108,7 +108,7 @@ private static synchronized HttpDataSource.Factory getHttpDataSourceFactory() {
     }
 
     private static synchronized DataSource.Factory getDataSourceFactory(Map<String, String> headers) {
-        if (!headers.containsKey(HttpHeaders.USER_AGENT)) headers.put(HttpHeaders.USER_AGENT, Util.getUserAgent(App.get(), App.get().getPackageName()));
+        if (!headers.containsKey(HttpHeaders.USER_AGENT)) headers.put(HttpHeaders.USER_AGENT, Sniffer.CHROME);
         if (dataSourceFactory == null) dataSourceFactory = buildReadOnlyCacheDataSource(new DefaultDataSource.Factory(App.get(), getHttpDataSourceFactory()), getCache());
         httpDataSourceFactory.setDefaultRequestProperties(headers);
         return dataSourceFactory;

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -4,7 +4,7 @@
 
 public class Sniffer {
 
-    public static final String CHROME = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36";
+    public static final String CHROME = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36";
 
     public static final Pattern RULE = Pattern.compile(
             "http((?!http).){12,}?\\.(m3u8|mp4|flv|avi|mkv|rm|wmv|mpg|m4a|mp3)\\?.*|" +

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -176,7 +176,7 @@ private void openVideo() {
     }
 
     private void fixUserAgent() {
-        if (!mHeaders.containsKey(Utils.USER_AGENT)) mHeaders.put(Utils.USER_AGENT, Utils.getUserAgent(mAppContext));
+        if (!mHeaders.containsKey(Utils.USER_AGENT)) mHeaders.put(Utils.USER_AGENT, Utils.CHROME);
         mIjkPlayer.setOption(format, "user_agent", mHeaders.get(Utils.USER_AGENT));
         mHeaders.remove(Utils.USER_AGENT);
     }

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/Utils.java
Patch:
@@ -9,6 +9,7 @@
 public class Utils {
 
     public static final String USER_AGENT = "User-Agent";
+    public static final String CHROME = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36";
 
     public static float dp2px(Context context, float dpValue) {
         return Math.round((dpValue * context.getResources().getDisplayMetrics().densityDpi) / DisplayMetrics.DENSITY_DEFAULT);

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -229,7 +229,7 @@ private void homeContent() {
     }
 
     public Result getResult() {
-        return mResult;
+        return mResult == null ? new Result() : mResult;
     }
 
     @Subscribe(threadMode = ThreadMode.MAIN)

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -32,11 +32,13 @@ public static void load(String url, ImageView view, ImageView.ScaleType scaleTyp
 
     public static void loadKeep(String url, ImageView view) {
         view.setScaleType(ImageView.ScaleType.CENTER);
+        if (TextUtils.isEmpty(url)) view.setImageResource(R.drawable.ic_img_error);
         Glide.with(App.get()).asBitmap().load(getUrl(url)).error(R.drawable.ic_img_error).placeholder(R.drawable.ic_img_loading).listener(getListener(view)).into(view);
     }
 
     public static void loadHistory(String url, ImageView view) {
         view.setScaleType(ImageView.ScaleType.CENTER);
+        if (TextUtils.isEmpty(url)) view.setImageResource(R.drawable.ic_img_error);
         Glide.with(App.get()).asBitmap().load(getUrl(url)).error(R.drawable.ic_img_error).placeholder(R.drawable.ic_img_loading).listener(getListener(view)).into(view);
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Device.java
Patch:
@@ -92,12 +92,12 @@ public boolean isMobile() {
         return getType() == 1;
     }
 
-    public boolean isCast() {
+    public boolean isDLNA() {
         return getType() == 2;
     }
 
     public String getHost() {
-        return isCast() ? getUuid() : Uri.parse(getIp()).getHost();
+        return isDLNA() ? getUuid() : Uri.parse(getIp()).getHost();
     }
 
     public Device save() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -411,6 +411,7 @@ public void onItemClick(Parse item) {
     }
 
     private void setEpisodeAdapter(List<Vod.Flag.Episode> items) {
+        mBinding.control.action.episodes.setVisibility(items.size() < 2 ? View.GONE : View.VISIBLE);
         mBinding.control.nextRoot.setVisibility(items.size() < 2 ? View.GONE : View.VISIBLE);
         mBinding.control.prevRoot.setVisibility(items.size() < 2 ? View.GONE : View.VISIBLE);
         mBinding.episode.setVisibility(items.isEmpty() ? View.GONE : View.VISIBLE);

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/HistoryPresenter.java
Patch:
@@ -64,11 +64,11 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         ViewHolder holder = (ViewHolder) viewHolder;
         setClickListener(holder.view, item);
         holder.binding.name.setText(item.getVodName());
-        holder.binding.site.setVisibility(View.VISIBLE);
-        holder.binding.site.setText(ApiConfig.getSiteName(item.getSiteKey()));
-        holder.binding.remark.setText(ResUtil.getString(R.string.vod_last, item.getVodRemarks()));
+        holder.binding.site.setText(item.getSiteName());
+        holder.binding.site.setVisibility(item.getSiteVisible());
         holder.binding.remark.setVisibility(delete ? View.GONE : View.VISIBLE);
         holder.binding.delete.setVisibility(!delete ? View.GONE : View.VISIBLE);
+        holder.binding.remark.setText(ResUtil.getString(R.string.vod_last, item.getVodRemarks()));
         ImgUtil.loadHistory(item.getVodPic(), holder.binding.image);
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/HistoryAdapter.java
Patch:
@@ -90,11 +90,11 @@ public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
     public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
         History item = mItems.get(position);
         holder.binding.name.setText(item.getVodName());
-        holder.binding.site.setVisibility(View.VISIBLE);
-        holder.binding.site.setText(ApiConfig.getSiteName(item.getSiteKey()));
-        holder.binding.remark.setText(ResUtil.getString(R.string.vod_last, item.getVodRemarks()));
+        holder.binding.site.setText(item.getSiteName());
+        holder.binding.site.setVisibility(item.getSiteVisible());
         holder.binding.remark.setVisibility(delete ? View.GONE : View.VISIBLE);
         holder.binding.delete.setVisibility(!delete ? View.GONE : View.VISIBLE);
+        holder.binding.remark.setText(ResUtil.getString(R.string.vod_last, item.getVodRemarks()));
         ImgUtil.loadHistory(item.getVodPic(), holder.binding.image);
         setClickListener(holder.binding.getRoot(), item);
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -637,6 +637,7 @@ public void setPass(String pass) {
     @Override
     public void setLive(Live item) {
         LiveConfig.get().setHome(item);
+        mPlayers.stop();
         mHides.clear();
         hideControl();
         getLive();

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingFragment.java
Patch:
@@ -103,17 +103,17 @@ public void setConfig(Config config) {
     private void load(Config config) {
         switch (config.getType()) {
             case 0:
-                Notify.progress(getActivity(), true);
+                Notify.progress(getActivity());
                 mBinding.vodUrl.setText(config.getDesc());
                 ApiConfig.get().clear().config(config).load(getCallback(config));
                 break;
             case 1:
-                Notify.progress(getActivity(), true);
+                Notify.progress(getActivity());
                 mBinding.liveUrl.setText(config.getDesc());
                 LiveConfig.get().clear().config(config).load(getCallback(config));
                 break;
             case 2:
-                Notify.progress(getActivity(), true);
+                Notify.progress(getActivity());
                 mBinding.wallUrl.setText(config.getDesc());
                 WallConfig.get().clear().config(config).load(getCallback(config));
                 break;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SearchActivity.java
Patch:
@@ -71,6 +71,7 @@ public void afterTextChanged(Editable s) {
         mBinding.mic.setListener(this, new CustomTextListener() {
             @Override
             public void onEndOfSpeech() {
+                mBinding.keyword.requestFocus();
                 mBinding.mic.stop();
             }
 
@@ -126,7 +127,6 @@ public void onDataChanged(int size) {
 
     @Override
     public void onSearch() {
-        mBinding.mic.setFocusable(false);
         String keyword = mBinding.keyword.getText().toString().trim();
         mBinding.keyword.setSelection(mBinding.keyword.length());
         Utils.hideKeyboard(mBinding.keyword);
@@ -155,6 +155,5 @@ public void onRemote() {
     protected void onResume() {
         super.onResume();
         mBinding.keyword.requestFocus();
-        mBinding.mic.setFocusable(true);
     }
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -10,9 +10,9 @@
 
 import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.R;
+import com.fongmi.android.tv.Updater;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.api.LiveConfig;
-import com.fongmi.android.tv.api.Updater;
 import com.fongmi.android.tv.api.WallConfig;
 import com.fongmi.android.tv.databinding.ActivityMainBinding;
 import com.fongmi.android.tv.event.RefreshEvent;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingFragment.java
Patch:
@@ -12,9 +12,9 @@
 
 import com.fongmi.android.tv.BuildConfig;
 import com.fongmi.android.tv.R;
+import com.fongmi.android.tv.Updater;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.api.LiveConfig;
-import com.fongmi.android.tv.api.Updater;
 import com.fongmi.android.tv.api.WallConfig;
 import com.fongmi.android.tv.bean.Config;
 import com.fongmi.android.tv.bean.Live;
@@ -26,11 +26,11 @@
 import com.fongmi.android.tv.impl.SiteCallback;
 import com.fongmi.android.tv.net.Callback;
 import com.fongmi.android.tv.ui.base.BaseFragment;
+import com.fongmi.android.tv.ui.custom.FileChooser;
 import com.fongmi.android.tv.ui.custom.dialog.ConfigDialog;
 import com.fongmi.android.tv.ui.custom.dialog.HistoryDialog;
 import com.fongmi.android.tv.ui.custom.dialog.LiveDialog;
 import com.fongmi.android.tv.ui.custom.dialog.SiteDialog;
-import com.fongmi.android.tv.ui.custom.FileChooser;
 import com.fongmi.android.tv.utils.FileUtil;
 import com.fongmi.android.tv.utils.Notify;
 import com.fongmi.android.tv.utils.Prefers;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -128,7 +128,7 @@ private void setAdapter(Result result) {
     }
 
     private void checkPage(int count) {
-        if (count == 0 || mAdapter.getItemCount() >= 40 || isFolder()) return;
+        if (count == 0 || mAdapter.getItemCount() >= 40 || isFolder() || isHome()) return;
         getVideo(getTypeId(), String.valueOf(mScroller.addPage()));
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -158,13 +158,13 @@ private void setAdapter(Result result) {
     private void setFabVisible(int position) {
         if (position == 0) {
             mBinding.link.show();
-            mBinding.filter.hide();
+            mBinding.filter.setVisibility(View.GONE);
         } else if (mAdapter.get(position).getFilters().size() > 0) {
+            mBinding.link.setVisibility(View.GONE);
             mBinding.filter.show();
-            mBinding.link.hide();
         } else {
-            mBinding.filter.setVisibility(View.GONE);
             mBinding.link.setVisibility(View.GONE);
+            mBinding.filter.setVisibility(View.GONE);
         }
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -268,7 +268,7 @@ public PageAdapter(@NonNull FragmentManager fm) {
         @Override
         public Fragment getItem(int position) {
             Class type = mAdapter.get(position);
-            return type.isHome() ? TypeFragment.newInstance(result.getList()) : TypeFragment.newInstance(type.getTypeId(), type.getTypeFlag().equals("1"));
+            return type.isHome() ? TypeFragment.newInstance(Result.list(result.getList())) : TypeFragment.newInstance(type.getTypeId(), type.getTypeFlag().equals("1"));
         }
 
         @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -212,13 +212,13 @@ private void homeContent() {
         setFabVisible(0);
         mAdapter.clear();
         mViewModel.homeContent();
-        Notify.progress(getActivity());
         mBinding.pager.setAdapter(new PageAdapter(getChildFragmentManager()));
     }
 
     @Override
     public void setSite(Site item) {
         ApiConfig.get().setHome(item);
+        Notify.progress(getActivity());
         homeContent();
     }
 
@@ -268,7 +268,7 @@ public PageAdapter(@NonNull FragmentManager fm) {
         @Override
         public Fragment getItem(int position) {
             Class type = mAdapter.get(position);
-            return type.getTypeId().equals("home") ? TypeFragment.newInstance(Result.list(result.getList())) : TypeFragment.newInstance(type.getTypeId(), type.getTypeFlag().equals("1"));
+            return type.isHome() ? TypeFragment.newInstance(result.getList()) : TypeFragment.newInstance(type.getTypeId(), type.getTypeFlag().equals("1"));
         }
 
         @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -88,7 +88,6 @@ private Callback getCallback() {
             public void success() {
                 checkAction(getIntent());
                 RefreshEvent.video();
-                Notify.dismiss();
             }
 
             @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/TypeAdapter.java
Patch:
@@ -43,9 +43,9 @@ public void clear() {
     }
 
     public void addAll(Result result) {
-        if (result.getList().size() > 0) mItems.add(home());
         mItems.addAll(result.getTypes());
-        mItems.get(0).setActivated(true);
+        if (mItems.size() > 0) mItems.add(0, home());
+        if (mItems.size() > 0) mItems.get(0).setActivated(true);
         notifyDataSetChanged();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/TypeFragment.java
Patch:
@@ -82,6 +82,7 @@ protected void initView() {
         mTypeIds = new ArrayList<>();
         mExtends = new HashMap<>();
         mScroller = new CustomScroller(this);
+        mBinding.swipeLayout.setEnabled(!isHome());
         setRecyclerView();
         setViewModel();
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -331,6 +331,7 @@ private void getPlayer(Vod.Flag flag, Vod.Flag.Episode episode, boolean replay)
         mViewModel.playerContent(getKey(), flag.getFlag(), episode.getUrl());
         updateHistory(episode, replay);
         showProgress();
+        hideCenter();
     }
 
     private void setEmpty() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SearchActivity.java
Patch:
@@ -126,6 +126,7 @@ public void onDataChanged(int size) {
 
     @Override
     public void onSearch() {
+        mBinding.mic.setFocusable(false);
         String keyword = mBinding.keyword.getText().toString().trim();
         mBinding.keyword.setSelection(mBinding.keyword.length());
         Utils.hideKeyboard(mBinding.keyword);
@@ -154,5 +155,6 @@ public void onRemote() {
     protected void onResume() {
         super.onResume();
         mBinding.keyword.requestFocus();
+        mBinding.mic.setFocusable(true);
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -122,7 +122,7 @@ private void onChildSelected(@Nullable RecyclerView.ViewHolder child) {
         if (child == null) return;
         mOldView = child.itemView;
         mOldView.setActivated(true);
-        App.post(mRunnable, 200);
+        App.post(mRunnable, 50);
     }
 
     private final Runnable mRunnable = new Runnable() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -3,6 +3,7 @@
 import android.annotation.SuppressLint;
 import android.os.Bundle;
 import android.view.LayoutInflater;
+import android.view.View;
 import android.view.ViewGroup;
 
 import androidx.annotation.NonNull;
@@ -85,7 +86,7 @@ protected void initView() {
         mTypeIds = new ArrayList<>();
         mExtends = new HashMap<>();
         mFilters = Filter.arrayFrom(getFilter());
-        mBinding.progressLayout.showProgress();
+        mBinding.progress.getRoot().setVisibility(View.VISIBLE);
         setRecyclerView();
         setViewModel();
     }
@@ -110,7 +111,7 @@ private void setViewModel() {
         mViewModel = new ViewModelProvider(this).get(SiteViewModel.class);
         mViewModel.result.observe(getViewLifecycleOwner(), result -> {
             int size = result.getList().size();
-            mBinding.progressLayout.showContent(isFolder(), size);
+            mBinding.progress.getRoot().setVisibility(View.GONE);
             mScroller.endLoading(size == 0);
             addVideo(result.getList());
             checkPage(size);

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/FileChooser.java
Patch:
@@ -1,4 +1,4 @@
-package com.fongmi.android.tv.utils;
+package com.fongmi.android.tv.ui.custom;
 
 import android.content.Context;
 import android.content.Intent;

File: app/src/main/java/com/fongmi/android/tv/bean/Parse.java
Patch:
@@ -4,7 +4,9 @@
 
 import androidx.annotation.NonNull;
 
+import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.utils.Json;
+import com.fongmi.android.tv.utils.ResUtil;
 import com.fongmi.android.tv.utils.Utils;
 import com.google.gson.Gson;
 import com.google.gson.JsonElement;
@@ -55,7 +57,7 @@ public static Parse get(Integer type, String url, JsonElement header) {
 
     public static Parse god() {
         Parse parse = new Parse();
-        parse.setName("超級解析");
+        parse.setName(ResUtil.getString(R.string.parse_god));
         parse.setType(4);
         return parse;
     }

File: app/src/main/java/com/fongmi/android/tv/bean/Depot.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.text.TextUtils;
 
+import com.fongmi.android.tv.utils.Utils;
 import com.google.gson.Gson;
 import com.google.gson.annotations.SerializedName;
 import com.google.gson.reflect.TypeToken;
@@ -24,7 +25,7 @@ public static List<Depot> arrayFrom(String str) {
     }
 
     public String getUrl() {
-        return TextUtils.isEmpty(url) ? "" : url;
+        return TextUtils.isEmpty(url) ? "" : Utils.checkClan(url);
     }
 
     public String getName() {

File: app/src/main/java/com/fongmi/android/tv/api/WallConfig.java
Patch:
@@ -3,13 +3,13 @@
 import android.graphics.drawable.Drawable;
 
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.bean.Config;
 import com.fongmi.android.tv.event.RefreshEvent;
 import com.fongmi.android.tv.net.Callback;
 import com.fongmi.android.tv.net.OkHttp;
 import com.fongmi.android.tv.utils.FileUtil;
-import com.fongmi.android.tv.utils.ImgUtil;
 import com.fongmi.android.tv.utils.Prefers;
 
 import java.io.File;
@@ -84,7 +84,7 @@ private void loadConfig(Callback callback) {
 
     private File write(File file) throws IOException {
         if (url.startsWith("file")) FileUtil.copy(FileUtil.getLocal(url), file);
-        else if (url.startsWith("http")) FileUtil.write(file, ImgUtil.resize(OkHttp.newCall(url).execute().body().bytes()));
+        else if (url.startsWith("http")) FileUtil.write(file, Product.resize(OkHttp.newCall(url).execute().body().bytes()));
         else file.delete();
         return file;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SearchActivity.java
Patch:
@@ -22,7 +22,7 @@
 import com.fongmi.android.tv.ui.adapter.WordAdapter;
 import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.custom.CustomKeyboard;
-import com.fongmi.android.tv.ui.custom.CustomListener;
+import com.fongmi.android.tv.ui.custom.CustomTextListener;
 import com.fongmi.android.tv.ui.custom.SpaceItemDecoration;
 import com.fongmi.android.tv.ui.custom.dialog.SiteDialog;
 import com.fongmi.android.tv.utils.Utils;
@@ -61,14 +61,14 @@ protected void initEvent() {
             if (actionId == EditorInfo.IME_ACTION_DONE) onSearch();
             return true;
         });
-        mBinding.keyword.addTextChangedListener(new CustomListener() {
+        mBinding.keyword.addTextChangedListener(new CustomTextListener() {
             @Override
             public void afterTextChanged(Editable s) {
                 if (s.toString().isEmpty()) getHot();
                 else getSuggest(s.toString());
             }
         });
-        mBinding.mic.setListener(this, new CustomListener() {
+        mBinding.mic.setListener(this, new CustomTextListener() {
             @Override
             public void onEndOfSpeech() {
                 mBinding.mic.stop();

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomMic.java
Patch:
@@ -51,7 +51,7 @@ private void setListen(boolean listen) {
         this.listen = listen;
     }
 
-    public void setListener(FragmentActivity activity, CustomListener listener) {
+    public void setListener(FragmentActivity activity, CustomTextListener listener) {
         this.recognizer.setRecognitionListener(listener);
         this.activity = activity;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomTextListener.java
Patch:
@@ -8,7 +8,7 @@
 
 import java.util.List;
 
-public abstract class CustomListener implements TextWatcher, RecognitionListener {
+public abstract class CustomTextListener implements TextWatcher, RecognitionListener {
 
     @Override
     public void onReadyForSpeech(Bundle params) {

File: app/src/main/java/com/fongmi/android/tv/utils/Utils.java
Patch:
@@ -81,7 +81,7 @@ public static void hideSystemUI(Window window) {
         window.getDecorView().setSystemUiVisibility(flags);
     }
 
-    public static boolean hasPIP() {
+    public static boolean hasPiP() {
         return Build.VERSION.SDK_INT >= Build.VERSION_CODES.O && App.get().getPackageManager().hasSystemFeature(PackageManager.FEATURE_PICTURE_IN_PICTURE);
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/TypeFragment.java
Patch:
@@ -84,7 +84,7 @@ protected void initData() {
     private void setRecyclerView() {
         mBinding.recycler.setHasFixedSize(true);
         mBinding.recycler.setAdapter(mAdapter = new VodAdapter(this));
-        mBinding.recycler.setPadding(ResUtil.dp2px(isFolder() ? 0 : 8), ResUtil.dp2px(isFolder() ? 4 : 8), ResUtil.dp2px(isFolder() ? 0 : 8), ResUtil.dp2px(isFolder() ? 0 : 8));
+        mBinding.recycler.setPadding(ResUtil.dp2px(isFolder() ? 0 : 8), ResUtil.dp2px(isFolder() ? 12 : 8), ResUtil.dp2px(isFolder() ? 0 : 8), ResUtil.dp2px(isFolder() ? 0 : 8));
         mBinding.recycler.setLayoutManager(isFolder() ? new LinearLayoutManager(getActivity()) : new GridLayoutManager(getContext(), Product.getColumn()));
         mAdapter.setViewType(isFolder() ? ViewType.FOLDER : ViewType.GRID);
         mAdapter.setSize(Product.getSpec(getActivity()));

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -543,7 +543,7 @@ private void createPlayer() {
         mIjkPlayer.setOption(player, "soundtouch", 1);
         mIjkPlayer.setOption(player, "start-on-prepared", 1);
         mIjkPlayer.setOption(player, "subtitle", 1);
-        mIjkPlayer.setOption(format, "protocol_whitelist", "async,cache,crypto,file,http,https,ijkhttphook,ijkinject,ijklivehook,ijklongurl,ijksegment,ijktcphook,pipe,rtp,tcp,tls,udp,ijkurlhook,data");
+        mIjkPlayer.setOption(format, "protocol_whitelist", "async,cache,crypto,file,http,https,ijkhttphook,ijkinject,ijklivehook,ijklongurl,ijksegment,ijktcphook,pipe,rtmp,rtp,tcp,tls,udp,ijkurlhook,data");
         if (url.contains("rtsp") || url.contains("udp") || url.contains("rtp")) {
             mIjkPlayer.setOption(format, "infbuf", 1);
             mIjkPlayer.setOption(format, "rtsp_transport", "tcp");

File: app/src/main/java/com/fongmi/android/tv/utils/Prefers.java
Patch:
@@ -5,7 +5,6 @@
 import androidx.preference.PreferenceManager;
 
 import com.fongmi.android.tv.App;
-import com.fongmi.android.tv.ui.custom.ViewType;
 
 public class Prefers {
 
@@ -141,7 +140,7 @@ public static void putHot(String hot) {
     }
 
     public static int getViewType() {
-        return getInt("viewType", ViewType.GRID);
+        return getInt("viewType");
     }
 
     public static void putViewType(int viewType) {

File: app/src/main/java/com/fongmi/android/tv/bean/Vod.java
Patch:
@@ -104,7 +104,7 @@ public String getVodPic() {
     }
 
     public String getVodRemarks() {
-        return TextUtils.isEmpty(vodRemarks) ? "" : vodRemarks;
+        return TextUtils.isEmpty(vodRemarks) ? "" : vodRemarks.trim();
     }
 
     public String getVodYear() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/ViewType.java
Patch:
@@ -4,4 +4,5 @@ public class ViewType {
 
     public static final int GRID = 0;
     public static final int LIST = 1;
+    public static final int FOLDER = 2;
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/SearchPresenter.java
Patch:
@@ -21,7 +21,7 @@ public SearchPresenter(OnClickListener listener) {
     }
 
     private void setLayoutSize() {
-        int space = ResUtil.dp2px(24) + ResUtil.dp2px(8 * 5);
+        int space = ResUtil.dp2px(48) + ResUtil.dp2px(8 * 4);
         int base = ResUtil.getScreenWidth() - space;
         width = base / 5;
     }

File: app/src/main/java/com/fongmi/android/tv/bean/Site.java
Patch:
@@ -101,7 +101,7 @@ public void setApi(String api) {
     }
 
     public String getPlayUrl() {
-        return playUrl;
+        return TextUtils.isEmpty(playUrl) ? "" : playUrl;
     }
 
     public int getPlayerType() {

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -160,7 +160,7 @@ public void playerContent(String key, String flag, String id) {
                 result.setUrl(url);
                 result.setFlag(flag);
                 result.setPlayUrl(site.getPlayUrl());
-                result.setParse(Utils.isVideoFormat(url) ? 0 : 1);
+                result.setParse(Utils.isVideoFormat(url) && result.getPlayUrl().isEmpty() ? 0 : 1);
                 return result;
             }
         });

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/EpisodeFragment.java
Patch:
@@ -61,9 +61,9 @@ private void setViewModel() {
     }
 
     private void setEpisode() {
-        List<Vod.Flag.Episode> items = Vod.Flag.Episode.arrayFrom(getJson());
-        mBinding.recycler.setLayoutManager(new GridLayoutManager(getContext(), getSpan(items)));
-        mAdapter.addAll(items);
+        mAdapter.addAll(Vod.Flag.Episode.arrayFrom(getJson()));
+        mBinding.recycler.setLayoutManager(new GridLayoutManager(getContext(), getSpan(mAdapter.getItems())));
+        mBinding.recycler.scrollToPosition(mAdapter.getPosition());
     }
 
     private int getSpan(List<Vod.Flag.Episode> items) {

File: app/src/main/java/com/fongmi/android/tv/Constant.java
Patch:
@@ -4,7 +4,7 @@ public class Constant {
     //快進時間單位
     public static final int INTERVAL_SEEK = 10 * 1000;
     //控件隱藏時間
-    public static final int INTERVAL_HIDE = 3 * 1000;
+    public static final int INTERVAL_HIDE = 5 * 1000;
     //網路偵測間隔
     public static final int INTERVAL_TRAFFIC = 500;
     //點播爬蟲時間

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -429,7 +429,7 @@ private void setArray(int size) {
         mEpisodePresenter.setNextFocusDown(size > 1 ? R.id.array : R.id.part);
         mPartPresenter.setNextFocusUp(size > 1 ? R.id.array : R.id.episode);
         mBinding.array.setVisibility(size > 1 ? View.VISIBLE : View.GONE);
-        if (mHistory.isRevSort()) for (int i = size + 1; i > 0; i -= 20) items.add((i - 1) + "-" + Math.max(i - 20, 1));
+        if (mHistory.isRevSort()) for (int i = size; i > 0; i -= 20) items.add(i + "-" + Math.max(i - 19, 1));
         else for (int i = 0; i < size; i += 20) items.add((i + 1) + "-" + Math.min(i + 20, size));
         mArrayAdapter.setItems(items, null);
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -93,14 +93,14 @@ private void setRecyclerView() {
 
     private void setFabVisible(int position) {
         if (position == 0) {
-            mBinding.filter.hide();
             mBinding.link.show();
+            mBinding.filter.hide();
         } else if (mAdapter.get(position).getFilters().size() > 0) {
             mBinding.filter.show();
             mBinding.link.hide();
         } else {
-            mBinding.filter.hide();
-            mBinding.link.hide();
+            mBinding.filter.setVisibility(View.GONE);
+            mBinding.link.setVisibility(View.GONE);
         }
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/Product.java
Patch:
@@ -2,6 +2,7 @@
 
 import com.fongmi.android.tv.ui.activity.LiveActivity;
 import com.fongmi.android.tv.utils.Prefers;
+import com.fongmi.android.tv.utils.ResUtil;
 
 public class Product {
 
@@ -14,6 +15,6 @@ public static void bootLive() {
     }
 
     public static int getEms() {
-        return Math.min(getScreenWidth() / sp2px(24), 35);
+        return Math.min(ResUtil.getScreenWidth() / ResUtil.sp2px(24), 35);
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/EpisodePresenter.java
Patch:
@@ -6,9 +6,9 @@
 import androidx.annotation.NonNull;
 import androidx.leanback.widget.Presenter;
 
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.AdapterEpisodeBinding;
-import com.fongmi.android.tv.utils.ResUtil;
 
 public class EpisodePresenter extends Presenter {
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/PartPresenter.java
Patch:
@@ -6,8 +6,8 @@
 import androidx.annotation.NonNull;
 import androidx.leanback.widget.Presenter;
 
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.databinding.AdapterPartBinding;
-import com.fongmi.android.tv.utils.ResUtil;
 
 public class PartPresenter extends Presenter {
 

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -147,7 +147,7 @@ public long getBuffered() {
     }
 
     public boolean isPlaying() {
-        return isExo() ? exoPlayer.isPlaying() : ijkPlayer.isPlaying();
+        return isExo() ? exoPlayer != null && exoPlayer.isPlaying() : ijkPlayer != null && ijkPlayer.isPlaying();
     }
 
     public String getSizeText() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -127,7 +127,7 @@ private void setRecyclerView() {
         mBinding.recordRecycler.setHasFixedSize(true);
         mBinding.recordRecycler.setLayoutManager(new GridLayoutManager(this, 2));
         mBinding.recordRecycler.setAdapter(mRecordAdapter = new RecordAdapter(this));
-        mVodAdapter.setSize(Product.getSpec(ResUtil.dp2px(64), 3));
+        mVodAdapter.setSize(Product.getSpec(this, ResUtil.dp2px(64), 3));
     }
 
     private void setLayoutSize() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/HomeFragment.java
Patch:
@@ -78,8 +78,8 @@ private void setRecyclerView() {
         mBinding.recommend.setHasFixedSize(true);
         mBinding.recommend.setLayoutManager(new GridLayoutManager(getContext(), Product.getColumn()));
         mBinding.recommend.setAdapter(mVodAdapter = new VodAdapter(this));
-        mHistoryAdapter.setSize(Product.getSpec());
-        mVodAdapter.setSize(Product.getSpec());
+        mHistoryAdapter.setSize(Product.getSpec(getActivity()));
+        mVodAdapter.setSize(Product.getSpec(getActivity()));
     }
 
     private void setViewModel() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/TypeFragment.java
Patch:
@@ -93,7 +93,7 @@ private void setRecyclerView() {
         mBinding.recycler.setHasFixedSize(true);
         mBinding.recycler.setAdapter(mVodAdapter = new VodAdapter(this));
         mBinding.recycler.setLayoutManager(new GridLayoutManager(getContext(), Product.getColumn()));
-        mVodAdapter.setSize(Product.getSpec());
+        mVodAdapter.setSize(Product.getSpec(getActivity()));
     }
 
     private void setViewModel() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/EpisodePresenter.java
Patch:
@@ -37,7 +37,7 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         Vod.Flag.Episode item = (Vod.Flag.Episode) object;
         ViewHolder holder = (ViewHolder) viewHolder;
         holder.binding.text.setText(item.getName());
-        holder.binding.text.setMaxEms(ResUtil.getEms());
+        holder.binding.text.setMaxEms(Product.getEms());
         holder.binding.text.setNextFocusDownId(nextFocus);
         holder.binding.text.setActivated(item.isActivated());
         setOnClickListener(holder, view -> mListener.onItemClick(item));

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/PartPresenter.java
Patch:
@@ -36,7 +36,7 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         String text = object.toString();
         ViewHolder holder = (ViewHolder) viewHolder;
         holder.binding.text.setText(text);
-        holder.binding.text.setMaxEms(ResUtil.getEms());
+        holder.binding.text.setMaxEms(Product.getEms());
         holder.binding.text.setNextFocusUpId(nextFocus);
         setOnClickListener(holder, view -> mListener.onItemClick(text));
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/EpisodeAdapter.java
Patch:
@@ -70,7 +70,7 @@ public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
     public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
         Vod.Flag.Episode item = mItems.get(position);
         holder.binding.text.setText(item.getName());
-        //holder.binding.text.setMaxEms(ResUtil.getEms());
+        holder.binding.text.setSelected(item.isActivated());
         holder.binding.text.setActivated(item.isActivated());
         holder.binding.text.setOnClickListener(v -> mListener.onItemClick(item));
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -263,7 +263,7 @@ public boolean onLongClick() {
 
     @Override
     public void showDialog() {
-        SiteDialog.create(this).filter(true).show();
+        SiteDialog.create(this).filter().show();
     }
 
     @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SearchActivity.java
Patch:
@@ -142,7 +142,7 @@ public boolean dispatchKeyEvent(KeyEvent event) {
 
     @Override
     public void showDialog() {
-        SiteDialog.create(this).search(true).show();
+        SiteDialog.create(this).search().show();
     }
 
     @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -100,7 +100,7 @@ protected void initView(Bundle savedInstanceState) {
     @Override
     protected void initEvent() {
         mBinding.view.setOnClickListener(this::switchView);
-        mBinding.site.setOnClickListener(v -> SiteDialog.create(this).search(true).show());
+        mBinding.site.setOnClickListener(v -> SiteDialog.create(this).search().show());
         mBinding.keyword.setOnEditorActionListener((textView, actionId, event) -> {
             if (actionId == EditorInfo.IME_ACTION_DONE) search();
             return true;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -100,7 +100,7 @@ private void setFabVisible(boolean filter) {
     }
 
     private void onTitle(View view) {
-        SiteDialog.create(this).show();
+        SiteDialog.create(this).change().show();
     }
 
     private void onLink(View view) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/SiteAdapter.java
Patch:
@@ -62,9 +62,9 @@ public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
     @Override
     public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
         Site item = mItems.get(position);
-        holder.binding.text.setEnabled(!search);
-        holder.binding.text.setFocusable(!search);
         holder.binding.text.setText(item.getName());
+        holder.binding.text.setEnabled(!search || change);
+        holder.binding.text.setFocusable(!search || change);
         holder.binding.text.setActivated(item.isActivated());
         holder.binding.search.setActivated(item.isActivated());
         holder.binding.search.setImageResource(item.getSearchIcon());

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -129,6 +129,7 @@ public void onRefreshEvent(RefreshEvent event) {
 
     private void homeContent() {
         mAdapter.clear();
+        setFabVisible(false);
         mBinding.pager.setAdapter(new PageAdapter(getChildFragmentManager()));
         mBinding.title.setText(getSite().getName().isEmpty() ? getString(R.string.app_name) : getSite().getName());
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/TypeFragment.java
Patch:
@@ -143,8 +143,7 @@ public void setFilter(String key, String value) {
 
     @Override
     public void onItemClick(Vod item) {
-        if (item.shouldSearch()) onLongClick(item);
-        else if (item.isFolder()) getVideo(item.getVodId(), "1");
+        if (item.isFolder()) getVideo(item.getVodId(), "1");
         else DetailActivity.start(getActivity(), item.getVodId(), item.getVodName());
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -168,9 +168,7 @@ private void search() {
         mBinding.view.setVisibility(View.VISIBLE);
         mBinding.result.setVisibility(View.VISIBLE);
         if (mExecutor != null) mExecutor.shutdownNow();
-        int core = Runtime.getRuntime().availableProcessors();
-        int corePoolSize = Math.max(Constant.THREAD_POOL, core);
-        mExecutor = new PauseThreadPoolExecutor(corePoolSize, corePoolSize, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>());
+        mExecutor = new PauseThreadPoolExecutor(Constant.THREAD_POOL, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>());
         String keyword = mBinding.keyword.getText().toString().trim();
         for (Site site : mSites) mExecutor.execute(() -> search(site, keyword));
         App.post(() -> mRecordAdapter.add(keyword), 250);

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/HomeFragment.java
Patch:
@@ -111,8 +111,7 @@ public void onRefresh() {
 
     @Override
     public void onItemClick(Vod item) {
-        if (item.shouldSearch()) onLongClick(item);
-        else DetailActivity.start(getActivity(), item.getVodId(), item.getVodName());
+        DetailActivity.start(getActivity(), item.getVodId(), item.getVodName());
     }
 
     @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.app.Activity;
 import android.content.Intent;
+import android.os.Bundle;
 import android.text.Editable;
 import android.text.TextUtils;
 import android.view.View;
@@ -32,6 +33,7 @@
 import com.fongmi.android.tv.ui.adapter.RecordAdapter;
 import com.fongmi.android.tv.ui.adapter.VodAdapter;
 import com.fongmi.android.tv.ui.adapter.WordAdapter;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.custom.CustomListener;
 import com.fongmi.android.tv.ui.custom.ViewType;
 import com.fongmi.android.tv.ui.custom.dialog.SiteDialog;
@@ -84,7 +86,7 @@ protected ViewBinding getBinding() {
     }
 
     @Override
-    protected void initView() {
+    protected void initView(Bundle savedInstanceState) {
         mSites = new ArrayList<>();
         setRecyclerView();
         setLayoutSize();

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -6,6 +6,7 @@
 import android.content.pm.ActivityInfo;
 import android.content.res.Configuration;
 import android.graphics.Rect;
+import android.os.Bundle;
 import android.text.Html;
 import android.text.Layout;
 import android.util.Rational;
@@ -45,6 +46,7 @@
 import com.fongmi.android.tv.ui.adapter.EpisodeAdapter;
 import com.fongmi.android.tv.ui.adapter.FlagAdapter;
 import com.fongmi.android.tv.ui.adapter.ParseAdapter;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.custom.CustomKeyDownVod;
 import com.fongmi.android.tv.ui.custom.SpaceItemDecoration;
 import com.fongmi.android.tv.ui.custom.dialog.TrackDialog;
@@ -184,7 +186,7 @@ protected void onNewIntent(Intent intent) {
     }
 
     @Override
-    protected void initView() {
+    protected void initView(Bundle savedInstanceState) {
         mKeyDown = CustomKeyDownVod.create(this);
         mFrameParams = mBinding.video.getLayoutParams();
         mPlayers = new Players().init();

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/FragmentStateManager.java
Patch:
@@ -6,7 +6,7 @@
 import androidx.fragment.app.FragmentManager;
 import androidx.fragment.app.FragmentTransaction;
 
-import com.fongmi.android.tv.ui.activity.BaseFragment;
+import com.fongmi.android.tv.ui.base.BaseFragment;
 
 public abstract class FragmentStateManager {
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingFragment.java
Patch:
@@ -23,7 +23,7 @@
 import com.fongmi.android.tv.impl.LiveCallback;
 import com.fongmi.android.tv.impl.SiteCallback;
 import com.fongmi.android.tv.net.Callback;
-import com.fongmi.android.tv.ui.activity.BaseFragment;
+import com.fongmi.android.tv.ui.base.BaseFragment;
 import com.fongmi.android.tv.ui.custom.dialog.ConfigDialog;
 import com.fongmi.android.tv.ui.custom.dialog.HistoryDialog;
 import com.fongmi.android.tv.ui.custom.dialog.LiveDialog;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -21,9 +21,9 @@
 import com.fongmi.android.tv.event.RefreshEvent;
 import com.fongmi.android.tv.impl.FilterCallback;
 import com.fongmi.android.tv.impl.SiteCallback;
-import com.fongmi.android.tv.ui.activity.BaseFragment;
 import com.fongmi.android.tv.ui.activity.CollectActivity;
 import com.fongmi.android.tv.ui.adapter.TypeAdapter;
+import com.fongmi.android.tv.ui.base.BaseFragment;
 import com.fongmi.android.tv.ui.custom.dialog.FilterDialog;
 import com.fongmi.android.tv.ui.custom.dialog.LinkDialog;
 import com.fongmi.android.tv.ui.custom.dialog.SiteDialog;
@@ -170,6 +170,7 @@ public void toggleFilter(int dy) {
 
     public void setAdapter(Result result) {
         try {
+            if (mAdapter.hasType()) return;
             result.setTypes(getTypes(result));
             mAdapter.addAll(result.getTypes());
             for (Class item : mAdapter.getTypes()) if (result.getFilters().containsKey(item.getTypeId())) item.setFilters(result.getFilters().get(item.getTypeId()));

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/HomeFragment.java
Patch:
@@ -21,11 +21,11 @@
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.FragmentHomeBinding;
 import com.fongmi.android.tv.model.SiteViewModel;
-import com.fongmi.android.tv.ui.activity.BaseFragment;
 import com.fongmi.android.tv.ui.activity.CollectActivity;
 import com.fongmi.android.tv.ui.activity.DetailActivity;
 import com.fongmi.android.tv.ui.adapter.HistoryAdapter;
 import com.fongmi.android.tv.ui.adapter.VodAdapter;
+import com.fongmi.android.tv.ui.base.BaseFragment;
 import com.fongmi.android.tv.ui.fragment.VodFragment;
 
 public class HomeFragment extends BaseFragment implements VodAdapter.OnClickListener, HistoryAdapter.OnClickListener, SwipeRefreshLayout.OnRefreshListener {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/TypeFragment.java
Patch:
@@ -16,10 +16,10 @@
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.FragmentTypeBinding;
 import com.fongmi.android.tv.model.SiteViewModel;
-import com.fongmi.android.tv.ui.activity.BaseFragment;
 import com.fongmi.android.tv.ui.activity.CollectActivity;
 import com.fongmi.android.tv.ui.activity.DetailActivity;
 import com.fongmi.android.tv.ui.adapter.VodAdapter;
+import com.fongmi.android.tv.ui.base.BaseFragment;
 import com.fongmi.android.tv.ui.custom.CustomScroller;
 import com.fongmi.android.tv.ui.fragment.VodFragment;
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -41,6 +41,7 @@
 import com.fongmi.android.tv.net.OkHttp;
 import com.fongmi.android.tv.player.ExoUtil;
 import com.fongmi.android.tv.player.Players;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.custom.CustomKeyDownVod;
 import com.fongmi.android.tv.ui.custom.dialog.DescDialog;
 import com.fongmi.android.tv.ui.custom.dialog.TrackDialog;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -31,6 +31,7 @@
 import com.fongmi.android.tv.model.SiteViewModel;
 import com.fongmi.android.tv.net.Callback;
 import com.fongmi.android.tv.server.Server;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.custom.CustomRowPresenter;
 import com.fongmi.android.tv.ui.custom.CustomSelector;
 import com.fongmi.android.tv.ui.custom.CustomTitleView;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/KeepActivity.java
Patch:
@@ -14,6 +14,7 @@
 import com.fongmi.android.tv.event.RefreshEvent;
 import com.fongmi.android.tv.net.Callback;
 import com.fongmi.android.tv.ui.adapter.KeepAdapter;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.custom.SpaceItemDecoration;
 
 import org.greenrobot.eventbus.Subscribe;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -36,6 +36,7 @@
 import com.fongmi.android.tv.player.source.Force;
 import com.fongmi.android.tv.player.source.TVBus;
 import com.fongmi.android.tv.player.source.ZLive;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.custom.CustomKeyDownLive;
 import com.fongmi.android.tv.ui.custom.CustomLiveListView;
 import com.fongmi.android.tv.ui.custom.dialog.LiveDialog;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/PushActivity.java
Patch:
@@ -10,6 +10,7 @@
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.databinding.ActivityPushBinding;
 import com.fongmi.android.tv.server.Server;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.utils.QRCode;
 import com.fongmi.android.tv.utils.ResUtil;
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SearchActivity.java
Patch:
@@ -20,6 +20,7 @@
 import com.fongmi.android.tv.net.OkHttp;
 import com.fongmi.android.tv.ui.adapter.RecordAdapter;
 import com.fongmi.android.tv.ui.adapter.WordAdapter;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.custom.CustomKeyboard;
 import com.fongmi.android.tv.ui.custom.CustomListener;
 import com.fongmi.android.tv.ui.custom.SpaceItemDecoration;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingActivity.java
Patch:
@@ -21,6 +21,7 @@
 import com.fongmi.android.tv.impl.LiveCallback;
 import com.fongmi.android.tv.impl.SiteCallback;
 import com.fongmi.android.tv.net.Callback;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.custom.dialog.ConfigDialog;
 import com.fongmi.android.tv.ui.custom.dialog.HistoryDialog;
 import com.fongmi.android.tv.ui.custom.dialog.LiveDialog;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -24,6 +24,7 @@
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.bean.Site;
 import com.fongmi.android.tv.databinding.ActivityVodBinding;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 import com.fongmi.android.tv.ui.fragment.VodFragment;
 import com.fongmi.android.tv.ui.presenter.TypePresenter;
 import com.fongmi.android.tv.utils.ResUtil;
@@ -159,7 +160,7 @@ private VodFragment getFragment() {
     class PageAdapter extends FragmentStatePagerAdapter {
 
         public PageAdapter(@NonNull FragmentManager fm) {
-            super(fm);
+            super(fm, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT);
         }
 
         @NonNull

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/CollectFragment.java
Patch:
@@ -16,9 +16,9 @@
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.FragmentVodBinding;
-import com.fongmi.android.tv.ui.activity.BaseFragment;
 import com.fongmi.android.tv.ui.activity.DetailActivity;
 import com.fongmi.android.tv.ui.activity.VodActivity;
+import com.fongmi.android.tv.ui.base.BaseFragment;
 import com.fongmi.android.tv.ui.custom.CustomRowPresenter;
 import com.fongmi.android.tv.ui.custom.CustomSelector;
 import com.fongmi.android.tv.ui.presenter.VodPresenter;

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -21,9 +21,9 @@
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.FragmentVodBinding;
 import com.fongmi.android.tv.model.SiteViewModel;
-import com.fongmi.android.tv.ui.activity.BaseFragment;
 import com.fongmi.android.tv.ui.activity.CollectActivity;
 import com.fongmi.android.tv.ui.activity.DetailActivity;
+import com.fongmi.android.tv.ui.base.BaseFragment;
 import com.fongmi.android.tv.ui.custom.CustomRowPresenter;
 import com.fongmi.android.tv.ui.custom.CustomScroller;
 import com.fongmi.android.tv.ui.custom.CustomSelector;

File: app/src/main/java/com/fongmi/android/tv/ui/activity/CrashActivity.java
Patch:
@@ -5,6 +5,7 @@
 
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.databinding.ActivityCrashBinding;
+import com.fongmi.android.tv.ui.base.BaseActivity;
 
 import java.util.Objects;
 

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -80,7 +80,7 @@ public static byte[] resize(byte[] bytes) {
         Matrix matrix = new Matrix();
         boolean land = bitmap.getWidth() > bitmap.getHeight();
         matrix.postScale((float) width / bitmap.getWidth(), (float) height / bitmap.getHeight());
-        bitmap = Bitmap.createBitmap(bitmap, land ? bitmap.getWidth() / 2 - bitmap.getHeight() / 2 : 0, 0, bitmap.getHeight(), bitmap.getHeight(), matrix, false);
+        bitmap = Bitmap.createBitmap(bitmap, land ? bitmap.getWidth() / 2 - bitmap.getHeight() / 2 : 0, 0, bitmap.getWidth(), bitmap.getHeight(), matrix, false);
         ByteArrayOutputStream baos = new ByteArrayOutputStream();
         bitmap.compress(Bitmap.CompressFormat.JPEG, 100, baos);
         return baos.toByteArray();

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -44,6 +44,7 @@
 import com.fongmi.android.tv.utils.Notify;
 import com.fongmi.android.tv.utils.ResUtil;
 import com.fongmi.android.tv.utils.Utils;
+import com.google.android.exoplayer2.util.Log;
 import com.google.common.collect.Lists;
 
 import org.greenrobot.eventbus.Subscribe;
@@ -315,6 +316,7 @@ public boolean dispatchKeyEvent(KeyEvent event) {
     @Override
     protected void onResume() {
         super.onResume();
+        Log.e("DDD", "DDD");
         Clock.start(mBinding.time, "MM/dd HH:mm:ss");
     }
 

File: app/src/main/java/com/fongmi/android/tv/utils/Clock.java
Patch:
@@ -28,6 +28,7 @@ public static Clock get() {
     public void init(String format) {
         this.formatter = new SimpleDateFormat(format, Locale.getDefault());
         this.date = new Date();
+        this.callback = null;
     }
 
     public static void stop() {

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomWebView.java
Patch:
@@ -88,6 +88,7 @@ private WebViewClient webViewClient() {
             public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceRequest request) {
                 String url = request.getUrl().toString();
                 String host = request.getUrl().getHost();
+                if (TextUtils.isEmpty(host)) return empty;
                 if (ApiConfig.get().getAds().contains(host)) return empty;
                 Map<String, String> headers = request.getRequestHeaders();
                 if (isVideoFormat(url, headers)) post(headers, url);

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/HomeFragment.java
Patch:
@@ -72,6 +72,8 @@ private void setRecyclerView() {
         mBinding.recommend.setHasFixedSize(true);
         mBinding.recommend.setLayoutManager(new GridLayoutManager(getContext(), Product.getColumn()));
         mBinding.recommend.setAdapter(mVodAdapter = new VodAdapter(this));
+        mHistoryAdapter.setSize(Product.getSpec(getActivity()));
+        mVodAdapter.setSize(Product.getSpec(getActivity()));
     }
 
     private void setViewModel() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/TypeFragment.java
Patch:
@@ -88,6 +88,7 @@ private void setRecyclerView() {
         mBinding.recycler.setHasFixedSize(true);
         mBinding.recycler.setAdapter(mVodAdapter = new VodAdapter(this));
         mBinding.recycler.setLayoutManager(new GridLayoutManager(getContext(), Product.getColumn()));
+        mVodAdapter.setSize(Product.getSpec(getActivity()));
     }
 
     private void setViewModel() {

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -78,8 +78,9 @@ public static byte[] resize(byte[] bytes) {
         Bitmap bitmap = BitmapFactory.decodeByteArray(bytes, 0, bytes.length);
         if (bitmap.getWidth() < width && bitmap.getHeight() < height) return bytes;
         Matrix matrix = new Matrix();
+        boolean land = bitmap.getWidth() > bitmap.getHeight();
         matrix.postScale((float) width / bitmap.getWidth(), (float) height / bitmap.getHeight());
-        bitmap = Bitmap.createBitmap(bitmap, 0, 0, bitmap.getWidth(), bitmap.getHeight(), matrix, false);
+        bitmap = Bitmap.createBitmap(bitmap, land ? bitmap.getWidth() / 2 - bitmap.getHeight() / 2 : 0, 0, bitmap.getHeight(), bitmap.getHeight(), matrix, false);
         ByteArrayOutputStream baos = new ByteArrayOutputStream();
         bitmap.compress(Bitmap.CompressFormat.JPEG, 100, baos);
         return baos.toByteArray();

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -178,6 +178,7 @@ public void setAdapter(Result result) {
 
     @Override
     public boolean canBack() {
+        if (mBinding.pager.getAdapter() == null) return true;
         return getFragment().canBack();
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/TypeFragment.java
Patch:
@@ -152,7 +152,7 @@ public boolean onLongClick(Vod item) {
 
     @Override
     public boolean canBack() {
-        if (mTypeIds.size() == 0) return true;
+        if (mTypeIds.size() < 2) return true;
         refresh(2);
         return false;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -322,7 +322,7 @@ private void onDecode() {
 
     private void onTrack(View view) {
         int type = Integer.parseInt(view.getTag().toString());
-        TrackDialog.create(this).player(mPlayers).type(type).show();
+        TrackDialog.create().player(mPlayers).type(type).show(getSupportFragmentManager(), null);
         hideControl();
     }
 
@@ -379,7 +379,7 @@ private void showEpg() {
     }
 
     private void hideCenter() {
-        mBinding.widget.action.setImageResource(R.drawable.ic_play);
+        mBinding.widget.action.setImageResource(R.drawable.ic_widget_play);
         mBinding.widget.center.setVisibility(View.GONE);
     }
 
@@ -549,7 +549,7 @@ public void onSeeking(int time) {
         if (!mPlayers.isVod() || !mChannel.isOnly()) return;
         mBinding.widget.exoDuration.setText(mPlayers.getDurationTime());
         mBinding.widget.exoPosition.setText(mPlayers.getPositionTime(time));
-        mBinding.widget.action.setImageResource(time > 0 ? R.drawable.ic_forward : R.drawable.ic_rewind);
+        mBinding.widget.action.setImageResource(time > 0 ? R.drawable.ic_widget_forward : R.drawable.ic_widget_rewind);
         mBinding.widget.center.setVisibility(View.VISIBLE);
         hideProgress();
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/adapter/KeyboardAdapter.java
Patch:
@@ -20,7 +20,7 @@ public class KeyboardAdapter extends RecyclerView.Adapter<RecyclerView.ViewHolde
     private final List<Object> mItems;
 
     public KeyboardAdapter(OnClickListener listener) {
-        this.mItems = Arrays.asList(R.drawable.ic_keyboard_remote, R.drawable.ic_keyboard_left, R.drawable.ic_keyboard_right, R.drawable.ic_keyboard_back, R.drawable.ic_keyboard_search, R.drawable.ic_search_on, "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9");
+        this.mItems = Arrays.asList(R.drawable.ic_keyboard_remote, R.drawable.ic_keyboard_left, R.drawable.ic_keyboard_right, R.drawable.ic_keyboard_back, R.drawable.ic_keyboard_search, R.drawable.ic_site_search_on, "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9");
         this.mListener = listener;
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomKeyboard.java
Patch:
@@ -42,7 +42,7 @@ public void onIconClick(int resId) {
         StringBuilder sb = new StringBuilder(binding.keyword.getText().toString());
         int cursor = binding.keyword.getSelectionStart();
         switch (resId) {
-            case R.drawable.ic_search_on:
+            case R.drawable.ic_site_search_on:
                 callback.showDialog();
                 break;
             case R.drawable.ic_keyboard_left:

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/TypePresenter.java
Patch:
@@ -43,7 +43,7 @@ public void onUnbindViewHolder(Presenter.ViewHolder viewHolder) {
     }
 
     private int getIcon(Class item) {
-        return item.getFilter() == null ? 0 : item.getFilter() ? R.drawable.ic_type_filter_off : R.drawable.ic_type_filter_on;
+        return item.getFilter() == null ? 0 : item.getFilter() ? R.drawable.ic_vod_filter_off : R.drawable.ic_vod_filter_on;
     }
 
     public static class ViewHolder extends Presenter.ViewHolder {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -125,6 +125,7 @@ private void search() {
         mVodAdapter.clear();
         mCollectAdapter.clear();
         Utils.hideKeyboard(mBinding.keyword);
+        if (mExecutor != null) mExecutor.shutdownNow();
         int core = Runtime.getRuntime().availableProcessors();
         int corePoolSize = Math.max(Constant.THREAD_POOL, core);
         mExecutor = new PauseThreadPoolExecutor(corePoolSize, corePoolSize, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>());

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/TypeFragment.java
Patch:
@@ -106,7 +106,7 @@ private void getVideo() {
     }
 
     private void checkPage() {
-        if (mScroller.getPage() != 1 || mVodAdapter.getItemCount() >= 4 || isFolder()) return;
+        if (mScroller.getPage() != 1 || mVodAdapter.getItemCount() >= 40 || isFolder()) return;
         if (mScroller.addPage()) getVideo(getTypeId(), "2");
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -416,7 +416,7 @@ private void setEpisodeActivated(Vod.Flag.Episode item) {
         onRefresh();
     }
 
-    private void reverseEpisode() {
+    private void reverseEpisode(boolean scroll) {
         for (int i = 0; i < mFlagAdapter.size(); i++) Collections.reverse(((Vod.Flag) mFlagAdapter.get(i)).getEpisodes());
         setEpisodeAdapter(getFlag().getEpisodes());
         mBinding.episode.setSelectedPosition(getEpisodePosition());

File: app/src/mobile/java/com/fongmi/android/tv/ui/custom/FragmentStateManager.java
Patch:
@@ -20,7 +20,7 @@ public FragmentStateManager(ViewGroup container, FragmentManager fm) {
 
     public abstract Fragment getItem(int position);
 
-    public void change(int position) {
+    public boolean change(int position) {
         FragmentTransaction ft = fm.beginTransaction();
         Fragment fragment = fm.findFragmentByTag(getTag(position));
         if (fragment == null) ft.add(container.getId(), fragment = getItem(position), getTag(position));
@@ -30,6 +30,7 @@ public void change(int position) {
         ft.setPrimaryNavigationFragment(fragment);
         ft.setReorderingAllowed(true);
         ft.commitNowAllowingStateLoss();
+        return true;
     }
 
     private String getTag(int position) {

File: app/src/main/java/com/fongmi/android/tv/player/parse/ParseJob.java
Patch:
@@ -52,8 +52,8 @@ public ParseJob start(Result result, boolean useParse) {
 
     private void setParse(Result result, boolean useParse) {
         if (useParse) parse = ApiConfig.get().getParse();
-        else if (result.getPlayUrl().startsWith("json:")) parse = Parse.get(1, result.getPlayUrl().substring(5));
-        else if (result.getPlayUrl().startsWith("parse:")) parse = ApiConfig.get().getParse(result.getPlayUrl().substring(6));
+        if (result.getPlayUrl().startsWith("json:")) parse = Parse.get(1, result.getPlayUrl().substring(5));
+        if (result.getPlayUrl().startsWith("parse:")) parse = ApiConfig.get().getParse(result.getPlayUrl().substring(6));
         if (parse == null) parse = Parse.get(0, result.getPlayUrl(), result.getHeader());
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -36,7 +36,6 @@
 import com.fongmi.android.tv.db.AppDatabase;
 import com.fongmi.android.tv.event.ErrorEvent;
 import com.fongmi.android.tv.event.PlayerEvent;
-import com.fongmi.android.tv.event.RefreshEvent;
 import com.fongmi.android.tv.model.SiteViewModel;
 import com.fongmi.android.tv.player.ExoUtil;
 import com.fongmi.android.tv.player.Players;
@@ -844,6 +843,7 @@ public void onPictureInPictureModeChanged(boolean isInPictureInPictureMode) {
     @Override
     public void onConfigurationChanged(@NonNull Configuration newConfig) {
         super.onConfigurationChanged(newConfig);
+        if (Utils.hasPIP() && isInPictureInPictureMode()) return;
         if (isFullscreen()) Utils.hideSystemUI(this);
         if (ResUtil.isLand(this)) enterFullscreen();
     }
@@ -864,7 +864,6 @@ protected void onStart() {
     @Override
     protected void onStop() {
         super.onStop();
-        RefreshEvent.history();
         onPause(false);
         setStop(true);
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -82,6 +82,7 @@ public class DetailActivity extends BaseActivity implements CustomKeyDownVod.Lis
     private boolean mLock;
     private boolean mStop;
     private int mCurrent;
+    private int mRotate;
     private Runnable mR1;
     private Runnable mR2;
 
@@ -535,7 +536,7 @@ private void toggleFullscreen() {
     }
 
     private void enterFullscreen() {
-        mBinding.progressLayout.setVisibility(View.GONE);
+        mRotate = getRequestedOrientation();
         mBinding.control.full.setImageResource(R.drawable.ic_full_off);
         setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_USER_LANDSCAPE);
         getIjk().getSubtitleView().setTextSize(TypedValue.COMPLEX_UNIT_SP, 16);
@@ -545,11 +546,10 @@ private void enterFullscreen() {
     }
 
     private void exitFullscreen() {
+        setRequestedOrientation(mRotate);
         mBinding.control.full.setImageResource(R.drawable.ic_full_on);
-        setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_USER_PORTRAIT);
         getIjk().getSubtitleView().setTextSize(TypedValue.COMPLEX_UNIT_SP, 14);
         mBinding.episode.scrollToPosition(mEpisodeAdapter.getPosition());
-        mBinding.progressLayout.setVisibility(View.VISIBLE);
         mBinding.video.setLayoutParams(mFrameParams);
         setFullscreen(false);
         hideAll();

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/EpisodeAdapter.java
Patch:
@@ -56,8 +56,7 @@ public Vod.Flag.Episode getNext() {
 
     public Vod.Flag.Episode getPrev() {
         int current = getPosition();
-        int max = getItemCount() - 1;
-        current = ++current > max ? max : current;
+        current = --current < 0 ? 0 : current;
         return mItems.get(current);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/Product.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.content.res.Resources;
 
+import com.fongmi.android.tv.ui.activity.LiveActivity;
 import com.fongmi.android.tv.utils.Prefers;
 
 import me.jessyan.autosize.AutoSizeCompat;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -182,7 +182,7 @@ private boolean isReplay() {
     }
 
     private boolean isFromCollect() {
-        return getCallingActivity().getShortClassName().contains(CollectActivity.class.getSimpleName());
+        return getCallingActivity() != null && getCallingActivity().getShortClassName().contains(CollectActivity.class.getSimpleName());
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -1,6 +1,7 @@
 package com.fongmi.android.tv.api;
 
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.bean.Channel;
 import com.fongmi.android.tv.bean.Config;
@@ -9,7 +10,6 @@
 import com.fongmi.android.tv.bean.Live;
 import com.fongmi.android.tv.db.AppDatabase;
 import com.fongmi.android.tv.net.Callback;
-import com.fongmi.android.tv.ui.activity.LiveActivity;
 import com.fongmi.android.tv.utils.Json;
 import com.fongmi.android.tv.utils.Prefers;
 import com.google.gson.JsonElement;
@@ -104,7 +104,7 @@ public void parse(JsonObject object) {
         if (!object.has("lives")) return;
         for (JsonElement element : Json.safeListElement(object, "lives")) parse(Live.objectFrom(element).check());
         if (home == null) setHome(lives.isEmpty() ? new Live() : lives.get(0));
-        if (home.isBoot()) App.post(() -> LiveActivity.start(App.activity()));
+        if (home.isBoot()) App.post(Product::bootLive);
     }
 
     private void parse(Live live) {

File: app/src/mobile/java/com/fongmi/android/tv/Product.java
Patch:
@@ -14,4 +14,7 @@ public static Resources hackResources(Resources resources) {
     public static int getColumn(Activity activity) {
         return ResUtil.isPort(activity) ? 3 : 6;
     }
+
+    public static void bootLive() {
+    }
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -162,7 +162,7 @@ private boolean isReplay() {
     }
 
     private boolean isFromSearch() {
-        return getCallingActivity().getShortClassName().contains(SearchActivity.class.getSimpleName());
+        return getCallingActivity() != null && getCallingActivity().getShortClassName().contains(SearchActivity.class.getSimpleName());
     }
 
     @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -29,6 +29,7 @@
 import com.fongmi.android.tv.ui.custom.dialog.SiteDialog;
 import com.fongmi.android.tv.ui.fragment.child.SiteFragment;
 import com.fongmi.android.tv.ui.fragment.child.TypeFragment;
+import com.google.android.material.bottomsheet.BottomSheetDialogFragment;
 
 import org.greenrobot.eventbus.EventBus;
 import org.greenrobot.eventbus.Subscribe;
@@ -119,6 +120,7 @@ private void onTitle(View view) {
     }
 
     private void onFilter(View view) {
+        for (Fragment fragment : getChildFragmentManager().getFragments()) if (fragment instanceof BottomSheetDialogFragment) return;
         FilterDialog.create(this).filter(mTypeAdapter.get(mBinding.pager.getCurrentItem()).getFilters()).show(getChildFragmentManager(), null);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/Product.java
Patch:
@@ -2,6 +2,8 @@
 
 import android.content.res.Resources;
 
+import com.fongmi.android.tv.utils.Prefers;
+
 import me.jessyan.autosize.AutoSizeCompat;
 
 public class Product {
@@ -16,6 +18,6 @@ public static Resources hackResources(Resources resources) {
     }
 
     public static int getColumn() {
-        return Math.abs(getSize() - 7);
+        return Math.abs(Prefers.getSize() - 7);
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -14,6 +14,7 @@
 import androidx.viewbinding.ViewBinding;
 
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.api.LiveConfig;
@@ -41,7 +42,6 @@
 import com.fongmi.android.tv.ui.presenter.VodPresenter;
 import com.fongmi.android.tv.utils.Clock;
 import com.fongmi.android.tv.utils.Notify;
-import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.ResUtil;
 import com.fongmi.android.tv.utils.Utils;
 import com.google.common.collect.Lists;
@@ -158,7 +158,7 @@ private void getVideo() {
     }
 
     private void addVideo(Result result) {
-        for (List<Vod> items : Lists.partition(result.getList(), Prefers.getColumn())) {
+        for (List<Vod> items : Lists.partition(result.getList(), Product.getColumn())) {
             ArrayObjectAdapter adapter = new ArrayObjectAdapter(new VodPresenter(this));
             adapter.setItems(items, null);
             mAdapter.add(new ListRow(adapter));

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/KeepActivity.java
Patch:
@@ -6,6 +6,7 @@
 import androidx.recyclerview.widget.GridLayoutManager;
 import androidx.viewbinding.ViewBinding;
 
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Config;
 import com.fongmi.android.tv.bean.Keep;
@@ -14,7 +15,6 @@
 import com.fongmi.android.tv.net.Callback;
 import com.fongmi.android.tv.ui.adapter.KeepAdapter;
 import com.fongmi.android.tv.ui.custom.SpaceItemDecoration;
-import com.fongmi.android.tv.utils.Prefers;
 
 import org.greenrobot.eventbus.Subscribe;
 import org.greenrobot.eventbus.ThreadMode;
@@ -43,8 +43,8 @@ private void setRecyclerView() {
         mBinding.recycler.setHasFixedSize(true);
         mBinding.recycler.setItemAnimator(null);
         mBinding.recycler.setAdapter(mAdapter = new KeepAdapter(this));
-        mBinding.recycler.setLayoutManager(new GridLayoutManager(this, Prefers.getColumn()));
-        mBinding.recycler.addItemDecoration(new SpaceItemDecoration(Prefers.getColumn(), 16));
+        mBinding.recycler.setLayoutManager(new GridLayoutManager(this, Product.getColumn()));
+        mBinding.recycler.addItemDecoration(new SpaceItemDecoration(Product.getColumn(), 16));
     }
 
     private void getKeep() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/adapter/KeepAdapter.java
Patch:
@@ -7,10 +7,10 @@
 import androidx.annotation.NonNull;
 import androidx.recyclerview.widget.RecyclerView;
 
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.bean.Keep;
 import com.fongmi.android.tv.databinding.AdapterVodBinding;
 import com.fongmi.android.tv.utils.ImgUtil;
-import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.ResUtil;
 
 import java.util.ArrayList;
@@ -30,9 +30,9 @@ public KeepAdapter(OnClickListener listener) {
     }
 
     private void setLayoutSize() {
-        int space = ResUtil.dp2px(48) + ResUtil.dp2px(16 * (Prefers.getColumn() - 1));
+        int space = ResUtil.dp2px(48) + ResUtil.dp2px(16 * (Product.getColumn() - 1));
         int base = ResUtil.getScreenWidthPx() - space;
-        width = base / Prefers.getColumn();
+        width = base / Product.getColumn();
         height = (int) (width / 0.75f);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/CollectFragment.java
Patch:
@@ -11,6 +11,7 @@
 import androidx.leanback.widget.ListRow;
 import androidx.viewbinding.ViewBinding;
 
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.bean.Vod;
@@ -21,7 +22,6 @@
 import com.fongmi.android.tv.ui.custom.CustomRowPresenter;
 import com.fongmi.android.tv.ui.custom.CustomSelector;
 import com.fongmi.android.tv.ui.presenter.VodPresenter;
-import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.ResUtil;
 import com.google.common.collect.Lists;
 import com.google.gson.Gson;
@@ -66,7 +66,7 @@ private void setRecyclerView() {
 
     private boolean checkLastSize(List<Vod> items) {
         if (mLast == null || items.size() == 0) return false;
-        int size = Prefers.getColumn() - mLast.size();
+        int size = Product.getColumn() - mLast.size();
         if (size == 0) return false;
         size = Math.min(size, items.size());
         mLast.addAll(mLast.size(), new ArrayList<>(items.subList(0, size)));
@@ -77,7 +77,7 @@ private boolean checkLastSize(List<Vod> items) {
     public void addVideo(List<Vod> items) {
         if (checkLastSize(items) || getActivity() == null || getActivity().isFinishing()) return;
         List<ListRow> rows = new ArrayList<>();
-        for (List<Vod> part : Lists.partition(items, Prefers.getColumn())) {
+        for (List<Vod> part : Lists.partition(items, Product.getColumn())) {
             mLast = new ArrayObjectAdapter(new VodPresenter(this));
             mLast.setItems(part, null);
             rows.add(new ListRow(mLast));

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/HistoryPresenter.java
Patch:
@@ -7,12 +7,12 @@
 import androidx.annotation.NonNull;
 import androidx.leanback.widget.Presenter;
 
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.History;
 import com.fongmi.android.tv.databinding.AdapterVodBinding;
 import com.fongmi.android.tv.utils.ImgUtil;
-import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.ResUtil;
 
 public class HistoryPresenter extends Presenter {
@@ -44,9 +44,9 @@ public void setDelete(boolean delete) {
     }
 
     private void setLayoutSize() {
-        int space = ResUtil.dp2px(48) + ResUtil.dp2px(16 * (Prefers.getColumn() - 1));
+        int space = ResUtil.dp2px(48) + ResUtil.dp2px(16 * (Product.getColumn() - 1));
         int base = ResUtil.getScreenWidthPx() - space;
-        width = base / Prefers.getColumn();
+        width = base / Product.getColumn();
         height = (int) (width / 0.75f);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/VodPresenter.java
Patch:
@@ -6,10 +6,10 @@
 import androidx.annotation.NonNull;
 import androidx.leanback.widget.Presenter;
 
+import com.fongmi.android.tv.Product;
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.AdapterVodBinding;
 import com.fongmi.android.tv.utils.ImgUtil;
-import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.ResUtil;
 
 public class VodPresenter extends Presenter {
@@ -30,9 +30,9 @@ public interface OnClickListener {
     }
 
     private void setLayoutSize() {
-        int space = ResUtil.dp2px(48) + ResUtil.dp2px(16 * (Prefers.getColumn() - 1));
+        int space = ResUtil.dp2px(48) + ResUtil.dp2px(16 * (Product.getColumn() - 1));
         int base = ResUtil.getScreenWidthPx() - space;
-        width = base / Prefers.getColumn();
+        width = base / Product.getColumn();
         height = (int) (width / 0.75f);
     }
 

File: app/src/main/java/com/fongmi/android/tv/utils/Utils.java
Patch:
@@ -70,8 +70,7 @@ public static void toggleFullscreen(Activity activity, boolean fullscreen) {
     }
 
     public static void showSystemUI(Activity activity) {
-        int flags = View.SYSTEM_UI_FLAG_LAYOUT_STABLE | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN;
-        activity.getWindow().getDecorView().setSystemUiVisibility(flags);
+        activity.getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_VISIBLE);
     }
 
     public static void hideSystemUI(Activity activity) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -229,6 +229,7 @@ private void setRecyclerView() {
         mBinding.episode.setAdapter(mEpisodeAdapter = new EpisodeAdapter(this));
         mBinding.control.parse.setHasFixedSize(true);
         mBinding.control.parse.setItemAnimator(null);
+        mBinding.control.parse.addItemDecoration(new SpaceItemDecoration(8));
         mBinding.control.parse.setLayoutManager(new LinearLayoutManager(this, LinearLayoutManager.HORIZONTAL, false));
         mBinding.control.parse.setAdapter(mParseAdapter = new ParseAdapter(this));
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -37,6 +37,7 @@ protected ViewBinding getBinding() {
 
     @Override
     protected void initView() {
+        Notify.progress(this);
         Updater.get().start();
         Server.get().start();
         initFragment();
@@ -67,12 +68,13 @@ private Callback getCallback() {
             @Override
             public void success() {
                 RefreshEvent.video();
+                Notify.dismiss();
             }
 
             @Override
             public void error(int resId) {
-                RefreshEvent.empty();
                 Notify.show(resId);
+                Notify.dismiss();
             }
         };
     }

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/TypeAdapter.java
Patch:
@@ -19,7 +19,7 @@ public class TypeAdapter extends RecyclerView.Adapter<TypeAdapter.ViewHolder> {
 
     public TypeAdapter(OnClickListener listener) {
         this.mListener = listener;
-        this.mItems = new ArrayList<>(List.of(home()));
+        this.mItems = new ArrayList<>();
     }
 
     public interface OnClickListener {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -111,7 +111,7 @@ public void onBackPressed() {
             mBinding.navigation.setSelectedItemId(R.id.vod);
         } else if (getVodFragment().canBack()) {
             if (!confirm) setConfirm();
-            else super.onBackPressed();
+            else finish();
         }
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -53,7 +53,7 @@ private void initFragment() {
         mFragments = new ArrayList<>();
         mFragments.add(VodFragment.newInstance());
         mFragments.add(SettingFragment.newInstance());
-        for (int i = 0; i < mFragments.size(); i++) getSupportFragmentManager().beginTransaction().add(R.id.container, mFragments.get(i), String.valueOf(i)).hide(mFragments.get(i)).commit();
+        for (int i = 0; i < mFragments.size(); i++) getSupportFragmentManager().beginTransaction().add(R.id.container, mFragments.get(i), String.valueOf(i)).hide(mFragments.get(i)).commitNowAllowingStateLoss();
     }
 
     private void initConfig() {
@@ -95,10 +95,10 @@ private void setConfirm() {
     public boolean onNavigationItemSelected(@NonNull MenuItem item) {
         switch (item.getItemId()) {
             case R.id.vod:
-                getSupportFragmentManager().beginTransaction().hide(mFragments.get(1)).show(mFragments.get(0)).commit();
+                getSupportFragmentManager().beginTransaction().hide(mFragments.get(1)).show(mFragments.get(0)).commitNowAllowingStateLoss();
                 return true;
             case R.id.setting:
-                getSupportFragmentManager().beginTransaction().hide(mFragments.get(0)).show(mFragments.get(1)).commit();
+                getSupportFragmentManager().beginTransaction().hide(mFragments.get(0)).show(mFragments.get(1)).commitNowAllowingStateLoss();
                 return true;
             default:
                 return false;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingFragment.java
Patch:
@@ -134,7 +134,6 @@ private void setConfig() {
             case 0:
                 Notify.dismiss();
                 RefreshEvent.video();
-                RefreshEvent.history();
                 mBinding.liveUrl.setText(LiveConfig.getUrl());
                 mBinding.wallUrl.setText(WallConfig.getUrl());
                 break;

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/SiteFragment.java
Patch:
@@ -86,7 +86,7 @@ public void onItemDelete(History item) {
 
     @Override
     public boolean onLongClick() {
-        setHistoryDelete(true);
+        setHistoryDelete(!mHistoryAdapter.isDelete());
         return true;
     }
 
@@ -105,6 +105,7 @@ public boolean canBack() {
     public void onResult(Result result) {
         mBinding.progressLayout.showContent();
         mVodAdapter.addAll(result.getList());
+        getHistory();
     }
 
     @Subscribe(threadMode = ThreadMode.MAIN)

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/SiteFragment.java
Patch:
@@ -80,6 +80,8 @@ public void onItemClick(History item) {
     public void onItemDelete(History item) {
         mHistoryAdapter.remove(item.delete());
         mBinding.history.requestLayout();
+        if (mHistoryAdapter.getItemCount() > 0) return;
+        mHistoryAdapter.setDelete(false);
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -258,7 +258,7 @@ private void setFlags(List<String> flags) {
     }
 
     public String getAds() {
-        return ads;
+        return TextUtils.isEmpty(ads) ? "" : ads;
     }
 
     private void setAds(List<String> ads) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -70,6 +70,7 @@ public void success() {
 
             @Override
             public void error(int resId) {
+                RefreshEvent.empty();
                 Notify.show(resId);
             }
         };

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -134,6 +134,7 @@ public void success() {
             @Override
             public void error(int resId) {
                 mBinding.progressLayout.showContent();
+                result = Result.empty();
                 Notify.show(resId);
                 setFocus();
             }

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -154,7 +154,6 @@ public void playerContent(String key, String flag, String id) {
                 result.setUrl(url);
                 result.setFlag(flag);
                 result.setPlayUrl(site.getPlayUrl());
-                result.setJx(Utils.isVip(url) ? 1 : 0);
                 result.setParse(Utils.isVideoFormat(url) ? 0 : 1);
                 return result;
             }

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/SiteFragment.java
Patch:
@@ -41,6 +41,7 @@ protected ViewBinding getBinding(@NonNull LayoutInflater inflater, @Nullable Vie
 
     @Override
     protected void initView() {
+        mBinding.progressLayout.showProgress();
         setRecyclerView();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -843,8 +843,8 @@ private void checkFlag() {
     }
 
     private void checkSearch() {
-        if (isAutoMode() && mSearchAdapter.size() > 0) nextSite();
-        else initSearch(getName(), true);
+        if (mSearchAdapter.size() == 0) initSearch(getName(), true);
+        else if (isAutoMode()) nextSite();
     }
 
     private void initSearch(String keyword, boolean auto) {

File: app/src/main/java/com/fongmi/android/tv/player/parse/ParseJob.java
Patch:
@@ -156,7 +156,7 @@ private boolean isPass(Map<String, String> headers, String url) {
             Response response = OkHttp.newCall(url, Headers.of(headers)).execute();
             Map<String, List<String>> respHeader = response.headers().toMultimap();
             if (response.code() != 200 || url.length() < 40) return false;
-            if (respHeader.containsKey("content-length") && Integer.parseInt(respHeader.get("content-length").get(0)) < 10 * 1024 * 1024) return false;
+            if (respHeader.containsKey("content-length") && Integer.parseInt(respHeader.get("content-length").get(0)) < 10 * 1024) return false;
             return true;
         } catch (Exception e) {
             return false;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -814,7 +814,7 @@ private void startFlow() {
     private void checkParse() {
         int position = getParsePosition();
         boolean last = position == mParseAdapter.size() - 1;
-        boolean pass = position < 2 || last;
+        boolean pass = position == 1 || last;
         if (last) initParse();
         if (pass) checkFlag();
         else nextParse(position);

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/TypeFragment.java
Patch:
@@ -130,7 +130,7 @@ private void showFilter() {
     }
 
     private void hideFilter() {
-        mFilterAdapter.clear();
+        //mFilterAdapter.clear();
     }
 
     public void toggleFilter(boolean open) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/child/TypeFragment.java
Patch:
@@ -126,7 +126,7 @@ private void getVideo(String typeId, String page) {
 
     private void showFilter() {
         //mBinding.scroller.smoothScrollTo(0, 0);
-        mFilterAdapter.addAll(mFilters);
+        //mFilterAdapter.addAll(mFilters);
     }
 
     private void hideFilter() {

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/HistoryAdapter.java
Patch:
@@ -88,7 +88,7 @@ public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
         holder.binding.remark.setText(ResUtil.getString(R.string.vod_last, item.getVodRemarks()));
         holder.binding.remark.setVisibility(delete ? View.GONE : View.VISIBLE);
         holder.binding.delete.setVisibility(!delete ? View.GONE : View.VISIBLE);
-        ImgUtil.load(item.getVodPic(), holder.binding.image);
+        ImgUtil.loadHistory(item.getVodPic(), holder.binding.image);
         setClickListener(holder.binding.getRoot(), item);
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -83,7 +83,7 @@ private static MediaSource getSource(Map<String, String> headers, String url, Li
     }
 
     private static MediaItem getMediaItem(String url, List<Sub> subs, int errorCode) {
-        MediaItem.Builder builder = new MediaItem.Builder().setUri(Uri.parse(url.trim()));
+        MediaItem.Builder builder = new MediaItem.Builder().setUri(Uri.parse(url.trim().replace("\\", "")));
         if (errorCode == PlaybackException.ERROR_CODE_PARSING_MANIFEST_MALFORMED) builder.setMimeType(MimeTypes.APPLICATION_OCTET);
         else if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED) builder.setMimeType(MimeTypes.APPLICATION_M3U8);
         if (subs.size() > 0) builder.setSubtitleConfigurations(getSubtitles(subs));

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -138,7 +138,7 @@ public void setResizeMode(int resizeMode) {
     }
 
     public void setMediaSource(String path, Map<String, String> headers) {
-        setVideoURI(Uri.parse(path.trim()), headers);
+        setVideoURI(Uri.parse(path.trim().replace("\\", "")), headers);
     }
 
     public void setVideoURI(Uri uri, Map<String, String> headers) {

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -34,6 +34,8 @@
 import com.google.android.exoplayer2.upstream.cache.NoOpCacheEvictor;
 import com.google.android.exoplayer2.upstream.cache.SimpleCache;
 import com.google.android.exoplayer2.util.MimeTypes;
+import com.google.android.exoplayer2.util.Util;
+import com.google.common.net.HttpHeaders;
 
 import java.util.ArrayList;
 import java.util.Collections;
@@ -106,6 +108,7 @@ private static synchronized HttpDataSource.Factory getHttpDataSourceFactory() {
     }
 
     private static synchronized DataSource.Factory getDataSourceFactory(Map<String, String> headers) {
+        if (!headers.containsKey(HttpHeaders.USER_AGENT)) headers.put(HttpHeaders.USER_AGENT, Util.getUserAgent(App.get(), App.get().getPackageName()));
         if (dataSourceFactory == null) dataSourceFactory = buildReadOnlyCacheDataSource(new DefaultDataSource.Factory(App.get(), getHttpDataSourceFactory()), getCache());
         httpDataSourceFactory.setDefaultRequestProperties(headers);
         return dataSourceFactory;

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -176,9 +176,9 @@ private void openVideo() {
     }
 
     private void fixUserAgent() {
-        if (mHeaders == null || !mHeaders.containsKey("User-Agent")) return;
-        mIjkPlayer.setOption(format, "user_agent", mHeaders.get("User-Agent"));
-        mHeaders.remove("User-Agent");
+        if (!mHeaders.containsKey(Utils.USER_AGENT)) mHeaders.put(Utils.USER_AGENT, Utils.getUserAgent(mAppContext));
+        mIjkPlayer.setOption(format, "user_agent", mHeaders.get(Utils.USER_AGENT));
+        mHeaders.remove(Utils.USER_AGENT);
     }
 
     IMediaPlayer.OnVideoSizeChangedListener mSizeChangedListener = new IMediaPlayer.OnVideoSizeChangedListener() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -69,7 +69,7 @@ protected ViewBinding getBinding() {
     @Override
     protected void initView() {
         mBinding.progressLayout.showProgress();
-        Updater.get().start(this);
+        Updater.get().start();
         Server.get().start();
         setRecyclerView();
         setViewModel();
@@ -299,7 +299,7 @@ public void onServerEvent(ServerEvent event) {
                 CollectActivity.start(this, event.getText(), true);
                 break;
             case UPDATE:
-                Updater.get().force().branch(event.getText()).start(this);
+                Updater.get().force().branch(event.getText()).start();
                 break;
             case PUSH:
                 if (ApiConfig.get().getSite("push_agent") == null) return;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingActivity.java
Patch:
@@ -68,7 +68,7 @@ protected void initEvent() {
         mBinding.wall.setOnClickListener(view -> ConfigDialog.create(this).type(2).show());
         mBinding.vodHistory.setOnClickListener(view -> HistoryDialog.create(this).type(0).show());
         mBinding.liveHistory.setOnClickListener(view -> HistoryDialog.create(this).type(1).show());
-        mBinding.version.setOnClickListener(view -> Updater.get().reset().start(this));
+        mBinding.version.setOnClickListener(view -> Updater.get().force().start());
         mBinding.wallDefault.setOnClickListener(view -> setWallDefault());
         mBinding.wallRefresh.setOnClickListener(view -> setWallRefresh());
         mBinding.quality.setOnClickListener(view -> setQuality());

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -35,7 +35,7 @@ protected ViewBinding getBinding() {
 
     @Override
     protected void initView() {
-        Updater.get().start(this);
+        Updater.get().start();
         Server.get().start();
         initFragment();
         initConfig();

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingFragment.java
Patch:
@@ -70,7 +70,7 @@ protected void initEvent() {
         mBinding.wall.setOnClickListener(view -> ConfigDialog.create(this).type(2).show());
         mBinding.vodHistory.setOnClickListener(view -> HistoryDialog.create(this).type(0).show());
         mBinding.liveHistory.setOnClickListener(view -> HistoryDialog.create(this).type(1).show());
-        mBinding.version.setOnClickListener(view -> Updater.get().reset().start(getActivity()));
+        mBinding.version.setOnClickListener(view -> Updater.get().force().start());
         mBinding.wallDefault.setOnClickListener(view -> setWallDefault());
         mBinding.wallRefresh.setOnClickListener(view -> setWallRefresh());
         mBinding.quality.setOnClickListener(view -> setQuality());

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/VodAdapter.java
Patch:
@@ -56,8 +56,8 @@ public void addAll(List<Vod> items) {
     }
 
     public void clear() {
-        notifyItemRangeInserted(0, mItems.size());
         mItems.clear();
+        notifyDataSetChanged();
     }
 
     @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/HomeFragment.java
Patch:
@@ -36,6 +36,7 @@ public class HomeFragment extends BaseFragment implements VodAdapter.OnClickList
     private HistoryAdapter mHistoryAdapter;
     private SiteViewModel mViewModel;
     private VodAdapter mVodAdapter;
+    private Result result;
 
     public static HomeFragment newInstance() {
         return new HomeFragment();
@@ -77,7 +78,7 @@ private void setViewModel() {
         mViewModel.result.observe(getViewLifecycleOwner(), result -> {
             mBinding.progressLayout.showContent();
             mVodAdapter.addAll(result.getList());
-            result.clear();
+            this.result = result;
         });
     }
 
@@ -99,6 +100,7 @@ public void error(int resId) {
 
     private void getVideo() {
         mVodAdapter.clear();
+        result = Result.empty();
         String home = ApiConfig.get().getHome().getName();
         mBinding.title.setText(home.isEmpty() ? ResUtil.getString(R.string.app_name) : home);
         if (ApiConfig.get().getHome().getKey().isEmpty()) return;

File: app/src/mobile/java/com/fongmi/android/tv/impl/ConfigCallback.java
Patch:
@@ -1,6 +1,8 @@
 package com.fongmi.android.tv.impl;
 
+import com.fongmi.android.tv.bean.Config;
+
 public interface ConfigCallback {
 
-    void setConfig(String url);
+    void setConfig(Config config);
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/ChildFragment.java
Patch:
@@ -105,7 +105,7 @@ private void getVideo(String typeId, String page) {
         if (isFolder()) mBinding.recycler.scrollToPosition(0);
         boolean clear = page.equals("1") && mAdapter.getItemCount() > mFilters.size();
         //if (clear) mAdapter.removeItems(mFilters.size(), mAdapter.size() - mFilters.size());
-        mViewModel.categoryContent(typeId, page, true, mExtend);
+        //mViewModel.categoryContent(typeId, page, true, mExtend);
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -40,8 +40,8 @@ public static void loadHistory(String url, ImageView view) {
 
     public static void loadLive(String url, ImageView view) {
         view.setVisibility(TextUtils.isEmpty(url) ? View.GONE : View.VISIBLE);
-        if (TextUtils.isEmpty(url)) view.setImageResource(R.drawable.ic_live);
-        else Glide.with(App.get()).asBitmap().load(url).skipMemoryCache(true).dontAnimate().signature(new ObjectKey(url)).error(R.drawable.ic_live).into(view);
+        if (TextUtils.isEmpty(url)) view.setImageResource(R.drawable.ic_img_empty);
+        else Glide.with(App.get()).asBitmap().load(url).skipMemoryCache(true).dontAnimate().signature(new ObjectKey(url)).error(R.drawable.ic_img_empty).into(view);
     }
 
     public static GlideUrl getUrl(String url) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -284,8 +284,7 @@ private void setViewModel() {
         mViewModel.player.observe(this, result -> {
             boolean useParse = (result.getPlayUrl().isEmpty() && ApiConfig.get().getFlags().contains(result.getFlag())) || result.getJx() == 1;
             mBinding.control.parseLayout.setVisibility(mParseAdapter.size() > 0 && useParse ? View.VISIBLE : View.GONE);
-            mPlayers.setTimeout(getSite().isSwitchable() ? Constant.TIMEOUT_PLAY : -1);
-            mPlayers.start(result, useParse);
+            mPlayers.start(result, useParse, getSite().isSwitchable() ? Constant.TIMEOUT_PLAY : -1);
             resetFocus();
         });
         mViewModel.result.observe(this, result -> {

File: app/src/main/java/com/fongmi/android/tv/App.java
Patch:
@@ -48,7 +48,7 @@ public static void post(Runnable runnable) {
 
     public static void post(Runnable runnable, long delayMillis) {
         get().handler.removeCallbacks(runnable);
-        get().handler.postDelayed(runnable, delayMillis);
+        if (delayMillis >= 0) get().handler.postDelayed(runnable, delayMillis);
     }
 
     public static void removeCallbacks(Runnable runnable) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -654,7 +654,6 @@ private void setTraffic() {
     }
 
     private void setR1Callback() {
-        App.removeCallbacks(mR1);
         App.post(mR1, Constant.INTERVAL_HIDE);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -384,12 +384,10 @@ private void hideCenter() {
     }
 
     private void setR1Callback() {
-        App.removeCallbacks(mR1);
         App.post(mR1, Constant.INTERVAL_HIDE);
     }
 
     private void setR2Callback() {
-        App.removeCallbacks(mR2);
         App.post(mR2, Constant.INTERVAL_HIDE);
     }
 
@@ -527,7 +525,6 @@ public boolean dispatchKeyEvent(KeyEvent event) {
 
     @Override
     public void setUITimer() {
-        App.removeCallbacks(mR0);
         App.post(mR0, Constant.INTERVAL_HIDE);
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ParseTask.java
Patch:
@@ -58,7 +58,6 @@ private void execute(Result result) {
             try {
                 executor.submit(getTask(result)).get(getTimeout(), TimeUnit.MILLISECONDS);
             } catch (Throwable e) {
-                ;
                 onParseError();
             }
         });

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -728,7 +728,6 @@ private void createKeep() {
 
     @Override
     public void onTrackClick(Track item) {
-        item.setPlayer(mPlayers.getPlayer());
         item.setKey(getHistoryKey());
         item.save();
     }

File: app/src/main/java/com/fongmi/android/tv/ui/custom/TrackSelectionDialog.java
Patch:
@@ -90,6 +90,7 @@ private void addExoTrack(List<Track> items) {
             for (int j = 0; j < trackGroup.length; j++) {
                 Track item = new Track(type, provider.getTrackName(trackGroup.getTrackFormat(j)));
                 item.setSelected(trackGroup.isTrackSelected(j));
+                item.setPlayer(player.getPlayer());
                 item.setGroup(i);
                 item.setTrack(j);
                 items.add(item);
@@ -104,6 +105,7 @@ private void addIjkTrack(List<Track> items) {
             IjkTrackInfo trackInfo = trackInfos[i];
             if (trackInfo.getTrackType() != type) continue;
             Track item = new Track(type, provider.getTrackName(trackInfo));
+            item.setPlayer(player.getPlayer());
             item.setSelected(track == i);
             item.setTrack(i);
             items.add(item);

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -4,7 +4,6 @@
 import android.net.Uri;
 
 import com.fongmi.android.tv.App;
-import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.bean.Sub;
 import com.fongmi.android.tv.utils.FileUtil;
@@ -99,7 +98,7 @@ private static synchronized ExtractorsFactory getExtractorsFactory() {
     }
 
     private static synchronized HttpDataSource.Factory getHttpDataSourceFactory() {
-        if (httpDataSourceFactory == null) httpDataSourceFactory = new DefaultHttpDataSource.Factory().setConnectTimeoutMs(5000).setReadTimeoutMs(5000).setBlackList(ApiConfig.get().getAds()).setAllowCrossProtocolRedirects(true);
+        if (httpDataSourceFactory == null) httpDataSourceFactory = new DefaultHttpDataSource.Factory().setConnectTimeoutMs(5000).setReadTimeoutMs(5000).setAllowCrossProtocolRedirects(true);
         return httpDataSourceFactory;
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -932,11 +932,11 @@ public boolean dispatchKeyEvent(KeyEvent event) {
 
     @Override
     public void onSeeking(int time) {
-        mBinding.widget.progress.setVisibility(View.GONE);
-        mBinding.widget.center.setVisibility(View.VISIBLE);
         mBinding.widget.exoDuration.setText(mPlayers.getDurationTime());
         mBinding.widget.exoPosition.setText(mPlayers.getPositionTime(time));
         mBinding.widget.action.setImageResource(time > 0 ? R.drawable.ic_forward : R.drawable.ic_rewind);
+        mBinding.widget.center.setVisibility(View.VISIBLE);
+        hideProgress();
     }
 
     @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -561,6 +561,7 @@ public void onSeeking(int time) {
         mBinding.widget.exoPosition.setText(mPlayers.getPositionTime(time));
         mBinding.widget.action.setImageResource(time > 0 ? R.drawable.ic_forward : R.drawable.ic_rewind);
         mBinding.widget.center.setVisibility(View.VISIBLE);
+        hideProgress();
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/Constant.java
Patch:
@@ -8,6 +8,7 @@ public class Constant {
     public static final int TIMEOUT_VOD = 30 * 1000;
     public static final int TIMEOUT_LIVE = 10 * 1000;
     public static final int TIMEOUT_HTTP = 30 * 1000;
+    public static final int TIMEOUT_GITHUB = 5 * 1000;
 
     public static final int HIDE_TIME = 5 * 1000;
 

File: app/src/main/java/com/fongmi/android/tv/Github.java
Patch:
@@ -17,7 +17,6 @@ public class Github {
     public static final String REPO = "FongMi/TV/";
     public static final String RELEASE = "release";
     public static final String DEV = "dev";
-    public static final int TIME = 5;
 
     private String proxy;
 
@@ -39,7 +38,7 @@ public Github() {
     private void check(String url) {
         try {
             if (getProxy().length() > 0) return;
-            int code = OkHttp.client(TIME).newCall(new Request.Builder().url(url).build()).execute().code();
+            int code = OkHttp.client(Constant.TIMEOUT_GITHUB).newCall(new Request.Builder().url(url).build()).execute().code();
             if (code == 200) setProxy(url);
         } catch (IOException ignored) {
         }

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -125,7 +125,7 @@ private void setRenderView(IRenderView renderView) {
     }
 
     private void removeRenderView() {
-        if (mRenderView != null) return;
+        if (mRenderView == null) return;
         mContentFrame.removeView(mRenderView.getView());
         mRenderView.removeRenderCallback(mSHCallback);
         mRenderView = null;

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -347,9 +347,9 @@ private void setTrackExo(Track item) {
 
     private void setTrackIjk(Track item) {
         if (item.isSelected()) {
-            ijkPlayer.selectTrack(item.getTrack());
+            ijkPlayer.selectTrack(item.getType(), item.getTrack());
         } else {
-            ijkPlayer.deselectTrack(item.getTrack());
+            ijkPlayer.deselectTrack(item.getType(), item.getTrack());
         }
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -509,7 +509,7 @@ private void onPrev() {
 
     private void onScale() {
         int index = mHistory.getScale();
-        if (index == -1) index = Prefers.getVodScale();
+        if (index == -1) index = Prefers.getScale();
         String[] array = ResUtil.getStringArray(R.array.select_scale);
         mHistory.setScale(index = index == array.length - 1 ? 0 : ++index);
         setScale(index);
@@ -567,6 +567,7 @@ private boolean onEndingReset() {
     private void onPlayer() {
         mPlayers.stop();
         mPlayers.togglePlayer();
+        Prefers.putPlayer(mPlayers.getPlayer());
         mHistory.setPlayer(mPlayers.getPlayer());
         getPlayer(false);
         setPlayerView();
@@ -681,7 +682,7 @@ private void checkHistory() {
         mHistory = mHistory == null ? createHistory() : mHistory;
         setFlagActivated(mHistory.getFlag());
         if (mHistory.isRevSort()) reverseEpisode();
-        setScale(mHistory.getScale() == -1 ? Prefers.getVodScale() : mHistory.getScale());
+        setScale(mHistory.getScale() == -1 ? Prefers.getScale() : mHistory.getScale());
         mBinding.control.opening.setText(mPlayers.stringToTime(mHistory.getOpening()));
         mBinding.control.ending.setText(mPlayers.stringToTime(mHistory.getEnding()));
         mBinding.control.speed.setText(mPlayers.setSpeed(mHistory.getSpeed()));

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingActivity.java
Patch:
@@ -52,7 +52,7 @@ protected void initView() {
         mBinding.wallUrl.setText(WallConfig.getUrl());
         mBinding.versionText.setText(BuildConfig.VERSION_NAME);
         mBinding.sizeText.setText(ResUtil.getStringArray(R.array.select_size)[Prefers.getSize()]);
-        mBinding.scaleText.setText(ResUtil.getStringArray(R.array.select_scale)[Prefers.getVodScale()]);
+        mBinding.scaleText.setText(ResUtil.getStringArray(R.array.select_scale)[Prefers.getScale()]);
         mBinding.playerText.setText(ResUtil.getStringArray(R.array.select_player)[Prefers.getPlayer()]);
         mBinding.decodeText.setText(ResUtil.getStringArray(R.array.select_decode)[Prefers.getDecode()]);
         mBinding.renderText.setText(ResUtil.getStringArray(R.array.select_render)[Prefers.getRender()]);
@@ -187,9 +187,9 @@ private void setRender() {
     }
 
     private void setScale() {
-        int index = Prefers.getVodScale();
+        int index = Prefers.getScale();
         String[] array = ResUtil.getStringArray(R.array.select_scale);
-        Prefers.putVodScale(index = index == array.length - 1 ? 0 : ++index);
+        Prefers.putScale(index = index == array.length - 1 ? 0 : ++index);
         mBinding.scaleText.setText(array[index]);
     }
 

File: app/src/main/java/com/fongmi/android/tv/Github.java
Patch:
@@ -11,7 +11,7 @@
 public class Github {
 
     public static final String A = "https://raw.githubusercontent.com/";
-    public static final String B = "https://ghproxy.com/";
+    public static final String B = "https://gh-proxy.com/";
     public static final String C = "https://raw.iqiq.io/";
     public static final String REPO = "FongMi/TV/";
     public static final String RELEASE = "release";

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -185,7 +185,6 @@ public String toggleSpeed() {
 
     public void togglePlayer() {
         setPlayer(player == 0 ? 1 : 0);
-        Prefers.putPlayer(player);
     }
 
     public void toggleDecode() {

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/IjkMediaPlayer.java
Patch:
@@ -199,7 +199,7 @@ private static void initNativeOnce() {
             if (!mIsNativeInitialized) {
                 native_init();
                 native_setDot(0);
-                native_setLogLevel(BuildConfig.DEBUG ? IjkMediaPlayer.IJK_LOG_INFO : IjkMediaPlayer.IJK_LOG_SILENT);
+                native_setLogLevel(IjkMediaPlayer.IJK_LOG_SILENT);
                 mIsNativeInitialized = true;
             }
         }

File: app/src/main/java/com/fongmi/android/tv/model/LiveViewModel.java
Patch:
@@ -34,7 +34,7 @@ public void getLive(Live home) {
     public void getUrl(Channel item) {
         execute(() -> {
             TVBus.get().stop();
-            String url = item.getUrls().get(item.getLine()).split("\\$")[0];
+            String url = item.getCurrent().split("\\$")[0];
             if (item.isForce()) item.setUrl(Force.get().fetch(url));
             else if (item.isZLive()) item.setUrl(ZLive.get().fetch(url));
             else if (item.isTVBus()) item.setUrl(TVBus.get().fetch(url));

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/IjkMediaMeta.java
Patch:
@@ -229,8 +229,6 @@ public static IjkMediaMeta parse(Bundle mediaMeta) {
             } else if (streamMeta.mType.equalsIgnoreCase(IJKM_VAL_TYPE__AUDIO)) {
                 streamMeta.mSampleRate = streamMeta.getInt(IJKM_KEY_SAMPLE_RATE);
                 streamMeta.mChannelLayout = streamMeta.getLong(IJKM_KEY_CHANNEL_LAYOUT);
-            } else if (streamMeta.mType.equalsIgnoreCase(IJKM_VAL_TYPE__TIMEDTEXT)) {
-                if (streamMeta.mCodecName.equals("hdmv_pgs_subtitle")) continue;
             }
 
             meta.mStreams.add(streamMeta);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -432,6 +432,7 @@ private void initSearch(String keyword, boolean accurate) {
         stopSearch();
         startSearch(keyword);
         setAccurate(accurate);
+        setAutoMode(accurate);
         mBinding.part.setTag(keyword);
     }
 
@@ -700,6 +701,7 @@ public void onFailure(@NonNull Call call, @NonNull IOException e) {
     private boolean hasFlag() {
         mBinding.flag.setVisibility(mFlagAdapter.size() > 0 ? View.VISIBLE : View.GONE);
         if (mFlagAdapter.size() == 0) Notify.show(R.string.error_episode);
+        if (mFlagAdapter.size() == 0) initSearch(getName(), true);
         return mFlagAdapter.size() > 0;
     }
 
@@ -823,7 +825,6 @@ private void onError(String msg) {
             initSearch(mBinding.name.getText().toString(), true);
             mBinding.widget.text.setText(msg);
             Clock.get().setCallback(null);
-            setAutoMode(true);
             mPlayers.stop();
             hideProgress();
             showError();

File: app/src/main/java/com/fongmi/android/tv/net/Download.java
Patch:
@@ -35,7 +35,7 @@ private void doInBackground() {
             FileUtil.clearDir(file);
             Response response = OkHttp.newCall(url).execute();
             download(response.body().byteStream(), Double.parseDouble(response.header("Content-Length", "1")));
-            App.post(() -> callback.success(file));
+            App.post(() -> callback.success(FileUtil.chmod(file)));
         } catch (Exception e) {
             App.post(() -> callback.error(e.getMessage()));
         }

File: app/src/main/java/com/fongmi/android/tv/utils/FileUtil.java
Patch:
@@ -158,12 +158,14 @@ public static void openFile(File file) {
         App.get().startActivity(intent);
     }
 
-    private static void chmod(File file) {
+    public static File chmod(File file) {
         try {
             Process process = Runtime.getRuntime().exec("chmod 777 " + file);
             process.waitFor();
+            return file;
         } catch (Exception e) {
             e.printStackTrace();
+            return file;
         }
     }
 }

File: app/src/main/java/com/fongmi/android/tv/db/AppDatabase.java
Patch:
@@ -21,7 +21,7 @@
 import com.fongmi.android.tv.db.dao.SiteDao;
 import com.fongmi.android.tv.db.dao.TrackDao;
 
-@Database(entities = {Keep.class, Site.class, Track.class, Config.class, History.class}, version = AppDatabase.VERSION, exportSchema = false)
+@Database(entities = {Keep.class, Site.class, Track.class, Config.class, History.class}, version = AppDatabase.VERSION)
 public abstract class AppDatabase extends RoomDatabase {
 
     public static final int VERSION = 17;
@@ -98,7 +98,8 @@ public void migrate(@NonNull SupportSQLiteDatabase database) {
     static final Migration MIGRATION_16_17 = new Migration(16, 17) {
         @Override
         public void migrate(@NonNull SupportSQLiteDatabase database) {
-            database.execSQL("CREATE TABLE IF NOT EXISTS Track (`id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, `type` INTEGER NOT NULL, `group` INTEGER NOT NULL, `track` INTEGER NOT NULL, `player` INTEGER NOT NULL, `key` TEXT, `name` TEXT, `selected` INTEGER NOT NULL)");
+            database.execSQL("CREATE TABLE IF NOT EXISTS `Track` (`id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, `type` INTEGER NOT NULL, `group` INTEGER NOT NULL, `track` INTEGER NOT NULL, `player` INTEGER NOT NULL, `key` TEXT, `name` TEXT, `selected` INTEGER NOT NULL)");
+            database.execSQL("CREATE UNIQUE INDEX IF NOT EXISTS `index_Track_key_player_type` ON `Track` (`key`, `player`, `type`)");
         }
     };
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -840,15 +840,15 @@ public boolean dispatchKeyEvent(KeyEvent event) {
 
     @Override
     public void onSeeking(int time) {
+        mBinding.widget.center.setVisibility(View.VISIBLE);
         mBinding.widget.exoDuration.setText(mPlayers.getDurationTime());
         mBinding.widget.exoPosition.setText(mPlayers.getPositionTime(time));
         mBinding.widget.action.setImageResource(time > 0 ? R.drawable.ic_forward : R.drawable.ic_rewind);
-        mBinding.widget.center.setVisibility(View.VISIBLE);
     }
 
     @Override
     public void onSeekTo(int time) {
-        mPlayers.seekTo(time);
+        App.post(() -> mPlayers.seekTo(time),500);
         mKeyDown.resetTime();
         onPlay(500);
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -579,15 +579,15 @@ public void onKeyDown() {
     @Override
     public void onKeyLeft(int time) {
         if (isVisible(mBinding.widget.center)) App.post(mR2, 500);
-        if (mChannel.isOnly() && mPlayers.isVod()) mPlayers.seekTo(time);
+        if (mChannel.isOnly() && mPlayers.isVod()) App.post(() -> mPlayers.seekTo(time), 500);
         else if (!mChannel.isOnly()) prevLine();
         mKeyDown.resetTime();
     }
 
     @Override
     public void onKeyRight(int time) {
         if (isVisible(mBinding.widget.center)) App.post(mR2, 500);
-        if (mChannel.isOnly() && mPlayers.isVod()) mPlayers.seekTo(time);
+        if (mChannel.isOnly() && mPlayers.isVod()) App.post(() -> mPlayers.seekTo(time), 500);
         else if (!mChannel.isOnly()) nextLine(true);
         mKeyDown.resetTime();
     }

File: app/src/main/java/com/fongmi/android/tv/bean/Site.java
Patch:
@@ -188,8 +188,7 @@ public Site sync() {
         Site item = find(getKey());
         if (item == null) return this;
         setFilterable(item.getFilterable());
-        if (getSearchable() == 0) return this;
-        if (getSearchable() == 1) setSearchable(Math.max(item.getSearchable(), 1));
+        if (getSearchable() != 0) setSearchable(item.getSearchable());
         return this;
     }
 

File: app/src/main/java/com/fongmi/android/tv/Github.java
Patch:
@@ -15,6 +15,7 @@ public class Github {
     public static final String C = "https://raw.iqiq.io/";
     public static final String REPO = "FongMi/TV/";
     public static final String RELEASE = "release";
+    public static final String DEV = "dev";
     public static final int TIME = 5;
 
     private String proxy;

File: catvod/src/main/java/com/github/catvod/crawler/Spider.java
Patch:
@@ -38,11 +38,11 @@ public String playerContent(String flag, String id, List<String> vipFlags) throw
         return "";
     }
 
-    public boolean isVideoFormat(String url) {
+    public boolean manualVideoCheck() {
         return false;
     }
 
-    public boolean manualVideoCheck() {
+    public boolean isVideoFormat(String url) {
         return false;
     }
 }

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -63,7 +63,7 @@ public static CaptionStyleCompat getCaptionStyle() {
 
     public static boolean haveTrack(Tracks tracks, int type) {
         int count = 0;
-        for (Tracks.Group trackGroup : tracks.getGroups()) if (trackGroup.getType() == type) ++count;
+        for (Tracks.Group trackGroup : tracks.getGroups()) if (trackGroup.getType() == type) count += trackGroup.length;
         return count > 1;
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -120,7 +120,7 @@ private void setSite() {
     private void search() {
         mAdapter.add(Collect.all());
         mPageAdapter.notifyDataSetChanged();
-        mExecutor = Executors.newCachedThreadPool();
+        mExecutor = Executors.newFixedThreadPool(5);
         mBinding.result.setText(getString(R.string.collect_result, getKeyword()));
         for (Site site : mSites) mExecutor.execute(() -> search(site));
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -193,8 +193,8 @@ protected void initEvent() {
         mBinding.control.player.setOnClickListener(view -> onPlayer());
         mBinding.control.decode.setOnClickListener(view -> onDecode());
         mBinding.control.ending.setOnClickListener(view -> onEnding());
-        //mBinding.control.opening.setOnClickListener(view -> onOpening());
-        mBinding.control.opening.setOnClickListener(view -> onTracks());
+        mBinding.control.opening.setOnClickListener(view -> onOpening());
+        //mBinding.control.opening.setOnClickListener(view -> onTracks());
         mBinding.control.replay.setOnClickListener(view -> getPlayer(true));
         mBinding.control.speed.setOnLongClickListener(view -> onSpeedLong());
         mBinding.control.ending.setOnLongClickListener(view -> onEndingReset());

File: app/src/leanback/java/com/fongmi/android/tv/ui/adapter/LiveAdapter.java
Patch:
@@ -10,7 +10,6 @@
 import com.fongmi.android.tv.bean.Live;
 import com.fongmi.android.tv.databinding.AdapterLiveBinding;
 
-import java.util.Collections;
 import java.util.List;
 
 public class LiveAdapter extends RecyclerView.Adapter<LiveAdapter.ViewHolder> {
@@ -21,7 +20,6 @@ public class LiveAdapter extends RecyclerView.Adapter<LiveAdapter.ViewHolder> {
     public LiveAdapter(OnClickListener listener) {
         this.mListener = listener;
         this.mItems = LiveConfig.get().getLives();
-        Collections.sort(mItems, new Live.Sorter());
     }
 
     public interface OnClickListener {

File: app/src/main/java/com/fongmi/android/tv/utils/Utils.java
Patch:
@@ -74,7 +74,7 @@ public static boolean isVideoFormat(String url) {
     public static boolean isVideoFormat(String url, Map<String, String> headers) {
         if (Sniffer.CUSTOM.matcher(url).find()) return true;
         if (headers.containsKey("Accept") && headers.get("Accept").startsWith("image")) return false;
-        if (url.contains("=http") || url.contains(".js") || url.contains(".css") || url.contains(".html")) return false;
+        if (url.contains("url=http") || url.contains(".js") || url.contains(".css") || url.contains(".html")) return false;
         return Sniffer.RULE.matcher(url).find();
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Live.java
Patch:
@@ -90,7 +90,7 @@ public List<Group> getGroups() {
     }
 
     public Core getCore() {
-        return core == null ? new Core() : core;
+        return core;
     }
 
     public boolean isActivated() {

File: app/src/main/java/com/fongmi/android/tv/player/source/TVBus.java
Patch:
@@ -27,6 +27,7 @@ public TVBus() {
     }
 
     public void init(Core core) {
+        if (core == null) return;
         tvcore = TVCore.getInstance().listener(this);
         TVService.start(App.get(), core.getAuth(), core.getName(), core.getPass(), core.getBroker());
     }

File: tvbus/src/main/java/com/tvbus/engine/TVService.java
Patch:
@@ -17,7 +17,7 @@ public static void start(Context context, String auth, String name, String pass,
             intent.putExtra("pass", pass);
             intent.putExtra("broker", broker);
             context.startService(intent);
-        } catch (Exception e) {
+        } catch (Throwable e) {
             e.printStackTrace();
         }
     }
@@ -33,8 +33,7 @@ public static void stop(Context context) {
     @Override
     public int onStartCommand(Intent intent, int flags, int startId) {
         tvcore = TVCore.getInstance().auth(intent.getStringExtra("auth")).name(intent.getStringExtra("name")).pass(intent.getStringExtra("pass")).broker(intent.getStringExtra("broker"));
-        tvcore.serv(0).play(8902).mode(1);
-        tvcore.init(this);
+        tvcore.serv(0).play(8902).mode(1).init(this);
         return START_NOT_STICKY;
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Site.java
Patch:
@@ -103,7 +103,7 @@ public String getPlayUrl() {
     }
 
     public int getPlayerType() {
-        return playerType == null ? -1 : playerType;
+        return playerType == null ? -1 : playerType == 1 ? 1 : 0;
     }
 
     public Integer getSearchable() {

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -93,7 +93,7 @@ private void parseConfig(String json) {
 
     private void parse(String text) {
         Live live = new Live(config.getUrl());
-        LiveParser.start(live, text);
+        LiveParser.text(live, text);
         lives.remove(live);
         lives.add(live);
         setHome(live);

File: app/src/main/java/com/fongmi/android/tv/bean/Live.java
Patch:
@@ -81,7 +81,7 @@ public String getUa() {
         return TextUtils.isEmpty(ua) ? "" : ua;
     }
 
-    public List<Channel> getChannels() {
+    private List<Channel> getChannels() {
         return channels = channels == null ? new ArrayList<>() : channels;
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -9,7 +9,6 @@
 import com.fongmi.android.tv.bean.Live;
 import com.fongmi.android.tv.db.AppDatabase;
 import com.fongmi.android.tv.net.Callback;
-import com.fongmi.android.tv.player.source.TVBus;
 import com.fongmi.android.tv.utils.Json;
 import com.fongmi.android.tv.utils.Prefers;
 import com.google.gson.JsonElement;
@@ -173,7 +172,6 @@ public Live getHome() {
     public void setHome(Live home) {
         this.home = home;
         this.home.setActivated(true);
-        TVBus.get().init(home.getCore());
         config.home(home.getName()).update();
         for (Live item : lives) item.setActivated(home);
     }

File: app/src/main/java/com/fongmi/android/tv/model/LiveViewModel.java
Patch:
@@ -26,6 +26,7 @@ public LiveViewModel() {
 
     public void getLive(Live home) {
         execute(() -> {
+            TVBus.get().init(home.getCore());
             LiveParser.start(home);
             return home;
         });

File: app/src/main/java/com/fongmi/android/tv/player/source/ZLive.java
Patch:
@@ -48,6 +48,7 @@ public String fetch(String url) {
     public void stop() {
         try {
             if (init) com.east.android.zlive.ZLive.INSTANCE.OnLiveStop();
+            init = false;
         } catch (Throwable e) {
             e.printStackTrace();
         }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -754,7 +754,7 @@ public void onPlayerEvent(PlayerEvent event) {
     }
 
     private void checkPosition() {
-        mPlayers.seekTo(Math.max(mHistory.getOpening(), mHistory.getPosition()));
+        mPlayers.seekTo(Math.max(mHistory.getOpening(), mHistory.getPosition()), false);
         Clock.get().setCallback(this);
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -201,13 +201,12 @@ public String getDurationTime() {
     }
 
     public void seekTo(int time) {
-        if (time == 0) return;
         if (isExo()) exoPlayer.seekTo(getPosition() + time);
         else if (isIjk()) ijkPlayer.seekTo(getPosition() + time);
     }
 
-    public void seekTo(long time) {
-        if (time == 0) return;
+    public void seekTo(long time, boolean force) {
+        if (time == 0 && !force) return;
         if (isExo()) exoPlayer.seekTo(time);
         else if (isIjk()) ijkPlayer.seekTo(time);
     }

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomSeekView.java
Patch:
@@ -65,7 +65,7 @@ public void setListener(Players players) {
     }
 
     private void seekToTimeBarPosition(long positionMs) {
-        listener.seekTo(positionMs);
+        listener.seekTo(positionMs, true);
         updateProgress();
     }
 

File: drpy/src/main/java/com/hiker/drpy/Spider.java
Patch:
@@ -84,6 +84,7 @@ public String playerContent(String flag, String id, List<String> vipFlags) throw
 
     public void destroy() {
         submit(() -> {
+            executor.shutdownNow();
             QuickJSContext.destroy(ctx);
             QuickJSContext.destroyRuntime(ctx);
         });

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -593,7 +593,7 @@ private void onToggle() {
 
     private void showProgress() {
         mBinding.widget.progress.setVisibility(View.VISIBLE);
-        App.post(mR3, 500);
+        App.post(mR3, 0);
     }
 
     private void hideProgress() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -330,7 +330,7 @@ private void showUI() {
 
     private void showProgress() {
         mBinding.widget.progress.setVisibility(View.VISIBLE);
-        App.post(mR5, 500);
+        App.post(mR5, 0);
     }
 
     private void hideProgress() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -593,7 +593,7 @@ private void onToggle() {
 
     private void showProgress() {
         mBinding.widget.progress.setVisibility(View.VISIBLE);
-        App.post(mR3, 250);
+        App.post(mR3, 500);
     }
 
     private void hideProgress() {
@@ -637,8 +637,8 @@ private void hideCenter() {
     }
 
     private void setTraffic() {
-        mBinding.widget.traffic.setText(Traffic.get());
-        App.post(mR3, 250);
+        Traffic.setSpeed(mBinding.widget.traffic);
+        App.post(mR3, 500);
     }
 
     private void setR1Callback() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -255,8 +255,8 @@ private void setChannelActivated() {
     }
 
     private void setTraffic() {
-        mBinding.widget.traffic.setText(Traffic.get());
-        App.post(mR5, 250);
+        Traffic.setSpeed(mBinding.widget.traffic);
+        App.post(mR5, 500);
     }
 
     private void onToggle() {
@@ -330,7 +330,7 @@ private void showUI() {
 
     private void showProgress() {
         mBinding.widget.progress.setVisibility(View.VISIBLE);
-        App.post(mR5, 250);
+        App.post(mR5, 500);
     }
 
     private void hideProgress() {

File: app/src/main/java/com/fongmi/android/tv/api/JarLoader.java
Patch:
@@ -93,7 +93,7 @@ public Spider getSpider(String key, String api, String ext, String jar) {
             spider.init(App.get(), ext);
             spiders.put(spKey, spider);
             return spider;
-        } catch (Exception e) {
+        } catch (Throwable e) {
             e.printStackTrace();
             return new SpiderNull();
         }

File: app/src/main/java/com/fongmi/android/tv/api/JsLoader.java
Patch:
@@ -23,7 +23,7 @@ public void clear() {
     private void init() {
         try {
             new Loader().init(App.get());
-        } catch (Exception e) {
+        } catch (Throwable e) {
             e.printStackTrace();
         }
     }
@@ -35,7 +35,7 @@ public Spider getSpider(String key, String api, String ext) {
             spider.init(App.get(), ext);
             spiders.put(key, spider);
             return spider;
-        } catch (Exception e) {
+        } catch (Throwable e) {
             e.printStackTrace();
             return null;
         }

File: app/src/main/java/com/fongmi/android/tv/api/PyLoader.java
Patch:
@@ -26,7 +26,7 @@ public void clear() {
     private void init() {
         try {
             loader = Class.forName("com.undcover.freedom.pyramid.Loader").newInstance();
-        } catch (Exception e) {
+        } catch (Throwable e) {
             e.printStackTrace();
         }
     }
@@ -39,7 +39,7 @@ public Spider getSpider(String key, String api, String ext) {
             spider.init(App.get(), ext);
             spiders.put(key, spider);
             return spider;
-        } catch (Exception e) {
+        } catch (Throwable e) {
             e.printStackTrace();
             return new SpiderNull();
         }

File: app/src/main/java/com/fongmi/android/tv/api/JsLoader.java
Patch:
@@ -36,8 +36,8 @@ private void init() {
     public Spider getSpider(String key, String api, String ext) {
         try {
             if (spiders.containsKey(key)) return spiders.get(key);
-            Method method = loader.getClass().getMethod("spider", String.class, String.class, String.class);
-            Spider spider = (Spider) method.invoke(loader, key, api, ext);
+            Method method = loader.getClass().getMethod("spider", String.class, String.class);
+            Spider spider = (Spider) method.invoke(loader, api, ext);
             spider.init(App.get(), ext);
             spiders.put(key, spider);
             return spider;

File: drpy/src/main/java/com/hiker/drpy/Loader.java
Patch:
@@ -26,8 +26,8 @@ public void init(Context context) {
     }
 
     @Keep
-    public Spider spider(String key, String api, String ext) {
-        return new Spider(ctx, key, api, ext);
+    public Spider spider(String api, String ext) {
+        return new Spider(ctx, api, ext);
     }
 
     @Keep

File: drpy/src/main/java/com/hiker/drpy/Spider.java
Patch:
@@ -8,6 +8,7 @@
 
 import java.util.HashMap;
 import java.util.List;
+import java.util.UUID;
 import java.util.concurrent.ExecutionException;
 
 public class Spider extends com.github.catvod.crawler.Spider {
@@ -18,9 +19,9 @@ public class Spider extends com.github.catvod.crawler.Spider {
     private final String key;
     private final String api;
 
-    public Spider(QuickJSContext ctx, String key, String api, String ext) {
+    public Spider(QuickJSContext ctx, String api, String ext) {
+        this.key = "__" + UUID.randomUUID().toString().replace("-", "") + "__";
         this.ctx = ctx;
-        this.key = key;
         this.ext = ext;
         this.api = api;
     }

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -178,7 +178,8 @@ private String parseExt(String ext) {
         if (ext.startsWith("file")) return Utils.convert(ext);
         if (ext.startsWith("img+")) return Decoder.getExt(ext);
         if (ext.contains("http") || ext.contains("file")) return ext;
-        return parseExt(Utils.convert(config.getUrl(), ext));
+        if (ext.endsWith(".txt") || ext.endsWith(".json") || ext.endsWith(".py") || ext.endsWith(".js")) return parseExt(Utils.convert(config.getUrl(), ext));
+        return ext;
     }
 
     public Spider getCSP(Site site) {

File: app/src/main/java/com/fongmi/android/tv/utils/Utils.java
Patch:
@@ -70,7 +70,7 @@ public static boolean isVideoFormat(String url) {
     public static boolean isVideoFormat(String url, Map<String, String> headers) {
         if (Sniffer.CUSTOM.matcher(url).find()) return true;
         if (headers.containsKey("Accept") && headers.get("Accept").startsWith("image")) return false;
-        if (url.contains(".js") || url.contains(".css")) return false;
+        if (url.contains("url=http") || url.contains(".js") || url.contains(".css")) return false;
         return Sniffer.RULE.matcher(url).find();
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -871,5 +871,6 @@ public void onBackPressed() {
     protected void onDestroy() {
         super.onDestroy();
         mPlayers.release();
+        App.removeCallbacks(mR1, mR2, mR3);
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -690,5 +690,6 @@ protected void onDestroy() {
         super.onDestroy();
         mPlayers.release();
         Force.get().stop();
+        App.removeCallbacks(mR1, mR2, mR3, mR4, mR5, mR6);
     }
 }

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -75,7 +75,6 @@ private static MediaItem getMediaItem(String url, String sub, int errorCode) {
         MediaItem.Builder builder = new MediaItem.Builder().setUri(Uri.parse(url.trim()));
         if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED) builder.setMimeType(MimeTypes.APPLICATION_M3U8);
         if (!TextUtils.isEmpty(sub)) builder.setSubtitleConfigurations(getSubtitles(sub));
-        builder.setAllowChunklessPreparation(Prefers.getDecode() == 1);
         return builder.build();
     }
 

File: app/src/main/java/com/fongmi/android/tv/utils/Prefers.java
Patch:
@@ -76,7 +76,7 @@ public static void putPlayer(int player) {
     }
 
     public static int getDecode() {
-        return getInt("decode", 0);
+        return getInt("decode", 1);
     }
 
     public static void putDecode(int decode) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -343,6 +343,7 @@ private void setEpisodeActivated(Vod.Flag.Episode item) {
     private void reverseEpisode() {
         for (int i = 0; i < mFlagAdapter.size(); i++) Collections.reverse(((Vod.Flag) mFlagAdapter.get(i)).getEpisodes());
         mEpisodeAdapter.setItems(getVodFlag().getEpisodes(), null);
+        mBinding.episode.setSelectedPosition(getEpisodePosition());
         setArray(mEpisodeAdapter.size());
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -72,8 +72,7 @@ private static MediaSource getSource(Map<String, String> headers, String url, St
 
     private static MediaItem getMediaItem(String url, String sub, int errorCode) {
         MediaItem.Builder builder = new MediaItem.Builder().setUri(Uri.parse(url.trim()));
-        if (errorCode == PlaybackException.ERROR_CODE_PARSING_MANIFEST_MALFORMED) builder.setMimeType(MimeTypes.APPLICATION_OCTET);
-        else if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED) builder.setMimeType(MimeTypes.APPLICATION_M3U8);
+        if (errorCode == PlaybackException.ERROR_CODE_PARSING_CONTAINER_UNSUPPORTED) builder.setMimeType(MimeTypes.APPLICATION_M3U8);
         if (!TextUtils.isEmpty(sub)) builder.setSubtitleConfigurations(getSubtitles(sub));
         return builder.build();
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -105,6 +105,7 @@ private void setViewModel() {
         mViewModel.result.observe(this, result -> {
             mAdapter.remove("progress");
             addVideo(result);
+            result.clear();
         });
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -31,7 +31,6 @@
 import com.google.gson.Gson;
 
 import java.util.ArrayList;
-import java.util.Collections;
 import java.util.List;
 
 public class VodActivity extends BaseActivity {
@@ -43,7 +42,6 @@ public class VodActivity extends BaseActivity {
     private View mOldView;
 
     public static void start(Activity activity, Result result) {
-        result.setList(Collections.emptyList());
         start(activity, ApiConfig.get().getHome().getKey(), result);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingActivity.java
Patch:
@@ -78,7 +78,7 @@ protected void initEvent() {
         mBinding.wall.setOnClickListener(view -> ConfigDialog.create(this).type(2).show());
         mBinding.vodHistory.setOnClickListener(view -> HistoryDialog.create(this).type(0).show());
         mBinding.liveHistory.setOnClickListener(view -> HistoryDialog.create(this).type(1).show());
-        mBinding.version.setOnClickListener(view -> Updater.create(this).force().start());
+        mBinding.version.setOnClickListener(view -> Updater.create(this).reset().start());
         mBinding.wallDefault.setOnClickListener(view -> setWallDefault());
         mBinding.wallRefresh.setOnClickListener(view -> setWallRefresh());
         mBinding.quality.setOnClickListener(view -> setQuality());

File: app/src/main/java/com/fongmi/android/tv/player/ParseTask.java
Patch:
@@ -5,9 +5,9 @@
 import com.fongmi.android.tv.bean.Parse;
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.net.OKHttp;
-import com.fongmi.android.tv.server.Server;
 import com.fongmi.android.tv.ui.custom.CustomWebView;
 import com.fongmi.android.tv.utils.Json;
+import com.fongmi.android.tv.utils.Utils;
 import com.google.gson.JsonObject;
 import com.google.gson.JsonParser;
 
@@ -101,7 +101,7 @@ private void checkResult(Result result) {
         if (result.getUrl().isEmpty()) {
             onParseError();
         } else if (result.getParse(0) == 1) {
-            App.post(() -> webView.start(Server.proxy(result.getUrl()), result.getHeaders(), callback));
+            App.post(() -> webView.start(Utils.checkProxy(result.getUrl()), result.getHeaders(), callback));
         } else {
             onParseSuccess(result.getHeaders(), result.getUrl(), result.getJxFrom());
         }

File: catvod/src/main/java/com/github/catvod/crawler/Spider.java
Patch:
@@ -7,10 +7,10 @@
 
 public abstract class Spider {
 
-    public void init(Context context) {
+    public void init(Context context) throws Exception {
     }
 
-    public void init(Context context, String extend) {
+    public void init(Context context, String extend) throws Exception {
         init(context);
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -171,20 +171,20 @@ public String toggleSpeed() {
 
     public void setPlayer(int player) {
         this.player = player;
-        Prefers.putPlayer(player);
     }
 
     public void togglePlayer() {
         setPlayer(player == 0 ? 1 : 0);
+        Prefers.putPlayer(player);
     }
 
     public void setDecode(int decode) {
         this.decode = decode;
-        Prefers.putDecode(decode);
     }
 
     public void toggleDecode() {
         setDecode(decode == 0 ? 1 : 0);
+        Prefers.putDecode(decode);
     }
 
     public String getPositionTime(long time) {

File: app/src/main/java/com/fongmi/android/tv/db/AppDatabase.java
Patch:
@@ -87,7 +87,6 @@ public void migrate(@NonNull SupportSQLiteDatabase database) {
         public void migrate(@NonNull SupportSQLiteDatabase database) {
             database.execSQL("ALTER TABLE History ADD COLUMN speed REAL DEFAULT 1 NOT NULL");
             database.execSQL("ALTER TABLE History ADD COLUMN player INTEGER DEFAULT -1 NOT NULL");
-            database.execSQL("ALTER TABLE History ADD COLUMN decode INTEGER DEFAULT -1 NOT NULL");
         }
     };
 }

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -7,7 +7,6 @@
 import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.utils.FileUtil;
-import com.fongmi.android.tv.utils.Prefers;
 import com.google.android.exoplayer2.DefaultRenderersFactory;
 import com.google.android.exoplayer2.MediaItem;
 import com.google.android.exoplayer2.PlaybackException;
@@ -51,8 +50,8 @@ public static TrackSelector buildTrackSelector() {
         return trackSelector;
     }
 
-    public static RenderersFactory buildRenderersFactory() {
-        return new DefaultRenderersFactory(App.get()).setExtensionRendererMode(Math.abs(Prefers.getDecode() - 2));
+    public static RenderersFactory buildRenderersFactory(int decode) {
+        return new DefaultRenderersFactory(App.get()).setExtensionRendererMode(Math.abs(decode - 2));
     }
 
     public static CaptionStyleCompat getCaptionStyle() {

File: app/src/main/java/com/fongmi/android/tv/utils/ResUtil.java
Patch:
@@ -52,7 +52,7 @@ public static String getString(@StringRes int resId, Object... formatArgs) {
         return App.get().getString(resId, formatArgs);
     }
 
-    public static CharSequence[] getStringArray(@ArrayRes int resId) {
+    public static String[] getStringArray(@ArrayRes int resId) {
         return App.get().getResources().getStringArray(resId);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -513,7 +513,6 @@ private void hideError() {
     }
 
     private void showInfo() {
-        mBinding.widget.size.setText(mPlayers.getSizeText());
         mBinding.widget.center.setVisibility(View.VISIBLE);
         mBinding.widget.info.setVisibility(View.VISIBLE);
     }
@@ -640,6 +639,7 @@ public void onPlayerEvent(PlayerEvent event) {
             case Player.STATE_READY:
                 hideProgress();
                 mPlayers.reset();
+                mBinding.widget.size.setText(mPlayers.getSizeText());
                 TrackSelectionDialog.setVisible(mPlayers.exo(), mBinding.control.tracks);
                 break;
             case Player.STATE_ENDED:

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomSeekView.java
Patch:
@@ -75,6 +75,7 @@ public void start() {
     }
 
     private void updateProgress() {
+        if (listener.isRelease()) return;
         long duration = listener.getDuration();
         long position = listener.getPosition();
         long buffered = listener.getBuffered();

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -137,7 +137,7 @@ private int[] getKeep(List<Group> items) {
     }
 
     public void setKeep(Group group, Channel channel) {
-        if (!group.isHidden()) Prefers.putKeep(home.getName() + AppDatabase.SYMBOL + group.getName() + AppDatabase.SYMBOL + channel.getName());
+        if (!group.isHidden() && home != null) Prefers.putKeep(home.getName() + AppDatabase.SYMBOL + group.getName() + AppDatabase.SYMBOL + channel.getName());
     }
 
     public int[] find(List<Group> items) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -696,9 +696,9 @@ private void onPlay(int delay) {
 
     @Override
     public boolean dispatchKeyEvent(KeyEvent event) {
+        if (mFullscreen && Utils.isMenuKey(event)) onToggle();
         if (isVisible(mBinding.control.getRoot())) setR1Callback();
-        if (mFullscreen && mBinding.control.tracks.getVisibility() == View.VISIBLE && Utils.isMenuKey(event)) onToggle();
-        else if (mFullscreen && isGone(mBinding.control.getRoot()) && mKeyDown.hasEvent(event)) return mKeyDown.onKeyDown(event);
+        if (mFullscreen && isGone(mBinding.control.getRoot()) && mKeyDown.hasEvent(event)) return mKeyDown.onKeyDown(event);
         return super.dispatchKeyEvent(event);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/CollectFragment.java
Patch:
@@ -88,7 +88,7 @@ public void addVideo(List<Vod> items) {
     @Override
     public void onItemClick(Vod item) {
         getActivity().setResult(Activity.RESULT_OK);
-        if (item.isFolder()) VodActivity.start(getActivity(), Result.folder(item));
+        if (item.isFolder()) VodActivity.start(getActivity(), item.getSite().getKey(), Result.folder(item));
         else DetailActivity.start(getActivity(), item.getSite().getKey(), item.getVodId());
     }
 

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -82,8 +82,8 @@ public void homeContent() {
         });
     }
 
-    public void categoryContent(String tid, String page, boolean filter, HashMap<String, String> extend) {
-        Site site = ApiConfig.get().getHome();
+    public void categoryContent(String key, String tid, String page, boolean filter, HashMap<String, String> extend) {
+        Site site = ApiConfig.get().getSite(key);
         execute(result, () -> {
             if (site.getType() == 3) {
                 Spider spider = ApiConfig.get().getCSP(site);

File: ijkplayer/src/main/java/tv/danmaku/ijk/media/player/ui/IjkVideoView.java
Patch:
@@ -532,7 +532,7 @@ private void createPlayer() {
         mIjkPlayer.setOption(player, "soundtouch", 1);
         mIjkPlayer.setOption(player, "start-on-prepared", 1);
         mIjkPlayer.setOption(player, "subtitle", 1);
-        if (mUri.getScheme().startsWith("rtsp")) {
+        if (mUri.getScheme() != null && mUri.getScheme().startsWith("rtsp")) {
             mIjkPlayer.setOption(format, "infbuf", 1);
             mIjkPlayer.setOption(format, "rtsp_transport", "tcp");
             mIjkPlayer.setOption(format, "rtsp_flags", "prefer_tcp");

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -21,6 +21,7 @@
 import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.api.ApiConfig;
+import com.fongmi.android.tv.api.SoLoader;
 import com.fongmi.android.tv.bean.History;
 import com.fongmi.android.tv.bean.Keep;
 import com.fongmi.android.tv.bean.Parse;
@@ -470,6 +471,7 @@ private boolean onEndingReset() {
     }
 
     private void onPlayer() {
+        if (SoLoader.isFail()) return;
         int index = Prefers.getPlayer();
         CharSequence[] array = ResUtil.getStringArray(R.array.select_player);
         Prefers.putPlayer(index = index == array.length - 1 ? 0 : ++index);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -17,6 +17,7 @@
 import com.fongmi.android.tv.App;
 import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.api.LiveConfig;
+import com.fongmi.android.tv.api.SoLoader;
 import com.fongmi.android.tv.bean.Channel;
 import com.fongmi.android.tv.bean.Epg;
 import com.fongmi.android.tv.bean.Group;
@@ -270,6 +271,7 @@ private boolean onSpeedLong() {
     }
 
     private void onPlayer() {
+        if (SoLoader.isFail()) return;
         int index = Prefers.getPlayer();
         CharSequence[] array = ResUtil.getStringArray(R.array.select_player);
         Prefers.putPlayer(index = index == array.length - 1 ? 0 : ++index);

File: app/src/main/java/com/fongmi/android/tv/api/SoLoader.java
Patch:
@@ -1,8 +1,10 @@
 package com.fongmi.android.tv.api;
 
 import com.fongmi.android.tv.App;
+import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.net.OKHttp;
 import com.fongmi.android.tv.utils.FileUtil;
+import com.fongmi.android.tv.utils.Notify;
 
 import java.io.File;
 
@@ -35,6 +37,7 @@ private void checkSo(String name) {
             if (!file.exists()) FileUtil.write(file, OKHttp.newCall(url + name).execute().body().bytes());
             System.load(file.getAbsolutePath());
         } catch (Throwable e) {
+            App.post(() -> Notify.show(R.string.error_so_load));
             e.printStackTrace();
         }
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -241,7 +241,7 @@ private void setViewModel() {
     }
 
     private void resetFocus(boolean useParse) {
-        mBinding.control.seek.setNextFocusUpId(useParse ? R.id.parse : R.id.next);
+        findViewById(R.id.timeBar).setNextFocusUpId(useParse ? R.id.parse : R.id.next);
         for (int i = 0; i < mBinding.control.actionLayout.getChildCount(); i++) {
             mBinding.control.actionLayout.getChildAt(i).setNextFocusDownId(useParse ? R.id.parse : R.id.timeBar);
         }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -278,9 +278,9 @@ private void onPlayer() {
         CharSequence[] array = ResUtil.getStringArray(R.array.select_player);
         Prefers.putPlayer(index = index == array.length - 1 ? 0 : ++index);
         mBinding.control.player.setText(array[index]);
+        App.post(this::getUrl,250);
         setVideoVisible();
         mPlayers.toggle();
-        getUrl();
     }
 
     private void hideUI() {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -182,8 +182,8 @@ public void stop() {
     }
 
     public void toggle() {
-        stopExo();
-        stopIjk();
+        if (isIjk()) stopExo();
+        if (isExo()) stopIjk();
     }
 
     public void release() {

File: app/src/main/java/com/fongmi/android/tv/bean/Part.java
Patch:
@@ -8,7 +8,6 @@
 
 import java.lang.reflect.Type;
 import java.util.ArrayList;
-import java.util.Collections;
 import java.util.List;
 
 public class Part {
@@ -21,13 +20,13 @@ private static List<Part> arrayFrom(String str) {
             Type listType = new TypeToken<ArrayList<Part>>() {}.getType();
             return new Gson().fromJson(str, listType);
         } catch (Exception e) {
-            return Collections.emptyList();
+            return new ArrayList<>();
         }
     }
 
     public static List<String> get(String str) {
         List<String> items = new ArrayList<>();
-        if (TextUtils.isEmpty(str)) return Collections.emptyList();
+        if (TextUtils.isEmpty(str)) return items;
         for (Part item : arrayFrom(str)) items.add(item.getT());
         return items;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -451,7 +451,7 @@ private void onTracks() {
     }
 
     private void getPart(String source) {
-        OKHttp.newCall("http://api.pullword.com/get.php?source=" + URLEncoder.encode(source) + "&param1=0&param2=0&json=1").enqueue(new Callback() {
+        OKHttp.newCall("http://api.pullword.com/get.php?source=" + URLEncoder.encode(source.trim()) + "&param1=0&param2=0&json=1").enqueue(new Callback() {
             @Override
             public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {
                 List<String> items = Part.get(response.body().string());

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -190,6 +190,7 @@ private void setPosition(int[] position) {
         if (mGroupAdapter.size() == 1) return;
         mGroup = (Group) mGroupAdapter.get(position[0]);
         mBinding.group.setSelectedPosition(position[0]);
+        if (mGroup.getChannel().isEmpty()) return;
         mGroup.setPosition(position[1]);
         onItemClick(mGroup);
         onItemClick(mGroup.current());
@@ -419,8 +420,8 @@ public boolean prevGroup(boolean skip) {
 
     @Override
     public boolean dispatchKeyEvent(KeyEvent event) {
-        if (mGroup == null) return false;
         if (Utils.isMenuKey(event)) onLongPress();
+        if (mGroup == null || mChannel == null) return super.dispatchKeyEvent(event);
         else if (isGone(mBinding.recycler) && !getPlayerView().isControllerFullyVisible() && mKeyDown.hasEvent(event)) return mKeyDown.onKeyDown(event);
         return super.dispatchKeyEvent(event);
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/ChannelPresenter.java
Patch:
@@ -36,6 +36,7 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         item.loadLogo(holder.binding.logo);
         holder.binding.name.setText(item.getName());
         holder.binding.number.setText(item.getNumber());
+        holder.binding.getRoot().setSelected(item.isSelected());
         holder.binding.logo.setVisibility(item.getLogoVisible());
         setOnClickListener(holder, view -> mListener.onItemClick(item));
         holder.view.setOnLongClickListener(view -> mListener.onLongClick(item));

File: app/src/main/java/com/fongmi/android/tv/player/ParseTask.java
Patch:
@@ -7,6 +7,7 @@
 import com.fongmi.android.tv.net.OKHttp;
 import com.fongmi.android.tv.server.Server;
 import com.fongmi.android.tv.ui.custom.CustomWebView;
+import com.fongmi.android.tv.utils.Json;
 import com.google.gson.JsonObject;
 import com.google.gson.JsonParser;
 
@@ -77,7 +78,7 @@ private void jsonParse(String webUrl) {
             HashMap<String, String> headers = new HashMap<>();
             for (String key : object.keySet()) if (key.equalsIgnoreCase("user-agent") || key.equalsIgnoreCase("referer")) headers.put(key, object.get(key).getAsString());
             object = object.has("data") ? object.getAsJsonObject("data") : object;
-            onParseSuccess(headers, object.get("url").getAsString(), "");
+            onParseSuccess(headers, Json.safeString(object, "url"), "");
         } catch (Exception e) {
             e.printStackTrace();
             onParseError();

File: app/src/main/java/com/fongmi/android/tv/bean/Result.java
Patch:
@@ -72,7 +72,7 @@ public static Result fromXml(String str) {
     }
 
     public static Result fromObject(JSONObject object) {
-        return objectFrom(object.toString());
+        return object == null ? empty() : objectFrom(object.toString());
     }
 
     public static Result objectFrom(String str) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -320,6 +320,7 @@ public void onBackPressed() {
             Notify.show(R.string.app_exit);
             App.post(() -> confirm = false, 1000);
         } else {
+            super.onBackPressed();
             finish();
         }
     }
@@ -331,6 +332,5 @@ protected void onDestroy() {
         LiveConfig.get().clear();
         ApiConfig.get().clear();
         Server.get().stop();
-        System.exit(0);
     }
 }
\ No newline at end of file

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -377,6 +377,7 @@ public void onResponse(@NonNull Call call, @NonNull Response response) throws IO
     private void getUrl() {
         mBinding.widget.progress.getRoot().setVisibility(View.VISIBLE);
         mViewModel.getUrl(mChannel);
+
     }
 
     private void prevLine(boolean show) {
@@ -542,6 +543,7 @@ public void onPlayerEvent(PlayerEvent event) {
                 onKeyDown();
                 break;
             default:
+                App.removeCallbacks(mR4);
                 if (!event.isRetry() || mPlayers.addRetry() > 2) onError();
                 else getUrl();
                 break;
@@ -550,7 +552,6 @@ public void onPlayerEvent(PlayerEvent event) {
 
     private void onError() {
         mPlayers.reset();
-        App.removeCallbacks(mR4);
         if (mChannel.isLastLine()) {
             if (isGone(mBinding.recycler)) onKeyDown();
         } else {

File: app/src/main/java/com/fongmi/android/tv/api/JarLoader.java
Patch:
@@ -52,6 +52,7 @@ public void load(String key, File file) {
             methods.put(key, classProxy.getMethod("proxy", Map.class));
         } catch (Exception e) {
             e.printStackTrace();
+            file.delete();
         }
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -101,12 +101,11 @@ private void parse(String text) {
 
     public void parse(JsonObject object) {
         if (!object.has("lives")) return;
-        for (JsonElement element : Json.safeListElement(object, "lives")) parse(Live.objectFrom(element));
+        for (JsonElement element : Json.safeListElement(object, "lives")) parse(Live.objectFrom(element).check());
         if (home == null) setHome(lives.isEmpty() ? new Live() : lives.get(0));
     }
 
     private void parse(Live live) {
-        if (live.isProxy()) live = new Live(live.getChannels().get(0).getName(), live.getChannels().get(0).getUrls().get(0).split("ext=")[1]);
         if (live.getName().equals(config.getHome())) setHome(live);
         if (!lives.contains(live)) lives.add(live);
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -547,15 +547,15 @@ public void onPlayerEvent(PlayerEvent event) {
                 mBinding.widget.progress.getRoot().setVisibility(View.VISIBLE);
                 break;
             case Player.STATE_READY:
-                mPlayers.setRetry(0);
+                mPlayers.reset();
                 mBinding.widget.progress.getRoot().setVisibility(View.GONE);
                 TrackSelectionDialog.setVisible(mPlayers.exo(), mControl.tracks);
                 break;
             case Player.STATE_ENDED:
                 if (mPlayers.canNext()) checkNext();
                 break;
             default:
-                if (!event.isRetry() || mPlayers.addRetry() > 3) onError(event.getMsg());
+                if (!event.isRetry() || mPlayers.addRetry() > 2) onError(event.getMsg());
                 else getPlayer(false);
                 break;
         }
@@ -575,6 +575,7 @@ private void onError(String msg) {
             Clock.get().setCallback(null);
             mPlayers.stop();
         } else {
+            mPlayers.reset();
             Vod.Flag flag = (Vod.Flag) mFlagAdapter.get(position + 1);
             Notify.show(ResUtil.getString(R.string.play_switching, flag.getFlag()));
             setFlagActivated(flag);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -531,7 +531,7 @@ public void onPlayerEvent(PlayerEvent event) {
                 mBinding.widget.progress.getRoot().setVisibility(View.VISIBLE);
                 break;
             case Player.STATE_READY:
-                mPlayers.setRetry(0);
+                mPlayers.reset();
                 mBinding.widget.progress.getRoot().setVisibility(View.GONE);
                 TrackSelectionDialog.setVisible(mPlayers.exo(), mControl.tracks);
                 break;
@@ -546,7 +546,7 @@ public void onPlayerEvent(PlayerEvent event) {
     }
 
     private void onError() {
-        mPlayers.setRetry(0);
+        mPlayers.reset();
         if (isGone(mBinding.recycler) && mChannel.isLastLine()) {
             onKeyDown();
         } else {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -165,6 +165,7 @@ private void setVideoView() {
         getPlayerView().setResizeMode(Prefers.getLiveScale());
         getPlayerView().setOnClickListener(view -> onToggle());
         getPlayerView().setOnLongClickListener(view -> onLongPress());
+        mControl.home.setVisibility(LiveConfig.isOnly() ? View.GONE : View.VISIBLE);
         mControl.scale.setText(ResUtil.getStringArray(R.array.select_scale)[Prefers.getLiveScale()]);
         mControl.speed.setText(mPlayers.getSpeed());
     }
@@ -181,6 +182,7 @@ private void setGroup(Live home) {
 
     private void setPosition(int[] position) {
         if (position[0] == -1) return;
+        if (mGroupAdapter.size() == 1) return;
         mGroup = (Group) mGroupAdapter.get(position[0]);
         mBinding.group.setSelectedPosition(position[0]);
         mGroup.setPosition(position[1]);

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomTitleView.java
Patch:
@@ -35,6 +35,7 @@ public CustomTitleView(@NonNull Context context, @Nullable AttributeSet attrs) {
 
     public void setListener(Listener listener) {
         this.listener = listener;
+        setOnClickListener(v -> listener.showDialog());
     }
 
     @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/ArrayPresenter.java
Patch:
@@ -43,7 +43,8 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         String text = object.toString();
         holder.binding.text.setText(text);
         if (text.equals(reverse)) setOnClickListener(holder, view -> mListener.onRevSort());
-        if (text.equals(backward) || text.equals(forward)) setOnClickListener(holder, view -> mListener.onRevPlay(holder.binding.text));
+        else if (text.equals(backward) || text.equals(forward)) setOnClickListener(holder, view -> mListener.onRevPlay(holder.binding.text));
+        else setOnClickListener(holder, null);
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -111,6 +111,7 @@ private void loadConfig(Callback callback) {
         } catch (Exception e) {
             if (config.getUrl().isEmpty()) App.post(() -> callback.error(0));
             else loadCache(callback);
+            LiveConfig.get().load();
             e.printStackTrace();
         }
     }
@@ -157,7 +158,7 @@ private void parseLive(JsonObject object) {
         if (hasLive) Config.create(config.getUrl(), 1);
         boolean loadApi = hasLive && LiveConfig.get().isSame(config.getUrl());
         if (loadApi) LiveConfig.get().clear().config(Config.find(config.getUrl(), 1).update()).parse(object);
-        else if (LiveConfig.isEmpty()) LiveConfig.get().load();
+        else LiveConfig.get().load();
     }
 
     private String parseExt(String ext) {

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -65,7 +65,7 @@ public LiveConfig clear() {
     }
 
     public void load() {
-        load(new Callback());
+        if (isEmpty()) load(new Callback());
     }
 
     public void load(Callback callback) {

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -151,7 +151,7 @@ public int[] find(String number, List<Group> items) {
     }
 
     public boolean isSame(String url) {
-        return same || url.equals(config.getUrl());
+        return same || config.getUrl().isEmpty() || url.equals(config.getUrl());
     }
 
     public List<Live> getLives() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -135,7 +135,7 @@ protected void initEvent() {
         mBinding.group.addOnChildViewHolderSelectedListener(new OnChildViewHolderSelectedListener() {
             @Override
             public void onChildViewHolderSelected(@NonNull RecyclerView parent, @Nullable RecyclerView.ViewHolder child, int position, int subposition) {
-                onChildSelected(child, mGroup = (Group) mGroupAdapter.get(position));
+                if (mGroupAdapter.size() > 0) onChildSelected(child, mGroup = (Group) mGroupAdapter.get(position));
             }
         });
     }
@@ -189,6 +189,7 @@ private void setPosition(int[] position) {
     }
 
     private void setPosition() {
+        if (mChannel == null) return;
         Group group = mChannel.getGroup();
         int position = mGroupAdapter.indexOf(group);
         boolean change = mBinding.group.getSelectedPosition() != position;
@@ -383,6 +384,7 @@ public boolean prevGroup(boolean skip) {
 
     @Override
     public boolean dispatchKeyEvent(KeyEvent event) {
+        if (mGroup == null) return false;
         if (Utils.isMenuKey(event)) onLongPress();
         else if (isGone(mBinding.recycler) && !getPlayerView().isControllerFullyVisible() && mKeyDown.hasEvent(event)) return mKeyDown.onKeyDown(event);
         return super.dispatchKeyEvent(event);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -157,7 +157,7 @@ protected void initEvent() {
         mControl.tracks.setOnClickListener(view -> onTracks());
         mControl.ending.setOnClickListener(view -> onEnding());
         mControl.opening.setOnClickListener(view -> onOpening());
-        mControl.speed.setOnLongClickListener(view -> onSpeedReset());
+        mControl.speed.setOnLongClickListener(view -> onSpeedLong());
         mControl.ending.setOnLongClickListener(view -> onEndingReset());
         mControl.opening.setOnLongClickListener(view -> onOpeningReset());
         mBinding.flag.addOnChildViewHolderSelectedListener(new OnChildViewHolderSelectedListener() {
@@ -406,8 +406,8 @@ private void onSpeed() {
         mControl.speed.setText(mPlayers.getSpeed());
     }
 
-    private boolean onSpeedReset() {
-        mPlayers.resetSpeed();
+    private boolean onSpeedLong() {
+        mPlayers.toggleSpeed();
         mControl.speed.setText(mPlayers.getSpeed());
         return true;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -71,6 +71,7 @@ protected void initView() {
         LiveConfig.get().init();
         ApiConfig.get().init().load(getCallback());
         Updater.create(this).start();
+        Notify.progress(this);
         Server.get().start();
         setRecyclerView();
         setViewModel();
@@ -124,13 +125,15 @@ private Callback getCallback() {
         return new Callback() {
             @Override
             public void success() {
+                Notify.dismiss();
                 getHistory();
                 getVideo();
             }
 
             @Override
             public void error(int resId) {
                 Notify.show(resId);
+                Notify.dismiss();
             }
         };
     }

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -157,7 +157,7 @@ private void parseLive(JsonObject object) {
         if (hasLive) Config.create(config.getUrl(), 1);
         boolean loadApi = hasLive && LiveConfig.get().isSame(config.getUrl());
         if (loadApi) LiveConfig.get().clear().config(Config.find(config.getUrl(), 1).update()).parse(object);
-        else if (LiveConfig.get().getHome() == null) LiveConfig.get().load();
+        else if (LiveConfig.isEmpty()) LiveConfig.get().load();
     }
 
     private String parseExt(String ext) {

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -42,7 +42,7 @@ public static int getHomeIndex() {
     }
 
     public static boolean isEmpty() {
-        return get().getHome() == null || get().getHome().getGroups().isEmpty();
+        return get().getHome() == null;
     }
 
     public LiveConfig init() {
@@ -99,7 +99,6 @@ public void parse(JsonObject object) {
         if (!object.has("lives")) return;
         for (JsonElement element : Json.safeListElement(object, "lives")) parse(Live.objectFrom(element));
         if (home == null) setHome(lives.isEmpty() ? new Live() : lives.get(0));
-        LiveParser.start(home);
     }
 
     private void parse(Live live) {

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -82,8 +82,9 @@ public void addSpeed() {
         exoPlayer.setPlaybackSpeed(speed);
     }
 
-    public void resetSpeed() {
-        exoPlayer.setPlaybackSpeed(1f);
+    public void toggleSpeed() {
+        float speed = exoPlayer.getPlaybackParameters().speed;
+        exoPlayer.setPlaybackSpeed(speed == 1 ? 3f : 1f);
     }
 
     public String getTime(long time) {

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -157,7 +157,7 @@ private void parseLive(JsonObject object) {
         if (hasLive) Config.create(config.getUrl(), 1);
         boolean loadApi = hasLive && LiveConfig.get().isSame(config.getUrl());
         if (loadApi) LiveConfig.get().clear().config(Config.find(config.getUrl(), 1).update()).parse(object);
-        else if (LiveConfig.isEmpty()) LiveConfig.get().load();
+        else if (LiveConfig.get().getHome() == null) LiveConfig.get().load();
     }
 
     private String parseExt(String ext) {

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -42,7 +42,7 @@ public static int getHomeIndex() {
     }
 
     public static boolean isEmpty() {
-        return get().getHome() == null;
+        return get().getHome() == null || get().getHome().getGroups().isEmpty();
     }
 
     public LiveConfig init() {
@@ -99,6 +99,7 @@ public void parse(JsonObject object) {
         if (!object.has("lives")) return;
         for (JsonElement element : Json.safeListElement(object, "lives")) parse(Live.objectFrom(element));
         if (home == null) setHome(lives.isEmpty() ? new Live() : lives.get(0));
+        LiveParser.start(home);
     }
 
     private void parse(Live live) {

File: app/src/main/java/com/fongmi/android/tv/api/LiveParser.java
Patch:
@@ -25,6 +25,7 @@ private static String extract(String line, Pattern pattern) {
     }
 
     public static void start(Live live) {
+        if (live.getGroups().size() > 0) return;
         start(live, getText(live.getUrl()));
     }
 

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -24,7 +24,7 @@ public class ImgUtil {
     public static void load(String url, ImageView view) {
         view.setScaleType(ImageView.ScaleType.CENTER);
         if (TextUtils.isEmpty(url)) view.setImageResource(R.drawable.ic_img_error);
-        else Glide.with(App.get()).asBitmap().load(url).skipMemoryCache(true).sizeMultiplier(Prefers.getThumbnail()).signature(new ObjectKey(url + "_" + Prefers.getQuality())).placeholder(R.drawable.ic_img_loading).listener(getListener(view)).into(view);
+        else Glide.with(App.get()).asBitmap().load(url).skipMemoryCache(true).dontAnimate().sizeMultiplier(Prefers.getThumbnail()).signature(new ObjectKey(url + "_" + Prefers.getQuality())).placeholder(R.drawable.ic_img_loading).listener(getListener(view)).into(view);
     }
 
     private static RequestListener<Bitmap> getListener(ImageView view) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -277,14 +277,14 @@ private void setFlagActivated(Vod.Flag item) {
     private void seamless(Vod.Flag flag) {
         Vod.Flag.Episode episode = flag.find(mHistory.getVodRemarks());
         if (episode == null || episode.isActivated()) return;
-        if (mPlayers.getCurrentPosition() > 0) mHistory.setPosition(mPlayers.getCurrentPosition());
         mHistory.setVodRemarks(episode.getName());
         setEpisodeActivated(episode);
     }
 
     private void setEpisodeActivated(Vod.Flag.Episode item) {
         if (shouldEnterFullscreen(item)) return;
         mCurrent = mBinding.flag.getSelectedPosition();
+        if (mPlayers.getCurrentPosition() > 0) mHistory.update(mPlayers.getCurrentPosition(), mPlayers.getDuration());
         for (int i = 0; i < mFlagAdapter.size(); i++) ((Vod.Flag) mFlagAdapter.get(i)).toggle(mCurrent == i, item);
         mBinding.episode.setSelectedPosition(getEpisodePosition());
         notifyItemChanged(mBinding.episode, mEpisodeAdapter);

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -92,7 +92,7 @@ public void categoryContent(String tid, String page, boolean filter, HashMap<Str
                 return Result.fromJson(categoryContent);
             } else {
                 ArrayMap<String, String> params = new ArrayMap<>();
-                if (site.getType() == 1) params.put("f", new Gson().toJson(extend));
+                if (site.getType() == 1 && !extend.isEmpty()) params.put("f", new Gson().toJson(extend));
                 else if (site.getType() == 4) params.put("ext", Utils.getBase64(new Gson().toJson(extend)));
                 params.put("ac", site.getType() == 0 ? "videolist" : "detail");
                 params.put("t", tid);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingActivity.java
Patch:
@@ -92,7 +92,7 @@ public void setConfig(Config config) {
     }
 
     private void checkPermission() {
-        if (config.getUrl().startsWith("file/") && Build.VERSION.SDK_INT >= Build.VERSION_CODES.R && !Environment.isExternalStorageManager()) {
+        if (config.getUrl().startsWith("file") && Build.VERSION.SDK_INT >= Build.VERSION_CODES.R && !Environment.isExternalStorageManager()) {
             openSetting();
         } else if (config.getUrl().startsWith("file") && Build.VERSION.SDK_INT < Build.VERSION_CODES.R && ContextCompat.checkSelfPermission(this, Manifest.permission.READ_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
             launcherString.launch(Manifest.permission.READ_EXTERNAL_STORAGE);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -53,6 +53,7 @@
 import com.fongmi.android.tv.utils.ResUtil;
 import com.google.android.exoplayer2.Player;
 import com.google.android.exoplayer2.ui.StyledPlayerView;
+import com.google.android.exoplayer2.util.Log;
 
 import org.greenrobot.eventbus.EventBus;
 import org.greenrobot.eventbus.Subscribe;
@@ -266,7 +267,7 @@ private void setText(TextView view, int resId, String text) {
     }
 
     private void setFlagActivated(Vod.Flag item) {
-        if (item.isActivated()) return;
+        if (mFlagAdapter.size() == 0 || item.isActivated()) return;
         for (int i = 0; i < mFlagAdapter.size(); i++) ((Vod.Flag) mFlagAdapter.get(i)).setActivated(item);
         mBinding.flag.setSelectedPosition(mFlagAdapter.indexOf(item));
         mEpisodeAdapter.setItems(item.getEpisodes(), null);

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -73,6 +73,8 @@ public static String getSiteName(String key) {
     }
 
     public ApiConfig init() {
+        this.home = null;
+        this.wall = null;
         this.config = Config.vod();
         this.ads = new ArrayList<>();
         this.sites = new ArrayList<>();

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -49,6 +49,7 @@ public static int getHomeIndex() {
     }
 
     public LiveConfig init() {
+        this.home = null;
         this.config = Config.live();
         this.lives = new ArrayList<>();
         this.handler = new Handler(Looper.getMainLooper());
@@ -61,6 +62,7 @@ public LiveConfig config(Config config) {
     }
 
     public LiveConfig clear() {
+        this.home = null;
         this.lives.clear();
         this.lives.addAll(ApiConfig.get().getLives());
         return this;

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -168,6 +168,7 @@ private String parseExt(String ext) {
         if (ext.startsWith("http")) return ext;
         else if (ext.startsWith("file")) return FileUtil.read(ext);
         else if (ext.startsWith("img+")) return Decoder.getExt(ext);
+        else if (ext.contains("http") || ext.contains("file")) return ext;
         else if (ext.endsWith(".json") || ext.endsWith(".py")) return parseExt(Utils.convert(ext));
         return ext;
     }

File: app/src/main/java/com/fongmi/android/tv/api/Decoder.java
Patch:
@@ -88,9 +88,7 @@ private static String base64(String data) {
 
     private static String extract(String data) {
         Matcher matcher = Pattern.compile("[A-Za-z0-9]{8}\\*\\*").matcher(data);
-        if (!matcher.find()) return "";
-        String key = matcher.group();
-        return data.substring(data.indexOf(key) + key.length());
+        return matcher.find() ? data.substring(data.indexOf(matcher.group()) + 10) : "";
     }
 
     private static byte[] padEnd(String key) {

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -223,7 +223,7 @@ public String getAds() {
     }
 
     public Config getConfig() {
-        return config;
+        return config == null ? Config.vod() : config;
     }
 
     public Parse getParse() {

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -174,7 +174,7 @@ public List<Live> getLives() {
     }
 
     public Config getConfig() {
-        return config;
+        return config == null ? Config.live() : config;
     }
 
     public Live getHome() {

File: app/src/main/java/com/fongmi/android/tv/ui/activity/BaseActivity.java
Patch:
@@ -10,6 +10,7 @@
 import androidx.appcompat.app.AppCompatActivity;
 import androidx.viewbinding.ViewBinding;
 
+import com.fongmi.android.tv.R;
 import com.fongmi.android.tv.event.RefreshEvent;
 import com.fongmi.android.tv.utils.FileUtil;
 import com.fongmi.android.tv.utils.Prefers;
@@ -52,7 +53,8 @@ protected void initEvent() {
     private void setWall() {
         File file = FileUtil.getWall(Prefers.getWall());
         if (file.exists() && file.length() > 0) getWindow().setBackgroundDrawable(Drawable.createFromPath(file.getPath()));
-        else getWindow().setBackgroundDrawableResource(ResUtil.getDrawable(file.getName()));
+        else if (Prefers.getWall() > 0) getWindow().setBackgroundDrawableResource(ResUtil.getDrawable(file.getName()));
+        else getWindow().setBackgroundDrawableResource(R.drawable.wallpaper_1);
     }
 
     private void hackResources() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomLiveListView.java
Patch:
@@ -60,8 +60,8 @@ public interface Callback {
 
         void setUITimer();
 
-        void nextGroup();
+        boolean nextGroup();
 
-        void prevGroup();
+        boolean prevGroup();
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -253,8 +253,9 @@ private void addKeep(Channel item) {
     }
 
     private void delKeep(Channel item) {
-        if (mGroup.isKeep()) mChannelAdapter.remove(item); else getKeep().getChannel().remove(item);
+        if (mGroup.isKeep()) mChannelAdapter.remove(item);
         if (mChannelAdapter.size() == 0) mBinding.group.requestFocus();
+        getKeep().getChannel().remove(item);
         Keep.delete(item.getName());
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -141,7 +141,7 @@ private void getLive() {
         List<Group> items = new ArrayList<>();
         items.add(Group.create(ResUtil.getString(R.string.keep)));
         for (Group group : LiveConfig.get().getHome().getGroups()) (group.isHidden() ? mHides : items).add(group);
-        items.add(Group.create(ResUtil.getString(R.string.live_setting)));
+        //items.add(Group.create(ResUtil.getString(R.string.live_setting)));
         mGroupAdapter.setItems(items, null);
         LiveConfig.get().setKeep(items);
         setPosition(LiveConfig.get().getKeep(items));
@@ -253,8 +253,8 @@ private void addKeep(Channel item) {
     }
 
     private void delKeep(Channel item) {
-        if (mGroup.isKeep()) mChannelAdapter.remove(item);
-        else getKeep().getChannel().remove(item);
+        if (mGroup.isKeep()) mChannelAdapter.remove(item); else getKeep().getChannel().remove(item);
+        if (mChannelAdapter.size() == 0) mBinding.group.requestFocus();
         Keep.delete(item.getName());
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/Channel.java
Patch:
@@ -198,8 +198,8 @@ public Channel copy(Channel item) {
         setNumber(item.getNumber());
         setLogo(item.getLogo());
         setName(item.getName());
+        setUrls(item.getUrls());
         setUa(item.getName());
-        setUrl(item.getUrl());
         return this;
     }
 

File: app/src/main/java/com/fongmi/android/tv/db/dao/ConfigDao.java
Patch:
@@ -24,7 +24,4 @@ public abstract class ConfigDao extends BaseDao<Config> {
 
     @Query("DELETE FROM Config WHERE url = :url")
     public abstract void delete(String url);
-
-    @Query("DELETE FROM Config WHERE type = :type")
-    public abstract void delete(int type);
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -33,7 +33,6 @@
 import com.google.android.exoplayer2.Player;
 import com.google.android.exoplayer2.ui.AspectRatioFrameLayout;
 import com.google.android.exoplayer2.ui.StyledPlayerView;
-import com.google.android.exoplayer2.util.Log;
 
 import org.greenrobot.eventbus.EventBus;
 import org.greenrobot.eventbus.Subscribe;
@@ -56,7 +55,7 @@ public class LiveActivity extends BaseActivity implements GroupPresenter.OnClick
     private Runnable mR3;
 
     public static void start(Activity activity) {
-        if (LiveConfig.get().getHome().getGroups().isEmpty()) return;
+        if (LiveConfig.get().isEmpty()) return;
         activity.startActivity(new Intent(activity, LiveActivity.class));
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/LiveConfig.java
Patch:
@@ -94,7 +94,7 @@ private void parseConfig(String json, Callback callback) {
     private String getText(String url) throws Exception {
         if (url.startsWith("file")) return FileUtil.read(url);
         else if (url.startsWith("http")) return OKHttp.newCall(url).execute().body().string();
-        else if (url.length() % 4 == 0) return getText(new String(Base64.decode(url, Base64.DEFAULT)));
+        else if (url.length() > 0 && url.length() % 4 == 0) return getText(new String(Base64.decode(url, Base64.DEFAULT)));
         else return "";
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/LiveActivity.java
Patch:
@@ -55,6 +55,7 @@ public class LiveActivity extends BaseActivity implements GroupPresenter.OnClick
     private Runnable mR3;
 
     public static void start(Activity activity) {
+        if (LiveConfig.get().getHome().getGroups().isEmpty()) return;
         activity.startActivity(new Intent(activity, LiveActivity.class));
     }
 
@@ -119,6 +120,7 @@ private void setVideoView() {
 
     private void getLive() {
         mGroupAdapter.setItems(LiveConfig.get().getHome().getGroups(), null);
+        mBinding.group.setVisibility(mGroupAdapter.size() == 1 ? View.GONE : View.VISIBLE);
         setPosition(LiveConfig.get().getKeep());
     }
 

File: app/src/main/java/com/fongmi/android/tv/api/PyLoader.java
Patch:
@@ -36,7 +36,7 @@ public Spider getSpider(String key, String api, String ext) {
             if (spiders.containsKey(key)) return spiders.get(key);
             Method method = loader.getClass().getMethod("spider", Context.class, String.class, String.class);
             Spider spider = (Spider) method.invoke(loader, App.get(), api.split("py_")[1], ext);
-            spider.init(App.get());
+            spider.init(App.get(), ext);
             spiders.put(key, spider);
             return spider;
         } catch (Exception e) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/adapter/LiveAdapter.java
Patch:
@@ -10,6 +10,7 @@
 import com.fongmi.android.tv.bean.Live;
 import com.fongmi.android.tv.databinding.AdapterLiveBinding;
 
+import java.util.Collections;
 import java.util.List;
 
 public class LiveAdapter extends RecyclerView.Adapter<LiveAdapter.ViewHolder> {
@@ -20,6 +21,7 @@ public class LiveAdapter extends RecyclerView.Adapter<LiveAdapter.ViewHolder> {
     public LiveAdapter(OnClickListener listener) {
         this.mListener = listener;
         this.mItems = LiveConfig.get().getLives();
+        Collections.sort(mItems, new Live.Sorter());
     }
 
     public interface OnClickListener {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/HistoryDialog.java
Patch:
@@ -18,8 +18,8 @@ public class HistoryDialog implements ConfigAdapter.OnClickListener {
 
     private final DialogHistoryBinding binding;
     private final ConfigCallback callback;
+    private final ConfigAdapter adapter;
     private final AlertDialog dialog;
-    private ConfigAdapter adapter;
     private int type;
 
     public static HistoryDialog create(Activity activity) {
@@ -35,6 +35,7 @@ public HistoryDialog(Activity activity) {
         this.callback = (ConfigCallback) activity;
         this.binding = DialogHistoryBinding.inflate(LayoutInflater.from(activity));
         this.dialog = new MaterialAlertDialogBuilder(activity).setView(binding.getRoot()).create();
+        this.adapter = new ConfigAdapter(this);
     }
 
     public void show() {
@@ -45,7 +46,7 @@ public void show() {
     private void setRecyclerView() {
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
-        binding.recycler.setAdapter(adapter = new ConfigAdapter(this, type));
+        binding.recycler.setAdapter(adapter.addAll(type));
     }
 
     private void setDialog() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/LiveDialog.java
Patch:
@@ -20,7 +20,7 @@ public class LiveDialog implements LiveAdapter.OnClickListener {
     private final DialogLiveBinding binding;
     private final LiveCallback callback;
     private final AlertDialog dialog;
-    private LiveAdapter adapter;
+    private final LiveAdapter adapter;
 
     public static LiveDialog create(Activity activity) {
         return new LiveDialog(activity);
@@ -30,18 +30,18 @@ public LiveDialog(Activity activity) {
         this.callback = (LiveCallback) activity;
         this.binding = DialogLiveBinding.inflate(LayoutInflater.from(activity));
         this.dialog = new MaterialAlertDialogBuilder(activity).setView(binding.getRoot()).create();
+        this.adapter = new LiveAdapter(this);
     }
 
     public void show() {
-        if (LiveConfig.get().getLives().isEmpty()) return;
         setRecyclerView();
         setDialog();
     }
 
     private void setRecyclerView() {
+        binding.recycler.setAdapter(adapter);
         binding.recycler.setHasFixedSize(true);
         binding.recycler.addItemDecoration(new SpaceItemDecoration(1, 16));
-        binding.recycler.setAdapter(adapter = new LiveAdapter(this));
         binding.recycler.scrollToPosition(LiveConfig.getHomeIndex());
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/dialog/SiteDialog.java
Patch:
@@ -35,7 +35,6 @@ public SiteDialog(Activity activity) {
     }
 
     public void show() {
-        if (ApiConfig.get().getSites().isEmpty()) return;
         setRecyclerView();
         setDialog();
     }
@@ -48,6 +47,7 @@ private void setRecyclerView() {
     }
 
     private void setDialog() {
+        if (adapter.size() == 0) return;
         WindowManager.LayoutParams params = dialog.getWindow().getAttributes();
         params.width = (int) (ResUtil.getScreenWidthPx() * 0.4f);
         params.height = (int) (ResUtil.getScreenHeightPx() * 0.74f);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -570,7 +570,7 @@ public void onPlayerEvent(PlayerEvent event) {
     }
 
     private void checkPosition() {
-        mPlayers.seekTo(mHistory.getPosition());
+        mPlayers.seekTo(Math.max(mHistory.getOpening(), mHistory.getPosition()));
         Clock.get().setCallback(this);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -537,7 +537,6 @@ public void run() {
     public void onTimeChanged() {
         long duration = mPlayers.getDuration();
         long current = mPlayers.getCurrentPosition();
-        if (mHistory.getOpening() >= current) mPlayers.seekTo(mHistory.getOpening());
         if (mHistory.getEnding() > 0 && duration > 0 && mHistory.getEnding() + current >= duration) {
             Clock.get().setCallback(null);
             checkNext();

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomWebView.java
Patch:
@@ -114,7 +114,7 @@ private void post(Map<String, String> headers, String url) {
         handler.removeCallbacks(mTimer);
         handler.post(() -> {
             if (callback != null) callback.onParseSuccess(news, url, "");
-            SpiderDebug.log(url);
+            SpiderDebug.log(url + "," + headers);
             stop(false);
         });
     }

File: app/src/main/java/com/fongmi/android/tv/utils/FileUtil.java
Patch:
@@ -70,9 +70,9 @@ public static String read(String path) {
             BufferedReader br = new BufferedReader(new InputStreamReader(new FileInputStream(getLocal(path))));
             StringBuilder sb = new StringBuilder();
             String text;
-            while ((text = br.readLine()) != null) sb.append(text);
+            while ((text = br.readLine()) != null) sb.append(text).append("\n");
             br.close();
-            return sb.toString();
+            return Utils.substring(sb.toString());
         } catch (Exception e) {
             return "";
         }

File: app/src/main/java/com/fongmi/android/tv/utils/Sniffer.java
Patch:
@@ -8,8 +8,6 @@ public class Sniffer {
                     "http((?!http).){12,}?\\.(m3u8|mp4|flv|avi|mkv|rm|wmv|mpg)\\?.*|" +
                     "http((?!http).){12,}\\.(m3u8|mp4|flv|avi|mkv|rm|wmv|mpg)|" +
                     "http((?!http).)*?xg.php\\?id=|" +
-                    "http((?!http).)*?cdn-tos|" +
-                    "http((?!http).)*?obj/tos|" +
                     "http((?!http).)*?video/tos*"
     );
 }

File: app/src/main/java/com/fongmi/android/tv/api/JarLoader.java
Patch:
@@ -65,7 +65,7 @@ private File download(String jar) {
 
     public void parseJar(String key, String jar) {
         String[] texts = jar.split(";md5;");
-        String md5 = jar.startsWith("http") && texts.length > 1 ? texts[1].trim() : "";
+        String md5 = !jar.startsWith("file") && texts.length > 1 ? texts[1].trim() : "";
         jar = texts[0];
         if (md5.length() > 0 && FileUtil.equals(jar, md5)) {
             load(key, FileUtil.getJar(jar));

File: app/src/main/java/com/fongmi/android/tv/utils/FileUtil.java
Patch:
@@ -70,7 +70,7 @@ public static String read(String path) {
             BufferedReader br = new BufferedReader(new InputStreamReader(new FileInputStream(getLocal(path))));
             StringBuilder sb = new StringBuilder();
             String text;
-            while ((text = br.readLine()) != null) sb.append(text).append("\n");
+            while ((text = br.readLine()) != null) sb.append(text);
             br.close();
             return sb.toString();
         } catch (Exception e) {

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -84,7 +84,7 @@ public void loadConfig(Callback callback) {
     public void loadConfig(boolean cache, Callback callback) {
         new Thread(() -> {
             if (cache) loadCache(Prefers.getUrl(), callback);
-            else loadJson(Prefers.getUrl(), callback);
+            else loadConfig(Prefers.getUrl(), callback);
         }).start();
     }
 
@@ -94,7 +94,7 @@ private void loadCache(String url, Callback callback) {
         else handler.post(() -> callback.error(R.string.error_config_get));
     }
 
-    private void loadJson(String url, Callback callback) {
+    private void loadConfig(String url, Callback callback) {
         try {
             parseConfig(new Gson().fromJson(Decoder.getJson(url), JsonObject.class), callback);
         } catch (Exception e) {

File: app/src/main/java/com/fongmi/android/tv/api/Decoder.java
Patch:
@@ -64,9 +64,9 @@ private static byte[] padEnd(String key) {
     }
 
     private static byte[] decodeHex(String s) {
-        int len = s.length();
-        byte[] data = new byte[len / 2];
-        for (int i = 0; i < len; i += 2) data[i / 2] = (byte) ((Character.digit(s.charAt(i), 16) << 4) + Character.digit(s.charAt(i + 1), 16));
+        int len = s.length() / 2;
+        byte[] data = new byte[len];
+        for (int i = 0; i < len; i++) data[i] = Integer.valueOf(s.substring(i * 2, i * 2 + 2), 16).byteValue();
         return data;
     }
 }

File: app/src/main/java/com/fongmi/android/tv/utils/Updater.java
Patch:
@@ -22,7 +22,7 @@
 
 public class Updater implements View.OnClickListener {
 
-    private static final String URL = "https://github.com/FongMi/TV/raw/main/release/leanback.json";
+    private static final String URL = "https://raw.githubusercontent.com/FongMi/TV/release/release/leanback.json";
     private static final String PROXY = "https://ghproxy.com/";
 
     private final ExecutorService executor;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -473,10 +473,10 @@ private boolean hasFlag() {
     private void checkHistory() {
         mHistory = History.find(getHistoryKey());
         mHistory = mHistory == null ? createHistory() : mHistory;
+        setFlagActivated(mHistory.getFlag());
+        if (mHistory.isRevSort()) reverseEpisode();
         mControl.opening.setText(mPlayers.getStringForTime(mHistory.getOpening()));
         mControl.ending.setText(mPlayers.getStringForTime(mHistory.getEnding()));
-        if (mHistory.isRevSort()) reverseEpisode();
-        setFlagActivated(mHistory.getFlag());
     }
 
     private History createHistory() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -124,8 +124,7 @@ private void getVideo() {
 
     private void checkPage() {
         if (mScroller.getPage() != 1 || mAdapter.size() >= 4 || isFolder()) return;
-        mScroller.addPage();
-        getVideo(getTypeId(), "2");
+        if (mScroller.addPage()) getVideo(getTypeId(), "2");
     }
 
     private void getVideo(String typeId, String page) {

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -120,7 +120,7 @@ private void getCacheConfig(String url, Callback callback) {
     private void parseConfig(JsonObject object, Callback callback) {
         try {
             parseJson(object);
-            loader.parseJar(Json.safeString(object, "spider", ""));
+            loader.parseJar("", Json.safeString(object, "spider", ""));
             handler.post(() -> callback.success(object.toString()));
         } catch (Exception e) {
             e.printStackTrace();

File: app/src/main/java/com/fongmi/android/tv/utils/Utils.java
Patch:
@@ -65,6 +65,7 @@ public static String getBase64(String ext) {
 
     public static int getDigit(String text) {
         try {
+            if (text.startsWith("上") || text.startsWith("下")) return -1;
             if (text.contains(".")) text = text.substring(0, text.lastIndexOf("."));
             return Integer.parseInt(text.replaceAll("\\D+", ""));
         } catch (Exception e) {

File: app/src/main/java/com/fongmi/android/tv/player/ParseTask.java
Patch:
@@ -8,6 +8,7 @@
 import com.fongmi.android.tv.bean.Parse;
 import com.fongmi.android.tv.bean.Result;
 import com.fongmi.android.tv.net.OKHttp;
+import com.fongmi.android.tv.server.Server;
 import com.fongmi.android.tv.ui.custom.CustomWebView;
 import com.fongmi.android.tv.utils.Json;
 import com.google.gson.JsonObject;
@@ -104,7 +105,7 @@ private void checkResult(Result result) {
         if (result.getUrl().isEmpty()) {
             onParseError();
         } else if (result.getParse(0) == 1) {
-            handler.post(() -> webView.start(result.getUrl(), callback));
+            handler.post(() -> webView.start(Server.proxy(result.getUrl()), callback));
         } else {
             onParseSuccess(result.getHeaders(), result.getUrl(), result.getJxFrom());
         }

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -120,7 +120,7 @@ private void getCacheConfig(String url, Callback callback) {
     private void parseConfig(JsonObject object, Callback callback) {
         try {
             parseJson(object);
-            loader.parseJar("", Json.safeString(object, "spider", ""));
+            loader.parseJar(Json.safeString(object, "spider", ""));
             handler.post(() -> callback.success(object.toString()));
         } catch (Exception e) {
             e.printStackTrace();

File: app/src/main/java/com/fongmi/android/tv/bean/Vod.java
Patch:
@@ -298,9 +298,8 @@ public boolean isActivated() {
                 return activated;
             }
 
-            public Episode deactivated() {
+            public void deactivated() {
                 this.activated = false;
-                return this;
             }
 
             private void setActivated(Episode item) {
@@ -311,7 +310,8 @@ public boolean like(int number, String name) {
                 if (name.equalsIgnoreCase(getName())) return true;
                 if (name.toLowerCase().contains(getName().toLowerCase())) return true;
                 if (getName().toLowerCase().contains(name.toLowerCase())) return true;
-                return number != -1 && number == getNumber();
+                if (number != -1 && number == getNumber()) return true;
+                return false;
             }
 
             @Override

File: app/src/main/java/com/fongmi/android/tv/utils/Utils.java
Patch:
@@ -65,6 +65,7 @@ public static String getBase64(String ext) {
 
     public static int getDigit(String text) {
         try {
+            if (text.contains(".")) text = text.substring(0, text.lastIndexOf("."));
             return Integer.parseInt(text.replaceAll("\\D+", ""));
         } catch (Exception e) {
             return -1;

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -280,10 +280,10 @@ private void setFlagActivated(Vod.Flag item) {
 
     private void seamless(Vod.Flag flag) {
         Vod.Flag.Episode episode = flag.find(mHistory.getVodRemarks());
-        if (episode == null) return;
+        if (episode == null || episode.isActivated()) return;
         if (mPlayers.getCurrentPosition() > 0) mHistory.setPosition(mPlayers.getCurrentPosition());
         mHistory.setVodRemarks(episode.getName());
-        setEpisodeActivated(episode.deactivated());
+        setEpisodeActivated(episode);
     }
 
     private void setEpisodeActivated(Vod.Flag.Episode item) {

File: app/src/main/java/com/fongmi/android/tv/utils/Utils.java
Patch:
@@ -67,7 +67,7 @@ public static int getDigit(String text) {
         try {
             return Integer.parseInt(text.replaceAll("\\D+", ""));
         } catch (Exception e) {
-            return 0;
+            return -1;
         }
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomHorizontalGridView.java
Patch:
@@ -35,7 +35,7 @@ public CustomHorizontalGridView(@NonNull Context context, @Nullable AttributeSet
     @Override
     protected void initAttributes(@NonNull Context context, @Nullable AttributeSet attrs) {
         super.initAttributes(context, attrs);
-        this.shake = ResUtil.getAnim(R.anim.shake);
+        this.shake = isInEditMode() ? null : ResUtil.getAnim(R.anim.shake);
     }
 
     @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomRowPresenter.java
Patch:
@@ -15,7 +15,7 @@ public class CustomRowPresenter extends ListRowPresenter {
     private final int strategy;
 
     public CustomRowPresenter(int spacing) {
-        this(spacing, FocusHighlight.ZOOM_FACTOR_MEDIUM);
+        this(spacing, FocusHighlight.ZOOM_FACTOR_SMALL);
     }
 
     @SuppressLint("RestrictedApi")

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomVerticalGridView.java
Patch:
@@ -74,7 +74,7 @@ public boolean dispatchKeyEvent(KeyEvent event) {
     }
 
     public boolean moveToTop() {
-        if (views == null) return false;
+        if (views == null || getSelectedPosition() == 0) return false;
         for (View view : views) view.setVisibility(View.VISIBLE);
         for (View view : views) if (view.getId() == R.id.recycler) view.requestFocus();
         scrollToPosition(0);

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -222,6 +222,7 @@ public ApiConfig clear() {
         this.lives.clear();
         this.flags.clear();
         this.parses.clear();
+        this.loader.clear();
         this.home = null;
         return this;
     }

File: app/src/main/java/com/fongmi/android/tv/bean/History.java
Patch:
@@ -184,9 +184,9 @@ public static void delete(int cid) {
 
     private void checkMerge(List<History> items) {
         for (History item : items) {
-            if (Math.abs(item.getDuration() - getDuration()) > 10 * 60 * 1000) continue;
-            setOpening(item.getOpening());
-            setEnding(item.getEnding());
+            if (getKey().equals(item.getKey()) || Math.abs(item.getDuration() - getDuration()) > 10 * 60 * 1000) continue;
+            if (getOpening() == 0) setOpening(item.getOpening());
+            if (getEnding() == 0) setEnding(item.getEnding());
             item.delete();
         }
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -98,7 +98,6 @@ private void setRecyclerView() {
     private void setViewModel() {
         mViewModel = new ViewModelProvider(this).get(SiteViewModel.class);
         mViewModel.result.observe(this, result -> {
-            if (mExecutor == null) return;
             mAdapter.add(Collect.create(result.getList()));
             getFragment().addVideo(result.getList());
             mPageAdapter.notifyDataSetChanged();

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/CollectFragment.java
Patch:
@@ -72,7 +72,7 @@ private boolean checkLastSize(List<Vod> items) {
     }
 
     public void addVideo(List<Vod> items) {
-        if (checkLastSize(items)) return;
+        if (checkLastSize(items) || getActivity() == null || getActivity().isFinishing()) return;
         List<ListRow> rows = new ArrayList<>();
         for (List<Vod> part : Lists.partition(items, Prefers.getColumn())) {
             mLast = new ArrayObjectAdapter(new VodPresenter(this));

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -35,8 +35,10 @@ public Players init() {
     }
 
     private void setupPlayer() {
+        DefaultTrackSelector selector = new DefaultTrackSelector(App.get());
+        selector.setParameters(selector.getParameters().buildUpon().setPreferredTextLanguage("zh"));
         DefaultRenderersFactory factory = new DefaultRenderersFactory(App.get()).setEnableDecoderFallback(true).setExtensionRendererMode(DefaultRenderersFactory.EXTENSION_RENDERER_MODE_ON);
-        exoPlayer = new ExoPlayer.Builder(App.get()).setRenderersFactory(factory).setTrackSelector(new DefaultTrackSelector(App.get())).build();
+        exoPlayer = new ExoPlayer.Builder(App.get()).setRenderersFactory(factory).setTrackSelector(selector).build();
         exoPlayer.addListener(this);
     }
 

File: app/src/mobile/java/com/fongmi/android/tv/ui/activity/MainActivity.java
Patch:
@@ -45,6 +45,7 @@ protected void initView() {
     @Override
     protected void initEvent() {
         mBinding.navigation.setOnItemSelectedListener(this);
+        mBinding.navigation.setSelectedItemId(R.id.home);
     }
 
     @Override

File: app/src/main/java/com/fongmi/android/tv/bean/Collect.java
Patch:
@@ -12,7 +12,7 @@ public class Collect {
     private final List<Vod> list;
 
     public static Collect all() {
-        return new Collect(Site.get("all", ResUtil.getString(R.string.collect_all)), new ArrayList<>());
+        return new Collect(Site.get("all", ResUtil.getString(R.string.all)), new ArrayList<>());
     }
 
     public static Collect create(List<Vod> list) {

File: app/src/mobile/java/com/fongmi/android/tv/ui/adapter/VodAdapter.java
Patch:
@@ -83,6 +83,6 @@ public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
         holder.binding.remark.setText(item.getVodRemarks());
         holder.binding.year.setVisibility(item.getYearVisible());
         holder.binding.remark.setVisibility(item.getRemarkVisible());
-        ImgUtil.load(item.getVodName(), item.getVodPic(), holder.binding.image);
+        ImgUtil.load(item.getVodPic(), holder.binding.image);
     }
 }

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/HomeFragment.java
Patch:
@@ -13,7 +13,6 @@
 import com.fongmi.android.tv.bean.History;
 import com.fongmi.android.tv.bean.Vod;
 import com.fongmi.android.tv.databinding.FragmentHomeBinding;
-import com.fongmi.android.tv.db.AppDatabase;
 import com.fongmi.android.tv.model.SiteViewModel;
 import com.fongmi.android.tv.ui.activity.BaseFragment;
 import com.fongmi.android.tv.ui.adapter.HistoryAdapter;
@@ -69,7 +68,7 @@ private void getVideo() {
     }
 
     private void getHistory() {
-        mHistoryAdapter.addAll(AppDatabase.get().getHistoryDao().getAll());
+        mHistoryAdapter.addAll(History.get());
     }
 
     @Override

File: app/src/mobile/java/com/fongmi/android/tv/ui/fragment/SettingFragment.java
Patch:
@@ -19,7 +19,6 @@
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.Site;
 import com.fongmi.android.tv.databinding.FragmentSettingBinding;
-import com.fongmi.android.tv.db.AppDatabase;
 import com.fongmi.android.tv.event.RefreshEvent;
 import com.fongmi.android.tv.net.Callback;
 import com.fongmi.android.tv.ui.activity.BaseFragment;
@@ -63,7 +62,6 @@ public void setSite(Site item) {
     public void setConfig(String url) {
         mBinding.url.setText(url);
         Notify.progress(getActivity());
-        AppDatabase.clear();
         Prefers.putUrl(url);
         checkUrl(url);
     }

File: app/src/main/java/com/fongmi/android/tv/ui/custom/CustomWebView.java
Patch:
@@ -103,7 +103,7 @@ private void post(Map<String, String> headers, String url) {
         for (String key : headers.keySet()) if (keys.contains(key.toLowerCase())) news.put(key, headers.get(key));
         handler.removeCallbacks(mTimer);
         handler.post(() -> {
-            callback.onParseSuccess(news, url, "");
+            if (callback != null) callback.onParseSuccess(news, url, "");
             stop(false);
         });
     }
@@ -113,5 +113,6 @@ public void stop(boolean error) {
         loadUrl("about:blank");
         handler.removeCallbacks(mTimer);
         if (error) handler.post(() -> callback.onParseError());
+        else callback = null;
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/CollectActivity.java
Patch:
@@ -72,7 +72,6 @@ protected void initView() {
 
     @Override
     protected void initEvent() {
-        mBinding.recycler.addOnScrollListener(new CustomScroller());
         mBinding.pager.addOnPageChangeListener(new ViewPager.SimpleOnPageChangeListener() {
             @Override
             public void onPageSelected(int position) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/HistoryPresenter.java
Patch:
@@ -83,8 +83,6 @@ private void setClickListener(View root, History item) {
 
     @Override
     public void onUnbindViewHolder(Presenter.ViewHolder viewHolder) {
-        ViewHolder holder = (ViewHolder) viewHolder;
-        Glide.with(App.get()).clear(holder.binding.image);
     }
 
     public static class ViewHolder extends Presenter.ViewHolder {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -163,10 +163,10 @@ private void getHistory() {
     }
 
     private void getHistory(boolean renew) {
+        List<History> items = History.get();
         int historyIndex = getHistoryIndex();
         int recommendIndex = getRecommendIndex();
         boolean exist = recommendIndex - historyIndex == 2;
-        List<History> items = History.find(ApiConfig.getCid());
         if (renew) mHistoryAdapter = new ArrayObjectAdapter(mHistoryPresenter = new HistoryPresenter(this));
         if ((items.isEmpty() && exist) || (renew && exist)) mAdapter.removeItems(historyIndex, 1);
         if ((items.size() > 0 && !exist) || (renew && exist)) mAdapter.add(historyIndex, new ListRow(mHistoryAdapter));

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/HistoryPresenter.java
Patch:
@@ -13,7 +13,6 @@
 import com.fongmi.android.tv.api.ApiConfig;
 import com.fongmi.android.tv.bean.History;
 import com.fongmi.android.tv.databinding.AdapterVodBinding;
-import com.fongmi.android.tv.utils.ImgUtil;
 import com.fongmi.android.tv.utils.Prefers;
 import com.fongmi.android.tv.utils.ResUtil;
 
@@ -64,14 +63,14 @@ public Presenter.ViewHolder onCreateViewHolder(ViewGroup parent) {
     public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         History item = (History) object;
         ViewHolder holder = (ViewHolder) viewHolder;
+        setClickListener(holder.view, item);
         holder.binding.name.setText(item.getVodName());
         holder.binding.site.setText(ApiConfig.getSiteName(item.getSiteKey()));
         holder.binding.remark.setText(ResUtil.getString(R.string.vod_last, item.getVodRemarks()));
         holder.binding.site.setVisibility(delete ? View.GONE : View.VISIBLE);
         holder.binding.remark.setVisibility(delete ? View.GONE : View.VISIBLE);
         holder.binding.delete.setVisibility(!delete ? View.GONE : View.VISIBLE);
-        ImgUtil.load(item.getVodPic(), holder.binding.image);
-        setClickListener(holder.view, item);
+        Glide.with(App.get()).load(item.getVodPic()).centerCrop().error(R.drawable.ic_img_error).placeholder(R.drawable.ic_img_loading).into(holder.binding.image);
     }
 
     private void setClickListener(View root, History item) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/VodPresenter.java
Patch:
@@ -57,7 +57,7 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         holder.binding.site.setVisibility(item.getSiteVisible());
         holder.binding.year.setVisibility(item.getYearVisible());
         holder.binding.remark.setVisibility(item.getRemarkVisible());
-        ImgUtil.load(item.getVodName(), item.getVodPic(), holder.binding.image);
+        ImgUtil.load(item.getVodPic(), holder.binding.image);
         setOnClickListener(holder, view -> mListener.onItemClick(item));
         holder.view.setOnLongClickListener(v -> mListener.onLongClick(item));
     }

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -42,7 +42,7 @@ public static MediaSource getSource(Result result) {
     }
 
     public static MediaSource getSource(Map<String, String> headers, String url) {
-        return getSource(headers, url, null);
+        return getSource(headers, url, Collections.emptyList());
     }
 
     private static MediaSource getSource(Map<String, String> headers, String url, List<MediaItem.SubtitleConfiguration> config) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -198,7 +198,7 @@ public void onItemClick(Func item) {
 
     @Override
     public void onItemClick(Vod item) {
-        if (item.getVodId().startsWith("msearch:")) onLongClick(item);
+        if (item.shouldSearch()) onLongClick(item);
         else DetailActivity.start(this, item.getVodId());
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -182,8 +182,8 @@ public void goBack() {
 
     @Override
     public void onItemClick(Vod item) {
-        if (item.getVodTag().equals("folder")) getVideo(item.getVodId(), "1");
-        else if (item.getVodId().startsWith("msearch:")) onLongClick(item);
+        if (item.shouldSearch()) onLongClick(item);
+        else if (item.getVodTag().equals("folder")) getVideo(item.getVodId(), "1");
         else DetailActivity.start(getActivity(), item.getVodId());
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -121,10 +121,10 @@ private void checkPage() {
 
     private void getVideo(String typeId, String page) {
         if (page.equals("1")) mLast = null;
+        if (isFolder()) mTypeIds.add(typeId);
         boolean clear = page.equals("1") && mAdapter.size() > mFilters.size();
         if (clear) mAdapter.removeItems(mFilters.size(), mAdapter.size() - mFilters.size());
         mViewModel.categoryContent(typeId, page, true, mExtend);
-        mTypeIds.add(typeId);
     }
 
     private boolean checkLastSize(List<Vod> items) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -276,13 +276,12 @@ public void onBackPressed() {
             Notify.show(R.string.app_exit);
             mHandler.postDelayed(() -> mConfirmExit = false, 1000);
         } else {
+            release();
             super.onBackPressed();
         }
     }
 
-    @Override
-    protected void onDestroy() {
-        super.onDestroy();
+    private void release() {
         Server.get().stop();
         Clock.get().release();
         Players.get().release();

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/PartPresenter.java
Patch:
@@ -7,6 +7,7 @@
 import androidx.leanback.widget.Presenter;
 
 import com.fongmi.android.tv.databinding.AdapterPartBinding;
+import com.fongmi.android.tv.utils.ResUtil;
 
 public class PartPresenter extends Presenter {
 
@@ -35,6 +36,7 @@ public void onBindViewHolder(Presenter.ViewHolder viewHolder, Object object) {
         String text = object.toString();
         ViewHolder holder = (ViewHolder) viewHolder;
         holder.binding.text.setText(text);
+        holder.binding.text.setMaxEms(ResUtil.getEms());
         holder.binding.text.setNextFocusUpId(nextFocus);
         setOnClickListener(holder, view -> mListener.onItemClick(text));
     }

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -161,10 +161,10 @@ public void searchContent(Site site, String keyword) {
                 post(site, Result.fromJson(searchContent));
             } else {
                 HashMap<String, String> params = new HashMap<>();
-                if (site.getType() != 0) params.put("ac", "detail");
+                if (site.getType() == 1) params.put("ac", "detail");
                 params.put("wd", keyword);
                 String body = OKHttp.newCall(site.getApi(), params).execute().body().string();
-                SpiderDebug.log(body);
+                SpiderDebug.log(site.getName() +"," +body);
                 if (site.getType() == 0) post(site, Result.fromXml(body));
                 else post(site, Result.fromJson(body));
             }

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomKeyboard.java
Patch:
@@ -43,9 +43,7 @@ public void onIconClick(int resId) {
         int cursor = binding.keyword.getSelectionStart();
         switch (resId) {
             case R.drawable.ic_keyboard_space:
-                sb.insert(cursor, " ");
-                binding.keyword.setText(sb.toString());
-                binding.keyword.setSelection(cursor + 1);
+                onTextClick(" ");
                 break;
             case R.drawable.ic_keyboard_left:
                 binding.keyword.setSelection(--cursor < 0 ? 0 : cursor);

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomKeyboard.java
Patch:
@@ -30,7 +30,7 @@ private void initView() {
     public void onTextClick(String text) {
         StringBuilder sb = new StringBuilder(binding.keyword.getText().toString());
         int cursor = binding.keyword.getSelectionStart();
-        if (binding.keyword.length() > 29) return;
+        if (binding.keyword.length() > 19) return;
         sb.insert(cursor, text);
         binding.keyword.setText(sb.toString());
         binding.keyword.setSelection(cursor + 1);

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/CollectFragment.java
Patch:
@@ -60,7 +60,7 @@ private void setRecyclerView() {
         CustomSelector selector = new CustomSelector();
         selector.addPresenter(ListRow.class, new CustomRowPresenter(16), VodPresenter.class);
         mBinding.recycler.setAdapter(new ItemBridgeAdapter(mAdapter = new ArrayObjectAdapter(selector)));
-        mBinding.recycler.setTabView(getActivity().findViewById(R.id.header));
+        mBinding.recycler.setHeader(getActivity().findViewById(R.id.hint), getActivity().findViewById(R.id.recycler));
         mBinding.recycler.setVerticalSpacing(ResUtil.dp2px(16));
         addVideo(Vod.arrayFrom(getJson()));
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -83,7 +83,7 @@ private void setRecyclerView() {
         selector.addPresenter(ListRow.class, new CustomRowPresenter(8), FilterPresenter.class);
         mBinding.recycler.addOnScrollListener(mScroller = new CustomScroller(this));
         mBinding.recycler.setAdapter(new ItemBridgeAdapter(mAdapter = new ArrayObjectAdapter(selector)));
-        mBinding.recycler.setTabView(getActivity().findViewById(R.id.recycler));
+        mBinding.recycler.setHeader(getActivity().findViewById(R.id.recycler));
         mBinding.recycler.setVerticalSpacing(ResUtil.dp2px(16));
     }
 

File: app/src/main/java/com/fongmi/android/tv/player/ExoUtil.java
Patch:
@@ -27,7 +27,7 @@ public static MediaSource getSource(Map<String, String> headers, String url) {
         DataSource.Factory factory = getFactory(headers, url);
         MediaItem mediaItem = new MediaItem.Builder().setUri(videoUri).build();
         int type = Util.inferContentType(videoUri);
-        if (type == C.CONTENT_TYPE_HLS || url.contains("php") || url.contains("m3u8") || Players.get().getRetry() > 0) {
+        if (type == C.CONTENT_TYPE_HLS || url.contains("php") || url.contains("m3u8")) {
             return new HlsMediaSource.Factory(factory).createMediaSource(mediaItem);
         } else if (type == C.CONTENT_TYPE_DASH) {
             return new DashMediaSource.Factory(factory).createMediaSource(mediaItem);

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -34,6 +34,7 @@ private static RequestListener<Bitmap> getListener(String vodName, ImageView vie
         return new RequestListener<>() {
             @Override
             public boolean onLoadFailed(@Nullable GlideException e, Object model, Target<Bitmap> target, boolean isFirstResource) {
+                view.setScaleType(ImageView.ScaleType.CENTER);
                 ImgUtil.onLoadFailed(vodName, view);
                 return true;
             }
@@ -50,10 +51,8 @@ private static void onLoadFailed(String vodName, ImageView view) {
         String text = vodName.isEmpty() ? "" : vodName.substring(0, 1);
         if (text.isEmpty()) {
             view.setImageResource(R.drawable.ic_img_error);
-            view.setScaleType(ImageView.ScaleType.CENTER);
         } else {
-            view.setImageDrawable(TextDrawable.builder().buildRect(text, ColorGenerator.MATERIAL.getColor(text)));
-            view.setScaleType(ImageView.ScaleType.CENTER_CROP);
+            view.setImageDrawable(TextDrawable.builder().beginConfig().width(view.getWidth()).height(view.getHeight()).endConfig().buildRect(text, ColorGenerator.MATERIAL.getColor(text)));
         }
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -258,7 +258,6 @@ protected void onDestroy() {
         Server.get().stop();
         Clock.get().release();
         Players.get().release();
-        ApiConfig.get().release();
         EventBus.getDefault().unregister(this);
     }
 }
\ No newline at end of file

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -375,7 +375,7 @@ private History createHistory() {
     }
 
     private void updateHistory(Vod.Flag.Episode item, boolean replay) {
-        replay = replay || !item.getUrl().equals(mHistory.getEpisodeUrl());
+        replay = replay || !item.equals(mHistory.getEpisode());
         long duration = replay ? 0 : mHistory.getDuration();
         mHistory.setDuration(duration);
         mHistory.setEpisodeUrl(item.getUrl());

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -406,7 +406,7 @@ public void run() {
             long duration = Players.get().getDuration();
             long current = Players.get().getCurrentPosition();
             if (mHistory.getOpening() >= current) Players.get().seekTo(mHistory.getOpening());
-            if (mHistory.getEnding() > 0 && mHistory.getEnding() + current >= duration) {
+            if (mHistory.getEnding() > 0 && duration > 0 && mHistory.getEnding() + current >= duration) {
                 keep = false;
                 onNext();
             }

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -140,7 +140,7 @@ private String parseExt(String ext) {
 
     private void parseJar(String spider) throws Exception {
         String[] texts = spider.split(";md5;");
-        String md5 = texts.length > 1 ? texts[1].trim() : "";
+        String md5 = spider.startsWith("http") && texts.length > 1 ? texts[1].trim() : "";
         String url = texts[0];
         if (md5.length() > 0 && FileUtil.equals(md5)) {
             loader.load(FileUtil.getJar());

File: app/src/main/java/com/fongmi/android/tv/utils/FileUtil.java
Patch:
@@ -17,7 +17,6 @@
 import java.io.File;
 import java.io.FileInputStream;
 import java.io.FileOutputStream;
-import java.io.IOException;
 import java.io.InputStreamReader;
 import java.net.URLConnection;
 
@@ -79,7 +78,7 @@ public static String read(String path) {
         }
     }
 
-    public static boolean equals(String md5) throws IOException {
+    public static boolean equals(String md5) throws Exception {
         return Files.hash(FileUtil.getJar(), Hashing.md5()).toString().equalsIgnoreCase(md5);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -442,7 +442,6 @@ private void checkPosition() {
         Players.get().seekTo(mHistory.getDuration());
         stopTimer();
         setTimer();
-        mRetry = 0;
     }
 
     private void stopTimer() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -253,6 +253,7 @@ private void setEpisodeActivated(Vod.Flag.Episode item) {
         for (int i = 0; i < mFlagAdapter.size(); i++) ((Vod.Flag) mFlagAdapter.get(i)).toggle(mCurrent == i, item);
         mEpisodeAdapter.notifyArrayItemRangeChanged(0, mEpisodeAdapter.size());
         mHandler.post(() -> mBinding.episode.setSelectedPosition(getEpisodePosition()));
+        if (mEpisodeAdapter.size() == 0) return;
         getPlayer(false);
     }
 

File: app/src/main/java/com/fongmi/android/tv/utils/Json.java
Patch:
@@ -24,6 +24,7 @@ public static List<String> safeList(JsonObject obj, String key) {
     }
 
     public static JsonObject safeObject(JsonElement element) {
+        if (element.getAsString().isEmpty()) return null;
         if (element.isJsonObject()) return element.getAsJsonObject();
         else if (element.isJsonPrimitive()) return JsonParser.parseString(element.getAsJsonPrimitive().getAsString()).getAsJsonObject();
         return null;

File: app/src/main/java/com/fongmi/android/tv/bean/Vod.java
Patch:
@@ -147,7 +147,7 @@ public void setVodFlags() {
         String[] playFlags = getVodPlayFrom().split("\\$\\$\\$");
         String[] playUrls = getVodPlayUrl().split("\\$\\$\\$");
         for (int i = 0; i < playFlags.length; i++) {
-            if (playFlags[i].isEmpty()) continue;
+            if (playFlags[i].isEmpty() || i >= playUrls.length) continue;
             Vod.Flag item = new Vod.Flag(playFlags[i]);
             item.createEpisode(playUrls[i]);
             getVodFlags().add(item);

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -190,6 +190,7 @@ private void execute(MutableLiveData<Result> result, Callable<Result> callable)
             try {
                 if (!Thread.interrupted()) result.postValue(service.submit(callable).get(15, TimeUnit.SECONDS));
             } catch (Exception e) {
+                e.printStackTrace();
                 if (e instanceof InterruptedException) return;
                 if (!Thread.interrupted()) result.postValue(new Result());
             }

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -168,7 +168,7 @@ public void searchContent(String key, String keyword) {
                 if (site.getType() == 0) postSearch(site, Result.fromXml(body));
                 else postSearch(site, Result.fromJson(body));
             }
-        } catch (Exception e) {
+        } catch (Exception | NoClassDefFoundError e) {
             e.printStackTrace();
         }
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/ConfigDialog.java
Patch:
@@ -44,7 +44,7 @@ public void create(Activity activity) {
 
     private void initDialog() {
         WindowManager.LayoutParams params = dialog.getWindow().getAttributes();
-        params.width = (int) (ResUtil.getScreenWidthPx() * 0.65f);
+        params.width = (int) (ResUtil.getScreenWidthPx() * 0.7f);
         dialog.getWindow().setAttributes(params);
         dialog.getWindow().setDimAmount(0);
         dialog.setOnDismissListener(this);
@@ -55,7 +55,7 @@ private void initView() {
         String address = Server.get().getAddress(false);
         binding.text.setText(Prefers.getUrl());
         binding.text.setSelection(binding.text.getText().length());
-        binding.code.setImageBitmap(QRCode.getBitmap(address, 180, 0));
+        binding.code.setImageBitmap(QRCode.getBitmap(address, 200, 0));
         binding.info.setText(ResUtil.getString(R.string.dialog_config_info, address));
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/SiteDialog.java
Patch:
@@ -38,7 +38,7 @@ public void create(Activity activity) {
     private void initDialog() {
         WindowManager.LayoutParams params = dialog.getWindow().getAttributes();
         params.width = (int) (ResUtil.getScreenWidthPx() * 0.45f);
-        params.height = (int) (ResUtil.getScreenHeightPx() * 0.8f);
+        params.height = (int) (ResUtil.getScreenHeightPx() * 0.85f);
         dialog.getWindow().setAttributes(params);
         dialog.getWindow().setDimAmount(0);
         dialog.show();

File: app/src/main/java/com/fongmi/android/tv/bean/Result.java
Patch:
@@ -127,8 +127,8 @@ public String getJxFrom() {
         return TextUtils.isEmpty(jxFrom) ? "" : jxFrom;
     }
 
-    public Integer getParse() {
-        return parse == null ? 1 : parse;
+    public Integer getParse(Integer def) {
+        return parse == null ? def : parse;
     }
 
     public void setParse(Integer parse) {

File: app/src/main/java/com/fongmi/android/tv/player/ParseTask.java
Patch:
@@ -88,7 +88,7 @@ private void jsonExtend(String webUrl) {
         Result result = Result.fromObject(ApiConfig.get().jsonExt(parse.getUrl(), jxs, webUrl));
         if (result.getUrl().isEmpty()) {
             onParseError();
-        } else if (result.getParse() == 1) {
+        } else if (result.getParse(0) == 1) {
             handler.post(() -> Players.get().web().start(result.getUrl(), callback));
         } else {
             onParseSuccess(result.getHeaders(), result.getUrl(), result.getJxFrom());
@@ -107,7 +107,7 @@ private void jsonMix(String webUrl, String flag) {
         Result result = Result.fromObject(ApiConfig.get().jsonExtMix(flag + "@", parse.getUrl(), parse.getName(), jxs, webUrl));
         if (result.getUrl().isEmpty()) {
             onParseError();
-        } else if (result.getParse() == 1) {
+        } else if (result.getParse(0) == 1) {
             handler.post(() -> Players.get().web().start(result.getUrl(), callback));
         } else {
             onParseSuccess(result.getHeaders(), result.getUrl(), result.getJxFrom());

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -109,7 +109,7 @@ public boolean isIdle() {
     public void setMediaSource(Result result, boolean useParse) {
         if (result.getUrl().isEmpty()) {
             PlayerEvent.error(R.string.error_play_load);
-        } else if (result.getParse() == 1 || result.getJx() == 1) {
+        } else if (result.getParse(1) == 1 || result.getJx() == 1) {
             if (parseTask != null) parseTask.cancel();
             parseTask = ParseTask.create(this).run(result, useParse);
         } else {

File: app/src/main/java/com/fongmi/android/tv/api/ApiConfig.java
Patch:
@@ -203,6 +203,7 @@ public Site getHome() {
 
     public void setHome(Site home) {
         this.home = home;
+        this.home.setActivated(true);
         Prefers.putHome(home.getKey());
         for (Site item : sites) item.setActivated(home);
     }
@@ -213,6 +214,7 @@ public Parse getParse() {
 
     public void setParse(Parse parse) {
         this.parse = parse;
+        this.parse.setActivated(true);
         Prefers.putParse(parse.getName());
         for (Parse item : parses) item.setActivated(parse);
     }

File: app/src/main/java/com/fongmi/android/tv/bean/Parse.java
Patch:
@@ -64,11 +64,11 @@ public void setUrl(String url) {
     }
 
     public Ext getExt() {
-        return ext;
+        return ext == null ? new Ext() : ext;
     }
 
     public boolean hasHeader() {
-        return getExt() != null && getExt().getHeader() != null;
+        return getExt().getHeader() != null;
     }
 
     public JsonElement getHeader() {
@@ -77,7 +77,7 @@ public JsonElement getHeader() {
 
     public String mixUrl() {
         int index = getUrl().indexOf("?");
-        if (getExt() == null || index == -1) return getUrl();
+        if (index == -1) return getUrl();
         return getUrl().substring(0, index + 1) + "cat_ext=" + Base64.encodeToString(getExt().toString().getBytes(), Base64.DEFAULT | Base64.URL_SAFE | Base64.NO_WRAP) + "&" + getUrl().substring(index + 1);
     }
 

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -141,7 +141,7 @@ public void playerContent(String key, String flag, String id) {
                 result.setUrl(id);
                 result.setFlag(flag);
                 result.setPlayUrl(site.getPlayerUrl());
-                result.setParse(Utils.isVideoFormat(id) ? "0" : "1");
+                result.setParse(Utils.isVideoFormat(id) ? 0 : 1);
                 return result;
             }
         });

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -106,7 +106,7 @@ public boolean isIdle() {
     public void setMediaSource(Result result) {
         if (result.getUrl().isEmpty()) {
             PlayerEvent.error(R.string.error_play_load);
-        } else if (result.getParse().equals("1") || result.getJx().equals("1")) {
+        } else if (result.getParse() == 1 || result.getJx() == 1) {
             ParseTask.create(this).run(result);
         } else {
             setMediaSource(result.getHeaders(), result.getPlayUrl() + result.getUrl());

File: app/src/main/java/com/fongmi/android/tv/player/Players.java
Patch:
@@ -167,7 +167,7 @@ public void onParseError() {
 
     @Override
     public void onPlayerError(@NonNull PlaybackException error) {
-        PlayerEvent.error(R.string.error_play_format);
+        PlayerEvent.error(R.string.error_play_format, true);
     }
 
     @Override

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -380,7 +380,7 @@ public void run() {
             long duration = Players.get().getDuration();
             long current = Players.get().getCurrentPosition();
             if (mHistory.getOpening() >= current) Players.get().seekTo(mHistory.getOpening());
-            if (duration > 0 && mHistory.getEnding() + current >= duration) {
+            if (mHistory.getEnding() > 0 && mHistory.getEnding() + current >= duration) {
                 keep = false;
                 onNext();
             }

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -186,6 +186,7 @@ private void execute(MutableLiveData<Result> result, Callable<Result> callable)
             try {
                 if (!Thread.interrupted()) result.postValue(service.submit(callable).get(15, TimeUnit.SECONDS));
             } catch (Exception e) {
+                if (e instanceof InterruptedException) return;
                 if (!Thread.interrupted()) result.postValue(new Result());
             }
         });

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SearchActivity.java
Patch:
@@ -137,7 +137,7 @@ public void onResults(String result) {
                 mBinding.search.requestFocus();
                 mBinding.voice.clearAnimation();
                 mBinding.keyword.setText(result);
-                mBinding.keyword.setSelection(result.length());
+                mBinding.keyword.setSelection(mBinding.keyword.length());
             }
         });
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -121,7 +121,7 @@ private void getVideo(String page) {
     }
 
     private boolean checkLastSize(List<Vod> items) {
-        if (mLast == null) return false;
+        if (mLast == null || items.size() == 0) return false;
         int size = 5 - mLast.size();
         if (size == 0) return false;
         mLast.addAll(mLast.size(), new ArrayList<>(items.subList(0, size)));

File: app/src/main/java/com/fongmi/android/tv/utils/Clock.java
Patch:
@@ -39,6 +39,7 @@ private void run(TextView view) {
         timer.schedule(new TimerTask() {
             @Override
             public void run() {
+                if (formatter == null) return;
                 handler.post(() -> view.setText(formatter.format(new Date())));
             }
         }, 0, 1000);

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -146,7 +146,7 @@ private void addFilter() {
     public void toggleFilter(boolean open) {
         if (open) {
             addFilter();
-            mBinding.recycler.postDelayed(() -> mBinding.recycler.smoothScrollToPosition(0), 100);
+            mBinding.recycler.postDelayed(() -> mBinding.recycler.smoothScrollToPosition(0), 50);
         } else {
             mAdapter.removeItems(0, mFilters.size());
         }

File: app/src/main/java/com/fongmi/android/tv/bean/History.java
Patch:
@@ -119,6 +119,6 @@ public Vod.Flag getFlag() {
     }
 
     public Vod.Flag.Episode getEpisode() {
-        return new Vod.Flag.Episode(getEpisodeUrl());
+        return new Vod.Flag.Episode(getVodRemarks(), getEpisodeUrl());
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -247,7 +247,7 @@ private void setGroup(int size) {
     }
 
     private boolean shouldEnterFullscreen(Vod.Flag.Episode item) {
-        boolean enter = !mFullscreen && item.isActivated();
+        boolean enter = !mFullscreen && item.isActivated() && !Players.get().isIdle();
         if (enter) enterFullscreen();
         return enter;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -229,7 +229,6 @@ private void setFlagActivated(Vod.Flag item) {
     }
 
     private void setEpisodeActivated(Vod.Flag.Episode item) {
-        if (shouldEnterFullscreen()) return;
         mCurrent = mBinding.flag.getSelectedPosition();
         for (int i = 0; i < mFlagAdapter.size(); i++) ((Vod.Flag) mFlagAdapter.get(i)).toggle(mCurrent == i, item);
         mEpisodeAdapter.notifyArrayItemRangeChanged(0, mEpisodeAdapter.size());
@@ -245,8 +244,8 @@ private void setGroup(int size) {
         mGroupAdapter.setItems(items, null);
     }
 
-    private boolean shouldEnterFullscreen() {
-        boolean enter = !mFullscreen && mBinding.episode.getSelectedPosition() == getEpisodePosition();
+    private boolean shouldEnterFullscreen(Vod.Flag.Episode item) {
+        boolean enter = !mFullscreen && item.getUrl().equals(mHistory.getEpisodeUrl());
         if (enter) enterFullscreen();
         return enter;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -246,7 +246,7 @@ private void setGroup(int size) {
     }
 
     private boolean shouldEnterFullscreen() {
-        boolean enter = mBinding.episode.getSelectedPosition() == getEpisodePosition();
+        boolean enter = !mFullscreen && mBinding.episode.getSelectedPosition() == getEpisodePosition();
         if (enter) enterFullscreen();
         return enter;
     }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -137,7 +137,7 @@ protected void initEvent() {
         mBinding.flag.addOnChildViewHolderSelectedListener(new OnChildViewHolderSelectedListener() {
             @Override
             public void onChildViewHolderSelected(@NonNull RecyclerView parent, @Nullable RecyclerView.ViewHolder child, int position, int subposition) {
-                setFlagActivated((Vod.Flag) mFlagAdapter.get(position));
+                if (mFlagAdapter.size() > 0) setFlagActivated((Vod.Flag) mFlagAdapter.get(position));
             }
         });
         mBinding.group.addOnChildViewHolderSelectedListener(new OnChildViewHolderSelectedListener() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/SettingActivity.java
Patch:
@@ -38,7 +38,7 @@ public class SettingActivity extends BaseActivity implements ConfigDialog.Callba
     private ActivitySettingBinding mBinding;
 
     public static void start(Activity activity) {
-        activity.startActivity(new Intent(activity, SettingActivity.class));
+        activity.startActivityForResult(new Intent(activity, SettingActivity.class), 1000);
     }
 
     private final ActivityResultLauncher<String> launcherString = registerForActivityResult(new ActivityResultContracts.RequestPermission(), isGranted -> loadConfig());
@@ -121,7 +121,7 @@ public void setSite(ArrayObjectAdapter adapter, Site item) {
         mBinding.home.setText(item.getName());
         for (int i = 0; i < adapter.size(); i++) ((Site) adapter.get(i)).setHome(item);
         adapter.notifyArrayItemRangeChanged(0, adapter.size());
-        EventBus.getDefault().post(RefreshEvent.video());
+        setResult(RESULT_OK);
         Notify.dismiss();
     }
 

File: app/src/main/java/com/fongmi/android/tv/utils/Utils.java
Patch:
@@ -47,7 +47,7 @@ public static String getUserAgent() {
 
     public static boolean isVideoFormat(String url) {
         if (url.contains("=http") || url.contains("=https") || url.contains("=https%3a%2f") || url.contains("=http%3a%2f")) return false;
-        if (SNIFFER.matcher(url).find()) return !url.contains("cdn-tos") || (!url.contains(".js") && !url.contains(".css"));
+        if (SNIFFER.matcher(url).find() || url.endsWith(".m3u8")) return !url.contains("cdn-tos") || (!url.contains(".js") && !url.contains(".css"));
         return false;
     }
 }

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -5,7 +5,6 @@
 import android.os.Handler;
 import android.os.Looper;
 import android.text.Html;
-import android.util.Log;
 import android.view.KeyEvent;
 import android.view.View;
 import android.view.ViewGroup;
@@ -74,7 +73,7 @@ private String getId() {
     }
 
     private String getHistoryKey() {
-        return getKey().concat("@@@").concat(getId());
+        return getKey().concat(AppDatabase.SYMBOL).concat(getId());
     }
 
     private Vod.Flag getVodFlag() {

File: app/src/main/java/com/fongmi/android/tv/db/AppDatabase.java
Patch:
@@ -14,6 +14,7 @@
 public abstract class AppDatabase extends RoomDatabase {
 
     public static final int VERSION = 4;
+    public static final String SYMBOL = "@@@";
 
     private static volatile AppDatabase instance;
 

File: app/src/main/java/com/fongmi/android/tv/bean/History.java
Patch:
@@ -109,7 +109,7 @@ public String getSiteKey() {
     }
 
     public String getVodId() {
-        return getKey().substring(getKey().lastIndexOf("@@@") + 1);
+        return getKey().substring(getKey().lastIndexOf("@@@") + 3);
     }
 
     public Vod.Flag getFlag() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -121,7 +121,7 @@ public boolean dispatchKeyEvent(KeyEvent event) {
     @Override
     public void onBackPressed() {
         Class item = mResult.getTypes().get(mBinding.pager.getCurrentItem());
-        if (item.getFilter()) updateFilter(item);
+        if (item.getFilter() != null && item.getFilter()) updateFilter(item);
         else super.onBackPressed();
     }
 

File: app/src/main/java/com/fongmi/android/tv/event/PlayerEvent.java
Patch:
@@ -4,14 +4,15 @@
 
 public class PlayerEvent {
 
-    private int state;
+    private final int state;
     private String msg;
 
     public PlayerEvent(int state) {
         this.state = state;
     }
 
     public PlayerEvent(String msg) {
+        this.state = -1;
         this.msg = msg;
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -26,6 +26,7 @@
 import com.fongmi.android.tv.utils.ResUtil;
 
 import java.util.ArrayList;
+import java.util.Collections;
 import java.util.List;
 
 public class VodActivity extends BaseActivity {
@@ -44,6 +45,7 @@ private String getResult() {
     public static void start(Activity activity, Result result) {
         if (result == null || result.getTypes().isEmpty()) return;
         Intent intent = new Intent(activity, VodActivity.class);
+        result.setList(Collections.emptyList());
         intent.putExtra("result", result.toString());
         activity.startActivity(intent);
     }

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -15,6 +15,7 @@
 import com.github.catvod.crawler.SpiderDebug;
 
 import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.HashMap;
 import java.util.List;
 import java.util.concurrent.Callable;
@@ -93,7 +94,7 @@ public void detailContent(String key, String id) {
         execute(result, () -> {
             if (site.getType() == 3) {
                 Spider spider = ApiConfig.get().getCSP(site);
-                String detailContent = spider.detailContent(List.of(id));
+                String detailContent = spider.detailContent(Arrays.asList(id));
                 SpiderDebug.log(detailContent);
                 Result result = Result.fromJson(detailContent);
                 if (!result.getList().isEmpty()) result.getList().get(0).setVodFlags();

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -1,6 +1,7 @@
 package com.fongmi.android.tv.utils;
 
 import android.graphics.drawable.Drawable;
+import android.text.TextUtils;
 import android.widget.ImageView;
 
 import androidx.annotation.Nullable;
@@ -33,7 +34,8 @@ public static void load(String url, ImageView view) {
     }
 
     public static void load(String vodName, String vodPic, ImageView view) {
-        Glide.with(App.get()).load(vodPic).override(getWidth(), getHeight()).signature(new ObjectKey(vodPic + "_" + Prefers.getThumbnail())).placeholder(R.drawable.ic_img_loading).listener(getListener(vodName, view)).into(view);
+        if (TextUtils.isEmpty(vodPic)) onLoadFailed(vodName, view);
+        else Glide.with(App.get()).load(vodPic).override(getWidth(), getHeight()).signature(new ObjectKey(vodPic + "_" + Prefers.getThumbnail())).placeholder(R.drawable.ic_img_loading).listener(getListener(vodName, view)).into(view);
     }
 
     private static RequestListener<Drawable> getListener(String vodName, ImageView view) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/custom/CustomKeyboard.java
Patch:
@@ -71,6 +71,7 @@ public void onItemClick(String text) {
                 binding.keyword.setSelection(cursor - 1);
                 break;
             default:
+                if (binding.keyword.length() > 19) return;
                 sb.insert(cursor, text);
                 binding.keyword.setText(sb.toString());
                 binding.keyword.setSelection(cursor + 1);

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -29,7 +29,7 @@ private static int getHeight() {
     }
 
     public static void load(String url, ImageView view) {
-        Glide.with(App.get()).load(url).override(getWidth(), getHeight()).error(R.drawable.ic_img_error).placeholder(R.drawable.ic_img_loading).into(view);
+        Glide.with(App.get()).load(url).error(R.drawable.ic_img_error).placeholder(R.drawable.ic_img_loading).into(view);
     }
 
     public static void load(String vodName, String vodPic, ImageView view) {

File: app/src/main/java/com/fongmi/android/tv/server/Server.java
Patch:
@@ -23,7 +23,7 @@ public Server() {
     }
 
     public String getAddress(boolean local) {
-        return "http://" + (local ? "127.0.0.1" : Utils.getIP()) + ":" + port + "/";
+        return "http://" + (local ? "127.0.0.1" : Utils.getIP()) + ":" + port;
     }
 
     public void start() {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/DetailActivity.java
Patch:
@@ -290,7 +290,7 @@ private void createHistory() {
 
     private void updateHistory(Vod.Flag.Episode item, boolean reset) {
         History history = AppDatabase.get().getHistoryDao().find(getHistoryKey());
-        reset = reset || !history.getEpisodeUrl().equals(item.getUrl());
+        reset = reset || !item.getUrl().equals(history.getEpisodeUrl());
         long duration = reset ? 0 : history.getDuration();
         history.setDuration(duration);
         history.setEpisodeUrl(item.getUrl());

File: app/src/main/java/com/fongmi/android/tv/bean/History.java
Patch:
@@ -63,7 +63,7 @@ public void setVodRemarks(String vodRemarks) {
     }
 
     public String getEpisodeUrl() {
-        return episodeUrl;
+        return episodeUrl == null ? "" : episodeUrl;
     }
 
     public void setEpisodeUrl(String episodeUrl) {

File: app/src/main/java/com/fongmi/android/tv/utils/ImgUtil.java
Patch:
@@ -19,7 +19,7 @@
 public class ImgUtil {
 
     public static void load(String url, ImageView view) {
-        Glide.with(App.get()).load(url).error(R.drawable.ic_img_error).placeholder(R.drawable.ic_img_loading).into(view);
+        Glide.with(App.get()).load(url).override(ResUtil.dp2px(300), ResUtil.dp2px(400)).error(R.drawable.ic_img_error).placeholder(R.drawable.ic_img_loading).into(view);
     }
 
     public static void load(String vodName, String vodPic, ImageView view) {

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/HomeActivity.java
Patch:
@@ -150,9 +150,10 @@ private ListRow getFuncRow() {
     private void getHistory() {
         int historyIndex = getHistoryIndex();
         int recommendIndex = getRecommendIndex();
+        boolean isExist = recommendIndex - historyIndex == 2;
         List<History> items = AppDatabase.get().getHistoryDao().getAll();
-        if (items.isEmpty()) return;
-        if (recommendIndex - historyIndex != 2) mAdapter.add(historyIndex, new ListRow(mHistoryAdapter));
+        if (items.isEmpty() && isExist) mAdapter.removeItems(getHistoryIndex(), 1);
+        if (items.size() > 0 && !isExist) mAdapter.add(historyIndex, new ListRow(mHistoryAdapter));
         mHistoryAdapter.setItems(items, null);
     }
 

File: app/src/leanback/java/com/fongmi/android/tv/ui/presenter/VodPresenter.java
Patch:
@@ -26,7 +26,7 @@ public interface OnClickListener {
     }
 
     private void setLayoutSize(int columns) {
-        int space = ResUtil.dp2px(16 * columns - 1) + ResUtil.dp2px(48);
+        int space = ResUtil.dp2px(16) * (columns - 1) + ResUtil.dp2px(48);
         int base = ResUtil.getScreenWidthPx() - space;
         width = base / columns;
         height = (int) (width / 0.75f);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -40,7 +40,7 @@ private String getResult() {
     }
 
     public static void start(Activity activity, Result result) {
-        if (result.getTypes().isEmpty()) return;
+        if (result == null || result.getTypes().isEmpty()) return;
         Intent intent = new Intent(activity, VodActivity.class);
         intent.putExtra("result", result.toString());
         activity.startActivity(intent);

File: app/src/leanback/java/com/fongmi/android/tv/ui/activity/VodActivity.java
Patch:
@@ -40,7 +40,7 @@ private String getResult() {
     }
 
     public static void start(Activity activity, Result result) {
-        if (result == null || result.getTypes().isEmpty()) return;
+        if (result.getTypes().isEmpty()) return;
         Intent intent = new Intent(activity, VodActivity.class);
         intent.putExtra("result", result.toString());
         activity.startActivity(intent);

File: app/src/leanback/java/com/fongmi/android/tv/ui/fragment/VodFragment.java
Patch:
@@ -1,7 +1,6 @@
 package com.fongmi.android.tv.ui.fragment;
 
 import android.os.Bundle;
-import android.util.Log;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
@@ -93,8 +92,8 @@ private void setRecyclerView() {
     private void setViewModel() {
         mSiteViewModel = new ViewModelProvider(this).get(SiteViewModel.class);
         mSiteViewModel.result.observe(getViewLifecycleOwner(), result -> {
-            mScroller.endLoading(result == null || result.getList().isEmpty());
-            if (result != null) addVideo(result);
+            mScroller.endLoading(result.getList().isEmpty());
+            if (result.getList().size() > 0) addVideo(result);
         });
     }
 

File: app/src/main/java/com/fongmi/android/tv/bean/History.java
Patch:
@@ -87,11 +87,11 @@ public void setDuration(long duration) {
     }
 
     public String getSiteKey() {
-        return getKey().split("_")[0];
+        return getKey().substring(0, getKey().lastIndexOf("_"));
     }
 
     public String getVodId() {
-        return getKey().split("_")[1];
+        return getKey().substring(getKey().lastIndexOf("_") + 1);
     }
 
     public Vod.Flag getFlag() {

File: app/src/main/java/com/fongmi/android/tv/model/SiteViewModel.java
Patch:
@@ -42,7 +42,7 @@ public void homeContent() {
         execute(result, () -> {
             if (home.getType() == 3) {
                 Spider spider = ApiConfig.get().getCSP(home);
-                String homeContent = spider.homeContent(false);
+                String homeContent = spider.homeContent(true);
                 SpiderDebug.log(homeContent);
                 Result result = Result.fromJson(homeContent);
                 if (result.getList().size() > 0) return result;

File: app/src/main/java/com/fongmi/android/tv/utils/FileUtil.java
Patch:
@@ -17,7 +17,7 @@ public static String getRootPath() {
     }
 
     public static File getCacheDir() {
-        return App.get().getExternalCacheDir();
+        return App.get().getCacheDir();
     }
 
     public static String getCachePath() {

File: app/src/main/java/com/fongmi/bear/ApiConfig.java
Patch:
@@ -131,6 +131,7 @@ private void parseJson(JsonObject object) {
     }
 
     private void parseJar(String spider) throws Exception {
+        if (spider.contains(";md5")) spider = spider.split(";md5")[0];
         if (spider.startsWith("file://")) {
             loader.load(FileUtil.getLocal(spider));
         } else if (Patterns.WEB_URL.matcher(spider).matches()) {

File: app/src/main/java/com/fongmi/bear/ui/activity/DetailActivity.java
Patch:
@@ -25,7 +25,6 @@
 import com.fongmi.bear.databinding.ActivityDetailBinding;
 import com.fongmi.bear.databinding.ViewControllerBottomBinding;
 import com.fongmi.bear.event.PlayerEvent;
-import com.fongmi.bear.impl.KeyDownImpl;
 import com.fongmi.bear.model.SiteViewModel;
 import com.fongmi.bear.player.Players;
 import com.fongmi.bear.ui.presenter.EpisodePresenter;
@@ -44,7 +43,7 @@
 import java.util.ArrayList;
 import java.util.List;
 
-public class DetailActivity extends BaseActivity implements KeyDownImpl {
+public class DetailActivity extends BaseActivity implements KeyDown.Listener {
 
     private ViewControllerBottomBinding mControl;
     private ViewGroup.LayoutParams mFrameParams;

File: app/src/main/java/com/fongmi/bear/ui/activity/HomeActivity.java
Patch:
@@ -158,6 +158,7 @@ public void onBackPressed() {
     @Override
     protected void onDestroy() {
         Players.get().release();
+        ApiConfig.get().clear();
         super.onDestroy();
         Clock.destroy();
     }

File: app/src/main/java/com/fongmi/bear/ui/activity/DetailActivity.java
Patch:
@@ -174,7 +174,7 @@ private void setEpisodeActivated(Vod.Flag.Episode item) {
     private void setEpisode(Vod.Flag item) {
         mEpisodeAdapter.clear();
         mEpisodeAdapter.addAll(0, item.getEpisodes());
-        mEpisodePresenter.performClick((Vod.Flag.Episode) mEpisodeAdapter.get(0));
+        if (mEpisodeAdapter.size() > 0) mEpisodePresenter.performClick((Vod.Flag.Episode) mEpisodeAdapter.get(0));
         setGroup(item.getEpisodes().size());
     }
 

File: app/src/main/java/com/fongmi/bear/bean/Vod.java
Patch:
@@ -8,6 +8,8 @@
 
 import com.amulyakhare.textdrawable.TextDrawable;
 import com.amulyakhare.textdrawable.util.ColorGenerator;
+import com.fongmi.bear.R;
+import com.fongmi.bear.utils.ResUtil;
 import com.fongmi.bear.utils.Utils;
 import com.google.gson.Gson;
 import com.google.gson.annotations.SerializedName;
@@ -199,9 +201,9 @@ public List<Episode> getEpisodes() {
         public void createEpisode(String data) {
             String[] urls = data.contains("#") ? data.split("#") : new String[]{data};
             for (String url : urls) {
-                if (!url.contains("$")) return;
                 String[] split = url.split("\\$");
                 if (split.length >= 2) getEpisodes().add(new Vod.Flag.Episode(split[0], split[1]));
+                else getEpisodes().add(new Vod.Flag.Episode(ResUtil.getString(R.string.play), url));
             }
         }
 

File: app/src/main/java/com/fongmi/bear/ui/activity/DetailActivity.java
Patch:
@@ -130,6 +130,7 @@ private void setViewModel() {
             if (object != null) Players.get().setMediaSource(object);
         });
         mSiteViewModel.result.observe(this, result -> {
+            if (result == null) return;
             if (result.getList().isEmpty()) mBinding.progressLayout.showErrorText();
             else setDetail(result.getList().get(0));
         });

File: app/src/main/java/com/fongmi/bear/ui/activity/HomeActivity.java
Patch:
@@ -83,6 +83,7 @@ private void setViewModel() {
         mSiteViewModel = new ViewModelProvider(this).get(SiteViewModel.class);
         mSiteViewModel.result.observe(this, result -> {
             mAdapter.remove("progress");
+            if (result == null) return;
             for (List<Vod> items : result.partition()) {
                 VodPresenter presenter = new VodPresenter(items.size());
                 ArrayObjectAdapter adapter = new ArrayObjectAdapter(presenter);

File: app/src/main/java/com/fongmi/bear/ui/activity/VodActivity.java
Patch:
@@ -48,7 +48,7 @@ protected ViewBinding getBinding() {
 
     @Override
     protected void initView() {
-        mResult = Result.objectFrom(getResult());
+        mResult = Result.fromJson(getResult());
         setRecyclerView();
         setPager();
     }

File: app/src/main/java/com/fongmi/bear/ui/fragment/VodFragment.java
Patch:
@@ -90,6 +90,7 @@ private void setViewModel() {
         mSiteViewModel = new ViewModelProvider(this).get(SiteViewModel.class);
         mSiteViewModel.result.observe(getViewLifecycleOwner(), result -> {
             mAdapter.remove("progress");
+            if (result == null) return;
             mScroller.endLoading(result.getList().isEmpty());
             for (List<Vod> items : result.partition()) {
                 VodPresenter presenter = new VodPresenter(items.size());

File: app/src/main/java/com/fongmi/bear/net/SSLSocketFactoryCompat.java
Patch:
@@ -8,6 +8,7 @@
 import java.util.LinkedList;
 import java.util.List;
 
+import javax.net.ssl.HttpsURLConnection;
 import javax.net.ssl.SSLContext;
 import javax.net.ssl.SSLSocket;
 import javax.net.ssl.SSLSocketFactory;
@@ -54,6 +55,7 @@ public SSLSocketFactoryCompat(X509TrustManager tm) {
             SSLContext sslContext = SSLContext.getInstance("TLS");
             sslContext.init(null, (tm != null) ? new X509TrustManager[]{tm} : null, null);
             defaultFactory = sslContext.getSocketFactory();
+            HttpsURLConnection.setDefaultSSLSocketFactory(defaultFactory);
         } catch (GeneralSecurityException e) {
             throw new AssertionError(); // The system has no TLS. Just give up.
         }

File: app/src/main/java/com/fongmi/bear/ui/activity/VodActivity.java
Patch:
@@ -85,7 +85,7 @@ private void setRecyclerView() {
 
     private void setPager() {
         mBinding.pager.setAdapter(new PageAdapter(getSupportFragmentManager()));
-        if (mResult.getTypes().size() > 0) mBinding.pager.setOffscreenPageLimit(mResult.getTypes().size());
+        if (mResult.getTypes().size() > 0) mBinding.pager.setOffscreenPageLimit(Math.min(mResult.getTypes().size(), 5));
     }
 
     class PageAdapter extends FragmentStatePagerAdapter {

File: app/src/main/java/com/fongmi/bear/player/Players.java
Patch:
@@ -72,7 +72,7 @@ public void setMediaSource(JsonObject object) {
 
     private void loadWebView(String url) {
         handler.removeCallbacks(mTimer);
-        handler.postDelayed(mTimer, 5000);
+        handler.postDelayed(mTimer, 10000);
         handler.post(() -> webView.start(url));
     }
 

File: app/src/main/java/com/fongmi/bear/ui/custom/CustomWebView.java
Patch:
@@ -32,10 +32,12 @@ public CustomWebView(@NonNull Context context) {
 
     public CustomWebView(@NonNull Context context, @Nullable AttributeSet attrs) {
         super(context, attrs);
+        initSettings();
     }
 
     public CustomWebView(@NonNull Context context, @Nullable AttributeSet attrs, int defStyleAttr) {
         super(context, attrs, defStyleAttr);
+        initSettings();
     }
 
     @SuppressLint("SetJavaScriptEnabled")
@@ -67,7 +69,7 @@ public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceReque
                 String url = request.getUrl().toString();
                 String host = request.getUrl().getHost();
                 if (ads.contains(host)) return empty;
-                if (Utils.isVideoFormat(url)) Players.get().setMediaSource(request.getRequestHeaders(), url);
+                if (Utils.isVideoFormat(url) || request.getRequestHeaders().containsKey("Range")) Players.get().setMediaSource(request.getRequestHeaders(), url);
                 return super.shouldInterceptRequest(view, request);
             }
 

File: app/src/main/java/com/fongmi/bear/ApiConfig.java
Patch:
@@ -29,7 +29,6 @@
 import java.util.List;
 import java.util.Map;
 
-import okhttp3.Request;
 import okhttp3.Response;
 
 public class ApiConfig {
@@ -91,7 +90,7 @@ private void getFileConfig(String url, Callback callback) {
 
     private void getWebConfig(String url, Callback callback) {
         try {
-            Response response = OKHttp.get().client().newCall(new Request.Builder().url(url).build()).execute();
+            Response response = OKHttp.newCall(url).execute();
             parseConfig(new Gson().fromJson(response.body().string(), JsonObject.class), callback);
         } catch (IOException e) {
             handler.post(() -> callback.error(R.string.error_config_get));
@@ -134,7 +133,7 @@ private void parseJar(String spider) throws Exception {
         if (spider.startsWith("file://")) {
             loader.load(FileUtil.getLocal(spider));
         } else if (Patterns.WEB_URL.matcher(spider).matches()) {
-            Response response = OKHttp.get().client().newCall(new Request.Builder().url(spider).build()).execute();
+            Response response = OKHttp.newCall(spider).execute();
             FileUtil.write(FileUtil.getJar(), response.body().bytes());
             loader.load(FileUtil.getJar());
         }

File: app/src/main/java/com/fongmi/bear/bean/Result.java
Patch:
@@ -72,7 +72,7 @@ static class FiltersAdapter implements JsonDeserializer<LinkedHashMap<String, Li
         @Override
         public LinkedHashMap<String, List<Filter>> deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException {
             LinkedHashMap<String, List<Filter>> filterMap = new LinkedHashMap<>();
-            JsonObject filters = (JsonObject) json.getAsJsonObject();
+            JsonObject filters = json.getAsJsonObject();
             if (filters == null) return filterMap;
             for (String key : filters.keySet()) {
                 List<Filter> items = new ArrayList<>();

File: app/src/main/java/com/fongmi/bear/ui/activity/HomeActivity.java
Patch:
@@ -125,7 +125,6 @@ public void onItemClick(Vod item) {
     @Override
     protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
         super.onActivityResult(requestCode, resultCode, data);
-        if (resultCode != RESULT_OK) return;
         getVideo();
     }
 }
\ No newline at end of file

File: app/src/main/java/com/fongmi/bear/ui/custom/CustomWebView.java
Patch:
@@ -15,7 +15,7 @@
 import androidx.annotation.Nullable;
 
 import com.fongmi.bear.ApiConfig;
-import com.fongmi.bear.player.Player;
+import com.fongmi.bear.player.Players;
 import com.fongmi.bear.utils.Utils;
 
 import java.io.ByteArrayInputStream;
@@ -67,7 +67,7 @@ public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceReque
                 String url = request.getUrl().toString();
                 String host = request.getUrl().getHost();
                 if (ads.contains(host)) return empty;
-                if (Utils.isVideoFormat(url)) Player.get().setMediaSource(request.getRequestHeaders(), url);
+                if (Utils.isVideoFormat(url)) Players.get().setMediaSource(request.getRequestHeaders(), url);
                 return super.shouldInterceptRequest(view, request);
             }
 

File: app/src/main/java/com/fongmi/bear/net/Callback.java
Patch:
@@ -1,6 +1,7 @@
 package com.fongmi.bear.net;
 
 import androidx.annotation.NonNull;
+import androidx.annotation.StringRes;
 
 import java.io.IOException;
 
@@ -12,7 +13,7 @@ public abstract class Callback implements okhttp3.Callback {
     public void success() {
     }
 
-    public void error(String msg) {
+    public void error(@StringRes int resId) {
     }
 
     @Override

File: app/src/main/java/com/fongmi/bear/ui/activity/DetailActivity.java
Patch:
@@ -79,7 +79,7 @@ private void setRecyclerView() {
         mBinding.group.addOnChildViewHolderSelectedListener(new OnChildViewHolderSelectedListener() {
             @Override
             public void onChildViewHolderSelected(@NonNull RecyclerView parent, @Nullable RecyclerView.ViewHolder child, int position, int subposition) {
-                mBinding.episode.setSelectedPosition(position * 20);
+                if (mEpisodeAdapter.size() > 20) mBinding.episode.setSelectedPosition(position * 20);
             }
         });
         mBinding.flag.addOnChildViewHolderSelectedListener(new OnChildViewHolderSelectedListener() {
@@ -138,7 +138,7 @@ private void setGroup(int size) {
         List<String> items = new ArrayList<>();
         int itemSize = (int) Math.ceil(size / 20.0f);
         for (int i = 0; i < itemSize; i++) items.add(String.valueOf(i * 20 + 1));
-        mGroupAdapter.addAll(0, items);
         mBinding.group.setVisibility(View.VISIBLE);
+        mGroupAdapter.addAll(0, items);
     }
 }

File: app/src/main/java/com/fongmi/bear/ui/activity/SettingActivity.java
Patch:
@@ -74,9 +74,9 @@ public void success() {
             }
 
             @Override
-            public void error(String msg) {
+            public void error(int resId) {
                 Notify.dismiss();
-                Notify.show(msg);
+                Notify.show(resId);
             }
         });
     }

File: app/src/main/java/com/fongmi/bear/ui/activity/SplashActivity.java
Patch:
@@ -46,9 +46,9 @@ public void success() {
             }
 
             @Override
-            public void error(String msg) {
+            public void error(int resId) {
                 HomeActivity.start(getActivity());
-                Notify.show(msg);
+                Notify.show(resId);
             }
         });
     }

File: app/src/main/java/com/fongmi/bear/utils/Notify.java
Patch:
@@ -30,7 +30,7 @@ private static Notify get() {
     }
 
     public static void show(int resId) {
-        show(Utils.getString(resId));
+        if (resId != 0) show(ResUtil.getString(resId));
     }
 
     public static void show(String text) {

File: app/src/main/java/com/fongmi/bear/ui/activity/HomeActivity.java
Patch:
@@ -90,7 +90,8 @@ private void setAdapter() {
 
     private void getVideo() {
         if (mAdapter.size() > 4) mAdapter.removeItems(4, mAdapter.size() - 4);
-        if (!ApiConfig.get().getHome().getKey().isEmpty()) mSiteViewModel.homeContent();
+        if (ApiConfig.get().getHome().getKey().isEmpty()) return;
+        mSiteViewModel.homeContent();
         mAdapter.add("progress");
     }
 

File: app/src/main/java/com/fongmi/bear/ui/activity/SettingActivity.java
Patch:
@@ -75,6 +75,7 @@ public void success() {
 
             @Override
             public void error(String msg) {
+                Notify.dismiss();
                 Notify.show(msg);
             }
         });

File: app/src/main/java/com/fongmi/bear/utils/Notify.java
Patch:
@@ -70,6 +70,5 @@ private void makeText(String message) {
         if (TextUtils.isEmpty(message)) return;
         mToast = Toast.makeText(App.get(), message, Toast.LENGTH_LONG);
         mToast.show();
-        dismiss();
     }
 }

File: app/src/main/java/com/fongmi/bear/ui/activity/HomeActivity.java
Patch:
@@ -10,6 +10,7 @@
 import androidx.lifecycle.ViewModelProvider;
 import androidx.viewbinding.ViewBinding;
 
+import com.fongmi.bear.ApiConfig;
 import com.fongmi.bear.R;
 import com.fongmi.bear.bean.Func;
 import com.fongmi.bear.bean.Result;
@@ -89,7 +90,7 @@ private void setAdapter() {
 
     private void getVideo() {
         if (mAdapter.size() > 4) mAdapter.removeItems(4, mAdapter.size() - 4);
-        mSiteViewModel.homeContent();
+        if (!ApiConfig.get().getHome().getKey().isEmpty()) mSiteViewModel.homeContent();
         mAdapter.add("progress");
     }
 

File: app/src/main/java/com/fongmi/bear/ui/activity/VodActivity.java
Patch:
@@ -91,7 +91,7 @@ private void setPager() {
     class PageAdapter extends FragmentStatePagerAdapter {
 
         public PageAdapter(@NonNull FragmentManager fm) {
-            super(fm, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT);
+            super(fm);
         }
 
         @NonNull

File: app/src/main/java/com/fongmi/bear/ui/custom/CustomVerticalGridView.java
Patch:
@@ -70,6 +70,7 @@ public boolean dispatchKeyEvent(KeyEvent event) {
 
     public void moveToTop() {
         mTabView.setVisibility(View.VISIBLE);
+        mTabView.requestFocus();
         scrollToPosition(0);
     }
 }

File: app/src/main/java/com/fongmi/bear/ui/adapter/PageAdapter.java
Patch:
@@ -13,7 +13,7 @@ public class PageAdapter extends FragmentStatePagerAdapter {
     private final Result result;
 
     public PageAdapter(@NonNull FragmentManager fm, Result result) {
-        super(fm);
+        super(fm, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT);
         this.result = result;
     }
 

File: app/src/main/java/com/fongmi/bear/bean/Result.java
Patch:
@@ -40,7 +40,7 @@ public static Result objectFrom(String str) {
     }
 
     public List<Class> getTypes() {
-        return types;
+        return types == null ? Collections.emptyList() : types;
     }
 
     public List<Vod> getList() {

File: app/src/main/java/com/fongmi/bear/ui/activity/VodActivity.java
Patch:
@@ -58,7 +58,7 @@ private void setRecyclerView() {
 
     private void setPager() {
         mBinding.pager.setAdapter(new PageAdapter(this, mResult.getTypes(), mResult.getFilters()));
-        mBinding.pager.setOffscreenPageLimit(mResult.getTypes().size());
+        if (mResult.getTypes().size() > 0) mBinding.pager.setOffscreenPageLimit(mResult.getTypes().size());
         mBinding.pager.setUserInputEnabled(false);
     }
 }

File: app/src/main/java/com/fongmi/bear/model/SiteViewModel.java
Patch:
@@ -45,7 +45,8 @@ public void homeContent() {
                 if (result.getList().size() > 0) return result;
                 String homeVideoContent = spider.homeVideoContent();
                 SpiderDebug.json(homeVideoContent);
-                return Result.objectFrom(homeVideoContent);
+                result.setList(Result.objectFrom(homeVideoContent).getList());
+                return result;
             });
         }
     }

File: app/src/main/java/com/fongmi/bear/model/SiteViewModel.java
Patch:
@@ -37,5 +37,6 @@ public void homeContent(String key) {
                 mResult.postValue(result);
             });
         }
+        mResult.postValue(new Result());
     }
 }

File: app/src/main/java/com/fongmi/bear/ApiConfig.java
Patch:
@@ -79,13 +79,13 @@ public void onResponse(@NonNull Call call, @NonNull Response response) {
                     loadJar();
                     handler.post(callback::success);
                 } catch (Exception e) {
-                    handler.post(() -> callback.error("解析配置失敗"));
+                    handler.post(() -> callback.error("配置解析失敗"));
                 }
             }
 
             @Override
             public void onFailure(@NonNull Call call, @NonNull IOException e) {
-                handler.post(() -> callback.error("取得配置失敗"));
+                handler.post(() -> callback.error("配置取得失敗"));
             }
         });
     }

File: app/src/main/java/com/fongmi/bear/bean/Result.java
Patch:
@@ -12,7 +12,8 @@ public class Result {
     private List<Vod> list;
 
     public static Result objectFrom(String str) {
-        return new Gson().fromJson(str, Result.class);
+        Result result = new Gson().fromJson(str, Result.class);
+        return result == null ? new Result() : result;
     }
 
     public List<Vod> getList() {

File: app/src/main/java/com/fongmi/bear/utils/ResUtil.java
Patch:
@@ -8,7 +8,7 @@
 
 public class ResUtil {
 
-    private static DisplayMetrics getDisplayMetrics() {
+    public static DisplayMetrics getDisplayMetrics() {
         return App.get().getResources().getDisplayMetrics();
     }
 

File: app/src/main/java/com/fongmi/bear/utils/Utils.java
Patch:
@@ -13,6 +13,7 @@
 import com.bumptech.glide.load.resource.bitmap.CenterCrop;
 import com.bumptech.glide.load.resource.bitmap.RoundedCorners;
 import com.fongmi.bear.App;
+import com.fongmi.bear.R;
 import com.google.android.exoplayer2.util.Util;
 
 public class Utils {
@@ -62,7 +63,7 @@ static boolean isRightKey(KeyEvent event) {
     }
 
     public static void loadImage(String url, ImageView view) {
-        Glide.with(App.get()).load(url).transform(new CenterCrop(), new RoundedCorners(ResUtil.dp2px(8))).into(view);
+        Glide.with(App.get()).load(url).placeholder(R.drawable.ic_img_loading).error(R.drawable.ic_img_error).transform(new CenterCrop(), new RoundedCorners(ResUtil.dp2px(8))).into(view);
     }
 
     public static boolean hasPIP() {

File: app/src/main/java/com/fongmi/bear/ui/adapter/SiteAdapter.java
Patch:
@@ -75,5 +75,7 @@ public void onBindViewHolder(@NonNull SiteAdapter.ViewHolder holder, int positio
         Site item = mItems.get(position);
         holder.itemView.setSelected(item.isHome());
         holder.binding.name.setText(item.getName());
+        if (item.isHome()) holder.itemView.requestFocus();
+        else holder.itemView.clearFocus();
     }
 }

