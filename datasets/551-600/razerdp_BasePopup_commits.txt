File: app/src/main/java/razerdp/demo/popup/DemoPopup.java
Patch:
@@ -3,13 +3,13 @@
 import android.app.Dialog;
 import android.content.Context;
 import android.graphics.Rect;
-import android.service.autofill.TextValueSanitizer;
 import android.view.View;
 import android.view.animation.Animation;
 import android.widget.TextView;
 
 import androidx.annotation.NonNull;
 import androidx.fragment.app.Fragment;
+
 import razerdp.basepopup.BasePopupWindow;
 import razerdp.basepopup.R;
 import razerdp.basepopup.databinding.PopupDemoBinding;

File: app/src/main/java/razerdp/demo/popup/issue/PopupIssue230.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.content.Context;
 import android.view.Gravity;
+import android.view.MotionEvent;
 import android.view.View;
 import android.view.animation.Animation;
 
@@ -20,6 +21,7 @@
 import razerdp.demo.utils.UIHelper;
 import razerdp.util.animation.AnimationHelper;
 import razerdp.util.animation.ScaleConfig;
+import razerdp.util.log.PopupLog;
 
 /**
  * Created by 大灯泡 on 2019/10/9.
@@ -37,7 +39,7 @@ public PopupIssue230(Context context) {
         setMaxWidth(UIHelper.getScreenWidth() >> 1);
 
         List<String> data = new ArrayList<>();
-        for (int i = 0; i < RandomUtil.randomInt(5, 10); i++) {
+        for (int i = 0; i < 50; i++) {
             data.add("pos ： " + (i + 1));
         }
         mAdapter = new SimpleRecyclerViewAdapter<>(context, data);

File: app/src/main/java/razerdp/demo/ui/SizeLimitActivity.java
Patch:
@@ -95,7 +95,6 @@ void showPopup(View v) {
             showWithAnchorView = true;
         }
         mPopup.setPopupGravity(gravity);
-        mPopup.setFitSize(mBinding.checkFitSize.isChecked());
         if (showWithAnchorView) {
             mPopup.showPopupWindow(v);
         } else {

File: app/src/main/java/razerdp/demo/ui/issuestest/Issue224TestActivity.java
Patch:
@@ -52,7 +52,6 @@ void show() {
 
         int value = StringUtil.toInt(mBinding.edNum.getText().toString().trim());
         mPopupIssue224.setItemCount(value);
-        mPopupIssue224.setFitSize(mBinding.checkFitSize.isChecked());
         if (!mPopupIssue224.isShowing() && value > 0) {
             mPopupIssue224.showPopupWindow(mBinding.layoutTestContainer);
         }

File: app/src/main/java/razerdp/demo/ui/issuestest/Issue277TestActivity.java
Patch:
@@ -54,7 +54,6 @@ public Issue277Popup(Context context) {
             setBlurBackgroundEnable(false);
             setOutSideDismiss(false);
             setOutSideTouchable(true);
-            setAdjustInputMode(R.id.feedbackTv, FLAG_KEYBOARD_ALIGN_TO_VIEW);
         }
 
 

File: lib/src/main/java/razerdp/basepopup/BasePopupHelper.java
Patch:
@@ -449,6 +449,9 @@ boolean isWithAnchor() {
 
     BasePopupHelper withAnchor(boolean showAsDropDown) {
         setFlag(WITH_ANCHOR, showAsDropDown);
+        if (showAsDropDown && (popupGravity == Gravity.NO_GRAVITY || popupGravity == -1)) {
+            popupGravity = Gravity.BOTTOM;
+        }
         return this;
     }
 

File: app/src/main/java/razerdp/demo/popup/DemoPopup.java
Patch:
@@ -64,7 +64,7 @@ public DemoPopup setText(CharSequence text) {
         return this;
     }
 
-    public TextView getTextView(){
+    public TextView getTextView() {
         return mBinding.tvDesc;
     }
 

File: app/src/main/java/razerdp/demo/base/imageloader/ImageLoaderManager.java
Patch:
@@ -70,6 +70,9 @@ void loadImageInternal(View target, Object from, Options options) {
             Glide.with(target).load(from).apply(options.requestOptions).into((Target) target);
         } else {
             if (target instanceof ImageView) {
+                if (options.progressListener != null) {
+                    Glide.with(target).load(from).apply(options.requestOptions).into(new ProgressImageViewTarget((ImageView) target, String.valueOf(from), options.progressListener));
+                }
                 Glide.with(target).load(from).apply(options.requestOptions).into((ImageView) target);
             }
         }

File: app/src/main/java/razerdp/demo/model/common/CommonAnchorMatchInfo.java
Patch:
@@ -30,6 +30,9 @@ public class CommonAnchorMatchInfo extends DemoCommonUsageInfo {
 
     public CommonAnchorMatchInfo() {
         title = "关联anchor\n同时宽或者高为match_parent";
+        name="PopupSlide";
+        javaUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/java/razerdp/demo/popup/PopupSlide.java";
+        resUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/res/layout/popup_slide.xml";
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonAnimateInfo.java
Patch:
@@ -24,6 +24,9 @@ public class CommonAnimateInfo extends DemoCommonUsageInfo {
 
     public CommonAnimateInfo() {
         title = "动画展示";
+        name = "PopupAnimate";
+        javaUrl = "https://github.com/razerdp/BasePopup/blob/master/app/src/main/java/razerdp/demo/popup/PopupAnimate.java";
+        resUrl = "https://github.com/razerdp/BasePopup/blob/master/app/src/main/res/layout/popup_animate.xml";
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonAnyPosInfo.java
Patch:
@@ -23,6 +23,9 @@ public class CommonAnyPosInfo extends DemoCommonUsageInfo {
 
     public CommonAnyPosInfo() {
         title = "任意位置展示";
+        name="DemoPopup";
+        javaUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/java/razerdp/demo/popup/DemoPopup.java";
+        resUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/res/layout/popup_demo.xml";
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonArrowInfo.java
Patch:
@@ -21,6 +21,9 @@ public class CommonArrowInfo extends DemoCommonUsageInfo {
 
     public CommonArrowInfo() {
         title = "带箭头的Popup";
+        name="PopupArrow";
+        javaUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/java/razerdp/demo/popup/PopupArrow.java";
+        resUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/res/layout/popup_arrow.xml";
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonBackgroundAlignInfo.java
Patch:
@@ -22,6 +22,9 @@ public class CommonBackgroundAlignInfo extends DemoCommonUsageInfo {
 
     public CommonBackgroundAlignInfo() {
         title = "背景蒙层控制";
+        name="DemoPopup";
+        javaUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/java/razerdp/demo/popup/DemoPopup.java";
+        resUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/res/layout/popup_demo.xml";
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonBackgroundInfo.java
Patch:
@@ -20,6 +20,9 @@ public class CommonBackgroundInfo extends DemoCommonUsageInfo {
 
     public CommonBackgroundInfo() {
         title = "背景控制";
+        name = "DemoPopup";
+        javaUrl = "https://github.com/razerdp/BasePopup/blob/master/app/src/main/java/razerdp/demo/popup/DemoPopup.java";
+        resUrl = "https://github.com/razerdp/BasePopup/blob/master/app/src/main/res/layout/popup_demo.xml";
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonBlurInfo.java
Patch:
@@ -24,6 +24,9 @@ public class CommonBlurInfo extends DemoCommonUsageInfo {
 
     public CommonBlurInfo() {
         title = "背景模糊";
+        name = "DemoPopup";
+        javaUrl = "https://github.com/razerdp/BasePopup/blob/master/app/src/main/java/razerdp/demo/popup/DemoPopup.java";
+        resUrl = "https://github.com/razerdp/BasePopup/blob/master/app/src/main/res/layout/popup_demo.xml";
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonControllerInfo.java
Patch:
@@ -21,6 +21,9 @@ public class CommonControllerInfo extends DemoCommonUsageInfo {
 
     public CommonControllerInfo() {
         title = "控制展示";
+        name = "DemoPopup";
+        javaUrl = "https://github.com/razerdp/BasePopup/blob/master/app/src/main/java/razerdp/demo/popup/DemoPopup.java";
+        resUrl = "https://github.com/razerdp/BasePopup/blob/master/app/src/main/res/layout/popup_demo.xml";
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonFriendCircleInfo.java
Patch:
@@ -16,6 +16,9 @@ public class CommonFriendCircleInfo extends DemoCommonUsageInfo {
 
     public CommonFriendCircleInfo() {
         title = "朋友圈评论";
+        name="PopupFriendCircle";
+        javaUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/java/razerdp/demo/popup/PopupFriendCircle.java";
+        resUrl="https://github.com/razerdp/BasePopup/blob/master/app/src/main/res/layout/popup_friend_circle_comment.xml";
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonFullScreenActivityInfo.java
Patch:
@@ -16,6 +16,7 @@ public class CommonFullScreenActivityInfo extends DemoCommonUsageInfo {
 
     public CommonFullScreenActivityInfo() {
         title = "全屏Activity";
+        sourceVisible = false;
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/common/CommonRTLInfo.java
Patch:
@@ -13,6 +13,7 @@
 public class CommonRTLInfo extends DemoCommonUsageInfo {
     public CommonRTLInfo() {
         title = "RTL布局";
+        sourceVisible = false;
     }
 
     @Override

File: app/src/main/java/razerdp/demo/model/friendcircle/FriendCircleInfo.java
Patch:
@@ -1,5 +1,7 @@
 package razerdp.demo.model.friendcircle;
 
+import android.util.Pair;
+
 import java.util.List;
 
 /**
@@ -11,7 +13,7 @@ public class FriendCircleInfo {
     public String name;
     public String avatar;
     public String content;
-    public List<String> pics;
+    public List<Pair<String, String>> pics;
     public boolean started;
 
 

File: app/src/main/java/razerdp/demo/ui/UpdateLogActivity.java
Patch:
@@ -42,6 +42,8 @@ protected void onInitView(View decorView) {
                 .createAgentWeb()
                 .ready()
                 .go("https://www.yuque.com/razerdp/basepopup/uyrsxx");
+        mAgentWeb.getAgentWebSettings().getWebSettings().setUseWideViewPort(true);
+        mAgentWeb.getAgentWebSettings().getWebSettings().setLoadWithOverviewMode(true);
     }
 
     @Override

File: app/src/main/java/razerdp/demo/ui/issuestest/Issue224TestActivity.java
Patch:
@@ -53,7 +53,8 @@ void show() {
             mPopupIssue224.setPopupGravity(Gravity.TOP | Gravity.CENTER_HORIZONTAL)
                     .setBackground(0)
                     .setOutSideDismiss(false)
-                    .setOutSideTouchable(true);
+                    .setOutSideTouchable(true)
+                    .linkTo(testLayout);
             mPopupIssue224.getPopupWindow().setFocusable(false);
         }
 

File: app/src/main/java/razerdp/demo/ui/photobrowser/IPhotoBrowserProvider.java
Patch:
@@ -10,4 +10,6 @@
 public interface IPhotoBrowserProvider extends Serializable {
 
     String getPhoto();
+
+    String getThumb();
 }

File: lib/src/main/java/razerdp/basepopup/BasePopupEvent.java
Patch:
@@ -10,6 +10,7 @@
 class BasePopupEvent {
     public static final int EVENT_SHOW = 1;
     public static final int EVENT_DISMISS = 2;
+    public static final int EVENT_ALIGN_KEYBOARD = 3;
 
 
     static Message getMessage(int event) {

File: lib/src/main/java/razerdp/blur/PopupBlurOption.java
Patch:
@@ -15,7 +15,7 @@ public class PopupBlurOption {
 
 
     private static final float DEFAULT_BLUR_RADIUS = 10;
-    private static final float DEFAULT_PRE_SCALE_RATIO = 0.15f;
+    private static final float DEFAULT_PRE_SCALE_RATIO = 0.125f;
     private static final long DEFAULT_ANIMATION_DURATION = 500;
     private static final boolean DEFAULT_BLUR_ASYNC = true;//默认子线程blur
 

File: app/src/main/java/razerdp/demo/popup/issue/PopupIssue238.java
Patch:
@@ -40,8 +40,8 @@ public void onClick(View v) {
             }
         });
         if (isEdit) {
-            setAutoShowInputMethod(true);
-            setAdjustInputMethod(true);
+            setAutoShowKeyboard(true);
+            setKeyboardAdaptive(true);
         }
     }
 

File: app/src/main/java/razerdp/demo/popup/options/PopupAnimateOption.java
Patch:
@@ -50,7 +50,7 @@ public PopupAnimateOption(Context context) {
         super(context);
         setContentView(R.layout.popup_option_animate);
         checkClipchildren.setChecked(true);
-        setAutoLocatePopup(true);
+        setAutoMirrorEnable(true);
     }
 
 

File: app/src/main/java/razerdp/demo/ui/CommonUsageActivity.java
Patch:
@@ -37,6 +37,7 @@
 import razerdp.demo.model.common.CommonFullScreenActivityInfo;
 import razerdp.demo.model.common.CommonGestureNavInfo;
 import razerdp.demo.model.common.CommonInputInfo;
+import razerdp.demo.model.common.CommonPriorityInfo;
 import razerdp.demo.model.common.CommonRTLInfo;
 import razerdp.demo.model.common.CommonSlideInfo;
 import razerdp.demo.model.common.CommonUpdateInfo;
@@ -94,7 +95,7 @@ public int getSpanSize(int position) {
         });
         rvContent.setLayoutManager(gridLayoutManager);
         rvContent.addItemDecoration(new GridItemDecoration(new SpaceOption.Builder().size(UIHelper.DP8)
-                .build()));
+                                                                   .build()));
         mAdapter = new MultiRecyclerViewAdapter(this, createItem());
         mAdapter.appendHolder(InnerTitleViewHolder.class, 0)
                 .appendHolder(InnerItemViewHolder.class, 1);
@@ -126,6 +127,7 @@ private List<MultiType> createItem() {
         result.add(new DemoCommonUsageTitle("PopupWindow控制相关"));
         result.add(new CommonControllerInfo());
         result.add(new CommonBarControllerInfo());
+        result.add(new CommonPriorityInfo());
         result.add(new DemoCommonUsageTitle("动画相关"));
         result.add(new CommonAnimateInfo());
         result.add(new DemoCommonUsageTitle("背景相关"));

File: app/src/main/java/razerdp/demo/ui/issuestest/Issue226TestActivity.java
Patch:
@@ -51,8 +51,8 @@ void show() {
         if (checkForceAdjust.isChecked()) {
             flag |= BasePopupWindow.FLAG_KEYBOARD_FORCE_ADJUST;
         }
-        popupInput.setAdjustInputMethod(true)
-                .setAdjustInputMode(flag)
+        popupInput.setKeyboardAdaptive(true)
+                .setKeyboardAdaptionMode(flag)
                 .showPopupWindow();
     }
 

File: lib/src/main/java/razerdp/widget/QuickPopup.java
Patch:
@@ -85,7 +85,7 @@ protected <C extends QuickPopupConfig> void applyConfigSetting(C config) {
         setPopupGravity(config.getGravity());
         setAlignBackground((config.flag & BasePopupFlag.ALIGN_BACKGROUND) != 0);
         setAlignBackgroundGravity(config.getAlignBackgroundGravity());
-        setAutoLocatePopup((config.flag & BasePopupFlag.AUTO_MIRROR) != 0);
+        setAutoMirrorEnable((config.flag & BasePopupFlag.AUTO_MIRROR) != 0);
         setOverlayStatusbar((config.flag & BasePopupFlag.OVERLAY_STATUS_BAR) != 0);
         setOverlayNavigationBar((config.flag & BasePopupFlag.OVERLAY_NAVIGATION_BAR) != 0);
         setOverlayStatusbarMode(config.getOverlayStatusBarMode());

File: lib/src/main/java/razerdp/basepopup/BasePopupHelper.java
Patch:
@@ -1021,9 +1021,9 @@ void update(View v, boolean positionMode) {
         mPopupWindow.mPopupWindowProxy.update();
     }
 
-    void dispatchOutSideEvent(MotionEvent event, boolean touchInMask) {
+    void dispatchOutSideEvent(MotionEvent event, boolean touchInMask, boolean isMaskPressed) {
         if (mPopupWindow != null) {
-            mPopupWindow.dispatchOutSideEvent(event, touchInMask);
+            mPopupWindow.dispatchOutSideEvent(event, touchInMask, isMaskPressed);
         }
     }
 

File: lib/src/main/java/razerdp/basepopup/PopupMaskLayout.java
Patch:
@@ -47,6 +47,7 @@ private PopupMaskLayout(Context context, AttributeSet attrs, int defStyleAttr) {
 
     private void init(Context context, BasePopupHelper mHelper) {
         this.mPopupHelper = mHelper;
+        setClickable(true);
         location = null;
         maskRect = new RectF();
         setLayoutAnimation(null);
@@ -185,7 +186,7 @@ public boolean dispatchTouchEvent(MotionEvent ev) {
             if (!mPopupHelper.isOverlayStatusbar()) {
                 ev.offsetLocation(0, PopupUiUtils.getStatusBarHeight());
             }
-            mPopupHelper.dispatchOutSideEvent(ev, maskRect.contains(ev.getRawX(), ev.getRawY()));
+            mPopupHelper.dispatchOutSideEvent(ev, maskRect.contains(ev.getRawX(), ev.getRawY()),isPressed());
         }
         return super.dispatchTouchEvent(ev);
     }

File: lib/src/main/java/razerdp/basepopup/BasePopupHelper.java
Patch:
@@ -1021,9 +1021,9 @@ void update(View v, boolean positionMode) {
         mPopupWindow.mPopupWindowProxy.update();
     }
 
-    void dispatchOutSideEvent(MotionEvent event, boolean touchInMask) {
+    void dispatchOutSideEvent(MotionEvent event, boolean touchInMask, boolean isMaskPressed) {
         if (mPopupWindow != null) {
-            mPopupWindow.dispatchOutSideEvent(event, touchInMask);
+            mPopupWindow.dispatchOutSideEvent(event, touchInMask, isMaskPressed);
         }
     }
 

File: lib/src/main/java/razerdp/basepopup/PopupMaskLayout.java
Patch:
@@ -47,6 +47,7 @@ private PopupMaskLayout(Context context, AttributeSet attrs, int defStyleAttr) {
 
     private void init(Context context, BasePopupHelper mHelper) {
         this.mPopupHelper = mHelper;
+        setClickable(true);
         location = null;
         maskRect = new RectF();
         setLayoutAnimation(null);
@@ -185,7 +186,7 @@ public boolean dispatchTouchEvent(MotionEvent ev) {
             if (!mPopupHelper.isOverlayStatusbar()) {
                 ev.offsetLocation(0, PopupUiUtils.getStatusBarHeight());
             }
-            mPopupHelper.dispatchOutSideEvent(ev, maskRect.contains(ev.getRawX(), ev.getRawY()));
+            mPopupHelper.dispatchOutSideEvent(ev, maskRect.contains(ev.getRawX(), ev.getRawY()),isPressed());
         }
         return super.dispatchTouchEvent(ev);
     }

File: app/src/main/java/razerdp/demo/ui/CommonUsageActivity.java
Patch:
@@ -39,6 +39,7 @@
 import razerdp.demo.model.common.CommonRTLInfo;
 import razerdp.demo.model.common.CommonSlideInfo;
 import razerdp.demo.model.common.CommonUpdateInfo;
+import razerdp.demo.model.common.ScreenRotateActivityInfo;
 import razerdp.demo.model.lifecycle.ShowInServiceInfo;
 import razerdp.demo.model.lifecycle.ShowOnCreateInfo;
 import razerdp.demo.utils.ButterKnifeUtil;
@@ -141,6 +142,7 @@ private List<MultiType> createItem() {
         result.add(new CommonDialogActivityInfo());
         result.add(new CommonRTLInfo());
         result.add(new CommonUpdateInfo());
+        result.add(new ScreenRotateActivityInfo());
 
         return result;
     }

File: app/src/main/java/razerdp/demo/ui/CommonUsageActivity.java
Patch:
@@ -39,6 +39,7 @@
 import razerdp.demo.model.common.CommonRTLInfo;
 import razerdp.demo.model.common.CommonSlideInfo;
 import razerdp.demo.model.common.CommonUpdateInfo;
+import razerdp.demo.model.common.ScreenRotateActivityInfo;
 import razerdp.demo.model.lifecycle.ShowInServiceInfo;
 import razerdp.demo.model.lifecycle.ShowOnCreateInfo;
 import razerdp.demo.utils.ButterKnifeUtil;
@@ -141,6 +142,7 @@ private List<MultiType> createItem() {
         result.add(new CommonDialogActivityInfo());
         result.add(new CommonRTLInfo());
         result.add(new CommonUpdateInfo());
+        result.add(new ScreenRotateActivityInfo());
 
         return result;
     }

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -2105,7 +2105,6 @@ public boolean onBackPressed() {
      * @return 返回True则意味着您消耗了该事件，该事件不再会被分发下去
      */
     public boolean onOutSideTouch(MotionEvent event, boolean touchInMask) {
-        PopupLog.i("onOutSideTouch", event.getRawX(), event.getRawY(), event.getX(), event.getY(), touchInMask);
         if (mHelper.isOutSideDismiss() && event.getAction() == MotionEvent.ACTION_UP) {
             dismiss();
             return true;

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -2105,7 +2105,6 @@ public boolean onBackPressed() {
      * @return 返回True则意味着您消耗了该事件，该事件不再会被分发下去
      */
     public boolean onOutSideTouch(MotionEvent event, boolean touchInMask) {
-        PopupLog.i("onOutSideTouch", event.getRawX(), event.getRawY(), event.getX(), event.getY(), touchInMask);
         if (mHelper.isOutSideDismiss() && event.getAction() == MotionEvent.ACTION_UP) {
             dismiss();
             return true;

File: lib/src/main/java/razerdp/basepopup/BasePopupUnsafe.java
Patch:
@@ -35,7 +35,7 @@ public enum BasePopupUnsafe {
      */
     @Deprecated
     public void dismissAllPopup(boolean animateDismiss) {
-        HashMap<String, LinkedList<WindowManagerProxy>> allCache = WindowManagerProxy.PopupWindowQueueManager.sQueueMap;
+        HashMap<String, LinkedList<WindowManagerProxy>> allCache = new HashMap<>(WindowManagerProxy.PopupWindowQueueManager.sQueueMap);
         if (!allCache.isEmpty()) {
             for (LinkedList<WindowManagerProxy> value : allCache.values()) {
                 for (WindowManagerProxy proxy : value) {
@@ -45,6 +45,8 @@ public void dismissAllPopup(boolean animateDismiss) {
                 }
             }
         }
+        allCache.clear();
+        allCache = null;
     }
 
     /**

File: lib/src/main/java/razerdp/basepopup/BasePopupUnsafe.java
Patch:
@@ -35,7 +35,7 @@ public enum BasePopupUnsafe {
      */
     @Deprecated
     public void dismissAllPopup(boolean animateDismiss) {
-        HashMap<String, LinkedList<WindowManagerProxy>> allCache = WindowManagerProxy.PopupWindowQueueManager.sQueueMap;
+        HashMap<String, LinkedList<WindowManagerProxy>> allCache = new HashMap<>(WindowManagerProxy.PopupWindowQueueManager.sQueueMap);
         if (!allCache.isEmpty()) {
             for (LinkedList<WindowManagerProxy> value : allCache.values()) {
                 for (WindowManagerProxy proxy : value) {
@@ -45,6 +45,8 @@ public void dismissAllPopup(boolean animateDismiss) {
                 }
             }
         }
+        allCache.clear();
+        allCache = null;
     }
 
     /**

File: lib/src/main/java/razerdp/basepopup/BasePopupHelper.java
Patch:
@@ -104,6 +104,7 @@ enum ShowMode {
 
     int animationStyleRes;
 
+    boolean isStartShowing = false;
     //callback
     BasePopupWindow.OnDismissListener mOnDismissListener;
     BasePopupWindow.OnBeforeShowCallback mOnBeforeShowCallback;
@@ -891,6 +892,7 @@ public void onGlobalLayout() {
     }
 
     void onAttachToWindow() {
+        isStartShowing = false;
         if (mPopupWindow != null) {
             mPopupWindow.onShowing();
         }
@@ -949,6 +951,7 @@ void dismiss(boolean animateDismiss) {
         if (mPopupWindow.mDisplayAnimateView == null || animateDismiss && (flag & CUSTOM_ON_ANIMATE_DISMISS) != 0) {
             return;
         }
+        isStartShowing = false;
         Message msg = BasePopupEvent.getMessage(BasePopupEvent.EVENT_DISMISS);
         if (animateDismiss) {
             startDismissAnimate(mPopupWindow.mDisplayAnimateView.getWidth(),

File: lib/src/main/java/razerdp/basepopup/BasePopupHelper.java
Patch:
@@ -104,6 +104,7 @@ enum ShowMode {
 
     int animationStyleRes;
 
+    boolean isStartShowing = false;
     //callback
     BasePopupWindow.OnDismissListener mOnDismissListener;
     BasePopupWindow.OnBeforeShowCallback mOnBeforeShowCallback;
@@ -891,6 +892,7 @@ public void onGlobalLayout() {
     }
 
     void onAttachToWindow() {
+        isStartShowing = false;
         if (mPopupWindow != null) {
             mPopupWindow.onShowing();
         }
@@ -949,6 +951,7 @@ void dismiss(boolean animateDismiss) {
         if (mPopupWindow.mDisplayAnimateView == null || animateDismiss && (flag & CUSTOM_ON_ANIMATE_DISMISS) != 0) {
             return;
         }
+        isStartShowing = false;
         Message msg = BasePopupEvent.getMessage(BasePopupEvent.EVENT_DISMISS);
         if (animateDismiss) {
             startDismissAnimate(mPopupWindow.mDisplayAnimateView.getWidth(),

File: lib/src/main/java/razerdp/blur/BlurImageView.java
Patch:
@@ -315,6 +315,7 @@ class CreateBlurBitmapRunnable implements Runnable {
         CreateBlurBitmapRunnable(View target) {
             outWidth = target.getWidth();
             outHeight = target.getHeight();
+            PopupLog.i("aaadf", cutoutX, cutoutY);
             mBitmap = BlurHelper.getViewBitmap(target, mBlurOption.getBlurPreScaleRatio(), mBlurOption
                     .isFullScreen(), cutoutX, cutoutY);
         }

File: lib/src/main/java/razerdp/blur/BlurImageView.java
Patch:
@@ -315,6 +315,7 @@ class CreateBlurBitmapRunnable implements Runnable {
         CreateBlurBitmapRunnable(View target) {
             outWidth = target.getWidth();
             outHeight = target.getHeight();
+            PopupLog.i("aaadf", cutoutX, cutoutY);
             mBitmap = BlurHelper.getViewBitmap(target, mBlurOption.getBlurPreScaleRatio(), mBlurOption
                     .isFullScreen(), cutoutX, cutoutY);
         }

File: lib/src/main/java/razerdp/basepopup/PopupDecorViewProxy.java
Patch:
@@ -390,7 +390,7 @@ private void layoutInternal(int l, int t, int r, int b) {
                             contentRect.left = anchorBound.left;
                             offsetX += anchorBound.centerX() - (contentRect.left + (width >> 1));
                         } else {
-                            contentRect.left = ((contentBounds.width() - width) >> 1);
+                            contentRect.left = contentBounds.left + ((contentBounds.width() - width) >> 1);
                         }
                         break;
                     default:
@@ -424,7 +424,7 @@ private void layoutInternal(int l, int t, int r, int b) {
                             contentRect.top = anchorBound.bottom;
                             offsetY += anchorBound.centerY() - (contentRect.top + (height >> 1));
                         } else {
-                            contentRect.top = ((contentBounds.height() - height) >> 1);
+                            contentRect.top = contentBounds.top + ((contentBounds.height() - height) >> 1);
                         }
                         break;
                     default:

File: lib/src/main/java/razerdp/basepopup/PopupDecorViewProxy.java
Patch:
@@ -390,7 +390,7 @@ private void layoutInternal(int l, int t, int r, int b) {
                             contentRect.left = anchorBound.left;
                             offsetX += anchorBound.centerX() - (contentRect.left + (width >> 1));
                         } else {
-                            contentRect.left = ((contentBounds.width() - width) >> 1);
+                            contentRect.left = contentBounds.left + ((contentBounds.width() - width) >> 1);
                         }
                         break;
                     default:
@@ -424,7 +424,7 @@ private void layoutInternal(int l, int t, int r, int b) {
                             contentRect.top = anchorBound.bottom;
                             offsetY += anchorBound.centerY() - (contentRect.top + (height >> 1));
                         } else {
-                            contentRect.top = ((contentBounds.height() - height) >> 1);
+                            contentRect.top = contentBounds.top + ((contentBounds.height() - height) >> 1);
                         }
                         break;
                     default:

File: lib/src/main/java/razerdp/util/PopupUiUtils.java
Patch:
@@ -119,6 +119,7 @@ public static void setBackground(View v, Drawable background) {
 
     public static void safeAddGlobalLayoutListener(View v, ViewTreeObserver.OnGlobalLayoutListener listener) {
         try {
+            v.getViewTreeObserver().removeOnGlobalLayoutListener(listener);
             v.getViewTreeObserver().addOnGlobalLayoutListener(listener);
         } catch (Exception e) {
             PopupLog.e(e);

File: lib/src/main/java/razerdp/util/PopupUiUtils.java
Patch:
@@ -119,6 +119,7 @@ public static void setBackground(View v, Drawable background) {
 
     public static void safeAddGlobalLayoutListener(View v, ViewTreeObserver.OnGlobalLayoutListener listener) {
         try {
+            v.getViewTreeObserver().removeOnGlobalLayoutListener(listener);
             v.getViewTreeObserver().addOnGlobalLayoutListener(listener);
         } catch (Exception e) {
             PopupLog.e(e);

File: app/src/main/java/razerdp/demo/DemoActivity.java
Patch:
@@ -23,7 +23,6 @@
 import razerdp.demo.base.baseadapter.BaseSimpleRecyclerViewHolder;
 import razerdp.demo.base.baseadapter.SimpleRecyclerViewAdapter;
 import razerdp.demo.model.DemoMainItem;
-import razerdp.demo.popup.update.PopupUpdate;
 import razerdp.demo.ui.ActivityLauncher;
 import razerdp.demo.ui.ApiListActivity;
 import razerdp.demo.ui.CommonUsageActivity;

File: app/src/main/java/razerdp/demo/DemoActivity.java
Patch:
@@ -23,7 +23,6 @@
 import razerdp.demo.base.baseadapter.BaseSimpleRecyclerViewHolder;
 import razerdp.demo.base.baseadapter.SimpleRecyclerViewAdapter;
 import razerdp.demo.model.DemoMainItem;
-import razerdp.demo.popup.update.PopupUpdate;
 import razerdp.demo.ui.ActivityLauncher;
 import razerdp.demo.ui.ApiListActivity;
 import razerdp.demo.ui.CommonUsageActivity;

File: lib/src/main/java/razerdp/util/SimpleAnimationUtils.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.animation.AnimatorSet;
 import android.animation.ObjectAnimator;
+import android.content.res.Resources;
 import android.view.View;
 import android.view.animation.AccelerateInterpolator;
 import android.view.animation.AlphaAnimation;
@@ -66,7 +67,7 @@ public static Animation getScaleAnimation(float fromX,
         Animation scaleAnimation = new ScaleAnimation(fromX, toX, fromY, toY, pivotXType, pivotXValue, pivotYType,
                 pivotYValue
         );
-        scaleAnimation.setDuration(360);
+        scaleAnimation.setDuration(Resources.getSystem().getInteger(android.R.integer.config_mediumAnimTime));
         return scaleAnimation;
     }
 

File: lib/src/main/java/razerdp/util/SimpleAnimationUtils.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.animation.AnimatorSet;
 import android.animation.ObjectAnimator;
+import android.content.res.Resources;
 import android.view.View;
 import android.view.animation.AccelerateInterpolator;
 import android.view.animation.AlphaAnimation;
@@ -66,7 +67,7 @@ public static Animation getScaleAnimation(float fromX,
         Animation scaleAnimation = new ScaleAnimation(fromX, toX, fromY, toY, pivotXType, pivotXValue, pivotYType,
                 pivotYValue
         );
-        scaleAnimation.setDuration(360);
+        scaleAnimation.setDuration(Resources.getSystem().getInteger(android.R.integer.config_mediumAnimTime));
         return scaleAnimation;
     }
 

File: lib/src/main/java/razerdp/basepopup/BasePopupHelper.java
Patch:
@@ -712,7 +712,6 @@ void prepare(View v, boolean positionMode) {
 
     private void applyToPopupWindow() {
         if (mPopupWindow == null || mPopupWindow.mPopupWindowProxy == null) return;
-        mPopupWindow.mPopupWindowProxy.setSoftInputMode(isAutoShowInputMethod() ? WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE : WindowManager.LayoutParams.SOFT_INPUT_STATE_UNCHANGED);
         mPopupWindow.mPopupWindowProxy.setSoftInputMode(mSoftInputMode);
         mPopupWindow.mPopupWindowProxy.setAnimationStyle(animationStyleRes);
     }
@@ -952,6 +951,7 @@ public void onGlobalLayout() {
                 int screenHeight = content == null ? decor.getHeight() : content.getHeight();
                 keyboardRect.set(rect.left, rect.bottom, rect.right, screenHeight);
                 boolean isVisible = keyboardRect.height() > (screenHeight >> 2) && KeyboardUtils.isOpen();
+                PopupLog.i("Issue277", screenHeight, keyboardRect.height(), isVisible);
                 if (isVisible == lastVisible && keyboardRect.height() == lastHeight) return;
                 lastVisible = isVisible;
                 lastHeight = keyboardRect.height();

File: lib/src/main/java/razerdp/basepopup/BasePopupHelper.java
Patch:
@@ -712,7 +712,6 @@ void prepare(View v, boolean positionMode) {
 
     private void applyToPopupWindow() {
         if (mPopupWindow == null || mPopupWindow.mPopupWindowProxy == null) return;
-        mPopupWindow.mPopupWindowProxy.setSoftInputMode(isAutoShowInputMethod() ? WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE : WindowManager.LayoutParams.SOFT_INPUT_STATE_UNCHANGED);
         mPopupWindow.mPopupWindowProxy.setSoftInputMode(mSoftInputMode);
         mPopupWindow.mPopupWindowProxy.setAnimationStyle(animationStyleRes);
     }
@@ -952,6 +951,7 @@ public void onGlobalLayout() {
                 int screenHeight = content == null ? decor.getHeight() : content.getHeight();
                 keyboardRect.set(rect.left, rect.bottom, rect.right, screenHeight);
                 boolean isVisible = keyboardRect.height() > (screenHeight >> 2) && KeyboardUtils.isOpen();
+                PopupLog.i("Issue277", screenHeight, keyboardRect.height(), isVisible);
                 if (isVisible == lastVisible && keyboardRect.height() == lastHeight) return;
                 lastVisible = isVisible;
                 lastHeight = keyboardRect.height();

File: lib/src/main/java/razerdp/basepopup/WindowManagerProxy.java
Patch:
@@ -83,9 +83,10 @@ private void applyHelper(ViewGroup.LayoutParams params, BasePopupHelper helper)
                 p.layoutInDisplayCutoutMode = LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT;
             }
             if (helper.isOverlayStatusbar()) {
-                PopupLog.i(TAG, "applyHelper  >>>  全屏（覆盖状态栏）");
+                PopupLog.i(TAG, "applyHelper  >>>  覆盖状态栏");
                 p.flags |= LayoutParams.FLAG_LAYOUT_IN_SCREEN;
                 if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR2) {
+                    PopupLog.i(TAG, "applyHelper  >>>  覆盖导航栏");
                     p.flags |= LayoutParams.FLAG_LAYOUT_IN_OVERSCAN;
                 }
                 if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {

File: lib/src/main/java/razerdp/basepopup/WindowManagerProxy.java
Patch:
@@ -83,9 +83,10 @@ private void applyHelper(ViewGroup.LayoutParams params, BasePopupHelper helper)
                 p.layoutInDisplayCutoutMode = LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT;
             }
             if (helper.isOverlayStatusbar()) {
-                PopupLog.i(TAG, "applyHelper  >>>  全屏（覆盖状态栏）");
+                PopupLog.i(TAG, "applyHelper  >>>  覆盖状态栏");
                 p.flags |= LayoutParams.FLAG_LAYOUT_IN_SCREEN;
                 if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR2) {
+                    PopupLog.i(TAG, "applyHelper  >>>  覆盖导航栏");
                     p.flags |= LayoutParams.FLAG_LAYOUT_IN_OVERSCAN;
                 }
                 if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {

File: lib/src/main/java/razerdp/util/SimpleAnimationUtils.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.animation.AnimatorSet;
 import android.animation.ObjectAnimator;
+import android.content.res.Resources;
 import android.view.View;
 import android.view.animation.AccelerateInterpolator;
 import android.view.animation.AlphaAnimation;
@@ -66,7 +67,7 @@ public static Animation getScaleAnimation(float fromX,
         Animation scaleAnimation = new ScaleAnimation(fromX, toX, fromY, toY, pivotXType, pivotXValue, pivotYType,
                 pivotYValue
         );
-        scaleAnimation.setDuration(360);
+        scaleAnimation.setDuration(Resources.getSystem().getInteger(android.R.integer.config_mediumAnimTime));
         return scaleAnimation;
     }
 

File: lib/src/main/java/razerdp/util/SimpleAnimationUtils.java
Patch:
@@ -2,6 +2,7 @@
 
 import android.animation.AnimatorSet;
 import android.animation.ObjectAnimator;
+import android.content.res.Resources;
 import android.view.View;
 import android.view.animation.AccelerateInterpolator;
 import android.view.animation.AlphaAnimation;
@@ -66,7 +67,7 @@ public static Animation getScaleAnimation(float fromX,
         Animation scaleAnimation = new ScaleAnimation(fromX, toX, fromY, toY, pivotXType, pivotXValue, pivotYType,
                 pivotYValue
         );
-        scaleAnimation.setDuration(360);
+        scaleAnimation.setDuration(Resources.getSystem().getInteger(android.R.integer.config_mediumAnimTime));
         return scaleAnimation;
     }
 

File: lib/src/main/java/razerdp/widget/QuickPopup.java
Patch:
@@ -7,10 +7,11 @@
 import android.view.View;
 import android.view.animation.Animation;
 
+import androidx.fragment.app.Fragment;
+
 import java.util.HashMap;
 import java.util.Map;
 
-import androidx.fragment.app.Fragment;
 import razerdp.basepopup.BaseLazyPopupWindow;
 import razerdp.basepopup.BasePopupFlag;
 import razerdp.basepopup.QuickPopupConfig;
@@ -73,6 +74,7 @@ protected <C extends QuickPopupConfig> void applyConfigSetting(C config) {
 
         setOutSideDismiss((config.flag & BasePopupFlag.OUT_SIDE_DISMISS) != 0);
         setOutSideTouchable((config.flag & BasePopupFlag.OUT_SIDE_TOUCHABLE) != 0);
+        setBackPressEnable((config.flag & BasePopupFlag.BACKPRESS_ENABLE) != 0);
         setPopupGravity(config.getGravity());
         setAlignBackground((config.flag & BasePopupFlag.ALIGN_BACKGROUND) != 0);
         setAlignBackgroundGravity(config.getAlignBackgroundGravity());

File: lib/src/main/java/razerdp/widget/QuickPopup.java
Patch:
@@ -7,10 +7,11 @@
 import android.view.View;
 import android.view.animation.Animation;
 
+import androidx.fragment.app.Fragment;
+
 import java.util.HashMap;
 import java.util.Map;
 
-import androidx.fragment.app.Fragment;
 import razerdp.basepopup.BaseLazyPopupWindow;
 import razerdp.basepopup.BasePopupFlag;
 import razerdp.basepopup.QuickPopupConfig;
@@ -73,6 +74,7 @@ protected <C extends QuickPopupConfig> void applyConfigSetting(C config) {
 
         setOutSideDismiss((config.flag & BasePopupFlag.OUT_SIDE_DISMISS) != 0);
         setOutSideTouchable((config.flag & BasePopupFlag.OUT_SIDE_TOUCHABLE) != 0);
+        setBackPressEnable((config.flag & BasePopupFlag.BACKPRESS_ENABLE) != 0);
         setPopupGravity(config.getGravity());
         setAlignBackground((config.flag & BasePopupFlag.ALIGN_BACKGROUND) != 0);
         setAlignBackgroundGravity(config.getAlignBackgroundGravity());

File: lib/src/main/java/razerdp/basepopup/PopupWindowProxy.java
Patch:
@@ -78,7 +78,7 @@ public void showAtLocation(View parent, int gravity, int x, int y) {
     }
 
     void onBeforeShowExec(Activity act) {
-        if (needObserverUiVisibilityChange(act)) {
+        if (isFullScreen(act)) {
             handleFullScreenFocusable();
         }
     }
@@ -90,7 +90,7 @@ void onAfterShowExec(Activity act) {
         }
     }
 
-    boolean needObserverUiVisibilityChange(Activity act) {
+    boolean isFullScreen(Activity act) {
         if (act == null) return false;
         try {
             View decorView = act.getWindow().getDecorView();
@@ -99,7 +99,7 @@ boolean needObserverUiVisibilityChange(Activity act) {
             int f = decorView.getWindowSystemUiVisibility();
 
             return (i & WindowManager.LayoutParams.FLAG_FULLSCREEN) != 0
-                    && ((f & View.SYSTEM_UI_FLAG_HIDE_NAVIGATION) != 0 || (f & View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION) != 0);
+                    || ((f & View.SYSTEM_UI_FLAG_HIDE_NAVIGATION) != 0 || (f & View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION) != 0);
         } catch (Exception e) {
             return false;
         }

File: lib/src/main/java/razerdp/basepopup/PopupWindowProxy.java
Patch:
@@ -78,7 +78,7 @@ public void showAtLocation(View parent, int gravity, int x, int y) {
     }
 
     void onBeforeShowExec(Activity act) {
-        if (needObserverUiVisibilityChange(act)) {
+        if (isFullScreen(act)) {
             handleFullScreenFocusable();
         }
     }
@@ -90,7 +90,7 @@ void onAfterShowExec(Activity act) {
         }
     }
 
-    boolean needObserverUiVisibilityChange(Activity act) {
+    boolean isFullScreen(Activity act) {
         if (act == null) return false;
         try {
             View decorView = act.getWindow().getDecorView();
@@ -99,7 +99,7 @@ boolean needObserverUiVisibilityChange(Activity act) {
             int f = decorView.getWindowSystemUiVisibility();
 
             return (i & WindowManager.LayoutParams.FLAG_FULLSCREEN) != 0
-                    && ((f & View.SYSTEM_UI_FLAG_HIDE_NAVIGATION) != 0 || (f & View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION) != 0);
+                    || ((f & View.SYSTEM_UI_FLAG_HIDE_NAVIGATION) != 0 || (f & View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION) != 0);
         } catch (Exception e) {
             return false;
         }

File: lib/src/main/java/razerdp/basepopup/QuickPopupBuilder.java
Patch:
@@ -122,6 +122,7 @@ public QuickPopup show() {
         return show(null);
     }
 
+    @Deprecated
     public QuickPopup show(int anchorViewResid) {
         QuickPopup quickPopup = build();
         quickPopup.showPopupWindow(anchorViewResid);

File: lib/src/main/java/razerdp/basepopup/QuickPopupBuilder.java
Patch:
@@ -122,6 +122,7 @@ public QuickPopup show() {
         return show(null);
     }
 
+    @Deprecated
     public QuickPopup show(int anchorViewResid) {
         QuickPopup quickPopup = build();
         quickPopup.showPopupWindow(anchorViewResid);

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -1405,8 +1405,8 @@ public BasePopupWindow setPopupGravity(int popupGravity) {
      * </ul>
      *
      * @param mode <ul><li>GravityMode.RELATIVE_TO_ANCHOR：该模式将会以Anchor作为参考点，表示Popup处于该Anchor的哪个位置</li>
-     *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <li>GravityMode.ALIGN_TO_ANCHOR_SIDE：该模式将会以Anchor作为参考点，表示Popup对齐Anchor的哪条边</li>
-     *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </ul>
+     *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <li>GravityMode.ALIGN_TO_ANCHOR_SIDE：该模式将会以Anchor作为参考点，表示Popup对齐Anchor的哪条边</li>
+     *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </ul>
      */
     public BasePopupWindow setPopupGravity(GravityMode mode, int popupGravity) {
         mHelper.setPopupGravity(mode, popupGravity);

File: lib/src/main/java/razerdp/basepopup/PopupWindowProxy.java
Patch:
@@ -38,6 +38,7 @@ public PopupWindowProxy(BasePopupContextWrapper context) {
         setFocusable(true);
         setOutsideTouchable(true);
         setBackgroundDrawable(new ColorDrawable());
+        setInputMethodMode(PopupWindow.INPUT_METHOD_NEEDED);
     }
 
 

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -1405,8 +1405,8 @@ public BasePopupWindow setPopupGravity(int popupGravity) {
      * </ul>
      *
      * @param mode <ul><li>GravityMode.RELATIVE_TO_ANCHOR：该模式将会以Anchor作为参考点，表示Popup处于该Anchor的哪个位置</li>
-     *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <li>GravityMode.ALIGN_TO_ANCHOR_SIDE：该模式将会以Anchor作为参考点，表示Popup对齐Anchor的哪条边</li>
-     *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </ul>
+     *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <li>GravityMode.ALIGN_TO_ANCHOR_SIDE：该模式将会以Anchor作为参考点，表示Popup对齐Anchor的哪条边</li>
+     *                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </ul>
      */
     public BasePopupWindow setPopupGravity(GravityMode mode, int popupGravity) {
         mHelper.setPopupGravity(mode, popupGravity);

File: lib/src/main/java/razerdp/basepopup/PopupWindowProxy.java
Patch:
@@ -38,6 +38,7 @@ public PopupWindowProxy(BasePopupContextWrapper context) {
         setFocusable(true);
         setOutsideTouchable(true);
         setBackgroundDrawable(new ColorDrawable());
+        setInputMethodMode(PopupWindow.INPUT_METHOD_NEEDED);
     }
 
 

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -1368,7 +1368,7 @@ public BasePopupWindow setPopupGravity(int popupGravity) {
      * </ul>
      *
      * @param mode         <ul><li>GravityMode.RELATIVE_TO_ANCHOR：该模式将会以Anchor作为参考点，表示Popup处于该Anchor的哪个位置</li>
-     *                     <li>GravityMode.ALIGN_TO_ANCHOR_SIDE：该模式将会以Anchor作为参考点，表示Popup对齐Anchor的哪个位置</li></ul>
+     *                                         <li>GravityMode.ALIGN_TO_ANCHOR_SIDE：该模式将会以Anchor作为参考点，表示Popup对齐Anchor的哪个位置</li></ul>
      * @param popupGravity
      */
     public BasePopupWindow setPopupGravity(GravityMode mode, int popupGravity) {
@@ -1635,10 +1635,11 @@ public BasePopupWindow setFitSize(boolean canResize) {
 
     void superDismiss() {
         try {
-            mHelper.onDismiss();
             mPopupWindow.superDismiss();
         } catch (Exception e) {
             e.printStackTrace();
+        } finally {
+            mHelper.onDismiss();
         }
     }
 

File: lib/src/main/java/razerdp/util/KeyboardUtils.java
Patch:
@@ -18,6 +18,8 @@ public class KeyboardUtils {
      * 显示软键盘
      */
     public static void open(View view) {
+        if (view == null) return;
+        view.requestFocus();
         InputMethodManager imm = (InputMethodManager) view.getContext()
                 .getSystemService(Context.INPUT_METHOD_SERVICE);
         if (imm != null) {
@@ -29,6 +31,7 @@ public static void open(View view) {
      * 显示软键盘
      */
     public static void open(Context context) {
+        if (context==null)return;
         InputMethodManager imm = (InputMethodManager) context
                 .getSystemService(Context.INPUT_METHOD_SERVICE);
         imm.toggleSoftInput(0, InputMethodManager.HIDE_NOT_ALWAYS);

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -1368,7 +1368,7 @@ public BasePopupWindow setPopupGravity(int popupGravity) {
      * </ul>
      *
      * @param mode         <ul><li>GravityMode.RELATIVE_TO_ANCHOR：该模式将会以Anchor作为参考点，表示Popup处于该Anchor的哪个位置</li>
-     *                     <li>GravityMode.ALIGN_TO_ANCHOR_SIDE：该模式将会以Anchor作为参考点，表示Popup对齐Anchor的哪个位置</li></ul>
+     *                                         <li>GravityMode.ALIGN_TO_ANCHOR_SIDE：该模式将会以Anchor作为参考点，表示Popup对齐Anchor的哪个位置</li></ul>
      * @param popupGravity
      */
     public BasePopupWindow setPopupGravity(GravityMode mode, int popupGravity) {
@@ -1635,10 +1635,11 @@ public BasePopupWindow setFitSize(boolean canResize) {
 
     void superDismiss() {
         try {
-            mHelper.onDismiss();
             mPopupWindow.superDismiss();
         } catch (Exception e) {
             e.printStackTrace();
+        } finally {
+            mHelper.onDismiss();
         }
     }
 

File: lib/src/main/java/razerdp/util/KeyboardUtils.java
Patch:
@@ -18,6 +18,8 @@ public class KeyboardUtils {
      * 显示软键盘
      */
     public static void open(View view) {
+        if (view == null) return;
+        view.requestFocus();
         InputMethodManager imm = (InputMethodManager) view.getContext()
                 .getSystemService(Context.INPUT_METHOD_SERVICE);
         if (imm != null) {
@@ -29,6 +31,7 @@ public static void open(View view) {
      * 显示软键盘
      */
     public static void open(Context context) {
+        if (context==null)return;
         InputMethodManager imm = (InputMethodManager) context
                 .getSystemService(Context.INPUT_METHOD_SERVICE);
         imm.toggleSoftInput(0, InputMethodManager.HIDE_NOT_ALWAYS);

File: app/src/main/java/razerdp/demo/base/baseactivity/BaseActivity.java
Patch:
@@ -34,7 +34,7 @@
 import razerdp.demo.utils.ToolUtil;
 import razerdp.demo.widget.StatusBarViewPlaceHolder;
 import razerdp.demo.widget.TitleBarView;
-import razerdp.util.InputMethodUtils;
+import razerdp.util.KeyboardUtils;
 import razerdp.util.log.PopupLog;
 
 public abstract class BaseActivity<T extends BaseActivity.IntentData>
@@ -314,7 +314,7 @@ protected void onDestroy() {
 
     @Override
     public void finish() {
-        InputMethodUtils.close(this);
+        KeyboardUtils.close(this);
         super.finish();
     }
 

File: app/src/main/java/razerdp/demo/base/baseactivity/BaseFragment.java
Patch:
@@ -21,7 +21,7 @@
 import razerdp.demo.utils.StringUtil;
 import razerdp.demo.widget.StatusBarViewPlaceHolder;
 import razerdp.demo.widget.TitleBarView;
-import razerdp.util.InputMethodUtils;
+import razerdp.util.KeyboardUtils;
 import razerdp.util.log.PopupLog;
 
 /**
@@ -106,7 +106,7 @@ public void clearMemory() {
     }
 
     protected boolean onBackPressed() {
-        InputMethodUtils.close(getActivity());
+        KeyboardUtils.close(getActivity());
         try {
             if (getFragmentManager() != null && getFragmentManager().getBackStackEntryCount() > 0) {
                 getFragmentManager().popBackStack();
@@ -121,7 +121,7 @@ protected boolean onBackPressed() {
     }
 
     protected void finishActivity() {
-        InputMethodUtils.close(getActivity());
+        KeyboardUtils.close(getActivity());
         try {
             getActivity().finish();
         } catch (Exception e) {

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -229,7 +229,7 @@ file or class name and description of purpose be included on the
 import java.lang.ref.WeakReference;
 
 import razerdp.blur.PopupBlurOption;
-import razerdp.util.InputMethodUtils;
+import razerdp.util.KeyboardUtils;
 import razerdp.util.PopupUiUtils;
 import razerdp.util.PopupUtils;
 import razerdp.util.SimpleAnimationUtils;
@@ -830,7 +830,7 @@ private void addGlobalListener() {
 
         Activity activity = getContext();
         if (activity == null) return;
-        mGlobalLayoutListener = InputMethodUtils.observerKeyboardChange(activity, new InputMethodUtils.OnKeyboardChangeListener() {
+        mGlobalLayoutListener = KeyboardUtils.observerKeyboardChange(activity, new KeyboardUtils.OnKeyboardChangeListener() {
             @Override
             public void onKeyboardChange(Rect keyboardBounds, boolean isVisible) {
                 mHelper.onKeyboardChange(keyboardBounds, isVisible);

File: lib/src/main/java/razerdp/basepopup/PopupDecorViewProxy.java
Patch:
@@ -19,7 +19,7 @@
 import android.view.WindowManager;
 import android.widget.FrameLayout;
 
-import razerdp.util.InputMethodUtils;
+import razerdp.util.KeyboardUtils;
 import razerdp.util.PopupUiUtils;
 import razerdp.util.PopupUtils;
 import razerdp.util.log.PopupLog;
@@ -29,7 +29,7 @@
  * <p>
  * 旨在用来拦截keyevent、以及蒙层
  */
-final class PopupDecorViewProxy extends ViewGroup implements InputMethodUtils.OnKeyboardChangeListener, ViewTreeObserver.OnGlobalLayoutListener {
+final class PopupDecorViewProxy extends ViewGroup implements KeyboardUtils.OnKeyboardChangeListener, ViewTreeObserver.OnGlobalLayoutListener {
     private static final String TAG = "PopupDecorViewProxy";
     //模糊层
     private PopupMaskLayout mMaskLayout;

File: app/src/main/java/razerdp/demo/base/baseactivity/BaseActivity.java
Patch:
@@ -34,7 +34,7 @@
 import razerdp.demo.utils.ToolUtil;
 import razerdp.demo.widget.StatusBarViewPlaceHolder;
 import razerdp.demo.widget.TitleBarView;
-import razerdp.util.InputMethodUtils;
+import razerdp.util.KeyboardUtils;
 import razerdp.util.log.PopupLog;
 
 public abstract class BaseActivity<T extends BaseActivity.IntentData>
@@ -314,7 +314,7 @@ protected void onDestroy() {
 
     @Override
     public void finish() {
-        InputMethodUtils.close(this);
+        KeyboardUtils.close(this);
         super.finish();
     }
 

File: app/src/main/java/razerdp/demo/base/baseactivity/BaseFragment.java
Patch:
@@ -21,7 +21,7 @@
 import razerdp.demo.utils.StringUtil;
 import razerdp.demo.widget.StatusBarViewPlaceHolder;
 import razerdp.demo.widget.TitleBarView;
-import razerdp.util.InputMethodUtils;
+import razerdp.util.KeyboardUtils;
 import razerdp.util.log.PopupLog;
 
 /**
@@ -106,7 +106,7 @@ public void clearMemory() {
     }
 
     protected boolean onBackPressed() {
-        InputMethodUtils.close(getActivity());
+        KeyboardUtils.close(getActivity());
         try {
             if (getFragmentManager() != null && getFragmentManager().getBackStackEntryCount() > 0) {
                 getFragmentManager().popBackStack();
@@ -121,7 +121,7 @@ protected boolean onBackPressed() {
     }
 
     protected void finishActivity() {
-        InputMethodUtils.close(getActivity());
+        KeyboardUtils.close(getActivity());
         try {
             getActivity().finish();
         } catch (Exception e) {

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -229,7 +229,7 @@ file or class name and description of purpose be included on the
 import java.lang.ref.WeakReference;
 
 import razerdp.blur.PopupBlurOption;
-import razerdp.util.InputMethodUtils;
+import razerdp.util.KeyboardUtils;
 import razerdp.util.PopupUiUtils;
 import razerdp.util.PopupUtils;
 import razerdp.util.SimpleAnimationUtils;
@@ -830,7 +830,7 @@ private void addGlobalListener() {
 
         Activity activity = getContext();
         if (activity == null) return;
-        mGlobalLayoutListener = InputMethodUtils.observerKeyboardChange(activity, new InputMethodUtils.OnKeyboardChangeListener() {
+        mGlobalLayoutListener = KeyboardUtils.observerKeyboardChange(activity, new KeyboardUtils.OnKeyboardChangeListener() {
             @Override
             public void onKeyboardChange(Rect keyboardBounds, boolean isVisible) {
                 mHelper.onKeyboardChange(keyboardBounds, isVisible);

File: lib/src/main/java/razerdp/basepopup/PopupDecorViewProxy.java
Patch:
@@ -19,7 +19,7 @@
 import android.view.WindowManager;
 import android.widget.FrameLayout;
 
-import razerdp.util.InputMethodUtils;
+import razerdp.util.KeyboardUtils;
 import razerdp.util.PopupUiUtils;
 import razerdp.util.PopupUtils;
 import razerdp.util.log.PopupLog;
@@ -29,7 +29,7 @@
  * <p>
  * 旨在用来拦截keyevent、以及蒙层
  */
-final class PopupDecorViewProxy extends ViewGroup implements InputMethodUtils.OnKeyboardChangeListener, ViewTreeObserver.OnGlobalLayoutListener {
+final class PopupDecorViewProxy extends ViewGroup implements KeyboardUtils.OnKeyboardChangeListener, ViewTreeObserver.OnGlobalLayoutListener {
     private static final String TAG = "PopupDecorViewProxy";
     //模糊层
     private PopupMaskLayout mMaskLayout;

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -960,7 +960,8 @@ public BasePopupWindow setAdjustInputMode(int viewId, int flag) {
         mHelper.setFlag(FLAG_KEYBOARD_ALIGN_TO_ROOT
                 | FLAG_KEYBOARD_ALIGN_TO_VIEW
                 | FLAG_KEYBOARD_IGNORE_OVER
-                | FLAG_KEYBOARD_ANIMATE_ALIGN, false);
+                | FLAG_KEYBOARD_ANIMATE_ALIGN
+                | FLAG_KEYBOARD_FORCE_ADJUST, false);
         mHelper.setFlag(flag, true);
         return this;
     }

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -960,7 +960,8 @@ public BasePopupWindow setAdjustInputMode(int viewId, int flag) {
         mHelper.setFlag(FLAG_KEYBOARD_ALIGN_TO_ROOT
                 | FLAG_KEYBOARD_ALIGN_TO_VIEW
                 | FLAG_KEYBOARD_IGNORE_OVER
-                | FLAG_KEYBOARD_ANIMATE_ALIGN, false);
+                | FLAG_KEYBOARD_ANIMATE_ALIGN
+                | FLAG_KEYBOARD_FORCE_ADJUST, false);
         mHelper.setFlag(flag, true);
         return this;
     }

File: app/src/main/java/razerdp/demo/DemoActivity.java
Patch:
@@ -26,6 +26,7 @@
 import razerdp.demo.ui.ActivityLauncher;
 import razerdp.demo.ui.CommonUsageActivity;
 import razerdp.demo.ui.GuideActivity;
+import razerdp.demo.ui.issuestest.home.IssueHomeActivity;
 import razerdp.demo.update.UpdateRequest;
 import razerdp.demo.update.entity.UpdateInfo;
 import razerdp.demo.utils.ButterKnifeUtil;
@@ -112,6 +113,7 @@ private List<DemoMainItem> generateItem() {
         List<DemoMainItem> result = new ArrayList<>();
         result.add(new DemoMainItem(GuideActivity.class, "简介", GuideActivity.DESC, null));
         result.add(new DemoMainItem(CommonUsageActivity.class, "快速入门", CommonUsageActivity.DESC, "入门推荐"));
+        result.add(new DemoMainItem(IssueHomeActivity.class, "Issue测试Demo", IssueHomeActivity.DESC, "issue"));
         return result;
     }
 

File: app/src/main/java/razerdp/demo/DemoActivity.java
Patch:
@@ -26,6 +26,7 @@
 import razerdp.demo.ui.ActivityLauncher;
 import razerdp.demo.ui.CommonUsageActivity;
 import razerdp.demo.ui.GuideActivity;
+import razerdp.demo.ui.issuestest.home.IssueHomeActivity;
 import razerdp.demo.update.UpdateRequest;
 import razerdp.demo.update.entity.UpdateInfo;
 import razerdp.demo.utils.ButterKnifeUtil;
@@ -112,6 +113,7 @@ private List<DemoMainItem> generateItem() {
         List<DemoMainItem> result = new ArrayList<>();
         result.add(new DemoMainItem(GuideActivity.class, "简介", GuideActivity.DESC, null));
         result.add(new DemoMainItem(CommonUsageActivity.class, "快速入门", CommonUsageActivity.DESC, "入门推荐"));
+        result.add(new DemoMainItem(IssueHomeActivity.class, "Issue测试Demo", IssueHomeActivity.DESC, "issue"));
         return result;
     }
 

File: app/src/main/java/razerdp/demo/fragment/basedemo/OutSideTouchPopupFrag.java
Patch:
@@ -11,7 +11,6 @@
 import razerdp.basepopup.BasePopupWindow;
 import razerdp.basepopup.R;
 import razerdp.demo.fragment.other.SimpleBaseFrag;
-import razerdp.demo.popup.AutoLocatedRecyclerViewPopup;
 import razerdp.demo.popup.DemoPopup;
 import razerdp.demo.utils.MultiSpanUtil;
 import razerdp.demo.utils.UIHelper;

File: app/src/main/java/razerdp/demo/fragment/basedemo/OutSideTouchPopupFrag.java
Patch:
@@ -11,7 +11,6 @@
 import razerdp.basepopup.BasePopupWindow;
 import razerdp.basepopup.R;
 import razerdp.demo.fragment.other.SimpleBaseFrag;
-import razerdp.demo.popup.AutoLocatedRecyclerViewPopup;
 import razerdp.demo.popup.DemoPopup;
 import razerdp.demo.utils.MultiSpanUtil;
 import razerdp.demo.utils.UIHelper;

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -1344,7 +1344,7 @@ public Animator getDismissAnimator() {
      * @return 返回对应的context。如果为空，则返回{@code null}
      */
     public Activity getContext() {
-        return mContext == null ? null : PopupUtils.scanForActivity(mContext.get(),15);
+        return mContext == null ? null : PopupUtils.scanForActivity(mContext.get(), 15);
     }
 
     /**

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -1344,7 +1344,7 @@ public Animator getDismissAnimator() {
      * @return 返回对应的context。如果为空，则返回{@code null}
      */
     public Activity getContext() {
-        return mContext == null ? null : PopupUtils.scanForActivity(mContext.get(),15);
+        return mContext == null ? null : PopupUtils.scanForActivity(mContext.get(), 15);
     }
 
     /**

File: lib/src/main/java/razerdp/basepopup/BasePopupWindowProxy.java
Patch:
@@ -215,7 +215,7 @@ private void troToProxyWindowManagerMethodBeforeP(PopupWindow popupWindow) {
     public void update() {
         try {
             if (mHelper != null) {
-                if (mHelper.isInterceptTouchEvent()) {
+                if (!mHelper.isOutSideTouchable()) {
                     if (mWindowManagerProxy != null) {
                         mWindowManagerProxy.update();
                     }

File: lib/src/main/java/razerdp/basepopup/PopupWindowActionListener.java
Patch:
@@ -9,4 +9,5 @@ interface PopupWindowActionListener {
 
     void onDismiss(boolean hasAnimate);
 
+    boolean onUpdate();
 }

File: lib/src/main/java/razerdp/basepopup/WindowManagerProxy.java
Patch:
@@ -81,7 +81,7 @@ private void applyHelper(ViewGroup.LayoutParams params, BasePopupHelper helper)
             if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {
                 p.layoutInDisplayCutoutMode = LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT;
             }
-            if (!helper.isInterceptTouchEvent()) {
+            if (helper.isOutSideTouchable()) {
                 PopupLogUtil.trace(LogTag.i, TAG, "applyHelper  >>>  不拦截事件");
                 p.flags |= LayoutParams.FLAG_NOT_TOUCH_MODAL;
                 p.flags |= LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH;
@@ -96,7 +96,7 @@ private void applyHelper(ViewGroup.LayoutParams params, BasePopupHelper helper)
                     //允许占用刘海
                     p.layoutInDisplayCutoutMode = LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES;
                 }
-                if (helper.isInterceptTouchEvent()) {
+                if (!helper.isOutSideTouchable()) {
                     p.flags |= LayoutParams.FLAG_LAYOUT_NO_LIMITS;
                 }
             }
@@ -111,7 +111,7 @@ private ViewGroup.LayoutParams fitLayoutParamsPosition(PopupDecorViewProxy viewP
                 if (helper.getShowCount() > 1) {
                     p.type = LayoutParams.TYPE_APPLICATION_SUB_PANEL;
                 }
-                if (helper.isInterceptTouchEvent()) {
+                if (!helper.isOutSideTouchable()) {
                     //偏移交给PopupDecorViewProxy处理，此处固定为0
                     p.y = 0;
                     p.x = 0;

File: lib/src/main/java/razerdp/basepopup/BasePopupWindowProxy.java
Patch:
@@ -215,7 +215,7 @@ private void troToProxyWindowManagerMethodBeforeP(PopupWindow popupWindow) {
     public void update() {
         try {
             if (mHelper != null) {
-                if (mHelper.isInterceptTouchEvent()) {
+                if (!mHelper.isOutSideTouchable()) {
                     if (mWindowManagerProxy != null) {
                         mWindowManagerProxy.update();
                     }

File: lib/src/main/java/razerdp/basepopup/PopupWindowActionListener.java
Patch:
@@ -9,4 +9,5 @@ interface PopupWindowActionListener {
 
     void onDismiss(boolean hasAnimate);
 
+    boolean onUpdate();
 }

File: lib/src/main/java/razerdp/basepopup/WindowManagerProxy.java
Patch:
@@ -81,7 +81,7 @@ private void applyHelper(ViewGroup.LayoutParams params, BasePopupHelper helper)
             if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {
                 p.layoutInDisplayCutoutMode = LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT;
             }
-            if (!helper.isInterceptTouchEvent()) {
+            if (helper.isOutSideTouchable()) {
                 PopupLogUtil.trace(LogTag.i, TAG, "applyHelper  >>>  不拦截事件");
                 p.flags |= LayoutParams.FLAG_NOT_TOUCH_MODAL;
                 p.flags |= LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH;
@@ -96,7 +96,7 @@ private void applyHelper(ViewGroup.LayoutParams params, BasePopupHelper helper)
                     //允许占用刘海
                     p.layoutInDisplayCutoutMode = LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES;
                 }
-                if (helper.isInterceptTouchEvent()) {
+                if (!helper.isOutSideTouchable()) {
                     p.flags |= LayoutParams.FLAG_LAYOUT_NO_LIMITS;
                 }
             }
@@ -111,7 +111,7 @@ private ViewGroup.LayoutParams fitLayoutParamsPosition(PopupDecorViewProxy viewP
                 if (helper.getShowCount() > 1) {
                     p.type = LayoutParams.TYPE_APPLICATION_SUB_PANEL;
                 }
-                if (helper.isInterceptTouchEvent()) {
+                if (!helper.isOutSideTouchable()) {
                     //偏移交给PopupDecorViewProxy处理，此处固定为0
                     p.y = 0;
                     p.x = 0;

File: app/src/main/java/razerdp/demo/fragment/basedemo/AutoLocatedPopupFrag.java
Patch:
@@ -49,8 +49,10 @@ public void onInitView(View rootView) {
             @Override
             public void onClick(View v) {
                 if (mUseRcv.isChecked()) {
+                    mAutoLocatedRecyclerViewPopup.setPopupGravity((v == popup_show || v == popup_show1) ? Gravity.TOP : Gravity.BOTTOM);
                     mAutoLocatedRecyclerViewPopup.showPopupWindow(v);
                 } else {
+                    mAutoLocatedPopup.setPopupGravity((v == popup_show || v == popup_show1) ? Gravity.TOP : Gravity.BOTTOM);
                     mAutoLocatedPopup.showPopupWindow(v);
                 }
             }

File: app/src/main/java/razerdp/demo/fragment/other/DismissControlPopupFrag.java
Patch:
@@ -47,9 +47,9 @@ public void onInitView(View rootView) {
         mDismissControlPopup.setOnBeforeShowCallback(new BasePopupWindow.OnBeforeShowCallback() {
             @Override
             public boolean onBeforeShow(View popupRootView, View anchorView, boolean hasShowAnima) {
-                mDismissControlPopup.setAllowDismissWhenTouchOutside(switchDismissWhenTouchOutside.isChecked());
+                mDismissControlPopup.setOutSideDismiss(switchDismissWhenTouchOutside.isChecked());
                 mDismissControlPopup.setBackPressEnable(switchBackpressEnable.isChecked());
-                mDismissControlPopup.setAllowInterceptTouchEvent(switchInterceptTouchEvent.isChecked());
+                mDismissControlPopup.setOutSideTouchable(switchInterceptTouchEvent.isChecked());
                 return true;
             }
         });

File: app/src/main/java/razerdp/demo/popup/DialogPopup.java
Patch:
@@ -32,7 +32,6 @@ public DialogPopup(Context context) {
         setViewClickListener(this, ok, cancel);
         setPopupGravity(Gravity.CENTER);
         setClipChildren(false);
-        setAllowInterceptTouchEvent(false);
     }
 
     @Override

File: app/src/main/java/razerdp/demo/fragment/basedemo/AutoLocatedPopupFrag.java
Patch:
@@ -49,8 +49,10 @@ public void onInitView(View rootView) {
             @Override
             public void onClick(View v) {
                 if (mUseRcv.isChecked()) {
+                    mAutoLocatedRecyclerViewPopup.setPopupGravity((v == popup_show || v == popup_show1) ? Gravity.TOP : Gravity.BOTTOM);
                     mAutoLocatedRecyclerViewPopup.showPopupWindow(v);
                 } else {
+                    mAutoLocatedPopup.setPopupGravity((v == popup_show || v == popup_show1) ? Gravity.TOP : Gravity.BOTTOM);
                     mAutoLocatedPopup.showPopupWindow(v);
                 }
             }

File: app/src/main/java/razerdp/demo/fragment/other/DismissControlPopupFrag.java
Patch:
@@ -47,9 +47,9 @@ public void onInitView(View rootView) {
         mDismissControlPopup.setOnBeforeShowCallback(new BasePopupWindow.OnBeforeShowCallback() {
             @Override
             public boolean onBeforeShow(View popupRootView, View anchorView, boolean hasShowAnima) {
-                mDismissControlPopup.setAllowDismissWhenTouchOutside(switchDismissWhenTouchOutside.isChecked());
+                mDismissControlPopup.setOutSideDismiss(switchDismissWhenTouchOutside.isChecked());
                 mDismissControlPopup.setBackPressEnable(switchBackpressEnable.isChecked());
-                mDismissControlPopup.setAllowInterceptTouchEvent(switchInterceptTouchEvent.isChecked());
+                mDismissControlPopup.setOutSideTouchable(switchInterceptTouchEvent.isChecked());
                 return true;
             }
         });

File: app/src/main/java/razerdp/demo/popup/DialogPopup.java
Patch:
@@ -32,7 +32,6 @@ public DialogPopup(Context context) {
         setViewClickListener(this, ok, cancel);
         setPopupGravity(Gravity.CENTER);
         setClipChildren(false);
-        setAllowInterceptTouchEvent(false);
     }
 
     @Override

File: lib/src/main/java/razerdp/util/PopupUiUtils.java
Patch:
@@ -71,6 +71,7 @@ public static boolean checkHasNavigationBar(Context context) {
                 final int childCount = decorView.getChildCount();
                 for (int i = 0; i < childCount; i++) {
                     View child = decorView.getChildAt(i);
+                    if (child.getId()==View.NO_ID)continue;
                     String resourceEntryName;
                     try {
                         resourceEntryName = act.getResources().getResourceEntryName(child.getId());

File: lib/src/main/java/razerdp/util/PopupUiUtils.java
Patch:
@@ -71,6 +71,7 @@ public static boolean checkHasNavigationBar(Context context) {
                 final int childCount = decorView.getChildCount();
                 for (int i = 0; i < childCount; i++) {
                     View child = decorView.getChildAt(i);
+                    if (child.getId()==View.NO_ID)continue;
                     String resourceEntryName;
                     try {
                         resourceEntryName = act.getResources().getResourceEntryName(child.getId());

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -427,7 +427,7 @@ private void initView(int width, int height) {
         //默认占满全屏
         mPopupWindow = new PopupWindowProxy(mContentView, width, height, mHelper);
         mPopupWindow.setOnDismissListener(this);
-        mPopupWindow.bindPopupHelper(mHelper);
+        mPopupWindow.attachPopupHelper(mHelper);
         setAllowDismissWhenTouchOutside(true);
         setPopupAnimationStyle(0);
 

File: lib/src/main/java/razerdp/basepopup/BasePopupWindowProxy.java
Patch:
@@ -74,11 +74,11 @@ public BasePopupWindowProxy(View contentView, int width, int height, boolean foc
         init(contentView.getContext());
     }
 
-    void bindPopupHelper(BasePopupHelper mHelper) {
+    void attachPopupHelper(BasePopupHelper mHelper) {
         if (mWindowManagerProxy == null) {
             tryToProxyWindowManagerMethod(this);
         }
-        mWindowManagerProxy.bindPopupHelper(mHelper);
+        mWindowManagerProxy.attachPopupHelper(mHelper);
     }
 
     private void init(Context context) {

File: lib/src/main/java/razerdp/widget/QuickPopup.java
Patch:
@@ -73,6 +73,7 @@ protected <C extends QuickPopupConfig> void applyConfigSetting(C config) {
         setPopupGravity(config.getGravity());
         setAlignBackground(config.isAlignBackground());
         setAutoLocatePopup(config.isAutoLocated());
+        setOnDismissListener(config.getDismissListener());
         if (config.getBackground() != null) {
             setBackground(config.getBackground());
         }

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -427,7 +427,7 @@ private void initView(int width, int height) {
         //默认占满全屏
         mPopupWindow = new PopupWindowProxy(mContentView, width, height, mHelper);
         mPopupWindow.setOnDismissListener(this);
-        mPopupWindow.bindPopupHelper(mHelper);
+        mPopupWindow.attachPopupHelper(mHelper);
         setAllowDismissWhenTouchOutside(true);
         setPopupAnimationStyle(0);
 

File: lib/src/main/java/razerdp/basepopup/BasePopupWindowProxy.java
Patch:
@@ -74,11 +74,11 @@ public BasePopupWindowProxy(View contentView, int width, int height, boolean foc
         init(contentView.getContext());
     }
 
-    void bindPopupHelper(BasePopupHelper mHelper) {
+    void attachPopupHelper(BasePopupHelper mHelper) {
         if (mWindowManagerProxy == null) {
             tryToProxyWindowManagerMethod(this);
         }
-        mWindowManagerProxy.bindPopupHelper(mHelper);
+        mWindowManagerProxy.attachPopupHelper(mHelper);
     }
 
     private void init(Context context) {

File: lib/src/main/java/razerdp/widget/QuickPopup.java
Patch:
@@ -73,6 +73,7 @@ protected <C extends QuickPopupConfig> void applyConfigSetting(C config) {
         setPopupGravity(config.getGravity());
         setAlignBackground(config.isAlignBackground());
         setAutoLocatePopup(config.isAutoLocated());
+        setOnDismissListener(config.getDismissListener());
         if (config.getBackground() != null) {
             setBackground(config.getBackground());
         }

File: lib/src/main/java/razerdp/basepopup/WindowManagerProxy.java
Patch:
@@ -202,7 +202,7 @@ private BasePopupHelper getBasePopupHelper() {
         return mPopupHelper.get();
     }
 
-    void bindPopupHelper(BasePopupHelper helper) {
+    void attachPopupHelper(BasePopupHelper helper) {
         mPopupHelper = new WeakReference<BasePopupHelper>(helper);
     }
 

File: lib/src/main/java/razerdp/basepopup/WindowManagerProxy.java
Patch:
@@ -202,7 +202,7 @@ private BasePopupHelper getBasePopupHelper() {
         return mPopupHelper.get();
     }
 
-    void bindPopupHelper(BasePopupHelper helper) {
+    void attachPopupHelper(BasePopupHelper helper) {
         mPopupHelper = new WeakReference<BasePopupHelper>(helper);
     }
 

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -243,7 +243,6 @@ file or class name and description of purpose be included on the
 import razerdp.util.SimpleAnimationUtils;
 import razerdp.util.log.LogTag;
 import razerdp.util.log.PopupLogUtil;
-import razerdp.widget.QuickPopup;
 
 /**
  * <br>
@@ -387,7 +386,7 @@ public BasePopupWindow(Context context, int width, int height) {
      */
     public BasePopupWindow(Context context, int width, int height, boolean delayInit) {
         mContext = new WeakReference<Context>(context);
-        if (!(this instanceof QuickPopup) && !delayInit) {
+        if (!delayInit) {
             initView(width, height);
         } else {
             mDelayInitCached = new DelayInitCached();
@@ -436,7 +435,6 @@ private void initView(int width, int height) {
 
         hookContentViewDismissClick(width, height);
         preMeasurePopupView(width, height);
-
         //show or dismiss animate
         mHelper.setShowAnimation(onCreateShowAnimation())
                 .setShowAnimator(onCreateShowAnimator())

File: lib/src/main/java/razerdp/basepopup/QuickPopupConfig.java
Patch:
@@ -3,6 +3,7 @@
 import android.animation.Animator;
 import android.graphics.drawable.ColorDrawable;
 import android.graphics.drawable.Drawable;
+import android.os.Build;
 import android.util.Pair;
 import android.view.Gravity;
 import android.view.View;
@@ -26,7 +27,7 @@ public class QuickPopupConfig {
     Animator mShowAnimator;
     Animator mDismissAnimator;
 
-    boolean fadeEnable = true;
+    boolean fadeEnable = Build.VERSION.SDK_INT != Build.VERSION_CODES.M;
 
     BasePopupWindow.OnDismissListener mDismissListener;
 

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -243,7 +243,6 @@ file or class name and description of purpose be included on the
 import razerdp.util.SimpleAnimationUtils;
 import razerdp.util.log.LogTag;
 import razerdp.util.log.PopupLogUtil;
-import razerdp.widget.QuickPopup;
 
 /**
  * <br>
@@ -387,7 +386,7 @@ public BasePopupWindow(Context context, int width, int height) {
      */
     public BasePopupWindow(Context context, int width, int height, boolean delayInit) {
         mContext = new WeakReference<Context>(context);
-        if (!(this instanceof QuickPopup) && !delayInit) {
+        if (!delayInit) {
             initView(width, height);
         } else {
             mDelayInitCached = new DelayInitCached();
@@ -436,7 +435,6 @@ private void initView(int width, int height) {
 
         hookContentViewDismissClick(width, height);
         preMeasurePopupView(width, height);
-
         //show or dismiss animate
         mHelper.setShowAnimation(onCreateShowAnimation())
                 .setShowAnimator(onCreateShowAnimator())

File: lib/src/main/java/razerdp/basepopup/QuickPopupConfig.java
Patch:
@@ -3,6 +3,7 @@
 import android.animation.Animator;
 import android.graphics.drawable.ColorDrawable;
 import android.graphics.drawable.Drawable;
+import android.os.Build;
 import android.util.Pair;
 import android.view.Gravity;
 import android.view.View;
@@ -26,7 +27,7 @@ public class QuickPopupConfig {
     Animator mShowAnimator;
     Animator mDismissAnimator;
 
-    boolean fadeEnable = true;
+    boolean fadeEnable = Build.VERSION.SDK_INT != Build.VERSION_CODES.M;
 
     BasePopupWindow.OnDismissListener mDismissListener;
 

File: lib/src/main/java/razerdp/basepopup/PopupCompatManager.java
Patch:
@@ -123,7 +123,7 @@ void showAsDropDownImpl(Activity activity, BasePopupWindowProxy popupWindow, Vie
                 yoff = anchorLocation[1] + anchor.getHeight();
             }
             //offset在basepopupwindow已经计算好，在windowmanagerproxy里面进行适配
-            popupWindow.callSuperShowAtLocation(activity.getWindow().getDecorView(), Gravity.NO_GRAVITY, xoff, yoff);
+            popupWindow.callSuperShowAtLocation(anchor, Gravity.NO_GRAVITY, xoff, yoff);
         }
 
         @Override

File: lib/src/main/java/razerdp/basepopup/PopupCompatManager.java
Patch:
@@ -123,7 +123,7 @@ void showAsDropDownImpl(Activity activity, BasePopupWindowProxy popupWindow, Vie
                 yoff = anchorLocation[1] + anchor.getHeight();
             }
             //offset在basepopupwindow已经计算好，在windowmanagerproxy里面进行适配
-            popupWindow.callSuperShowAtLocation(activity.getWindow().getDecorView(), Gravity.NO_GRAVITY, xoff, yoff);
+            popupWindow.callSuperShowAtLocation(anchor, Gravity.NO_GRAVITY, xoff, yoff);
         }
 
         @Override

File: lib/src/main/java/razerdp/basepopup/PopupCompatManager.java
Patch:
@@ -122,6 +122,7 @@ public void clear(BasePopupWindowProxy popupWindow) {
 
         protected void onBeforeShowExec(BasePopupWindowProxy popupWindowProxy, Activity act) {
             if (OnSystemUiVisibilityChangeListenerWrapper.needListenUiVisibilityChange(act)) {
+                popupWindowProxy.setFocusable(false);
                 Window window = act.getWindow();
                 View decorView = window == null ? null : window.getDecorView();
                 String decorStr = decorView == null ? null : String.valueOf(decorView.hashCode());
@@ -139,7 +140,7 @@ protected void onBeforeShowExec(BasePopupWindowProxy popupWindowProxy, Activity
         }
 
         protected void onAfterShowExec(BasePopupWindowProxy popupWindowProxy, Activity act) {
-
+            popupWindowProxy.setFocusable(true);
         }
 
         boolean isPopupShowing(BasePopupWindowProxy popupWindow) {

File: lib/src/main/java/razerdp/widget/QuickPopup.java
Patch:
@@ -68,6 +68,7 @@ protected <C extends QuickPopupConfig> void applyConfigSetting(C config) {
         setClipChildren(config.isClipChildren());
         setClipToScreen(config.isClipToScreen());
 
+        setAllowDismissWhenTouchOutside(config.isDismissOutSide());
         setAllowInterceptTouchEvent(config.isAllowInterceptTouchEvent());
         setPopupGravity(config.getGravity());
         setAlignBackground(config.isAlignBackground());

File: lib/src/main/java/razerdp/basepopup/PopupCompatManager.java
Patch:
@@ -122,6 +122,7 @@ public void clear(BasePopupWindowProxy popupWindow) {
 
         protected void onBeforeShowExec(BasePopupWindowProxy popupWindowProxy, Activity act) {
             if (OnSystemUiVisibilityChangeListenerWrapper.needListenUiVisibilityChange(act)) {
+                popupWindowProxy.setFocusable(false);
                 Window window = act.getWindow();
                 View decorView = window == null ? null : window.getDecorView();
                 String decorStr = decorView == null ? null : String.valueOf(decorView.hashCode());
@@ -139,7 +140,7 @@ protected void onBeforeShowExec(BasePopupWindowProxy popupWindowProxy, Activity
         }
 
         protected void onAfterShowExec(BasePopupWindowProxy popupWindowProxy, Activity act) {
-
+            popupWindowProxy.setFocusable(true);
         }
 
         boolean isPopupShowing(BasePopupWindowProxy popupWindow) {

File: lib/src/main/java/razerdp/widget/QuickPopup.java
Patch:
@@ -68,6 +68,7 @@ protected <C extends QuickPopupConfig> void applyConfigSetting(C config) {
         setClipChildren(config.isClipChildren());
         setClipToScreen(config.isClipToScreen());
 
+        setAllowDismissWhenTouchOutside(config.isDismissOutSide());
         setAllowInterceptTouchEvent(config.isAllowInterceptTouchEvent());
         setPopupGravity(config.getGravity());
         setAlignBackground(config.isAlignBackground());

File: lib/src/main/java/razerdp/basepopup/BasePopupWindowProxy.java
Patch:
@@ -164,6 +164,7 @@ void clear() {
             mWindowManagerProxy.clear();
         }
         PopupUtils.clearViewFromParent(getContentView());
+        PopupCompatManager.clear(this);
     }
 
 

File: lib/src/main/java/razerdp/basepopup/BasePopupWindowProxy.java
Patch:
@@ -164,6 +164,7 @@ void clear() {
             mWindowManagerProxy.clear();
         }
         PopupUtils.clearViewFromParent(getContentView());
+        PopupCompatManager.clear(this);
     }
 
 

File: app/src/main/java/razerdp/demo/OtherDemoActivity.java
Patch:
@@ -13,7 +13,6 @@
 
 import razerdp.basepopup.BasePopupWindow;
 import razerdp.basepopup.R;
-import razerdp.demo.fragment.basedemo.AutoLocatedPopupFrag;
 import razerdp.demo.fragment.other.BlurSlideFromBottomPopupFrag;
 import razerdp.demo.fragment.other.BottomInputFragment;
 import razerdp.demo.fragment.other.CommentPopupFrag;
@@ -23,6 +22,7 @@
 import razerdp.demo.fragment.other.ListPopupFrag;
 import razerdp.demo.fragment.other.LocatePopupFrag;
 import razerdp.demo.fragment.other.MenuPopupFrag;
+import razerdp.demo.fragment.other.OtherPopupFrag1;
 import razerdp.demo.fragment.other.ScalePopupFrag;
 import razerdp.demo.fragment.other.SimpleBaseFrag;
 import razerdp.demo.fragment.other.SlideFromBottomPopupFrag;
@@ -56,6 +56,7 @@ protected void onCreate(@Nullable Bundle savedInstanceState) {
         fragMap.put(R.id.id_blur_slide_from_bottom_popup, new BlurSlideFromBottomPopupFrag());
         fragMap.put(R.id.id_locate_with_view, new LocatePopupFrag());
         fragMap.put(R.id.id_slide_from_bottom_input_popup, new BottomInputFragment());
+        fragMap.put(R.id.id_other_1,new OtherPopupFrag1());
     }
 
 

File: app/src/main/java/razerdp/demo/fragment/other/SlideFromBottomPopupFrag.java
Patch:
@@ -6,6 +6,7 @@
 import android.view.View;
 import android.view.ViewGroup;
 import android.widget.Button;
+
 import razerdp.basepopup.BasePopupWindow;
 import razerdp.basepopup.R;
 import razerdp.demo.popup.SlideFromBottomPopup;

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -497,8 +497,8 @@ private void preMeasurePopupView(int w, int h) {
         if (mContentView != null) {
             boolean breakPreMeasure = mEventInterceptor != null && mEventInterceptor.onPreMeasurePopupView(this, mContentView, w, h);
             if (!breakPreMeasure) {
-                int measureWidth = View.MeasureSpec.makeMeasureSpec(w, View.MeasureSpec.UNSPECIFIED);
-                int measureHeight = View.MeasureSpec.makeMeasureSpec(h, View.MeasureSpec.UNSPECIFIED);
+                int measureWidth = View.MeasureSpec.makeMeasureSpec(w, w == ViewGroup.LayoutParams.WRAP_CONTENT ? View.MeasureSpec.UNSPECIFIED : View.MeasureSpec.EXACTLY);
+                int measureHeight = View.MeasureSpec.makeMeasureSpec(h, h == ViewGroup.LayoutParams.WRAP_CONTENT ? View.MeasureSpec.UNSPECIFIED : View.MeasureSpec.EXACTLY);
                 mContentView.measure(measureWidth, measureHeight);
             }
             mHelper.setPreMeasureWidth(mContentView.getMeasuredWidth())

File: app/src/main/java/razerdp/demo/OtherDemoActivity.java
Patch:
@@ -13,7 +13,6 @@
 
 import razerdp.basepopup.BasePopupWindow;
 import razerdp.basepopup.R;
-import razerdp.demo.fragment.basedemo.AutoLocatedPopupFrag;
 import razerdp.demo.fragment.other.BlurSlideFromBottomPopupFrag;
 import razerdp.demo.fragment.other.BottomInputFragment;
 import razerdp.demo.fragment.other.CommentPopupFrag;
@@ -23,6 +22,7 @@
 import razerdp.demo.fragment.other.ListPopupFrag;
 import razerdp.demo.fragment.other.LocatePopupFrag;
 import razerdp.demo.fragment.other.MenuPopupFrag;
+import razerdp.demo.fragment.other.OtherPopupFrag1;
 import razerdp.demo.fragment.other.ScalePopupFrag;
 import razerdp.demo.fragment.other.SimpleBaseFrag;
 import razerdp.demo.fragment.other.SlideFromBottomPopupFrag;
@@ -56,6 +56,7 @@ protected void onCreate(@Nullable Bundle savedInstanceState) {
         fragMap.put(R.id.id_blur_slide_from_bottom_popup, new BlurSlideFromBottomPopupFrag());
         fragMap.put(R.id.id_locate_with_view, new LocatePopupFrag());
         fragMap.put(R.id.id_slide_from_bottom_input_popup, new BottomInputFragment());
+        fragMap.put(R.id.id_other_1,new OtherPopupFrag1());
     }
 
 

File: app/src/main/java/razerdp/demo/fragment/other/SlideFromBottomPopupFrag.java
Patch:
@@ -6,6 +6,7 @@
 import android.view.View;
 import android.view.ViewGroup;
 import android.widget.Button;
+
 import razerdp.basepopup.BasePopupWindow;
 import razerdp.basepopup.R;
 import razerdp.demo.popup.SlideFromBottomPopup;

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -497,8 +497,8 @@ private void preMeasurePopupView(int w, int h) {
         if (mContentView != null) {
             boolean breakPreMeasure = mEventInterceptor != null && mEventInterceptor.onPreMeasurePopupView(this, mContentView, w, h);
             if (!breakPreMeasure) {
-                int measureWidth = View.MeasureSpec.makeMeasureSpec(w, View.MeasureSpec.UNSPECIFIED);
-                int measureHeight = View.MeasureSpec.makeMeasureSpec(h, View.MeasureSpec.UNSPECIFIED);
+                int measureWidth = View.MeasureSpec.makeMeasureSpec(w, w == ViewGroup.LayoutParams.WRAP_CONTENT ? View.MeasureSpec.UNSPECIFIED : View.MeasureSpec.EXACTLY);
+                int measureHeight = View.MeasureSpec.makeMeasureSpec(h, h == ViewGroup.LayoutParams.WRAP_CONTENT ? View.MeasureSpec.UNSPECIFIED : View.MeasureSpec.EXACTLY);
                 mContentView.measure(measureWidth, measureHeight);
             }
             mHelper.setPreMeasureWidth(mContentView.getMeasuredWidth())

File: app/src/main/java/razerdp/demo/fragment/basedemo/GravityPopupFrag.java
Patch:
@@ -47,6 +47,7 @@ public View onCreateView(LayoutInflater inflater,
     public void onInitView(View rootView) {
         initView();
         mPopupWindow = new GravityPopup(mContext);
+        mPopupWindow.setAllowInterceptTouchEvent(false);
 
         popupShow.setOnClickListener(new View.OnClickListener() {
             @Override

File: lib/src/main/java/razerdp/basepopup/BasePopupWindowProxy.java
Patch:
@@ -12,7 +12,7 @@
 
 import java.lang.reflect.Field;
 
-import razerdp.util.PopupUtil;
+import razerdp.util.PopupUtils;
 import razerdp.util.log.LogTag;
 import razerdp.util.log.PopupLogUtil;
 
@@ -132,7 +132,7 @@ boolean callSuperIsShowing() {
      * @author: razerdp optimize on 2018/4/25
      */
     Activity scanForActivity(Context from) {
-        return PopupUtil.scanForActivity(from, MAX_SCAN_ACTIVITY_COUNT);
+        return PopupUtils.scanForActivity(from, MAX_SCAN_ACTIVITY_COUNT);
     }
 
 
@@ -163,7 +163,7 @@ void clear() {
         if (mWindowManagerProxy != null) {
             mWindowManagerProxy.clear();
         }
-        PopupUtil.clearViewFromParent(getContentView());
+        PopupUtils.clearViewFromParent(getContentView());
     }
 
 

File: lib/src/main/java/razerdp/basepopup/PopupBackgroundView.java
Patch:
@@ -9,7 +9,7 @@
 import android.view.animation.AnimationUtils;
 
 import razerdp.library.R;
-import razerdp.util.PopupUtil;
+import razerdp.util.PopupUtils;
 
 /**
  * Created by 大灯泡 on 2018/5/9.
@@ -38,7 +38,7 @@ public static PopupBackgroundView creaete(Context context, BasePopupHelper helpe
     }
 
     private void init(Context context, final BasePopupHelper mHelper) {
-        if (PopupUtil.isBackgroundInvalidated(mHelper.getPopupBackground())) {
+        if (PopupUtils.isBackgroundInvalidated(mHelper.getPopupBackground())) {
             setVisibility(GONE);
             return;
         }

File: lib/src/main/java/razerdp/basepopup/PopupMaskLayout.java
Patch:
@@ -7,7 +7,7 @@
 import android.widget.FrameLayout;
 
 import razerdp.blur.BlurImageView;
-import razerdp.util.PopupUtil;
+import razerdp.util.PopupUtils;
 import razerdp.util.log.PopupLogUtil;
 
 /**
@@ -56,7 +56,7 @@ private void init(Context context, BasePopupHelper mHelper) {
             mBlurImageView.applyBlurOption(mHelper.getBlurOption());
             addViewInLayout(mBlurImageView, -1, generateDefaultLayoutParams());
         }
-        if (!PopupUtil.isBackgroundInvalidated(mHelper.getPopupBackground())) {
+        if (!PopupUtils.isBackgroundInvalidated(mHelper.getPopupBackground())) {
             mBackgroundView = PopupBackgroundView.creaete(context, mHelper);
             addViewInLayout(mBackgroundView, -1, generateDefaultLayoutParams());
         }

File: app/src/main/java/razerdp/demo/fragment/basedemo/GravityPopupFrag.java
Patch:
@@ -47,6 +47,7 @@ public View onCreateView(LayoutInflater inflater,
     public void onInitView(View rootView) {
         initView();
         mPopupWindow = new GravityPopup(mContext);
+        mPopupWindow.setAllowInterceptTouchEvent(false);
 
         popupShow.setOnClickListener(new View.OnClickListener() {
             @Override

File: lib/src/main/java/razerdp/basepopup/BasePopupWindowProxy.java
Patch:
@@ -12,7 +12,7 @@
 
 import java.lang.reflect.Field;
 
-import razerdp.util.PopupUtil;
+import razerdp.util.PopupUtils;
 import razerdp.util.log.LogTag;
 import razerdp.util.log.PopupLogUtil;
 
@@ -132,7 +132,7 @@ boolean callSuperIsShowing() {
      * @author: razerdp optimize on 2018/4/25
      */
     Activity scanForActivity(Context from) {
-        return PopupUtil.scanForActivity(from, MAX_SCAN_ACTIVITY_COUNT);
+        return PopupUtils.scanForActivity(from, MAX_SCAN_ACTIVITY_COUNT);
     }
 
 
@@ -163,7 +163,7 @@ void clear() {
         if (mWindowManagerProxy != null) {
             mWindowManagerProxy.clear();
         }
-        PopupUtil.clearViewFromParent(getContentView());
+        PopupUtils.clearViewFromParent(getContentView());
     }
 
 

File: lib/src/main/java/razerdp/basepopup/PopupBackgroundView.java
Patch:
@@ -9,7 +9,7 @@
 import android.view.animation.AnimationUtils;
 
 import razerdp.library.R;
-import razerdp.util.PopupUtil;
+import razerdp.util.PopupUtils;
 
 /**
  * Created by 大灯泡 on 2018/5/9.
@@ -38,7 +38,7 @@ public static PopupBackgroundView creaete(Context context, BasePopupHelper helpe
     }
 
     private void init(Context context, final BasePopupHelper mHelper) {
-        if (PopupUtil.isBackgroundInvalidated(mHelper.getPopupBackground())) {
+        if (PopupUtils.isBackgroundInvalidated(mHelper.getPopupBackground())) {
             setVisibility(GONE);
             return;
         }

File: lib/src/main/java/razerdp/basepopup/PopupMaskLayout.java
Patch:
@@ -7,7 +7,7 @@
 import android.widget.FrameLayout;
 
 import razerdp.blur.BlurImageView;
-import razerdp.util.PopupUtil;
+import razerdp.util.PopupUtils;
 import razerdp.util.log.PopupLogUtil;
 
 /**
@@ -56,7 +56,7 @@ private void init(Context context, BasePopupHelper mHelper) {
             mBlurImageView.applyBlurOption(mHelper.getBlurOption());
             addViewInLayout(mBlurImageView, -1, generateDefaultLayoutParams());
         }
-        if (!PopupUtil.isBackgroundInvalidated(mHelper.getPopupBackground())) {
+        if (!PopupUtils.isBackgroundInvalidated(mHelper.getPopupBackground())) {
             mBackgroundView = PopupBackgroundView.creaete(context, mHelper);
             addViewInLayout(mBackgroundView, -1, generateDefaultLayoutParams());
         }

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -1311,7 +1311,7 @@ public int getPopupGravity() {
 
     /**
      * <p>
-     * 设置参考点
+     * 设置参考点 {@link Gravity}
      * <br>
      * <ul>
      * <li> 不跟anchorView联系的情况下，gravity意味着在整个view中的方位{@link #showPopupWindow()}</li>

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -1311,7 +1311,7 @@ public int getPopupGravity() {
 
     /**
      * <p>
-     * 设置参考点
+     * 设置参考点 {@link Gravity}
      * <br>
      * <ul>
      * <li> 不跟anchorView联系的情况下，gravity意味着在整个view中的方位{@link #showPopupWindow()}</li>

File: app/src/main/java/razerdp/demo/popup/GravityPopup.java
Patch:
@@ -1,6 +1,6 @@
 package razerdp.demo.popup;
 
-import android.app.Activity;
+import android.content.Context;
 import android.view.Gravity;
 import android.view.View;
 import android.view.animation.Animation;
@@ -16,7 +16,7 @@
  */
 public class GravityPopup extends BasePopupWindow implements View.OnClickListener {
 
-    public GravityPopup(Activity context) {
+    public GravityPopup(Context context) {
         super(context);
         setPopupFadeEnable(true);
         bindEvent();

File: app/src/main/java/razerdp/demo/popup/SlideFromBottomInputPopup.java
Patch:
@@ -17,7 +17,7 @@ public class SlideFromBottomInputPopup extends BasePopupWindow {
     EditText mEditText;
 
     public SlideFromBottomInputPopup(Context context) {
-        super(context, MATCH_PARENT, WRAP_CONTENT);
+        super(context);
         mEditText = findViewById(R.id.ed_input);
         findViewById(R.id.btn_send).setOnClickListener(new View.OnClickListener() {
             @Override

File: app/src/main/java/razerdp/demo/popup/SlideFromTopPopup.java
Patch:
@@ -35,7 +35,6 @@ public SlideFromTopPopup(Context context) {
         super(context);
         setBackPressEnable(true);
         setAlignBackground(true);
-        setClipToScreen(false);
         testList = new ArrayList<>();
         for (int i = 0; i < 50; i++) {
             testList.add("position - " + i);

File: app/src/main/java/razerdp/demo/popup/SlideFromTopPopup2.java
Patch:
@@ -31,7 +31,7 @@
 public class SlideFromTopPopup2 extends BasePopupWindow {
 
     public SlideFromTopPopup2(Context context) {
-        super(context, MATCH_PARENT, WRAP_CONTENT);
+        super(context);
         setBackPressEnable(false);
         setAlignBackground(true);
         List<String> testList = new ArrayList<>();

File: app/src/main/java/razerdp/demo/popup/GravityPopup.java
Patch:
@@ -1,6 +1,6 @@
 package razerdp.demo.popup;
 
-import android.app.Activity;
+import android.content.Context;
 import android.view.Gravity;
 import android.view.View;
 import android.view.animation.Animation;
@@ -16,7 +16,7 @@
  */
 public class GravityPopup extends BasePopupWindow implements View.OnClickListener {
 
-    public GravityPopup(Activity context) {
+    public GravityPopup(Context context) {
         super(context);
         setPopupFadeEnable(true);
         bindEvent();

File: app/src/main/java/razerdp/demo/popup/SlideFromBottomInputPopup.java
Patch:
@@ -17,7 +17,7 @@ public class SlideFromBottomInputPopup extends BasePopupWindow {
     EditText mEditText;
 
     public SlideFromBottomInputPopup(Context context) {
-        super(context, MATCH_PARENT, WRAP_CONTENT);
+        super(context);
         mEditText = findViewById(R.id.ed_input);
         findViewById(R.id.btn_send).setOnClickListener(new View.OnClickListener() {
             @Override

File: app/src/main/java/razerdp/demo/popup/SlideFromTopPopup.java
Patch:
@@ -35,7 +35,6 @@ public SlideFromTopPopup(Context context) {
         super(context);
         setBackPressEnable(true);
         setAlignBackground(true);
-        setClipToScreen(false);
         testList = new ArrayList<>();
         for (int i = 0; i < 50; i++) {
             testList.add("position - " + i);

File: app/src/main/java/razerdp/demo/popup/SlideFromTopPopup2.java
Patch:
@@ -31,7 +31,7 @@
 public class SlideFromTopPopup2 extends BasePopupWindow {
 
     public SlideFromTopPopup2(Context context) {
-        super(context, MATCH_PARENT, WRAP_CONTENT);
+        super(context);
         setBackPressEnable(false);
         setAlignBackground(true);
         List<String> testList = new ArrayList<>();

File: lib/src/main/java/razerdp/blur/PopupBlurOption.java
Patch:
@@ -37,6 +37,9 @@ public View getBlurView() {
 
     public PopupBlurOption setBlurView(View blurView) {
         mBlurView = new WeakReference<View>(blurView);
+        if (blurView != null && blurView.getId() != android.R.id.content) {
+            setFullScreen(false);
+        }
         return this;
     }
 

File: lib/src/main/java/razerdp/blur/PopupBlurOption.java
Patch:
@@ -37,6 +37,9 @@ public View getBlurView() {
 
     public PopupBlurOption setBlurView(View blurView) {
         mBlurView = new WeakReference<View>(blurView);
+        if (blurView != null && blurView.getId() != android.R.id.content) {
+            setFullScreen(false);
+        }
         return this;
     }
 

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -668,6 +668,7 @@ public void showPopupWindow(View anchorView) {
     //------------------------------------------Methods-----------------------------------------------
     private void tryToShowPopup(View v) {
         addGlobalListener();
+        mHelper.handleShow();
         if (mEventInterceptor != null && mEventInterceptor.onTryToShowPopup(this,
                 mPopupWindow,
                 v,
@@ -746,6 +747,7 @@ private void removeGlobalListener() {
         if (mGlobalLayoutListenerWrapper != null) {
             mGlobalLayoutListenerWrapper.remove();
         }
+        mHelper.handleDismiss();
     }
 
     /**

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -668,6 +668,7 @@ public void showPopupWindow(View anchorView) {
     //------------------------------------------Methods-----------------------------------------------
     private void tryToShowPopup(View v) {
         addGlobalListener();
+        mHelper.handleShow();
         if (mEventInterceptor != null && mEventInterceptor.onTryToShowPopup(this,
                 mPopupWindow,
                 v,
@@ -746,6 +747,7 @@ private void removeGlobalListener() {
         if (mGlobalLayoutListenerWrapper != null) {
             mGlobalLayoutListenerWrapper.remove();
         }
+        mHelper.handleDismiss();
     }
 
     /**

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -445,7 +445,7 @@ public boolean onTouch(View v, MotionEvent event) {
 
     private void preMeasurePopupView(int w, int h) {
         if (mContentView != null) {
-            boolean breakPreMeasure = mEventInterceptor != null && !mEventInterceptor.onPreMeasurePopupView(this, mContentView, w, h);
+            boolean breakPreMeasure = mEventInterceptor != null && mEventInterceptor.onPreMeasurePopupView(this, mContentView, w, h);
             if (!breakPreMeasure) {
                 int measureWidth = View.MeasureSpec.makeMeasureSpec(w, View.MeasureSpec.UNSPECIFIED);
                 int measureHeight = View.MeasureSpec.makeMeasureSpec(h, View.MeasureSpec.UNSPECIFIED);

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -445,7 +445,7 @@ public boolean onTouch(View v, MotionEvent event) {
 
     private void preMeasurePopupView(int w, int h) {
         if (mContentView != null) {
-            boolean breakPreMeasure = mEventInterceptor != null && !mEventInterceptor.onPreMeasurePopupView(this, mContentView, w, h);
+            boolean breakPreMeasure = mEventInterceptor != null && mEventInterceptor.onPreMeasurePopupView(this, mContentView, w, h);
             if (!breakPreMeasure) {
                 int measureWidth = View.MeasureSpec.makeMeasureSpec(w, View.MeasureSpec.UNSPECIFIED);
                 int measureHeight = View.MeasureSpec.makeMeasureSpec(h, View.MeasureSpec.UNSPECIFIED);

File: app/src/main/java/razerdp/demo/popup/AutoLocatedPopup.java
Patch:
@@ -19,8 +19,7 @@ public class AutoLocatedPopup extends BasePopupWindow implements View.OnClickLis
 
     public AutoLocatedPopup(Context context) {
         super(context, ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT);
-        setAutoLocatePopup(true)
-                .setAlignBackground(false);
+        setAutoLocatePopup(true);
         bindEvent();
     }
 

File: lib/src/main/java/razerdp/basepopup/PopupDecorViewProxy.java
Patch:
@@ -49,7 +49,6 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
             }
             setMeasuredDimension(maxWidth, maxHeight);
         }
-        PopupLogUtil.trace(LogTag.d, TAG, "onMeasure");
     }
 
     @Override

File: app/src/main/java/razerdp/demo/popup/AutoLocatedPopup.java
Patch:
@@ -19,8 +19,7 @@ public class AutoLocatedPopup extends BasePopupWindow implements View.OnClickLis
 
     public AutoLocatedPopup(Context context) {
         super(context, ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT);
-        setAutoLocatePopup(true)
-                .setAlignBackground(false);
+        setAutoLocatePopup(true);
         bindEvent();
     }
 

File: lib/src/main/java/razerdp/basepopup/PopupDecorViewProxy.java
Patch:
@@ -49,7 +49,6 @@ protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
             }
             setMeasuredDimension(maxWidth, maxHeight);
         }
-        PopupLogUtil.trace(LogTag.d, TAG, "onMeasure");
     }
 
     @Override

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -409,7 +409,6 @@ public boolean onTouch(View v, MotionEvent event) {
                                 return isAllowDismissWhenTouchOutside();
                             case MotionEvent.ACTION_UP:
                                 v.performClick();
-                                v.performLongClick();
                                 if (isAllowDismissWhenTouchOutside()) {
                                     int x = (int) event.getX();
                                     int y = (int) event.getY();

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -409,7 +409,6 @@ public boolean onTouch(View v, MotionEvent event) {
                                 return isAllowDismissWhenTouchOutside();
                             case MotionEvent.ACTION_UP:
                                 v.performClick();
-                                v.performLongClick();
                                 if (isAllowDismissWhenTouchOutside()) {
                                     int x = (int) event.getX();
                                     int y = (int) event.getY();

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -395,6 +395,8 @@ public boolean onTouch(View v, MotionEvent event) {
                             case MotionEvent.ACTION_DOWN:
                                 return isAllowDismissWhenTouchOutside();
                             case MotionEvent.ACTION_UP:
+                                v.performClick();
+                                v.performLongClick();
                                 if (isAllowDismissWhenTouchOutside()) {
                                     int childCount = 0;
                                     if (mContentView instanceof ViewGroup) {
@@ -869,7 +871,7 @@ public BasePopupWindow setBackgroundColor(int color) {
      * @param drawableIds 背景Drawable id
      */
     public BasePopupWindow setBackground(int drawableIds) {
-        if (drawableIds==0){
+        if (drawableIds == 0) {
             return setBackground(null);
         }
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -395,6 +395,8 @@ public boolean onTouch(View v, MotionEvent event) {
                             case MotionEvent.ACTION_DOWN:
                                 return isAllowDismissWhenTouchOutside();
                             case MotionEvent.ACTION_UP:
+                                v.performClick();
+                                v.performLongClick();
                                 if (isAllowDismissWhenTouchOutside()) {
                                     int childCount = 0;
                                     if (mContentView instanceof ViewGroup) {
@@ -869,7 +871,7 @@ public BasePopupWindow setBackgroundColor(int color) {
      * @param drawableIds 背景Drawable id
      */
     public BasePopupWindow setBackground(int drawableIds) {
-        if (drawableIds==0){
+        if (drawableIds == 0) {
             return setBackground(null);
         }
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -875,7 +875,7 @@ public BasePopupWindow setBackground(int drawableIds) {
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
             return setBackground(getContext().getDrawable(drawableIds));
         } else {
-            return setBackground(getContext().getResources().getDrawable(drawableIds, getContext().getTheme()));
+            return setBackground(getContext().getResources().getDrawable(drawableIds));
         }
     }
 

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -875,7 +875,7 @@ public BasePopupWindow setBackground(int drawableIds) {
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
             return setBackground(getContext().getDrawable(drawableIds));
         } else {
-            return setBackground(getContext().getResources().getDrawable(drawableIds, getContext().getTheme()));
+            return setBackground(getContext().getResources().getDrawable(drawableIds));
         }
     }
 

File: app/src/main/java/razerdp/demo/popup/CommentPopup.java
Patch:
@@ -50,7 +50,7 @@ public CommentPopup(Activity context) {
         mCommentClickLayout.setOnClickListener(this);
 
         buildAnima();
-        setPopupBackgroundColor(Color.TRANSPARENT);
+        setBackgroundColor(Color.TRANSPARENT);
         setAllowDismissWhenTouchOutside(true);
         setAllowInterceptTouchEvent(false);
         setBlurBackgroundEnable(true);

File: app/src/main/java/razerdp/demo/popup/CommentPopup.java
Patch:
@@ -50,7 +50,7 @@ public CommentPopup(Activity context) {
         mCommentClickLayout.setOnClickListener(this);
 
         buildAnima();
-        setPopupBackgroundColor(Color.TRANSPARENT);
+        setBackgroundColor(Color.TRANSPARENT);
         setAllowDismissWhenTouchOutside(true);
         setAllowInterceptTouchEvent(false);
         setBlurBackgroundEnable(true);

File: app/src/main/java/razerdp/demo/DemoActivity.java
Patch:
@@ -28,6 +28,7 @@
 import razerdp.demo.fragment.SimpleBaseFrag;
 import razerdp.demo.fragment.SlideFromBottomPopupFrag;
 import razerdp.demo.fragment.SlideFromTopPopupFrag;
+import razerdp.demo.fragment.SlideFromTopPopupFrag2;
 import razerdp.demo.popup.ScalePopup;
 
 public class DemoActivity extends AppCompatActivity {
@@ -57,6 +58,7 @@ protected void onCreate(@Nullable Bundle savedInstanceState) {
         fragMap.put(R.id.id_full_screen_popup, new FullScreenPopupFrag());
         fragMap.put(R.id.id_auto_located_popup, new AutoLocatedPopupFrag());
         fragMap.put(R.id.id_slide_from_top_popup, new SlideFromTopPopupFrag());
+        fragMap.put(R.id.id_slide_from_top_popup2, new SlideFromTopPopupFrag2());
         fragMap.put(R.id.id_dismiss_control_popup, new DismissControlPopupFrag());
         fragMap.put(R.id.id_blur_slide_from_bottom_popup, new BlurSlideFromBottomPopupFrag());
 

File: lib/src/main/java/razerdp/basepopup/PopupWindowProxy.java
Patch:
@@ -32,7 +32,7 @@ public void showAsDropDownProxy(View anchor, int xoff, int yoff, int gravity) {
     }
 
     public void showAsDropDownProxy(View anchor, int xoff, int yoff) {
-        PopupCompatManager.showAsDropDown(this, anchor, xoff, yoff, Gravity.TOP | Gravity.START);
+        showAsDropDownProxy(anchor, xoff, yoff, Gravity.NO_GRAVITY);
     }
 
     public void showAtLocationProxy(View parent, int gravity, int x, int y) {

File: app/src/main/java/razerdp/demo/DemoActivity.java
Patch:
@@ -28,6 +28,7 @@
 import razerdp.demo.fragment.SimpleBaseFrag;
 import razerdp.demo.fragment.SlideFromBottomPopupFrag;
 import razerdp.demo.fragment.SlideFromTopPopupFrag;
+import razerdp.demo.fragment.SlideFromTopPopupFrag2;
 import razerdp.demo.popup.ScalePopup;
 
 public class DemoActivity extends AppCompatActivity {
@@ -57,6 +58,7 @@ protected void onCreate(@Nullable Bundle savedInstanceState) {
         fragMap.put(R.id.id_full_screen_popup, new FullScreenPopupFrag());
         fragMap.put(R.id.id_auto_located_popup, new AutoLocatedPopupFrag());
         fragMap.put(R.id.id_slide_from_top_popup, new SlideFromTopPopupFrag());
+        fragMap.put(R.id.id_slide_from_top_popup2, new SlideFromTopPopupFrag2());
         fragMap.put(R.id.id_dismiss_control_popup, new DismissControlPopupFrag());
         fragMap.put(R.id.id_blur_slide_from_bottom_popup, new BlurSlideFromBottomPopupFrag());
 

File: lib/src/main/java/razerdp/basepopup/PopupWindowProxy.java
Patch:
@@ -32,7 +32,7 @@ public void showAsDropDownProxy(View anchor, int xoff, int yoff, int gravity) {
     }
 
     public void showAsDropDownProxy(View anchor, int xoff, int yoff) {
-        PopupCompatManager.showAsDropDown(this, anchor, xoff, yoff, Gravity.TOP | Gravity.START);
+        showAsDropDownProxy(anchor, xoff, yoff, Gravity.NO_GRAVITY);
     }
 
     public void showAtLocationProxy(View parent, int gravity, int x, int y) {

File: lib/src/main/java/razerdp/basepopup/BasePopupHelper.java
Patch:
@@ -52,9 +52,9 @@ final class BasePopupHelper {
 
 
     //popup params
-    private boolean focusable;
-    private boolean outsideTouchable;
-    private boolean hasBackground;
+    private boolean focusable = true;
+    private boolean outsideTouchable = true;
+    private boolean hasBackground = true;
 
     public BasePopupHelper() {
         mAnchorViewLocation = new int[2];

File: lib/src/main/java/razerdp/basepopup/BasePopupHelper.java
Patch:
@@ -52,9 +52,9 @@ final class BasePopupHelper {
 
 
     //popup params
-    private boolean focusable;
-    private boolean outsideTouchable;
-    private boolean hasBackground;
+    private boolean focusable = true;
+    private boolean outsideTouchable = true;
+    private boolean hasBackground = true;
 
     public BasePopupHelper() {
         mAnchorViewLocation = new int[2];

File: app/src/main/java/razerdp/demo/popup/SlideFromTopPopup.java
Patch:
@@ -11,8 +11,6 @@
 import android.view.animation.TranslateAnimation;
 import android.widget.AdapterView;
 import android.widget.BaseAdapter;
-import android.widget.ImageView;
-import android.widget.LinearLayout;
 import android.widget.ListView;
 import android.widget.TextView;
 import android.widget.Toast;
@@ -37,7 +35,7 @@ public class SlideFromTopPopup extends BasePopupWindow {
     public SlideFromTopPopup(Activity context) {
         super(context);
         setBackPressEnable(false);
-        setDismissWhenTouchOuside(true);
+        setDismissWhenTouchOutside(true);
         testList = new ArrayList<>();
         for (int i = 0; i < 50; i++) {
             testList.add("position - " + i);

File: app/src/main/java/razerdp/demo/popup/SlideFromTopPopup.java
Patch:
@@ -11,8 +11,6 @@
 import android.view.animation.TranslateAnimation;
 import android.widget.AdapterView;
 import android.widget.BaseAdapter;
-import android.widget.ImageView;
-import android.widget.LinearLayout;
 import android.widget.ListView;
 import android.widget.TextView;
 import android.widget.Toast;
@@ -37,7 +35,7 @@ public class SlideFromTopPopup extends BasePopupWindow {
     public SlideFromTopPopup(Activity context) {
         super(context);
         setBackPressEnable(false);
-        setDismissWhenTouchOuside(true);
+        setDismissWhenTouchOutside(true);
         testList = new ArrayList<>();
         for (int i = 0; i < 50; i++) {
             testList.add("position - " + i);

File: lib/src/main/java/razerdp/basepopup/PopupWindowProxy.java
Patch:
@@ -92,6 +92,8 @@ public void showAsDropDown(View anchor, int xoff, int yoff, int gravity) {
                 Log.e(TAG, "please make sure that context is instance of activity");
                 return;
             }
+            //复位重试次数#issue 45(https://github.com/razerdp/BasePopup/issues/45)
+            tryScanActivityCount = 0;
 
             xoff = anchorLocation[0] + xoff;
             yoff = anchorLocation[1] + anchor.getHeight() + yoff;

File: lib/src/main/java/razerdp/basepopup/PopupWindowProxy.java
Patch:
@@ -92,6 +92,8 @@ public void showAsDropDown(View anchor, int xoff, int yoff, int gravity) {
                 Log.e(TAG, "please make sure that context is instance of activity");
                 return;
             }
+            //复位重试次数#issue 45(https://github.com/razerdp/BasePopup/issues/45)
+            tryScanActivityCount = 0;
 
             xoff = anchorLocation[0] + xoff;
             yoff = anchorLocation[1] + anchor.getHeight() + yoff;

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -294,9 +294,9 @@ protected void setViewClickListener(View.OnClickListener listener, View... views
     private void fitPopupWindowOverStatusBar() {
         if (Build.VERSION.SDK_INT > Build.VERSION_CODES.LOLLIPOP) {
             try {
-                Field mClippingEnabled = PopupWindow.class.getDeclaredField("mClippingEnabled");
-                mClippingEnabled.setAccessible(true);
-                mClippingEnabled.set(mPopupWindow, false);
+                Field mLayoutInScreen = PopupWindow.class.getDeclaredField("mLayoutInScreen");
+                mLayoutInScreen.setAccessible(true);
+                mLayoutInScreen.set(mPopupWindow, true);
             } catch (NoSuchFieldException e) {
                 e.printStackTrace();
             } catch (IllegalAccessException e) {

File: lib/src/main/java/razerdp/basepopup/BasePopupWindow.java
Patch:
@@ -294,9 +294,9 @@ protected void setViewClickListener(View.OnClickListener listener, View... views
     private void fitPopupWindowOverStatusBar() {
         if (Build.VERSION.SDK_INT > Build.VERSION_CODES.LOLLIPOP) {
             try {
-                Field mClippingEnabled = PopupWindow.class.getDeclaredField("mClippingEnabled");
-                mClippingEnabled.setAccessible(true);
-                mClippingEnabled.set(mPopupWindow, false);
+                Field mLayoutInScreen = PopupWindow.class.getDeclaredField("mLayoutInScreen");
+                mLayoutInScreen.setAccessible(true);
+                mLayoutInScreen.set(mPopupWindow, true);
             } catch (NoSuchFieldException e) {
                 e.printStackTrace();
             } catch (IllegalAccessException e) {

File: app/src/main/java/razerdp/basepopup/base/BasePopupWindow.java
Patch:
@@ -155,9 +155,8 @@ private void tryToShowPopup(int res, View v) throws Exception {
         }
         if (curAnima != null && mAnimaView != null) {
             mAnimaView.clearAnimation();
-            mAnimaView.startAnimation(getAnimation());
+            mAnimaView.startAnimation(curAnima);
         }
-        //ViewHelper.setPivotX是包nineoldAndroid的方法，用于兼容低版本的anima以及方便的view工具
         if (curAnima == null && curAnimator != null && mAnimaView != null &&
                 Build.VERSION.SDK_INT >= Build.VERSION_CODES.HONEYCOMB) {
             curAnimator.start();

File: app/src/main/java/razerdp/basepopup/base/BasePopupWindow.java
Patch:
@@ -155,9 +155,8 @@ private void tryToShowPopup(int res, View v) throws Exception {
         }
         if (curAnima != null && mAnimaView != null) {
             mAnimaView.clearAnimation();
-            mAnimaView.startAnimation(getAnimation());
+            mAnimaView.startAnimation(curAnima);
         }
-        //ViewHelper.setPivotX是包nineoldAndroid的方法，用于兼容低版本的anima以及方便的view工具
         if (curAnima == null && curAnimator != null && mAnimaView != null &&
                 Build.VERSION.SDK_INT >= Build.VERSION_CODES.HONEYCOMB) {
             curAnimator.start();

File: app/src/main/java/razerdp/basepopup/BasePopup/ViewCreate.java
Patch:
@@ -1,4 +1,4 @@
-package razerdp.basepopup.widget;
+package razerdp.basepopup.basepopup;
 
 import android.view.View;
 

File: app/src/main/java/razerdp/basepopup/BasePopup/ViewCreate.java
Patch:
@@ -1,4 +1,4 @@
-package razerdp.basepopup.widget;
+package razerdp.basepopup.basepopup;
 
 import android.view.View;
 

