File: core/src/test/java/com/google/zxing/client/result/ParsedReaderResultTestCase.java
Patch:
@@ -92,7 +92,8 @@ public void testEmailAddressType() {
     doTestResult("srowen@example.org", "srowen@example.org", ParsedResultType.EMAIL_ADDRESS);
     doTestResult("mailto:srowen@example.org", "srowen@example.org", ParsedResultType.EMAIL_ADDRESS);
     doTestResult("MAILTO:srowen@example.org", "srowen@example.org", ParsedResultType.EMAIL_ADDRESS);
-    doTestResult("srowen@example", "srowen@example", ParsedResultType.EMAIL_ADDRESS);
+    doTestResult("srowen@example.com", "srowen@example.com", ParsedResultType.EMAIL_ADDRESS);
+    doTestResult("srowen@example", "srowen@example", ParsedResultType.TEXT);
     doTestResult("srowen", "srowen", ParsedResultType.TEXT);
     doTestResult("Let's meet @ 2", "Let's meet @ 2", ParsedResultType.TEXT);
   }

File: core/src/main/java/com/google/zxing/multi/qrcode/QRCodeMultiReader.java
Patch:
@@ -83,6 +83,9 @@ public Result[] decodeMultiple(BinaryBitmap image, Map<DecodeHintType,?> hints)
           result.putMetadata(ResultMetadataType.STRUCTURED_APPEND_PARITY,
                              decoderResult.getStructuredAppendParity());
         }
+        // Fix SYMBOLOGY_IDENTIFIER loss in QRCodeMultiReader
+        result.putMetadata(ResultMetadataType.SYMBOLOGY_IDENTIFIER, "]Q" + decoderResult.getSymbologyModifier());
+
         results.add(result);
       } catch (ReaderException re) {
         // ignore and continue

File: core/src/main/java/com/google/zxing/oned/Code128Writer.java
Patch:
@@ -249,6 +249,9 @@ private static boolean[] encodeFast(String contents, int forcedCodeSet) {
   static boolean[] produceResult(Collection<int[]> patterns, int checkSum) {
     // Compute and append checksum
     checkSum %= 103;
+    if (checkSum < 0) {
+      throw new IllegalArgumentException("Unable to compute a valid input checksum");
+    }
     patterns.add(Code128Reader.CODE_PATTERNS[checkSum]);
 
     // Append stop code

File: core/src/main/java/com/google/zxing/maxicode/MaxiCodeReader.java
Patch:
@@ -98,7 +98,7 @@ private static BitMatrix extractPureBits(BitMatrix image) throws NotFoundExcepti
     // Now just read off the bits
     BitMatrix bits = new BitMatrix(MATRIX_WIDTH, MATRIX_HEIGHT);
     for (int y = 0; y < MATRIX_HEIGHT; y++) {
-      int iy = Math.min(top + (y * height + height / 2) / MATRIX_HEIGHT, height - 1);
+      int iy = top + Math.min((y * height + height / 2) / MATRIX_HEIGHT, height - 1);
       for (int x = 0; x < MATRIX_WIDTH; x++) {
         // srowen: I don't quite understand why the formula below is necessary, but it
         // can walk off the image if left + width = the right boundary. So cap it.

File: core/src/test/java/com/google/zxing/maxicode/Maxicode1TestCase.java
Patch:
@@ -27,7 +27,7 @@ public final class Maxicode1TestCase extends AbstractBlackBoxTestCase {
 
   public Maxicode1TestCase() {
     super("src/test/resources/blackbox/maxicode-1", new MultiFormatReader(), BarcodeFormat.MAXICODE);
-    addTest(8, 8, 0.0f);
+    addTest(9, 9, 0.0f);
   }
 
 }

File: core/src/main/java/com/google/zxing/datamatrix/DataMatrixReader.java
Patch:
@@ -83,6 +83,7 @@ public Result decode(BinaryBitmap image, Map<DecodeHintType,?> hints)
     if (ecLevel != null) {
       result.putMetadata(ResultMetadataType.ERROR_CORRECTION_LEVEL, ecLevel);
     }
+    result.putMetadata(ResultMetadataType.ERRORS_CORRECTED, decoderResult.getErrorsCorrected());
     result.putMetadata(ResultMetadataType.SYMBOLOGY_IDENTIFIER, "]d" + decoderResult.getSymbologyModifier());
     return result;
   }

File: core/src/main/java/com/google/zxing/maxicode/MaxiCodeReader.java
Patch:
@@ -64,7 +64,7 @@ public Result decode(BinaryBitmap image, Map<DecodeHintType,?> hints)
     BitMatrix bits = extractPureBits(image.getBlackMatrix());
     DecoderResult decoderResult = decoder.decode(bits, hints);
     Result result = new Result(decoderResult.getText(), decoderResult.getRawBytes(), NO_POINTS, BarcodeFormat.MAXICODE);
-
+    result.putMetadata(ResultMetadataType.ERRORS_CORRECTED, decoderResult.getErrorsCorrected());
     String ecLevel = decoderResult.getECLevel();
     if (ecLevel != null) {
       result.putMetadata(ResultMetadataType.ERROR_CORRECTION_LEVEL, ecLevel);

File: core/src/main/java/com/google/zxing/pdf417/PDF417Reader.java
Patch:
@@ -90,6 +90,8 @@ private static Result[] decode(BinaryBitmap image, Map<DecodeHintType, ?> hints,
           points[6], points[7], getMinCodewordWidth(points), getMaxCodewordWidth(points));
       Result result = new Result(decoderResult.getText(), decoderResult.getRawBytes(), points, BarcodeFormat.PDF_417);
       result.putMetadata(ResultMetadataType.ERROR_CORRECTION_LEVEL, decoderResult.getECLevel());
+      result.putMetadata(ResultMetadataType.ERRORS_CORRECTED, decoderResult.getErrorsCorrected());
+      result.putMetadata(ResultMetadataType.ERASURES_CORRECTED, decoderResult.getErasures());
       PDF417ResultMetadata pdf417ResultMetadata = (PDF417ResultMetadata) decoderResult.getOther();
       if (pdf417ResultMetadata != null) {
         result.putMetadata(ResultMetadataType.PDF417_EXTRA_METADATA, pdf417ResultMetadata);

File: core/src/main/java/com/google/zxing/qrcode/QRCodeReader.java
Patch:
@@ -99,6 +99,7 @@ public final Result decode(BinaryBitmap image, Map<DecodeHintType,?> hints)
       result.putMetadata(ResultMetadataType.STRUCTURED_APPEND_PARITY,
                          decoderResult.getStructuredAppendParity());
     }
+    result.putMetadata(ResultMetadataType.ERRORS_CORRECTED, decoderResult.getErrorsCorrected());
     result.putMetadata(ResultMetadataType.SYMBOLOGY_IDENTIFIER, "]Q" + decoderResult.getSymbologyModifier());
     return result;
   }

File: core/src/test/java/com/google/zxing/maxicode/MaxiCodeBlackBox1TestCase.java
Patch:
@@ -32,7 +32,7 @@ public final class MaxiCodeBlackBox1TestCase extends AbstractBlackBoxTestCase {
   public MaxiCodeBlackBox1TestCase() {
     super("src/test/resources/blackbox/maxicode-1", new MultiFormatReader(), BarcodeFormat.MAXICODE);
     addHint(DecodeHintType.PURE_BARCODE);
-    addTest(7, 7, 0.0f);
+    addTest(8, 8, 0.0f);
   }
 
 }

File: core/src/test/java/com/google/zxing/maxicode/Maxicode1TestCase.java
Patch:
@@ -27,7 +27,7 @@ public final class Maxicode1TestCase extends AbstractBlackBoxTestCase {
 
   public Maxicode1TestCase() {
     super("src/test/resources/blackbox/maxicode-1", new MultiFormatReader(), BarcodeFormat.MAXICODE);
-    addTest(7, 7, 0.0f);
+    addTest(8, 8, 0.0f);
   }
 
 }

File: core/src/main/java/com/google/zxing/pdf417/detector/Detector.java
Patch:
@@ -40,7 +40,7 @@ public final class Detector {
   private static final int[] INDEXES_START_PATTERN = {0, 4, 1, 5};
   private static final int[] INDEXES_STOP_PATTERN = {6, 2, 7, 3};
   private static final float MAX_AVG_VARIANCE = 0.42f;
-  private static final float MAX_INDIVIDUAL_VARIANCE = 0.8f;
+  private static final float MAX_INDIVIDUAL_VARIANCE = 0.7f;
 
   // B S B S B S B S Bar/Space pattern
   // 11111111 0 1 0 1 0 1 000

File: core/src/main/java/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -321,6 +321,9 @@ private static int textCompaction(int[] codewords, int codeIndex, ECIStringBuild
           case ECI_CHARSET:
             subMode = decodeTextCompaction(textCompactionData, byteCompactionData, index, result, subMode);
             result.appendECI(codewords[codeIndex++]);
+            if (codeIndex > codewords[0]) {
+              throw FormatException.getFormatInstance();
+            }
             textCompactionData = new int[(codewords[0] - codeIndex) * 2];
             byteCompactionData = new int[(codewords[0] - codeIndex) * 2];
             index = 0;

File: core/src/main/java/com/google/zxing/maxicode/decoder/DecodedBitStreamParser.java
Patch:
@@ -62,7 +62,7 @@ final class DecodedBitStreamParser {
 
   @SuppressWarnings("checkstyle:lineLength")
   private static final String[] SETS = {
-    "\nABCDEFGHIJKLMNOPQRSTUVWXYZ" + ECI + FS + GS + RS + NS + ' ' + PAD +
+    "\rABCDEFGHIJKLMNOPQRSTUVWXYZ" + ECI + FS + GS + RS + NS + ' ' + PAD +
         "\"#$%&'()*+,-./0123456789:" + SHIFTB + SHIFTC + SHIFTD + SHIFTE + LATCHB,
     "`abcdefghijklmnopqrstuvwxyz" + ECI + FS + GS + RS + NS + '{' + PAD +
         "}~\u007F;<=>?[\\]^_ ,./:@!|" + PAD + TWOSHIFTA + THREESHIFTA + PAD +

File: core/src/main/java/com/google/zxing/common/ECIStringBuilder.java
Patch:
@@ -77,7 +77,7 @@ public void append(int value) {
   /**
    * Appends ECI value to output.
    *
-   * @param ECI value to append, as an int
+   * @param value ECI value to append, as an int
    */
   public void appendECI(int value) throws FormatException {
     encodeCurrentBytesIfAny();

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417HighLevelEncoder.java
Patch:
@@ -437,7 +437,7 @@ private static void encodeMultiECIBinary(ECIInput input,
         //encode the segment
         encodeBinary(subBytes(input, localStart, localEnd),
             0, localCount, localStart == startpos ? startmode : BYTE_COMPACTION, sb);
-        localStart = localEnd + 1;
+        localStart = localEnd;
       }
     }
   }

File: core/src/main/java/com/google/zxing/datamatrix/DataMatrixWriter.java
Patch:
@@ -99,7 +99,9 @@ public BitMatrix encode(String contents, BarcodeFormat format, int width, int he
       }
       encoded = MinimalEncoder.encodeHighLevel(contents, charset, hasGS1FormatHint ? 0x1D : -1, shape);
     } else {
-      encoded = HighLevelEncoder.encodeHighLevel(contents, shape, minSize, maxSize);
+      boolean hasForceC40Hint = hints != null && hints.containsKey(EncodeHintType.FORCE_C40) &&
+          Boolean.parseBoolean(hints.get(EncodeHintType.FORCE_C40).toString());
+      encoded = HighLevelEncoder.encodeHighLevel(contents, shape, minSize, maxSize, hasForceC40Hint);
     }
 
     SymbolInfo symbolInfo = SymbolInfo.lookup(encoded.length(), shape, minSize, maxSize, true);

File: core/src/main/java/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -301,7 +301,7 @@ private ResultPoint[] shiftToModuleCenter(ResultPoint[] points) {
   }
 
   private boolean isValid(ResultPoint p) {
-    return p.getX() >= 0 && p.getX() < image.getWidth() && p.getY() > 0 && p.getY() < image.getHeight();
+    return p.getX() >= 0 && p.getX() <= image.getWidth() - 1 && p.getY() > 0 && p.getY() <= image.getHeight() - 1;
   }
 
   private static BitMatrix sampleGrid(BitMatrix image,

File: core/src/main/java/com/google/zxing/qrcode/encoder/Encoder.java
Patch:
@@ -107,7 +107,7 @@ public static QRCode encode(String content,
     } else {
     
       // Pick an encoding mode appropriate for the content. Note that this will not attempt to use
-      // multiple modes / segments even if that were more efficient. Twould be nice.
+      // multiple modes / segments even if that were more efficient.
       mode = chooseMode(content, encoding);
   
       // This will store the header information, like mode and

File: core/src/main/java/com/google/zxing/qrcode/encoder/QRCode.java
Patch:
@@ -39,7 +39,7 @@ public QRCode() {
   }
 
   /**
-   * @return the mode. Not relevant if {@link com.google.zxing.EncodeHintType.java#QR_COMPACT} is selected.
+   * @return the mode. Not relevant if {@link com.google.zxing.EncodeHintType#QR_COMPACT} is selected.
    */
   public Mode getMode() {
     return mode;

File: core/src/main/java/com/google/zxing/qrcode/encoder/QRCode.java
Patch:
@@ -38,6 +38,9 @@ public QRCode() {
     maskPattern = -1;
   }
 
+  /**
+   * @return the mode. Not relevant if {@link com.google.zxing.EncodeHintType.java#QR_COMPACT} is selected.
+   */
   public Mode getMode() {
     return mode;
   }

File: core/src/main/java/com/google/zxing/common/reedsolomon/ReedSolomonDecoder.java
Patch:
@@ -100,7 +100,7 @@ private GenericGFPoly[] runEuclideanAlgorithm(GenericGFPoly a, GenericGFPoly b,
     GenericGFPoly t = field.getOne();
 
     // Run Euclidean algorithm until r's degree is less than R/2
-    while (r.getDegree() >= R / 2) {
+    while (2 * r.getDegree() >= R) {
       GenericGFPoly rLastLast = rLast;
       GenericGFPoly tLastLast = tLast;
       rLast = r;
@@ -125,7 +125,8 @@ private GenericGFPoly[] runEuclideanAlgorithm(GenericGFPoly a, GenericGFPoly b,
       t = q.multiply(tLast).addOrSubtract(tLastLast);
 
       if (r.getDegree() >= rLast.getDegree()) {
-        throw new IllegalStateException("Division algorithm failed to reduce polynomial?");
+        throw new IllegalStateException("Division algorithm failed to reduce polynomial? " +
+          "r: " + r + ", rLast: " + rLast);
       }
     }
 

File: core/src/main/java/com/google/zxing/aztec/detector/Detector.java
Patch:
@@ -550,7 +550,7 @@ private static ResultPoint[] expandSquare(ResultPoint[] cornerPoints, int oldSid
   }
 
   private boolean isValid(int x, int y) {
-    return x >= 0 && x < image.getWidth() && y > 0 && y < image.getHeight();
+    return x >= 0 && x < image.getWidth() && y >= 0 && y < image.getHeight();
   }
 
   private boolean isValid(ResultPoint point) {

File: core/src/main/java/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -179,8 +179,9 @@ static int decodeMacroBlock(int[] codewords, int codeIndex, PDF417ResultMetadata
     for (int i = 0; i < NUMBER_OF_SEQUENCE_CODEWORDS; i++, codeIndex++) {
       segmentIndexArray[i] = codewords[codeIndex];
     }
-    resultMetadata.setSegmentIndex(Integer.parseInt(decodeBase900toBase10(segmentIndexArray,
-        NUMBER_OF_SEQUENCE_CODEWORDS)));
+    String segmentIndexString = decodeBase900toBase10(segmentIndexArray, NUMBER_OF_SEQUENCE_CODEWORDS);
+    int segmentIndex = segmentIndexString.isEmpty() ? 0 : Integer.parseInt(segmentIndexString);
+    resultMetadata.setSegmentIndex(segmentIndex);
 
     // Decoding the fileId codewords as 0-899 numbers, each 0-filled to width 3. This follows the spec
     // (See ISO/IEC 15438:2015 Annex H.6) and preserves all info, but some generators (e.g. TEC-IT) write

File: core/src/main/java/com/google/zxing/aztec/decoder/Decoder.java
Patch:
@@ -183,6 +183,9 @@ private static String getEncodedData(boolean[] correctedBits) throws FormatExcep
                 eci = eci * 10 + (nextDigit - 2);
               }
               CharacterSetECI charsetECI = CharacterSetECI.getCharacterSetECIByValue(eci);
+              if (charsetECI == null) {
+                throw FormatException.getFormatInstance();
+              }
               encoding = charsetECI.getCharset();
           }
           // Go back to whatever mode we had been in

File: core/src/main/java/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -126,6 +126,9 @@ static DecoderResult decode(int[] codewords, String ecLevel) throws FormatExcept
         case ECI_CHARSET:
           CharacterSetECI charsetECI =
               CharacterSetECI.getCharacterSetECIByValue(codewords[codeIndex++]);
+          if (charsetECI == null) {
+            throw FormatException.getFormatInstance();
+          }
           encoding = charsetECI.getCharset();
           break;
         case ECI_GENERAL_PURPOSE:

File: core/src/main/java/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -76,7 +76,7 @@ public DetectorResult detect() throws NotFoundException {
       dimensionTop = dimensionRight = Math.max(dimensionTop, dimensionRight);
     }
 
-    BitMatrix bits = sampleGrid(image, 
+    BitMatrix bits = sampleGrid(image,
                                 topLeft,
                                 bottomLeft,
                                 bottomRight,
@@ -343,7 +343,8 @@ private int transitionsBetween(ResultPoint from, ResultPoint to) {
     int fromX = (int) from.getX();
     int fromY = (int) from.getY();
     int toX = (int) to.getX();
-    int toY = (int) to.getY();
+    int toY = Math.min(image.getHeight() - 1, (int) to.getY());
+
     boolean steep = Math.abs(toY - fromY) > Math.abs(toX - fromX);
     if (steep) {
       int temp = fromX;

File: core/src/main/java/com/google/zxing/aztec/encoder/HighLevelEncoder.java
Patch:
@@ -25,6 +25,7 @@
 import java.util.Collection;
 import java.util.Collections;
 import java.util.Comparator;
+import java.util.Deque;
 import java.util.Iterator;
 import java.util.LinkedList;
 
@@ -301,7 +302,7 @@ private static void updateStateForPair(State state, int index, int pairCode, Col
   }
 
   private static Collection<State> simplifyStates(Iterable<State> states) {
-    Collection<State> result = new LinkedList<>();
+    Deque<State> result = new LinkedList<>();
     for (State newState : states) {
       boolean add = true;
       for (Iterator<State> iterator = result.iterator(); iterator.hasNext();) {
@@ -315,7 +316,7 @@ private static Collection<State> simplifyStates(Iterable<State> states) {
         }
       }
       if (add) {
-        result.add(newState);
+        result.addFirst(newState);
       }
     }
     return result;

File: core/src/main/java/com/google/zxing/pdf417/decoder/ec/ErrorCorrection.java
Patch:
@@ -166,6 +166,9 @@ private int[] findErrorMagnitudes(ModulusPoly errorEvaluator,
                                     ModulusPoly errorLocator,
                                     int[] errorLocations) {
     int errorLocatorDegree = errorLocator.getDegree();
+    if (errorLocatorDegree < 1) {
+      return new int[0];
+    }
     int[] formalDerivativeCoefficients = new int[errorLocatorDegree];
     for (int i = 1; i <= errorLocatorDegree; i++) {
       formalDerivativeCoefficients[errorLocatorDegree - i] =

File: core/src/main/java/com/google/zxing/aztec/detector/Detector.java
Patch:
@@ -472,7 +472,7 @@ private int getColor(Point p1, Point p2) {
 
     boolean colorModel = image.get(p1.getX(), p1.getY());
 
-    int iMax = (int) Math.ceil(d);
+    int iMax = (int) Math.floor(d);
     for (int i = 0; i < iMax; i++) {
       px += dx;
       py += dy;

File: core/src/main/java/com/google/zxing/maxicode/MaxiCodeReader.java
Patch:
@@ -98,13 +98,13 @@ private static BitMatrix extractPureBits(BitMatrix image) throws NotFoundExcepti
     // Now just read off the bits
     BitMatrix bits = new BitMatrix(MATRIX_WIDTH, MATRIX_HEIGHT);
     for (int y = 0; y < MATRIX_HEIGHT; y++) {
-      int iy = top + (y * height + height / 2) / MATRIX_HEIGHT;
+      int iy = Math.min(top + (y * height + height / 2) / MATRIX_HEIGHT, height - 1);
       for (int x = 0; x < MATRIX_WIDTH; x++) {
         // srowen: I don't quite understand why the formula below is necessary, but it
         // can walk off the image if left + width = the right boundary. So cap it.
         int ix = left + Math.min(
           (x * width + width / 2 + (y & 0x01) * width / 2) / MATRIX_WIDTH,
-          width);
+          width - 1);
         if (image.get(ix, iy)) {
           bits.set(x, y);
         }

File: core/src/main/java/com/google/zxing/ResultMetadataType.java
Patch:
@@ -96,7 +96,7 @@ public enum ResultMetadataType {
 
   /**
    * Barcode Symbology Identifier.
-   * Note: According to the GS1 specification the identifer may have to replace a leading FNC1/GS character when prepending to the barcode content.
+   * Note: According to the GS1 specification the identifier may have to replace a leading FNC1/GS character when prepending to the barcode content.
    */
   SYMBOLOGY_IDENTIFIER,
 }

File: core/src/main/java/com/google/zxing/oned/Code128Reader.java
Patch:
@@ -482,9 +482,6 @@ public Result decodeRow(int rowNumber, BitArray row, Map<DecodeHintType,?> hints
                   }
                 }
                 break;
-              case CODE_FNC_2:
-                symbologyModifier = 4;
-                break;
               case CODE_CODE_A:
                 codeSet = CODE_CODE_A;
                 break;

File: core/src/main/java/com/google/zxing/ResultMetadataType.java
Patch:
@@ -96,6 +96,7 @@ public enum ResultMetadataType {
 
   /**
    * Barcode Symbology Identifier.
+   * Note: According to the GS1 specification the identifer may have to replace a leading FNC1/GS character when prepending to the barcode content.
    */
   SYMBOLOGY_IDENTIFIER,
 }

File: core/src/main/java/com/google/zxing/aztec/AztecWriter.java
Patch:
@@ -24,7 +24,6 @@
 import com.google.zxing.common.BitMatrix;
 
 import java.nio.charset.Charset;
-import java.nio.charset.StandardCharsets;
 import java.util.Map;
 
 /**
@@ -39,7 +38,7 @@ public BitMatrix encode(String contents, BarcodeFormat format, int width, int he
 
   @Override
   public BitMatrix encode(String contents, BarcodeFormat format, int width, int height, Map<EncodeHintType,?> hints) {
-    Charset charset = StandardCharsets.ISO_8859_1;
+    Charset charset = null; // Do not add any ECI code by default
     int eccPercent = Encoder.DEFAULT_EC_PERCENT;
     int layers = Encoder.DEFAULT_AZTEC_LAYERS;
     if (hints != null) {
@@ -62,7 +61,7 @@ private static BitMatrix encode(String contents, BarcodeFormat format,
     if (format != BarcodeFormat.AZTEC) {
       throw new IllegalArgumentException("Can only encode AZTEC, but got " + format);
     }
-    AztecCode aztec = Encoder.encode(contents.getBytes(charset), eccPercent, layers);
+    AztecCode aztec = Encoder.encode(contents, eccPercent, layers, charset);
     return renderResult(aztec, width, height);
   }
 

File: core/src/main/java/com/google/zxing/aztec/decoder/Decoder.java
Patch:
@@ -177,7 +177,7 @@ private static String getEncodedData(boolean[] correctedBits) throws FormatExcep
                 eci = eci * 10 + (nextDigit - 2);
               }
               CharacterSetECI charsetECI = CharacterSetECI.getCharacterSetECIByValue(eci);
-              encoding = Charset.forName(charsetECI.name());
+              encoding = charsetECI.getCharset();
           }
           // Go back to whatever mode we had been in
           shiftTable = latchTable;

File: core/src/main/java/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -125,7 +125,7 @@ static DecoderResult decode(int[] codewords, String ecLevel) throws FormatExcept
         case ECI_CHARSET:
           CharacterSetECI charsetECI =
               CharacterSetECI.getCharacterSetECIByValue(codewords[codeIndex++]);
-          encoding = Charset.forName(charsetECI.name());
+          encoding = charsetECI.getCharset();
           break;
         case ECI_GENERAL_PURPOSE:
           // Can't do anything with generic ECI; skip its 2 characters

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417HighLevelEncoder.java
Patch:
@@ -169,7 +169,7 @@ static String encodeHighLevel(String msg, Compaction compaction, Charset encodin
     if (encoding == null) {
       encoding = DEFAULT_ENCODING;
     } else if (!DEFAULT_ENCODING.equals(encoding)) {
-      CharacterSetECI eci = CharacterSetECI.getCharacterSetECIByName(encoding.name());
+      CharacterSetECI eci = CharacterSetECI.getCharacterSetECI(encoding);
       if (eci != null) {
         encodingECI(eci.getValue(), sb);
       }

File: core/src/test/java/com/google/zxing/aztec/detector/DetectorTest.java
Patch:
@@ -27,7 +27,6 @@
 import org.junit.Assert;
 import org.junit.Test;
 
-import java.nio.charset.StandardCharsets;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Collection;
@@ -62,7 +61,7 @@ public void testErrorInParameterLocatorNotCompact() throws Exception {
 
   // Test that we can tolerate errors in the parameter locator bits
   private static void testErrorInParameterLocator(String data) throws Exception {
-    AztecCode aztec = Encoder.encode(data.getBytes(StandardCharsets.ISO_8859_1), 25, Encoder.DEFAULT_AZTEC_LAYERS);
+    AztecCode aztec = Encoder.encode(data, 25, Encoder.DEFAULT_AZTEC_LAYERS);
     Random random = new Random(aztec.getMatrix().hashCode());   // pseudo-random, but deterministic
     int layers = aztec.getLayers();
     boolean compact = aztec.isCompact();

File: android/src/com/google/zxing/client/android/encode/QRCodeEncoder.java
Patch:
@@ -35,7 +35,6 @@
 import android.net.Uri;
 import android.os.Bundle;
 import android.provider.ContactsContract;
-import android.util.Log;
 
 import java.io.ByteArrayOutputStream;
 import java.io.IOException;

File: android/src/com/google/zxing/client/android/camera/CameraConfigurationManager.java
Patch:
@@ -161,7 +161,7 @@ void setDesiredCameraParameters(OpenCamera camera, boolean safeMode) {
     CameraConfigurationUtils.setFocus(
         parameters,
         prefs.getBoolean(PreferencesActivity.KEY_AUTO_FOCUS, true),
-        prefs.getBoolean(PreferencesActivity.KEY_DISABLE_CONTINUOUS_FOCUS, true),
+        prefs.getBoolean(PreferencesActivity.KEY_DISABLE_CONTINUOUS_FOCUS, false),
         safeMode);
 
     if (!safeMode) {

File: android/src/com/google/zxing/client/android/HttpHelper.java
Patch:
@@ -34,8 +34,6 @@
  */
 public final class HttpHelper {
 
-  private static final String TAG = HttpHelper.class.getSimpleName();
-
   private static final Collection<String> REDIRECTOR_DOMAINS = new HashSet<>(Arrays.asList(
     "amzn.to", "bit.ly", "bitly.com", "fb.me", "goo.gl", "is.gd", "j.mp", "lnkd.in", "ow.ly",
     "R.BEETAGG.COM", "r.beetagg.com", "SCN.BY", "su.pr", "t.co", "tinyurl.com", "tr.im"

File: core/src/main/java/com/google/zxing/datamatrix/encoder/C40Encoder.java
Patch:
@@ -42,7 +42,7 @@ public void encode(EncoderContext context) {
       if (!context.hasMoreCharacters()) {
         //Avoid having a single C40 value in the last triplet
         StringBuilder removed = new StringBuilder();
-        if ((buffer.length() % 3) == 2 && (available < 2 || available > 2)) {
+        if ((buffer.length() % 3) == 2 && available != 2) {
           lastCharSize = backtrackOneCharacter(context, buffer, removed, lastCharSize);
         }
         while ((buffer.length() % 3) == 1 && (lastCharSize > 3 || available != 1)) {

File: core/src/main/java/com/google/zxing/oned/UPCEWriter.java
Patch:
@@ -64,7 +64,7 @@ public boolean[] encode(String contents) {
         break;
       case 8:
         try {
-          if (!UPCEANReader.checkStandardUPCEANChecksum(contents)) {
+          if (!UPCEANReader.checkStandardUPCEANChecksum(UPCEReader.convertUPCEtoUPCA(contents))) {
             throw new IllegalArgumentException("Contents do not pass checksum");
           }
         } catch (FormatException ignored) {

File: core/src/main/java/com/google/zxing/multi/qrcode/detector/MultiFinderPatternFinder.java
Patch:
@@ -104,7 +104,7 @@ public int compare(FinderPattern center1, FinderPattern center2) {
    *         size differs from the average among those patterns the least
    * @throws NotFoundException if 3 such finder patterns do not exist
    */
-  private FinderPattern[][] selectMutipleBestPatterns() throws NotFoundException {
+  private FinderPattern[][] selectMultipleBestPatterns() throws NotFoundException {
     List<FinderPattern> possibleCenters = getPossibleCenters();
     int size = possibleCenters.size();
 
@@ -282,7 +282,7 @@ public FinderPatternInfo[] findMulti(Map<DecodeHintType,?> hints) throws NotFoun
         handlePossibleCenter(stateCount, i, maxJ);
       }
     } // for i=iSkip-1 ...
-    FinderPattern[][] patternInfo = selectMutipleBestPatterns();
+    FinderPattern[][] patternInfo = selectMultipleBestPatterns();
     List<FinderPatternInfo> result = new ArrayList<>();
     for (FinderPattern[] pattern : patternInfo) {
       ResultPoint.orderBestPatterns(pattern);

File: core/src/main/java/com/google/zxing/oned/Code93Reader.java
Patch:
@@ -52,7 +52,7 @@ public final class Code93Reader extends OneDReader {
       0x12E, 0x1D4, 0x1D2, 0x1CA, 0x16E, 0x176, 0x1AE, // - - %
       0x126, 0x1DA, 0x1D6, 0x132, 0x15E, // Control chars? $-*
   };
-  private static final int ASTERISK_ENCODING = CHARACTER_ENCODINGS[47];
+  static final int ASTERISK_ENCODING = CHARACTER_ENCODINGS[47];
 
   private final StringBuilder decodeRowResult;
   private final int[] counters;

File: core/src/test/java/com/google/zxing/common/BitArrayTestCase.java
Patch:
@@ -225,7 +225,7 @@ public void testEquals() {
     assertEquals(a.hashCode(), b.hashCode());
     assertNotEquals(a, new BitArray(31));
     a.set(16);
-    assertNotEquals(a, new BitArray(31));
+    assertNotEquals(a, b);
     assertNotEquals(a.hashCode(), b.hashCode());
     b.set(16);
     assertEquals(a, b);
@@ -255,4 +255,4 @@ private static boolean arraysAreEqual(int[] left, int[] right, int size) {
     return true;
   }
 
-}
\ No newline at end of file
+}

File: zxingorg/src/main/java/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -185,6 +185,7 @@ protected void doGet(HttpServletRequest request,
       } catch (IOException | IllegalStateException e) {
         log.info("Error " + e + " while reading data URI: " + imageURIString);
         errorResponse(request, response, "badurl");
+        return;
       }
       if (image == null) {
         log.info("Couldn't read data URI: " + imageURIString);
@@ -218,6 +219,7 @@ protected void doGet(HttpServletRequest request,
     if (destHostTracker.isBanned(imageURL.getHost())) {
       log.info("Temporarily not requesting from host: " + imageURIString);
       errorResponse(request, response, "badurl");
+      return;
     }
 
     HttpURLConnection connection;

File: core/src/main/java/com/google/zxing/client/result/URIParsedResult.java
Patch:
@@ -41,6 +41,8 @@ public String getTitle() {
   }
 
   /**
+   * @return true if the URI contains suspicious patterns that may suggest it intends to
+   *  mislead the user about its true nature
    * @deprecated see {@link URIResultParser#isPossiblyMaliciousURI(String)}
    */
   @Deprecated
@@ -81,4 +83,4 @@ private static boolean isColonFollowedByPortNumber(String uri, int protocolEnd)
   }
 
 
-}
\ No newline at end of file
+}

File: core/src/main/java/com/google/zxing/oned/OneDimensionalCodeWriter.java
Patch:
@@ -93,9 +93,10 @@ private static BitMatrix renderResult(boolean[] code, int width, int height, int
   }
 
   /**
-   * Throw IllegalArgumentException if input contains characters other than digits 0-9.
+   * @param contents string to check for numeric characters
+   * @throws IllegalArgumentException if input contains characters other than digits 0-9.
    */
-  protected static final void checkNumeric(String contents) throws IllegalArgumentException {
+  protected static void checkNumeric(String contents) {
     if (!NUMERIC.matcher(contents).matches()) {
       throw new IllegalArgumentException("Input should only contain digits 0-9");
     }

File: android/src/com/google/zxing/client/android/CaptureActivityHandler.java
Patch:
@@ -136,7 +136,7 @@ public void handleMessage(Message message) {
         try {
           activity.startActivity(intent);
         } catch (ActivityNotFoundException ignored) {
-          Log.w(TAG, "Can't find anything to handle VIEW of URI " + url);
+          Log.w(TAG, "Can't find anything to handle VIEW of URI");
         }
         break;
     }

File: android/src/com/google/zxing/client/android/DecodeThread.java
Patch:
@@ -24,7 +24,6 @@
 import android.os.Handler;
 import android.os.Looper;
 import android.preference.PreferenceManager;
-import android.util.Log;
 
 import java.util.Collection;
 import java.util.EnumMap;
@@ -90,7 +89,6 @@ final class DecodeThread extends Thread {
       hints.put(DecodeHintType.CHARACTER_SET, characterSet);
     }
     hints.put(DecodeHintType.NEED_RESULT_POINT_CALLBACK, resultPointCallback);
-    Log.i("DecodeThread", "Hints: " + hints);
   }
 
   Handler getHandler() {

File: android/src/com/google/zxing/client/android/HttpHelper.java
Patch:
@@ -16,8 +16,6 @@
 
 package com.google.zxing.client.android;
 
-import android.util.Log;
-
 import java.io.IOException;
 import java.io.InputStreamReader;
 import java.io.Reader;
@@ -193,7 +191,6 @@ private static HttpURLConnection safelyOpenConnection(URL url) throws IOExceptio
       conn = url.openConnection();
     } catch (NullPointerException npe) {
       // Another strange bug in Android?
-      Log.w(TAG, "Bad URI? " + url);
       throw new IOException(npe);
     }
     if (!(conn instanceof HttpURLConnection)) {

File: android/src/com/google/zxing/client/android/result/ResultHandler.java
Patch:
@@ -462,7 +462,6 @@ final void webSearch(String query) {
   final void rawLaunchIntent(Intent intent) {
     if (intent != null) {
       intent.addFlags(Intents.FLAG_NEW_DOC);
-      Log.d(TAG, "Launching intent: " + intent + " with extras: " + intent.getExtras());
       activity.startActivity(intent);
     }
   }

File: android/src/com/google/zxing/client/android/wifi/WifiConfigManager.java
Patch:
@@ -76,7 +76,7 @@ protected Object doInBackground(WifiParsedResult... args) {
     try {
       networkType = NetworkType.forIntentValue(networkTypeString);
     } catch (IllegalArgumentException ignored) {
-      Log.w(TAG, "Bad network type; see NetworkType values: " + networkTypeString);
+      Log.w(TAG, "Bad network type");
       return null;
     }
     if (networkType == NetworkType.NO_PASSWORD) {

File: android/src/com/google/zxing/client/android/history/HistoryManager.java
Patch:
@@ -298,7 +298,7 @@ void clearHistory() {
   static Uri saveHistory(String history) {
     File bsRoot = new File(Environment.getExternalStorageDirectory(), "BarcodeScanner");
     File historyRoot = new File(bsRoot, "History");
-    if (!historyRoot.exists() && !historyRoot.mkdirs()) {
+    if (!historyRoot.mkdirs() && !historyRoot.isDirectory()) {
       Log.w(TAG, "Couldn't make dir " + historyRoot);
       return null;
     }

File: javase/src/test/java/com/google/zxing/client/j2se/CommandLineEncoderTestCase.java
Patch:
@@ -25,6 +25,9 @@
 import java.nio.file.Files;
 import java.nio.file.Path;
 
+/**
+ * Tests {@link CommandLineEncoder}.
+ */
 public final class CommandLineEncoderTestCase extends Assert {
 
   @Test

File: javase/src/test/java/com/google/zxing/client/j2se/CommandLineRunnerTestCase.java
Patch:
@@ -19,6 +19,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link CommandLineRunner}.
+ */
 public final class CommandLineRunnerTestCase extends Assert {
 
   @Test

File: javase/src/test/java/com/google/zxing/client/j2se/DecodeWorkerTestCase.java
Patch:
@@ -30,7 +30,7 @@
  */
 public final class DecodeWorkerTestCase extends Assert {
 
-  private static final String IMAGE_DATA_URI =
+  static final String IMAGE_DATA_URI =
       "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhAQAAAAB/n//CAAAAkklEQVR42mP4DwQNDJjkB4" +
       "E77A0M369N/d7A8CV6rjiQjPMFkWG1QPL7RVGg%2BAfREKCa/5/vA9V/nFSQ3sDwb7/KdiDJqX4dSH4pXN/A8DfyDVD2" +
       "988HQPUfPVaqA0XKz%2BgD9bIk1AP1fgwvB7KlS9VBdqXbA82PT9AH2fiaH2SXGdDM71fDgeIfhIvKsbkTTAIAKYVr0N" +

File: javase/src/main/java/com/google/zxing/client/j2se/ImageReader.java
Patch:
@@ -21,7 +21,6 @@
 import java.io.ByteArrayInputStream;
 import java.io.IOException;
 import java.net.URI;
-import java.net.URLDecoder;
 
 /**
  * Encapsulates reading URIs as images.
@@ -60,8 +59,7 @@ public static BufferedImage readDataURIImage(URI uri) throws IOException {
     if (base64Start < 0) {
       throw new IOException("Unsupported data URI encoding");
     }
-    String base64DataEncoded = uriString.substring(base64Start + BASE64TOKEN.length());
-    String base64Data = URLDecoder.decode(base64DataEncoded, "UTF-8");
+    String base64Data = uriString.substring(base64Start + BASE64TOKEN.length());
     byte[] imageBytes = Base64Decoder.getInstance().decode(base64Data);
     return ImageIO.read(new ByteArrayInputStream(imageBytes));
   }

File: javase/src/test/java/com/google/zxing/client/j2se/ImageReaderTestCase.java
Patch:
@@ -28,7 +28,7 @@
 public final class ImageReaderTestCase extends Assert {
   
   @Test
-  public void testFoo() throws Exception {
+  public void testDataURI() throws Exception {
     String uri = 
         "data:image/gif;base64,R0lGODlhEAAQAMQAAORHHOVSKudfOulrSOp3WOyDZu6QdvCchPGolfO0o/XBs/fNwfjZ0frl3/zy7////w" +
         "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABAALAAAAAAQABAAAAVVICSOZGlCQAosJ6" +

File: zxing.appspot.com/src/main/java/com/google/zxing/web/generator/client/Generator.java
Patch:
@@ -68,10 +68,9 @@ public void onModuleLoad() {
 
     setupLeftPanel();
     topPanel.getElement().setId("leftpanel");
-    Widget leftPanel = topPanel;
 
     HorizontalPanel mainPanel = new HorizontalPanel();
-    mainPanel.add(leftPanel);
+    mainPanel.add(topPanel);
 
     SimplePanel div2 = new SimplePanel();
     div2.add(result);

File: zxingorg/src/main/java/com/google/zxing/web/DoSTracker.java
Patch:
@@ -38,7 +38,7 @@ final class DoSTracker {
   DoSTracker(Timer timer, final int maxAccessesPerTime, long accessTimeMS, int maxEntries) {
     this.maxAccessesPerTime = maxAccessesPerTime;
     this.numRecentAccesses = new LRUMap<>(maxEntries);
-    timer.scheduleAtFixedRate(new TimerTask() {
+    timer.schedule(new TimerTask() {
       @Override
       public void run() {
         synchronized (numRecentAccesses) {

File: zxingorg/src/test/java/com/google/zxing/web/HTTPSFilterTestCase.java
Patch:
@@ -42,7 +42,6 @@ public void setUp() {
     request.setRequestURI("/path");
     response = new MockHttpServletResponse();
     chain = new MockFilterChain();
-
   }
 
   @Test

File: core/src/main/java/com/google/zxing/oned/EAN13Writer.java
Patch:
@@ -78,6 +78,7 @@ public boolean[] encode(String contents) {
             "Requested contents should be 12 or 13 digits long, but got " + length);
     }
 
+    checkNumeric(contents);
 
     int firstDigit = Character.digit(contents.charAt(0), 10);
     int parities = EAN13Reader.FIRST_DIGIT_ENCODINGS[firstDigit];

File: core/src/main/java/com/google/zxing/oned/EAN8Writer.java
Patch:
@@ -82,6 +82,8 @@ public boolean[] encode(String contents) {
             "Requested contents should be 8 digits long, but got " + length);
     }
 
+    checkNumeric(contents);
+
     boolean[] result = new boolean[CODE_WIDTH];
     int pos = 0;
 

File: core/src/main/java/com/google/zxing/oned/ITFWriter.java
Patch:
@@ -74,6 +74,9 @@ public boolean[] encode(String contents) {
       throw new IllegalArgumentException(
           "Requested contents should be less than 80 digits long, but got " + length);
     }
+
+    checkNumeric(contents);
+
     boolean[] result = new boolean[9 + 9 * length];
     int pos = appendPattern(result, 0, START_PATTERN, true);
     for (int i = 0; i < length; i += 2) {

File: core/src/main/java/com/google/zxing/oned/UPCEWriter.java
Patch:
@@ -76,6 +76,8 @@ public boolean[] encode(String contents) {
             "Requested contents should be 8 digits long, but got " + length);
     }
 
+    checkNumeric(contents);
+
     int firstDigit = Character.digit(contents.charAt(0), 10);
     if (firstDigit != 0 && firstDigit != 1) {
       throw new IllegalArgumentException("Number system must be 0 or 1");

File: core/src/main/java/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -160,7 +160,7 @@ private static void decodeHanziSegment(BitSource bits,
       // Each 13 bits encodes a 2-byte character
       int twoBytes = bits.readBits(13);
       int assembledTwoBytes = ((twoBytes / 0x060) << 8) | (twoBytes % 0x060);
-      if (assembledTwoBytes < 0x003BF) {
+      if (assembledTwoBytes < 0x00A00) {
         // In the 0xA1A1 to 0xAAFE range
         assembledTwoBytes += 0x0A1A1;
       } else {

File: zxingorg/src/main/java/com/google/zxing/web/DoSFilter.java
Patch:
@@ -61,7 +61,9 @@ public void doFilter(ServletRequest request,
                        FilterChain chain) throws IOException, ServletException {
     if (isBanned((HttpServletRequest) request)) {
       HttpServletResponse servletResponse = (HttpServletResponse) response;
-      servletResponse.sendError(HttpServletResponse.SC_FORBIDDEN);
+      // Send very short response as requests may be very frequent
+      servletResponse.setStatus(HttpServletResponse.SC_FORBIDDEN);
+      servletResponse.getWriter().write("Forbidden");
     } else {
       chain.doFilter(request, response);
     }

File: core/src/test/java/com/google/zxing/common/reedsolomon/GenericGFPolyTestCase.java
Patch:
@@ -19,6 +19,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link GenericGFPoly}.
+ */
 public final class GenericGFPolyTestCase extends Assert {
 
   private static final GenericGF FIELD = GenericGF.QR_CODE_FIELD_256;

File: android/src/com/google/zxing/client/android/HttpHelper.java
Patch:
@@ -197,7 +197,7 @@ private static HttpURLConnection safelyOpenConnection(URL url) throws IOExceptio
       throw new IOException(npe);
     }
     if (!(conn instanceof HttpURLConnection)) {
-      throw new IOException();
+      throw new IOException("Expected HttpURLConnection but got " + conn.getClass());
     }
     return (HttpURLConnection) conn;
   }

File: core/src/main/java/com/google/zxing/datamatrix/decoder/DecodedBitStreamParser.java
Patch:
@@ -185,7 +185,7 @@ private static Mode decodeAsciiSegment(BitSource bits,
           default:
             // Not to be used in ASCII encodation
             // but work around encoders that end with 254, latch back to ASCII
-            if (oneByte >= 242 && (oneByte != 254 || bits.available() != 0)) {
+            if (oneByte != 254 || bits.available() != 0) {
               throw FormatException.getFormatInstance();
             }
             break;

File: core/src/main/java/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -256,9 +256,6 @@ protected final void shiftCounts2(int[] stateCount) {
    * 
    * @param centerI row where a finder pattern was detected
    * @param centerJ center of the section that appears to cross a finder pattern
-   * @param maxCount maximum reasonable number of modules that should be
-   *  observed in any reading state, based on the results of the horizontal scan
-   * @param originalStateCountTotal The original state count total.
    * @return true if proportions are withing expected limits
    */
   private boolean crossCheckDiagonal(int centerI, int centerJ) {

File: core/src/main/java/com/google/zxing/qrcode/encoder/Encoder.java
Patch:
@@ -92,7 +92,7 @@ public static QRCode encode(String content,
     BitArray headerBits = new BitArray();
 
     // Append ECI segment if applicable
-    if (mode == Mode.BYTE && (hasEncodingHint || !DEFAULT_BYTE_MODE_ENCODING.equals(encoding))) {
+    if (mode == Mode.BYTE && hasEncodingHint) {
       CharacterSetECI eci = CharacterSetECI.getCharacterSetECIByName(encoding);
       if (eci != null) {
         appendECI(eci, headerBits);

File: core/src/test/java/com/google/zxing/PlanarYUVLuminanceSourceTestCase.java
Patch:
@@ -19,6 +19,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link PlanarYUVLuminanceSource}.
+ */
 public final class PlanarYUVLuminanceSourceTestCase extends Assert {
 
   private static final byte[] YUV = {

File: core/src/test/java/com/google/zxing/RGBLuminanceSourceTestCase.java
Patch:
@@ -19,6 +19,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link RGBLuminanceSource}.
+ */
 public final class RGBLuminanceSourceTestCase extends Assert {
 
   private static final RGBLuminanceSource SOURCE = new RGBLuminanceSource(3, 3, new int[] {

File: core/src/test/java/com/google/zxing/aztec/decoder/DecoderTest.java
Patch:
@@ -23,6 +23,9 @@
 import org.junit.Test;
 import org.junit.Assert;
 
+/**
+ * Tests {@link Decoder}.
+ */
 public final class DecoderTest extends Assert {
 
   private static final ResultPoint[] NO_POINTS = new ResultPoint[0];

File: core/src/test/java/com/google/zxing/client/result/ExpandedProductParsedResultTestCase.java
Patch:
@@ -41,7 +41,7 @@
 public final class ExpandedProductParsedResultTestCase extends Assert {
 
   @Test
-  public void test_RSSExpanded() {
+  public void testRSSExpanded() {
     Map<String,String> uncommonAIs = new HashMap<>();
     uncommonAIs.put("123", "544654");
     Result result =

File: core/src/test/java/com/google/zxing/client/result/VINParsedResultTestCase.java
Patch:
@@ -22,6 +22,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link VINParsedResult}.
+ */
 public final class VINParsedResultTestCase extends Assert {
 
   @Test

File: core/src/test/java/com/google/zxing/common/AbstractBlackBoxTestCase.java
Patch:
@@ -322,7 +322,7 @@ protected static BufferedImage rotateImage(BufferedImage original, float degrees
       return original;
     }
 
-    switch(original.getType()) {
+    switch (original.getType()) {
       case BufferedImage.TYPE_BYTE_INDEXED:
       case BufferedImage.TYPE_BYTE_BINARY:
         BufferedImage argb = new BufferedImage(original.getWidth(),

File: core/src/test/java/com/google/zxing/common/TestResult.java
Patch:
@@ -16,6 +16,9 @@
 
 package com.google.zxing.common;
 
+/**
+ * Encapsulates the result of one test over a batch of black-box images.
+ */
 public final class TestResult {
 
   private final int mustPassCount;

File: core/src/test/java/com/google/zxing/common/detector/MathUtilsTestCase.java
Patch:
@@ -19,6 +19,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link MathUtils}.
+ */
 public final class MathUtilsTestCase extends Assert {
 
   private static final float EPSILON = 1.0E-8f;

File: core/src/test/java/com/google/zxing/common/reedsolomon/ReedSolomonTestCase.java
Patch:
@@ -493,7 +493,7 @@ private static void assertDataEquals(String message, int[] expected, int[] recei
   
   private static String arrayToString(int[] data) {
     StringBuilder sb = new StringBuilder("{");
-    for (int i=0; i<data.length; i++) {
+    for (int i = 0; i < data.length; i++) {
       sb.append(String.format(i > 0 ? ",%X" : "%X", data[i]));
     }
     return sb.append('}').toString();

File: core/src/test/java/com/google/zxing/datamatrix/decoder/DecodedBitStreamParserTestCase.java
Patch:
@@ -34,9 +34,9 @@ public void testAsciiStandardDecode() throws Exception {
   }
 
   @Test
-  public void testAsciiDoubleDigitDecode() throws Exception{
+  public void testAsciiDoubleDigitDecode() throws Exception {
     // ASCII double digit (00 - 99) Numeric Value + 130
-    byte[] bytes = {(byte)       130 , (byte) ( 1 + 130),
+    byte[] bytes = {(byte)       130 , (byte) (1 + 130),
                     (byte) (98 + 130), (byte) (99 + 130)};
     String decodedString = DecodedBitStreamParser.decode(bytes).getText();
     assertEquals("00019899", decodedString);

File: core/src/test/java/com/google/zxing/maxicode/Maxicode1TestCase.java
Patch:
@@ -20,6 +20,9 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
+/**
+ * Tests {@link MaxiCodeReader} against a fixed set of test images.
+ */
 public final class Maxicode1TestCase extends AbstractBlackBoxTestCase {
 
   public Maxicode1TestCase() {

File: core/src/test/java/com/google/zxing/multi/MultiTestCase.java
Patch:
@@ -31,6 +31,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link MultipleBarcodeReader}.
+ */
 public final class MultiTestCase extends Assert {
 
   @Test

File: core/src/test/java/com/google/zxing/multi/qrcode/MultiQRCodeTestCase.java
Patch:
@@ -35,6 +35,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link QRCodeMultiReader}.
+ */
 public final class MultiQRCodeTestCase extends Assert {
 
   @Test

File: core/src/test/java/com/google/zxing/oned/Code128WriterTestCase.java
Patch:
@@ -28,6 +28,9 @@
 import com.google.zxing.common.BitArray;
 import com.google.zxing.common.BitMatrix;
 
+/**
+ * Tests {@link Code128Writer}.
+ */
 public class Code128WriterTestCase extends Assert {
 
   private static final String FNC1 = "11110101110";

File: core/src/test/java/com/google/zxing/oned/Code39ExtendedModeTestCase.java
Patch:
@@ -32,7 +32,7 @@
 public final class Code39ExtendedModeTestCase extends Assert {
 
   @Test
-  public void testDecodeExtendedMode() throws FormatException, ChecksumException, NotFoundException {
+  public void testDecodeExtendedMode() throws Exception {
     doTest("\u0000\u0001\u0002\u0003\u0004\u0005\u0006\u0007\b\t\n\u000b\f\r\u000e\u000f\u0010\u0011\u0012\u0013\u0014\u0015\u0016\u0017\u0018\u0019\u001a\u001b\u001c\u001d\u001e\u001f",
            "000001001011011010101001001001011001010101101001001001010110101001011010010010010101011010010110100100100101011011010010101001001001010101011001011010010010010101101011001010100100100101010110110010101001001001010101010011011010010010010101101010011010100100100101010110100110101001001001010101011001101010010010010101101010100110100100100101010110101001101001001001010110110101001010010010010101010110100110100100100101011010110100101001001001010101101101001010010010010101010101100110100100100101011010101100101001001001010101101011001010010010010101010110110010100100100101011001010101101001001001010100110101011010010010010101100110101010100100100101010010110101101001001001010110010110101010010010010101001101101010101001001001011010100101101010010010010101101001011010100100100101101101001010101001001001010101100101101010010010010110101100101010010110110100000");
     doTest(" !\"#$%&'()*+,-./0123456789:;<=>?",

File: core/src/test/java/com/google/zxing/oned/Code39WriterTestCase.java
Patch:
@@ -23,6 +23,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link Code39Writer}.
+ */
 public final class Code39WriterTestCase extends Assert {
 
   @Test

File: core/src/test/java/com/google/zxing/oned/Code93WriterTestCase.java
Patch:
@@ -23,6 +23,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link Code93Writer}.
+ */
 public final class Code93WriterTestCase extends Assert {
 
   @Test

File: core/src/test/java/com/google/zxing/oned/ITFWriterTestCase.java
Patch:
@@ -23,6 +23,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link ITFWriter}.
+ */
 public final class ITFWriterTestCase extends Assert {
 
   @Test

File: core/src/test/java/com/google/zxing/oned/UPCEWriterTestCase.java
Patch:
@@ -23,6 +23,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link UPCEWriter}.
+ */
 public final class UPCEWriterTestCase extends Assert {
 
   @Test

File: core/src/test/java/com/google/zxing/oned/rss/expanded/RSSExpandedBlackBox1TestCase.java
Patch:
@@ -30,6 +30,9 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
+/**
+ * A test of {@link RSSExpandedReader} against a fixed test set of images.
+ */
 public final class RSSExpandedBlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public RSSExpandedBlackBox1TestCase() {

File: core/src/test/java/com/google/zxing/oned/rss/expanded/RSSExpandedBlackBox2TestCase.java
Patch:
@@ -30,6 +30,9 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
+/**
+ * A test of {@link RSSExpandedReader} against a fixed test set of images.
+ */
 public final class RSSExpandedBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public RSSExpandedBlackBox2TestCase() {

File: core/src/test/java/com/google/zxing/oned/rss/expanded/RSSExpandedBlackBox3TestCase.java
Patch:
@@ -30,6 +30,9 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
+/**
+ * A test of {@link RSSExpandedReader} against a fixed test set of images.
+ */
 public final class RSSExpandedBlackBox3TestCase extends AbstractBlackBoxTestCase {
     
     public RSSExpandedBlackBox3TestCase() {

File: core/src/test/java/com/google/zxing/oned/rss/expanded/RSSExpandedImage2resultTestCase.java
Patch:
@@ -61,7 +61,7 @@
 public final class RSSExpandedImage2resultTestCase extends Assert {
 
   @Test
-  public void testDecodeRow2result_2() throws Exception {
+  public void testDecodeRow2result2() throws Exception {
     // (01)90012345678908(3103)001750
     ExpandedProductParsedResult expected =
         new ExpandedProductParsedResult("(01)90012345678908(3103)001750",

File: core/src/test/java/com/google/zxing/oned/rss/expanded/RSSExpandedStackedInternalTestCase.java
Patch:
@@ -37,6 +37,9 @@
 import com.google.zxing.Result;
 import com.google.zxing.common.BitArray;
 
+/**
+ * Tests {@link RSSExpandedReader} handling of stacked RSS barcodes.
+ */
 public final class RSSExpandedStackedInternalTestCase extends Assert {
 
   @Test

File: core/src/test/java/com/google/zxing/oned/rss/expanded/decoders/FieldParserTest.java
Patch:
@@ -43,12 +43,12 @@ private static void checkFields(String expected) throws NotFoundException {
   }
 
   @Test
-  public void testParseField() throws Exception{
+  public void testParseField() throws Exception {
     checkFields("(15)991231(3103)001750(10)12A");
   }
 
   @Test
-  public void testParseField2() throws Exception{
+  public void testParseField2() throws Exception {
     checkFields("(15)991231(15)991231(3103)001750(10)12A");
   }
 }

File: core/src/test/java/com/google/zxing/pdf417/PDF417BlackBox3TestCase.java
Patch:
@@ -20,6 +20,9 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
+/**
+ * Tests {@link PDF417Reader} against more sample images.
+ */
 public final class PDF417BlackBox3TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox3TestCase() {

File: core/src/test/java/com/google/zxing/pdf417/PDF417WriterTestCase.java
Patch:
@@ -26,6 +26,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link PDF417Writer}.
+ */
 public final class PDF417WriterTestCase extends Assert {
 
   @Test

File: core/src/test/java/com/google/zxing/pdf417/decoder/PDF417DecoderTestCase.java
Patch:
@@ -21,6 +21,9 @@
 import org.junit.Assert;
 import org.junit.Test;
 
+/**
+ * Tests {@link DecodedBitStreamParser}.
+ */
 public class PDF417DecoderTestCase extends Assert {
 
   /**

File: core/src/test/java/com/google/zxing/qrcode/decoder/VersionTestCase.java
Patch:
@@ -33,7 +33,7 @@ public void testVersionForNumber() {
       // good
     }
     for (int i = 1; i <= 40; i++) {
-      checkVersion(Version.getVersionForNumber(i), i, 4*i + 17);
+      checkVersion(Version.getVersionForNumber(i), i, 4 * i + 17);
     }
   }
 
@@ -55,7 +55,7 @@ private static void checkVersion(Version version, int number, int dimension) {
   @Test
   public void testGetProvisionalVersionForDimension() throws Exception {
     for (int i = 1; i <= 40; i++) {
-      assertEquals(i, Version.getProvisionalVersionForDimension(4*i + 17).getVersionNumber());
+      assertEquals(i, Version.getProvisionalVersionForDimension(4 * i + 17).getVersionNumber());
     }
   }
 

File: javase/src/main/java/com/google/zxing/client/j2se/DecoderConfig.java
Patch:
@@ -84,8 +84,7 @@ final class DecoderConfig {
   Map<DecodeHintType,?> buildHints() {
     List<BarcodeFormat> finalPossibleFormats = possibleFormats;
     if (finalPossibleFormats == null || finalPossibleFormats.isEmpty()) {
-      finalPossibleFormats = new ArrayList<>();
-      finalPossibleFormats.addAll(Arrays.asList(
+      finalPossibleFormats = new ArrayList<>(Arrays.asList(
           BarcodeFormat.UPC_A,
           BarcodeFormat.UPC_E,
           BarcodeFormat.EAN_13,

File: javase/src/test/java/com/google/zxing/client/j2se/Base64DecoderTestCase.java
Patch:
@@ -21,6 +21,9 @@
 
 import java.nio.charset.StandardCharsets;
 
+/**
+ * Tests {@link Base64Decoder}.
+ */
 public final class Base64DecoderTestCase extends Assert {
   
   @Test

File: javase/src/test/java/com/google/zxing/client/j2se/ImageReaderTestCase.java
Patch:
@@ -22,6 +22,9 @@
 import java.awt.image.BufferedImage;
 import java.net.URI;
 
+/**
+ * Tests {@link ImageReader}.
+ */
 public final class ImageReaderTestCase extends Assert {
   
   @Test

File: javase/src/test/java/com/google/zxing/client/j2se/MatrixToImageWriterTestCase.java
Patch:
@@ -26,6 +26,9 @@
 import java.nio.file.Files;
 import java.nio.file.Path;
 
+/**
+ * Tests {@link MatrixToImageWriter}.
+ */
 public final class MatrixToImageWriterTestCase extends Assert {
   
   @Test

File: zxingorg/src/main/java/com/google/zxing/web/AbstractFilter.java
Patch:
@@ -33,16 +33,17 @@
 abstract class AbstractFilter implements Filter {
 
   @Override
-  public void init(FilterConfig filterConfig) throws ServletException {
+  public final void init(FilterConfig filterConfig) {
     // do nothing
   }
 
   @Override
   public abstract void doFilter(ServletRequest request, 
                        ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException;
+
   @Override
-  public void destroy() {
+  public final void destroy() {
     // do nothing
   }
   

File: zxingorg/src/main/java/com/google/zxing/web/OutputUtils.java
Patch:
@@ -50,7 +50,7 @@ public static String arrayToString(byte[] bytes) {
   
   private static char hexChar(int value) {
     if (value < 0 || value > 15) {
-      throw new IllegalArgumentException();
+      throw new IllegalArgumentException("Bad hex digit value " + value);
     }
     return (char) (value < 10 ? ('0' + value) : ('a' + (value - 10)));
   }

File: zxingorg/src/main/java/com/google/zxing/web/WelcomeFilter.java
Patch:
@@ -17,11 +17,9 @@
 package com.google.zxing.web;
 
 import javax.servlet.FilterChain;
-import javax.servlet.ServletException;
 import javax.servlet.ServletRequest;
 import javax.servlet.ServletResponse;
 import javax.servlet.annotation.WebFilter;
-import java.io.IOException;
 
 /**
  * Handles redirects to the app landing page.
@@ -32,7 +30,7 @@ public final class WelcomeFilter extends AbstractFilter {
   @Override
   public void doFilter(ServletRequest servletRequest,
                        ServletResponse servletResponse,
-                       FilterChain filterChain) throws IOException, ServletException {
+                       FilterChain filterChain) {
     redirect(servletResponse, "/w/decode.jspx");
   }
 

File: core/src/main/java/com/google/zxing/multi/qrcode/detector/MultiFinderPatternFinder.java
Patch:
@@ -240,7 +240,7 @@ public FinderPatternInfo[] findMulti(Map<DecodeHintType,?> hints) throws NotFoun
     // image, and then account for the center being 3 modules in size. This gives the smallest
     // number of pixels the center could be, so skip this often. When trying harder, look for all
     // QR versions regardless of how dense they are.
-    int iSkip = (int) (maxI / (MAX_MODULES * 4.0f) * 3);
+    int iSkip = (3 * maxI) / (4 * MAX_MODULES);
     if (iSkip < MIN_SKIP || tryHarder) {
       iSkip = MIN_SKIP;
     }

File: core/src/main/java/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -41,7 +41,7 @@ public class FinderPatternFinder {
 
   private static final int CENTER_QUORUM = 2;
   protected static final int MIN_SKIP = 3; // 1 pixel/module times 3 modules/center
-  protected static final int MAX_MODULES = 57; // support up to version 10 for mobile clients
+  protected static final int MAX_MODULES = 97; // support up to version 20 for mobile clients
 
   private final BitMatrix image;
   private final List<FinderPattern> possibleCenters;

File: core/src/test/java/com/google/zxing/qrcode/QRCodeBlackBox6TestCase.java
Patch:
@@ -30,7 +30,7 @@ public QRCodeBlackBox6TestCase() {
     super("src/test/resources/blackbox/qrcode-6", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(15, 15, 0.0f);
     addTest(14, 14, 90.0f);
-    addTest(12, 13, 180.0f);
+    addTest(13, 13, 180.0f);
     addTest(14, 14, 270.0f);
   }
 

File: android/src/com/google/zxing/client/android/result/ResultHandler.java
Patch:
@@ -201,7 +201,7 @@ final void addContact(String[] names,
     // Only use the first name in the array, if present.
     Intent intent = new Intent(Intent.ACTION_INSERT_OR_EDIT, ContactsContract.Contacts.CONTENT_URI);
     intent.setType(ContactsContract.Contacts.CONTENT_ITEM_TYPE);
-    putExtra(intent, ContactsContract.Intents.Insert.NAME, names != null ? names[0] : null);
+    putExtra(intent, ContactsContract.Intents.Insert.NAME, names != null && names.length > 0 ? names[0] : null);
 
     putExtra(intent, ContactsContract.Intents.Insert.PHONETIC_NAME, pronunciation);
 
@@ -270,7 +270,7 @@ final void addContact(String[] names,
     if (note != null) {
       aggregatedNotes.append('\n').append(note);
     }
-    if (geo != null) {
+    if (geo != null && geo.length >= 2) {
       aggregatedNotes.append('\n').append(geo[0]).append(',').append(geo[1]);
     }
 

File: zxingorg/src/main/java/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -303,7 +303,7 @@ protected void doPost(HttpServletRequest request, HttpServletResponse response)
       return;
     } catch (IOException ioe) {
       log.info(ioe.toString());
-      errorResponse(request, response, "badurl");
+      errorResponse(request, response, "badimage");
       return;
     }
     Part fileUploadPart = null;

File: javase/src/main/java/com/google/zxing/client/j2se/DecodeWorker.java
Patch:
@@ -163,6 +163,9 @@ private Result[] decode(URI uri, Map<DecodeHintType,?> hints) throws IOException
         output.write("Found " + result.getResultPoints().length + " result points.\n");
         for (int pointIndex = 0; pointIndex < result.getResultPoints().length; pointIndex++) {
           ResultPoint rp = result.getResultPoints()[pointIndex];
+          if (rp == null) {
+            continue;
+          }
           output.write("  Point " + pointIndex + ": (" + rp.getX() + ',' + rp.getY() + ')');
           if (pointIndex != result.getResultPoints().length - 1) {
             output.write('\n');

File: zxingorg/src/main/java/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -83,7 +83,7 @@
 @MultipartConfig(
     maxFileSize = 1L << 26, // ~64MB
     maxRequestSize = 1L << 26, // ~64MB
-    fileSizeThreshold = 1 << 20, // ~1MB
+    fileSizeThreshold = 1 << 23, // ~8MB
     location = "/tmp")
 @WebServlet(value = "/w/decode", loadOnStartup = 1)
 public final class DecodeServlet extends HttpServlet {

File: android/src/com/google/zxing/client/android/encode/MECARDContactEncoder.java
Patch:
@@ -79,10 +79,10 @@ public CharSequence format(CharSequence value, int index) {
   }
 
   private static class MECARDTelDisplayFormatter implements Formatter {
-    private static final Pattern NOT_DIGITS = Pattern.compile("[^0-9]+");
+    private static final Pattern NOT_DIGITS_OR_PLUS = Pattern.compile("[^0-9+]+");
     @Override
     public CharSequence format(CharSequence value, int index) {
-      return NOT_DIGITS.matcher(PhoneNumberUtils.formatNumber(value.toString())).replaceAll("");
+      return NOT_DIGITS_OR_PLUS.matcher(PhoneNumberUtils.formatNumber(value.toString())).replaceAll("");
     }
   }
 

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -430,7 +430,7 @@ public void surfaceDestroyed(SurfaceHolder holder) {
 
   @Override
   public void surfaceChanged(SurfaceHolder holder, int format, int width, int height) {
-
+    // do nothing
   }
 
   /**

File: android/src/com/google/zxing/client/android/HttpHelper.java
Patch:
@@ -92,8 +92,7 @@ public static CharSequence downloadViaHttp(String uri, ContentType type, int max
       case XML:
         contentTypes = "application/xml,text/*,*/*";
         break;
-      case TEXT:
-      default:
+      default: // Includes TEXT
         contentTypes = "text/*,*/*";
     }
     return downloadViaHttp(uri, contentTypes, maxChars);

File: android/src/com/google/zxing/client/android/camera/open/OpenCameraInterface.java
Patch:
@@ -27,12 +27,12 @@ public final class OpenCameraInterface {
 
   private static final String TAG = OpenCameraInterface.class.getName();
 
-  private OpenCameraInterface() {
-  }
-
   /** For {@link #open(int)}, means no preference for which camera to open. */
   public static final int NO_REQUESTED_CAMERA = -1;
 
+  private OpenCameraInterface() {
+  }
+
   /**
    * Opens the requested camera with {@link Camera#open(int)}, if one exists.
    *

File: core/src/test/java/com/google/zxing/oned/Code128WriterTestCase.java
Patch:
@@ -44,7 +44,7 @@ public class Code128WriterTestCase extends Assert {
   private Code128Reader reader;
 
   @Before
-  public void setup() {
+  public void setUp() {
     writer = new Code128Writer();
     reader = new Code128Reader();
   }

File: javase/src/main/java/com/google/zxing/client/j2se/MatrixToImageWriter.java
Patch:
@@ -115,7 +115,7 @@ public static void writeToFile(BitMatrix matrix, String format, File file, Matri
   }
 
   /**
-   * As {@link #writeToFile(BitMatrix, String, File)}, but allows customization of the output.
+   * As {@link #writeToPath(BitMatrix, String, Path)}, but allows customization of the output.
    *
    * @param matrix {@link BitMatrix} to write
    * @param format image format

File: javase/src/test/java/com/google/zxing/client/j2se/MatrixToImageWriterTestCase.java
Patch:
@@ -56,7 +56,7 @@ private static void doTestFormat(String format, MatrixToImageConfig config) thro
     matrix.set(0, 1);
     matrix.set(1, 2);
     
-    BufferedImage newImage = null;
+    BufferedImage newImage;
     Path tempFile = Files.createTempFile(null, "." + format);
     try {
       MatrixToImageWriter.writeToPath(matrix, format, tempFile, config);

File: android/src/com/google/zxing/client/android/result/WifiResultHandler.java
Patch:
@@ -61,7 +61,7 @@ public int getButtonText(int index) {
   public void handleButtonPress(int index) {
     if (index == 0) {
       WifiParsedResult wifiResult = (WifiParsedResult) getResult();
-      WifiManager wifiManager = (WifiManager) getActivity().getSystemService(Context.WIFI_SERVICE);
+      WifiManager wifiManager = (WifiManager) getActivity().getApplicationContext().getSystemService(Context.WIFI_SERVICE);
       if (wifiManager == null) {
         Log.w(TAG, "No WifiManager available from device");
         return;

File: core/src/main/java/com/google/zxing/datamatrix/encoder/Base256Encoder.java
Patch:
@@ -35,7 +35,8 @@ public void encode(EncoderContext context) {
 
       int newMode = HighLevelEncoder.lookAheadTest(context.getMessage(), context.pos, getEncodingMode());
       if (newMode != getEncodingMode()) {
-        context.signalEncoderChange(newMode);
+        // Return to ASCII encodation, which will actually handle latch to new mode
+        context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
         break;
       }
     }

File: core/src/main/java/com/google/zxing/datamatrix/encoder/C40Encoder.java
Patch:
@@ -59,7 +59,8 @@ public void encode(EncoderContext context) {
       if ((count % 3) == 0) {
         int newMode = HighLevelEncoder.lookAheadTest(context.getMessage(), context.pos, getEncodingMode());
         if (newMode != getEncodingMode()) {
-          context.signalEncoderChange(newMode);
+          // Return to ASCII encodation, which will actually handle latch to new mode
+          context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
           break;
         }
       }

File: core/src/main/java/com/google/zxing/datamatrix/encoder/EdifactEncoder.java
Patch:
@@ -39,6 +39,7 @@ public void encode(EncoderContext context) {
 
         int newMode = HighLevelEncoder.lookAheadTest(context.getMessage(), context.pos, getEncodingMode());
         if (newMode != getEncodingMode()) {
+          // Return to ASCII encodation, which will actually handle latch to new mode
           context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
           break;
         }

File: core/src/main/java/com/google/zxing/datamatrix/encoder/X12Encoder.java
Patch:
@@ -39,7 +39,8 @@ public void encode(EncoderContext context) {
 
         int newMode = HighLevelEncoder.lookAheadTest(context.getMessage(), context.pos, getEncodingMode());
         if (newMode != getEncodingMode()) {
-          context.signalEncoderChange(newMode);
+          // Return to ASCII encodation, which will actually handle latch to new mode
+          context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
           break;
         }
       }

File: javase/src/main/java/com/google/zxing/client/j2se/Java8Base64Decoder.java
Patch:
@@ -29,9 +29,10 @@ byte[] decode(String s) {
           .getMethod("getDecoder").invoke(null);
       return (byte[]) Class.forName("java.util.Base64$Decoder")
           .getMethod("decode", String.class).invoke(decoder, s);
-    } catch (IllegalAccessException | InvocationTargetException |
-             NoSuchMethodException | ClassNotFoundException e) {
+    } catch (IllegalAccessException | NoSuchMethodException | ClassNotFoundException e) {
       throw new IllegalStateException(e);
+    } catch (InvocationTargetException ite) {
+      throw new IllegalStateException(ite.getCause());
     }
   }
 }

File: javase/src/main/java/com/google/zxing/client/j2se/Java8Base64Decoder.java
Patch:
@@ -27,7 +27,7 @@ byte[] decode(String s) {
     try {
       Object decoder = Class.forName("java.util.Base64")
           .getMethod("getDecoder").invoke(null);
-      return (byte[]) Class.forName("java.util.Base64.Decoder")
+      return (byte[]) Class.forName("java.util.Base64$Decoder")
           .getMethod("decode", String.class).invoke(decoder, s);
     } catch (IllegalAccessException | InvocationTargetException |
              NoSuchMethodException | ClassNotFoundException e) {

File: android/src/com/google/zxing/client/android/HttpHelper.java
Patch:
@@ -216,8 +216,8 @@ private static HttpURLConnection safelyOpenConnection(URL url) throws IOExceptio
   private static int safelyConnect(HttpURLConnection connection) throws IOException {
     try {
       connection.connect();
-    } catch (NullPointerException | IllegalArgumentException | IndexOutOfBoundsException | SecurityException e) {
-      // this is an Android bug: http://code.google.com/p/android/issues/detail?id=16895
+    } catch (RuntimeException e) {
+      // These are, generally, Android bugs
       throw new IOException(e);
     }
     try {

File: core/src/main/java/com/google/zxing/common/reedsolomon/ReedSolomonEncoder.java
Patch:
@@ -20,7 +20,7 @@
 import java.util.List;
 
 /**
- * <p>Implements Reed-Solomon enbcoding, as the name implies.</p>
+ * <p>Implements Reed-Solomon encoding, as the name implies.</p>
  *
  * @author Sean Owen
  * @author William Rucklidge

File: zxing.appspot.com/src/main/java/com/google/zxing/web/generator/client/ContactInfoGenerator.java
Patch:
@@ -24,7 +24,7 @@
 import com.google.gwt.user.client.ui.Widget;
 
 /**
- * A Generator for contact informations, output is in MeCard format.
+ * A Generator for contact information, output is in MeCard format.
  * 
  * @author Yohann Coppel
  * @author Sean Owen

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -67,7 +67,6 @@
 import java.io.IOException;
 import java.text.DateFormat;
 import java.util.Collection;
-import java.util.Date;
 import java.util.EnumSet;
 import java.util.Map;
 
@@ -557,7 +556,7 @@ private void handleDecodeInternally(Result rawResult, ResultHandler resultHandle
 
     DateFormat formatter = DateFormat.getDateTimeInstance(DateFormat.SHORT, DateFormat.SHORT);
     TextView timeTextView = (TextView) findViewById(R.id.time_text_view);
-    timeTextView.setText(formatter.format(new Date(rawResult.getTimestamp())));
+    timeTextView.setText(formatter.format(rawResult.getTimestamp()));
 
 
     TextView metaTextView = (TextView) findViewById(R.id.meta_text_view);

File: android/src/com/google/zxing/client/android/history/HistoryManager.java
Patch:
@@ -41,7 +41,6 @@
 import java.nio.charset.Charset;
 import java.text.DateFormat;
 import java.util.ArrayList;
-import java.util.Date;
 import java.util.List;
 
 /**
@@ -299,8 +298,7 @@ CharSequence buildHistory() {
 
         // Add timestamp again, formatted
         long timestamp = cursor.getLong(3);
-        historyText.append('"').append(massageHistoryField(
-            format.format(new Date(timestamp)))).append("\",");
+        historyText.append('"').append(massageHistoryField(format.format(timestamp))).append("\",");
 
         // Above we're preserving the old ordering of columns which had formatted data in position 5
 

File: core/src/main/java/com/google/zxing/aztec/decoder/Decoder.java
Patch:
@@ -133,7 +133,7 @@ private static String getEncodedData(boolean[] correctedBits) {
         String str = getCharacter(shiftTable, code);
         if (str.startsWith("CTRL_")) {
           // Table changes
-          // ISO/IEC 24778:2008 prescibes ending a shift sequence in the mode from which it was invoked.
+          // ISO/IEC 24778:2008 prescribes ending a shift sequence in the mode from which it was invoked.
           // That's including when that mode is a shift.
           // Our test case dlusbs.png for issue #642 exercises that.
           latchTable = shiftTable;  // Latch the current mode, so as to return to Upper after U/S B/S

File: core/src/main/java/com/google/zxing/datamatrix/decoder/BitMatrixParser.java
Patch:
@@ -404,7 +404,7 @@ private BitMatrix extractDataRegion(BitMatrix bitMatrix) {
     int symbolSizeColumns = version.getSymbolSizeColumns();
     
     if (bitMatrix.getHeight() != symbolSizeRows) {
-      throw new IllegalArgumentException("Dimension of bitMarix must match the version size");
+      throw new IllegalArgumentException("Dimension of bitMatrix must match the version size");
     }
     
     int dataRegionSizeRows = version.getDataRegionSizeRows();

File: core/src/main/java/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -156,7 +156,7 @@ public DetectorResult detect() throws NotFoundException {
     BitMatrix bits;
     ResultPoint correctedTopRight;
 
-    // Rectanguar symbols are 6x16, 6x28, 10x24, 10x32, 14x32, or 14x44. If one dimension is more
+    // Rectangular symbols are 6x16, 6x28, 10x24, 10x32, 14x32, or 14x44. If one dimension is more
     // than twice the other, it's certainly rectangular, but to cut a bit more slack we accept it as
     // rectangular if the bigger side is at least 7/4 times the other:
     if (4 * dimensionTop >= 7 * dimensionRight || 4 * dimensionRight >= 7 * dimensionTop) {

File: core/src/main/java/com/google/zxing/oned/rss/expanded/RSSExpandedReader.java
Patch:
@@ -491,7 +491,7 @@ private void findNextPair(BitArray row, List<ExpandedPair> previousPairs, int fo
     int counterPosition = 0;
     int patternStart = rowOffset;
     for (int x = rowOffset; x < width; x++) {
-      if (row.get(x) ^ isWhite) {
+      if (row.get(x) != isWhite) {
         counters[counterPosition]++;
       } else {
         if (counterPosition == 3) {

File: core/src/main/java/com/google/zxing/pdf417/PDF417Writer.java
Patch:
@@ -109,7 +109,7 @@ private static BitMatrix bitMatrixFromEncoder(PDF417 encoder,
     int aspectRatio = 4;
     byte[][] originalScale = encoder.getBarcodeMatrix().getScaledMatrix(1, aspectRatio);
     boolean rotated = false;
-    if ((height > width) ^ (originalScale[0].length < originalScale.length)) {
+    if ((height > width) != (originalScale[0].length < originalScale.length)) {
       originalScale = rotateArray(originalScale);
       rotated = true;
     }

File: core/src/main/java/com/google/zxing/pdf417/decoder/BarcodeValue.java
Patch:
@@ -61,7 +61,7 @@ int[] getValue() {
     return PDF417Common.toIntArray(result);
   }
 
-  public Integer getConfidence(int value) {
+  Integer getConfidence(int value) {
     return values.get(value);
   }
 

File: core/src/main/java/com/google/zxing/pdf417/decoder/DetectionResult.java
Patch:
@@ -249,7 +249,7 @@ int getBarcodeECLevel() {
     return barcodeMetadata.getErrorCorrectionLevel();
   }
 
-  public void setBoundingBox(BoundingBox boundingBox) {
+  void setBoundingBox(BoundingBox boundingBox) {
     this.boundingBox = boundingBox;
   }
 

File: core/src/main/java/com/google/zxing/pdf417/encoder/BarcodeMatrix.java
Patch:
@@ -17,7 +17,7 @@
 package com.google.zxing.pdf417.encoder;
 
 /**
- * Holds all of the information for a barcode in a format where it can be easily accessable
+ * Holds all of the information for a barcode in a format where it can be easily accessible
  *
  * @author Jacob Haynes
  */

File: core/src/main/java/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -653,7 +653,7 @@ private FurthestFromAverageComparator(float f) {
     public int compare(FinderPattern center1, FinderPattern center2) {
       float dA = Math.abs(center2.getEstimatedModuleSize() - average);
       float dB = Math.abs(center1.getEstimatedModuleSize() - average);
-      return dA < dB ? -1 : dA == dB ? 0 : 1;
+      return dA < dB ? -1 : dA > dB ? 1 : 0;
     }
   }
 
@@ -670,7 +670,7 @@ public int compare(FinderPattern center1, FinderPattern center2) {
       if (center2.getCount() == center1.getCount()) {
         float dA = Math.abs(center2.getEstimatedModuleSize() - average);
         float dB = Math.abs(center1.getEstimatedModuleSize() - average);
-        return dA < dB ? 1 : dA == dB ? 0 : -1;
+        return dA < dB ? 1 : dA > dB ? -1 : 0;
       } else {
         return center2.getCount() - center1.getCount();
       }

File: core/src/test/java/com/google/zxing/client/result/CalendarParsedResultTestCase.java
Patch:
@@ -231,8 +231,8 @@ private static void doTest(String contents,
     assertEquals(summary, calResult.getSummary());
     assertEquals(location, calResult.getLocation());
     DateFormat dateFormat = makeGMTFormat();
-    assertEquals(startString, dateFormat.format(calResult.getStart()));
-    assertEquals(endString, calResult.getEnd() == null ? null : dateFormat.format(calResult.getEnd()));
+    assertEquals(startString, dateFormat.format(calResult.getStartTimestamp()));
+    assertEquals(endString, calResult.getEndTimestamp() < 0L ? null : dateFormat.format(calResult.getEndTimestamp()));
     assertEquals(organizer, calResult.getOrganizer());
     assertArrayEquals(attendees, calResult.getAttendees());
     assertEqualOrNaN(latitude, calResult.getLatitude());

File: core/src/test/java/com/google/zxing/common/AbstractNegativeBlackBoxTestCase.java
Patch:
@@ -126,7 +126,7 @@ public void testBlackBox() throws IOException {
    *
    * @param image The image to test
    * @param rotationInDegrees The amount of rotation to apply
-   * @return true if nothing found, false if a non-existant barcode was detected
+   * @return true if nothing found, false if a non-existent barcode was detected
    */
   private boolean checkForFalsePositives(BufferedImage image, float rotationInDegrees) {
     BufferedImage rotatedImage = rotateImage(image, rotationInDegrees);

File: core/src/main/java/com/google/zxing/oned/UPCEANWriter.java
Patch:
@@ -28,7 +28,7 @@ public abstract class UPCEANWriter extends OneDimensionalCodeWriter {
   @Override
   public int getDefaultMargin() {
     // Use a different default more appropriate for UPC/EAN
-    return UPCEANReader.START_END_PATTERN.length;
+    return 9;
   }
 
 }

File: core/src/test/java/com/google/zxing/oned/EAN13WriterTestCase.java
Patch:
@@ -30,14 +30,14 @@ public final class EAN13WriterTestCase extends Assert {
 
   @Test
   public void testEncode() throws WriterException {
-    String testStr = "00010100010110100111011001100100110111101001110101010110011011011001000010101110010011101000100101000";
+    String testStr = "00001010001011010011101100110010011011110100111010101011001101101100100001010111001001110100010010100000";
     BitMatrix result = new EAN13Writer().encode("5901234123457", BarcodeFormat.EAN_13, testStr.length(), 0);
     assertEquals(testStr, BitMatrixTestCase.matrixToString(result));
   }
 
   @Test
   public void testAddChecksumAndEncode() throws WriterException {
-    String testStr = "00010100010110100111011001100100110111101001110101010110011011011001000010101110010011101000100101000";
+    String testStr = "00001010001011010011101100110010011011110100111010101011001101101100100001010111001001110100010010100000";
     BitMatrix result = new EAN13Writer().encode("590123412345", BarcodeFormat.EAN_13, testStr.length(), 0);
     assertEquals(testStr, BitMatrixTestCase.matrixToString(result));
   }

File: core/src/test/java/com/google/zxing/oned/EAN8WriterTestCase.java
Patch:
@@ -30,14 +30,14 @@ public final class EAN8WriterTestCase extends Assert {
 
   @Test
   public void testEncode() throws WriterException {
-    String testStr = "0001010001011010111101111010110111010101001110111001010001001011100101000";
+    String testStr = "0000001010001011010111101111010110111010101001110111001010001001011100101000000";
     BitMatrix result = new EAN8Writer().encode("96385074", BarcodeFormat.EAN_8, testStr.length(), 0);
     assertEquals(testStr, BitMatrixTestCase.matrixToString(result));
   }
 
   @Test
   public void testAddChecksumAndEncode() throws WriterException {
-    String testStr = "0001010001011010111101111010110111010101001110111001010001001011100101000";
+    String testStr = "0000001010001011010111101111010110111010101001110111001010001001011100101000000";
     BitMatrix result = new EAN8Writer().encode("9638507", BarcodeFormat.EAN_8, testStr.length(), 0);
     assertEquals(testStr, BitMatrixTestCase.matrixToString(result));
   }

File: core/src/test/java/com/google/zxing/oned/UPCAWriterTestCase.java
Patch:
@@ -31,14 +31,14 @@ public final class UPCAWriterTestCase extends Assert {
 
   @Test
   public void testEncode() throws WriterException {
-    String testStr = "00010101000110110111011000100010110101111011110101010111001011101001001110110011011011001011100101000";
+    String testStr = "00001010100011011011101100010001011010111101111010101011100101110100100111011001101101100101110010100000";
     BitMatrix result = new UPCAWriter().encode("485963095124", BarcodeFormat.UPC_A, testStr.length(), 0);
     assertEquals(testStr, BitMatrixTestCase.matrixToString(result));
   }
 
   @Test
   public void testAddChecksumAndEncode() throws WriterException {
-    String testStr = "00010100110010010011011110101000110110001010111101010100010010010001110100111001011001101101100101000";
+    String testStr = "00001010011001001001101111010100011011000101011110101010001001001000111010011100101100110110110010100000";
     BitMatrix result = new UPCAWriter().encode("12345678901", BarcodeFormat.UPC_A, testStr.length(), 0);
     assertEquals(testStr, BitMatrixTestCase.matrixToString(result));
   }

File: core/src/main/java/com/google/zxing/qrcode/encoder/Encoder.java
Patch:
@@ -78,7 +78,8 @@ public static QRCode encode(String content,
 
     // Determine what character encoding has been specified by the caller, if any
     String encoding = DEFAULT_BYTE_MODE_ENCODING;
-    if (hints != null && hints.containsKey(EncodeHintType.CHARACTER_SET)) {
+    boolean hasEncodingHint = hints != null && hints.containsKey(EncodeHintType.CHARACTER_SET);
+    if (hasEncodingHint) {
       encoding = hints.get(EncodeHintType.CHARACTER_SET).toString();
     }
 
@@ -91,7 +92,7 @@ public static QRCode encode(String content,
     BitArray headerBits = new BitArray();
 
     // Append ECI segment if applicable
-    if (mode == Mode.BYTE && !DEFAULT_BYTE_MODE_ENCODING.equals(encoding)) {
+    if (mode == Mode.BYTE && (hasEncodingHint || !DEFAULT_BYTE_MODE_ENCODING.equals(encoding))) {
       CharacterSetECI eci = CharacterSetECI.getCharacterSetECIByName(encoding);
       if (eci != null) {
         appendECI(eci, headerBits);

File: core/src/main/java/com/google/zxing/common/BitMatrix.java
Patch:
@@ -311,7 +311,7 @@ public int[] getEnclosingRectangle() {
       return null;
     }
 
-    return new int[] {left, top, right - left, bottom - top};
+    return new int[] {left, top, right - left + 1, bottom - top + 1};
   }
 
   /**

File: core/src/main/java/com/google/zxing/pdf417/decoder/ec/ModulusPoly.java
Patch:
@@ -201,6 +201,7 @@ ModulusPoly multiplyByMonomial(int degree, int coefficient) {
     return new ModulusPoly(field, product);
   }
 
+  /*
   ModulusPoly[] divide(ModulusPoly other) {
     if (!field.equals(other.field)) {
       throw new IllegalArgumentException("ModulusPolys do not have same ModulusGF field");
@@ -226,6 +227,7 @@ ModulusPoly[] divide(ModulusPoly other) {
 
     return new ModulusPoly[] { quotient, remainder };
   }
+   */
 
   @Override
   public String toString() {

File: core/src/main/java/com/google/zxing/ReaderException.java
Patch:
@@ -39,10 +39,8 @@ public abstract class ReaderException extends Exception {
   }
 
   // Prevent stack traces from being taken
-  // srowen says: huh, my IDE is saying this is not an override. native methods can't be overridden?
-  // This, at least, does not hurt. Because we use a singleton pattern here, it doesn't matter anyhow.
   @Override
-  public final Throwable fillInStackTrace() {
+  public final synchronized Throwable fillInStackTrace() {
     return null;
   }
 

File: core/src/main/java/com/google/zxing/aztec/detector/Detector.java
Patch:
@@ -470,7 +470,8 @@ private int getColor(Point p1, Point p2) {
 
     boolean colorModel = image.get(p1.getX(), p1.getY());
 
-    for (int i = 0; i < d; i++) {
+    int iMax = (int) Math.ceil(d);
+    for (int i = 0; i < iMax; i++) {
       px += dx;
       py += dy;
       if (image.get(MathUtils.round(px), MathUtils.round(py)) != colorModel) {

File: core/src/main/java/com/google/zxing/datamatrix/encoder/Base256Encoder.java
Patch:
@@ -47,7 +47,7 @@ public void encode(EncoderContext context) {
     if (context.hasMoreCharacters() || mustPad) {
       if (dataCount <= 249) {
         buffer.setCharAt(0, (char) dataCount);
-      } else if (dataCount > 249 && dataCount <= 1555) {
+      } else if (dataCount <= 1555) {
         buffer.setCharAt(0, (char) ((dataCount / 250) + 249));
         buffer.insert(1, (char) (dataCount % 250));
       } else {

File: android/src/com/google/zxing/client/android/wifi/NetworkType.java
Patch:
@@ -26,7 +26,8 @@ static NetworkType forIntentValue(String networkTypeString) {
     if (networkTypeString == null) {
       return NO_PASSWORD;
     }
-    if ("WPA".equals(networkTypeString)) {
+    if ("WPA".equals(networkTypeString) ||
+        "WPA2".equals(networkTypeString)) {
       return WPA;
     }
     if ("WEP".equals(networkTypeString)) {

File: core/src/main/java/com/google/zxing/datamatrix/decoder/Version.java
Patch:
@@ -139,7 +139,7 @@ ECB[] getECBlocks() {
   }
 
   /**
-   * <p>Encapsualtes the parameters for one error-correction block in one symbol version.
+   * <p>Encapsulates the parameters for one error-correction block in one symbol version.
    * This includes the number of data codewords, and the number of times a block with these
    * parameters is used consecutively in the Data Matrix code version's format.</p>
    */

File: core/src/main/java/com/google/zxing/qrcode/decoder/Version.java
Patch:
@@ -153,7 +153,7 @@ BitMatrix buildFunctionPattern() {
       int i = alignmentPatternCenters[x] - 2;
       for (int y = 0; y < max; y++) {
         if ((x == 0 && (y == 0 || y == max - 1)) || (x == max - 1 && y == 0)) {
-          // No alignment patterns near the three finder paterns
+          // No alignment patterns near the three finder patterns
           continue;
         }
         bitMatrix.setRegion(alignmentPatternCenters[y] - 2, i, 5, 5);
@@ -212,7 +212,7 @@ public ECB[] getECBlocks() {
   }
 
   /**
-   * <p>Encapsualtes the parameters for one error-correction block in one symbol version.
+   * <p>Encapsulates the parameters for one error-correction block in one symbol version.
    * This includes the number of data codewords, and the number of times a block with these
    * parameters is used consecutively in the QR code version's format.</p>
    */

File: core/src/main/java/com/google/zxing/pdf417/decoder/DetectionResultRowIndicatorColumn.java
Patch:
@@ -54,7 +54,7 @@ void adjustCompleteIndicatorColumnRowNumbers(BarcodeMetadata barcodeMetadata) {
     int lastRow = imageRowToCodewordIndex((int) bottom.getY());
     // We need to be careful using the average row height. Barcode could be skewed so that we have smaller and 
     // taller rows
-    float averageRowHeight = (lastRow - firstRow) / (float) barcodeMetadata.getRowCount();
+    //float averageRowHeight = (lastRow - firstRow) / (float) barcodeMetadata.getRowCount();
     int barcodeRow = -1;
     int maxRowHeight = 1;
     int currentRowHeight = 0;
@@ -139,7 +139,7 @@ private void adjustIncompleteIndicatorColumnRowNumbers(BarcodeMetadata barcodeMe
     ResultPoint bottom = isLeft ? boundingBox.getBottomLeft() : boundingBox.getBottomRight();
     int firstRow = imageRowToCodewordIndex((int) top.getY());
     int lastRow = imageRowToCodewordIndex((int) bottom.getY());
-    float averageRowHeight = (lastRow - firstRow) / (float) barcodeMetadata.getRowCount();
+    //float averageRowHeight = (lastRow - firstRow) / (float) barcodeMetadata.getRowCount();
     Codeword[] codewords = getCodewords();
     int barcodeRow = -1;
     int maxRowHeight = 1;

File: core/src/main/java/com/google/zxing/pdf417/decoder/ec/ModulusGF.java
Patch:
@@ -43,7 +43,7 @@ private ModulusGF(int modulus, int generator) {
       expTable[i] = x;
       x = (x * generator) % modulus;
     }
-    for (int i = 0; i < modulus - e1; i++) {
+    for (int i = 0; i < modulus - 1; i++) {
       logTable[expTable[i]] = i;
     }
     // logTable[0] == 0 but this should never be used

File: core/src/test/java/com/google/zxing/qrcode/encoder/MatrixUtilTestCase.java
Patch:
@@ -278,7 +278,7 @@ public void testCalculateBCHCode() {
     // From http://www.swetake.com/qr/qr11.html
     assertEquals(0x214, MatrixUtil.calculateBCHCode(0x1b, 0x537));
 
-    // Encofing of version information.
+    // Encoding of version information.
     // From Appendix D in JISX0510:2004 (p 68)
     assertEquals(0xc94, MatrixUtil.calculateBCHCode(7, 0x1f25));
     assertEquals(0x5bc, MatrixUtil.calculateBCHCode(8, 0x1f25));

File: zxingorg/src/main/java/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -279,7 +279,8 @@ protected void doPost(HttpServletRequest request, HttpServletResponse response)
       log.info("File upload was not multipart");
       errorResponse(request, response, "badimage");
     } else {
-      log.info("Decoding uploaded file " + fileUploadPart);
+      log.info("Decoding uploaded file " + fileUploadPart.getName() + " " +
+               fileUploadPart.getSubmittedFileName());
       try (InputStream is = fileUploadPart.getInputStream()) {
         processStream(is, request, response);
       }

File: core/src/main/java/com/google/zxing/oned/rss/AbstractRSSReader.java
Patch:
@@ -84,6 +84,8 @@ protected static int parseFinderValue(int[] counters,
   }
 
   /**
+   * @param array values to sum
+   * @return sum of values
    * @deprecated call {@link MathUtils#sum(int[])}
    */
   @Deprecated

File: core/src/main/java/com/google/zxing/pdf417/PDF417Common.java
Patch:
@@ -43,6 +43,8 @@ private PDF417Common() {
   }
 
   /**
+   * @param moduleBitCount values to sum
+   * @return sum of values
    * @deprecated call {@link MathUtils#sum(int[])}
    */
   @Deprecated

File: javase/src/main/java/com/google/zxing/client/j2se/ImageReader.java
Patch:
@@ -17,7 +17,6 @@
 package com.google.zxing.client.j2se;
 
 import javax.imageio.ImageIO;
-import javax.xml.bind.DatatypeConverter;
 import java.awt.image.BufferedImage;
 import java.io.ByteArrayInputStream;
 import java.io.IOException;
@@ -63,7 +62,7 @@ public static BufferedImage readDataURIImage(URI uri) throws IOException {
     }
     String base64DataEncoded = uriString.substring(base64Start + BASE64TOKEN.length());
     String base64Data = URLDecoder.decode(base64DataEncoded, "UTF-8");
-    byte[] imageBytes = DatatypeConverter.parseBase64Binary(base64Data);
+    byte[] imageBytes = Base64Decoder.getInstance().decode(base64Data);
     return ImageIO.read(new ByteArrayInputStream(imageBytes));
   }
 

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417.java
Patch:
@@ -659,7 +659,7 @@ public void generateBarcodeLogic(String msg, int errorCorrectionLevel) throws Wr
     //2. step: construct data codewords
     if (sourceCodeWords + errorCorrectionCodeWords + 1 > 929) { // +1 for symbol length CW
       throw new WriterException(
-          "Encoded message contains to many code words, message to big (" + msg.length() + " bytes)");
+          "Encoded message contains too many code words, message too big (" + msg.length() + " bytes)");
     }
     int n = sourceCodeWords + pad + 1;
     StringBuilder sb = new StringBuilder(n);

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417.java
Patch:
@@ -659,7 +659,7 @@ public void generateBarcodeLogic(String msg, int errorCorrectionLevel) throws Wr
     //2. step: construct data codewords
     if (sourceCodeWords + errorCorrectionCodeWords + 1 > 929) { // +1 for symbol length CW
       throw new WriterException(
-          "Encoded message contains to many code words, message to big (" + msg.length() + " bytes)");
+          "Encoded message contains too many code words, message too big (" + msg.length() + " bytes)");
     }
     int n = sourceCodeWords + pad + 1;
     StringBuilder sb = new StringBuilder(n);

File: javase/src/main/java/com/google/zxing/client/j2se/DecoderConfig.java
Patch:
@@ -21,7 +21,6 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.DecodeHintType;
 
-import java.net.URI;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Collections;
@@ -80,7 +79,7 @@ final class DecoderConfig {
   boolean help;
 
   @Parameter(description = "(URIs to decode)", required = true, variableArity = true)
-  List<URI> inputPaths;
+  List<String> inputPaths;
 
   Map<DecodeHintType,?> buildHints() {
     List<BarcodeFormat> finalPossibleFormats = possibleFormats;

File: android/src/com/google/zxing/client/android/book/SearchBookContentsActivity.java
Patch:
@@ -97,7 +97,7 @@ public void onCreate(Bundle icicle) {
     CookieManager.getInstance().removeExpiredCookie();
 
     Intent intent = getIntent();
-    if (intent == null || !intent.getAction().equals(Intents.SearchBookContents.ACTION)) {
+    if (intent == null || !Intents.SearchBookContents.ACTION.equals(intent.getAction())) {
       finish();
       return;
     }

File: android/src/com/google/zxing/client/android/encode/QRCodeEncoder.java
Patch:
@@ -74,9 +74,9 @@ final class QRCodeEncoder {
     this.dimension = dimension;
     this.useVCard = useVCard;
     String action = intent.getAction();
-    if (action.equals(Intents.Encode.ACTION)) {
+    if (Intents.Encode.ACTION.equals(action)) {
       encodeContentsFromZXingIntent(intent);
-    } else if (action.equals(Intent.ACTION_SEND)) {
+    } else if (Intent.ACTION_SEND.equals(action)) {
       encodeContentsFromShareIntent(intent);
     }
   }

File: android/src/com/google/zxing/client/android/result/AddressBookResultHandler.java
Patch:
@@ -21,6 +21,7 @@
 import com.google.zxing.client.result.ParsedResult;
 
 import android.app.Activity;
+import android.graphics.Typeface;
 import android.telephony.PhoneNumberUtils;
 import android.text.Spannable;
 import android.text.SpannableString;
@@ -205,7 +206,7 @@ public CharSequence getDisplayContents() {
     if (namesLength > 0) {
       // Bold the full name to make it stand out a bit.
       Spannable styled = new SpannableString(contents.toString());
-      styled.setSpan(new StyleSpan(android.graphics.Typeface.BOLD), 0, namesLength, 0);
+      styled.setSpan(new StyleSpan(Typeface.BOLD), 0, namesLength, 0);
       return styled;
     } else {
       return contents.toString();

File: androidtest/src/com/google/zxing/client/androidtest/BenchmarkItem.java
Patch:
@@ -53,7 +53,7 @@ void setFormat(BarcodeFormat format) {
   @Override
   public String toString() {
     StringBuilder result = new StringBuilder(30);
-    result.append(decoded ? "DECODED " + format.toString() + ": " : "FAILED: ");
+    result.append(decoded ? "DECODED " + format + ": " : "FAILED: ");
     result.append(path);
     result.append(" (");
     result.append(getAverageTime());

File: core/src/main/java/com/google/zxing/Reader.java
Patch:
@@ -24,7 +24,7 @@
  * decode a QR code. The decoder may optionally receive hints from the caller which may help
  * it decode more quickly or accurately.
  *
- * See {@link com.google.zxing.MultiFormatReader}, which attempts to determine what barcode
+ * See {@link MultiFormatReader}, which attempts to determine what barcode
  * format is present within the image as well, and then decodes it accordingly.
  *
  * @author Sean Owen
@@ -48,7 +48,7 @@ public interface Reader {
    * hints, each possibly associated to some data, which may help the implementation decode.
    *
    * @param image image of barcode to decode
-   * @param hints passed as a {@link java.util.Map} from {@link com.google.zxing.DecodeHintType}
+   * @param hints passed as a {@link java.util.Map} from {@link DecodeHintType}
    * to arbitrary data. The
    * meaning of the data depends upon the hint type. The implementation may or may not do
    * anything with these hints.

File: core/src/main/java/com/google/zxing/aztec/decoder/Decoder.java
Patch:
@@ -271,7 +271,7 @@ private boolean[] correctBits(boolean[] rawbits) throws FormatException {
   boolean[] extractBits(BitMatrix matrix) {
     boolean compact = ddata.isCompact();
     int layers = ddata.getNbLayers();
-    int baseMatrixSize = compact ? 11 + layers * 4 : 14 + layers * 4; // not including alignment lines
+    int baseMatrixSize = (compact ? 11 : 14) + layers * 4; // not including alignment lines
     int[] alignmentMap = new int[baseMatrixSize];
     boolean[] rawbits = new boolean[totalBitsInLayer(layers, compact)];
 
@@ -290,7 +290,7 @@ boolean[] extractBits(BitMatrix matrix) {
       }
     }
     for (int i = 0, rowOffset = 0; i < layers; i++) {
-      int rowSize = compact ? (layers - i) * 4 + 9 : (layers - i) * 4 + 12;
+      int rowSize = (layers - i) * 4 + (compact ? 9 : 12);
       // The top-left most point of this layer is <low, low> (not including alignment lines)
       int low = i * 2;
       // The bottom-right most point of this layer is <high, high> (not including alignment lines)

File: core/src/main/java/com/google/zxing/aztec/encoder/Encoder.java
Patch:
@@ -129,7 +129,7 @@ public static AztecCode encode(byte[] data, int minECCPercent, int userSpecified
     BitArray modeMessage = generateModeMessage(compact, layers, messageSizeInWords);
 
     // allocate symbol
-    int baseMatrixSize = compact ? 11 + layers * 4 : 14 + layers * 4; // not including alignment lines
+    int baseMatrixSize = (compact ? 11 : 14) + layers * 4; // not including alignment lines
     int[] alignmentMap = new int[baseMatrixSize];
     int matrixSize;
     if (compact) {
@@ -152,7 +152,7 @@ public static AztecCode encode(byte[] data, int minECCPercent, int userSpecified
     
     // draw data bits
     for (int i = 0, rowOffset = 0; i < layers; i++) {
-      int rowSize = compact ? (layers - i) * 4 + 9 : (layers - i) * 4 + 12;
+      int rowSize = (layers - i) * 4 + (compact ? 9 : 12);
       for (int j = 0; j < rowSize; j++) {
         int columnOffset = j * 2;
         for (int k = 0; k < 2; k++) {

File: core/src/main/java/com/google/zxing/common/BitArray.java
Patch:
@@ -307,7 +307,7 @@ public int[] getBitArray() {
   public void reverse() {
     int[] newBits = new int[bits.length];
     // reverse all int's first
-    int len = ((size-1) / 32);
+    int len = (size - 1) / 32;
     int oldBitsLen = len + 1;
     for (int i = 0; i < oldBitsLen; i++) {
       long x = (long) bits[i];

File: core/src/main/java/com/google/zxing/common/detector/MonochromeRectangleDetector.java
Patch:
@@ -128,7 +128,7 @@ private ResultPoint findCornerFromCenter(int centerX,
           if (lastRange[0] < centerX) {
             if (lastRange[1] > centerX) {
               // straddle, choose one or the other based on direction
-              return new ResultPoint(deltaY > 0 ? lastRange[0] : lastRange[1], lastY);
+              return new ResultPoint(lastRange[deltaY > 0 ? 0 : 1], lastY);
             }
             return new ResultPoint(lastRange[0], lastY);
           } else {
@@ -138,7 +138,7 @@ private ResultPoint findCornerFromCenter(int centerX,
           int lastX = x - deltaX;
           if (lastRange[0] < centerY) {
             if (lastRange[1] > centerY) {
-              return new ResultPoint(lastX, deltaX < 0 ? lastRange[0] : lastRange[1]);
+              return new ResultPoint(lastX, lastRange[deltaX < 0 ? 0 : 1]);
             }
             return new ResultPoint(lastX, lastRange[0]);
           } else {

File: core/src/main/java/com/google/zxing/datamatrix/encoder/DefaultPlacement.java
Patch:
@@ -60,7 +60,7 @@ public final boolean getBit(int col, int row) {
   }
 
   final void setBit(int col, int row, boolean bit) {
-    bits[row * numcols + col] = bit ? (byte) 1 : (byte) 0;
+    bits[row * numcols + col] = (byte) (bit ? 1 : 0);
   }
 
   final boolean hasBit(int col, int row) {

File: core/src/main/java/com/google/zxing/datamatrix/encoder/HighLevelEncoder.java
Patch:
@@ -128,7 +128,7 @@ public static byte[] getBytesForMessage(String msg) {
   private static char randomize253State(char ch, int codewordPosition) {
     int pseudoRandom = ((149 * codewordPosition) % 253) + 1;
     int tempVariable = ch + pseudoRandom;
-    return tempVariable <= 254 ? (char) tempVariable : (char) (tempVariable - 254);
+    return (char) (tempVariable <= 254 ? tempVariable : tempVariable - 254);
   }
 
   /**

File: core/src/main/java/com/google/zxing/multi/qrcode/QRCodeMultiReader.java
Patch:
@@ -166,8 +166,8 @@ private static List<Result> processStructuredAppend(List<Result> results) {
   private static final class SAComparator implements Comparator<Result>, Serializable {
     @Override
     public int compare(Result a, Result b) {
-      int aNumber = (int) (a.getResultMetadata().get(ResultMetadataType.STRUCTURED_APPEND_SEQUENCE));
-      int bNumber = (int) (b.getResultMetadata().get(ResultMetadataType.STRUCTURED_APPEND_SEQUENCE));
+      int aNumber = (int) a.getResultMetadata().get(ResultMetadataType.STRUCTURED_APPEND_SEQUENCE);
+      int bNumber = (int) b.getResultMetadata().get(ResultMetadataType.STRUCTURED_APPEND_SEQUENCE);
       if (aNumber < bNumber) {
         return -1;
       }

File: core/src/main/java/com/google/zxing/qrcode/detector/AlignmentPatternFinder.java
Patch:
@@ -110,7 +110,7 @@ AlignmentPattern find() throws NotFoundException {
         if (image.get(j, i)) {
           // Black pixel
           if (currentState == 1) { // Counting black pixels
-            stateCount[currentState]++;
+            stateCount[1]++;
           } else { // Counting white pixels
             if (currentState == 2) { // A winner?
               if (foundPatternCross(stateCount)) { // Yes

File: core/src/test/java/com/google/zxing/client/result/GeoParsedResultTestCase.java
Patch:
@@ -22,7 +22,7 @@
 import org.junit.Test;
 
 /**
- * Tests {@link com.google.zxing.client.result.GeoParsedResult}.
+ * Tests {@link GeoParsedResult}.
  *
  * @author Sean Owen
  */

File: core/src/test/java/com/google/zxing/qrcode/decoder/DecodedBitStreamParserTestCase.java
Patch:
@@ -21,7 +21,7 @@
 import org.junit.Test;
 
 /**
- * Tests {@link com.google.zxing.qrcode.decoder.DecodedBitStreamParser}.
+ * Tests {@link DecodedBitStreamParser}.
  *
  * @author Sean Owen
  */

File: javase/src/main/java/com/google/zxing/client/j2se/CommandLineEncoder.java
Patch:
@@ -23,7 +23,7 @@
 import com.beust.jcommander.JCommander;
 
 import java.nio.file.Paths;
-import java.util.HashMap;
+import java.util.EnumMap;
 import java.util.Locale;
 import java.util.Map;
 
@@ -50,7 +50,7 @@ public static void main(String[] args) throws Exception {
     if (EncoderConfig.DEFAULT_OUTPUT_FILE_BASE.equals(outFileString)) {
       outFileString += '.' + config.imageFormat.toLowerCase(Locale.ENGLISH);
     }
-    Map<EncodeHintType, Object> hints = new HashMap<>();
+    Map<EncodeHintType, Object> hints = new EnumMap<>(EncodeHintType.class);
     if (config.errorCorrectionLevel != null) {
       hints.put(EncodeHintType.ERROR_CORRECTION, config.errorCorrectionLevel);
     }

File: javase/src/main/java/com/google/zxing/client/j2se/CommandLineRunner.java
Patch:
@@ -19,7 +19,6 @@
 import com.beust.jcommander.JCommander;
 import java.io.IOException;
 import java.net.URI;
-import java.net.URISyntaxException;
 import java.nio.file.DirectoryStream;
 import java.nio.file.Files;
 import java.nio.file.Path;
@@ -90,7 +89,7 @@ public static void main(String[] args) throws Exception {
     }
   }
 
-  private static List<URI> expand(List<URI> inputs) throws IOException, URISyntaxException {
+  private static List<URI> expand(List<URI> inputs) throws IOException {
     List<URI> expanded = new ArrayList<>();
     for (URI input : inputs) {
       if (isFileOrDir(input)) {
@@ -111,7 +110,7 @@ private static List<URI> expand(List<URI> inputs) throws IOException, URISyntaxE
     for (int i = 0; i < expanded.size(); i++) {
       URI input = expanded.get(i);
       if (input.getScheme() == null) {
-        expanded.set(i, new URI("file", input.getSchemeSpecificPart(), input.getFragment()));
+        expanded.set(i, Paths.get(input.getRawPath()).toUri());
       }
     }
     return expanded;

File: zxing.appspot.com/src/main/java/com/google/zxing/web/generator/client/Validators.java
Patch:
@@ -54,7 +54,7 @@ private static boolean isBasicallyValidURI(String uri) {
   
   static void validateEmail(String email) throws GeneratorException {
     //FIXME: we can have a better check for email here.
-    if (!email.matches("^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,6}$")) {
+    if (!email.matches("^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$")) {
       throw new GeneratorException("Email is not valid.");
     }
   }

File: core/src/main/java/com/google/zxing/oned/ITFWriter.java
Patch:
@@ -50,7 +50,7 @@ public BitMatrix encode(String contents,
   public boolean[] encode(String contents) {
     int length = contents.length();
     if (length % 2 != 0) {
-      throw new IllegalArgumentException("The lenght of the input should be even");
+      throw new IllegalArgumentException("The length of the input should be even");
     }
     if (length > 80) {
       throw new IllegalArgumentException(
@@ -73,4 +73,4 @@ public boolean[] encode(String contents) {
     return result;
   }
 
-}
\ No newline at end of file
+}

File: core/src/main/java/com/google/zxing/oned/Code39Writer.java
Patch:
@@ -63,7 +63,7 @@ public boolean[] encode(String contents) {
       }
     }
     boolean[] result = new boolean[codeWidth];
-    toIntArray(Code39Reader.CHARACTER_ENCODINGS[39], widths);
+    toIntArray(Code39Reader.ASTERISK_ENCODING, widths);
     int pos = appendPattern(result, 0, widths, true);
     int[] narrowWhite = {1};
     pos += appendPattern(result, pos, narrowWhite, false);
@@ -74,7 +74,7 @@ public boolean[] encode(String contents) {
       pos += appendPattern(result, pos, widths, true);
       pos += appendPattern(result, pos, narrowWhite, false);
     }
-    toIntArray(Code39Reader.CHARACTER_ENCODINGS[39], widths);
+    toIntArray(Code39Reader.ASTERISK_ENCODING, widths);
     appendPattern(result, pos, widths, true);
     return result;
   }

File: core/src/test/java/com/google/zxing/BufferedImageLuminanceSource.java
Patch:
@@ -68,7 +68,9 @@ public BufferedImageLuminanceSource(BufferedImage image, int left, int top, int
             pixel = 0xFFFFFFFF; // = white
           }
 
-          // .229R + 0.587G + 0.114B (YUV/YIQ for PAL and NTSC)
+          // .299R + 0.587G + 0.114B (YUV/YIQ for PAL and NTSC), 
+          // (306*R) >> 10 is approximately equal to R*0.299, and so on.
+          // 0x200 >> 10 is 0.5, it implements rounding.
           buffer[x] =
               (306 * ((pixel >> 16) & 0xFF) +
                601 * ((pixel >> 8) & 0xFF) +

File: javase/src/main/java/com/google/zxing/client/j2se/BufferedImageLuminanceSource.java
Patch:
@@ -70,12 +70,12 @@ public BufferedImageLuminanceSource(BufferedImage image, int left, int top, int
             pixel = 0xFFFFFFFF; // = white
           }
 
-          // .229R + 0.587G + 0.114B (YUV/YIQ for PAL and NTSC)
+          // .299R + 0.587G + 0.114B (YUV/YIQ for PAL and NTSC)
           buffer[x] =
               (306 * ((pixel >> 16) & 0xFF) +
                601 * ((pixel >> 8) & 0xFF) +
-               117 * (pixel & 0xFF) +
-               0x200) >> 10;
+               117 * (pixel & 0xFF) 
+               ) >> 10;
         }
         raster.setPixels(left, y, width, 1, buffer);
       }

File: android/src/com/google/zxing/client/android/share/BookmarkAdapter.java
Patch:
@@ -46,7 +46,7 @@ final class BookmarkAdapter extends BaseAdapter {
 
   @Override
   public int getCount() {
-    return cursor.getCount();
+    return cursor.isClosed() ? 0 : cursor.getCount();
   }
 
   @Override

File: core/src/main/java/com/google/zxing/pdf417/decoder/DetectionResultRowIndicatorColumn.java
Patch:
@@ -122,7 +122,8 @@ int[] getRowHeights() throws FormatException {
       if (codeword != null) {
         int rowNumber = codeword.getRowNumber();
         if (rowNumber >= result.length) {
-          throw FormatException.getFormatInstance();
+          // We have more rows than the barcode metadata allows for, ignore them.
+          continue;
         }
         result[rowNumber]++;
       } // else throw exception?

File: core/src/main/java/com/google/zxing/pdf417/decoder/PDF417ScanningDecoder.java
Patch:
@@ -343,7 +343,8 @@ private static BarcodeValue[][] createBarcodeMatrix(DetectionResult detectionRes
             int rowNumber = codeword.getRowNumber();
             if (rowNumber >= 0) {
               if (rowNumber >= barcodeMatrix.length) {
-                throw FormatException.getFormatInstance();
+                // We have more rows than the barcode metadata allows for, ignore them.
+                continue;
               }
               barcodeMatrix[rowNumber][column].setValue(codeword.getValue());
             }

File: core/src/test/java/com/google/zxing/pdf417/PDF417BlackBox1TestCase.java
Patch:
@@ -29,8 +29,8 @@ public final class PDF417BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox1TestCase() {
     super("src/test/resources/blackbox/pdf417-1", new MultiFormatReader(), BarcodeFormat.PDF_417);
-    addTest(9, 9, 0.0f);
-    addTest(9, 9, 180.0f);
+    addTest(10, 10, 0.0f);
+    addTest(10, 10, 180.0f);
   }
 
 }
\ No newline at end of file

File: core/src/main/java/com/google/zxing/EncodeHintType.java
Patch:
@@ -27,7 +27,8 @@ public enum EncodeHintType {
    * Specifies what degree of error correction to use, for example in QR Codes.
    * Type depends on the encoder. For example for QR codes it's type
    * {@link com.google.zxing.qrcode.decoder.ErrorCorrectionLevel ErrorCorrectionLevel}.
-   * For Aztec it is of type {@link Integer}, representing the minimal percentage of error correction words. 
+   * For Aztec it is of type {@link Integer}, representing the minimal percentage of error correction words.
+   * For PDF417 it is of type {@link Integer}, valid values being 0 to 8.
    * Note: an Aztec symbol should have a minimum of 25% EC words.
    */
   ERROR_CORRECTION,

File: core/src/main/java/com/google/zxing/EncodeHintType.java
Patch:
@@ -27,7 +27,8 @@ public enum EncodeHintType {
    * Specifies what degree of error correction to use, for example in QR Codes.
    * Type depends on the encoder. For example for QR codes it's type
    * {@link com.google.zxing.qrcode.decoder.ErrorCorrectionLevel ErrorCorrectionLevel}.
-   * For Aztec it is of type {@link Integer}, representing the minimal percentage of error correction words. 
+   * For Aztec it is of type {@link Integer}, representing the minimal percentage of error correction words.
+   * For PDF417 it is of type {@link Integer}, valid values being 0 to 8.
    * Note: an Aztec symbol should have a minimum of 25% EC words.
    */
   ERROR_CORRECTION,

File: zxing.appspot.com/src/main/java/com/google/zxing/web/generator/client/Generator.java
Patch:
@@ -197,7 +197,7 @@ private static void setGridStyle(HTMLTable grid) {
 
   private static String getUrl(int sizeX, int sizeY, String ecLevel, String encoding, String content) {
     StringBuilder result = new StringBuilder(100);
-    result.append("http://zxing.org/w/chart?cht=qr");
+    result.append("https://zxing.org/w/chart?cht=qr");
     result.append("&chs=").append(sizeX).append('x').append(sizeY);
     result.append("&chld=").append(ecLevel);
     result.append("&choe=").append(encoding);

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417HighLevelEncoder.java
Patch:
@@ -215,7 +215,7 @@ static String encodeHighLevel(String msg, Compaction compaction, Charset encodin
             if (b == 0) {
               b = 1;
             }
-            byte[] bytes = msg.substring(p, b).getBytes(encoding);
+            byte[] bytes = msg.substring(p, p + b).getBytes(encoding);
             if (bytes.length == 1 && encodingMode == TEXT_COMPACTION) {
               //Switch for one byte (instead of latch)
               encodeBinary(bytes, 0, 1, TEXT_COMPACTION, sb);

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417HighLevelEncoder.java
Patch:
@@ -215,7 +215,7 @@ static String encodeHighLevel(String msg, Compaction compaction, Charset encodin
             if (b == 0) {
               b = 1;
             }
-            byte[] bytes = msg.substring(p, b).getBytes(encoding);
+            byte[] bytes = msg.substring(p, p + b).getBytes(encoding);
             if (bytes.length == 1 && encodingMode == TEXT_COMPACTION) {
               //Switch for one byte (instead of latch)
               encodeBinary(bytes, 0, 1, TEXT_COMPACTION, sb);

File: core/src/test/java/com/google/zxing/aztec/decoder/DecoderTest.java
Patch:
@@ -33,6 +33,7 @@ public final class DecoderTest {
    *	at com.google.zxing.aztec.decoder.Decoder.correctBits(Decoder.java:231)
    *	at com.google.zxing.aztec.decoder.Decoder.decode(Decoder.java:77)
    *	at com.google.zxing.aztec.decoder.DecoderTest.testDecodeBug1(DecoderTest.java:66)</pre>
+   * @throws FormatException
    */
   @Test(expected = FormatException.class)
   public void testDecodeTooManyErrors() throws FormatException {

File: android/src/com/google/zxing/client/android/result/supplement/TitleRetriever.java
Patch:
@@ -16,6 +16,7 @@
 
 package com.google.zxing.client.android.result.supplement;
 
+import android.text.Html;
 import android.widget.TextView;
 import com.google.zxing.client.android.HttpHelper;
 import com.google.zxing.client.android.history.HistoryManager;
@@ -56,6 +57,7 @@ void retrieveSupplementalInfo() {
       if (m.find()) {
         String title = m.group(1);
         if (title != null && !title.isEmpty()) {
+          title = Html.fromHtml(title).toString();
           if (title.length() > MAX_TITLE_LEN) {
             title = title.substring(0, MAX_TITLE_LEN) + "...";
           }

File: android/src/com/google/zxing/client/android/result/supplement/TitleRetriever.java
Patch:
@@ -16,6 +16,7 @@
 
 package com.google.zxing.client.android.result.supplement;
 
+import android.text.Html;
 import android.widget.TextView;
 import com.google.zxing.client.android.HttpHelper;
 import com.google.zxing.client.android.history.HistoryManager;
@@ -56,6 +57,7 @@ void retrieveSupplementalInfo() {
       if (m.find()) {
         String title = m.group(1);
         if (title != null && !title.isEmpty()) {
+          title = Html.fromHtml(title).toString();
           if (title.length() > MAX_TITLE_LEN) {
             title = title.substring(0, MAX_TITLE_LEN) + "...";
           }

File: core/src/main/java/com/google/zxing/ChecksumException.java
Patch:
@@ -35,10 +35,10 @@ private ChecksumException(Throwable cause) {
   }
 
   public static ChecksumException getChecksumInstance() {
-    return IS_STACK_TRACE ? new ChecksumException() : INSTANCE;
+    return isStackTrace ? new ChecksumException() : INSTANCE;
   }
 
   public static ChecksumException getChecksumInstance(Throwable cause) {
-    return IS_STACK_TRACE ? new ChecksumException(cause) : INSTANCE;
+    return isStackTrace ? new ChecksumException(cause) : INSTANCE;
   }
 }
\ No newline at end of file

File: core/src/main/java/com/google/zxing/FormatException.java
Patch:
@@ -35,10 +35,10 @@ private FormatException(Throwable cause) {
   }
 
   public static FormatException getFormatInstance() {
-    return IS_STACK_TRACE ? new FormatException() : INSTANCE;
+    return isStackTrace ? new FormatException() : INSTANCE;
   }
   
   public static FormatException getFormatInstance(Throwable cause) {
-    return IS_STACK_TRACE ? new FormatException(cause) : INSTANCE;
+    return isStackTrace ? new FormatException(cause) : INSTANCE;
   }
 }
\ No newline at end of file

File: core/src/main/java/com/google/zxing/ReaderException.java
Patch:
@@ -26,7 +26,7 @@
 public abstract class ReaderException extends Exception {
 
   // disable stack traces when not running inside test units
-  protected static final boolean IS_STACK_TRACE =
+  protected static final boolean isStackTrace =
       System.getProperty("surefire.test.class.path") != null;
 
   ReaderException() {

File: core/src/main/java/com/google/zxing/common/BitMatrix.java
Patch:
@@ -426,6 +426,7 @@ public String toString(String setString, String unsetString) {
    * @param setString representation of a set bit
    * @param unsetString representation of an unset bit
    * @param lineSeparator newline character in string representation
+   * @return string representation of entire matrix utilizing given strings and line separator
    * @deprecated call {@link #toString(String,String)} only, which uses \n line separator always
    */
   @Deprecated

File: core/src/main/java/com/google/zxing/NotFoundException.java
Patch:
@@ -24,14 +24,14 @@
  */
 public final class NotFoundException extends ReaderException {
 
-  private static final NotFoundException instance = new NotFoundException();
+  private static final NotFoundException INSTANCE = new NotFoundException();
 
   private NotFoundException() {
     // do nothing
   }
 
   public static NotFoundException getNotFoundInstance() {
-    return instance;
+    return INSTANCE;
   }
 
 }
\ No newline at end of file

File: core/src/main/java/com/google/zxing/ReaderException.java
Patch:
@@ -26,7 +26,8 @@
 public abstract class ReaderException extends Exception {
 
   // disable stack traces when not running inside test units
-  protected static final boolean isStackTrace = System.getProperty("surefire.test.class.path") != null;
+  protected static final boolean IS_STACK_TRACE =
+      System.getProperty("surefire.test.class.path") != null;
 
   ReaderException() {
     // do nothing

File: core/src/main/java/com/google/zxing/oned/ITFReader.java
Patch:
@@ -294,9 +294,6 @@ int[] decodeEnd(BitArray row) throws NotFoundException {
   private static int[] findGuardPattern(BitArray row,
                                         int rowOffset,
                                         int[] pattern) throws NotFoundException {
-
-    // TODO: This is very similar to implementation in UPCEANReader. Consider if they can be
-    // merged to a single method.
     int patternLength = pattern.length;
     int[] counters = new int[patternLength];
     int width = row.getSize();

File: core/src/main/java/com/google/zxing/pdf417/decoder/BoundingBox.java
Patch:
@@ -88,7 +88,6 @@ BoundingBox addMissingRows(int missingStartRows, int missingEndRows, boolean isL
       if (newMinY < 0) {
         newMinY = 0;
       }
-      // TODO use existing points to better interpolate the new x positions
       ResultPoint newTop = new ResultPoint(top.getX(), newMinY);
       if (isLeft) {
         newTopLeft = newTop;
@@ -103,7 +102,6 @@ BoundingBox addMissingRows(int missingStartRows, int missingEndRows, boolean isL
       if (newMaxY >= image.getHeight()) {
         newMaxY = image.getHeight() - 1;
       }
-      // TODO use existing points to better interpolate the new x positions
       ResultPoint newBottom = new ResultPoint(bottom.getX(), newMaxY);
       if (isLeft) {
         newBottomLeft = newBottom;

File: core/src/main/java/com/google/zxing/qrcode/detector/Detector.java
Patch:
@@ -261,7 +261,7 @@ private float calculateModuleSizeOneWay(ResultPoint pattern, ResultPoint otherPa
   /**
    * See {@link #sizeOfBlackWhiteBlackRun(int, int, int, int)}; computes the total width of
    * a finder pattern by looking for a black-white-black run from the center in the direction
-   * of another point (another finder pattern center), and in the opposite direction too.</p>
+   * of another point (another finder pattern center), and in the opposite direction too.
    */
   private float sizeOfBlackWhiteBlackRunBothWays(int fromX, int fromY, int toX, int toY) {
 

File: zxing.appspot.com/src/main/java/com/google/zxing/web/generator/client/CalendarEventGenerator.java
Patch:
@@ -118,7 +118,7 @@ public Object getSource() {
 
   private void buildTimeZoneList() {
     for (TimeZoneInfo info : TimeZoneList.TIMEZONES) {
-      timeZones.addItem(info.getGMTRelative() + ' ' + info.getAbreviation(),
+      timeZones.addItem(info.getGmtRelative() + ' ' + info.getAbbreviation(),
                         String.valueOf(info.getGmtDiff()));
     }
   }

File: core/src/main/java/com/google/zxing/aztec/encoder/Encoder.java
Patch:
@@ -311,7 +311,7 @@ private static GenericGF getGF(int wordSize) {
       case 12:
         return GenericGF.AZTEC_DATA_12;
       default:
-        return null;
+        throw new IllegalArgumentException("Unsupported word size " + wordSize);
     }
   }
 

File: core/src/test/java/com/google/zxing/common/reedsolomon/ReedSolomonTestCase.java
Patch:
@@ -19,7 +19,6 @@
 import org.junit.Assert;
 import org.junit.Test;
 
-import java.security.SecureRandom;
 import java.util.Arrays;
 import java.util.BitSet;
 import java.util.Random;

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -296,7 +296,7 @@ protected void onPause() {
     ambientLightManager.stop();
     beepManager.close();
     cameraManager.closeDriver();
-    historyManager = null;
+    //historyManager = null; // Keep for onActivityResult
     if (!hasSurface) {
       SurfaceView surfaceView = (SurfaceView) findViewById(R.id.preview_view);
       SurfaceHolder surfaceHolder = surfaceView.getHolder();

File: core/src/main/java/com/google/zxing/datamatrix/encoder/X12Encoder.java
Patch:
@@ -73,10 +73,11 @@ void handleEOD(EncoderContext context, StringBuilder buffer) {
     int available = context.getSymbolInfo().getDataCapacity() - context.getCodewordCount();
     int count = buffer.length();
     context.pos -= count;
-    if (context.getRemainingCharacters() != 1 || available != 1) {
+    if (context.getRemainingCharacters() > 1 || available > 1 ||
+        context.getRemainingCharacters() != available) {
       context.writeCodeword(HighLevelEncoder.X12_UNLATCH);
     }
-    if (count > 0) {
+    if (context.getNewEncoding() < 0) {
       context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
     }
   }

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -198,6 +198,8 @@ protected void onResume() {
         && (intent == null || intent.getBooleanExtra(Intents.Scan.SAVE_HISTORY, true));
 
     source = IntentSource.NONE;
+    sourceUrl = null;
+    scanFromWebPageManager = null;
     decodeFormats = null;
     characterSet = null;
 
@@ -681,6 +683,7 @@ private void handleDecodeExternally(Result rawResult, ResultHandler resultHandle
 
       if (scanFromWebPageManager != null && scanFromWebPageManager.isScanFromWebPage()) {
         String replyURL = scanFromWebPageManager.buildReplyURL(rawResult, resultHandler);
+        scanFromWebPageManager = null;
         sendReplyMessage(R.id.launch_product_query, replyURL, resultDurationMS);
       }
       

File: android/src/com/google/zxing/client/android/camera/open/OpenCameraInterface.java
Patch:
@@ -26,7 +26,7 @@ public final class OpenCameraInterface {
   private OpenCameraInterface() {
   }
 
-  /** For {@link #open(int), means no preference for which camera to open. */
+  /** For {@link #open(int)}, means no preference for which camera to open. */
   public static final int NO_REQUESTED_CAMERA = -1;
 
   /**

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417HighLevelEncoder.java
Patch:
@@ -421,7 +421,7 @@ private static void encodeNumeric(String msg, int startpos, int count, StringBui
     StringBuilder tmp = new StringBuilder(count / 3 + 1);
     BigInteger num900 = BigInteger.valueOf(900);
     BigInteger num0 = BigInteger.valueOf(0);
-    while (idx < count - 1) {
+    while (idx < count) {
       tmp.setLength(0);
       int len = Math.min(44, count - idx);
       String part = '1' + msg.substring(startpos + idx, startpos + idx + len);

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417HighLevelEncoder.java
Patch:
@@ -421,7 +421,7 @@ private static void encodeNumeric(String msg, int startpos, int count, StringBui
     StringBuilder tmp = new StringBuilder(count / 3 + 1);
     BigInteger num900 = BigInteger.valueOf(900);
     BigInteger num0 = BigInteger.valueOf(0);
-    while (idx < count - 1) {
+    while (idx < count) {
       tmp.setLength(0);
       int len = Math.min(44, count - idx);
       String part = '1' + msg.substring(startpos + idx, startpos + idx + len);

File: core/src/main/java/com/google/zxing/datamatrix/DataMatrixWriter.java
Patch:
@@ -67,12 +67,12 @@ public BitMatrix encode(String contents, BarcodeFormat format, int width, int he
       if (requestedShape != null) {
         shape = requestedShape;
       }
-      @SuppressWarnings("deprecated")
+      @SuppressWarnings("deprecation")
       Dimension requestedMinSize = (Dimension) hints.get(EncodeHintType.MIN_SIZE);
       if (requestedMinSize != null) {
         minSize = requestedMinSize;
       }
-      @SuppressWarnings("deprecated")
+      @SuppressWarnings("deprecation")
       Dimension requestedMaxSize = (Dimension) hints.get(EncodeHintType.MAX_SIZE);
       if (requestedMaxSize != null) {
         maxSize = requestedMaxSize;

File: zxing.appspot.com/src/main/java/com/google/zxing/web/generator/client/ContactInfoGenerator.java
Patch:
@@ -125,7 +125,7 @@ private static String buildAddress(String address, String address2) {
   }
 
   private static void maybeAppendMECARD(StringBuilder output, String prefix, String value) {
-    if (!value.isEmpty()) {
+    if (value != null && !value.isEmpty()) {
       value = value.replaceAll("([\\\\:;])", "\\\\$1");
       value = value.replaceAll("\\n", "");
       output.append(prefix).append(':').append(value).append(';');

File: core/src/main/java/com/google/zxing/datamatrix/decoder/DataBlock.java
Patch:
@@ -94,8 +94,9 @@ static DataBlock[] getDataBlocks(byte[] rawCodewords,
     int max = result[0].codewords.length;
     for (int i = longerBlocksNumDataCodewords; i < max; i++) {
       for (int j = 0; j < numResultBlocks; j++) {
-        int iOffset = specialVersion && j > 7 ? i - 1 : i;
-        result[j].codewords[iOffset] = rawCodewords[rawCodewordsOffset++];
+        int jOffset = specialVersion ? (j + 8) % numResultBlocks : j;
+        int iOffset = specialVersion && jOffset > 7 ? i - 1 : i;
+        result[jOffset].codewords[iOffset] = rawCodewords[rawCodewordsOffset++];
       }
     }
 

File: core/src/main/java/com/google/zxing/ReaderException.java
Patch:
@@ -33,7 +33,7 @@ public abstract class ReaderException extends Exception {
   }
 
   ReaderException(Throwable cause) {
-      super(cause);
+    super(cause);
   }
 
   // Prevent stack traces from being taken

File: core/src/test/java/com/google/zxing/common/BitArrayTestCase.java
Patch:
@@ -101,7 +101,7 @@ public void testGetNextSet4() {
   
   @Test
   public void testGetNextSet5() {
-    Random r = new SecureRandom(new byte[] {(byte) 0xDE, (byte) 0xAD, (byte) 0xBE, (byte) 0xEF});
+    Random r = new Random(0xDEADBEEF);
     for (int i = 0; i < 10; i++) {
       BitArray array = new BitArray(1 + r.nextInt(100));
       int numSet = r.nextInt(20);

File: core/src/test/java/com/google/zxing/common/reedsolomon/ReedSolomonTestCase.java
Patch:
@@ -501,7 +501,7 @@ private static String arrayToString(int[] data) {
   }
 
   private static Random getPseudoRandom() {
-    return new SecureRandom(new byte[] {(byte) 0xDE, (byte) 0xAD, (byte) 0xBE, (byte) 0xEF});
+    return new Random(0xDEADBEEF);
   }
 
 }
\ No newline at end of file

File: core/src/test/java/com/google/zxing/pdf417/decoder/ec/AbstractErrorCorrectionTestCase.java
Patch:
@@ -49,7 +49,7 @@ static int[] erase(int[] received, int howMany, Random random) {
   }
 
   static Random getRandom() {
-    return new Random(0);
+    return new Random(0xDEADBEEF);
   }
 
 }
\ No newline at end of file

File: core/src/main/java/com/google/zxing/aztec/decoder/Decoder.java
Patch:
@@ -229,8 +229,8 @@ private boolean[] correctBits(boolean[] rawbits) throws FormatException {
     try {
       ReedSolomonDecoder rsDecoder = new ReedSolomonDecoder(gf);
       rsDecoder.decode(dataWords, numECCodewords);
-    } catch (ReedSolomonException ignored) {
-      throw FormatException.getFormatInstance();
+    } catch (ReedSolomonException ex) {
+      throw FormatException.getFormatInstance(ex);
     }
 
     // Now perform the unstuffing operation.

File: core/src/test/java/com/google/zxing/common/reedsolomon/ReedSolomonTestCase.java
Patch:
@@ -394,7 +394,7 @@ public void testAztec() {
     testEncodeDecodeRandom(GenericGF.AZTEC_DATA_12, 3072, 1023);
   }
 
-  private static void corrupt(int[] received, int howMany, Random random, int max) {
+  public static void corrupt(int[] received, int howMany, Random random, int max) {
     BitSet corrupted = new BitSet(received.length);
     for (int j = 0; j < howMany; j++) {
       int location = random.nextInt(received.length);

File: zxingorg/src/main/java/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -83,7 +83,7 @@
     maxFileSize = 10_000_000,
     maxRequestSize = 10_000_000,
     fileSizeThreshold = 1_000_000,
-    location = "/tmp/DecodeServlet")
+    location = "/tmp")
 @WebServlet("/w/decode")
 public final class DecodeServlet extends HttpServlet {
 

File: zxingorg/src/main/java/com/google/zxing/web/RedirectFilter.java
Patch:
@@ -45,9 +45,8 @@ public void doFilter(ServletRequest servletRequest,
                        FilterChain filterChain) throws IOException, ServletException {
     HttpServletRequest request = (HttpServletRequest) servletRequest;
     String requestURI = request.getRequestURI();
-    if ("/index.jspx".equals(requestURI) ||
-        "/w/".equals(requestURI) ||
-        "/w/index.jspx".equals(requestURI)) {
+    if ("/".equals(requestURI) || "/index.jspx".equals(requestURI) ||
+        "/w/".equals(requestURI) || "/w/index.jspx".equals(requestURI)) {
       redirect(servletResponse, "/w/decode.jspx");
     } else if (requestURI.startsWith(OLD_JAVADOC_PREFIX)) {
       String withoutPrefix = requestURI.substring(OLD_JAVADOC_PREFIX.length());

File: core/src/main/java/com/google/zxing/client/result/EmailAddressParsedResult.java
Patch:
@@ -74,6 +74,7 @@ public String getBody() {
   }
 
   /**
+   * @return "mailto:"
    * @deprecated without replacement
    */
   @Deprecated

File: core/src/test/java/com/google/zxing/common/StringUtilsTestCase.java
Patch:
@@ -53,7 +53,9 @@ private static void doTest(byte[] bytes, String charsetName) {
   /**
    * Utility for printing out a string in given encoding as a Java statement, since it's better
    * to write that into the Java source file rather than risk character encoding issues in the 
-   * source file itself
+   * source file itself.
+   *
+   * @param args command line arguments
    */
   public static void main(String[] args) {
     String text = args[0];

File: android/src/com/google/zxing/client/android/result/AddressBookResultHandler.java
Patch:
@@ -146,7 +146,7 @@ public void handleButtonPress(int index) {
         dialPhone(addressResult.getPhoneNumbers()[0]);
         break;
       case 3:
-        sendEmail(addressResult.getEmails()[0], null, null);
+        sendEmail(addressResult.getEmails(), null, null, null, null);
         break;
       default:
         break;

File: android-integration/src/main/java/com/google/zxing/integration/android/IntentIntegrator.java
Patch:
@@ -308,7 +308,7 @@ public final AlertDialog initiateScan(Collection<String> desiredBarcodeFormats,
       }
       intentScan.putExtra("SCAN_FORMATS", joinedByComma.toString());
     }
-	
+
     // check requested camera ID
     if (cameraId >= 0) {
       intentScan.putExtra("SCAN_CAMERA_ID", cameraId);

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -218,7 +218,7 @@ protected void onResume() {
             cameraManager.setManualFramingRect(width, height);
           }
         }
-		
+
         if (intent.hasExtra(Intents.Scan.CAMERA_ID)) {
           int cameraId = intent.getIntExtra(Intents.Scan.CAMERA_ID, -1);
           if (cameraId >= 0) {

File: android/src/com/google/zxing/client/android/Intents.java
Patch:
@@ -80,7 +80,7 @@ public static final class Scan {
      * Example: "EAN_13,EAN_8,QR_CODE". This overrides {@link #MODE}.
      */
     public static final String FORMATS = "SCAN_FORMATS";
-	
+
     /**
      * Optional parameter to specify the id of the camera from which to recognize barcodes.
      * Overrides the default camera that would otherwise would have been selected.

File: android/src/com/google/zxing/client/android/camera/CameraManager.java
Patch:
@@ -76,7 +76,7 @@ public CameraManager(Context context) {
   public synchronized void openDriver(SurfaceHolder holder) throws IOException {
     Camera theCamera = camera;
     if (theCamera == null) {
-	  
+
       if (requestedCameraId >= 0) {
         theCamera = OpenCameraInterface.open(requestedCameraId);
       } else {

File: android/src/com/google/zxing/client/android/camera/open/OpenCameraInterface.java
Patch:
@@ -40,9 +40,9 @@ public static Camera open(int cameraId) {
       Log.w(TAG, "No cameras!");
       return null;
     }
-	  
+
     boolean explicitRequest = cameraId >= 0;
-	  
+
     if (!explicitRequest) {
       // Select a camera if no explicit camera requested
       int index = 0;
@@ -57,7 +57,7 @@ public static Camera open(int cameraId) {
       
       cameraId = index;
     }
-	  
+
     Camera camera;
     if (cameraId < numCameras) {
       Log.i(TAG, "Opening camera #" + cameraId);

File: core/src/main/java/com/google/zxing/ResultPoint.java
Patch:
@@ -71,7 +71,7 @@ public final String toString() {
    * Orders an array of three ResultPoints in an order [A,B,C] such that AB is less than AC
    * and BC is less than AC, and the angle between BC and BA is less than 180 degrees.
    *
-   * @param patterns array of three {@link ResultPoint} to order
+   * @param patterns array of three {@code ResultPoint} to order
    */
   public static void orderBestPatterns(ResultPoint[] patterns) {
 

File: core/src/main/java/com/google/zxing/common/CharacterSetECI.java
Patch:
@@ -95,7 +95,7 @@ public int getValue() {
 
   /**
    * @param value character set ECI value
-   * @return {@link CharacterSetECI} representing ECI of given value, or null if it is legal but
+   * @return {@code CharacterSetECI} representing ECI of given value, or null if it is legal but
    *   unsupported
    * @throws FormatException if ECI value is invalid
    */

File: core/src/main/java/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -110,9 +110,11 @@ static DecoderResult decode(int[] codewords, String ecLevel) throws FormatExcept
           break;
         case BYTE_COMPACTION_MODE_LATCH:
         case BYTE_COMPACTION_MODE_LATCH_6:
-        case MODE_SHIFT_TO_BYTE_COMPACTION_MODE:
           codeIndex = byteCompaction(code, codewords, encoding, codeIndex, result);
           break;
+        case MODE_SHIFT_TO_BYTE_COMPACTION_MODE:
+          result.append((char) codewords[codeIndex++]);
+          break;
         case NUMERIC_COMPACTION_MODE_LATCH:
           codeIndex = numericCompaction(codewords, codeIndex, result);
           break;

File: core/src/main/java/com/google/zxing/client/result/URIResultParser.java
Patch:
@@ -28,7 +28,8 @@
  */
 public final class URIResultParser extends ResultParser {
 
-  private static final Pattern URL_WITH_PROTOCOL_PATTERN = Pattern.compile("[a-zA-Z0-9]{2,}:");
+  // See http://www.ietf.org/rfc/rfc2396.txt
+  private static final Pattern URL_WITH_PROTOCOL_PATTERN = Pattern.compile("[a-zA-Z][a-zA-Z0-9+-.]+:");
   private static final Pattern URL_WITHOUT_PROTOCOL_PATTERN = Pattern.compile(
       "([a-zA-Z0-9\\-]+\\.)+[a-zA-Z]{2,}" + // host name elements
       "(:\\d{1,5})?" + // maybe port

File: core/src/test/java/com/google/zxing/client/result/URIParsedResultTestCase.java
Patch:
@@ -104,6 +104,7 @@ public void testExotic() {
                "0ZAKOAB32/.8:J501GJJTTWOA+5/6$MIYBERPZ41NJ6-WSG/*Z48ZH*LSAOEM*IXP81L:$F*W08Z60CR*C*P.JEEVI1F02J07L6+" +
                "W4L1G$/IC*$16GK6A+:I1-:LJ:Z-P3NW6Z6ADFB-F2AKE$2DWN23GYCYEWX9S8L+LF$VXEKH7/R48E32PU+A:9H:8O5",
            null);
+    doTest("opc.tcp://test.samplehost.com:4841", "opc.tcp://test.samplehost.com:4841", null);
   }
 
   private static void doTest(String contents, String uri, String title) {

File: core/src/main/java/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -59,7 +59,7 @@ private enum Mode {
   private static final int PAL = 29;
 
   private static final char[] PUNCT_CHARS = {
-      ';', '<', '>', '@', '[', '\\', '}', '_', '`', '~', '!',
+      ';', '<', '>', '@', '[', '\\', ']', '_', '`', '~', '!',
       '\r', '\t', ',', ':', '\n', '-', '.', '$', '/', '"', '|', '*',
       '(', ')', '?', '{', '}', '\''};
 

File: core/src/main/java/com/google/zxing/aztec/decoder/Decoder.java
Patch:
@@ -215,6 +215,9 @@ private boolean[] correctBits(boolean[] rawbits) throws FormatException {
 
     int numDataCodewords = ddata.getNbDatablocks();
     int numCodewords = rawbits.length / codewordSize;
+    if (numCodewords < numDataCodewords) {
+      throw FormatException.getFormatInstance();
+    }
     int offset = rawbits.length % codewordSize;
     int numECCodewords = numCodewords - numDataCodewords;
 

File: android/src/com/google/zxing/client/android/result/supplement/SupplementalInfoRetriever.java
Patch:
@@ -55,8 +55,7 @@ public static void maybeInvokeRetrieval(TextView textView,
     } else if (result instanceof ProductParsedResult) {
       ProductParsedResult productParsedResult = (ProductParsedResult) result;
       String productID = productParsedResult.getProductID();
-      String normalizedProductID = productParsedResult.getNormalizedProductID();
-      SupplementalInfoRetriever productRetriever = 
+      SupplementalInfoRetriever productRetriever =
           new ProductResultInfoRetriever(textView, productID, historyManager, context);
       productRetriever.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
     } else if (result instanceof ISBNParsedResult) {

File: core/src/main/java/com/google/zxing/maxicode/decoder/DecodedBitStreamParser.java
Patch:
@@ -98,6 +98,9 @@ private static int getBit(int bit, byte[] bytes) {
   }
 
   private static int getInt(byte[] bytes, byte[] x) {
+    if (x.length == 0) {
+      throw new IllegalArgumentException();
+    }
     int val = 0;
     for (int i = 0; i < x.length; i++) {
       val += getBit(x[i], bytes) << (x.length - i - 1);

File: core/src/main/java/com/google/zxing/qrcode/encoder/MatrixUtil.java
Patch:
@@ -305,6 +305,9 @@ static int findMSBSet(int value) {
   // Since all coefficients in the polynomials are 1 or 0, we can do the calculation by bit
   // operations. We don't care if cofficients are positive or negative.
   static int calculateBCHCode(int value, int poly) {
+    if (poly == 0) {
+      throw new IllegalArgumentException("0 polynomial");
+    }
     // If poly is "1 1111 0010 0101" (version info poly), msbSetInPoly is 13. We'll subtract 1
     // from 13 to make it 12.
     int msbSetInPoly = findMSBSet(poly);

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417HighLevelEncoder.java
Patch:
@@ -166,7 +166,7 @@ static String encodeHighLevel(String msg, Compaction compaction, Charset encodin
     //the codewords 0..928 are encoded as Unicode characters
     StringBuilder sb = new StringBuilder(msg.length());
 
-    if (encoding != null || !DEFAULT_ENCODING_NAMES.contains(encoding.name())) {
+    if (encoding != null && !DEFAULT_ENCODING_NAMES.contains(encoding.name())) {
       CharacterSetECI eci = CharacterSetECI.getCharacterSetECIByName(encoding.name());
       if (eci != null) {
         encodingECI(eci.getValue(), sb);

File: core/src/main/java/com/google/zxing/Binarizer.java
Patch:
@@ -51,6 +51,7 @@ public final LuminanceSource getLuminanceSource() {
    * @param row An optional preallocated array. If null or too small, it will be ignored.
    *            If used, the Binarizer will call BitArray.clear(). Always use the returned object.
    * @return The array of bits for this row (true means black).
+   * @throws NotFoundException if row can't be binarized
    */
   public abstract BitArray getBlackRow(int y, BitArray row) throws NotFoundException;
 
@@ -61,6 +62,7 @@ public final LuminanceSource getLuminanceSource() {
    * fetched using getBlackRow(), so don't mix and match between them.
    *
    * @return The 2D array of bits for the image (true means black).
+   * @throws NotFoundException if image can't be binarized to make a matrix
    */
   public abstract BitMatrix getBlackMatrix() throws NotFoundException;
 

File: core/src/main/java/com/google/zxing/BinaryBitmap.java
Patch:
@@ -60,6 +60,7 @@ public int getHeight() {
    * @param row An optional preallocated array. If null or too small, it will be ignored.
    *            If used, the Binarizer will call BitArray.clear(). Always use the returned object.
    * @return The array of bits for this row (true means black).
+   * @throws NotFoundException if row can't be binarized
    */
   public BitArray getBlackRow(int y, BitArray row) throws NotFoundException {
     return binarizer.getBlackRow(y, row);
@@ -72,6 +73,7 @@ public BitArray getBlackRow(int y, BitArray row) throws NotFoundException {
    * fetched using getBlackRow(), so don't mix and match between them.
    *
    * @return The 2D array of bits for the image (true means black).
+   * @throws NotFoundException if image can't be binarized to make a matrix
    */
   public BitMatrix getBlackMatrix() throws NotFoundException {
     // The matrix is created on demand the first time it is requested, then cached. There are two

File: core/src/main/java/com/google/zxing/aztec/detector/Detector.java
Patch:
@@ -55,6 +55,7 @@ public AztecDetectorResult detect() throws NotFoundException {
   /**
    * Detects an Aztec Code in an image.
    *
+   * @param isMirror if true, image is a mirror-image of original
    * @return {@link AztecDetectorResult} encapsulating results of detecting an Aztec Code
    * @throws NotFoundException if no Aztec Code can be found
    */

File: core/src/main/java/com/google/zxing/aztec/encoder/HighLevelEncoder.java
Patch:
@@ -155,7 +155,7 @@ public HighLevelEncoder(byte[] text) {
   }
 
   /**
-   * Convert the text represented by this High Level Encoder into a BitArray.
+   * @return text represented by this encoder encoded as a {@link BitArray}
    */
   public BitArray encode() {
     Collection<State> states = Collections.singletonList(State.INITIAL_STATE);

File: core/src/main/java/com/google/zxing/client/result/CalendarParsedResult.java
Patch:
@@ -116,7 +116,7 @@ public boolean isStartAllDay() {
   }
 
   /**
-   * May return null if the event has no duration.
+   * @return event end {@link Date}, or {@code null} if event has no duration
    * @see #getStart()
    */
   public Date getEnd() {

File: core/src/main/java/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -71,6 +71,9 @@ public abstract class ResultParser {
    * Attempts to parse the raw {@link Result}'s contents as a particular type
    * of information (email, URL, etc.) and return a {@link ParsedResult} encapsulating
    * the result of parsing.
+   *
+   * @param theResult the raw {@link Result} to parse
+   * @return {@link ParsedResult} encapsulating the parsing result
    */
   public abstract ParsedResult parse(Result theResult);
 

File: core/src/main/java/com/google/zxing/common/CharacterSetECI.java
Patch:
@@ -95,9 +95,9 @@ public int getValue() {
 
   /**
    * @param value character set ECI value
-   * @return CharacterSetECI representing ECI of given value, or null if it is legal but
+   * @return {@link CharacterSetECI} representing ECI of given value, or null if it is legal but
    *   unsupported
-   * @throws IllegalArgumentException if ECI value is invalid
+   * @throws FormatException if ECI value is invalid
    */
   public static CharacterSetECI getCharacterSetECIByValue(int value) throws FormatException {
     if (value < 0 || value >= 900) {

File: core/src/main/java/com/google/zxing/common/PerspectiveTransform.java
Patch:
@@ -83,7 +83,6 @@ public void transformPoints(float[] points) {
     }
   }
 
-  /** Convenience method, not optimized for performance. */
   public void transformPoints(float[] xValues, float[] yValues) {
     int n = xValues.length;
     for (int i = 0; i < n; i ++) {

File: core/src/main/java/com/google/zxing/common/detector/MathUtils.java
Patch:
@@ -24,6 +24,9 @@ private MathUtils() {
   /**
    * Ends up being a bit faster than {@link Math#round(float)}. This merely rounds its
    * argument to the nearest int, where x.5 rounds up to x+1.
+   *
+   * @param d real value to round
+   * @return nearest {@code int}
    */
   public static int round(float d) {
     return (int) (d + 0.5f);

File: core/src/main/java/com/google/zxing/oned/OneDReader.java
Patch:
@@ -295,7 +295,9 @@ protected static int patternMatchVariance(int[] counters,
    * @param row the black/white pixel data of the row
    * @param hints decode hints
    * @return {@link Result} containing encoded string and start/end of barcode
-   * @throws NotFoundException if an error occurs or barcode cannot be found
+   * @throws NotFoundException if no potential barcode is found
+   * @throws ChecksumException if a potential barcode is found but does not pass its checksum
+   * @throws FormatException if a potential barcode is found but format is invalid
    */
   public abstract Result decodeRow(int rowNumber, BitArray row, Map<DecodeHintType,?> hints)
       throws NotFoundException, ChecksumException, FormatException;

File: core/src/main/java/com/google/zxing/oned/UPCEReader.java
Patch:
@@ -17,7 +17,6 @@
 package com.google.zxing.oned;
 
 import com.google.zxing.BarcodeFormat;
-import com.google.zxing.ChecksumException;
 import com.google.zxing.FormatException;
 import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitArray;
@@ -88,7 +87,7 @@ protected int[] decodeEnd(BitArray row, int endStart) throws NotFoundException {
   }
 
   @Override
-  protected boolean checkChecksum(String s) throws FormatException, ChecksumException {
+  protected boolean checkChecksum(String s) throws FormatException {
     return super.checkChecksum(convertUPCEtoUPCA(s));
   }
 

File: core/src/main/java/com/google/zxing/pdf417/PDF417Common.java
Patch:
@@ -60,8 +60,7 @@ public static int[] toIntArray(Collection<Integer> list) {
   }
 
   /**
-   * Translate the symbol into a codeword.
-   *
+   * @param symbol encoded symbol to translate to a codeword
    * @return the codeword corresponding to the symbol.
    */
   public static int getCodeword(long symbol) {

File: core/src/main/java/com/google/zxing/pdf417/detector/Detector.java
Patch:
@@ -65,6 +65,7 @@ private Detector() {
   /**
    * <p>Detects a PDF417 Code in an image. Only checks 0 and 180 degree rotations.</p>
    *
+   * @param image barcode image to decode
    * @param hints optional hints to detector
    * @param multiple if true, then the image is searched for multiple codes. If false, then at most one code will
    * be found and returned

File: core/src/main/java/com/google/zxing/qrcode/decoder/Decoder.java
Patch:
@@ -50,6 +50,7 @@ public DecoderResult decode(boolean[][] image) throws ChecksumException, FormatE
    * "true" is taken to mean a black module.</p>
    *
    * @param image booleans representing white/black QR Code modules
+   * @param hints decoding hints that should be used to influence decoding
    * @return text and bytes encoded within the QR Code
    * @throws FormatException if the QR Code cannot be decoded
    * @throws ChecksumException if error correction fails
@@ -76,6 +77,7 @@ public DecoderResult decode(BitMatrix bits) throws ChecksumException, FormatExce
    * <p>Decodes a QR Code represented as a {@link BitMatrix}. A 1 or "true" is taken to mean a black module.</p>
    *
    * @param bits booleans representing white/black QR Code modules
+   * @param hints decoding hints that should be used to influence decoding
    * @return text and bytes encoded within the QR Code
    * @throws FormatException if the QR Code cannot be decoded
    * @throws ChecksumException if error correction fails

File: core/src/main/java/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -476,6 +476,7 @@ private float crossCheckHorizontal(int startJ, int centerI, int maxCount,
    * @param stateCount reading state module counts from horizontal scan
    * @param i row where finder pattern may be found
    * @param j end of possible finder pattern in row
+   * @param pureBarcode true if in "pure barcode" mode
    * @return true if a finder pattern candidate was found this time
    */
   protected final boolean handlePossibleCenter(int[] stateCount, int i, int j, boolean pureBarcode) {

File: android/src/com/google/zxing/client/android/camera/open/OpenCameraInterface.java
Patch:
@@ -28,6 +28,8 @@ private OpenCameraInterface() {
 
   /**
    * Opens a rear-facing camera with {@link Camera#open(int)}, if one exists, or opens camera 0.
+   *
+   * @return handle to {@link Camera} that was opened
    */
   public static Camera open() {
     

File: core/src/main/java/com/google/zxing/common/StringUtils.java
Patch:
@@ -16,6 +16,7 @@
 
 package com.google.zxing.common;
 
+import java.nio.charset.Charset;
 import java.util.Map;
 
 import com.google.zxing.DecodeHintType;
@@ -28,8 +29,7 @@
  */
 public final class StringUtils {
 
-  private static final String PLATFORM_DEFAULT_ENCODING =
-      System.getProperty("file.encoding");
+  private static final String PLATFORM_DEFAULT_ENCODING = Charset.defaultCharset().name();
   public static final String SHIFT_JIS = "SJIS";
   public static final String GB2312 = "GB2312";
   private static final String EUC_JP = "EUC_JP";

File: core/src/main/java/com/google/zxing/pdf417/encoder/PDF417.java
Patch:
@@ -528,7 +528,7 @@ public PDF417() {
   public PDF417(boolean compact) {
     this.compact = compact;
     compaction = Compaction.AUTO;
-    encoding = PDF417HighLevelEncoder.DEFAULT_ENCODING;
+    encoding = null; // Use default
     minCols = 2;
     maxCols = 30;
     maxRows = 30;

File: android/src/com/google/zxing/client/android/Contents.java
Patch:
@@ -52,9 +52,9 @@ public static final class Type {
 
     /**
      * A contact. Send a request to encode it as follows:
-     * <p/>
+     * {@code
      * import android.provider.Contacts;
-     * <p/>
+     *
      * Intent intent = new Intent(Intents.Encode.ACTION);
      * intent.putExtra(Intents.Encode.TYPE, CONTACT);
      * Bundle bundle = new Bundle();
@@ -63,6 +63,7 @@ public static final class Type {
      * bundle.putString(ContactsContract.Intents.Insert.EMAIL, "jenny@the80s.com");
      * bundle.putString(ContactsContract.Intents.Insert.POSTAL, "123 Fake St. San Francisco, CA 94102");
      * intent.putExtra(Intents.Encode.DATA, bundle);
+     * }
      */
     public static final String CONTACT = "CONTACT_TYPE";
 

File: android/src/com/google/zxing/client/android/camera/AutoFocusManager.java
Patch:
@@ -64,7 +64,7 @@ public synchronized void onAutoFocus(boolean success, Camera theCamera) {
     autoFocusAgainLater();
   }
 
-  private void autoFocusAgainLater() {
+  private synchronized void autoFocusAgainLater() {
     if (!stopped && outstandingTask == null) {
       AutoFocusTask newTask = new AutoFocusTask();
       try {
@@ -78,7 +78,7 @@ private void autoFocusAgainLater() {
 
   synchronized void start() {
     if (useAutoFocus) {
-      cancelOutstandingTask();
+      outstandingTask = null;
       if (!stopped && !focusing) {
         try {
           camera.autoFocus(this);
@@ -93,7 +93,7 @@ synchronized void start() {
     }
   }
 
-  private void cancelOutstandingTask() {
+  private synchronized void cancelOutstandingTask() {
     if (outstandingTask != null) {
       if (outstandingTask.getStatus() != AsyncTask.Status.FINISHED) {
         outstandingTask.cancel(true);

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -52,6 +52,7 @@ public final class PreferencesActivity extends Activity {
   public static final String KEY_DISABLE_EXPOSURE = "preferences_disable_exposure";
   public static final String KEY_DISABLE_METERING = "preferences_disable_metering";
   public static final String KEY_DISABLE_BARCODE_SCENE_MODE = "preferences_disable_barcode_scene_mode";
+  public static final String KEY_AUTO_OPEN_WEB = "preferences_auto_open_web";
 
   @Override
   protected void onCreate(Bundle icicle) {

File: android/src/com/google/zxing/client/android/result/ResultHandler.java
Patch:
@@ -123,6 +123,9 @@ final Activity getActivity() {
    */
   public abstract int getButtonText(int index);
 
+  public Integer getDefaultButtonID() {
+    return null;
+  }
 
   /**
    * Execute the action which corresponds to the nth button.

File: android/src/com/google/zxing/client/android/PreferencesFragment.java
Patch:
@@ -109,8 +109,8 @@ private boolean isValid(Object newValue) {
       }
       // Before validating, remove custom placeholders, which will not
       // be considered valid parts of the URL in some locations:
-      // Blank %d and %s:
-      valueString = valueString.replaceAll("%[sd]", "");
+      // Blank %t and %s:
+      valueString = valueString.replaceAll("%[st]", "");
       // Blank %f but not if followed by digit or a-f as it may be a hex sequence
       valueString = valueString.replaceAll("%f(?![0-9a-f])", "");
       // Require a scheme otherwise:

File: core/src/main/java/com/google/zxing/oned/Code39Reader.java
Patch:
@@ -136,7 +136,7 @@ public Result decodeRow(int rowNumber, BitArray row, Map<DecodeHintType,?> hints
     int whiteSpaceAfterEnd = nextStart - lastStart - lastPatternSize;
     // If 50% of last pattern size, following last pattern, is not whitespace, fail
     // (but if it's whitespace to the very end of the image, that's OK)
-    if (nextStart != end && (whiteSpaceAfterEnd >> 1) < lastPatternSize) {
+    if (nextStart != end && (whiteSpaceAfterEnd << 1) < lastPatternSize) {
       throw NotFoundException.getNotFoundInstance();
     }
 

File: android/src/com/google/zxing/client/android/PreferencesFragment.java
Patch:
@@ -107,6 +107,9 @@ private boolean isValid(Object newValue) {
       if (valueString.isEmpty()) {
         return true;
       }
+      // Before validating, remove custom placeholders, which will not
+      // be considered valid parts of the URL in some locations:
+      valueString = valueString.replaceAll("%[sdf]", "");
       // Require a scheme otherwise:
       try {
         URI uri = new URI(valueString);

File: core/src/main/java/com/google/zxing/oned/Code39Writer.java
Patch:
@@ -67,15 +67,15 @@ public boolean[] encode(String contents) {
     int pos = appendPattern(result, 0, widths, true);
     int[] narrowWhite = {1};
     pos += appendPattern(result, pos, narrowWhite, false);
-    //append next character to bytematrix
+    //append next character to byte matrix
     for (int i = 0; i < length; i++) {
       int indexInString = Code39Reader.ALPHABET_STRING.indexOf(contents.charAt(i));
       toIntArray(Code39Reader.CHARACTER_ENCODINGS[indexInString], widths);
       pos += appendPattern(result, pos, widths, true);
       pos += appendPattern(result, pos, narrowWhite, false);
     }
     toIntArray(Code39Reader.CHARACTER_ENCODINGS[39], widths);
-    pos += appendPattern(result, pos, widths, true);
+    appendPattern(result, pos, widths, true);
     return result;
   }
 

File: core/src/main/java/com/google/zxing/oned/EAN13Writer.java
Patch:
@@ -86,7 +86,7 @@ public boolean[] encode(String contents) {
       int digit = Integer.parseInt(contents.substring(i, i + 1));
       pos += appendPattern(result, pos, UPCEANReader.L_PATTERNS[digit], true);
     }
-    pos += appendPattern(result, pos, UPCEANReader.START_END_PATTERN, true);
+    appendPattern(result, pos, UPCEANReader.START_END_PATTERN, true);
 
     return result;
   }

File: core/src/main/java/com/google/zxing/oned/EAN8Writer.java
Patch:
@@ -76,7 +76,7 @@ public boolean[] encode(String contents) {
       int digit = Integer.parseInt(contents.substring(i, i + 1));
       pos += appendPattern(result, pos, UPCEANReader.L_PATTERNS[digit], true);
     }
-    pos += appendPattern(result, pos, UPCEANReader.START_END_PATTERN, true);
+    appendPattern(result, pos, UPCEANReader.START_END_PATTERN, true);
 
     return result;
   }

File: android/src/com/google/zxing/client/android/LocaleManager.java
Patch:
@@ -172,7 +172,7 @@ private static String doGetTLD(Map<String,String> map, Context context) {
 
   public static String getCountry(Context context) {
     SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);
-    String countryOverride = prefs.getString(PreferencesActivity.KEY_SEARCH_COUNTRY, null);
+    String countryOverride = prefs.getString(PreferencesActivity.KEY_SEARCH_COUNTRY, "-");
     if (countryOverride != null && !countryOverride.isEmpty() && !"-".equals(countryOverride)) {
       return countryOverride;
     }

File: android/src/com/google/zxing/client/android/camera/FrontLightMode.java
Patch:
@@ -36,7 +36,7 @@ private static FrontLightMode parse(String modeString) {
   }
 
   public static FrontLightMode readPref(SharedPreferences sharedPrefs) {
-    return parse(sharedPrefs.getString(PreferencesActivity.KEY_FRONT_LIGHT_MODE, null));
+    return parse(sharedPrefs.getString(PreferencesActivity.KEY_FRONT_LIGHT_MODE, OFF.toString()));
   }
 
 }

File: core/src/main/java/com/google/zxing/pdf417/decoder/PDF417ScanningDecoder.java
Patch:
@@ -125,7 +125,7 @@ public static DecoderResult decode(BitMatrix image,
 
   private static DetectionResult merge(DetectionResultRowIndicatorColumn leftRowIndicatorColumn,
                                        DetectionResultRowIndicatorColumn rightRowIndicatorColumn)
-      throws NotFoundException {
+      throws NotFoundException, FormatException {
     if (leftRowIndicatorColumn == null && rightRowIndicatorColumn == null) {
       return null;
     }
@@ -139,7 +139,7 @@ private static DetectionResult merge(DetectionResultRowIndicatorColumn leftRowIn
   }
 
   private static BoundingBox adjustBoundingBox(DetectionResultRowIndicatorColumn rowIndicatorColumn)
-      throws NotFoundException {
+      throws NotFoundException, FormatException {
     if (rowIndicatorColumn == null) {
       return null;
     }

File: core/src/main/java/com/google/zxing/common/detector/WhiteRectangleDetector.java
Patch:
@@ -44,7 +44,7 @@ public final class WhiteRectangleDetector {
   private final int upInit;
 
   public WhiteRectangleDetector(BitMatrix image) throws NotFoundException {
-	this(image, INIT_SIZE, image.getWidth() / 2, image.getHeight() / 2);
+    this(image, INIT_SIZE, image.getWidth() / 2, image.getHeight() / 2);
   }
 
   /**
@@ -180,8 +180,8 @@ public ResultPoint[] detect() throws NotFoundException {
       if (aBlackPointFoundOnBorder) {
         atLeastOneBlackPointFoundOnBorder = true;
       }
-      
-  }
+
+    }
 
     if (!sizeExceeded && atLeastOneBlackPointFoundOnBorder) {
 

File: javase/src/main/java/com/google/zxing/HtmlAssetTranslator.java
Patch:
@@ -88,8 +88,9 @@ private static Collection<String> parseLanguagesToTranslate(Path assetsDir,
       DirectoryStream.Filter<Path> fileFilter = new DirectoryStream.Filter<Path>() {
         @Override
         public boolean accept(Path entry) {
+          String fileName = entry.getFileName().toString();
           return Files.isDirectory(entry) && !Files.isSymbolicLink(entry) &&
-              entry.getFileName().startsWith("html-") && !"html-en".equals(entry.getFileName().toString());
+              fileName.startsWith("html-") && !"html-en".equals(fileName);
         }
       };
       try (DirectoryStream<Path> dirs = Files.newDirectoryStream(assetsDir, fileFilter)) {

File: core/src/main/java/com/google/zxing/datamatrix/encoder/SymbolInfo.java
Patch:
@@ -25,7 +25,7 @@
  */
 public class SymbolInfo {
 
-  public static final SymbolInfo[] PROD_SYMBOLS = {
+  static final SymbolInfo[] PROD_SYMBOLS = {
     new SymbolInfo(false, 3, 5, 8, 8, 1),
     new SymbolInfo(false, 5, 7, 10, 10, 1),
       /*rect*/new SymbolInfo(true, 5, 7, 16, 6, 1),

File: core/src/main/java/com/google/zxing/multi/qrcode/QRCodeMultiReader.java
Patch:
@@ -31,6 +31,7 @@
 import com.google.zxing.qrcode.QRCodeReader;
 import com.google.zxing.qrcode.decoder.QRCodeDecoderMetaData;
 
+import java.io.Serializable;
 import java.util.ArrayList;
 import java.util.Collection;
 import java.util.List;
@@ -162,7 +163,7 @@ private static List<Result> processStructuredAppend(List<Result> results) {
     return newResults;
   }
 
-  private static final class SAComparator implements Comparator<Result> {
+  private static final class SAComparator implements Comparator<Result>, Serializable {
     @Override
     public int compare(Result a, Result b) {
       int aNumber = (int) (a.getResultMetadata().get(ResultMetadataType.STRUCTURED_APPEND_SEQUENCE));

File: core/src/main/java/com/google/zxing/pdf417/decoder/DetectionResult.java
Patch:
@@ -286,7 +286,7 @@ public String toString() {
         }
         formatter.format(" %3d|%3d", codeword.getRowNumber(), codeword.getValue());
       }
-      formatter.format("\n");
+      formatter.format("%n");
     }
     String result = formatter.toString();
     formatter.close();

File: core/src/main/java/com/google/zxing/pdf417/decoder/PDF417ScanningDecoder.java
Patch:
@@ -187,7 +187,7 @@ private static BarcodeMetadata getBarcodeMetadata(DetectionResultRowIndicatorCol
       return rightRowIndicatorColumn == null ? null : rightRowIndicatorColumn.getBarcodeMetadata();
     }
     if (rightRowIndicatorColumn == null || rightRowIndicatorColumn.getBarcodeMetadata() == null) {
-      return leftRowIndicatorColumn == null ? null : leftRowIndicatorColumn.getBarcodeMetadata();
+      return leftRowIndicatorColumn.getBarcodeMetadata();
     }
     BarcodeMetadata leftBarcodeMetadata = leftRowIndicatorColumn.getBarcodeMetadata();
     BarcodeMetadata rightBarcodeMetadata = rightRowIndicatorColumn.getBarcodeMetadata();
@@ -612,7 +612,7 @@ public static String toString(BarcodeValue[][] barcodeMatrix) {
               barcodeValue.getConfidence(barcodeValue.getValue()[0]));
         }
       }
-      formatter.format("\n");
+      formatter.format("%n");
     }
     String result = formatter.toString();
     formatter.close();

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -48,7 +48,9 @@ public final class PreferencesActivity extends Activity {
   public static final String KEY_SEARCH_COUNTRY = "preferences_search_country";
 
   public static final String KEY_DISABLE_CONTINUOUS_FOCUS = "preferences_disable_continuous_focus";
-  //public static final String KEY_DISABLE_EXPOSURE = "preferences_disable_exposure";
+  public static final String KEY_DISABLE_EXPOSURE = "preferences_disable_exposure";
+  public static final String KEY_DISABLE_METERING = "preferences_disable_metering";
+  public static final String KEY_DISABLE_BARCODE_SCENE_MODE = "preferences_disable_barcode_scene_mode";
 
   @Override
   protected void onCreate(Bundle icicle) {

File: core/src/main/java/com/google/zxing/client/result/ProductResultParser.java
Patch:
@@ -43,7 +43,7 @@ public ProductParsedResult parse(Result result) {
 
     String normalizedProductID;
     // Expand UPC-E for purposes of searching
-    if (format == BarcodeFormat.UPC_E) {
+    if (format == BarcodeFormat.UPC_E && rawText.length() == 8) {
       normalizedProductID = UPCEReader.convertUPCEtoUPCA(rawText);
     } else {
       normalizedProductID = rawText;

File: core/src/main/java/com/google/zxing/client/result/ParsedResultType.java
Patch:
@@ -35,5 +35,6 @@ public enum ParsedResultType {
   CALENDAR,
   WIFI,
   ISBN,
+  VIN,
 
 }

File: core/src/main/java/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -59,6 +59,7 @@ public abstract class ResultParser {
       new ISBNResultParser(),
       new ProductResultParser(),
       new ExpandedProductResultParser(),
+      new VINResultParser(),
   };
 
   private static final Pattern DIGITS = Pattern.compile("\\d*");
@@ -191,7 +192,7 @@ private static void appendKeyValue(CharSequence keyValue, Map<String,String> res
       }
     }
   }
-  
+
   static String urlDecode(String encoded) {
     try {
       return URLDecoder.decode(encoded, "UTF-8");

File: android/src/com/google/zxing/client/android/share/ShareActivity.java
Patch:
@@ -220,11 +220,14 @@ private void showContactAsBarcode(Uri contactUri) {
         try {
           int foundPhone = 0;
           int phonesNumberColumn = phonesCursor.getColumnIndex(ContactsContract.CommonDataKinds.Phone.NUMBER);
+          int phoneTypeColumn = phonesCursor.getColumnIndex(ContactsContract.CommonDataKinds.Phone.TYPE);
           while (phonesCursor.moveToNext() && foundPhone < Contents.PHONE_KEYS.length) {
             String number = phonesCursor.getString(phonesNumberColumn);
             if (number != null && !number.isEmpty()) {
               bundle.putString(Contents.PHONE_KEYS[foundPhone], massageContactData(number));
             }
+            int type = phonesCursor.getInt(phoneTypeColumn);
+            bundle.putInt(Contents.PHONE_TYPE_KEYS[foundPhone], type);
             foundPhone++;
           }
         } finally {

File: android/src/com/google/zxing/client/android/share/LoadPackagesAsyncTask.java
Patch:
@@ -38,7 +38,7 @@
  *
  * @author Sean Owen
  */
-final class LoadPackagesAsyncTask extends AsyncTask<Void,Void,List<AppInfo>> {
+final class LoadPackagesAsyncTask extends AsyncTask<Object,Object,List<AppInfo>> {
 
   private static final String[] PKG_PREFIX_WHITELIST = {
       "com.google.android.apps.",
@@ -57,7 +57,7 @@ final class LoadPackagesAsyncTask extends AsyncTask<Void,Void,List<AppInfo>> {
   }
 
   @Override
-  protected List<AppInfo> doInBackground(Void... objects) {
+  protected List<AppInfo> doInBackground(Object... objects) {
     List<AppInfo> labelsPackages = new ArrayList<>();
     PackageManager packageManager = activity.getPackageManager();
     Iterable<ApplicationInfo> appInfos = packageManager.getInstalledApplications(0);

File: android/src/com/google/zxing/client/android/result/WifiResultHandler.java
Patch:
@@ -30,7 +30,7 @@
 import com.google.zxing.client.result.WifiParsedResult;
 
 /**
- * Handles address book entries.
+ * Handles wifi access information.
  *
  * @author Vikram Aggarwal
  * @author Sean Owen

File: core/src/test/java/com/google/zxing/qrcode/QRCodeBlackBox1TestCase.java
Patch:
@@ -28,9 +28,9 @@ public final class QRCodeBlackBox1TestCase extends AbstractBlackBoxTestCase {
   public QRCodeBlackBox1TestCase() {
     super("src/test/resources/blackbox/qrcode-1", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(17, 17, 0.0f);
-    addTest(14, 15, 90.0f);
+    addTest(14, 14, 90.0f);
     addTest(17, 17, 180.0f);
-    addTest(14, 15, 270.0f);
+    addTest(14, 14, 270.0f);
   }
 
 }

File: core/src/test/java/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -27,10 +27,10 @@ public final class QRCodeBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox2TestCase() {
     super("src/test/resources/blackbox/qrcode-2", new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(30, 31, 0.0f);
-    addTest(29, 30, 90.0f);
+    addTest(30, 30, 0.0f);
+    addTest(29, 29, 90.0f);
     addTest(30, 30, 180.0f);
-    addTest(29, 30, 270.0f);
+    addTest(29, 29, 270.0f);
   }
 
 }

File: core/src/test/java/com/google/zxing/qrcode/QRCodeBlackBox3TestCase.java
Patch:
@@ -28,8 +28,8 @@ public final class QRCodeBlackBox3TestCase extends AbstractBlackBoxTestCase {
   public QRCodeBlackBox3TestCase() {
     super("src/test/resources/blackbox/qrcode-3", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(38, 38, 0.0f);
-    addTest(38, 39, 90.0f);
-    addTest(36, 38, 180.0f);
+    addTest(38, 38, 90.0f);
+    addTest(36, 36, 180.0f);
     addTest(39, 39, 270.0f);
   }
 

File: core/src/test/java/com/google/zxing/qrcode/QRCodeBlackBox4TestCase.java
Patch:
@@ -31,8 +31,8 @@ public QRCodeBlackBox4TestCase() {
     super("src/test/resources/blackbox/qrcode-4", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(36, 36, 0.0f);
     addTest(35, 35, 90.0f);
-    addTest(35, 36, 180.0f);
-    addTest(35, 36, 270.0f);
+    addTest(35, 35, 180.0f);
+    addTest(35, 35, 270.0f);
   }
 
 }

File: core/src/test/java/com/google/zxing/qrcode/QRCodeBlackBox5TestCase.java
Patch:
@@ -34,7 +34,7 @@ public QRCodeBlackBox5TestCase() {
     addTest(19, 19, 0.0f);
     addTest(19, 19, 90.0f);
     addTest(19, 19, 180.0f);
-    addTest(18, 19, 270.0f);
+    addTest(18, 18, 270.0f);
   }
 
 }

File: core/src/test/java/com/google/zxing/qrcode/QRCodeBlackBox6TestCase.java
Patch:
@@ -29,9 +29,9 @@ public final class QRCodeBlackBox6TestCase extends AbstractBlackBoxTestCase {
   public QRCodeBlackBox6TestCase() {
     super("src/test/resources/blackbox/qrcode-6", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(15, 15, 0.0f);
-    addTest(14, 15, 90.0f);
-    addTest(12, 15, 180.0f);
-    addTest(14, 15, 270.0f);
+    addTest(14, 14, 90.0f);
+    addTest(12, 13, 180.0f);
+    addTest(14, 14, 270.0f);
   }
 
 }

File: core/src/test/java/com/google/zxing/oned/Code128BlackBox1TestCase.java
Patch:
@@ -27,8 +27,8 @@ public final class Code128BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public Code128BlackBox1TestCase() {
     super("src/test/resources/blackbox/code128-1", new MultiFormatReader(), BarcodeFormat.CODE_128);
-    addTest(5, 5, 0.0f);
-    addTest(5, 5, 180.0f);
+    addTest(6, 6, 0.0f);
+    addTest(6, 6, 180.0f);
   }
 
 }
\ No newline at end of file

File: android/src/com/google/zxing/client/android/result/AddressBookResultHandler.java
Patch:
@@ -140,9 +140,7 @@ public void handleButtonPress(int index) {
                    addressResult.getGeo());
         break;
       case 1:
-        String[] names = addressResult.getNames();
-        String title = names != null ? names[0] : null;
-        searchMap(address1, title);
+        searchMap(address1);
         break;
       case 2:
         dialPhone(addressResult.getPhoneNumbers()[0]);

File: android/src/com/google/zxing/client/android/result/supplement/AmazonInfoRetriever.java
Patch:
@@ -120,7 +120,7 @@ void retrieveSupplementalInfo() throws IOException {
       }
 
     } catch (XmlPullParserException xppe) {
-      throw new IOException(xppe.toString());
+      throw new IOException(xppe);
     }
     
     if (error || detailPageURL == null) {

File: android/src/com/google/zxing/client/android/result/supplement/BookResultInfoRetriever.java
Patch:
@@ -88,7 +88,7 @@ void retrieveSupplementalInfo() throws IOException {
       }
 
     } catch (JSONException e) {
-      throw new IOException(e.toString());
+      throw new IOException(e);
     }
 
     Collection<String> newTexts = new ArrayList<String>();

File: core/src/com/google/zxing/oned/rss/expanded/RSSExpandedReader.java
Patch:
@@ -28,6 +28,7 @@
 
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.DecodeHintType;
+import com.google.zxing.FormatException;
 import com.google.zxing.NotFoundException;
 import com.google.zxing.Result;
 import com.google.zxing.ResultPoint;
@@ -122,7 +123,7 @@ public final class RSSExpandedReader extends AbstractRSSReader {
   @Override
   public Result decodeRow(int rowNumber,
                           BitArray row,
-                          Map<DecodeHintType,?> hints) throws NotFoundException {
+                          Map<DecodeHintType,?> hints) throws NotFoundException, FormatException {
     // Rows can start with even pattern in case in prev rows there where odd number of patters.
     // So lets try twice
     this.pairs.clear();
@@ -362,7 +363,7 @@ List<ExpandedRow> getRows() {
   }
 
   // Not private for unit testing
-  static Result constructResult(List<ExpandedPair> pairs) throws NotFoundException{
+  static Result constructResult(List<ExpandedPair> pairs) throws NotFoundException, FormatException {
     BitArray binary = BitArrayBuilder.buildBitArray(pairs);
 
     AbstractExpandedDecoder decoder = AbstractExpandedDecoder.createDecoder(binary);

File: core/src/com/google/zxing/oned/rss/expanded/decoders/AI01392xDecoder.java
Patch:
@@ -26,6 +26,7 @@
 
 package com.google.zxing.oned.rss.expanded.decoders;
 
+import com.google.zxing.FormatException;
 import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitArray;
 
@@ -42,7 +43,7 @@ final class AI01392xDecoder extends AI01decoder {
   }
 
   @Override
-  public String parseInformation() throws NotFoundException {
+  public String parseInformation() throws NotFoundException, FormatException {
     if (this.getInformation().getSize() < HEADER_SIZE + GTIN_SIZE) {
       throw NotFoundException.getNotFoundInstance();
     }

File: core/src/com/google/zxing/oned/rss/expanded/decoders/AI01393xDecoder.java
Patch:
@@ -25,6 +25,7 @@
  */
 package com.google.zxing.oned.rss.expanded.decoders;
 
+import com.google.zxing.FormatException;
 import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitArray;
 
@@ -42,7 +43,7 @@ final class AI01393xDecoder extends AI01decoder {
   }
 
   @Override
-  public String parseInformation() throws NotFoundException {
+  public String parseInformation() throws NotFoundException, FormatException {
     if(this.getInformation().getSize() < HEADER_SIZE + GTIN_SIZE) {
       throw NotFoundException.getNotFoundInstance();
     }

File: core/src/com/google/zxing/oned/rss/expanded/decoders/AI01AndOtherAIs.java
Patch:
@@ -26,6 +26,7 @@
 
 package com.google.zxing.oned.rss.expanded.decoders;
 
+import com.google.zxing.FormatException;
 import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitArray;
 
@@ -42,7 +43,7 @@ final class AI01AndOtherAIs extends AI01decoder {
   }
 
   @Override
-  public String parseInformation() throws NotFoundException {
+  public String parseInformation() throws NotFoundException, FormatException {
     StringBuilder buff = new StringBuilder();
 
     buff.append("(01)");

File: core/src/com/google/zxing/oned/rss/expanded/decoders/AbstractExpandedDecoder.java
Patch:
@@ -26,6 +26,7 @@
 
 package com.google.zxing.oned.rss.expanded.decoders;
 
+import com.google.zxing.FormatException;
 import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitArray;
 
@@ -51,7 +52,7 @@ protected final GeneralAppIdDecoder getGeneralDecoder() {
     return generalDecoder;
   }
 
-  public abstract String parseInformation() throws NotFoundException;
+  public abstract String parseInformation() throws NotFoundException, FormatException;
 
   public static AbstractExpandedDecoder createDecoder(BitArray information){
     if (information.get(1)) {

File: core/src/com/google/zxing/oned/rss/expanded/decoders/AnyAIDecoder.java
Patch:
@@ -26,6 +26,7 @@
 
 package com.google.zxing.oned.rss.expanded.decoders;
 
+import com.google.zxing.FormatException;
 import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitArray;
 
@@ -42,7 +43,7 @@ final class AnyAIDecoder extends AbstractExpandedDecoder {
   }
 
   @Override
-  public String parseInformation() throws NotFoundException {
+  public String parseInformation() throws NotFoundException, FormatException {
     StringBuilder buf = new StringBuilder();
     return this.getGeneralDecoder().decodeAllCodes(buf, HEADER_SIZE);
   }

File: core/test/src/com/google/zxing/oned/rss/expanded/decoders/AbstractDecoderTest.java
Patch:
@@ -26,6 +26,7 @@
 
 package com.google.zxing.oned.rss.expanded.decoders;
 
+import com.google.zxing.FormatException;
 import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitArray;
 import com.google.zxing.oned.rss.expanded.BinaryUtil;
@@ -67,7 +68,7 @@ public abstract class AbstractDecoderTest extends Assert {
 	protected static final String compressedDate_End             = "X..X.XX.........";
 
 	protected static void assertCorrectBinaryString(CharSequence binaryString,
-                                                  String expectedNumber) throws NotFoundException {
+                                                  String expectedNumber) throws NotFoundException, FormatException {
 		BitArray binary = BinaryUtil.buildBitArrayFromStringWithoutSpaces(binaryString);
 		AbstractExpandedDecoder decoder = AbstractExpandedDecoder.createDecoder(binary);
 		String result = decoder.parseInformation();

File: core/src/com/google/zxing/pdf417/decoder/PDF417ScanningDecoder.java
Patch:
@@ -144,6 +144,9 @@ private static BoundingBox adjustBoundingBox(DetectionResultRowIndicatorColumn r
       return null;
     }
     int[] rowHeights = rowIndicatorColumn.getRowHeights();
+    if (rowHeights == null) {
+      return null;
+    }
     int maxRowHeight = getMax(rowHeights);
     int missingStartRows = 0;
     for (int rowHeight : rowHeights) {

File: android/src/com/google/zxing/client/android/clipboard/ClipboardInterface.java
Patch:
@@ -41,6 +41,9 @@ public static void setText(CharSequence text, Context context) {
       } catch (NullPointerException npe) {
         // Have seen this in the wild, bizarrely
         Log.w(TAG, "Clipboard bug", npe);
+      } catch (IllegalStateException ise) {
+        // java.lang.IllegalStateException: beginBroadcast() called while already in a broadcast
+        Log.w(TAG, "Clipboard bug", ise);
       }
     }
   }

File: core/src/com/google/zxing/oned/Code128Reader.java
Patch:
@@ -441,6 +441,8 @@ public Result decodeRow(int rowNumber, BitArray row, Map<DecodeHintType,?> hints
 
     }
 
+    int lastPatternSize = nextStart - lastStart;
+
     // Check for ample whitespace following pattern, but, to do this we first need to remember that
     // we fudged decoding CODE_STOP since it actually has 7 bars, not 6. There is a black bar left
     // to read off. Would be slightly better to properly read. Here we just skip it:
@@ -476,7 +478,7 @@ public Result decodeRow(int rowNumber, BitArray row, Map<DecodeHintType,?> hints
     }
 
     float left = (float) (startPatternInfo[1] + startPatternInfo[0]) / 2.0f;
-    float right = (float) (nextStart + lastStart) / 2.0f;
+    float right = lastStart + lastPatternSize / 2.0f;
 
     int rawCodesSize = rawCodes.size();
     byte[] rawBytes = new byte[rawCodesSize];

File: core/src/com/google/zxing/oned/Code39Reader.java
Patch:
@@ -165,7 +165,7 @@ public Result decodeRow(int rowNumber, BitArray row, Map<DecodeHintType,?> hints
     }
 
     float left = (float) (start[1] + start[0]) / 2.0f;
-    float right = (float) (nextStart + lastStart) / 2.0f;
+    float right = lastStart + lastPatternSize / 2.0f;
     return new Result(
         resultString,
         null,

File: android/src/com/google/zxing/client/android/DecodeFormatManager.java
Patch:
@@ -52,8 +52,8 @@ final class DecodeFormatManager {
   private DecodeFormatManager() {}
 
   static Collection<BarcodeFormat> parseDecodeFormats(Intent intent) {
-    List<String> scanFormats = null;
-    String scanFormatsString = intent.getStringExtra(Intents.Scan.FORMATS);
+    Iterable<String> scanFormats = null;
+    CharSequence scanFormatsString = intent.getStringExtra(Intents.Scan.FORMATS);
     if (scanFormatsString != null) {
       scanFormats = Arrays.asList(COMMA_PATTERN.split(scanFormatsString));
     }

File: android/src/com/google/zxing/client/android/InactivityTimer.java
Patch:
@@ -40,7 +40,7 @@ final class InactivityTimer {
   private final Activity activity;
   private final AsyncTaskExecInterface taskExec;
   private final BroadcastReceiver powerStatusReceiver;
-  private InactivityAsyncTask inactivityTask;
+  private AsyncTask<?,?,?> inactivityTask;
 
   InactivityTimer(Activity activity) {
     this.activity = activity;

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -21,7 +21,7 @@
 import android.os.Bundle;
 import android.preference.CheckBoxPreference;
 import android.preference.PreferenceActivity;
-import android.preference.PreferenceScreen;
+import android.preference.PreferenceGroup;
 
 import java.util.ArrayList;
 import java.util.Collection;
@@ -62,7 +62,7 @@ protected void onCreate(Bundle icicle) {
     super.onCreate(icicle);
     addPreferencesFromResource(R.xml.preferences);
 
-    PreferenceScreen preferences = getPreferenceScreen();
+    PreferenceGroup preferences = getPreferenceScreen();
     preferences.getSharedPreferences().registerOnSharedPreferenceChangeListener(this);
     decode1D = (CheckBoxPreference) preferences.findPreference(KEY_DECODE_1D);
     decodeQR = (CheckBoxPreference) preferences.findPreference(KEY_DECODE_QR);

File: android/src/com/google/zxing/client/android/camera/AutoFocusManager.java
Patch:
@@ -45,7 +45,7 @@ final class AutoFocusManager implements Camera.AutoFocusCallback {
   private boolean active;
   private final boolean useAutoFocus;
   private final Camera camera;
-  private AutoFocusTask outstandingTask;
+  private AsyncTask<?,?,?> outstandingTask;
   private final AsyncTaskExecInterface taskExec;
 
   AutoFocusManager(Context context, Camera camera) {

File: android/src/com/google/zxing/client/android/share/LoadPackagesAsyncTask.java
Patch:
@@ -18,6 +18,7 @@
 
 import android.app.ListActivity;
 import android.content.pm.ApplicationInfo;
+import android.content.pm.PackageItemInfo;
 import android.content.pm.PackageManager;
 import android.graphics.drawable.Drawable;
 import android.os.AsyncTask;
@@ -59,8 +60,8 @@ final class LoadPackagesAsyncTask extends AsyncTask<Void,Void,List<AppInfo>> {
   protected List<AppInfo> doInBackground(Void... objects) {
     List<AppInfo> labelsPackages = new ArrayList<AppInfo>();
     PackageManager packageManager = activity.getPackageManager();
-    List<ApplicationInfo> appInfos = packageManager.getInstalledApplications(0);
-    for (ApplicationInfo appInfo : appInfos) {
+    Iterable<ApplicationInfo> appInfos = packageManager.getInstalledApplications(0);
+    for (PackageItemInfo appInfo : appInfos) {
       String packageName = appInfo.packageName;
       if (!isHidden(packageName)) {
         CharSequence label = appInfo.loadLabel(packageManager);

File: android/src/com/google/zxing/client/android/share/ShareActivity.java
Patch:
@@ -51,7 +51,7 @@ public final class ShareActivity extends Activity {
   private static final int PICK_CONTACT = 1;
   private static final int PICK_APP = 2;
 
-  private Button clipboardButton;
+  private View clipboardButton;
 
   private final Button.OnClickListener contactListener = new Button.OnClickListener() {
     @Override
@@ -124,7 +124,7 @@ public void onCreate(Bundle icicle) {
     findViewById(R.id.share_contact_button).setOnClickListener(contactListener);
     findViewById(R.id.share_bookmark_button).setOnClickListener(bookmarkListener);
     findViewById(R.id.share_app_button).setOnClickListener(appListener);
-    clipboardButton = (Button) findViewById(R.id.share_clipboard_button);
+    clipboardButton = findViewById(R.id.share_clipboard_button);
     clipboardButton.setOnClickListener(clipboardListener);
     findViewById(R.id.share_text_view).setOnKeyListener(textListener);
   }

File: android/src/com/google/zxing/client/android/wifi/WifiConfigManager.java
Patch:
@@ -21,7 +21,6 @@
 import android.os.AsyncTask;
 import android.util.Log;
 
-import java.util.List;
 import java.util.regex.Pattern;
 
 import com.google.zxing.client.result.WifiParsedResult;
@@ -170,7 +169,7 @@ private static void changeNetworkUnEncrypted(WifiManager wifiManager, WifiParsed
   }
 
   private static Integer findNetworkInExistingConfig(WifiManager wifiManager, String ssid) {
-    List<WifiConfiguration> existingConfigs = wifiManager.getConfiguredNetworks();
+    Iterable<WifiConfiguration> existingConfigs = wifiManager.getConfiguredNetworks();
     for (WifiConfiguration existingConfig : existingConfigs) {
       if (existingConfig.SSID.equals(ssid)) {
         return existingConfig.networkId;

File: androidtest/src/com/google/zxing/client/androidtest/BenchmarkActivity.java
Patch:
@@ -31,7 +31,7 @@ public final class BenchmarkActivity extends Activity {
   private static final String TAG = BenchmarkActivity.class.getSimpleName();
   private static final String PATH = Environment.getExternalStorageDirectory().getPath() + "/zxingbenchmark";
 
-  private Button runBenchmarkButton;
+  private View runBenchmarkButton;
   private TextView textView;
   private Thread benchmarkThread;
 
@@ -81,7 +81,7 @@ public void onCreate(Bundle icicle) {
 
     setContentView(R.layout.benchmark);
 
-    runBenchmarkButton = (Button) findViewById(R.id.benchmark_run);
+    runBenchmarkButton = findViewById(R.id.benchmark_run);
     runBenchmarkButton.setOnClickListener(runBenchmark);
     textView = (TextView) findViewById(R.id.benchmark_help);
 

File: androidtest/src/com/google/zxing/client/androidtest/ZXingTestActivity.java
Patch:
@@ -268,7 +268,7 @@ private void encodeBarcode(CharSequence type, Bundle data) {
     integrator.shareText(data.toString(), type); // data.toString() isn't used
   }
 
-  private static String getFlattenedParams() {
+  private static CharSequence getFlattenedParams() {
     Camera camera = Camera.open();
     if (camera == null) {
       return null;
@@ -307,7 +307,7 @@ private static String collectStats() {
     result.append("VERSION.RELEASE=").append(Build.VERSION.RELEASE).append('\n');
     result.append("VERSION.SDK_INT=").append(Build.VERSION.SDK_INT).append('\n');
 
-    String flattened = getFlattenedParams();
+    CharSequence flattened = getFlattenedParams();
     String[] params = SEMICOLON.split(flattened);
     Arrays.sort(params);
     for (String param : params) {

File: core/src/com/google/zxing/aztec/AztecWriter.java
Patch:
@@ -39,7 +39,7 @@ public BitMatrix encode(String contents, BarcodeFormat format, int width, int he
   public BitMatrix encode(String contents, BarcodeFormat format, int width, int height, Map<EncodeHintType,?> hints) {
     String charset = hints == null ? null : (String) hints.get(EncodeHintType.CHARACTER_SET);
     Number eccPercent = hints == null ? null : (Number) hints.get(EncodeHintType.ERROR_CORRECTION);
-    Integer layers = hints == null ? null : (Integer)hints.get(EncodeHintType.AZTEC_LAYERS);
+    Number layers = hints == null ? null : (Number) hints.get(EncodeHintType.AZTEC_LAYERS);
     return encode(contents, 
                   format, 
                   width,

File: core/src/com/google/zxing/client/result/ExpandedProductResultParser.java
Patch:
@@ -157,7 +157,7 @@ private static String findAIvalue(int i, String rawText) {
       return null;
     }
 
-    String rawTextAux = rawText.substring(i + 1);
+    CharSequence rawTextAux = rawText.substring(i + 1);
 
     StringBuilder buf = new StringBuilder();
     for (int index = 0; index < rawTextAux.length(); index++) {

File: core/src/com/google/zxing/client/result/GeoResultParser.java
Patch:
@@ -36,7 +36,7 @@ public final class GeoResultParser extends ResultParser {
   
   @Override
   public GeoParsedResult parse(Result result) {
-    String rawText = getMassagedText(result);
+    CharSequence rawText = getMassagedText(result);
     Matcher matcher = GEO_URL_PATTERN.matcher(rawText);
     if (!matcher.matches()) {
       return null;

File: core/src/com/google/zxing/client/result/SMTPResultParser.java
Patch:
@@ -20,7 +20,7 @@
 
 /**
  * <p>Parses an "smtp:" URI result, whose format is not standardized but appears to be like:
- * {@code smtp(:subject(:body))}.</p>
+ * {@code smtp[:subject[:body]]}.</p>
  *
  * <p>See http://code.google.com/p/zxing/issues/detail?id=536</p>
  *

File: core/src/com/google/zxing/datamatrix/encoder/DefaultPlacement.java
Patch:
@@ -23,7 +23,7 @@
  */
 public class DefaultPlacement {
 
-  private final String codewords;
+  private final CharSequence codewords;
   private final int numrows;
   private final int numcols;
   private final byte[] bits;
@@ -35,7 +35,7 @@ public class DefaultPlacement {
    * @param numcols   the number of columns
    * @param numrows   the number of rows
    */
-  public DefaultPlacement(String codewords, int numcols, int numrows) {
+  public DefaultPlacement(CharSequence codewords, int numcols, int numrows) {
     this.codewords = codewords;
     this.numcols = numcols;
     this.numrows = numrows;

File: core/src/com/google/zxing/maxicode/MaxiCodeReader.java
Patch:
@@ -43,9 +43,11 @@ public final class MaxiCodeReader implements Reader {
 
   private final Decoder decoder = new Decoder();
 
+  /*
   Decoder getDecoder() {
     return decoder;
   }
+   */
 
   /**
    * Locates and decodes a MaxiCode in an image.

File: core/src/com/google/zxing/oned/CodaBarReader.java
Patch:
@@ -238,14 +238,15 @@ private void setCounters(BitArray row) throws NotFoundException {
     }
     boolean isWhite = true;
     int count = 0;
-    for (; i < end; i++) {
+    while (i < end) {
       if (row.get(i) ^ isWhite) { // that is, exactly one is true
         count++;
       } else {
         counterAppend(count);
         count = 1;
         isWhite = !isWhite;
       }
+      i++;
     }
     counterAppend(count);
   }

File: core/src/com/google/zxing/pdf417/PDF417Common.java
Patch:
@@ -29,7 +29,7 @@ public final class PDF417Common {
   public static final int MIN_ROWS_IN_BARCODE = 3;
   public static final int MAX_ROWS_IN_BARCODE = 90;
   // One left row indication column + max 30 data columns + one right row indicator column
-  public static final int MAX_CODEWORDS_IN_ROW = 32;
+  //public static final int MAX_CODEWORDS_IN_ROW = 32;
   public static final int MODULES_IN_CODEWORD = 17;
   public static final int MODULES_IN_STOP_PATTERN = 18;
   public static final int BARS_IN_MODULE = 8;

File: core/src/com/google/zxing/pdf417/decoder/BoundingBox.java
Patch:
@@ -131,6 +131,7 @@ private void calculateMinMaxValues() {
     maxY = (int) Math.max(bottomLeft.getY(), bottomRight.getY());
   }
 
+  /*
   void setTopRight(ResultPoint topRight) {
     this.topRight = topRight;
     calculateMinMaxValues();
@@ -140,6 +141,7 @@ void setBottomRight(ResultPoint bottomRight) {
     this.bottomRight = bottomRight;
     calculateMinMaxValues();
   }
+   */
 
   int getMinX() {
     return minX;

File: core/src/com/google/zxing/pdf417/decoder/DetectionResultColumn.java
Patch:
@@ -61,9 +61,11 @@ final int imageRowToCodewordIndex(int imageRow) {
     return imageRow - boundingBox.getMinY();
   }
 
+  /*
   final int codewordIndexToImageRow(int codewordIndex) {
     return boundingBox.getMinY() + codewordIndex;
   }
+   */
 
   final void setCodeword(int imageRow, Codeword codeword) {
     codewords[imageRowToCodewordIndex(imageRow)] = codeword;

File: core/src/com/google/zxing/pdf417/encoder/BarcodeRow.java
Patch:
@@ -63,9 +63,11 @@ void addBar(boolean black, int width) {
     }
   }
 
+  /*
   byte[] getRow() {
     return row;
   }
+   */
 
   /**
    * This function scales the row

File: core/src/com/google/zxing/pdf417/encoder/PDF417HighLevelEncoder.java
Patch:
@@ -404,8 +404,7 @@ private static void encodeNumeric(String msg, int startpos, int count, StringBui
       String part = '1' + msg.substring(startpos + idx, startpos + idx + len);
       BigInteger bigint = new BigInteger(part);
       do {
-        BigInteger c = bigint.mod(num900);
-        tmp.append((char) c.intValue());
+        tmp.append((char) bigint.mod(num900).intValue());
         bigint = bigint.divide(num900);
       } while (!bigint.equals(num0));
 

File: core/src/com/google/zxing/qrcode/detector/FinderPattern.java
Patch:
@@ -28,7 +28,7 @@
 public final class FinderPattern extends ResultPoint {
 
   private final float estimatedModuleSize;
-  private int count;
+  private final int count;
 
   FinderPattern(float posX, float posY, float estimatedModuleSize) {
     this(posX, posY, estimatedModuleSize, 1);
@@ -48,9 +48,11 @@ int getCount() {
     return count;
   }
 
+  /*
   void incrementCount() {
     this.count++;
   }
+   */
 
   /**
    * <p>Determines if this finder pattern "about equals" a finder pattern at the stated

File: core/src/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -434,7 +434,7 @@ private int findRowSkip() {
     if (max <= 1) {
       return 0;
     }
-    FinderPattern firstConfirmedCenter = null;
+    ResultPoint firstConfirmedCenter = null;
     for (FinderPattern center : possibleCenters) {
       if (center.getCount() >= CENTER_QUORUM) {
         if (firstConfirmedCenter == null) {

File: core/test/src/com/google/zxing/datamatrix/encoder/ErrorCorrectionTestCase.java
Patch:
@@ -29,7 +29,7 @@ public void testRS() {
     //Sample from Annexe R in ISO/IEC 16022:2000(E)
     char[] cw = {142, 164, 186};
     SymbolInfo symbolInfo = SymbolInfo.lookup(3);
-    String s = ErrorCorrection.encodeECC200(String.valueOf(cw), symbolInfo);
+    CharSequence s = ErrorCorrection.encodeECC200(String.valueOf(cw), symbolInfo);
     assertEquals("142 164 186 114 25 5 88 102", HighLevelEncodeTestCase.visualize(s));
 
     //"A" encoded (ASCII encoding + 2 padding characters)

File: core/test/src/com/google/zxing/datamatrix/encoder/HighLevelEncodeTestCase.java
Patch:
@@ -353,7 +353,7 @@ public void testDataURL() {
    */
 
   private static String encodeHighLevel(String msg) {
-    String encoded = HighLevelEncoder.encodeHighLevel(msg);
+    CharSequence encoded = HighLevelEncoder.encodeHighLevel(msg);
     //DecodeHighLevel.decode(encoded);
     return visualize(encoded);
   }

File: core/test/src/com/google/zxing/oned/CodaBarWriterTestCase.java
Patch:
@@ -31,7 +31,7 @@ public final class CodaBarWriterTestCase extends Assert {
   public void testEncode() throws WriterException {
     // 1001001011 0 110101001 0 101011001 0 110101001 0 101001101 0 110010101 0 1101101011 0
     // 1001001011
-    String resultStr = "0000000000" +
+    CharSequence resultStr = "0000000000" +
         "1001001011011010100101010110010110101001010100110101100101010110110101101001001011"
         + "0000000000";
     BitMatrix result = new CodaBarWriter().encode("B515-3/B", BarcodeFormat.CODABAR, resultStr.length(), 0);

File: core/test/src/com/google/zxing/oned/EAN13WriterTestCase.java
Patch:
@@ -29,7 +29,7 @@ public final class EAN13WriterTestCase extends Assert {
 
   @Test
   public void testEncode() throws WriterException {
-    String testStr = "00010100010110100111011001100100110111101001110101010110011011011001000010101110010011101000100101000";
+    CharSequence testStr = "00010100010110100111011001100100110111101001110101010110011011011001000010101110010011101000100101000";
     BitMatrix result = new EAN13Writer().encode("5901234123457", BarcodeFormat.EAN_13, testStr.length(), 0);
     for (int i = 0; i < testStr.length(); i++) {
       assertEquals("Element " + i,  testStr.charAt(i) == '1', result.get(i, 0));

File: core/test/src/com/google/zxing/oned/EAN8WriterTestCase.java
Patch:
@@ -29,7 +29,7 @@ public final class EAN8WriterTestCase extends Assert {
 
   @Test
   public void testEncode() throws WriterException {
-    String testStr = "0001010001011010111101111010110111010101001110111001010001001011100101000";
+    CharSequence testStr = "0001010001011010111101111010110111010101001110111001010001001011100101000";
     BitMatrix result = new EAN8Writer().encode("96385074", BarcodeFormat.EAN_8, testStr.length(), 0);
     for (int i = 0; i < testStr.length(); i++) {
       assertEquals("Element " + i, testStr.charAt(i) == '1', result.get(i, 0));

File: core/test/src/com/google/zxing/oned/UPCAWriterTestCase.java
Patch:
@@ -30,7 +30,7 @@ public final class UPCAWriterTestCase extends Assert {
 
   @Test
   public void testEncode() throws WriterException {
-    String testStr = "00010101000110110111011000100010110101111011110101010111001011101001001110110011011011001011100101000";
+    CharSequence testStr = "00010101000110110111011000100010110101111011110101010111001011101001001110110011011011001011100101000";
     BitMatrix result = new UPCAWriter().encode("485963095124", BarcodeFormat.UPC_A, testStr.length(), 0);
     for (int i = 0; i < testStr.length(); i++) {
       assertEquals("Element " + i,  testStr.charAt(i) == '1', result.get(i, 0));
@@ -39,7 +39,7 @@ public void testEncode() throws WriterException {
 
   @Test
   public void testAddChecksumAndEncode() throws WriterException {
-    String testStr = "00010100110010010011011110101000110110001010111101010100010010010001110100111001011001101101100101000";
+    CharSequence testStr = "00010100110010010011011110101000110110001010111101010100010010010001110100111001011001101101100101000";
     BitMatrix result = new UPCAWriter().encode("12345678901", BarcodeFormat.UPC_A, testStr.length(), 0);
     for (int i = 0; i < testStr.length(); i++) {
       assertEquals("Element " + i,  testStr.charAt(i) == '1', result.get(i, 0));

File: core/test/src/com/google/zxing/oned/rss/expanded/BinaryUtil.java
Patch:
@@ -46,7 +46,7 @@ private BinaryUtil() {
   * Constructs a BitArray from a String like the one returned from BitArray.toString()
   */
   public static BitArray buildBitArrayFromString(CharSequence data) {
-    String dotsAndXs = ZERO.matcher(ONE.matcher(data).replaceAll("X")).replaceAll(".");
+    CharSequence dotsAndXs = ZERO.matcher(ONE.matcher(data).replaceAll("X")).replaceAll(".");
     BitArray binary = new BitArray(SPACE.matcher(dotsAndXs).replaceAll("").length());
     int counter = 0;
 
@@ -69,7 +69,7 @@ public static BitArray buildBitArrayFromString(CharSequence data) {
 
   public static BitArray buildBitArrayFromStringWithoutSpaces(CharSequence data) {
     StringBuilder sb = new StringBuilder();
-    String dotsAndXs = ZERO.matcher(ONE.matcher(data).replaceAll("X")).replaceAll(".");
+    CharSequence dotsAndXs = ZERO.matcher(ONE.matcher(data).replaceAll("X")).replaceAll(".");
     int current = 0;
     while (current < dotsAndXs.length()) {
       sb.append(' ');

File: core/test/src/com/google/zxing/oned/rss/expanded/BinaryUtilTest.java
Patch:
@@ -43,7 +43,7 @@ public final class BinaryUtilTest extends Assert {
   @Test
   public void testBuildBitArrayFromString(){
 
-    String data = " ..X..X.. ..XXX... XXXXXXXX ........";
+    CharSequence data = " ..X..X.. ..XXX... XXXXXXXX ........";
     check(data);
 
     data = " XXX..X..";
@@ -66,7 +66,7 @@ private static void check(CharSequence data){
 
   @Test
   public void testBuildBitArrayFromStringWithoutSpaces(){
-    String data = " ..X..X.. ..XXX... XXXXXXXX ........";
+    CharSequence data = " ..X..X.. ..XXX... XXXXXXXX ........";
     checkWithoutSpaces(data);
 
     data = " XXX..X..";
@@ -83,7 +83,7 @@ public void testBuildBitArrayFromStringWithoutSpaces(){
   }
 
   private static void checkWithoutSpaces(CharSequence data){
-    String dataWithoutSpaces = SPACE.matcher(data).replaceAll("");
+    CharSequence dataWithoutSpaces = SPACE.matcher(data).replaceAll("");
     BitArray binary = BinaryUtil.buildBitArrayFromStringWithoutSpaces(dataWithoutSpaces);
     assertEquals(data, binary.toString());
   }

File: core/test/src/com/google/zxing/oned/rss/expanded/RSSExpandedStackedInternalTestCase.java
Patch:
@@ -28,6 +28,7 @@
 
 import java.util.List;
 
+import com.google.zxing.oned.OneDReader;
 import org.junit.Assert;
 import org.junit.Test;
 
@@ -73,7 +74,7 @@ public void testDecodingRowByRow() throws Exception {
 	
 	@Test
 	public void testCompleteDecode() throws Exception {
-    RSSExpandedReader rssExpandedReader = new RSSExpandedReader();
+    OneDReader rssExpandedReader = new RSSExpandedReader();
 
     BinaryBitmap binaryMap = TestCaseUtil.getBinaryBitmap("test/data/blackbox/rssexpandedstacked-2/1000.png");
 

File: core/test/src/com/google/zxing/oned/rss/expanded/decoders/AI01_3103_DecoderTest.java
Patch:
@@ -38,21 +38,21 @@ public final class AI01_3103_DecoderTest extends AbstractDecoderTest {
 
   @Test
 	public void test01_3103_1() throws Exception {
-		String data = header + compressedGtin_900123456798908 + compressed15bitWeight_1750;
+		CharSequence data = header + compressedGtin_900123456798908 + compressed15bitWeight_1750;
 		String expected = "(01)90012345678908(3103)001750";
 		assertCorrectBinaryString(data, expected);
 	}
 
   @Test
 	public void test01_3103_2() throws Exception {
-		String data = header + compressedGtin_900000000000008 + compressed15bitWeight_0;
+		CharSequence data = header + compressedGtin_900000000000008 + compressed15bitWeight_0;
 		String expected = "(01)90000000000003(3103)000000";
 		assertCorrectBinaryString(data, expected);
 	}
 
   @Test(expected = NotFoundException.class)
 	public void test01_3103_invalid() throws Exception {
-    String data = header + compressedGtin_900123456798908 + compressed15bitWeight_1750 + "..";
+    CharSequence data = header + compressedGtin_900123456798908 + compressed15bitWeight_1750 + "..";
     assertCorrectBinaryString(data, "");
 	}
 }

File: core/test/src/com/google/zxing/oned/rss/expanded/decoders/AI01_3202_3203_DecoderTest.java
Patch:
@@ -37,15 +37,15 @@ public final class AI01_3202_3203_DecoderTest extends AbstractDecoderTest {
 
   @Test
 	public void test01_3202_1() throws Exception {
-		String data = header + compressedGtin_900123456798908 + compressed15bitWeight_1750;
+		CharSequence data = header + compressedGtin_900123456798908 + compressed15bitWeight_1750;
 		String expected = "(01)90012345678908(3202)001750";
 		
 		assertCorrectBinaryString(data, expected);
 	}
 
   @Test
 	public void test01_3203_1() throws Exception {
-		String data = header + compressedGtin_900123456798908 + compressed15bitWeight_11750;
+		CharSequence data = header + compressedGtin_900123456798908 + compressed15bitWeight_11750;
 		String expected = "(01)90012345678908(3203)001750";
 		
 		assertCorrectBinaryString(data, expected);

File: core/test/src/com/google/zxing/oned/rss/expanded/decoders/AbstractDecoderTest.java
Patch:
@@ -40,7 +40,7 @@ public abstract class AbstractDecoderTest extends Assert {
 	protected static final String numeric_10                     = "..X..XX";
 	protected static final String numeric_12                     = "..X.X.X";
 	protected static final String numeric_1FNC1                  = "..XXX.X";
-	protected static final String numeric_FNC11                  = "XXX.XXX";
+	//protected static final String numeric_FNC11                  = "XXX.XXX";
 	                                                             
 	protected static final String numeric2alpha                  = "....";
 	                                                             

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox4TestCase.java
Patch:
@@ -98,7 +98,7 @@ public SummaryResults testPDF417BlackBoxCountingResults(boolean assertOnFailure)
       log.fine(String.format("Starting Image Group %s", testImageGroup.getKey()));
 
       String fileBaseName = testImageGroup.getKey();
-      String expectedText = null;
+      String expectedText;
       File expectedTextFile = new File(testBase, fileBaseName + ".txt");
       if (expectedTextFile.exists()) {
         expectedText = readFileAsString(expectedTextFile, UTF8);

File: javase/src/com/google/zxing/StringsResourceTranslator.java
Patch:
@@ -111,7 +111,7 @@ private static void translate(File englishFile,
                                 File translatedFile,
                                 Collection<String> forceRetranslation) throws IOException {
 
-    SortedMap<String,String> english = readLines(englishFile);
+    Map<String, String> english = readLines(englishFile);
     SortedMap<String,String> translated = readLines(translatedFile);
     String parentName = translatedFile.getParentFile().getName();
 
@@ -226,7 +226,7 @@ private static SortedMap<String,String> readLines(File file) throws IOException
       return entries;
     }
     try (BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(file), UTF8))) {
-      String line;
+      CharSequence line;
       while ((line = reader.readLine()) != null) {
         Matcher m = ENTRY_PATTERN.matcher(line);
         if (m.find()) {

File: javase/src/com/google/zxing/client/j2se/GUIRunner.java
Patch:
@@ -39,6 +39,7 @@
 import javax.swing.JPanel;
 import javax.swing.JTextArea;
 import javax.swing.WindowConstants;
+import javax.swing.text.JTextComponent;
 
 /**
  * <p>Simple GUI frontend to the library. Right now, only decodes a local file.
@@ -49,7 +50,7 @@
 public final class GUIRunner extends JFrame {
 
   private final JLabel imageLabel;
-  private final JTextArea textArea;
+  private final JTextComponent textArea;
 
   private GUIRunner() {
     imageLabel = new JLabel();

File: zxingorg/src/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -140,7 +140,7 @@ protected void doGet(HttpServletRequest request,
     }
 
     imageURIString = imageURIString.trim();
-    for (String substring : blockedURLSubstrings) {
+    for (CharSequence substring : blockedURLSubstrings) {
       if (imageURIString.contains(substring)) {
         log.info("Disallowed URI " + imageURIString);        
         response.sendRedirect("badurl.jspx");
@@ -326,14 +326,14 @@ private static void processImage(BufferedImage image,
                                    ServletRequest request,
                                    HttpServletResponse response) throws IOException, ServletException {
 
-    Reader reader = new MultiFormatReader();
     LuminanceSource source = new BufferedImageLuminanceSource(image);
     BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
     Collection<Result> results = new ArrayList<>(1);
-    ReaderException savedException = null;
 
     try {
 
+      Reader reader = new MultiFormatReader();
+      ReaderException savedException = null;
       try {
         // Look for multiple barcodes
         MultipleBarcodeReader multiReader = new GenericMultipleBarcodeReader(reader);

File: zxingorg/src/com/google/zxing/web/OutputUtils.java
Patch:
@@ -48,7 +48,7 @@ public static String arrayToString(byte[] bytes) {
     return result.toString();
   }
   
-  public static char hexChar(int value) {
+  private static char hexChar(int value) {
     if (value < 0 || value > 15) {
       throw new IllegalArgumentException();
     }

File: core/src/com/google/zxing/datamatrix/decoder/DecodedBitStreamParser.java
Patch:
@@ -72,7 +72,7 @@ private enum Mode {
   };
 
   private static final char[] TEXT_SHIFT3_SET_CHARS = {
-    '\'', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N',
+    '`', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N',
     'O',  'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '{', '|', '}', '~', (char) 127
   };
 

File: core/src/com/google/zxing/pdf417/encoder/BarcodeMatrix.java
Patch:
@@ -33,14 +33,14 @@ public final class BarcodeMatrix {
    * @param width  the width of the matrix (Cols)
    */
   BarcodeMatrix(int height, int width) {
-    matrix = new BarcodeRow[height + 2];
+    matrix = new BarcodeRow[height];
     //Initializes the array to the correct width
     for (int i = 0, matrixLength = matrix.length; i < matrixLength; i++) {
       matrix[i] = new BarcodeRow((width + 4) * 17 + 1);
     }
     this.width = width * 17;
-    this.height = height + 2;
-    this.currentRow = 0;
+    this.height = height;
+    this.currentRow = -1;
   }
 
   void set(int x, int y, byte value) {

File: core/src/com/google/zxing/client/result/URIResultParser.java
Patch:
@@ -28,10 +28,9 @@
  */
 public final class URIResultParser extends ResultParser {
 
-  private static final String ALPHANUM_PART = "[a-zA-Z0-9\\-]";
   private static final Pattern URL_WITH_PROTOCOL_PATTERN = Pattern.compile("[a-zA-Z0-9]{2,}:");
   private static final Pattern URL_WITHOUT_PROTOCOL_PATTERN = Pattern.compile(
-      '(' + ALPHANUM_PART + "+\\.)+" + ALPHANUM_PART + "{2,}" + // host name elements
+      "([a-zA-Z0-9\\-]+\\.)+[a-zA-Z]{2,}" + // host name elements
       "(:\\d{1,5})?" + // maybe port
       "(/|\\?|$)"); // query, path or nothing
 

File: core/test/src/com/google/zxing/client/result/URIParsedResultTestCase.java
Patch:
@@ -38,6 +38,7 @@ public void testBookmarkDocomo() {
   @Test
   public void testURI() {
     doTest("google.com", "http://google.com", null);
+    doTest("123.com", "http://123.com", null);
     doTest("http://google.com", "http://google.com", null);
     doTest("https://google.com", "https://google.com", null);
     doTest("google.com:443", "http://google.com:443", null);
@@ -58,6 +59,8 @@ public void testNotURI() {
     doTestNotUri(":80/");
     doTestNotUri("ABC,20.3,AB,AD");
     doTestNotUri("http://google.com?q=foo bar");
+    doTestNotUri("12756.501");
+    doTestNotUri("google.50");
   }
 
   @Test

File: android/src/com/google/zxing/client/android/DecodeHintManager.java
Patch:
@@ -172,7 +172,7 @@ static Map<DecodeHintType,?> parseDecodeHints(Uri inputUri) {
       if (hintType.getValueType().equals(int[].class)) {
         // An integer array. Used to specify valid lengths.
         // Strip a trailing comma as in Java style array initialisers.
-        if (parameterText.length() > 0 && parameterText.charAt(parameterText.length() - 1) == ',') {
+        if (!parameterText.isEmpty() && parameterText.charAt(parameterText.length() - 1) == ',') {
           parameterText = parameterText.substring(0, parameterText.length() - 1);
         }
         String[] values = COMMA.split(parameterText);

File: android/src/com/google/zxing/client/android/share/ShareActivity.java
Patch:
@@ -98,7 +98,7 @@ public void onClick(View v) {
     public boolean onKey(View view, int keyCode, KeyEvent event) {
       if (keyCode == KeyEvent.KEYCODE_ENTER && event.getAction() == KeyEvent.ACTION_DOWN) {
         String text = ((TextView) view).getText().toString();
-        if (text != null && text.length() > 0) {
+        if (text != null && !text.isEmpty()) {
           launchSearch(text);
         }
         return true;

File: core/test/src/com/google/zxing/oned/CodaBarWriterTestCase.java
Patch:
@@ -34,7 +34,7 @@ public void testEncode() throws WriterException {
     String resultStr = "0000000000" +
         "1001001011011010100101010110010110101001010100110101100101010110110101101001001011"
         + "0000000000";
-    BitMatrix result = new CodaBarWriter().encode("B515-3/N", BarcodeFormat.CODABAR, resultStr.length(), 0);
+    BitMatrix result = new CodaBarWriter().encode("B515-3/B", BarcodeFormat.CODABAR, resultStr.length(), 0);
     for (int i = 0; i < resultStr.length(); i++) {
       assertEquals("Element " + i, resultStr.charAt(i) == '1', result.get(i, 0));
     }

File: core/src/com/google/zxing/aztec/AztecWriter.java
Patch:
@@ -37,8 +37,8 @@ public BitMatrix encode(String contents, BarcodeFormat format, int width, int he
 
   @Override
   public BitMatrix encode(String contents, BarcodeFormat format, int width, int height, Map<EncodeHintType,?> hints) {
-    String charset = (String) hints.get(EncodeHintType.CHARACTER_SET);
-    Number eccPercent = (Number) hints.get(EncodeHintType.ERROR_CORRECTION);
+    String charset = hints == null ? null : (String) hints.get(EncodeHintType.CHARACTER_SET);
+    Number eccPercent = hints == null ? null : (Number) hints.get(EncodeHintType.ERROR_CORRECTION);
     return encode(contents, 
                   format, 
                   charset == null ? DEFAULT_CHARSET : Charset.forName(charset),

File: core/src/com/google/zxing/oned/ITFReader.java
Patch:
@@ -45,7 +45,7 @@
 public final class ITFReader extends OneDReader {
 
   private static final int MAX_AVG_VARIANCE = (int) (PATTERN_MATCH_RESULT_SCALE_FACTOR * 0.42f);
-  private static final int MAX_INDIVIDUAL_VARIANCE = (int) (PATTERN_MATCH_RESULT_SCALE_FACTOR * 0.8f);
+  private static final int MAX_INDIVIDUAL_VARIANCE = (int) (PATTERN_MATCH_RESULT_SCALE_FACTOR * 0.78f);
 
   private static final int W = 3; // Pixel width of a wide line
   private static final int N = 1; // Pixed width of a narrow line

File: core/test/src/com/google/zxing/oned/ITFBlackBox1TestCase.java
Patch:
@@ -27,8 +27,8 @@ public final class ITFBlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public ITFBlackBox1TestCase() {
     super("test/data/blackbox/itf-1", new MultiFormatReader(), BarcodeFormat.ITF);
-    addTest(8, 12, 0.0f);
-    addTest(11, 12, 180.0f);
+    addTest(9, 13, 0.0f);
+    addTest(12, 13, 180.0f);
   }
 
 }

File: core/test/src/com/google/zxing/common/AbstractBlackBoxTestCase.java
Patch:
@@ -114,7 +114,7 @@ protected final void addTest(int mustPassCount,
   }
 
   protected final File[] getImageFiles() {
-    assertTrue("Please run from the 'core' directory", testBase.exists());
+    assertTrue("Please download and install test images, and run from the 'core' directory", testBase.exists());
     return testBase.listFiles(IMAGE_NAME_FILTER);
   }
 

File: core/test/src/com/google/zxing/qrcode/QRCodeWriterTestCase.java
Patch:
@@ -45,7 +45,7 @@ private static BufferedImage loadImage(String fileName) throws IOException {
       // try starting with 'core' since the test base is often given as the project root
       file = new File("core/" + BASE_IMAGE_PATH + fileName);
     }
-    assertTrue("Please run from the 'core' directory", file.exists());
+    assertTrue("Please download and install test images, and run from the 'core' directory", file.exists());
     return ImageIO.read(file);
   }
 

File: core/src/com/google/zxing/datamatrix/DataMatrixReader.java
Patch:
@@ -97,7 +97,6 @@ public void reset() {
    * around it. This is a specialized method that works exceptionally fast in this special
    * case.
    *
-   * @see com.google.zxing.pdf417.PDF417Reader#extractPureBits(BitMatrix)
    * @see com.google.zxing.qrcode.QRCodeReader#extractPureBits(BitMatrix)
    */
   private static BitMatrix extractPureBits(BitMatrix image) throws NotFoundException {

File: core/src/com/google/zxing/maxicode/MaxiCodeReader.java
Patch:
@@ -92,7 +92,6 @@ public void reset() {
    * around it. This is a specialized method that works exceptionally fast in this special
    * case.
    *
-   * @see com.google.zxing.pdf417.PDF417Reader#extractPureBits(BitMatrix)
    * @see com.google.zxing.datamatrix.DataMatrixReader#extractPureBits(BitMatrix)
    * @see com.google.zxing.qrcode.QRCodeReader#extractPureBits(BitMatrix)
    */

File: core/src/com/google/zxing/pdf417/decoder/PDF417ScanningDecoder.java
Patch:
@@ -187,10 +187,10 @@ private static int getMax(int[] values) {
   private static BarcodeMetadata getBarcodeMetadata(DetectionResultRowIndicatorColumn leftRowIndicatorColumn,
                                                     DetectionResultRowIndicatorColumn rightRowIndicatorColumn) {
     if (leftRowIndicatorColumn == null || leftRowIndicatorColumn.getBarcodeMetadata() == null) {
-      return rightRowIndicatorColumn.getBarcodeMetadata();
+      return rightRowIndicatorColumn == null ? null : rightRowIndicatorColumn.getBarcodeMetadata();
     }
     if (rightRowIndicatorColumn == null || rightRowIndicatorColumn.getBarcodeMetadata() == null) {
-      return leftRowIndicatorColumn.getBarcodeMetadata();
+      return leftRowIndicatorColumn == null ? null : leftRowIndicatorColumn.getBarcodeMetadata();
     }
     BarcodeMetadata leftBarcodeMetadata = leftRowIndicatorColumn.getBarcodeMetadata();
     BarcodeMetadata rightBarcodeMetadata = rightRowIndicatorColumn.getBarcodeMetadata();

File: core/src/com/google/zxing/multi/GenericMultipleBarcodeReader.java
Patch:
@@ -162,8 +162,9 @@ private static Result translateResultPoints(Result result, int xOffset, int yOff
       ResultPoint oldPoint = oldResultPoints[i];
       newResultPoints[i] = new ResultPoint(oldPoint.getX() + xOffset, oldPoint.getY() + yOffset);
     }
-    return new Result(result.getText(), result.getRawBytes(), newResultPoints,
-        result.getBarcodeFormat());
+    Result newResult = new Result(result.getText(), result.getRawBytes(), newResultPoints, result.getBarcodeFormat());
+    newResult.putAllMetadata(result.getResultMetadata());
+    return newResult;
   }
 
 }

File: core/src/com/google/zxing/qrcode/encoder/MaskUtil.java
Patch:
@@ -208,7 +208,7 @@ private static int applyMaskPenaltyRule1Internal(ByteMatrix matrix, boolean isHo
           prevBit = bit;
         }
       }
-      if (numSameBitCells > 5) {
+      if (numSameBitCells >= 5) {
         penalty += N1 + (numSameBitCells - 5);
       }
     }

File: android/src/com/google/zxing/client/android/encode/ContactEncoder.java
Patch:
@@ -36,7 +36,7 @@ abstract String[] encode(Iterable<String> names,
                            Iterable<String> addresses,
                            Iterable<String> phones,
                            Iterable<String> emails,
-                           String url,
+                           Iterable<String> urls,
                            String note);
 
   /**
@@ -78,7 +78,7 @@ static void doAppendUpToUnique(StringBuilder newContents,
     Collection<String> uniques = new HashSet<String>(2);
     for (String value : values) {
       String trimmed = trim(value);
-      if (trimmed != null && !uniques.contains(trimmed)) {
+      if (trimmed != null && trimmed.length() > 0 && !uniques.contains(trimmed)) {
         newContents.append(prefix).append(':').append(fieldFormatter.format(trimmed)).append(terminator);
         String display = formatter == null ? trimmed : formatter.format(trimmed);
         newDisplayContents.append(display).append('\n');

File: android/src/com/google/zxing/client/android/encode/MECARDContactEncoder.java
Patch:
@@ -44,7 +44,7 @@ public String[] encode(Iterable<String> names,
                          Iterable<String> addresses,
                          Iterable<String> phones,
                          Iterable<String> emails,
-                         String url,
+                         Iterable<String> urls,
                          String note) {
     StringBuilder newContents = new StringBuilder(100);
     newContents.append("MECARD:");
@@ -64,7 +64,7 @@ public String format(String source) {
       }
     });
     appendUpToUnique(newContents, newDisplayContents, "EMAIL", emails, Integer.MAX_VALUE, null);
-    append(newContents, newDisplayContents, "URL", url);
+    appendUpToUnique(newContents, newDisplayContents, "URL", urls, Integer.MAX_VALUE, null);
     append(newContents, newDisplayContents, "NOTE", note);
     newContents.append(';');
     return new String[] { newContents.toString(), newDisplayContents.toString() };

File: android/src/com/google/zxing/client/android/encode/QRCodeEncoder.java
Patch:
@@ -259,6 +259,7 @@ private void encodeQRCodeContents(Intent intent, String type) {
           emails.add(bundle.getString(Contents.EMAIL_KEYS[x]));
         }
         String url = bundle.getString(Contents.URL_KEY);
+        Collection<String> urls = url == null ? null : Collections.singletonList(url);
         String note = bundle.getString(Contents.NOTE_KEY);
 
         ContactEncoder mecardEncoder = useVCard ? new VCardContactEncoder() : new MECARDContactEncoder();
@@ -267,7 +268,7 @@ private void encodeQRCodeContents(Intent intent, String type) {
                                                 Collections.singleton(address),
                                                 phones,
                                                 emails,
-                                                url,
+                                                urls,
                                                 note);
         // Make sure we've encoded at least one field.
         if (encoded[1].length() > 0) {
@@ -300,7 +301,7 @@ private void encodeQRCodeContents(AddressBookParsedResult contact) {
                                       toIterable(contact.getAddresses()),
                                       toIterable(contact.getPhoneNumbers()),
                                       toIterable(contact.getEmails()),
-                                      contact.getURL(),
+                                      toIterable(contact.getURLs()),
                                       null);
     // Make sure we've encoded at least one field.
     if (encoded[1].length() > 0) {

File: android/src/com/google/zxing/client/android/encode/VCardContactEncoder.java
Patch:
@@ -43,7 +43,7 @@ public String[] encode(Iterable<String> names,
                          Iterable<String> addresses,
                          Iterable<String> phones,
                          Iterable<String> emails,
-                         String url,
+                         Iterable<String> urls,
                          String note) {
     StringBuilder newContents = new StringBuilder(100);
     newContents.append("BEGIN:VCARD").append(TERMINATOR);
@@ -59,7 +59,7 @@ public String format(String source) {
       }
     });
     appendUpToUnique(newContents, newDisplayContents, "EMAIL", emails, Integer.MAX_VALUE, null);
-    append(newContents, newDisplayContents, "URL", url);
+    appendUpToUnique(newContents, newDisplayContents, "URL", urls, Integer.MAX_VALUE, null);
     append(newContents, newDisplayContents, "NOTE", note);
     newContents.append("END:VCARD").append(TERMINATOR);
     return new String[] { newContents.toString(), newDisplayContents.toString() };

File: android/src/com/google/zxing/client/android/result/AddressBookResultHandler.java
Patch:
@@ -135,7 +135,7 @@ public void handleButtonPress(int index) {
                    address1Type,
                    addressResult.getOrg(),
                    addressResult.getTitle(),
-                   addressResult.getURL(),
+                   addressResult.getURLs(),
                    addressResult.getBirthday(),
                    addressResult.getGeo());
         break;
@@ -191,7 +191,7 @@ public CharSequence getDisplayContents() {
       }
     }
     ParsedResult.maybeAppend(result.getEmails(), contents);
-    ParsedResult.maybeAppend(result.getURL(), contents);
+    ParsedResult.maybeAppend(result.getURLs(), contents);
 
     String birthday = result.getBirthday();
     if (birthday != null && birthday.length() > 0) {

File: core/src/com/google/zxing/client/result/AddressBookDoCoMoResultParser.java
Patch:
@@ -56,7 +56,7 @@ public AddressBookParsedResult parse(Result result) {
       // No reason to throw out the whole card because the birthday is formatted wrong.
       birthday = null;
     }
-    String url = matchSingleDoCoMoPrefixedField("URL:", rawText, true);
+    String[] urls = matchDoCoMoPrefixedField("URL:", rawText, true);
 
     // Although ORG may not be strictly legal in MECARD, it does exist in VCARD and we might as well
     // honor it when found in the wild.
@@ -76,7 +76,7 @@ public AddressBookParsedResult parse(Result result) {
                                        org,
                                        birthday,
                                        null,
-                                       url,
+                                       urls,
                                        null);
   }
 

File: core/src/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -230,7 +230,9 @@ static String[] matchPrefixedField(String prefix, String rawText, char endChar,
           if (trim) {
             element = element.trim();
           }
-          matches.add(element);
+          if (element.length() > 0) {
+            matches.add(element);
+          }
           i++;
           more = false;
         }

File: core/test/src/com/google/zxing/client/result/CalendarParsedResultTestCase.java
Patch:
@@ -24,7 +24,6 @@
 
 import java.text.DateFormat;
 import java.text.SimpleDateFormat;
-import java.util.Arrays;
 import java.util.Locale;
 import java.util.TimeZone;
 
@@ -223,8 +222,7 @@ private static void doTest(String contents,
     assertEquals(startString, DATE_TIME_FORMAT.format(calResult.getStart()));
     assertEquals(endString, calResult.getEnd() == null ? null : DATE_TIME_FORMAT.format(calResult.getEnd()));
     assertEquals(organizer, calResult.getOrganizer());
-    assertTrue((attendees == null && calResult.getAttendees() == null) ||
-               Arrays.equals(attendees, calResult.getAttendees()));
+    assertArrayEquals(attendees, calResult.getAttendees());
     assertEqualOrNaN(latitude, calResult.getLatitude());
     assertEqualOrNaN(longitude, calResult.getLongitude());
   }

File: core/test/src/com/google/zxing/client/result/WifiParsedResultTestCase.java
Patch:
@@ -30,8 +30,8 @@ public final class WifiParsedResultTestCase extends Assert {
 
   @Test
   public void testNoPassword() {
-    doTest("WIFI:S:NoPassword;P:;T:;;", "NoPassword", "", "");
-    doTest("WIFI:S:No Password;P:;T:;;", "No Password", "", "");
+    doTest("WIFI:S:NoPassword;P:;T:;;", "NoPassword", null, "nopass");
+    doTest("WIFI:S:No Password;P:;T:;;", "No Password", null, "nopass");
   }
 
   @Test

File: core/src/com/google/zxing/client/result/WifiResultParser.java
Patch:
@@ -45,7 +45,7 @@ public WifiParsedResult parse(Result result) {
     if (type == null) {
       type = "nopass";
     }
-    boolean hidden = Boolean.parseBoolean(matchSinglePrefixedField("B:", rawText, ';', false));
+    boolean hidden = Boolean.parseBoolean(matchSinglePrefixedField("H:", rawText, ';', false));
     return new WifiParsedResult(type, ssid, pass, hidden);
   }
 }
\ No newline at end of file

File: core/src/com/google/zxing/client/result/ExpandedProductResultParser.java
Patch:
@@ -133,7 +133,8 @@ public ExpandedProductParsedResult parse(Result result) {
       }
     }
 
-    return new ExpandedProductParsedResult(productID,
+    return new ExpandedProductParsedResult(rawText,
+                                           productID,
                                            sscc,
                                            lotNumber,
                                            productionDate,

File: core/test/src/com/google/zxing/oned/rss/expanded/RSSExpandedImage2resultTestCase.java
Patch:
@@ -64,7 +64,8 @@ public void testDecodeRow2result_2() throws Exception {
     // (01)90012345678908(3103)001750
     String path = "test/data/blackbox/rssexpanded-1/2.jpg";
     ExpandedProductParsedResult expected =
-        new ExpandedProductParsedResult("90012345678908",
+        new ExpandedProductParsedResult("(01)90012345678908(3103)001750",
+                                        "90012345678908",
                                         null, null, null, null, null, null,
                                         "001750",
                                         ExpandedProductParsedResult.KILOGRAM,

File: core/src/com/google/zxing/oned/rss/expanded/decoders/FieldParser.java
Patch:
@@ -183,7 +183,8 @@ final class FieldParser {
     { "8100", 6},
     { "8101", 10},
     { "8102", 2},
-    { "8110", VARIABLE_LENGTH, 30},
+    { "8110", VARIABLE_LENGTH, 70},
+    { "8200", VARIABLE_LENGTH, 70},
   };
 
   private FieldParser() {

File: core/src/com/google/zxing/oned/rss/expanded/RSSExpandedReader.java
Patch:
@@ -404,7 +404,7 @@ DataCharacter decodeDataCharacter(BitArray row,
     if (leftChar) {
       recordPatternInReverse(row, pattern.getStartEnd()[0], counters);
     } else {
-      recordPattern(row, pattern.getStartEnd()[1] + 1, counters);
+      recordPattern(row, pattern.getStartEnd()[1], counters);
       // reverse it
       for (int i = 0, j = counters.length - 1; i < j; i++, j--) {
         int temp = counters[i];

File: core/test/src/com/google/zxing/oned/rss/expanded/RSSExpandedBlackBox2TestCase.java
Patch:
@@ -35,6 +35,6 @@ public final class RSSExpandedBlackBox2TestCase extends AbstractBlackBoxTestCase
   public RSSExpandedBlackBox2TestCase() {
     super("test/data/blackbox/rssexpanded-2", new MultiFormatReader(), BarcodeFormat.RSS_EXPANDED);
     addTest(21, 23, 0.0f);
-    addTest(19, 23, 180.0f);
+    addTest(21, 23, 180.0f);
   }
 }

File: core/test/src/com/google/zxing/oned/rss/RSS14BlackBox2TestCase.java
Patch:
@@ -27,7 +27,7 @@ public final class RSS14BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public RSS14BlackBox2TestCase() {
     super("test/data/blackbox/rss14-2", new MultiFormatReader(), BarcodeFormat.RSS_14);
-    addTest(3, 8, 1, 1, 0.0f);
+    addTest(4, 8, 1, 1, 0.0f);
     addTest(2, 8, 0, 1, 180.0f);
   }
 

File: core/src/com/google/zxing/client/result/VEventResultParser.java
Patch:
@@ -42,6 +42,7 @@ public CalendarParsedResult parse(Result result) {
       return null;
     }
     String end = matchSingleVCardPrefixedField("DTEND", rawText, true);
+    String duration = matchSingleVCardPrefixedField("DURATION", rawText, true);
     String location = matchSingleVCardPrefixedField("LOCATION", rawText, true);
     String organizer = stripMailto(matchSingleVCardPrefixedField("ORGANIZER", rawText, true));
 
@@ -73,6 +74,7 @@ public CalendarParsedResult parse(Result result) {
       return new CalendarParsedResult(summary,
                                       start,
                                       end,
+                                      duration,
                                       location,
                                       organizer,
                                       attendees,

File: android/src/com/google/zxing/client/android/CaptureActivityHandler.java
Patch:
@@ -112,8 +112,8 @@ public void handleMessage(Message message) {
           Log.d(TAG, "Using browser in package " + browserPackageName);
         }
 
-        // Needed for default Android browser only apparently
-        if ("com.android.browser".equals(browserPackageName)) {
+        // Needed for default Android browser / Chrome only apparently
+        if ("com.android.browser".equals(browserPackageName) || "com.android.chrome".equals(browserPackageName)) {
           intent.setPackage(browserPackageName);
           intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
           intent.putExtra(Browser.EXTRA_APPLICATION_ID, browserPackageName);

File: core/src/com/google/zxing/oned/UPCEANReader.java
Patch:
@@ -224,7 +224,7 @@ boolean checkChecksum(String s) throws ChecksumException, FormatException {
    * @return true iff string of digits passes the UPC/EAN checksum algorithm
    * @throws FormatException if the string does not contain only digits
    */
-  private static boolean checkStandardUPCEANChecksum(CharSequence s) throws FormatException {
+  static boolean checkStandardUPCEANChecksum(CharSequence s) throws FormatException {
     int length = s.length();
     if (length == 0) {
       return false;

File: android/src/com/google/zxing/client/android/common/PlatformSupportManager.java
Patch:
@@ -26,7 +26,7 @@
 
 /**
  * <p>Sometimes the application wants to access advanced functionality exposed by Android APIs that are only available
- * in later versions of the platform. While {@link Build.VERSION} can be used to determine the device's API level
+ * in later versions of the platform. While {@code Build.VERSION} can be used to determine the device's API level
  * and alter behavior accordingly, and it is possible to write code that uses both old and new APIs selectively,
  * such code would fail to load on older devices that do not have the new API methods.</p>
  *

File: android/src/com/google/zxing/client/android/book/SearchBookContentsActivity.java
Patch:
@@ -187,8 +187,8 @@ protected JSONObject doInBackground(String... args) {
         } else {
           uri = "http://www.google.com/books?vid=isbn" + theIsbn + "&jscmd=SearchWithinVolume2&q=" + theQuery;
         }
-        String content = HttpHelper.downloadViaHttp(uri, HttpHelper.ContentType.JSON);
-        return new JSONObject(content);
+        CharSequence content = HttpHelper.downloadViaHttp(uri, HttpHelper.ContentType.JSON);
+        return new JSONObject(content.toString());
       } catch (IOException ioe) {
         Log.w(TAG, "Error accessing book search", ioe);
         return null;

File: android/src/com/google/zxing/client/android/result/supplement/BookResultInfoRetriever.java
Patch:
@@ -52,8 +52,8 @@ final class BookResultInfoRetriever extends SupplementalInfoRetriever {
   @Override
   void retrieveSupplementalInfo() throws IOException {
 
-    String contents = HttpHelper.downloadViaHttp("https://www.googleapis.com/books/v1/volumes?q=isbn:" + isbn,
-                                                 HttpHelper.ContentType.JSON);
+    CharSequence contents = HttpHelper.downloadViaHttp("https://www.googleapis.com/books/v1/volumes?q=isbn:" + isbn,
+                                                       HttpHelper.ContentType.JSON);
 
     if (contents.length() == 0) {
       return;
@@ -65,7 +65,7 @@ void retrieveSupplementalInfo() throws IOException {
 
     try {
 
-      JSONObject topLevel = (JSONObject) new JSONTokener(contents).nextValue();
+      JSONObject topLevel = (JSONObject) new JSONTokener(contents.toString()).nextValue();
       JSONArray items = topLevel.optJSONArray("items");
       if (items == null || items.isNull(0)) {
         return;

File: android/src/com/google/zxing/client/android/result/supplement/ProductResultInfoRetriever.java
Patch:
@@ -53,7 +53,7 @@ void retrieveSupplementalInfo() throws IOException {
     String encodedProductID = URLEncoder.encode(productID, "UTF-8");
     String uri = "http://www.google." + LocaleManager.getProductSearchCountryTLD(context)
             + "/m/products?ie=utf8&oe=utf8&scoring=p&source=zxing&q=" + encodedProductID;
-    String content = HttpHelper.downloadViaHttp(uri, HttpHelper.ContentType.HTML);
+    CharSequence content = HttpHelper.downloadViaHttp(uri, HttpHelper.ContentType.HTML);
 
     for (Pattern p : PRODUCT_NAME_PRICE_PATTERNS) {
       Matcher matcher = p.matcher(content);

File: android/src/com/google/zxing/client/android/result/supplement/SupplementalInfoRetriever.java
Patch:
@@ -50,6 +50,7 @@ public static void maybeInvokeRetrieval(TextView textView,
     AsyncTaskExecInterface taskExec = new AsyncTaskExecManager().build();
     if (result instanceof URIParsedResult) {
       taskExec.execute(new URIResultInfoRetriever(textView, (URIParsedResult) result, historyManager, context));
+      taskExec.execute(new TitleRetriever(textView, (URIParsedResult) result, historyManager));
     } else if (result instanceof ProductParsedResult) {
       String productID = ((ProductParsedResult) result).getProductID();
       taskExec.execute(new ProductResultInfoRetriever(textView, productID, historyManager, context));

File: core/src/com/google/zxing/aztec/decoder/Decoder.java
Patch:
@@ -168,7 +168,6 @@ private String getEncodedData(boolean[] correctedBits) throws FormatException {
       } else {
         if (table == Table.BINARY) {
           if (endIndex - startIndex < 8) {
-            end = true;
             break;
           }
           code = readCode(correctedBits, startIndex, 8);
@@ -184,7 +183,6 @@ private String getEncodedData(boolean[] correctedBits) throws FormatException {
           }
 
           if (endIndex - startIndex < size) {
-            end = true;
             break;
           }
 

File: android/src/com/google/zxing/client/android/common/executor/DefaultAsyncTaskExecInterface.java
Patch:
@@ -26,7 +26,7 @@ public final class DefaultAsyncTaskExecInterface implements AsyncTaskExecInterfa
 
   @Override
   public <T> void execute(AsyncTask<T,?,?> task, T... args) {
-    task.execute();
+    task.execute(args);
   }
 
 }

File: android/src/com/google/zxing/client/android/camera/AutoFocusManager.java
Patch:
@@ -59,6 +59,7 @@ final class AutoFocusManager implements Camera.AutoFocusCallback {
   public synchronized void onAutoFocus(boolean success, Camera theCamera) {
     if (active) {
       outstandingTask = new AutoFocusTask();
+      outstandingTask.execute();
     }
   }
 

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -563,7 +563,6 @@ private void handleDecodeInternally(Result rawResult, ResultHandler resultHandle
         PreferencesActivity.KEY_SUPPLEMENTAL, true)) {
       SupplementalInfoRetriever.maybeInvokeRetrieval(supplementTextView,
                                                      resultHandler.getResult(),
-                                                     handler,
                                                      historyManager,
                                                      this);
     }

File: android/src/com/google/zxing/client/android/HttpHelper.java
Patch:
@@ -90,6 +90,7 @@ private static String downloadViaHttp(String uri, String contentTypes) throws IO
       if (connection.getResponseCode() != HttpURLConnection.HTTP_OK) {
         throw new IOException("Bad HTTP response: " + connection.getResponseCode());
       }
+      Log.i(TAG, "Consuming " + uri);
       return consume(connection);
     } finally {
       connection.disconnect();

File: android/src/com/google/zxing/client/android/result/WifiResultHandler.java
Patch:
@@ -57,7 +57,7 @@ public void handleButtonPress(int index) {
       WifiParsedResult wifiResult = (WifiParsedResult) getResult();
       WifiManager wifiManager = (WifiManager) getActivity().getSystemService(Context.WIFI_SERVICE);
       Toast.makeText(getActivity(), R.string.wifi_changing_network, Toast.LENGTH_LONG).show();
-      WifiConfigManager.configure(wifiManager, wifiResult);
+      new WifiConfigManager(wifiManager).execute(wifiResult);
       parent.restartPreviewAfterDelay(0L);
     }
   }

File: core/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -80,6 +80,9 @@ static DecoderResult decode(byte[] bytes,
           // We do little with FNC1 except alter the parsed result a bit according to the spec
           fc1InEffect = true;
         } else if (mode == Mode.STRUCTURED_APPEND) {
+          if (bits.available() < 16) {
+            throw FormatException.getFormatInstance();
+          }
           // not really supported; all we do is ignore it
           // Read next 8 bits (symbol sequence #) and 8 bits (parity data), then continue
           bits.readBits(16);

File: android/src/com/google/zxing/client/android/share/BookmarkPickerActivity.java
Patch:
@@ -65,7 +65,7 @@ protected void onCreate(Bundle icicle) {
 
   @Override
   protected void onListItemClick(ListView l, View view, int position, long id) {
-    if (cursor.moveToPosition(position)) {
+    if (!cursor.isClosed() && cursor.moveToPosition(position)) {
       Intent intent = new Intent();
       intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);
       intent.putExtra(Browser.BookmarkColumns.TITLE, cursor.getString(TITLE_COLUMN));

File: core/src/com/google/zxing/client/result/VCardResultParser.java
Patch:
@@ -314,7 +314,7 @@ private static void formatNames(Iterable<List<String>> names) {
         int start = 0;
         int end;
         int componentIndex = 0;
-        while ((end = name.indexOf(';', start)) > 0) {
+        while (componentIndex < components.length - 1 && (end = name.indexOf(';', start)) > 0) {
           components[componentIndex] = name.substring(start, end);
           componentIndex++;
           start = end + 1;

File: core/src/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -380,6 +380,7 @@ private static int byteCompaction(int mode, int[] codewords, int codeIndex, Stri
             nextCode == BEGIN_MACRO_PDF417_CONTROL_BLOCK ||
             nextCode == BEGIN_MACRO_PDF417_OPTIONAL_FIELD ||
             nextCode == MACRO_PDF417_TERMINATOR) {
+          codeIndex--;
           end = true;
         } else {
           if ((count % 5 == 0) && (count > 0)) {

File: core/src/com/google/zxing/pdf417/decoder/BitMatrixParser.java
Patch:
@@ -104,8 +104,8 @@ int[] readCodewords() throws FormatException {
         // that are more or less the same
         matchingConsecutiveScans++;
         // Height of a row is a multiple of the module size in pixels
-        // Usually at least 3 times the module size
-        if (matchingConsecutiveScans >= moduleWidth * 2) { // MGMG
+        // It's supposed to be >= 3x module width, but, accept anything >= 2x
+        if ((matchingConsecutiveScans + 1) >= 2.0f * moduleWidth) {
           // We have some previous matches as well as a match here
           // Set processing a unique row.
           rowInProgress = true;

File: core/src/com/google/zxing/qrcode/QRCodeWriter.java
Patch:
@@ -72,8 +72,7 @@ public BitMatrix encode(String contents,
       }
     }
 
-    QRCode code = new QRCode();
-    Encoder.encode(contents, errorCorrectionLevel, hints, code);
+    QRCode code = Encoder.encode(contents, errorCorrectionLevel, hints);
     return renderResult(code, width, height);
   }
 

File: android/src/com/google/zxing/client/android/ViewfinderView.java
Patch:
@@ -80,6 +80,9 @@ public void setCameraManager(CameraManager cameraManager) {
 
   @Override
   public void onDraw(Canvas canvas) {
+    if (cameraManager == null) {
+      return; // not ready yet, early draw before done configuring
+    }
     Rect frame = cameraManager.getFramingRect();
     if (frame == null) {
       return;

File: core/src/com/google/zxing/pdf417/encoder/PDF417Writer.java
Patch:
@@ -145,11 +145,11 @@ private static BitMatrix bitMatrixFrombitArray(byte[][] input) {
     // Creates the bitmatrix with extra space for whitespace
     BitMatrix output = new BitMatrix(input[0].length + 2 * whiteSpace, input.length + 2 * whiteSpace);
     output.clear();
-    for (int y = 0; y < input.length; y++) {
+    for (int y = 0, yOutput = output.getHeight() - whiteSpace; y < input.length; y++, yOutput--) {
       for (int x = 0; x < input[0].length; x++) {
         // Zero is white in the bytematrix
         if (input[y][x] == 1) {
-          output.set(x + whiteSpace, y + whiteSpace);
+          output.set(x + whiteSpace, yOutput);
         }
       }
     }

File: core/src/com/google/zxing/pdf417/encoder/PDF417Writer.java
Patch:
@@ -88,7 +88,7 @@ public BitMatrix encode(String contents,
     Map<EncodeHintType, Object> hints = new EnumMap<EncodeHintType,Object>(EncodeHintType.class);
     hints.put(EncodeHintType.PDF417_COMPACT, compact);
     hints.put(EncodeHintType.PDF417_COMPACTION, compaction);
-    hints.put(EncodeHintType.PDF417_DIMENSIONS, new Dimensions(maxCols, minCols, maxRows, minRows));
+    hints.put(EncodeHintType.PDF417_DIMENSIONS, new Dimensions(minCols, maxCols, minRows, maxRows));
     return encode(contents, format, width, height, hints);
   }
 

File: android/src/com/google/zxing/client/android/history/HistoryActivity.java
Patch:
@@ -81,7 +81,9 @@ public void onCreateContextMenu(ContextMenu menu,
                                   View v,
                                   ContextMenu.ContextMenuInfo menuInfo) {
     int position = ((AdapterView.AdapterContextMenuInfo) menuInfo).position;
-    menu.add(Menu.NONE, position, position, R.string.history_clear_one_history_text);
+    if (position >= adapter.getCount() || adapter.getItem(position).getResult() != null) {
+      menu.add(Menu.NONE, position, position, R.string.history_clear_one_history_text);
+    } // else it's just that dummy "Empty" message
   }
 
   @Override

File: core/src/com/google/zxing/common/BitSource.java
Patch:
@@ -50,11 +50,11 @@ public int getByteOffset() {
    * @param numBits number of bits to read
    * @return int representing the bits read. The bits will appear as the least-significant
    *         bits of the int
-   * @throws IllegalArgumentException if numBits isn't in [1,32]
+   * @throws IllegalArgumentException if numBits isn't in [1,32] or more than is available
    */
   public int readBits(int numBits) {
-    if (numBits < 1 || numBits > 32) {
-      throw new IllegalArgumentException();
+    if (numBits < 1 || numBits > 32 || numBits > available()) {
+      throw new IllegalArgumentException(String.valueOf(numBits));
     }
 
     int result = 0;

File: zxingorg/src/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -211,6 +211,8 @@ private static void consumeRemainder(InputStream is) {
       }
     } catch (IOException ioe) {
       // continue
+    } catch (IndexOutOfBoundsException ioobe) {
+      // sun.net.www.http.ChunkedInputStream.read is throwing this, continue
     }
   }
 

File: zxingorg/src/com/google/zxing/web/DoSFilter.java
Patch:
@@ -42,9 +42,9 @@
  */
 public final class DoSFilter implements Filter {
 
-  private static final int MAX_ACCESSES_PER_IP_PER_TIME = 10;
-  private static final long MAX_ACCESS_INTERVAL_MSEC = 10L * 1000L;
-  private static final long UNBAN_INTERVAL_MSEC = 60L * 60L * 1000L;
+  private static final int MAX_ACCESSES_PER_IP_PER_TIME = 100;
+  private static final long MAX_ACCESS_INTERVAL_MSEC = 60L * 1000L;
+  private static final long UNBAN_INTERVAL_MSEC = 15L * 60L * 1000L;
   private static final String BAD_IPS_INIT_PARAM = "bad.ips";
 
   private final IPTrie numRecentAccesses;

File: core/test/src/com/google/zxing/datamatrix/DataMatrixBlackBox2TestCase.java
Patch:
@@ -30,7 +30,7 @@ public DataMatrixBlackBox2TestCase() {
     addTest(8, 8, 0, 1, 0.0f);
     addTest(14, 14, 0, 1, 90.0f);
     addTest(14, 14, 0, 1, 180.0f);
-    addTest(12, 12, 0, 1, 270.0f);
+    addTest(13, 13, 0, 1, 270.0f);
   }
 
 }

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox1TestCase.java
Patch:
@@ -29,8 +29,8 @@ public final class PDF417BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox1TestCase() {
     super("test/data/blackbox/pdf417", new MultiFormatReader(), BarcodeFormat.PDF_417);
-    addTest(5, 5, 0.0f);
-    addTest(5, 5, 180.0f);
+    addTest(4, 4, 0.0f);
+    addTest(4, 4, 180.0f);
   }
 
 }
\ No newline at end of file

File: core/src/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -276,7 +276,7 @@ private ResultPoint correctTopRight(ResultPoint bottomLeft,
 		
 		ResultPoint c1 = new ResultPoint(topRight.getX() + corr * cos, topRight.getY() + corr * sin);
 	
-		corr = distance(bottomLeft, bottomRight) / (float) dimension;
+		corr = distance(bottomLeft, topLeft) / (float) dimension;
 		norm = distance(bottomRight, topRight);
 		cos = (topRight.getX() - bottomRight.getX()) / norm;
 		sin = (topRight.getY() - bottomRight.getY()) / norm;

File: core/test/src/com/google/zxing/common/reedsolomon/ReedSolomonEncoderQRCodeTestCase.java
Patch:
@@ -45,7 +45,7 @@ public void testQRCodeVersusDecoder() throws Exception {
     ReedSolomonEncoder encoder = new ReedSolomonEncoder(GenericGF.QR_CODE_FIELD_256);
     ReedSolomonDecoder decoder = new ReedSolomonDecoder(GenericGF.QR_CODE_FIELD_256);
     for (int i = 0; i < 100; i++) {
-      int size = 1 + random.nextInt(1000);
+      int size = 2 + random.nextInt(254);
       int[] toEncode = new int[size];
       int ecBytes = 1 + random.nextInt(2 * (1 + size / 8));
       ecBytes = Math.min(ecBytes, size - 1);
@@ -56,6 +56,7 @@ public void testQRCodeVersusDecoder() throws Exception {
       int[] original = new int[dataBytes];
       System.arraycopy(toEncode, 0, original, 0, dataBytes);
       encoder.encode(toEncode, ecBytes);
+      corrupt(toEncode, ecBytes / 2, random);
       decoder.decode(toEncode, ecBytes);
       assertArraysEqual(original, 0, toEncode, 0, dataBytes);
     }

File: core/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -258,6 +258,9 @@ private static void decodeAlphanumericSegment(BitSource bits,
     }
     if (count == 1) {
       // special case: one character left
+      if (bits.available() < 6) {
+        throw FormatException.getFormatInstance();
+      }
       result.append(toAlphaNumericChar(bits.readBits(6)));
     }
     // See section 6.4.8.1, 6.4.8.2

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -352,8 +352,6 @@ public boolean onOptionsItemSelected(MenuItem item) {
         startActivity(intent);
         break;
       case HISTORY_ID:
-        intent = new Intent(Intent.ACTION_VIEW);
-        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);
         intent.setClassName(this, HistoryActivity.class.getName());
         startActivityForResult(intent, HISTORY_REQUEST_CODE);
         break;

File: core/src/com/google/zxing/client/result/VEventResultParser.java
Patch:
@@ -74,7 +74,7 @@ public CalendarParsedResult parse(Result result) {
   private static String matchSingleVCardPrefixedField(CharSequence prefix,
                                                       String rawText,
                                                       boolean trim) {
-    List<String> values = VCardResultParser.matchSingleVCardPrefixedField(prefix, rawText, trim);
+    List<String> values = VCardResultParser.matchSingleVCardPrefixedField(prefix, rawText, trim, false);
     return values == null || values.isEmpty() ? null : values.get(0);
   }
 

File: core/test/src/com/google/zxing/client/result/AddressBookParsedResultTestCase.java
Patch:
@@ -84,7 +84,7 @@ public void testQuotedPrintable() {
            "=38=38=20=4C=79=6E=62=72=6F=6F=6B=0D=0A=43=\r\n" +
            "=4F=20=36=39=39=\r\n" +
            "=39=39;;;\r\nEND:VCARD",
-           null, null, null, new String[] {";;88 Lynbrook\r\nCO 69999;;;"},
+           null, null, null, new String[] {"88 Lynbrook\r\nCO 69999"},
            null, null, null, null, null, null);
   }
 

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox1TestCase.java
Patch:
@@ -29,8 +29,8 @@ public final class PDF417BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox1TestCase() {
     super("test/data/blackbox/pdf417", new MultiFormatReader(), BarcodeFormat.PDF_417);
-    addTest(4, 4, 0.0f);
-    addTest(4, 4, 180.0f);
+    addTest(5, 5, 0.0f);
+    addTest(5, 5, 180.0f);
   }
 
 }
\ No newline at end of file

File: core/src/com/google/zxing/oned/CodaBarReader.java
Patch:
@@ -249,7 +249,7 @@ private void setCounters(BitArray row) throws NotFoundException {
   private void counterAppend(int e) {
     counters[counterLength] = e;
     counterLength++;
-    if (counterLength >= counterLength) {
+    if (counterLength >= counters.length) {
       int[] temp = new int[counterLength * 2];
       System.arraycopy(counters, 0, temp, 0, counterLength);
       counters = temp;

File: core/src/com/google/zxing/qrcode/QRCodeReader.java
Patch:
@@ -138,7 +138,7 @@ private static BitMatrix extractPureBits(BitMatrix image) throws NotFoundExcepti
     // Push in the "border" by half the module width so that we start
     // sampling in the middle of the module. Just in case the image is a
     // little off, this will help recover.
-    int nudge = Math.round(moduleSize / 2.0f);
+    int nudge = (int) (moduleSize / 2.0f);
     top += nudge;
     left += nudge;
 

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox2TestCase.java
Patch:
@@ -29,8 +29,8 @@ public final class PDF417BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox2TestCase() {
     super("test/data/blackbox/pdf417-2", new MultiFormatReader(), BarcodeFormat.PDF_417);
-    addTest(15, 15, 3, 3, 0.0f);
-    addTest(14, 14, 1, 1, 180.0f);
+    addTest(11, 11, 0, 0, 0.0f);
+    addTest(13, 13, 0, 0, 180.0f);
   }
 
 }

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -39,7 +39,6 @@ public final class PreferencesActivity extends PreferenceActivity
   public static final String KEY_DECODE_DATA_MATRIX = "preferences_decode_Data_Matrix";
   public static final String KEY_CUSTOM_PRODUCT_SEARCH = "preferences_custom_product_search";
 
-  public static final String KEY_REVERSE_IMAGE = "preferences_reverse_image";
   public static final String KEY_PLAY_BEEP = "preferences_play_beep";
   public static final String KEY_VIBRATE = "preferences_vibrate";
   public static final String KEY_COPY_TO_CLIPBOARD = "preferences_copy_to_clipboard";

File: core/src/com/google/zxing/multi/qrcode/QRCodeMultiReader.java
Patch:
@@ -55,7 +55,7 @@ public Result[] decodeMultiple(BinaryBitmap image, Map<DecodeHintType,?> hints)
     DetectorResult[] detectorResults = new MultiDetector(image.getBlackMatrix()).detectMulti(hints);
     for (DetectorResult detectorResult : detectorResults) {
       try {
-        DecoderResult decoderResult = getDecoder().decode(detectorResult.getBits());
+        DecoderResult decoderResult = getDecoder().decode(detectorResult.getBits(), hints);
         ResultPoint[] points = detectorResult.getPoints();
         Result result = new Result(decoderResult.getText(), decoderResult.getRawBytes(), points,
                                    BarcodeFormat.QR_CODE);

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox1TestCase.java
Patch:
@@ -29,8 +29,8 @@ public final class PDF417BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox1TestCase() {
     super("test/data/blackbox/pdf417", new MultiFormatReader(), BarcodeFormat.PDF_417);
-    addTest(3, 3, 0.0f);
-    addTest(3, 3, 180.0f);
+    addTest(4, 4, 0.0f);
+    addTest(4, 4, 180.0f);
   }
 
 }
\ No newline at end of file

File: core/src/com/google/zxing/client/result/URIResultParser.java
Patch:
@@ -32,7 +32,7 @@ public final class URIResultParser extends ResultParser {
       "(:\\d{1,5})?" + // maybe port
       "(/|\\?|$)"; // query, path or nothing
   private static final Pattern URL_WITH_PROTOCOL_PATTERN = Pattern.compile(
-      "[a-zA-Z0-9]{2,}://" + // protocol
+      "[a-zA-Z0-9]{2,}:(/)*" + // protocol
       "[a-zA-Z0-9\\-]+(\\.[a-zA-Z0-9\\-]+)*" + // host name elements
       PATTERN_END);
   private static final Pattern URL_WITHOUT_PROTOCOL_PATTERN = Pattern.compile(

File: android/src/com/google/zxing/client/android/DecodeFormatManager.java
Patch:
@@ -43,7 +43,8 @@ final class DecodeFormatManager {
     ONE_D_FORMATS = EnumSet.of(BarcodeFormat.CODE_39,
                                BarcodeFormat.CODE_93,
                                BarcodeFormat.CODE_128,
-                               BarcodeFormat.ITF);
+                               BarcodeFormat.ITF,
+                               BarcodeFormat.CODABAR);
     ONE_D_FORMATS.addAll(PRODUCT_FORMATS);
   }
 

File: core/src/com/google/zxing/MultiFormatReader.java
Patch:
@@ -105,7 +105,7 @@ public void setHints(Map<DecodeHintType,?> hints) {
           formats.contains(BarcodeFormat.UPC_E) ||
           formats.contains(BarcodeFormat.EAN_13) ||
           formats.contains(BarcodeFormat.EAN_8) ||
-          //formats.contains(BarcodeFormat.CODABAR) ||
+          formats.contains(BarcodeFormat.CODABAR) ||
           formats.contains(BarcodeFormat.CODE_39) ||
           formats.contains(BarcodeFormat.CODE_93) ||
           formats.contains(BarcodeFormat.CODE_128) ||

File: core/src/com/google/zxing/oned/MultiFormatOneDReader.java
Patch:
@@ -76,7 +76,7 @@ public MultiFormatOneDReader(Map<DecodeHintType,?> hints) {
     if (readers.isEmpty()) {
       readers.add(new MultiFormatUPCEANReader(hints));
       readers.add(new Code39Reader());
-      //readers.add(new CodaBarReader());
+      readers.add(new CodaBarReader());
       readers.add(new Code93Reader());
       readers.add(new Code128Reader());
       readers.add(new ITFReader());

File: android/src/com/google/zxing/client/android/ViewfinderView.java
Patch:
@@ -181,7 +181,7 @@ public void drawResultBitmap(Bitmap barcode) {
 
   public void addPossibleResultPoint(ResultPoint point) {
     List<ResultPoint> points = possibleResultPoints;
-    synchronized (point) {
+    synchronized (points) {
       points.add(point);
       int size = points.size();
       if (size > MAX_RESULT_POINTS) {

File: android/src/com/google/zxing/client/android/encode/VCardContactEncoder.java
Patch:
@@ -27,7 +27,7 @@
  */
 final class VCardContactEncoder extends ContactEncoder {
 
-  private static final Pattern RESERVED_VCARD_CHARS = Pattern.compile("([\\\\:;])");
+  private static final Pattern RESERVED_VCARD_CHARS = Pattern.compile("([\\\\,;])");
   private static final Pattern NEWLINE = Pattern.compile("\\n");
   private static final Formatter VCARD_FIELD_FORMATTER = new Formatter() {
     @Override

File: zxing.appspot.com/src/com/google/zxing/web/generator/client/ContactInfoGenerator.java
Patch:
@@ -129,7 +129,7 @@ private static String getVCard(String name, String company, String tel, String u
   
   private static void maybeAppendvCard(StringBuilder output, String prefix, String value) {
     if (value.length() > 0) {
-      value = value.replaceAll("([\\\\:;])", "\\\\$1");
+      value = value.replaceAll("([\\\\,;])", "\\\\$1");
       value = value.replaceAll("\\n", "\\\\n");
       output.append(prefix).append(':').append(value).append('\n');
     }

File: core/src/com/google/zxing/oned/ITFWriter.java
Patch:
@@ -46,6 +46,9 @@ public BitMatrix encode(String contents,
   @Override
   public byte[] encode(String contents) {
     int length = contents.length();
+    if (length % 2 != 0) {
+      throw new IllegalArgumentException("The lenght of the input should be even");
+    }
     if (length > 80) {
       throw new IllegalArgumentException(
           "Requested contents should be less than 80 digits long, but got " + length);

File: core/src/com/google/zxing/oned/Code128Reader.java
Patch:
@@ -431,7 +431,7 @@ public Result decodeRow(int rowNumber, BitArray row, Map<DecodeHintType,?> hints
     int resultLength = result.length();
     if (resultLength == 0) {
       // false positive
-      throw ChecksumException.getChecksumInstance();
+      throw NotFoundException.getNotFoundInstance();
     }
 
     // Only bother if the result had at least one character, and if the checksum digit happened to

File: core/src/com/google/zxing/oned/Code39Reader.java
Patch:
@@ -146,8 +146,8 @@ public Result decodeRow(int rowNumber, BitArray row, Map<DecodeHintType,?> hints
       result.setLength(max);
     }
 
-    if (result.length() < 4) {
-      // Almost surely a false positive
+    if (result.length() == 0) {
+      // false positive
       throw NotFoundException.getNotFoundInstance();
     }
 

File: core/src/com/google/zxing/oned/Code93Reader.java
Patch:
@@ -88,8 +88,8 @@ public Result decodeRow(int rowNumber, BitArray row, Map<DecodeHintType,?> hints
       throw NotFoundException.getNotFoundInstance();
     }
 
-    if (result.length() < 4) {
-      // Almost surely a false positive
+    if (result.length() < 2) {
+      // false positive -- need at least 2 checksum digits
       throw NotFoundException.getNotFoundInstance();
     }
 

File: android/src/com/google/zxing/client/android/HttpHelper.java
Patch:
@@ -37,7 +37,7 @@ public final class HttpHelper {
 
   private static final Collection<String> REDIRECTOR_DOMAINS = new HashSet<String>(Arrays.asList(
     "amzn.to", "bit.ly", "bitly.com", "fb.me", "goo.gl", "is.gd", "j.mp", "lnkd.in", "ow.ly",
-    "SCN.BY", "su.pr", "t.co", "tinyurl.com", "tr.im"
+    "R.BEETAGG.COM", "r.beetagg.com", "SCN.BY", "su.pr", "t.co", "tinyurl.com", "tr.im"
   ));
 
   private HttpHelper() {

File: core/src/com/google/zxing/client/result/URIResultParser.java
Patch:
@@ -33,10 +33,10 @@ public final class URIResultParser extends ResultParser {
       "(/|\\?|$)"; // query, path or nothing
   private static final Pattern URL_WITH_PROTOCOL_PATTERN = Pattern.compile(
       "[a-zA-Z0-9]{2,}://" + // protocol
-      "[a-zA-Z0-9\\-]{2,}(\\.[a-zA-Z0-9\\-]{2,})*" + // host name elements
+      "[a-zA-Z0-9\\-]+(\\.[a-zA-Z0-9\\-]+)*" + // host name elements
       PATTERN_END);
   private static final Pattern URL_WITHOUT_PROTOCOL_PATTERN = Pattern.compile(
-      "[a-zA-Z0-9\\-]{2,}(\\.[a-zA-Z0-9\\-]{2,})+" + // host name elements
+      "([a-zA-Z0-9\\-]+\\.)+[a-zA-Z0-9\\-]{2,}" + // host name elements
       PATTERN_END);
 
   @Override

File: core/test/src/com/google/zxing/client/result/URIParsedResultTestCase.java
Patch:
@@ -48,6 +48,7 @@ public void testURI() {
            "otpauth://remoteaccess?devaddr=00%a1b2%c3d4&devname=foo&key=bar",
            null);
     doTest("s3://amazon.com:8123", "s3://amazon.com:8123", null);
+    doTest("HTTP://R.BEETAGG.COM/?12345", "http://R.BEETAGG.COM/?12345", null);
   }
 
   @Test

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -159,6 +159,8 @@ public void onCreate(Bundle icicle) {
     inactivityTimer = new InactivityTimer(this);
     beepManager = new BeepManager(this);
 
+    PreferenceManager.setDefaultValues(this, R.xml.preferences, false);
+
     showHelpOnFirstLaunch();
   }
 

File: android/src/com/google/zxing/client/android/DecodeThread.java
Patch:
@@ -59,13 +59,13 @@ final class DecodeThread extends Thread {
     if (decodeFormats == null || decodeFormats.isEmpty()) {
       SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(activity);
       decodeFormats = EnumSet.noneOf(BarcodeFormat.class);
-      if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_1D, true)) {
+      if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_1D, false)) {
         decodeFormats.addAll(DecodeFormatManager.ONE_D_FORMATS);
       }
-      if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_QR, true)) {
+      if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_QR, false)) {
         decodeFormats.addAll(DecodeFormatManager.QR_CODE_FORMATS);
       }
-      if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_DATA_MATRIX, true)) {
+      if (prefs.getBoolean(PreferencesActivity.KEY_DECODE_DATA_MATRIX, false)) {
         decodeFormats.addAll(DecodeFormatManager.DATA_MATRIX_FORMATS);
       }
     }

File: zxing.appspot.com/src/com/google/zxing/web/generator/client/ContactInfoGenerator.java
Patch:
@@ -106,7 +106,7 @@ private static String buildAddress(String address, String address2) {
 
   private static void maybeAppendMECARD(StringBuilder output, String prefix, String value) {
     if (value.length() > 0) {
-      value = value.replaceAll("([:;])", "\\\\$1");
+      value = value.replaceAll("([\\\\:;])", "\\\\$1");
       value = value.replaceAll("\\n", "");
       output.append(prefix).append(':').append(value).append(';');
     }

File: androidtest/src/com/google/zxing/client/androidtest/ZXingTestActivity.java
Patch:
@@ -142,6 +142,8 @@ public void onClick(View v) {
       intent.putExtra("SCAN_MODE", "PRODUCT_MODE");
       intent.putExtra("SCAN_WIDTH", 800);
       intent.putExtra("SCAN_HEIGHT", 200);
+      intent.putExtra("RESULT_DISPLAY_DURATION_MS", 3000L);
+      intent.putExtra("PROMPT_MESSAGE", "Custom prompt to scan a product");
       startActivityForResult(intent, IntentIntegrator.REQUEST_CODE);
     }
   };

File: core/src/com/google/zxing/common/CharacterSetECI.java
Patch:
@@ -49,11 +49,11 @@ public enum CharacterSetECI {
   Cp1251(22, "windows-1251"),
   Cp1252(23, "windows-1252"),
   Cp1256(24, "windows-1256"),
-  UnicodeBigUnmarked(25, "UTF-16BE"),
+  UnicodeBigUnmarked(25, "UTF-16BE", "UTF-16"),
   UTF8(26, "UTF-8"),
-  ASCII(27, "US-ASCII"),
+  ASCII(new int[] {27, 170}, "US-ASCII"),
   Big5(28),
-  EUC_CN(new int[] {29}, "x-EUC_CN"),
+  EUC_CN(new int[] {29}, "GB2312", "GB18030"),
   EUC_KR(new int[]{30}, "EUC-KR");
 
   private static final Map<Integer,CharacterSetECI> VALUE_TO_ECI = new HashMap<Integer,CharacterSetECI>();

File: android-integration/src/com/google/zxing/integration/android/IntentIntegrator.java
Patch:
@@ -291,9 +291,10 @@ public static IntentResult parseActivityResult(int requestCode, int resultCode,
       if (resultCode == Activity.RESULT_OK) {
         String contents = intent.getStringExtra("SCAN_RESULT");
         String formatName = intent.getStringExtra("SCAN_RESULT_FORMAT");
-        return new IntentResult(contents, formatName);
+        byte[] rawBytes = intent.getByteArrayExtra("SCAN_RESULT_BYTES");
+        return new IntentResult(contents, formatName, rawBytes);
       }
-      return new IntentResult(null, null);
+      return new IntentResult();
     }
     return null;
   }

File: android/src/com/google/zxing/client/android/result/ResultHandler.java
Patch:
@@ -245,8 +245,7 @@ final void addCalendarEvent(String summary,
         // + 1 day
         endMilliseconds = startMilliseconds + 24 * 60 * 60 * 1000;
       } else {
-        // + 1 hour
-        endMilliseconds = startMilliseconds + 60 * 60 * 1000;
+        endMilliseconds = startMilliseconds;
       }
     } else {
       endMilliseconds = calculateMilliseconds(end);

File: core/test/src/com/google/zxing/client/result/ParsedReaderResultTestCase.java
Patch:
@@ -216,11 +216,11 @@ public void testVEvent() {
         "DTEND:20080505\r\nEND:VEVENT", "foo\n20080504\n20080505", ParsedResultType.CALENDAR);
     // Start time only
     doTestResult("BEGIN:VEVENT\r\nSUMMARY:foo\r\nDTSTART:20080504T123456Z\r\nEND:VEVENT",
-        "foo\n20080504T123456Z\n20080504T123456Z", ParsedResultType.CALENDAR);
+        "foo\n20080504T123456Z", ParsedResultType.CALENDAR);
     doTestResult("BEGIN:VEVENT\r\nSUMMARY:foo\r\nDTSTART:20080504T123456\r\nEND:VEVENT",
-        "foo\n20080504T123456\n20080504T123456", ParsedResultType.CALENDAR);
+        "foo\n20080504T123456", ParsedResultType.CALENDAR);
     doTestResult("BEGIN:VEVENT\r\nSUMMARY:foo\r\nDTSTART:20080504\r\nEND:VEVENT",
-        "foo\n20080504\n20080504", ParsedResultType.CALENDAR);
+        "foo\n20080504", ParsedResultType.CALENDAR);
     doTestResult("BEGIN:VEVENT\r\nDTEND:20080505T\r\nEND:VEVENT",
         "BEGIN:VEVENT\r\nDTEND:20080505T\r\nEND:VEVENT", ParsedResultType.TEXT);
     // Make sure illegal entries without newlines don't crash

File: android/src/com/google/zxing/client/android/camera/CameraManager.java
Patch:
@@ -300,7 +300,7 @@ public void setManualFramingRect(int width, int height) {
   public PlanarYUVLuminanceSource buildLuminanceSource(byte[] data, int width, int height) {
     Rect rect = getFramingRectInPreview();
     if (rect == null) {
-      throw new IllegalStateException();
+      return null;
     }
     int previewFormat = configManager.getPreviewFormat();
     String previewFormatString = configManager.getPreviewFormatString();

File: android/src/com/google/zxing/client/android/wifi/WifiConfigManager.java
Patch:
@@ -103,6 +103,7 @@ private static void updateNetwork(WifiManager wifiManager, WifiConfiguration con
       // Try to disable the current network and start a new one.
       if (wifiManager.enableNetwork(networkId, true)) {
         Log.i(TAG, "Associating to network " + config.SSID);
+        wifiManager.saveConfiguration();
       } else {
         Log.w(TAG, "Failed to enable network " + config.SSID);
       }

File: core/src/com/google/zxing/datamatrix/decoder/DecodedBitStreamParser.java
Patch:
@@ -473,7 +473,7 @@ private static void decodeBase256Segment(BitSource bits,
       if (bits.available() < 8) {
         throw FormatException.getFormatInstance();
       }
-      bytes[i] = unrandomize255State(bits.readBits(8), codewordPosition++);
+      bytes[i] = (byte) unrandomize255State(bits.readBits(8), codewordPosition++);
     }
     byteSegments.add(bytes);
     try {
@@ -486,11 +486,11 @@ private static void decodeBase256Segment(BitSource bits,
   /**
    * See ISO 16022:2006, Annex B, B.2
    */
-  private static byte unrandomize255State(int randomizedBase256Codeword,
+  private static int unrandomize255State(int randomizedBase256Codeword,
                                           int base256CodewordPosition) {
     int pseudoRandomNumber = ((149 * base256CodewordPosition) % 255) + 1;
     int tempVariable = randomizedBase256Codeword - pseudoRandomNumber;
-    return (byte) (tempVariable >= 0 ? tempVariable : tempVariable + 256);
+    return tempVariable >= 0 ? tempVariable : tempVariable + 256;
   }
 
 }

File: android/src/com/google/zxing/client/android/DecodeHandler.java
Patch:
@@ -21,7 +21,6 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
-import com.google.zxing.client.android.camera.CameraManager;
 import com.google.zxing.common.HybridBinarizer;
 
 import android.os.Bundle;
@@ -73,7 +72,7 @@ public void handleMessage(Message message) {
   private void decode(byte[] data, int width, int height) {
     long start = System.currentTimeMillis();
     Result rawResult = null;
-    PlanarYUVLuminanceSource source = CameraManager.get().buildLuminanceSource(data, width, height);
+    PlanarYUVLuminanceSource source = activity.getCameraManager().buildLuminanceSource(data, width, height);
     BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
     try {
       rawResult = multiFormatReader.decodeWithState(bitmap);

File: core/src/com/google/zxing/pdf417/encoder/PDF417Writer.java
Patch:
@@ -56,12 +56,12 @@ public BitMatrix encode(String contents,
                           int maxCols,
                           int minRows,
                           int maxRows,
-                          boolean byteCompaction) throws WriterException {
+                          Compaction compaction) throws WriterException {
     PDF417 encoder = initializeEncoder(format, compact);
 
     // Set options: dimensions and byte compaction
     encoder.setDimensions(maxCols, minCols, maxRows, minRows);
-    encoder.setByteCompaction(byteCompaction);
+    encoder.setCompaction(compaction);
 
     return bitMatrixFromEncoder(encoder, contents, width, height);
   }

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -47,6 +47,7 @@ public final class PreferencesActivity extends PreferenceActivity
   public static final String KEY_BULK_MODE = "preferences_bulk_mode";
   public static final String KEY_REMEMBER_DUPLICATES = "preferences_remember_duplicates";
   public static final String KEY_SUPPLEMENTAL = "preferences_supplemental";
+  public static final String KEY_SEARCH_COUNTRY = "preferences_search_country";
 
   public static final String KEY_HELP_VERSION_SHOWN = "preferences_help_version_shown";
   public static final String KEY_NOT_OUR_RESULTS_SHOWN = "preferences_not_out_results_shown";

File: android/src/com/google/zxing/client/android/book/BrowseBookListener.java
Patch:
@@ -47,7 +47,7 @@ public void onItemClick(AdapterView<?> parent, View v, int position, long id) {
       int equals = uri.indexOf('=');
       String volumeId = uri.substring(equals + 1);
       String readBookURI = "http://books.google." +
-          LocaleManager.getBookSearchCountryTLD() +
+          LocaleManager.getBookSearchCountryTLD(activity) +
           "/books?id=" + volumeId + "&pg=" + pageId + "&vq=" + query;
       Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(readBookURI));
       intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);                    

File: android/src/com/google/zxing/client/android/result/ResultHandler.java
Patch:
@@ -446,18 +446,18 @@ final void searchMap(String address, CharSequence title) {
 
   final void getDirections(double latitude, double longitude) {
     launchIntent(new Intent(Intent.ACTION_VIEW, Uri.parse("http://maps.google." +
-        LocaleManager.getCountryTLD() + "/maps?f=d&daddr=" + latitude + ',' + longitude)));
+        LocaleManager.getCountryTLD(getActivity()) + "/maps?f=d&daddr=" + latitude + ',' + longitude)));
   }
 
   // Uses the mobile-specific version of Product Search, which is formatted for small screens.
   final void openProductSearch(String upc) {
-    Uri uri = Uri.parse("http://www.google." + LocaleManager.getProductSearchCountryTLD() +
+    Uri uri = Uri.parse("http://www.google." + LocaleManager.getProductSearchCountryTLD(getActivity()) +
         "/m/products?q=" + upc + "&source=zxing");
     launchIntent(new Intent(Intent.ACTION_VIEW, uri));
   }
 
   final void openBookSearch(String isbn) {
-    Uri uri = Uri.parse("http://books.google." + LocaleManager.getBookSearchCountryTLD() +
+    Uri uri = Uri.parse("http://books.google." + LocaleManager.getBookSearchCountryTLD(getActivity()) +
         "/books?vid=isbn" + isbn);
     launchIntent(new Intent(Intent.ACTION_VIEW, uri));
   }

File: core/test/src/com/google/zxing/aztec/AztecBlackBox2TestCase.java
Patch:
@@ -29,7 +29,7 @@ public final class AztecBlackBox2TestCase extends AbstractBlackBoxTestCase {
   public AztecBlackBox2TestCase() {
     super("test/data/blackbox/aztec-2", new AztecReader(), BarcodeFormat.AZTEC);
     addTest(2, 2, 0.0f);
-    addTest(2, 2, 90.0f);
+    addTest(1, 1, 90.0f);
     addTest(3, 3, 180.0f);
     addTest(1, 1, 270.0f);
   }

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox2TestCase.java
Patch:
@@ -33,8 +33,8 @@ public final class PDF417BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox2TestCase() {
     super("test/data/blackbox/pdf417-2", new MultiFormatReader(), BarcodeFormat.PDF_417);
-    addTest(13, 13, 0.0f);
-    addTest(13, 13, 180.0f);
+    addTest(15, 15, 0.0f);
+    addTest(14, 14, 180.0f);
   }
 
   @Override

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox1TestCase.java
Patch:
@@ -28,8 +28,8 @@ public final class QRCodeBlackBox1TestCase extends AbstractBlackBoxTestCase {
   public QRCodeBlackBox1TestCase() {
     super("test/data/blackbox/qrcode-1", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(17, 17, 0.0f);
-    addTest(13, 13, 90.0f);
-    addTest(16, 16, 180.0f);
+    addTest(14, 14, 90.0f);
+    addTest(17, 17, 180.0f);
     addTest(14, 14, 270.0f);
   }
 

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox3TestCase.java
Patch:
@@ -30,7 +30,7 @@ public QRCodeBlackBox3TestCase() {
     addTest(38, 38, 0.0f);
     addTest(38, 38, 90.0f);
     addTest(36, 36, 180.0f);
-    addTest(38, 38, 270.0f);
+    addTest(39, 39, 270.0f);
   }
 
 }

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox4TestCase.java
Patch:
@@ -32,7 +32,7 @@ public QRCodeBlackBox4TestCase() {
     addTest(36, 36, 0.0f);
     addTest(35, 35, 90.0f);
     addTest(35, 35, 180.0f);
-    addTest(34, 34, 270.0f);
+    addTest(35, 35, 270.0f);
   }
 
 }

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox5TestCase.java
Patch:
@@ -31,7 +31,7 @@ public final class QRCodeBlackBox5TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox5TestCase() {
     super("test/data/blackbox/qrcode-5", new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(18, 18, 0.0f);
+    addTest(19, 19, 0.0f);
     addTest(19, 19, 90.0f);
     addTest(19, 19, 180.0f);
     addTest(18, 18, 270.0f);

File: core/src/com/google/zxing/BarcodeFormat.java
Patch:
@@ -56,6 +56,9 @@ public final class BarcodeFormat {
   /** ITF (Interleaved Two of Five) 1D format. */
   public static final BarcodeFormat ITF = new BarcodeFormat("ITF");
 
+  /** MaxiCode 2D barcode format. */
+  public static final BarcodeFormat MAXICODE = new BarcodeFormat("MAXICODE");
+
   /** PDF417 format. */
   public static final BarcodeFormat PDF_417 = new BarcodeFormat("PDF_417");
 

File: core/src/com/google/zxing/common/reedsolomon/GenericGF.java
Patch:
@@ -36,6 +36,7 @@ public final class GenericGF {
   public static final GenericGF QR_CODE_FIELD_256 = new GenericGF(0x011D, 256); // x^8 + x^4 + x^3 + x^2 + 1
   public static final GenericGF DATA_MATRIX_FIELD_256 = new GenericGF(0x012D, 256); // x^8 + x^5 + x^3 + x^2 + 1
   public static final GenericGF AZTEC_DATA_8 = DATA_MATRIX_FIELD_256;
+  public static final GenericGF MAXICODE_FIELD_64 = AZTEC_DATA_6;
 
   private static final int INITIALIZATION_THRESHOLD = 0;
 
@@ -59,7 +60,7 @@ public GenericGF(int primitive, int size) {
     this.size = size;
     
     if (size <= INITIALIZATION_THRESHOLD){
-    	initialize();
+      initialize();
     }
   }
 

File: javase/src/com/google/zxing/client/j2se/CommandLineRunner.java
Patch:
@@ -163,6 +163,7 @@ private static Hashtable<DecodeHintType, Object> buildHints(Config config) {
       vector.addElement(BarcodeFormat.AZTEC);
       vector.addElement(BarcodeFormat.PDF_417);
       vector.addElement(BarcodeFormat.CODABAR);
+      vector.addElement(BarcodeFormat.MAXICODE);
     }
     hints.put(DecodeHintType.POSSIBLE_FORMATS, vector);
     if (config.isTryHarder()) {

File: android/src/com/google/zxing/client/android/camera/PreviewCallback.java
Patch:
@@ -46,8 +46,9 @@ public void onPreviewFrame(byte[] data, Camera camera) {
     if (!useOneShotPreviewCallback) {
       camera.setPreviewCallback(null);
     }
-    if (previewHandler != null) {
-      Message message = previewHandler.obtainMessage(previewMessage, cameraResolution.x,
+    Handler thePreviewHandler = previewHandler;
+    if (thePreviewHandler != null) {
+      Message message = thePreviewHandler.obtainMessage(previewMessage, cameraResolution.x,
           cameraResolution.y, data);
       message.sendToTarget();
       previewHandler = null;

File: android/src/com/google/zxing/client/android/result/WifiResultHandler.java
Patch:
@@ -59,9 +59,6 @@ public void handleButtonPress(int index) {
     WifiParsedResult wifiResult = (WifiParsedResult) getResult();
     if (index == 0) {
       String ssid = wifiResult.getSsid();
-      if (ssid == null || ssid.length() == 0) {
-        return;
-      }
       String password = wifiResult.getPassword();
       String networkType = wifiResult.getNetworkEncryption();
       WifiManager wifiManager = (WifiManager) getActivity().getSystemService(Context.WIFI_SERVICE);

File: android/src/com/google/zxing/client/android/result/supplement/BookResultInfoRetriever.java
Patch:
@@ -66,7 +66,7 @@ void retrieveSupplementalInfo() throws IOException, InterruptedException {
 
     String title;
     String pages;
-    Collection<String> authors;
+    Collection<String> authors = null;
 
     try {
 
@@ -84,9 +84,9 @@ void retrieveSupplementalInfo() throws IOException, InterruptedException {
       title = volumeInfo.optString("title");
       pages = volumeInfo.optString("pageCount");
 
-      authors = new ArrayList<String>();
       JSONArray authorsArray = volumeInfo.optJSONArray("authors");
       if (authorsArray != null && !authorsArray.isNull(0)) {
+        authors = new ArrayList<String>();
         for (int i = 0; i < authorsArray.length(); i++) {
           authors.add(authorsArray.getString(i));
         }

File: android/src/com/google/zxing/client/android/wifi/NetworkType.java
Patch:
@@ -23,6 +23,9 @@ enum NetworkType {
   NO_PASSWORD;
 
   static NetworkType forIntentValue(String networkTypeString) {
+    if (networkTypeString == null) {
+      return NO_PASSWORD;
+    }
     if ("WPA".equals(networkTypeString)) {
       return WPA;
     }

File: core/src/com/google/zxing/Binarizer.java
Patch:
@@ -32,9 +32,6 @@ public abstract class Binarizer {
   private final LuminanceSource source;
 
   protected Binarizer(LuminanceSource source) {
-    if (source == null) {
-      throw new IllegalArgumentException("Source must be non-null.");
-    }
     this.source = source;
   }
 

File: core/src/com/google/zxing/MultiFormatReader.java
Patch:
@@ -36,7 +36,7 @@
 public final class MultiFormatReader implements Reader {
 
   private Hashtable hints;
-  private Vector readers;
+  private final Vector readers = new Vector();
 
   /**
    * This version of decode honors the intent of Reader.decode(BinaryBitmap) in that it
@@ -75,7 +75,7 @@ public Result decode(BinaryBitmap image, Hashtable hints) throws NotFoundExcepti
    */
   public Result decodeWithState(BinaryBitmap image) throws NotFoundException {
     // Make sure to set up the default state so we don't crash
-    if (readers == null) {
+    if (readers.isEmpty()) {
       setHints(null);
     }
     return decodeInternal(image);
@@ -93,7 +93,7 @@ public void setHints(Hashtable hints) {
 
     boolean tryHarder = hints != null && hints.containsKey(DecodeHintType.TRY_HARDER);
     Vector formats = hints == null ? null : (Vector) hints.get(DecodeHintType.POSSIBLE_FORMATS);
-    readers = new Vector();
+    readers.clear();
     if (formats != null) {
       boolean addOneDReader =
           formats.contains(BarcodeFormat.UPC_A) ||

File: core/src/com/google/zxing/client/result/AddressBookDoCoMoResultParser.java
Patch:
@@ -37,7 +37,7 @@ final class AddressBookDoCoMoResultParser extends AbstractDoCoMoResultParser {
 
   public static AddressBookParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null || !rawText.startsWith("MECARD:")) {
+    if (!rawText.startsWith("MECARD:")) {
       return null;
     }
     String[] rawName = matchDoCoMoPrefixedField("N:", rawText, true);

File: core/src/com/google/zxing/client/result/BizcardResultParser.java
Patch:
@@ -35,7 +35,7 @@ final class BizcardResultParser extends AbstractDoCoMoResultParser {
 
   public static AddressBookParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null || !rawText.startsWith("BIZCARD:")) {
+    if (!rawText.startsWith("BIZCARD:")) {
       return null;
     }
     String firstName = matchSingleDoCoMoPrefixedField("N:", rawText, true);

File: core/src/com/google/zxing/client/result/BookmarkDoCoMoResultParser.java
Patch:
@@ -28,7 +28,7 @@ private BookmarkDoCoMoResultParser() {
 
   public static URIParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null || !rawText.startsWith("MEBKM:")) {
+    if (!rawText.startsWith("MEBKM:")) {
       return null;
     }
     String title = matchSingleDoCoMoPrefixedField("TITLE:", rawText, true);

File: core/src/com/google/zxing/client/result/EmailAddressResultParser.java
Patch:
@@ -30,9 +30,6 @@ final class EmailAddressResultParser extends ResultParser {
 
   public static EmailAddressParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null) {
-      return null;
-    }
     String emailAddress;
     if (rawText.startsWith("mailto:") || rawText.startsWith("MAILTO:")) {
       // If it starts with mailto:, assume it is definitely trying to be an email address

File: core/src/com/google/zxing/client/result/EmailDoCoMoResultParser.java
Patch:
@@ -32,7 +32,7 @@ final class EmailDoCoMoResultParser extends AbstractDoCoMoResultParser {
 
   public static EmailAddressParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null || !rawText.startsWith("MATMSG:")) {
+    if (!rawText.startsWith("MATMSG:")) {
       return null;
     }
     String[] rawTo = matchDoCoMoPrefixedField("TO:", rawText, true);

File: core/src/com/google/zxing/client/result/ExpandedProductParsedResult.java
Patch:
@@ -189,6 +189,6 @@ public Hashtable getUncommonAIs() {
   }
 
   public String getDisplayResult() {
-    return productID;
+    return String.valueOf(productID);
   }
 }

File: core/src/com/google/zxing/client/result/ISBNResultParser.java
Patch:
@@ -37,9 +37,6 @@ public static ISBNParsedResult parse(Result result) {
       return null;
     }
     String rawText = result.getText();
-    if (rawText == null) {
-      return null;
-    }
     int length = rawText.length();
     if (length != 13) {
       return null;

File: core/src/com/google/zxing/client/result/SMSMMSResultParser.java
Patch:
@@ -43,9 +43,6 @@ private SMSMMSResultParser() {
 
   public static SMSParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null) {
-      return null;
-    }
     if (!(rawText.startsWith("sms:") || rawText.startsWith("SMS:") ||
           rawText.startsWith("mms:") || rawText.startsWith("MMS:"))) {
       return null;

File: core/src/com/google/zxing/client/result/SMSParsedResult.java
Patch:
@@ -53,7 +53,7 @@ public String getSMSURI() {
         result.append(',');
       }
       result.append(numbers[i]);
-      if (vias[i] != null) {
+      if (vias != null && vias[i] != null) {
         result.append(";via=");
         result.append(vias[i]);
       }

File: core/src/com/google/zxing/client/result/SMSTOMMSTOResultParser.java
Patch:
@@ -35,9 +35,6 @@ private SMSTOMMSTOResultParser() {
 
   public static SMSParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null) {
-      return null;
-    }
     if (!(rawText.startsWith("smsto:") || rawText.startsWith("SMSTO:") ||
           rawText.startsWith("mmsto:") || rawText.startsWith("MMSTO:"))) {
       return null;

File: core/src/com/google/zxing/client/result/SMTPResultParser.java
Patch:
@@ -33,9 +33,6 @@ private SMTPResultParser() {
 
   public static EmailAddressParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null) {
-      return null;
-    }
     if (!(rawText.startsWith("smtp:") || rawText.startsWith("SMTP:"))) {
       return null;
     }

File: core/src/com/google/zxing/client/result/TelResultParser.java
Patch:
@@ -30,7 +30,7 @@ private TelResultParser() {
 
   public static TelParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null || (!rawText.startsWith("tel:") && !rawText.startsWith("TEL:"))) {
+    if (!rawText.startsWith("tel:") && !rawText.startsWith("TEL:")) {
       return null;
     }
     // Normalize "TEL:" to "tel:"

File: core/src/com/google/zxing/client/result/URLTOResultParser.java
Patch:
@@ -32,7 +32,7 @@ private URLTOResultParser() {
 
   public static URIParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null || (!rawText.startsWith("urlto:") && !rawText.startsWith("URLTO:"))) {
+    if (!rawText.startsWith("urlto:") && !rawText.startsWith("URLTO:")) {
       return null;
     }
     int titleEnd = rawText.indexOf(':', 6);

File: core/src/com/google/zxing/client/result/VCardResultParser.java
Patch:
@@ -38,7 +38,7 @@ public static AddressBookParsedResult parse(Result result) {
     // to throw out everything else we parsed just because this was omitted. In fact, Eclair
     // is doing just that, and we can't parse its contacts without this leniency.
     String rawText = result.getText();
-    if (rawText == null || !rawText.startsWith("BEGIN:VCARD")) {
+    if (!rawText.startsWith("BEGIN:VCARD")) {
       return null;
     }
     Vector names = matchVCardPrefixedField("FN", rawText, true);

File: core/src/com/google/zxing/common/DecoderResult.java
Patch:
@@ -33,9 +33,6 @@ public final class DecoderResult {
   private final String ecLevel;
 
   public DecoderResult(byte[] rawBytes, String text, Vector byteSegments, String ecLevel) {
-    if (rawBytes == null && text == null) {
-      throw new IllegalArgumentException();
-    }
     this.rawBytes = rawBytes;
     this.text = text;
     this.byteSegments = byteSegments;

File: core/src/com/google/zxing/common/GridSampler.java
Patch:
@@ -45,9 +45,6 @@ public abstract class GridSampler {
    * @param newGridSampler The platform-specific object to install.
    */
   public static void setGridSampler(GridSampler newGridSampler) {
-    if (newGridSampler == null) {
-      throw new IllegalArgumentException();
-    }
     gridSampler = newGridSampler;
   }
 

File: core/src/com/google/zxing/common/reedsolomon/GenericGFPoly.java
Patch:
@@ -40,7 +40,7 @@ final class GenericGFPoly {
    * constant polynomial (that is, it is not the monomial "0")
    */
   GenericGFPoly(GenericGF field, int[] coefficients) {
-    if (coefficients == null || coefficients.length == 0) {
+    if (coefficients.length == 0) {
       throw new IllegalArgumentException();
     }
     this.field = field;

File: core/src/com/google/zxing/multi/GenericMultipleBarcodeReader.java
Patch:
@@ -144,6 +144,9 @@ private void doDecodeMultiple(BinaryBitmap image,
 
   private static Result translateResultPoints(Result result, int xOffset, int yOffset) {
     ResultPoint[] oldResultPoints = result.getResultPoints();
+    if (oldResultPoints == null) {
+      return result;
+    }
     ResultPoint[] newResultPoints = new ResultPoint[oldResultPoints.length];
     for (int i = 0; i < oldResultPoints.length; i++) {
       ResultPoint oldPoint = oldResultPoints[i];

File: core/src/com/google/zxing/multi/qrcode/detector/MultiDetector.java
Patch:
@@ -46,7 +46,7 @@ public DetectorResult[] detectMulti(Hashtable hints) throws NotFoundException {
     MultiFinderPatternFinder finder = new MultiFinderPatternFinder(image);
     FinderPatternInfo[] info = finder.findMulti(hints);
 
-    if (info == null || info.length == 0) {
+    if (info.length == 0) {
       throw NotFoundException.getNotFoundInstance();
     }
 

File: core/src/com/google/zxing/oned/OneDimensionalCodeWriter.java
Patch:
@@ -53,7 +53,7 @@ public BitMatrix encode(String contents,
                           int width,
                           int height,
                           Hashtable hints) throws WriterException {
-    if (contents == null || contents.length() == 0) {
+    if (contents.length() == 0) {
       throw new IllegalArgumentException("Found empty contents");
     }
 

File: core/src/com/google/zxing/oned/rss/RSSUtils.java
Patch:
@@ -98,7 +98,7 @@ public static int getRSSvalue(int[] widths, int maxWidth, boolean noNarrow) {
     return val;
   }
 
-  static int combins(int n, int r) {
+  private static int combins(int n, int r) {
     int maxDenom;
     int minDenom;
     if (n - r > r) {

File: core/src/com/google/zxing/oned/rss/expanded/decoders/AbstractExpandedDecoder.java
Patch:
@@ -48,7 +48,8 @@ public abstract class AbstractExpandedDecoder {
   public static AbstractExpandedDecoder createDecoder(BitArray information){
     if (information.get(1)) {
       return new AI01AndOtherAIs(information);
-    } else if (!information.get(2)) {
+    }
+    if (!information.get(2)) {
       return new AnyAIDecoder(information);
     }
 

File: core/src/com/google/zxing/pdf417/encoder/BarcodeRow.java
Patch:
@@ -77,8 +77,8 @@ byte[] getRow() {
    */
   byte[] getScaledRow(int scale) {
     byte[] output = new byte[row.length * scale];
-    for (int ii = 0; ii < row.length * scale; ii++) {
-      output[ii] = row[ii / scale];
+    for (int i = 0; i < output.length; i++) {
+      output[i] = row[i / scale];
     }
     return output;
   }

File: core/src/com/google/zxing/qrcode/decoder/Mode.java
Patch:
@@ -87,9 +87,6 @@ public static Mode forBits(int bits) {
    *         count of characters that will follow encoded in this Mode
    */
   public int getCharacterCountBits(Version version) {
-    if (characterCountBitsForVersions == null) {
-      throw new IllegalArgumentException("Character count doesn't apply to this mode");
-    }
     int number = version.getVersionNumber();
     int offset;
     if (number <= 9) {

File: core/test/src/com/google/zxing/client/result/ExpandedProductParsedResultTestCase.java
Patch:
@@ -60,6 +60,7 @@ public void test_RSSExpanded() {
 
     Result result = new Result(text, null, null, BarcodeFormat.RSS_EXPANDED);
     ExpandedProductParsedResult o = ExpandedProductResultParser.parse(result);
+    assertNotNull(o);
     assertEquals(productID, o.getProductID());
     assertEquals(sscc, o.getSscc());
     assertEquals(lotNumber, o.getLotNumber());

File: core/test/src/com/google/zxing/client/result/ParsedReaderResultTestCase.java
Patch:
@@ -316,7 +316,7 @@ public void testNDEFSmartPoster() {
    */
 
   private static void doTestResult(String contents, String goldenResult, ParsedResultType type) {
-    doTestResult(contents, goldenResult, type, null);
+    doTestResult(contents, goldenResult, type, BarcodeFormat.QR_CODE); // QR code is arbitrary
   }
 
   private static void doTestResult(String contents, String goldenResult, ParsedResultType type,

File: core/test/src/com/google/zxing/common/reedsolomon/ReedSolomonEncoderQRCodeTestCase.java
Patch:
@@ -45,9 +45,10 @@ public void testQRCodeVersusDecoder() throws Exception {
     ReedSolomonEncoder encoder = new ReedSolomonEncoder(GenericGF.QR_CODE_FIELD_256);
     ReedSolomonDecoder decoder = new ReedSolomonDecoder(GenericGF.QR_CODE_FIELD_256);
     for (int i = 0; i < 100; i++) {
-      int size = random.nextInt(1000);
+      int size = 1 + random.nextInt(1000);
       int[] toEncode = new int[size];
       int ecBytes = 1 + random.nextInt(2 * (1 + size / 8));
+      ecBytes = Math.min(ecBytes, size - 1);
       int dataBytes = size - ecBytes;
       for (int j = 0; j < dataBytes; j++) {
         toEncode[j] = random.nextInt(256);

File: core/test/src/com/google/zxing/qrcode/decoder/FormatInformationTestCase.java
Patch:
@@ -40,6 +40,7 @@ public void testDecode() {
     // Normal case
     FormatInformation expected =
         FormatInformation.decodeFormatInformation(MASKED_TEST_FORMAT_INFO, MASKED_TEST_FORMAT_INFO);
+    assertNotNull(expected);
     assertEquals((byte) 0x07, expected.getDataMask());
     assertSame(ErrorCorrectionLevel.Q, expected.getErrorCorrectionLevel());
     // where the code forgot the mask!

File: javase/src/com/google/zxing/client/j2se/CommandLineRunner.java
Patch:
@@ -68,7 +68,7 @@ public static void main(String[] args) throws Exception {
       } else if (arg.startsWith("--crop")) {
         int[] crop = new int[4];
         String[] tokens = arg.substring(7).split(",");
-        for (int i = 0; i < config.getCrop().length; i++) {
+        for (int i = 0; i < crop.length; i++) {
           crop[i] = Integer.parseInt(tokens[i]);
         }
         config.setCrop(crop);

File: javase/src/com/google/zxing/client/j2se/GUIRunner.java
Patch:
@@ -102,7 +102,7 @@ private static String getDecodeText(File file) {
     } catch (ReaderException re) {
       return re.toString();
     }
-    return result.getText();
+    return String.valueOf(result.getText());
   }
 
 }

File: android/src/com/google/zxing/client/android/result/EmailAddressResultHandler.java
Patch:
@@ -60,7 +60,7 @@ public void handleButtonPress(int index) {
       case 1:
         String[] addresses = new String[1];
         addresses[0] = emailResult.getEmailAddress();
-        addContact(null, null, addresses, null, null, null, null);
+        addEmailOnlyContact(addresses, null);
         break;
     }
   }

File: android/src/com/google/zxing/client/android/result/TelResultHandler.java
Patch:
@@ -58,7 +58,7 @@ public void handleButtonPress(int index) {
       case 1:
         String[] numbers = new String[1];
         numbers[0] = telResult.getNumber();
-        addContact(null, numbers, null, null, null, null, null);
+        addPhoneOnlyContact(numbers, null);
         break;
     }
   }

File: android/src/com/google/zxing/client/android/HelpActivity.java
Patch:
@@ -55,7 +55,8 @@ public final class HelpActivity extends Activity {
   public static final String DEFAULT_PAGE = "index.html";
   public static final String WHATS_NEW_PAGE = "whatsnew.html";
 
-  private static final String BASE_URL = "file:///android_asset/html/";
+  private static final String BASE_URL =
+      "file:///android_asset/html-" + LocaleManager.getTranslatedAssetLanguage() + '/';
   private static final String WEBVIEW_STATE_PRESENT = "webview_state_present";
 
   private static boolean initialized = false;

File: android/src/com/google/zxing/client/android/book/SearchBookContentsActivity.java
Patch:
@@ -259,7 +259,7 @@ public void run() {
         // break or disappear at any time in the future. Since this is an API call rather than a
         // website, we don't use LocaleManager to change the TLD.
         URI uri;
-        if (isbn.startsWith("http://google.com/books?id=")) {
+        if (LocaleManager.isBookSearchUrl(isbn)) {
           int equals = isbn.indexOf('=');
           String volumeId = isbn.substring(equals + 1);
           uri = new URI("http", null, "www.google.com", -1, "/books", "id=" + volumeId +

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/ContactInfoGenerator.java
Patch:
@@ -194,7 +194,7 @@ public Grid getWidget() {
       // early termination if the table has already been constructed
       return table;
     }
-    table = new Grid(7, 2);
+    table = new Grid(8, 2);
     
     table.setText(0, 0, "Name");
     table.setWidget(0, 1, name);

File: android/src/com/google/zxing/client/android/result/supplement/URIResultInfoRetriever.java
Patch:
@@ -48,7 +48,7 @@ final class URIResultInfoRetriever extends SupplementalInfoRetriever {
                          Handler handler,
                          HistoryManager historyManager,
                          Context context) {
-    super(textView, handler, historyManager, context);
+    super(textView, handler, historyManager);
     redirectString = context.getString(R.string.msg_redirect);
     this.result = result;
   }
@@ -59,12 +59,11 @@ void retrieveSupplementalInfo() throws IOException, InterruptedException {
     String newURI = unredirect(oldURI);
     int count = 0;
     while (count < 3 && !oldURI.equals(newURI)) {
-      append(result.getDisplayResult(), redirectString + " : " + newURI);
+      append(result.getDisplayResult(), null, new String[] { redirectString + " : " + newURI }, newURI);
       count++;
       oldURI = newURI;
       newURI = unredirect(newURI);
     }
-    setLink(newURI);
   }
 
   private static String unredirect(String uri) throws IOException {

File: core/src/com/google/zxing/oned/rss/expanded/RSSExpandedReader.java
Patch:
@@ -366,7 +366,7 @@ private FinderPattern parseFoundFinderPattern(BitArray row, int rowNumber, boole
       start = this.startEnd[0];
 
       int firstElementStart = this.startEnd[1] + 1;
-      while(row.get(firstElementStart) && firstElementStart < row.size) {
+      while (firstElementStart < row.size && row.get(firstElementStart)) {
         firstElementStart++;
       }
 

File: core/src/com/google/zxing/datamatrix/decoder/DecodedBitStreamParser.java
Patch:
@@ -235,7 +235,7 @@ private static void decodeC40Segment(BitSource bits, StringBuffer result) throws
                 result.append(c40char);
               }
             } else if (cValue == 27) {  // FNC1
-              throw FormatException.getFormatInstance();
+              // ignore
             } else if (cValue == 30) {  // Upper Shift
               upperShift = true;
             } else {
@@ -437,7 +437,7 @@ private static void decodeEdifactSegment(BitSource bits, StringBuffer result) {
   private static void decodeBase256Segment(BitSource bits, StringBuffer result, Vector byteSegments)
       throws FormatException {
     // Figure out how long the Base 256 Segment is.
-    int codewordPosition = 2;
+    int codewordPosition = 1 + bits.getByteOffset(); // position is 1-indexed
     int d1 = unrandomize255State(bits.readBits(8), codewordPosition++);
     int count;
     if (d1 == 0) {  // Read the remainder of the symbol

File: core/src/com/google/zxing/oned/ITFReader.java
Patch:
@@ -50,7 +50,7 @@ public final class ITFReader extends OneDReader {
   private static final int W = 3; // Pixel width of a wide line
   private static final int N = 1; // Pixed width of a narrow line
 
-  private static final int[] DEFAULT_ALLOWED_LENGTHS = { 6, 8, 10, 12, 14, 16, 20, 24, 44 };
+  private static final int[] DEFAULT_ALLOWED_LENGTHS = { 44, 24, 20, 18, 16, 14, 12, 10, 8, 6 };
 
   // Stores the actual narrow line width of the image being decoded.
   private int narrowLineWidth = -1;

File: core/src/com/google/zxing/datamatrix/decoder/DecodedBitStreamParser.java
Patch:
@@ -221,7 +221,7 @@ private static void decodeC40Segment(BitSource bits, StringBuffer result) throws
               result.append((char) (cValue + 128));
               upperShift = false;
             } else {
-              result.append(cValue);
+              result.append((char) cValue);
             }
             shift = 0;
             break;
@@ -305,7 +305,7 @@ private static void decodeTextSegment(BitSource bits, StringBuffer result) throw
               result.append((char) (cValue + 128));
               upperShift = false;
             } else {
-              result.append(cValue);
+              result.append((char) cValue);
             }
             shift = 0;
             break;
@@ -320,7 +320,7 @@ private static void decodeTextSegment(BitSource bits, StringBuffer result) throw
                 result.append(c40char);
               }
             } else if (cValue == 27) {  // FNC1
-              throw FormatException.getFormatInstance();
+              // ignore
             } else if (cValue == 30) {  // Upper Shift
               upperShift = true;
             } else {

File: core/src/com/google/zxing/datamatrix/decoder/DecodedBitStreamParser.java
Patch:
@@ -184,6 +184,8 @@ private static void decodeC40Segment(BitSource bits, StringBuffer result) throws
     boolean upperShift = false;
 
     int[] cValues = new int[3];
+    int shift = 0;
+
     do {
       // If there is only one byte left then it will be encoded as ASCII
       if (bits.available() == 8) {
@@ -196,7 +198,6 @@ private static void decodeC40Segment(BitSource bits, StringBuffer result) throws
 
       parseTwoBytes(firstByte, bits.readBits(8), cValues);
 
-      int shift = 0;
       for (int i = 0; i < 3; i++) {
         int cValue = cValues[i];
         switch (shift) {

File: core/src/com/google/zxing/datamatrix/decoder/DecodedBitStreamParser.java
Patch:
@@ -421,10 +421,10 @@ private static void decodeEdifactSegment(BitSource bits, StringBuffer result) {
         }
 
         if (!unlatch) {
-          if ((edifactValue & 32) == 0) {  // no 1 in the leading (6th) bit
-            edifactValue |= 64;  // Add a leading 01 to the 6 bit binary value
+          if ((edifactValue & 0x20) == 0) {  // no 1 in the leading (6th) bit
+            edifactValue |= 0x40;  // Add a leading 01 to the 6 bit binary value
           }
-          result.append(edifactValue);
+          result.append((char) edifactValue);
         }
       }
     } while (!unlatch && bits.available() > 0);

File: javase/src/com/google/zxing/client/j2se/DecodeThread.java
Patch:
@@ -341,7 +341,9 @@ private static void writeResultImage(int stride, int height, int[] pixels, URI u
     OutputStream outStream = null;
     try {
       outStream = new FileOutputStream(resultName);
-      ImageIO.write(result, "png", outStream);
+      if (!ImageIO.write(result, "png", outStream)) {
+        System.err.println("Could not encode an image to " + resultName);
+      }
     } catch (FileNotFoundException e) {
       System.err.println("Could not create " + resultName);
     } catch (IOException e) {

File: android/src/com/google/zxing/client/android/book/SearchBookContentsActivity.java
Patch:
@@ -126,6 +126,7 @@ public void onCreate(Bundle icicle) {
     }
 
     isbn = intent.getStringExtra(Intents.SearchBookContents.ISBN);
+    // FIXME(dswitkin): Should not hardcode Books URL. Also does not handle books.google.ca etc.
     if (isbn.startsWith("http://google.com/books?id=")) {
       setTitle(getString(R.string.sbc_name));
     } else {

File: android/src/com/google/zxing/client/android/result/ResultHandler.java
Patch:
@@ -364,10 +364,10 @@ final void openBookSearch(String isbn) {
     launchIntent(new Intent(Intent.ACTION_VIEW, uri));
   }
 
-  final void searchBookContents(String isbn) {
+  final void searchBookContents(String isbnOrUrl) {
     Intent intent = new Intent(Intents.SearchBookContents.ACTION);
     intent.setClassName(activity, SearchBookContentsActivity.class.getName());
-    putExtra(intent, Intents.SearchBookContents.ISBN, isbn);
+    putExtra(intent, Intents.SearchBookContents.ISBN, isbnOrUrl);
     launchIntent(intent);
   }
 

File: android/src/com/google/zxing/client/android/result/URIResultHandler.java
Patch:
@@ -76,6 +76,7 @@ public int getDisplayTitle() {
   }
 
   private boolean isGoogleBooksURI() {
+    // FIXME(dswitkin): Should not hardcode Books URL. Also does not handle books.google.ca etc.
     return ((URIParsedResult) getResult()).getURI().startsWith("http://google.com/books?id=");
   }
 

File: android/src/com/google/zxing/client/android/wifi/WifiActivity.java
Patch:
@@ -216,10 +216,9 @@ protected void onCreate(Bundle savedInstanceState) {
     } else if ("WEP".equals(networkType)) {
       networkT = NetworkType.NETWORK_WEP;
     } else if ("nopass".equals(networkType)) {
-     networkT = NetworkType.NETWORK_NOPASS;
+      networkT = NetworkType.NETWORK_NOPASS;
     } else {
-      doError(R.string.wifi_type_incorrect);
-      return;
+      networkT = NetworkType.NETWORK_INVALID;
     }
 
     // This is not available before onCreate

File: android/src/com/google/zxing/client/android/DecodeFormatManager.java
Patch:
@@ -56,15 +56,15 @@ private DecodeFormatManager() {}
 
   static Vector<BarcodeFormat> parseDecodeFormats(Intent intent) {
     List<String> scanFormats = null;
-    String scanFormatsString = intent.getStringExtra(Intents.Scan.SCAN_FORMATS);
+    String scanFormatsString = intent.getStringExtra(Intents.Scan.FORMATS);
     if (scanFormatsString != null) {
       scanFormats = Arrays.asList(COMMA_PATTERN.split(scanFormatsString));
     }
     return parseDecodeFormats(scanFormats, intent.getStringExtra(Intents.Scan.MODE));
   }
 
   static Vector<BarcodeFormat> parseDecodeFormats(Uri inputUri) {
-    List<String> formats = inputUri.getQueryParameters(Intents.Scan.SCAN_FORMATS);
+    List<String> formats = inputUri.getQueryParameters(Intents.Scan.FORMATS);
     if (formats != null && formats.size() == 1 && formats.get(0) != null){
       formats = Arrays.asList(COMMA_PATTERN.split(formats.get(0)));
     }

File: android/src/com/google/zxing/client/android/DecodeHandler.java
Patch:
@@ -49,7 +49,6 @@ final class DecodeHandler extends Handler {
   public void handleMessage(Message message) {
     switch (message.what) {
       case R.id.decode:
-        //Log.d(TAG, "Got decode message");
         decode((byte[]) message.obj, message.arg1, message.arg2);
         break;
       case R.id.quit:
@@ -86,7 +85,6 @@ private void decode(byte[] data, int width, int height) {
       Bundle bundle = new Bundle();
       bundle.putParcelable(DecodeThread.BARCODE_BITMAP, source.renderCroppedGreyscaleBitmap());
       message.setData(bundle);
-      //Log.d(TAG, "Sending decode succeeded message...");
       message.sendToTarget();
     } else {
       Message message = Message.obtain(activity.getHandler(), R.id.decode_failed);

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -84,7 +84,8 @@ private void disableLastCheckedPref() {
       checked.add(decodeDataMatrix);
     }
     boolean disable = checked.size() < 2;
-    for (CheckBoxPreference pref : new CheckBoxPreference[] {decode1D, decodeQR, decodeDataMatrix}) {
+    CheckBoxPreference[] checkBoxPreferences = {decode1D, decodeQR, decodeDataMatrix};
+    for (CheckBoxPreference pref : checkBoxPreferences) {
       pref.setEnabled(!(disable && checked.contains(pref)));
     }
   }

File: android/src/com/google/zxing/client/android/result/supplement/ProductResultInfoRetriever.java
Patch:
@@ -48,7 +48,8 @@ final class ProductResultInfoRetriever extends SupplementalInfoRetriever {
 
   private final String productID;
 
-  ProductResultInfoRetriever(TextView textView, String productID, Handler handler, Context context) {
+  ProductResultInfoRetriever(TextView textView, String productID, Handler handler,
+      Context context) {
     super(textView, handler, context);
     this.productID = productID;
   }
@@ -107,5 +108,4 @@ private static String consume(HttpEntity entity) {
     }
   }
 
-
 }

File: android/src/com/google/zxing/client/android/result/supplement/URIResultInfoRetriever.java
Patch:
@@ -42,7 +42,8 @@ final class URIResultInfoRetriever extends SupplementalInfoRetriever {
   private final URIParsedResult result;
   private final String redirectString;
 
-  URIResultInfoRetriever(TextView textView, URIParsedResult result, Handler handler, Context context) {
+  URIResultInfoRetriever(TextView textView, URIParsedResult result, Handler handler,
+      Context context) {
     super(textView, handler, context);
     redirectString = context.getString(R.string.msg_redirect);
     this.result = result;

File: android/src/com/google/zxing/client/android/share/AppPickerActivity.java
Patch:
@@ -36,16 +36,16 @@ protected void onCreate(Bundle icicle) {
     if (labelsPackages.isEmpty()) {
       new LoadPackagesAsyncTask(this).execute(labelsPackages);
     }
-    // otherwise use last copy we loaded -- apps don't change much, and it takes
-    // forever to load for some reason
+    // Otherwise use last copy we loaded -- apps don't change much, and it takes
+    // forever to load for some reason.
   }
 
   @Override
   protected void onListItemClick(ListView l, View view, int position, long id) {
     if (position >= 0 && position < labelsPackages.size()) {
       String url = "market://search?q=pname:" + labelsPackages.get(position)[1];
       Intent intent = new Intent();
-      intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);      
+      intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);
       intent.putExtra(Browser.BookmarkColumns.URL, url);
       setResult(RESULT_OK, intent);
     } else {

File: android/src/com/google/zxing/client/android/share/LoadPackagesAsyncTask.java
Patch:
@@ -33,7 +33,7 @@
  *
  * @author Sean Owen
  */
-final class LoadPackagesAsyncTask extends AsyncTask<List<String[]>,Void,List<String[]>> {
+final class LoadPackagesAsyncTask extends AsyncTask<List<String[]>, Void, List<String[]>> {
 
   private static final String[] PKG_PREFIX_WHITELIST = {
       "com.google.android.apps.",
@@ -45,7 +45,6 @@ final class LoadPackagesAsyncTask extends AsyncTask<List<String[]>,Void,List<Str
       "com.htc",
   };
 
-
   private final AppPickerActivity activity;
 
   LoadPackagesAsyncTask(AppPickerActivity activity) {
@@ -93,7 +92,8 @@ protected synchronized void onPostExecute(List<String[]> results) {
     for (String[] result : results) {
       labels.add(result[0]);
     }
-    ListAdapter listAdapter = new ArrayAdapter<String>(activity, android.R.layout.simple_list_item_1, labels);
+    ListAdapter listAdapter = new ArrayAdapter<String>(activity,
+        android.R.layout.simple_list_item_1, labels);
     activity.setListAdapter(listAdapter);
   }
 

File: android/src/com/google/zxing/client/android/wifi/Killer.java
Patch:
@@ -42,6 +42,7 @@ final class Killer implements Runnable {
   Killer(Activity parent) {
     this.parent = parent;
   }
+
   void launchIntent(Intent intent) {
     if (intent != null) {
       intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);

File: android/src/com/google/zxing/client/android/book/SearchBookContentsActivity.java
Patch:
@@ -100,7 +100,7 @@ public void onClick(View view) {
 
   private final View.OnKeyListener keyListener = new View.OnKeyListener() {
     public boolean onKey(View view, int keyCode, KeyEvent event) {
-      if (keyCode == KeyEvent.KEYCODE_ENTER) {
+      if (keyCode == KeyEvent.KEYCODE_ENTER && event.getAction() == KeyEvent.ACTION_DOWN) {
         launchSearch();
         return true;
       }

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox2TestCase.java
Patch:
@@ -33,8 +33,8 @@ public final class PDF417BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox2TestCase() {
     super("test/data/blackbox/pdf417-2", new MultiFormatReader(), BarcodeFormat.PDF417);
-    addTest(11, 11, 0.0f);
-    addTest(11, 11, 180.0f);
+    addTest(13, 13, 0.0f);
+    addTest(13, 13, 180.0f);
   }
 
   @Override

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -220,7 +220,8 @@ protected void onResume() {
     }
 
     SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);
-    copyToClipboard = prefs.getBoolean(PreferencesActivity.KEY_COPY_TO_CLIPBOARD, true);
+    copyToClipboard = prefs.getBoolean(PreferencesActivity.KEY_COPY_TO_CLIPBOARD, true)
+        && (intent == null || intent.getBooleanExtra(Intents.Scan.SAVE_HISTORY, true));
 
     beepManager.updatePrefs();
     

File: core/src/com/google/zxing/oned/CodaBarReader.java
Patch:
@@ -41,7 +41,7 @@ public final class CodaBarReader extends OneDReader {
    */
   private static final int[] CHARACTER_ENCODINGS = {
       0x003, 0x006, 0x009, 0x060, 0x012, 0x042, 0x021, 0x024, 0x030, 0x048, // 0-9
-      0x00c, 0x018, 0x025, 0x051, 0x054, 0x015, 0x01A, 0x029, 0x00B, 0x00E, // -$:/.+ABCD
+      0x00c, 0x018, 0x045, 0x051, 0x054, 0x015, 0x01A, 0x029, 0x00B, 0x00E, // -$:/.+ABCD
       0x01A, 0x029 //TN
   };
 

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -223,6 +223,8 @@ protected void onResume() {
     copyToClipboard = prefs.getBoolean(PreferencesActivity.KEY_COPY_TO_CLIPBOARD, true);
 
     beepManager.updatePrefs();
+    
+    inactivityTimer.onResume();
   }
 
   @Override
@@ -232,6 +234,7 @@ protected void onPause() {
       handler.quitSynchronously();
       handler = null;
     }
+    inactivityTimer.onPause();
     CameraManager.get().closeDriver();
   }
 

File: core/test/src/com/google/zxing/oned/EAN13BlackBox1TestCase.java
Patch:
@@ -27,8 +27,8 @@ public final class EAN13BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox1TestCase() {
     super("test/data/blackbox/ean13-1", new MultiFormatReader(), BarcodeFormat.EAN_13);
-    addTest(30, 32, 0.0f);
-    addTest(27, 32, 180.0f);
+    addTest(29, 32, 0.0f);
+    addTest(28, 32, 180.0f);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/oned/UPCABlackBox5TestCase.java
Patch:
@@ -27,8 +27,8 @@ public final class UPCABlackBox5TestCase extends AbstractBlackBoxTestCase {
 
   public UPCABlackBox5TestCase() {
     super("test/data/blackbox/upca-5", new MultiFormatReader(), BarcodeFormat.UPC_A);
-    addTest(19, 22, 0.0f);
-    addTest(21, 22, 180.0f);
+    addTest(19, 23, 0.0f);
+    addTest(20, 23, 180.0f);
   }
 
 }

File: core/src/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -46,7 +46,7 @@ public final class Detector {
   private final BitMatrix image;
   private final WhiteRectangleDetector rectangleDetector;
 
-  public Detector(BitMatrix image) {
+  public Detector(BitMatrix image) throws NotFoundException {
     this.image = image;
     rectangleDetector = new WhiteRectangleDetector(image);
   }

File: core/src/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -252,7 +252,7 @@ private static void decodeTextCompaction(int[] textCompactionData,
           } else {
             if (subModeCh == 26) {
               ch = ' ';
-            } else if (subModeCh == AL) {
+            } else if (subModeCh == AS) {
               subMode = ALPHA;
             } else if (subModeCh == ML) {
               subMode = MIXED;

File: core/src/com/google/zxing/client/result/URIParsedResult.java
Patch:
@@ -79,6 +79,7 @@ public String getDisplayResult() {
    * the protocol.
    */
   private static String massageURI(String uri) {
+    uri = uri.trim();
     int protocolEnd = uri.indexOf(':');
     if (protocolEnd < 0) {
       // No protocol, assume http

File: core/src/com/google/zxing/client/result/URIResultParser.java
Patch:
@@ -34,6 +34,9 @@ public static URIParsedResult parse(Result result) {
     if (rawText != null && rawText.startsWith("URL:")) {
       rawText = rawText.substring(4);
     }
+    if (rawText != null) {
+      rawText = rawText.trim();
+    }
     if (!isBasicallyValidURI(rawText)) {
       return null;
     }

File: android/src/com/google/zxing/client/android/history/HistoryManager.java
Patch:
@@ -57,7 +57,7 @@ public final class HistoryManager {
 
   private static final String TAG = HistoryManager.class.getSimpleName();
 
-  private static final int MAX_ITEMS = 50;
+  private static final int MAX_ITEMS = 500;
   //private static final String[] TEXT_COL_PROJECTION = { DBHelper.TEXT_COL };
   private static final String[] GET_ITEM_COL_PROJECTION = {
       DBHelper.TEXT_COL,

File: core/test/src/com/google/zxing/datamatrix/DataMatrixBlackBox2TestCase.java
Patch:
@@ -17,6 +17,7 @@
 package com.google.zxing.datamatrix;
 
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**
@@ -25,8 +26,7 @@
 public final class DataMatrixBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public DataMatrixBlackBox2TestCase() {
-    // TODO use MultiFormatReader here once Data Matrix decoder is done
-    super("test/data/blackbox/datamatrix-2", new DataMatrixReader(), BarcodeFormat.DATA_MATRIX);
+    super("test/data/blackbox/datamatrix-2", new MultiFormatReader(), BarcodeFormat.DATA_MATRIX);
     addTest(10, 10, 0.0f);
     addTest(13, 13, 90.0f);
     addTest(16, 16, 180.0f);

File: android/src/com/google/zxing/client/android/result/ResultHandlerFactory.java
Patch:
@@ -46,7 +46,7 @@ public static ResultHandler makeResultHandler(Activity activity, Result rawResul
     } else if (type.equals(ParsedResultType.WIFI)) {
       return new WifiResultHandler(activity, result);
     } else if (type.equals(ParsedResultType.TEXT)) {
-      return new TextResultHandler(activity, result);
+      return new TextResultHandler(activity, result, rawResult);
     } else if (type.equals(ParsedResultType.GEO)) {
       return new GeoResultHandler(activity, result);
     } else if (type.equals(ParsedResultType.TEL)) {
@@ -59,7 +59,7 @@ public static ResultHandler makeResultHandler(Activity activity, Result rawResul
       return new ISBNResultHandler(activity, result, rawResult);
     } else {
       // The TextResultHandler is the fallthrough for unsupported formats.
-      return new TextResultHandler(activity, result);
+      return new TextResultHandler(activity, result, rawResult);
     }
   }
 

File: android/src/com/google/zxing/client/android/result/TextResultHandler.java
Patch:
@@ -16,6 +16,7 @@
 
 package com.google.zxing.client.android.result;
 
+import com.google.zxing.Result;
 import com.google.zxing.client.android.R;
 import com.google.zxing.client.result.ParsedResult;
 
@@ -35,8 +36,8 @@ public final class TextResultHandler extends ResultHandler {
       R.string.button_custom_product_search,
   };
 
-  public TextResultHandler(Activity activity, ParsedResult result) {
-    super(activity, result);
+  public TextResultHandler(Activity activity, ParsedResult result, Result rawResult) {
+    super(activity, result, rawResult);
   }
 
   @Override

File: android/src/com/google/zxing/client/android/encode/EncodeActivity.java
Patch:
@@ -16,7 +16,6 @@
 
 package com.google.zxing.client.android.encode;
 
-import android.content.Context;
 import android.view.Display;
 import android.view.WindowManager;
 import com.google.zxing.WriterException;
@@ -34,7 +33,6 @@
 import android.util.Log;
 import android.view.Menu;
 import android.view.MenuItem;
-import android.view.View;
 import android.widget.ImageView;
 import android.widget.TextView;
 

File: android/src/com/google/zxing/client/android/share/LoadPackagesAsyncTask.java
Patch:
@@ -16,14 +16,11 @@
 
 package com.google.zxing.client.android.share;
 
-import android.app.ProgressDialog;
-import android.content.DialogInterface;
 import android.content.pm.ApplicationInfo;
 import android.content.pm.PackageManager;
 import android.os.AsyncTask;
 import android.widget.ArrayAdapter;
 import android.widget.ListAdapter;
-import com.google.zxing.client.android.R;
 
 import java.io.Serializable;
 import java.util.ArrayList;

File: androidtest/src/com/google/zxing/client/androidtest/BenchmarkActivity.java
Patch:
@@ -25,8 +25,6 @@
 import android.widget.Button;
 import android.widget.TextView;
 
-import java.util.List;
-
 public final class BenchmarkActivity extends Activity {
 
   private static final String PATH = "/sdcard/zxingbenchmark";
@@ -76,7 +74,7 @@ public void handleMessage(Message message) {
   };
 
   private void handleBenchmarkDone(Message message) {
-    List<BenchmarkItem> items = (List<BenchmarkItem>) message.obj;
+    Iterable<BenchmarkItem> items = (Iterable<BenchmarkItem>) message.obj;
     int count = 0;
     int time = 0;
     for (BenchmarkItem item : items) {

File: androidtest/src/com/google/zxing/client/androidtest/BenchmarkThread.java
Patch:
@@ -66,8 +66,8 @@ private void walkTree(String path, List<BenchmarkItem> items) {
     if (file.isDirectory()) {
       String[] files = file.list();
       Arrays.sort(files);
-      for (int x = 0; x < files.length; x++) {
-        walkTree(file.getAbsolutePath() + '/' + files[x], items);
+      for (String f : files) {
+        walkTree(file.getAbsolutePath() + '/' + f, items);
       }
     } else {
       BenchmarkItem item = decode(path);

File: androidtest/src/com/google/zxing/client/androidtest/CameraManager.java
Patch:
@@ -58,7 +58,7 @@ final class CameraManager {
   private boolean previewing;
   private int previewFormat;
   private String previewFormatString;
-  private boolean useOneShotPreviewCallback;
+  private final boolean useOneShotPreviewCallback;
 
   /**
    * Preview frames are delivered here, which we pass on to the registered handler. Make sure to
@@ -288,7 +288,7 @@ private void setCameraParameters() {
   private String collectCameraParameters() {
     Camera.Parameters parameters = camera.getParameters();
     String[] params = parameters.flatten().split(";");
-    StringBuffer result = new StringBuffer();
+    StringBuilder result = new StringBuilder();
     result.append("Default camera parameters:");
     for (String param : params) {
       result.append("\n  ");

File: androidtest/src/com/google/zxing/client/androidtest/SaveThread.java
Patch:
@@ -63,7 +63,7 @@ public void handleMessage(Message message) {
 
   // Save the center rectangle of the Y channel as a greyscale PNG to the SD card.
   private void save(byte[] data, int width, int height) {
-    final Rect framingRect = CameraManager.get().getFramingRect();
+    Rect framingRect = CameraManager.get().getFramingRect();
     int framingWidth = framingRect.width();
     int framingHeight = framingRect.height();
     if (framingWidth > width || framingHeight > height) {

File: core/src/com/google/zxing/aztec/decoder/Decoder.java
Patch:
@@ -122,7 +122,7 @@ private String getEncodedData(boolean[] correctedBits) throws FormatException {
     int lastTable = UPPER;
     int table = UPPER;
     int startIndex = 0;
-    StringBuilder result = new StringBuilder(20);
+    StringBuffer result = new StringBuffer(20);
     boolean end = false;
     boolean shift = false;
     boolean switchShift = false;

File: core/src/com/google/zxing/qrcode/decoder/Decoder.java
Patch:
@@ -18,7 +18,6 @@
 
 import com.google.zxing.ChecksumException;
 import com.google.zxing.FormatException;
-import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitMatrix;
 import com.google.zxing.common.DecoderResult;
 import com.google.zxing.common.reedsolomon.GenericGF;
@@ -41,8 +40,7 @@ public Decoder() {
     rsDecoder = new ReedSolomonDecoder(GenericGF.QR_CODE_FIELD_256);
   }
 
-  public DecoderResult decode(boolean[][] image)
-      throws ChecksumException, FormatException, NotFoundException {
+  public DecoderResult decode(boolean[][] image) throws ChecksumException, FormatException {
     return decode(image, null);
   }
 

File: core/test/src/com/google/zxing/client/result/ExpandedProductParsedResultTestCase.java
Patch:
@@ -55,7 +55,7 @@ public void test_RSSExpanded() {
     String price = "5";
     String priceIncrement = "2";
     String priceCurrency = "445";
-    Hashtable uncommonAIs = new Hashtable();
+    Hashtable<Object,Object> uncommonAIs = new Hashtable<Object,Object>();
     uncommonAIs.put("123", "544654");
 
     Result result = new Result(text, null, null, BarcodeFormat.RSS_EXPANDED);

File: core/test/src/com/google/zxing/common/AbstractBlackBoxTestCase.java
Patch:
@@ -246,7 +246,7 @@ public SummaryResults testBlackBoxCountingResults(boolean assertOnFailure) throw
   private boolean decode(BinaryBitmap source,
                          float rotation,
                          String expectedText,
-                         Properties expectedMetadata,
+                         Map<Object,Object> expectedMetadata,
                          boolean tryHarder) {
     Result result;
     String suffix = " (" + (tryHarder ? "try harder, " : "") + "rotation: " + rotation + ')';
@@ -279,7 +279,7 @@ private boolean decode(BinaryBitmap source,
       return false;
     }
 
-    Hashtable resultMetadata = result.getResultMetadata();
+    Hashtable<Object,Object> resultMetadata = result.getResultMetadata();
     for (Map.Entry<Object,Object> metadatum : expectedMetadata.entrySet()) {
       ResultMetadataType key = ResultMetadataType.valueOf(metadatum.getKey().toString());
       Object expectedValue = metadatum.getValue();

File: javase/src/com/google/zxing/client/j2se/ImageConverter.java
Patch:
@@ -19,7 +19,6 @@
 import com.google.zxing.BinaryBitmap;
 import com.google.zxing.LuminanceSource;
 import com.google.zxing.NotFoundException;
-import com.google.zxing.ReaderException;
 import com.google.zxing.common.BitArray;
 import com.google.zxing.common.BitMatrix;
 import com.google.zxing.common.HybridBinarizer;

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/WifiGenerator.java
Patch:
@@ -103,7 +103,7 @@ private String getPasswordField() throws GeneratorException {
 	return parseTextField("Password", password);
   }
   
-  private String getNetworkTypeField() throws GeneratorException {
+  private String getNetworkTypeField() {
     return networkType.getValue(networkType.getSelectedIndex());
   }
   

File: core/src/com/google/zxing/datamatrix/decoder/DecodedBitStreamParser.java
Patch:
@@ -264,6 +264,7 @@ private static void decodeTextSegment(BitSource bits, StringBuffer result) throw
     boolean upperShift = false;
 
     int[] cValues = new int[3];
+    int shift = 0;
     do {
       // If there is only one byte left then it will be encoded as ASCII
       if (bits.available() == 8) {
@@ -276,7 +277,6 @@ private static void decodeTextSegment(BitSource bits, StringBuffer result) throw
 
       parseTwoBytes(firstByte, bits.readBits(8), cValues);
 
-      int shift = 0;
       for (int i = 0; i < 3; i++) {
         int cValue = cValues[i];
         switch (shift) {

File: core/src/com/google/zxing/oned/ITFReader.java
Patch:
@@ -46,7 +46,7 @@ public final class ITFReader extends OneDReader {
   private static final int W = 3; // Pixel width of a wide line
   private static final int N = 1; // Pixed width of a narrow line
 
-  private static final int[] DEFAULT_ALLOWED_LENGTHS = { 6, 10, 12, 14, 24, 44 };
+  private static final int[] DEFAULT_ALLOWED_LENGTHS = { 6, 10, 12, 14, 16, 24, 44 };
 
   // Stores the actual narrow line width of the image being decoded.
   private int narrowLineWidth = -1;

File: core/src/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -175,6 +175,7 @@ private static int textCompaction(int[] codewords, int codeIndex, StringBuffer r
             // of the Text Compaction mode. Codeword 913 is only available
             // in Text Compaction mode; its use is described in 5.4.2.4.
             textCompactionData[index] = MODE_SHIFT_TO_BYTE_COMPACTION_MODE;
+            code = codewords[codeIndex++];            
             byteCompactionData[index] = code; //Integer.toHexString(code);
             index++;
             break;
@@ -274,8 +275,8 @@ private static void decodeTextCompaction(int[] textCompactionData,
               subMode = PUNCT;
             } else if (subModeCh == 26) {
               ch = ' ';
-            } else if (subModeCh == AS) {
-              //mode_change = true;
+            } else if (subModeCh == LL) {
+              subMode = LOWER;
             } else if (subModeCh == AL) {
               subMode = ALPHA;
             } else if (subModeCh == PS) {

File: core/src/com/google/zxing/pdf417/decoder/BitMatrixParser.java
Patch:
@@ -61,8 +61,7 @@ final class BitMatrixParser {
    */
   int[] readCodewords() throws FormatException {
     int width = bitMatrix.getWidth();
-    // TODO should be a rectangular matrix
-    int height = width;
+    int height = bitMatrix.getHeight();
 
     erasures = new int[MAX_CW_CAPACITY];
 

File: javase/src/com/google/zxing/client/j2se/CommandLineRunner.java
Patch:
@@ -250,7 +250,7 @@ private static Result decode(URI uri,
     } catch (NotFoundException nfe) {
       System.out.println(uri.toString() + ": No barcode found");
       return null;
-    } finally {
+    // } finally {
       // Uncomment these lines when turning on exception tracking in ReaderException.
       //System.out.println("Threw " + ReaderException.getExceptionCountAndReset() + " exceptions");
       //System.out.println("Throwers:\n" + ReaderException.getThrowersAndReset());

File: core/src/com/google/zxing/MultiFormatWriter.java
Patch:
@@ -22,6 +22,7 @@
 import com.google.zxing.oned.EAN13Writer;
 import com.google.zxing.oned.EAN8Writer;
 import com.google.zxing.oned.ITFWriter;
+import com.google.zxing.oned.UPCAWriter;
 import com.google.zxing.qrcode.QRCodeWriter;
 
 import java.util.Hashtable;
@@ -48,6 +49,8 @@ public BitMatrix encode(String contents, BarcodeFormat format, int width, int he
       writer = new EAN8Writer();
     } else if (format == BarcodeFormat.EAN_13) {
       writer = new EAN13Writer();
+    } else if (format == BarcodeFormat.UPC_A) {
+      writer = new UPCAWriter();
     } else if (format == BarcodeFormat.QR_CODE) {
       writer = new QRCodeWriter();
     } else if (format == BarcodeFormat.CODE_39) {

File: core/src/com/google/zxing/common/StringUtils.java
Patch:
@@ -30,6 +30,7 @@ public final class StringUtils {
   private static final String PLATFORM_DEFAULT_ENCODING =
       System.getProperty("file.encoding");
   public static final String SHIFT_JIS = "SJIS";
+  public static final String GB2312 = "GB2312";
   private static final String EUC_JP = "EUC_JP";
   private static final String UTF8 = "UTF8";
   private static final String ISO88591 = "ISO8859_1";

File: core/src/com/google/zxing/datamatrix/decoder/Version.java
Patch:
@@ -232,7 +232,7 @@ private static Version[] buildVersions() {
             new ECBlocks(14, new ECB(1, 16))),
         new Version(28, 12, 36, 10, 16,
             new ECBlocks(18, new ECB(1, 22))),
-        new Version(29, 16, 36, 10, 16,
+        new Version(29, 16, 36, 14, 16,
             new ECBlocks(24, new ECB(1, 32))),
         new Version(30, 16, 48, 14, 22,
             new ECBlocks(28, new ECB(1, 49)))

File: core/test/src/com/google/zxing/datamatrix/DataMatrixBlackBox2TestCase.java
Patch:
@@ -30,7 +30,7 @@ public DataMatrixBlackBox2TestCase() {
     addTest(10, 10, 0.0f);
     addTest(13, 13, 90.0f);
     addTest(16, 16, 180.0f);
-    addTest(12, 12, 270.0f);
+    addTest(13, 13, 270.0f);
   }
 
 }

File: android/src/com/google/zxing/client/android/camera/CameraConfigurationManager.java
Patch:
@@ -58,7 +58,7 @@ void initFromCameraParameters(Camera camera) {
     screenResolution = new Point(display.getWidth(), display.getHeight());
     Log.d(TAG, "Screen resolution: " + screenResolution);
     cameraResolution = getCameraResolution(parameters, screenResolution);
-    Log.d(TAG, "Camera resolution: " + screenResolution);
+    Log.d(TAG, "Camera resolution: " + cameraResolution);
   }
 
   /**

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/CalendarEventGenerator.java
Patch:
@@ -238,7 +238,7 @@ private String getFullDayDateFields() throws GeneratorException {
       throw new GeneratorException("Start and end dates must be set.");
     }
     if (date1.after(date2)) {
-      throw new GeneratorException("Ending date is after starting date.");
+      throw new GeneratorException("Start date is after end date.");
     }
     DateTimeFormat isoFormatter = DateTimeFormat.getFormat("yyyyMMdd");
     StringBuilder output = new StringBuilder();

File: rim/src/com/google/zxing/client/rim/ZXingLMMainScreen.java
Patch:
@@ -228,9 +228,9 @@ public void run() {
           }
           if (file != null && file.exists()) {
             if (file.isOpen()) {
+              file.delete();              
               file.close();
             }
-            file.delete();
             Log.info("Deleted image file.");
           }
         } catch (IOException ioe) {

File: android/src/com/google/zxing/client/android/Intents.java
Patch:
@@ -127,7 +127,7 @@ public static final class Encode {
      * it defaults to QR Code. Use Intent.putExtra(FORMAT, format), where
      * format is one of Contents.Format. 
      */
-    public static final String FORMAT = "com.google.zxing.client.android.ENCODE_FORMAT";
+    public static final String FORMAT = "ENCODE_FORMAT";
 
     private Encode() {
     }

File: android/src/com/google/zxing/client/android/encode/QRCodeEncoder.java
Patch:
@@ -112,7 +112,6 @@ private boolean encodeContentsFromZXingIntent(Intent intent) {
     } catch (IllegalArgumentException iae) {
       // Ignore it then
       format = null;
-      formatString = null;
     }
     if (format == null || BarcodeFormat.QR_CODE.equals(format)) {
       String type = intent.getStringExtra(Intents.Encode.TYPE);

File: core/test/src/com/google/zxing/oned/EAN13BlackBox1TestCase.java
Patch:
@@ -27,7 +27,7 @@ public final class EAN13BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox1TestCase() {
     super("test/data/blackbox/ean13-1", new MultiFormatReader(), BarcodeFormat.EAN_13);
-    addTest(29, 32, 0.0f);
+    addTest(30, 32, 0.0f);
     addTest(27, 32, 180.0f);
   }
 

File: core/src/com/google/zxing/qrcode/detector/Detector.java
Patch:
@@ -374,6 +374,9 @@ protected AlignmentPattern findAlignmentInRegion(float overallEstModuleSize,
 
     int alignmentAreaTopY = Math.max(0, estAlignmentY - allowance);
     int alignmentAreaBottomY = Math.min(image.getHeight() - 1, estAlignmentY + allowance);
+    if (alignmentAreaBottomY - alignmentAreaTopY < overallEstModuleSize * 3) {
+      throw NotFoundException.getNotFoundInstance();
+    }
 
     AlignmentPatternFinder alignmentFinder =
         new AlignmentPatternFinder(

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox4TestCase.java
Patch:
@@ -29,10 +29,10 @@ public final class QRCodeBlackBox4TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox4TestCase() {
     super("test/data/blackbox/qrcode-4", new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(35, 35, 0.0f);
+    addTest(36, 36, 0.0f);
     addTest(36, 36, 90.0f);
-    addTest(34, 34, 180.0f);
-    addTest(34, 34, 270.0f);
+    addTest(35, 35, 180.0f);
+    addTest(35, 35, 270.0f);
   }
 
 }

File: javase/src/com/google/zxing/client/j2se/BufferedImageLuminanceSource.java
Patch:
@@ -95,7 +95,8 @@ public byte[] getMatrix() {
         int pixel = rgb[offset + x];
         int luminance = (306 * ((pixel >> 16) & 0xFF) +
             601 * ((pixel >> 8) & 0xFF) +
-            117 * (pixel & 0xFF)) >> 10;
+            117 * (pixel & 0xFF) +
+            (0x200)) >> 10; // 0x200 = 1<<9, half an lsb of the result to force rounding
         matrix[offset + x] = (byte) luminance;
       }
     }

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -28,8 +28,8 @@ public final class QRCodeBlackBox2TestCase extends AbstractBlackBoxTestCase {
   public QRCodeBlackBox2TestCase() {
     super("test/data/blackbox/qrcode-2", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(26, 26, 0.0f);
-    addTest(25, 25, 90.0f);
-    addTest(24, 24, 180.0f);
+    addTest(26, 26, 90.0f);
+    addTest(26, 26, 180.0f);
     addTest(25, 25, 270.0f);
   }
 

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox3TestCase.java
Patch:
@@ -27,10 +27,10 @@ public final class QRCodeBlackBox3TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox3TestCase() {
     super("test/data/blackbox/qrcode-3", new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(36, 36, 0.0f);
+    addTest(38, 38, 0.0f);
     addTest(38, 38, 90.0f);
     addTest(36, 36, 180.0f);
-    addTest(37, 37, 270.0f);
+    addTest(38, 38, 270.0f);
   }
 
 }

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox5TestCase.java
Patch:
@@ -31,10 +31,10 @@ public final class QRCodeBlackBox5TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox5TestCase() {
     super("test/data/blackbox/qrcode-5", new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(19, 19, 0.0f);
+    addTest(18, 18, 0.0f);
     addTest(19, 19, 90.0f);
-    addTest(18, 18, 180.0f);
-    addTest(18, 18, 270.0f);
+    addTest(19, 19, 180.0f);
+    addTest(19, 19, 270.0f);
   }
 
 }

File: core/src/com/google/zxing/qrcode/decoder/Version.java
Patch:
@@ -419,7 +419,7 @@ private static Version[] buildVersions() {
             new ECBlocks(30, new ECB(7, 24),
                 new ECB(16, 25)),
             new ECBlocks(24, new ECB(34, 13))),
-        new Version(23, new int[]{6, 30, 54, 74, 102},
+        new Version(23, new int[]{6, 30, 54, 78, 102},
             new ECBlocks(30, new ECB(4, 121),
                 new ECB(5, 122)),
             new ECBlocks(28, new ECB(4, 47),

File: core/test/src/com/google/zxing/negative/FalsePositivesBlackBoxTestCase.java
Patch:
@@ -28,9 +28,9 @@ public final class FalsePositivesBlackBoxTestCase extends AbstractNegativeBlackB
   public FalsePositivesBlackBoxTestCase() {
     super("test/data/blackbox/falsepositives");
     addTest(2, 0.0f);
-    addTest(0, 90.0f);
+    addTest(1, 90.0f);
     addTest(1, 180.0f);
-    addTest(1, 270.0f);
+    addTest(2, 270.0f);
   }
 
 }

File: core/test/src/com/google/zxing/negative/PartialBlackBoxTestCase.java
Patch:
@@ -30,7 +30,7 @@ public PartialBlackBoxTestCase() {
     addTest(1, 0.0f);
     addTest(1, 90.0f);
     addTest(1, 180.0f);
-    addTest(0, 270.0f);
+    addTest(1, 270.0f);
   }
 
 }

File: core/test/src/com/google/zxing/negative/UnsupportedBlackBoxTestCase.java
Patch:
@@ -28,9 +28,9 @@ public final class UnsupportedBlackBoxTestCase extends AbstractNegativeBlackBoxT
   public UnsupportedBlackBoxTestCase() {
     super("test/data/blackbox/unsupported");
     addTest(1, 0.0f);
-    addTest(0, 90.0f);
+    addTest(1, 90.0f);
     addTest(1, 180.0f);
-    addTest(0, 270.0f);
+    addTest(1, 270.0f);
   }
 
 }

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -28,9 +28,9 @@ public final class QRCodeBlackBox2TestCase extends AbstractBlackBoxTestCase {
   public QRCodeBlackBox2TestCase() {
     super("test/data/blackbox/qrcode-2", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(26, 26, 0.0f);
-    addTest(24, 24, 90.0f);
+    addTest(25, 25, 90.0f);
     addTest(24, 24, 180.0f);
-    addTest(22, 23, 270.0f);
+    addTest(25, 25, 270.0f);
   }
 
 }

File: android/src/com/google/zxing/client/android/DecodeThread.java
Patch:
@@ -59,11 +59,11 @@ final class DecodeThread extends Thread {
       boolean decode1D = prefs.getBoolean(PreferencesActivity.KEY_DECODE_1D, true);
       boolean decodeQR = prefs.getBoolean(PreferencesActivity.KEY_DECODE_QR, true);
       if (decode1D && decodeQR) {
-        hints.put(DecodeHintType.POSSIBLE_FORMATS, CaptureActivity.ALL_FORMATS);
+        hints.put(DecodeHintType.POSSIBLE_FORMATS, DecodeFormatManager.ALL_FORMATS);
       } else if (decode1D) {
-        hints.put(DecodeHintType.POSSIBLE_FORMATS, CaptureActivity.ONE_D_FORMATS);
+        hints.put(DecodeHintType.POSSIBLE_FORMATS, DecodeFormatManager.ONE_D_FORMATS);
       } else if (decodeQR) {
-        hints.put(DecodeHintType.POSSIBLE_FORMATS, CaptureActivity.QR_CODE_FORMATS);
+        hints.put(DecodeHintType.POSSIBLE_FORMATS, DecodeFormatManager.QR_CODE_FORMATS);
       }
     } else {
       hints.put(DecodeHintType.POSSIBLE_FORMATS, decodeFormats);

File: core/src/com/google/zxing/oned/ITFWriter.java
Patch:
@@ -53,9 +53,9 @@ public byte[] encode(String contents) {
       int one = Character.digit(contents.charAt(i), 10);
       int two = Character.digit(contents.charAt(i+1), 10);
       int[] encoding = new int[18];
-      for (int j = 0; j < 10; j += 2) {
-        encoding[j] = ITFReader.PATTERNS[one][j];
-        encoding[j + 1] = ITFReader.PATTERNS[two][j];
+      for (int j = 0; j < 5; j++) {
+        encoding[(j << 1)] = ITFReader.PATTERNS[one][j];
+        encoding[(j << 1) + 1] = ITFReader.PATTERNS[two][j];
       }
       pos += appendPattern(result, pos, encoding, 1);
     }

File: core/src/com/google/zxing/BarcodeFormat.java
Patch:
@@ -33,7 +33,7 @@ public final class BarcodeFormat {
   public static final BarcodeFormat QR_CODE = new BarcodeFormat("QR_CODE");
 
   /** DataMatrix 2D barcode format. */
-  public static final BarcodeFormat DATAMATRIX = new BarcodeFormat("DATAMATRIX");
+  public static final BarcodeFormat DATA_MATRIX = new BarcodeFormat("DATA_MATRIX");
 
   /** UPC-E 1D format. */
   public static final BarcodeFormat UPC_E = new BarcodeFormat("UPC_E");
@@ -58,7 +58,7 @@ public final class BarcodeFormat {
 
   /** Code 93 1D format. */
   public static final BarcodeFormat CODE_93 = new BarcodeFormat("CODE_93");
-  
+
   /** CODABAR 1D format. */
   public static final BarcodeFormat CODABAR = new BarcodeFormat("CODABAR");
 
@@ -70,7 +70,7 @@ public final class BarcodeFormat {
 
   /** PDF417 format. */
   public static final BarcodeFormat PDF417 = new BarcodeFormat("PDF417");
-  
+
   /** RSS EXPANDED */
   public static final BarcodeFormat RSS_EXPANDED = new BarcodeFormat("RSS_EXPANDED");
 

File: core/test/src/com/google/zxing/datamatrix/DataMatrixBlackBox1TestCase.java
Patch:
@@ -26,7 +26,7 @@ public final class DataMatrixBlackBox1TestCase extends AbstractBlackBoxTestCase
 
   public DataMatrixBlackBox1TestCase() {
     // TODO use MultiFormatReader here once Data Matrix decoder is done
-    super("test/data/blackbox/datamatrix-1", new DataMatrixReader(), BarcodeFormat.DATAMATRIX);
+    super("test/data/blackbox/datamatrix-1", new DataMatrixReader(), BarcodeFormat.DATA_MATRIX);
     addTest(7, 7, 0.0f);
     addTest(7, 7, 90.0f);
     addTest(6, 6, 180.0f);

File: core/test/src/com/google/zxing/datamatrix/DataMatrixBlackBox2TestCase.java
Patch:
@@ -26,7 +26,7 @@ public final class DataMatrixBlackBox2TestCase extends AbstractBlackBoxTestCase
 
   public DataMatrixBlackBox2TestCase() {
     // TODO use MultiFormatReader here once Data Matrix decoder is done
-    super("test/data/blackbox/datamatrix-2", new DataMatrixReader(), BarcodeFormat.DATAMATRIX);
+    super("test/data/blackbox/datamatrix-2", new DataMatrixReader(), BarcodeFormat.DATA_MATRIX);
     addTest(4, 4, 0.0f);
     addTest(1, 1, 90.0f);
     addTest(3, 3, 180.0f);

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -37,6 +37,7 @@
 import android.content.res.AssetFileDescriptor;
 import android.content.res.Configuration;
 import android.graphics.Bitmap;
+import android.graphics.BitmapFactory;
 import android.graphics.Canvas;
 import android.graphics.Paint;
 import android.graphics.Rect;
@@ -524,11 +525,11 @@ private void handleDecodeInternally(Result rawResult, Bitmap barcode) {
 
     ImageView barcodeImageView = (ImageView) findViewById(R.id.barcode_image_view);
     if (barcode == null) {
-      barcodeImageView.setImageResource(R.drawable.launcher_icon_large);
+      barcodeImageView.setImageBitmap(BitmapFactory.decodeResource(getResources(),
+          R.drawable.launcher_icon));
     } else {
       barcodeImageView.setImageBitmap(barcode);
     }
-    barcodeImageView.setVisibility(View.VISIBLE);
 
     TextView formatTextView = (TextView) findViewById(R.id.format_text_view);
     formatTextView.setText(rawResult.getBarcodeFormat().toString());

File: android/src/com/google/zxing/client/android/Intents.java
Patch:
@@ -150,7 +150,7 @@ private SearchBookContents() {
 
   public static final class WifiConnect {
 	    /**
-	     * Use Google Book Search to search the contents of the book provided.
+	     * Internal intent used to trigger connection to a wi-fi network.
 	     */
 	    public static final String ACTION = "com.google.zxing.client.android.WIFI_CONNECT";
 

File: android/src/com/google/zxing/client/android/wifi/WifiReceiver.java
Patch:
@@ -60,7 +60,7 @@ public void onReceive(Context context, Intent intent) {
           final NetworkInfo.State state = i.getState();
           final String ssid = mWifiManager.getConnectionInfo().getSSID();
 
-          if (state == NetworkInfo.State.CONNECTED){
+          if (state == NetworkInfo.State.CONNECTED && ssid != null){
             mWifiManager.saveConfiguration();
             final String label = parent.getString(R.string.wifi_connected);
             statusView.setText(label + "\n" + ssid);

File: android/src/com/google/zxing/client/android/result/WifiResultHandler.java
Patch:
@@ -17,7 +17,6 @@
 package com.google.zxing.client.android.result;
 
 import android.app.Activity;
-
 import com.google.zxing.client.android.R;
 import com.google.zxing.client.result.ParsedResult;
 import com.google.zxing.client.result.WifiParsedResult;
@@ -52,7 +51,7 @@ public int getButtonText(int index) {
   @Override
   public void handleButtonPress(int index) {
     // Get the underlying wifi config
-    WifiParsedResult wifiResult = (WifiParsedResult) getResult();
+    final WifiParsedResult wifiResult = (WifiParsedResult) getResult();
     if (index == 0) {
       wifiConnect(wifiResult);
     }
@@ -61,7 +60,7 @@ public void handleButtonPress(int index) {
   // Display the name of the network and the network type to the user.
   @Override
   public CharSequence getDisplayContents() {
-    WifiParsedResult wifiResult = (WifiParsedResult) getResult();
+    final WifiParsedResult wifiResult = (WifiParsedResult) getResult();
     StringBuffer contents = new StringBuffer();
     final String wifiLabel = parent.getString(R.string.wifi_ssid_label);
     ParsedResult.maybeAppend(wifiLabel + "\n" + wifiResult.getSsid(), contents);

File: android/src/com/google/zxing/client/android/wifi/NetworkUtil.java
Patch:
@@ -77,4 +77,4 @@ static boolean isHexWepKey(CharSequence wepKey) {
     return (length == 10 || length == 26 || length == 58) && isHex(wepKey);
   }
 
-}
+}
\ No newline at end of file

File: android/src/com/google/zxing/client/android/wifi/ConnectedReceiver.java
Patch:
@@ -35,15 +35,15 @@ final class ConnectedReceiver extends BroadcastReceiver {
   private final TextView statusView;
 
   ConnectedReceiver(Activity wifiActivity, TextView statusView) {
-    parent = wifiActivity;
+    this.parent = wifiActivity;
     this.statusView = statusView;
   }
 
   @Override
   public void onReceive(Context context, Intent intent) {
     if (intent.getAction().equals(android.net.ConnectivityManager.CONNECTIVITY_ACTION)) {
       ConnectivityManager con = (ConnectivityManager) parent.getSystemService(Context.CONNECTIVITY_SERVICE);
-      NetworkInfo[] s = con.getAllNetworkInfo();
+      final NetworkInfo[] s = con.getAllNetworkInfo();
       for (NetworkInfo i : s){
         if (i.getTypeName().contentEquals("WIFI")){
           NetworkInfo.State state = i.getState();

File: android/src/com/google/zxing/client/android/wifi/NetworkUtil.java
Patch:
@@ -46,7 +46,7 @@ static String convertToQuotedString(String string) {
     int lastPos = string.length() - 1;
     if (lastPos < 0 || (string.charAt(0) == '"' && string.charAt(lastPos) == '"')) {
       return string;
-    }        
+    }
     return '\"' + string + '\"';
   }
 
@@ -59,7 +59,7 @@ private static boolean isHex(CharSequence key) {
       if (!(c >= '0' && c <= '9' || c >= 'A' && c <= 'F' || c >= 'a' && c <= 'f')) {
         return false;
       }
-    }        
+    }
     return true;
   }
 

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -119,7 +119,7 @@ public final class CaptureActivity extends Activity implements SurfaceHolder.Cal
     PRODUCT_FORMATS.add(BarcodeFormat.EAN_13);
     PRODUCT_FORMATS.add(BarcodeFormat.EAN_8);
     PRODUCT_FORMATS.add(BarcodeFormat.RSS14);
-    ONE_D_FORMATS = new Vector<BarcodeFormat>(PRODUCT_FORMATS.size() + 3);
+    ONE_D_FORMATS = new Vector<BarcodeFormat>(PRODUCT_FORMATS.size() + 4);
     ONE_D_FORMATS.addAll(PRODUCT_FORMATS);
     ONE_D_FORMATS.add(BarcodeFormat.CODE_39);
     ONE_D_FORMATS.add(BarcodeFormat.CODE_93);

File: android/src/com/google/zxing/client/android/result/ResultHandlerFactory.java
Patch:
@@ -40,7 +40,7 @@ public static ResultHandler makeResultHandler(Activity activity, Result rawResul
     } else if (type.equals(ParsedResultType.EMAIL_ADDRESS)) {
       return new EmailAddressResultHandler(activity, result);
     } else if (type.equals(ParsedResultType.PRODUCT)) {
-      return new ProductResultHandler(activity, result);
+      return new ProductResultHandler(activity, result, rawResult);
     } else if (type.equals(ParsedResultType.URI)) {
       return new URIResultHandler(activity, result);
     } else if (type.equals(ParsedResultType.WIFI)) {
@@ -56,7 +56,7 @@ public static ResultHandler makeResultHandler(Activity activity, Result rawResul
     } else if (type.equals(ParsedResultType.CALENDAR)) {
       return new CalendarResultHandler(activity, result);
     } else if (type.equals(ParsedResultType.ISBN)) {
-      return new ISBNResultHandler(activity, result);
+      return new ISBNResultHandler(activity, result, rawResult);
     } else {
       // The TextResultHandler is the fallthrough for unsupported formats.
       return new TextResultHandler(activity, result);

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -39,6 +39,7 @@ public final class PreferencesActivity extends PreferenceActivity
   public static final String KEY_VIBRATE = "preferences_vibrate";
   public static final String KEY_COPY_TO_CLIPBOARD = "preferences_copy_to_clipboard";
   public static final String KEY_FRONT_LIGHT = "preferences_front_light";
+  public static final String KEY_BULK_MODE = "preferences_bulk_mode";
 
   public static final String KEY_HELP_VERSION_SHOWN = "preferences_help_version_shown";
   public static final String KEY_NOT_OUR_RESULTS_SHOWN = "preferences_not_out_results_shown";

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/Generator.java
Patch:
@@ -113,6 +113,7 @@ private void loadGenerators() {
     generators.add(new SmsAddressGenerator(changeListener, keyPressHandler));
     generators.add(new TextGenerator(changeListener));
     generators.add(new UrlGenerator(changeListener, keyPressHandler));
+    generators.add(new WifiGenerator(changeListener, keyPressHandler));
   }
   
   public void setupLeftPanel() {

File: core/src/com/google/zxing/client/result/ParsedResultType.java
Patch:
@@ -1,5 +1,5 @@
 /*
- * Copyright 2007 ZXing authors
+ * Copyright 2010 ZXing authors
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -34,6 +34,7 @@ public final class ParsedResultType {
   public static final ParsedResultType TEL = new ParsedResultType("TEL");
   public static final ParsedResultType SMS = new ParsedResultType("SMS");
   public static final ParsedResultType CALENDAR = new ParsedResultType("CALENDAR");
+  public static final ParsedResultType WIFI = new ParsedResultType("WIFI");
   // "optional" types
   public static final ParsedResultType NDEF_SMART_POSTER = new ParsedResultType("NDEF_SMART_POSTER");
   public static final ParsedResultType MOBILETAG_RICH_WEB = new ParsedResultType("MOBILETAG_RICH_WEB");

File: core/src/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -63,6 +63,8 @@ public static ParsedResult parseResult(Result theResult) {
       return result;
     } else if ((result = GeoResultParser.parse(theResult)) != null) {
       return result;
+    } else if ((result = WifiResultParser.parse(theResult)) != null) {
+      return result;
     } else if ((result = URLTOResultParser.parse(theResult)) != null) {
       return result;
     } else if ((result = URIResultParser.parse(theResult)) != null) {

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/TimeZoneList.java
Patch:
@@ -42,7 +42,7 @@ public TimeZoneInfo(String abreviation, String longName, String relative, long g
   
   public static final TimeZoneInfo[] TIMEZONES = {
     new TimeZoneInfo("GMT", "Greenwich Mean Time", "GMT",               0 * ONE_HOUR + 0 * THIRTY_MIN), // 0
-    new TimeZoneInfo("UTC", "Universal Coordinated Time", "GMT",        1 * ONE_HOUR + 0 * THIRTY_MIN),
+    new TimeZoneInfo("UTC", "Universal Coordinated Time", "GMT",        0 * ONE_HOUR + 0 * THIRTY_MIN),
     new TimeZoneInfo("ECT", "European Central Time", "GMT+1:00",        1 * ONE_HOUR + 0 * THIRTY_MIN),
     new TimeZoneInfo("EET", "Eastern European Time", "GMT+2:00",        2 * ONE_HOUR + 0 * THIRTY_MIN),
     new TimeZoneInfo("ART", "(Arabic) Egypt Standard Time", "GMT+2:00", 2 * ONE_HOUR + 0 * THIRTY_MIN),

File: core/src/com/google/zxing/qrcode/QRCodeReader.java
Patch:
@@ -121,10 +121,10 @@ public static BitMatrix extractPureBits(BitMatrix image) throws NotFoundExceptio
 
     // And now find where the rightmost black module on the first row ends
     int rowEndOfSymbol = width - 1;
-    while (rowEndOfSymbol >= 0 && !image.get(rowEndOfSymbol, y)) {
+    while (rowEndOfSymbol > x && !image.get(rowEndOfSymbol, y)) {
       rowEndOfSymbol--;
     }
-    if (rowEndOfSymbol < 0) {
+    if (rowEndOfSymbol <= x) {
       throw NotFoundException.getNotFoundInstance();
     }
     rowEndOfSymbol++;

File: core/src/com/google/zxing/qrcode/decoder/Version.java
Patch:
@@ -129,7 +129,7 @@ static Version decodeVersionInformation(int versionBits) {
       }
     }
     // We can tolerate up to 3 bits of error since no two version info codewords will
-    // differ in less than 4 bits.
+    // differ in less than 8 bits.
     if (bestDifference <= 3) {
       return getVersionForNumber(bestVersion);
     }

File: android/src/com/google/zxing/client/android/DecodeHandler.java
Patch:
@@ -49,6 +49,7 @@ final class DecodeHandler extends Handler {
   public void handleMessage(Message message) {
     switch (message.what) {
       case R.id.decode:
+        Log.v(TAG, "Got decode message");
         decode((byte[]) message.obj, message.arg1, message.arg2);
         break;
       case R.id.quit:
@@ -85,9 +86,11 @@ private void decode(byte[] data, int width, int height) {
       Bundle bundle = new Bundle();
       bundle.putParcelable(DecodeThread.BARCODE_BITMAP, source.renderCroppedGreyscaleBitmap());
       message.setData(bundle);
+      Log.v(TAG, "Sending decode succeeded message...");
       message.sendToTarget();
     } else {
       Message message = Message.obtain(activity.getHandler(), R.id.decode_failed);
+      Log.v(TAG, "Sending decode failed message...");
       message.sendToTarget();
     }
   }

File: android/src/com/google/zxing/client/android/camera/CameraManager.java
Patch:
@@ -176,8 +176,10 @@ public void requestPreviewFrame(Handler handler, int message) {
     if (camera != null && previewing) {
       previewCallback.setHandler(handler, message);
       if (useOneShotPreviewCallback) {
+        Log.v(TAG, "Requesting one-shot preview callback");
         camera.setOneShotPreviewCallback(previewCallback);
       } else {
+        Log.v(TAG, "Requesting preview callback");
         camera.setPreviewCallback(previewCallback);
       }
     }
@@ -192,6 +194,7 @@ public void requestPreviewFrame(Handler handler, int message) {
   public void requestAutoFocus(Handler handler, int message) {
     if (camera != null && previewing) {
       autoFocusCallback.setHandler(handler, message);
+      Log.v(TAG, "Requesting auto-focus callback");
       camera.autoFocus(autoFocusCallback);
     }
   }

File: core/src/com/google/zxing/qrcode/encoder/MatrixUtil.java
Patch:
@@ -290,7 +290,7 @@ public static int findMSBSet(int value) {
   // Example: Calculation of version information of 7.
   // f(x) is created from 7.
   //   - 7 = 000111 in 6 bits
-  //   - f(x) = x^2 + x^2 + x^1
+  //   - f(x) = x^2 + x^1 + x^0
   // g(x) is given by the standard (p. 67)
   //   - g(x) = x^12 + x^11 + x^10 + x^9 + x^8 + x^5 + x^2 + 1
   // Multiply f(x) by x^(18 - 6)

File: android-integration/src/com/google/zxing/integration/android/IntentIntegrator.java
Patch:
@@ -137,7 +137,7 @@ public static AlertDialog initiateScan(Activity activity,
                                          CharSequence stringButtonYes,
                                          CharSequence stringButtonNo) {
 
-	  return initiateScan(activity,
+    return initiateScan(activity,
                         stringTitle,
                         stringMessage,
                         stringButtonYes,
@@ -171,8 +171,8 @@ public static AlertDialog initiateScan(Activity activity,
 
     // check which types of codes to scan for
     if (stringDesiredBarcodeFormats != null) {
-    	// set the desired barcode types
-    	intentScan.putExtra("SCAN_FORMATS", stringDesiredBarcodeFormats);
+      // set the desired barcode types
+      intentScan.putExtra("SCAN_FORMATS", stringDesiredBarcodeFormats);
     }
 
     try {

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -588,8 +588,8 @@ private void handleDecodeExternally(Result rawResult, Bitmap barcode) {
           resultHandler.getDisplayContents().toString() + "&source=zxing";
       handler.sendMessageDelayed(message, INTENT_RESULT_DURATION);
     } else if (source == Source.ZXING_LINK) {
-    	// Replace each occurrence of RETURN_CODE_PLACEHOLDER in the returnUrlTemplate
-    	// with the scanned code. This allows both queries and REST-style URLs to work.
+      // Replace each occurrence of RETURN_CODE_PLACEHOLDER in the returnUrlTemplate
+      // with the scanned code. This allows both queries and REST-style URLs to work.
       Message message = Message.obtain(handler, R.id.launch_product_query);
       message.obj = returnUrlTemplate.replace(RETURN_CODE_PLACEHOLDER, resultHandler.getDisplayContents().toString());
       handler.sendMessageDelayed(message, INTENT_RESULT_DURATION);

File: android/src/com/google/zxing/client/android/book/SearchBookContentsActivity.java
Patch:
@@ -199,7 +199,7 @@ private void handleSearchResults(JSONObject json) {
         for (int x = 0; x < count; x++) {
           items.add(parseResult(results.getJSONObject(x)));
         }
-	      resultListView.setOnItemClickListener(new BrowseBookListener(this, items));
+        resultListView.setOnItemClickListener(new BrowseBookListener(this, items));
         resultListView.setAdapter(new SearchBookContentsAdapter(this, items));
       } else {
         String searchable = json.optString("searchable");
@@ -243,7 +243,7 @@ private SearchBookContentsResult parseResult(JSONObject json) {
       return new SearchBookContentsResult(pageId, pageNumber, snippet, valid);
     } catch (JSONException e) {
       // Never seen in the wild, just being complete.
-	    return new SearchBookContentsResult(getString(R.string.msg_sbc_no_page_returned), "", "", false);
+      return new SearchBookContentsResult(getString(R.string.msg_sbc_no_page_returned), "", "", false);
     }
   }
 
@@ -267,7 +267,7 @@ public void run() {
         // website, we don't use LocaleManager to change the TLD.
         URI uri;
         if (isbn.startsWith("http://google.com/books?id=")) {
-	        int equals = isbn.indexOf('=');
+          int equals = isbn.indexOf('=');
           String volumeId = isbn.substring(equals + 1);
           uri = new URI("http", null, "www.google.com", -1, "/books", "id=" + volumeId +
                         "&jscmd=SearchWithinVolume2&q=" + query, null);

File: android/src/com/google/zxing/client/android/result/URIResultHandler.java
Patch:
@@ -65,7 +65,7 @@ public void handleButtonPress(int index) {
         shareBySMS(uri);
         break;
       case 3:
-	      searchBookContents(uri);
+        searchBookContents(uri);
         break;
     }
   }

File: core/src/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -446,7 +446,7 @@ private static int numericCompaction(int[] codewords, int codeIndex, StringBuffe
             code == BEGIN_MACRO_PDF417_CONTROL_BLOCK ||
             code == BEGIN_MACRO_PDF417_OPTIONAL_FIELD ||
             code == MACRO_PDF417_TERMINATOR) {
-	        codeIndex--;
+          codeIndex--;
           end = true;          
         }
       }

File: core/src/com/google/zxing/pdf417/decoder/Decoder.java
Patch:
@@ -145,5 +145,6 @@ private static int correctErrors(int[] codewords, int[] erasures, int numECCodew
       }
     }
     return result;
-	}
+  }
+
 }

File: core/test/src/com/google/zxing/client/result/ParsedReaderResultTestCase.java
Patch:
@@ -202,11 +202,11 @@ public void testVEvent() {
         "DTEND:20080505\r\nEND:VEVENT", "foo\n20080504\n20080505", ParsedResultType.CALENDAR);
     // Start time only
     doTestResult("BEGIN:VEVENT\r\nSUMMARY:foo\r\nDTSTART:20080504T123456Z\r\nEND:VEVENT",
-        "foo\n20080504T123456Z", ParsedResultType.CALENDAR);
+        "foo\n20080504T123456Z\n20080504T123456Z", ParsedResultType.CALENDAR);
     doTestResult("BEGIN:VEVENT\r\nSUMMARY:foo\r\nDTSTART:20080504T123456\r\nEND:VEVENT",
-        "foo\n20080504T123456", ParsedResultType.CALENDAR);
+        "foo\n20080504T123456\n20080504T123456", ParsedResultType.CALENDAR);
     doTestResult("BEGIN:VEVENT\r\nSUMMARY:foo\r\nDTSTART:20080504\r\nEND:VEVENT",
-        "foo\n20080504", ParsedResultType.CALENDAR);
+        "foo\n20080504\n20080504", ParsedResultType.CALENDAR);
     doTestResult("BEGIN:VEVENT\r\nDTEND:20080505T\r\nEND:VEVENT",
         "BEGIN:VEVENT\r\nDTEND:20080505T\r\nEND:VEVENT", ParsedResultType.TEXT);
     // Make sure illegal entries without newlines don't crash

File: core/src/com/google/zxing/oned/OneDReader.java
Patch:
@@ -103,12 +103,12 @@ private Result doDecode(BinaryBitmap image, Hashtable hints) throws NotFoundExce
 
     int middle = height >> 1;
     boolean tryHarder = hints != null && hints.containsKey(DecodeHintType.TRY_HARDER);
-    int rowStep = Math.max(1, height >> (tryHarder ? 8 : 4));
+    int rowStep = Math.max(1, height >> (tryHarder ? 8 : 5));
     int maxLines;
     if (tryHarder) {
       maxLines = height; // Look at the whole image, not just the center
     } else {
-      maxLines = 9; // Nine rows spaced 1/16 apart is roughly the middle half of the image
+      maxLines = 15; // 15 rows spaced 1/32 apart is roughly the middle half of the image
     }
 
     for (int x = 0; x < maxLines; x++) {

File: javase/src/com/google/zxing/client/j2se/CommandLineRunner.java
Patch:
@@ -113,6 +113,7 @@ private static Hashtable<DecodeHintType, Object> buildHints(boolean tryHarder,
     vector.addElement(BarcodeFormat.UPC_E);
     vector.addElement(BarcodeFormat.EAN_13);
     vector.addElement(BarcodeFormat.EAN_8);
+    vector.addElement(BarcodeFormat.RSS14);    
     if (!productsOnly) {
       vector.addElement(BarcodeFormat.CODE_39);
       vector.addElement(BarcodeFormat.CODE_128);

File: javame/src/com/google/zxing/client/j2me/Menu.java
Patch:
@@ -31,8 +31,8 @@
 final class Menu extends List implements CommandListener {
 
   private final ZXingMIDlet zXingMIDlet;
-  private Command cancelCommand;
-  private Command barcodeCommand;
+  private final Command cancelCommand;
+  private final Command barcodeCommand;
 
   /**
    * Creates a new Search List and initialises all components.

File: javame/src/com/google/zxing/client/j2me/ZXingMIDlet.java
Patch:
@@ -254,7 +254,7 @@ void barcodeAction(ParsedResult result) {
       showOpenURL("Compose E-mail?", emailResult.getEmailAddress(), emailResult.getMailtoURI());
     } else if (type.equals(ParsedResultType.SMS)) {
       SMSParsedResult smsResult = (SMSParsedResult) result;
-      showOpenURL("Compose SMS?", smsResult.getNumber(), smsResult.getSMSURI());
+      showOpenURL("Compose SMS?", smsResult.getNumbers()[0], smsResult.getSMSURI());
     } else if (type.equals(ParsedResultType.PRODUCT)) {
       ProductParsedResult productResult = (ProductParsedResult) result;
       String uri = "http://www.upcdatabase.com/item.asp?upc=" + productResult.getNormalizedProductID();

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -19,6 +19,7 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.Result;
 import com.google.zxing.ResultPoint;
+import com.google.zxing.client.android.camera.CameraManager;
 import com.google.zxing.client.android.history.HistoryManager;
 import com.google.zxing.client.android.result.ResultButtonListener;
 import com.google.zxing.client.android.result.ResultHandler;

File: android/src/com/google/zxing/client/android/CaptureActivityHandler.java
Patch:
@@ -18,6 +18,7 @@
 
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.Result;
+import com.google.zxing.client.android.camera.CameraManager;
 
 import android.app.Activity;
 import android.content.Intent;
@@ -35,6 +36,7 @@
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class CaptureActivityHandler extends Handler {
+
   private final CaptureActivity activity;
   private final DecodeThread decodeThread;
   private State state;
@@ -122,4 +124,5 @@ private void restartPreviewAndDecode() {
       activity.drawViewfinder();
     }
   }
+
 }

File: android/src/com/google/zxing/client/android/DecodeThread.java
Patch:
@@ -23,6 +23,7 @@
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
 import com.google.zxing.ResultPointCallback;
+import com.google.zxing.client.android.camera.CameraManager;
 import com.google.zxing.common.HybridBinarizer;
 
 import android.content.SharedPreferences;
@@ -141,4 +142,5 @@ private void decode(byte[] data, int width, int height) {
       message.sendToTarget();
     }
   }
+
 }

File: android/src/com/google/zxing/client/android/PlanarYUVLuminanceSource.java
Patch:
@@ -37,7 +37,7 @@ public final class PlanarYUVLuminanceSource extends LuminanceSource {
   private final int left;
   private final int top;
 
-  PlanarYUVLuminanceSource(byte[] yuvData, int dataWidth, int dataHeight, int left, int top,
+  public PlanarYUVLuminanceSource(byte[] yuvData, int dataWidth, int dataHeight, int left, int top,
       int width, int height) {
     super(width, height);
 

File: android/src/com/google/zxing/client/android/camera/FlashlightManager.java
Patch:
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-package com.google.zxing.client.android;
+package com.google.zxing.client.android.camera;
 
 import android.os.IBinder;
 import android.util.Log;

File: android/src/com/google/zxing/client/android/encode/QRCodeEncoder.java
Patch:
@@ -54,6 +54,7 @@ final class QRCodeEncoder {
   private static final String TAG = "QRCodeEncoder";
 
   private static final int WHITE = 0xFFFFFFFF;
+  private static final int BLACK = 0xFF000000;
 
   private final Activity activity;
   private String contents;
@@ -338,9 +339,7 @@ public void run() {
         for (int y = 0; y < height; y++) {
           int offset = y * width;
           for (int x = 0; x < width; x++) {
-            if (!result.get(x, y)) {
-              pixels[offset + x] = WHITE;
-            }
+            pixels[offset + x] = result.get(x, y) ? BLACK : WHITE;
           }
         }
 

File: core/src/com/google/zxing/MultiFormatWriter.java
Patch:
@@ -16,7 +16,7 @@
 
 package com.google.zxing;
 
-import com.google.zxing.common.ByteMatrix;
+import com.google.zxing.common.BitMatrix;
 import com.google.zxing.oned.Code128Writer;
 import com.google.zxing.oned.Code39Writer;
 import com.google.zxing.oned.EAN13Writer;
@@ -34,13 +34,13 @@
  */
 public final class MultiFormatWriter implements Writer {
 
-  public ByteMatrix encode(String contents, BarcodeFormat format, int width,
+  public BitMatrix encode(String contents, BarcodeFormat format, int width,
       int height) throws WriterException {
 
     return encode(contents, format, width, height, null);
   }
 
-  public ByteMatrix encode(String contents, BarcodeFormat format, int width, int height,
+  public BitMatrix encode(String contents, BarcodeFormat format, int width, int height,
       Hashtable hints) throws WriterException {
 
     Writer writer;

File: core/src/com/google/zxing/Writer.java
Patch:
@@ -16,7 +16,7 @@
 
 package com.google.zxing;
 
-import com.google.zxing.common.ByteMatrix;
+import com.google.zxing.common.BitMatrix;
 
 import java.util.Hashtable;
 
@@ -36,7 +36,7 @@ public interface Writer {
    * @param height The preferred height in pixels
    * @return The generated barcode as a Matrix of unsigned bytes (0 == black, 255 == white)
    */
-  ByteMatrix encode(String contents, BarcodeFormat format, int width, int height)
+  BitMatrix encode(String contents, BarcodeFormat format, int width, int height)
       throws WriterException;
 
   /**
@@ -48,7 +48,7 @@ ByteMatrix encode(String contents, BarcodeFormat format, int width, int height)
    * @param hints Additional parameters to supply to the encoder
    * @return The generated barcode as a Matrix of unsigned bytes (0 == black, 255 == white)
    */
-  ByteMatrix encode(String contents, BarcodeFormat format, int width, int height, Hashtable hints)
+  BitMatrix encode(String contents, BarcodeFormat format, int width, int height, Hashtable hints)
       throws WriterException;
 
 }

File: core/src/com/google/zxing/oned/Code128Writer.java
Patch:
@@ -19,7 +19,7 @@
 import java.util.Hashtable;
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.WriterException;
-import com.google.zxing.common.ByteMatrix;
+import com.google.zxing.common.BitMatrix;
 
 /**
  * This object renders a CODE128 code as a {@link BitMatrix}.
@@ -28,7 +28,7 @@
  */
 public final class Code128Writer extends UPCEANWriter {
 
-	  public ByteMatrix encode(String contents,
+	  public BitMatrix encode(String contents,
                             BarcodeFormat format,
                             int width,
                             int height,

File: core/src/com/google/zxing/oned/Code39Writer.java
Patch:
@@ -19,7 +19,7 @@
 import java.util.Hashtable;
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.WriterException;
-import com.google.zxing.common.ByteMatrix;
+import com.google.zxing.common.BitMatrix;
 
 /**
  * This object renders a CODE39 code as a {@link BitMatrix}.
@@ -28,7 +28,7 @@
  */
 public final class Code39Writer extends UPCEANWriter {
 
-	  public ByteMatrix encode(String contents, BarcodeFormat format, int width, int height,
+	  public BitMatrix encode(String contents, BarcodeFormat format, int width, int height,
 	      Hashtable hints) throws WriterException {
 	    if (format != BarcodeFormat.CODE_39) {
 	      throw new IllegalArgumentException("Can only encode CODE_39, but got " + format);

File: core/src/com/google/zxing/oned/ITFWriter.java
Patch:
@@ -19,7 +19,7 @@
 import java.util.Hashtable;
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.WriterException;
-import com.google.zxing.common.ByteMatrix;
+import com.google.zxing.common.BitMatrix;
 
 /**
  * This object renders a ITF code as a {@link BitMatrix}.
@@ -28,7 +28,7 @@
  */
 public final class ITFWriter extends UPCEANWriter {
 
-	  public ByteMatrix encode(String contents, BarcodeFormat format, int width, int height,
+	  public BitMatrix encode(String contents, BarcodeFormat format, int width, int height,
 	      Hashtable hints) throws WriterException {
 	    if (format != BarcodeFormat.ITF) {
 	      throw new IllegalArgumentException("Can only encode ITF, but got " + format);

File: core/src/com/google/zxing/pdf417/decoder/BitMatrixParser.java
Patch:
@@ -60,7 +60,7 @@ final class BitMatrixParser {
    * @return an array of codewords.
    */
   int[] readCodewords() throws FormatException {
-    int width = bitMatrix.getDimension();
+    int width = bitMatrix.getWidth();
     // TODO should be a rectangular matrix
     int height = width;
 
@@ -186,7 +186,7 @@ private static int[] trimArray(int[] array, int size) {
    */
   int processRow(int[] rowCounters, int rowNumber, int rowHeight, int[] codewords, int next)
       throws FormatException {
-    int width = bitMatrix.getDimension();
+    int width = bitMatrix.getWidth();
     int columnNumber = 0;
     long symbol = 0;
     for (int i = 0; i < width; i += MODULES_IN_SYMBOL) {

File: core/src/com/google/zxing/qrcode/encoder/MaskUtil.java
Patch:
@@ -16,8 +16,6 @@
 
 package com.google.zxing.qrcode.encoder;
 
-import com.google.zxing.common.ByteMatrix;
-
 /**
  * @author satorux@google.com (Satoru Takabayashi) - creator
  * @author dswitkin@google.com (Daniel Switkin) - ported from C++

File: core/src/com/google/zxing/qrcode/encoder/QRCode.java
Patch:
@@ -16,7 +16,6 @@
 
 package com.google.zxing.qrcode.encoder;
 
-import com.google.zxing.common.ByteMatrix;
 import com.google.zxing.qrcode.decoder.ErrorCorrectionLevel;
 import com.google.zxing.qrcode.decoder.Mode;
 

File: core/test/src/com/google/zxing/common/BitMatrixTestCase.java
Patch:
@@ -26,7 +26,7 @@ public final class BitMatrixTestCase extends TestCase {
 
   public void testGetSet() {
     BitMatrix matrix = new BitMatrix(33);
-    assertEquals(33, matrix.getDimension());
+    assertEquals(33, matrix.getHeight());
     for (int y = 0; y < 33; y++) {
       for (int x = 0; x < 33; x++) {
         if (y * x % 3 == 0) {
@@ -94,7 +94,7 @@ public void testRectangularSetRegion() {
   public void testGetRow() {
     BitMatrix matrix = new BitMatrix(102, 5);
     for (int x = 0; x < 102; x++) {
-      if ((x & 3) == 0) {
+      if ((x & 0x03) == 0) {
         matrix.set(x, 2);
       }
     }
@@ -114,7 +114,7 @@ public void testGetRow() {
     assertEquals(200, array3.getSize());
 
     for (int x = 0; x < 102; x++) {
-      boolean on = ((x & 3) == 0);
+      boolean on = ((x & 0x03) == 0);
       assertEquals(on, array.get(x));
       assertEquals(on, array2.get(x));
       assertEquals(on, array3.get(x));

File: core/test/src/com/google/zxing/qrcode/encoder/MaskUtilTestCase.java
Patch:
@@ -16,7 +16,6 @@
 
 package com.google.zxing.qrcode.encoder;
 
-import com.google.zxing.common.ByteMatrix;
 import junit.framework.TestCase;
 
 /**

File: core/test/src/com/google/zxing/qrcode/encoder/QRCodeTestCase.java
Patch:
@@ -16,7 +16,6 @@
 
 package com.google.zxing.qrcode.encoder;
 
-import com.google.zxing.common.ByteMatrix;
 import com.google.zxing.qrcode.decoder.ErrorCorrectionLevel;
 import com.google.zxing.qrcode.decoder.Mode;
 import junit.framework.TestCase;

File: android/src/com/google/zxing/client/android/CameraManager.java
Patch:
@@ -160,7 +160,7 @@ public void openDriver(SurfaceHolder holder) throws IOException {
 
       setCameraParameters();
       SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(context);
-      if (prefs.getBoolean(PreferencesActivity.KEY_FRONT_LIGHT, true)) {
+      if (prefs.getBoolean(PreferencesActivity.KEY_FRONT_LIGHT, false)) {
         FlashlightManager.enableFlashlight();
       }
     }

File: core/test/src/com/google/zxing/negative/FalsePositivesBlackBoxTestCase.java
Patch:
@@ -29,8 +29,8 @@ public FalsePositivesBlackBoxTestCase() {
     super("test/data/blackbox/falsepositives");
     addTest(2, 0.0f);
     addTest(0, 90.0f);
-    addTest(0, 180.0f);
-    addTest(0, 270.0f);
+    addTest(1, 180.0f);
+    addTest(1, 270.0f);
   }
 
 }

File: core/test/src/com/google/zxing/negative/PartialBlackBoxTestCase.java
Patch:
@@ -27,7 +27,7 @@ public final class PartialBlackBoxTestCase extends AbstractNegativeBlackBoxTestC
 
   public PartialBlackBoxTestCase() {
     super("test/data/blackbox/partial");
-    addTest(0, 0.0f);
+    addTest(1, 0.0f);
     addTest(1, 90.0f);
     addTest(1, 180.0f);
     addTest(0, 270.0f);

File: core/test/src/com/google/zxing/negative/UnsupportedBlackBoxTestCase.java
Patch:
@@ -27,7 +27,7 @@ public final class UnsupportedBlackBoxTestCase extends AbstractNegativeBlackBoxT
 
   public UnsupportedBlackBoxTestCase() {
     super("test/data/blackbox/unsupported");
-    addTest(0, 0.0f);
+    addTest(1, 0.0f);
     addTest(0, 90.0f);
     addTest(1, 180.0f);
     addTest(0, 270.0f);

File: core/test/src/com/google/zxing/oned/Code128BlackBox2TestCase.java
Patch:
@@ -28,7 +28,7 @@ public final class Code128BlackBox2TestCase extends AbstractBlackBoxTestCase {
   public Code128BlackBox2TestCase() {
     super("test/data/blackbox/code128-2", new MultiFormatReader(), BarcodeFormat.CODE_128);
     addTest(33, 39, 0.0f);
-    addTest(34, 37, 180.0f);
+    addTest(34, 39, 180.0f);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/oned/EAN13BlackBox1TestCase.java
Patch:
@@ -27,8 +27,8 @@ public final class EAN13BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox1TestCase() {
     super("test/data/blackbox/ean13-1", new MultiFormatReader(), BarcodeFormat.EAN_13);
-    addTest(28, 30, 0.0f);
-    addTest(26, 30, 180.0f);
+    addTest(28, 31, 0.0f);
+    addTest(26, 31, 180.0f);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/oned/EAN13BlackBox2TestCase.java
Patch:
@@ -29,7 +29,7 @@ public final class EAN13BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox2TestCase() {
     super("test/data/blackbox/ean13-2", new MultiFormatReader(), BarcodeFormat.EAN_13);
-    addTest(10, 14, 0.0f);
+    addTest(10, 16, 0.0f);
     addTest(10, 16, 180.0f);
   }
 

File: core/test/src/com/google/zxing/oned/UPCABlackBox1TestCase.java
Patch:
@@ -27,8 +27,8 @@ public final class UPCABlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public UPCABlackBox1TestCase() {
     super("test/data/blackbox/upca-1", new MultiFormatReader(), BarcodeFormat.UPC_A);
-    addTest(15, 16, 0.0f);
-    addTest(15, 19, 180.0f);
+    addTest(15, 18, 0.0f);
+    addTest(15, 18, 180.0f);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/oned/UPCABlackBox4TestCase.java
Patch:
@@ -27,8 +27,8 @@ public final class UPCABlackBox4TestCase extends AbstractBlackBoxTestCase {
 
   public UPCABlackBox4TestCase() {
     super("test/data/blackbox/upca-4", new MultiFormatReader(), BarcodeFormat.UPC_A);
-    addTest(8, 13, 0.0f);
-    addTest(8, 12, 180.0f);
+    addTest(7, 11, 0.0f);
+    addTest(8, 11, 180.0f);
   }
 
 }

File: core/test/src/com/google/zxing/oned/rss/RSS14BlackBox2TestCase.java
Patch:
@@ -27,8 +27,8 @@ public final class RSS14BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public RSS14BlackBox2TestCase() {
     super("test/data/blackbox/rss14-2", new MultiFormatReader(), BarcodeFormat.RSS14);
-    addTest(7, 9, 0.0f);
-    addTest(6, 9, 180.0f);
+    addTest(0, 8, 0.0f);
+    addTest(0, 8, 180.0f);
   }
 
 }
\ No newline at end of file

File: android/src/com/google/zxing/client/android/CaptureActivity.java
Patch:
@@ -107,7 +107,7 @@ public final class CaptureActivity extends Activity implements SurfaceHolder.Cal
     PRODUCT_FORMATS.add(BarcodeFormat.UPC_E);
     PRODUCT_FORMATS.add(BarcodeFormat.EAN_13);
     PRODUCT_FORMATS.add(BarcodeFormat.EAN_8);
-    //PRODUCT_FORMATS.add(BarcodeFormat.RSS14);
+    PRODUCT_FORMATS.add(BarcodeFormat.RSS14);
     ONE_D_FORMATS = new Vector<BarcodeFormat>(PRODUCT_FORMATS.size() + 3);
     ONE_D_FORMATS.addAll(PRODUCT_FORMATS);
     ONE_D_FORMATS.add(BarcodeFormat.CODE_39);
@@ -255,6 +255,7 @@ private static Vector<BarcodeFormat> parseDecodeFormats(Intent intent) {
         for (String format : COMMA_PATTERN.split(scanFormats)) {
           formats.add(BarcodeFormat.valueOf(format));
         }
+        return formats;
       } catch (IllegalArgumentException iae) {
         // ignore it then
       }

File: javase/src/com/google/zxing/client/j2se/MatrixToImageWriter.java
Patch:
@@ -68,7 +68,7 @@ public static BufferedImage toBufferedImage(ByteMatrix matrix) {
     BufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);
     for (int x = 0; x < width; x++) {
       for (int y = 0; y < height; y++) {
-        image.setRGB(x, y, matrix.get(x, y) == 0 ? WHITE : BLACK);
+        image.setRGB(x, y, matrix.get(x, y) == 0 ? BLACK : WHITE);
       }
     }
     return image;

File: core/src/com/google/zxing/oned/OneDReader.java
Patch:
@@ -103,7 +103,7 @@ private Result doDecode(BinaryBitmap image, Hashtable hints) throws NotFoundExce
 
     int middle = height >> 1;
     boolean tryHarder = hints != null && hints.containsKey(DecodeHintType.TRY_HARDER);
-    int rowStep = Math.max(1, height >> (tryHarder ? 7 : 4));
+    int rowStep = Math.max(1, height >> (tryHarder ? 8 : 4));
     int maxLines;
     if (tryHarder) {
       maxLines = height; // Look at the whole image, not just the center

File: android/src/com/google/zxing/client/android/CaptureActivityHandler.java
Patch:
@@ -92,7 +92,9 @@ public void handleMessage(Message message) {
         break;
       case R.id.launch_product_query:
         String url = (String) message.obj;
-        activity.startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(url)));
+        Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));
+        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);        
+        activity.startActivity(intent);
         break;
     }
   }

File: android/src/com/google/zxing/client/android/HelpActivity.java
Patch:
@@ -60,7 +60,9 @@ public void onClick(View view) {
 
   private final DialogInterface.OnClickListener groupsListener = new DialogInterface.OnClickListener() {
     public void onClick(DialogInterface dialogInterface, int i) {
-      HelpActivity.this.startActivity(new Intent(Intent.ACTION_VIEW, BUGGY_URI));
+      Intent intent = new Intent(Intent.ACTION_VIEW, BUGGY_URI);
+      intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);              
+      HelpActivity.this.startActivity(intent);
     }
   };
 

File: android/src/com/google/zxing/client/android/book/BrowseBookListener.java
Patch:
@@ -47,8 +47,9 @@ public void onItemClick(AdapterView<?> parent, View v, int position, long id) {
       String readBookURI = "http://books.google." +
           LocaleManager.getBookSearchCountryTLD() +
           "/books?id=" + volumeId + "&pg=" + pageId + "&vq=" + query;
-      activity.startActivity(new Intent(Intent.ACTION_VIEW,
-          Uri.parse(readBookURI)));
+      Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(readBookURI));
+      intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);                    
+      activity.startActivity(intent);
     }
   }
 }

File: android/src/com/google/zxing/client/android/history/HistoryManager.java
Patch:
@@ -93,6 +93,7 @@ public void onClick(DialogInterface dialogInterface, int i) {
         } else if (i == dialogItems.length - 2) {
           String history = buildHistory();
           Intent intent = new Intent(Intent.ACTION_SEND, Uri.parse("mailto:"));
+          intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);          
           intent.putExtra(Intent.EXTRA_SUBJECT, res.getString(R.string.history_email_title));
           intent.putExtra(Intent.EXTRA_TEXT, history);
           intent.setType("text/plain");

File: android/src/com/google/zxing/client/android/result/ResultHandler.java
Patch:
@@ -339,6 +339,7 @@ final void openGoogleShopper(String query) {
 
   void launchIntent(Intent intent) {
     if (intent != null) {
+      intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);
       try {
         activity.startActivity(intent);
       } catch (ActivityNotFoundException e) {

File: android/src/com/google/zxing/client/android/share/AppPickerActivity.java
Patch:
@@ -49,6 +49,7 @@ protected void onListItemClick(ListView l, View view, int position, long id) {
     if (position >= 0 && position < labelsPackages.size()) {
       String url = "market://search?q=pname:" + labelsPackages.get(position)[1];
       Intent intent = new Intent();
+      intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);      
       intent.putExtra(Browser.BookmarkColumns.URL, url);
       setResult(RESULT_OK, intent);
     } else {

File: android/src/com/google/zxing/client/android/share/BookmarkPickerActivity.java
Patch:
@@ -70,6 +70,7 @@ protected void onCreate(Bundle icicle) {
   protected void onListItemClick(ListView l, View view, int position, long id) {
     if (cursor.moveToPosition(position)) {
       Intent intent = new Intent();
+      intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);
       intent.putExtra(Browser.BookmarkColumns.TITLE, cursor.getString(TITLE_COLUMN));
       intent.putExtra(Browser.BookmarkColumns.URL, cursor.getString(URL_COLUMN));
       setResult(RESULT_OK, intent);

File: javase/src/com/google/zxing/client/j2se/MatrixToImageWriter.java
Patch:
@@ -68,7 +68,7 @@ public static BufferedImage toBufferedImage(ByteMatrix matrix) {
     BufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);
     for (int x = 0; x < width; x++) {
       for (int y = 0; y < height; y++) {
-        image.setRGB(x, y, matrix.get(x, y) == 0 ? BLACK : WHITE);
+        image.setRGB(x, y, matrix.get(x, y) == 0 ? WHITE : BLACK);
       }
     }
     return image;

File: android/src/com/google/zxing/client/android/CaptureActivityHandler.java
Patch:
@@ -47,9 +47,10 @@ private enum State {
 
   CaptureActivityHandler(CaptureActivity activity,
                          Vector<BarcodeFormat> decodeFormats,
+                         String characterSet,
                          boolean beginScanning) {
     this.activity = activity;
-    decodeThread = new DecodeThread(activity, decodeFormats,
+    decodeThread = new DecodeThread(activity, decodeFormats, characterSet,
         new ViewfinderResultPointCallback(activity.getViewfinderView()));
     decodeThread.start();
     state = State.SUCCESS;

File: android/src/com/google/zxing/client/android/CameraManager.java
Patch:
@@ -287,8 +287,6 @@ public PlanarYUVLuminanceSource buildLuminanceSource(byte[] data, int width, int
       // This is the standard Android format which all devices are REQUIRED to support.
       // In theory, it's the only one we should ever care about.
       case PixelFormat.YCbCr_420_SP:
-        return new PlanarYUVLuminanceSource(data, width, height, rect.left, rect.top,
-            rect.width(), rect.height());
       // This format has never been seen in the wild, but is compatible as we only care
       // about the Y channel, so allow it.
       case PixelFormat.YCbCr_422_SP:
@@ -297,7 +295,7 @@ public PlanarYUVLuminanceSource buildLuminanceSource(byte[] data, int width, int
       default:
         // The Samsung Moment incorrectly uses this variant instead of the 'sp' version.
         // Fortunately, it too has all the Y data up front, so we can read it.
-        if (previewFormatString.equals("yuv420p")) {
+        if ("yuv420p".equals(previewFormatString)) {
           return new PlanarYUVLuminanceSource(data, width, height, rect.left, rect.top,
             rect.width(), rect.height());
         }

File: core/src/com/google/zxing/Binarizer.java
Patch:
@@ -55,7 +55,7 @@ public LuminanceSource getLuminanceSource() {
    *            If used, the Binarizer will call BitArray.clear(). Always use the returned object.
    * @return The array of bits for this row (true means black).
    */
-  public abstract BitArray getBlackRow(int y, BitArray row) throws ReaderException;
+  public abstract BitArray getBlackRow(int y, BitArray row) throws NotFoundException;
 
   /**
    * Converts a 2D array of luminance data to 1 bit data. As above, assume this method is expensive
@@ -65,7 +65,7 @@ public LuminanceSource getLuminanceSource() {
    *
    * @return The 2D array of bits for the image (true means black).
    */
-  public abstract BitMatrix getBlackMatrix() throws ReaderException;
+  public abstract BitMatrix getBlackMatrix() throws NotFoundException;
 
   /**
    * Creates a new object with the same type as this Binarizer implementation, but with pristine

File: core/src/com/google/zxing/BinaryBitmap.java
Patch:
@@ -62,7 +62,7 @@ public int getHeight() {
    *            If used, the Binarizer will call BitArray.clear(). Always use the returned object.
    * @return The array of bits for this row (true means black).
    */
-  public BitArray getBlackRow(int y, BitArray row) throws ReaderException {
+  public BitArray getBlackRow(int y, BitArray row) throws NotFoundException {
     return binarizer.getBlackRow(y, row);
   }
 
@@ -74,7 +74,7 @@ public BitArray getBlackRow(int y, BitArray row) throws ReaderException {
    *
    * @return The 2D array of bits for the image (true means black).
    */
-  public BitMatrix getBlackMatrix() throws ReaderException {
+  public BitMatrix getBlackMatrix() throws NotFoundException {
     // The matrix is created on demand the first time it is requested, then cached. There are two
     // reasons for this:
     // 1. This work will never be done if the caller only installs 1D Reader objects, or if a

File: core/src/com/google/zxing/common/HybridBinarizer.java
Patch:
@@ -18,7 +18,7 @@
 
 import com.google.zxing.Binarizer;
 import com.google.zxing.LuminanceSource;
-import com.google.zxing.ReaderException;
+import com.google.zxing.NotFoundException;
 
 /**
  * This class implements a local thresholding algorithm, which while slower than the
@@ -49,7 +49,7 @@ public HybridBinarizer(LuminanceSource source) {
     super(source);
   }
 
-  public BitMatrix getBlackMatrix() throws ReaderException {
+  public BitMatrix getBlackMatrix() throws NotFoundException {
     binarizeEntireImage();
     return matrix;
   }
@@ -61,7 +61,7 @@ public Binarizer createBinarizer(LuminanceSource source) {
   // Calculates the final BitMatrix once for all requests. This could be called once from the
   // constructor instead, but there are some advantages to doing it lazily, such as making
   // profiling easier, and not doing heavy lifting when callers don't expect it.
-  private void binarizeEntireImage() throws ReaderException {
+  private void binarizeEntireImage() throws NotFoundException {
     if (matrix == null) {
       LuminanceSource source = getLuminanceSource();
       if (source.getWidth() >= MINIMUM_DIMENSION && source.getHeight() >= MINIMUM_DIMENSION) {

File: core/src/com/google/zxing/multi/qrcode/QRCodeMultiReader.java
Patch:
@@ -18,6 +18,7 @@
 
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.BinaryBitmap;
+import com.google.zxing.NotFoundException;
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
 import com.google.zxing.ResultMetadataType;
@@ -41,11 +42,11 @@ public final class QRCodeMultiReader extends QRCodeReader implements MultipleBar
 
   private static final Result[] EMPTY_RESULT_ARRAY = new Result[0];
 
-  public Result[] decodeMultiple(BinaryBitmap image) throws ReaderException {
+  public Result[] decodeMultiple(BinaryBitmap image) throws NotFoundException {
     return decodeMultiple(image, null);
   }
 
-  public Result[] decodeMultiple(BinaryBitmap image, Hashtable hints) throws ReaderException {
+  public Result[] decodeMultiple(BinaryBitmap image, Hashtable hints) throws NotFoundException {
     Vector results = new Vector();
     DetectorResult[] detectorResult = new MultiDetector(image.getBlackMatrix()).detectMulti(hints);
     for (int i = 0; i < detectorResult.length; i++) {

File: core/src/com/google/zxing/oned/EAN8Reader.java
Patch:
@@ -17,7 +17,7 @@
 package com.google.zxing.oned;
 
 import com.google.zxing.BarcodeFormat;
-import com.google.zxing.ReaderException;
+import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitArray;
 
 /**
@@ -34,7 +34,7 @@ public EAN8Reader() {
   }
 
   protected int decodeMiddle(BitArray row, int[] startRange, StringBuffer result)
-      throws ReaderException {
+      throws NotFoundException {
     int[] counters = decodeMiddleCounters;
     counters[0] = 0;
     counters[1] = 0;

File: core/src/com/google/zxing/oned/MultiFormatOneDReader.java
Patch:
@@ -18,11 +18,11 @@
 
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.DecodeHintType;
+import com.google.zxing.NotFoundException;
 import com.google.zxing.Reader;
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
 import com.google.zxing.common.BitArray;
-import com.google.zxing.oned.rss.RSS14Reader;
 
 import java.util.Hashtable;
 import java.util.Vector;
@@ -70,7 +70,7 @@ public MultiFormatOneDReader(Hashtable hints) {
     }
   }
 
-  public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws ReaderException {
+  public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws NotFoundException {
     int size = readers.size();
     for (int i = 0; i < size; i++) {
       OneDReader reader = (OneDReader) readers.elementAt(i);
@@ -81,7 +81,7 @@ public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws Rea
       }
     }
 
-    throw ReaderException.getInstance();
+    throw NotFoundException.getNotFoundInstance();
   }
 
   public void reset() {

File: core/src/com/google/zxing/oned/MultiFormatUPCEANReader.java
Patch:
@@ -18,6 +18,7 @@
 
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.DecodeHintType;
+import com.google.zxing.NotFoundException;
 import com.google.zxing.Reader;
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
@@ -62,7 +63,7 @@ public MultiFormatUPCEANReader(Hashtable hints) {
     }
   }
 
-  public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws ReaderException {
+  public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws NotFoundException {
     // Compute this location once and reuse it on multiple implementations
     int[] startGuardPattern = UPCEANReader.findStartGuardPattern(row);
     int size = readers.size();
@@ -92,7 +93,7 @@ public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws Rea
       return result;
     }
 
-    throw ReaderException.getInstance();
+    throw NotFoundException.getNotFoundInstance();
   }
 
   public void reset() {

File: core/src/com/google/zxing/pdf417/decoder/BitMatrixParser.java
Patch:
@@ -16,7 +16,7 @@
 
 package com.google.zxing.pdf417.decoder;
 
-import com.google.zxing.ReaderException;
+import com.google.zxing.NotFoundException;
 import com.google.zxing.common.BitMatrix;
 
 /**
@@ -379,7 +379,7 @@ public int getECLevel() {
    * @param next        the next available index into the codewords array.
    * @return the next available index into the codeword array after processing
    *         this row.
-   * @throws ReaderException
+   * @throws NotFoundException
    */
   /*
   int processRow1(int[] rowCounters, int rowNumber, int rowHeight,

File: core/src/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -16,7 +16,7 @@
 
 package com.google.zxing.pdf417.decoder;
 
-import com.google.zxing.ReaderException;
+import com.google.zxing.FormatException;
 import com.google.zxing.common.DecoderResult;
 
 /**
@@ -81,7 +81,7 @@ final class DecodedBitStreamParser {
   private DecodedBitStreamParser() {
   }
 
-  static DecoderResult decode(int[] codewords) throws ReaderException {
+  static DecoderResult decode(int[] codewords) throws FormatException {
     StringBuffer result = new StringBuffer(100);
     // Get compaction mode
     int codeIndex = 1;
@@ -120,7 +120,7 @@ static DecoderResult decode(int[] codewords) throws ReaderException {
       if (codeIndex < codewords.length) {
         code = codewords[codeIndex++];
       } else {
-        throw ReaderException.getInstance();
+        throw FormatException.getFormatInstance();
       }
     }
     return new DecoderResult(null, result.toString(), null, null);

File: core/src/com/google/zxing/qrcode/QRCodeWriter.java
Patch:
@@ -21,9 +21,9 @@
 import com.google.zxing.Writer;
 import com.google.zxing.WriterException;
 import com.google.zxing.common.ByteMatrix;
+import com.google.zxing.qrcode.decoder.ErrorCorrectionLevel;
 import com.google.zxing.qrcode.encoder.Encoder;
 import com.google.zxing.qrcode.encoder.QRCode;
-import com.google.zxing.qrcode.decoder.ErrorCorrectionLevel;
 
 import java.util.Hashtable;
 

File: core/src/com/google/zxing/qrcode/encoder/Encoder.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.qrcode.encoder;
 
-import com.google.zxing.WriterException;
 import com.google.zxing.EncodeHintType;
+import com.google.zxing.WriterException;
 import com.google.zxing.common.ByteArray;
 import com.google.zxing.common.ByteMatrix;
 import com.google.zxing.common.CharacterSetECI;
@@ -27,9 +27,9 @@
 import com.google.zxing.qrcode.decoder.Mode;
 import com.google.zxing.qrcode.decoder.Version;
 
-import java.util.Vector;
-import java.util.Hashtable;
 import java.io.UnsupportedEncodingException;
+import java.util.Hashtable;
+import java.util.Vector;
 
 /**
  * @author satorux@google.com (Satoru Takabayashi) - creator

File: core/test/src/com/google/zxing/client/result/AddressBookParsedResultTestCase.java
Patch:
@@ -16,9 +16,9 @@
 
 package com.google.zxing.client.result;
 
-import junit.framework.TestCase;
-import com.google.zxing.Result;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.Result;
+import junit.framework.TestCase;
 
 import java.util.Arrays;
 

File: core/test/src/com/google/zxing/client/result/CalendarParsedResultTestCase.java
Patch:
@@ -16,9 +16,9 @@
 
 package com.google.zxing.client.result;
 
-import junit.framework.TestCase;
-import com.google.zxing.Result;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.Result;
+import junit.framework.TestCase;
 
 /**
  * Tests {@link CalendarParsedResult}.

File: core/test/src/com/google/zxing/client/result/EmailAddressParsedResultTestCase.java
Patch:
@@ -16,9 +16,9 @@
 
 package com.google.zxing.client.result;
 
-import junit.framework.TestCase;
-import com.google.zxing.Result;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.Result;
+import junit.framework.TestCase;
 
 /**
  * Tests {@link EmailAddressParsedResult}.

File: core/test/src/com/google/zxing/client/result/GeoParsedResultTestCase.java
Patch:
@@ -16,9 +16,9 @@
 
 package com.google.zxing.client.result;
 
-import junit.framework.TestCase;
-import com.google.zxing.Result;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.Result;
+import junit.framework.TestCase;
 
 /**
  * Tests {@link com.google.zxing.client.result.GeoParsedResult}.

File: core/test/src/com/google/zxing/client/result/ISBNParsedResultTestCase.java
Patch:
@@ -16,9 +16,9 @@
 
 package com.google.zxing.client.result;
 
-import junit.framework.TestCase;
-import com.google.zxing.Result;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.Result;
+import junit.framework.TestCase;
 
 /**
  * Tests {@link ISBNParsedResult}.

File: core/test/src/com/google/zxing/client/result/ProductParsedResultTestCase.java
Patch:
@@ -16,9 +16,9 @@
 
 package com.google.zxing.client.result;
 
-import junit.framework.TestCase;
-import com.google.zxing.Result;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.Result;
+import junit.framework.TestCase;
 
 /**
  * Tests {@link ProductParsedResult}.

File: core/test/src/com/google/zxing/client/result/SMSMMSParsedResultTestCase.java
Patch:
@@ -16,9 +16,9 @@
 
 package com.google.zxing.client.result;
 
-import junit.framework.TestCase;
-import com.google.zxing.Result;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.Result;
+import junit.framework.TestCase;
 
 /**
  * Tests {@link SMSParsedResult}.

File: core/test/src/com/google/zxing/client/result/TelParsedResultTestCase.java
Patch:
@@ -16,9 +16,9 @@
 
 package com.google.zxing.client.result;
 
-import junit.framework.TestCase;
-import com.google.zxing.Result;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.Result;
+import junit.framework.TestCase;
 
 /**
  * Tests {@link TelParsedResult}.

File: core/test/src/com/google/zxing/client/result/URIParsedResultTestCase.java
Patch:
@@ -16,9 +16,9 @@
 
 package com.google.zxing.client.result;
 
-import junit.framework.TestCase;
-import com.google.zxing.Result;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.Result;
+import junit.framework.TestCase;
 
 /**
  * Tests {@link URIParsedResult}.

File: core/test/src/com/google/zxing/common/AbstractBlackBoxTestCase.java
Patch:
@@ -24,9 +24,9 @@
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
 import com.google.zxing.client.j2se.BufferedImageLuminanceSource;
-
 import junit.framework.TestCase;
 
+import javax.imageio.ImageIO;
 import java.awt.geom.AffineTransform;
 import java.awt.image.AffineTransformOp;
 import java.awt.image.BufferedImage;
@@ -41,8 +41,6 @@
 import java.util.Hashtable;
 import java.util.List;
 
-import javax.imageio.ImageIO;
-
 /**
  * @author Sean Owen
  * @author dswitkin@google.com (Daniel Switkin)

File: core/test/src/com/google/zxing/common/AbstractNegativeBlackBoxTestCase.java
Patch:
@@ -23,14 +23,13 @@
 import com.google.zxing.Result;
 import com.google.zxing.client.j2se.BufferedImageLuminanceSource;
 
+import javax.imageio.ImageIO;
 import java.awt.image.BufferedImage;
 import java.io.File;
 import java.io.IOException;
 import java.util.ArrayList;
 import java.util.List;
 
-import javax.imageio.ImageIO;
-
 /**
  * This abstract class looks for negative results, i.e. it only allows a certain number of false
  * positives in images which should not decode. This helps ensure that we are not too lenient.

File: core/test/src/com/google/zxing/oned/Code39BlackBox1TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/Code39BlackBox3TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/Code39ExtendedBlackBox2TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.common.AbstractBlackBoxTestCase;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**
  * @author Sean Owen

File: core/test/src/com/google/zxing/oned/EAN13BlackBox1TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/EAN13BlackBox2TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/EAN13BlackBox3TestCase.java
Patch:
@@ -16,12 +16,10 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */

File: core/test/src/com/google/zxing/oned/EAN8BlackBox1TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/UPCABlackBox1TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/UPCABlackBox2TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/UPCABlackBox3ReflectiveTestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/UPCABlackBox4TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/UPCEBlackBox1TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/UPCEBlackBox2TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/oned/UPCEBlackBox3ReflectiveTestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.oned;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox1TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.qrcode;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.qrcode;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox3TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.qrcode;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox4TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.qrcode;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox5TestCase.java
Patch:
@@ -16,8 +16,8 @@
 
 package com.google.zxing.qrcode;
 
-import com.google.zxing.MultiFormatReader;
 import com.google.zxing.BarcodeFormat;
+import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 /**

File: core/test/src/com/google/zxing/qrcode/decoder/VersionTestCase.java
Patch:
@@ -16,7 +16,6 @@
 
 package com.google.zxing.qrcode.decoder;
 
-import com.google.zxing.ReaderException;
 import junit.framework.TestCase;
 
 /**
@@ -51,7 +50,7 @@ private static void checkVersion(Version version, int number, int dimension) {
     assertNotNull(version.buildFunctionPattern());
   }
 
-  public void testGetProvisionalVersionForDimension() throws ReaderException {
+  public void testGetProvisionalVersionForDimension() throws Exception {
     for (int i = 1; i <= 40; i++) {
       assertEquals(i, Version.getProvisionalVersionForDimension(4*i + 17).getVersionNumber());
     }

File: javase/src/com/google/zxing/client/j2se/ImageConverter.java
Patch:
@@ -18,6 +18,7 @@
 
 import com.google.zxing.BinaryBitmap;
 import com.google.zxing.LuminanceSource;
+import com.google.zxing.NotFoundException;
 import com.google.zxing.ReaderException;
 import com.google.zxing.common.BitArray;
 import com.google.zxing.common.BitMatrix;
@@ -107,7 +108,7 @@ private static void convertImage(URI uri) throws IOException {
       for (int y = 0; y < height; y++) {
           try {
             array = bitmap.getBlackRow(y, array);
-          } catch (ReaderException e) {
+          } catch (NotFoundException nfe) {
             // Draw rows with insufficient dynamic range in red
             for (int x = 0; x < width; x++) {
               result.setRGB(x, y, RED);
@@ -127,7 +128,7 @@ private static void convertImage(URI uri) throws IOException {
             result.setRGB(x, y, matrix.get(x, y) ? BLACK : WHITE);
           }
         }
-      } catch (ReaderException e) {
+      } catch (NotFoundException nfe) {
 
       }
     }

File: core/test/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParserTestCase.java
Patch:
@@ -35,7 +35,7 @@ public void testSimpleByteMode() throws ReaderException {
     builder.write(0xF2, 8);
     builder.write(0xF3, 8);
     String result = DecodedBitStreamParser.decode(builder.toByteArray(),
-        Version.getVersionForNumber(1), null).getText();
+        Version.getVersionForNumber(1), null, null).getText();
     assertEquals("\u00f1\u00f2\u00f3", result);
   }
 
@@ -47,7 +47,7 @@ public void testSimpleSJIS() throws ReaderException {
     builder.write(0xA2, 8);
     builder.write(0xA3, 8);
     String result = DecodedBitStreamParser.decode(builder.toByteArray(),
-        Version.getVersionForNumber(1), null).getText();
+        Version.getVersionForNumber(1), null, null).getText();
     assertEquals("\uff61\uff62\uff63", result);
   }
 
@@ -61,7 +61,7 @@ public void testECI() throws ReaderException {
     builder.write(0xA2, 8);
     builder.write(0xA3, 8);
     String result = DecodedBitStreamParser.decode(builder.toByteArray(),
-        Version.getVersionForNumber(1), null).getText();
+        Version.getVersionForNumber(1), null, null).getText();
     assertEquals("\u00ed\u00f3\u00fa", result);
   }
 

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox3TestCase.java
Patch:
@@ -28,9 +28,9 @@ public final class QRCodeBlackBox3TestCase extends AbstractBlackBoxTestCase {
   public QRCodeBlackBox3TestCase() {
     super("test/data/blackbox/qrcode-3", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(36, 36, 0.0f);
-    addTest(37, 37, 90.0f);
-    addTest(35, 35, 180.0f);
-    addTest(36, 36, 270.0f);
+    addTest(38, 38, 90.0f);
+    addTest(36, 36, 180.0f);
+    addTest(37, 37, 270.0f);
   }
 
 }

File: zxingorg/src/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -27,6 +27,7 @@
 import com.google.zxing.client.j2se.BufferedImageLuminanceSource;
 import com.google.zxing.client.result.ParsedResult;
 import com.google.zxing.client.result.ResultParser;
+import com.google.zxing.common.GlobalHistogramBinarizer;
 import com.google.zxing.common.HybridBinarizer;
 
 import org.apache.commons.fileupload.FileItem;
@@ -249,7 +250,7 @@ private static void processStream(InputStream is, ServletRequest request,
     Result result;
     try {
       LuminanceSource source = new BufferedImageLuminanceSource(image);
-      BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
+      BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
       result = reader.decode(bitmap, HINTS);
     } catch (ReaderException re) {
       log.info("DECODE FAILED: " + re.toString());

File: core/src/com/google/zxing/oned/Code128Reader.java
Patch:
@@ -420,10 +420,11 @@ public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws Rea
     // Check for ample whitespace following pattern, but, to do this we first need to remember that
     // we fudged decoding CODE_STOP since it actually has 7 bars, not 6. There is a black bar left
     // to read off. Would be slightly better to properly read. Here we just skip it:
-    while (row.get(nextStart)) {
+    int width = row.getSize();
+    while (nextStart < width && row.get(nextStart)) {
       nextStart++;
     }
-    if (!row.isRange(nextStart, Math.min(row.getSize(), nextStart + (nextStart - lastStart) / 2),
+    if (!row.isRange(nextStart, Math.min(width, nextStart + (nextStart - lastStart) / 2),
         false)) {
       throw ReaderException.getInstance();
     }

File: core/src/com/google/zxing/client/result/VCardResultParser.java
Patch:
@@ -57,7 +57,7 @@ public static AddressBookParsedResult parse(Result result) {
     String org = matchSingleVCardPrefixedField("ORG", rawText, true);
     String birthday = matchSingleVCardPrefixedField("BDAY", rawText, true);
     if (!isLikeVCardDate(birthday)) {
-      return null;
+      birthday = null;
     }
     String title = matchSingleVCardPrefixedField("TITLE", rawText, true);
     String url = matchSingleVCardPrefixedField("URL", rawText, true);

File: core/src/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -237,6 +237,9 @@ private ResultPointsAndTransitions transitionsBetween(ResultPoint from, ResultPo
       if (error > 0) {
         y += ystep;
         error -= dx;
+        if (y == toY) {
+          break;
+        }
       }
     }
     return new ResultPointsAndTransitions(from, to, transitions);

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/ContactInfoGenerator.java
Patch:
@@ -71,6 +71,7 @@ private String getMeCard(String name, String tel, String url,
       String email, String address, String address2, String memo) {
     StringBuilder output = new StringBuilder();
     output.append("MECARD:");
+    name = name.replace(",", ""); // remove commas -- reserved char in MECARD
     output.append("N:").append(name).append(';');
     //maybeAppend(output, "ORG:", company); // Not standard; don't generate
     maybeAppend(output, "TEL:", tel);

File: android/src/com/google/zxing/client/android/DecodeThread.java
Patch:
@@ -23,7 +23,7 @@
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
 import com.google.zxing.ResultPointCallback;
-import com.google.zxing.common.GlobalHistogramBinarizer;
+import com.google.zxing.common.HybridBinarizer;
 
 import android.content.SharedPreferences;
 import android.os.Bundle;
@@ -165,7 +165,7 @@ private void decode(byte[] data, int width, int height) {
     long start = System.currentTimeMillis();
     Result rawResult = null;
     PlanarYUVLuminanceSource source = CameraManager.get().buildLuminanceSource(data, width, height);
-    BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
+    BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
     try {
       rawResult = multiFormatReader.decodeWithState(bitmap);
     } catch (ReaderException re) {

File: androidtest/src/com/google/zxing/client/androidtest/BenchmarkThread.java
Patch:
@@ -20,7 +20,7 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
-import com.google.zxing.common.GlobalHistogramBinarizer;
+import com.google.zxing.common.HybridBinarizer;
 
 import android.os.Debug;
 import android.os.Message;
@@ -94,7 +94,7 @@ private BenchmarkItem decode(String path) {
       // scheduling and what else is happening in the system.
       long now = Debug.threadCpuTimeNanos();
       try {
-        BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
+        BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
         result = mMultiFormatReader.decodeWithState(bitmap);
         success = true;
       } catch (ReaderException e) {

File: core/test/src/com/google/zxing/common/AbstractBlackBoxTestCase.java
Patch:
@@ -184,7 +184,7 @@ public SummaryResults testBlackBoxCountingResults(boolean assertOnFailure) throw
         float rotation = testResults.get(x).getRotation();
         BufferedImage rotatedImage = rotateImage(image, rotation);
         LuminanceSource source = new BufferedImageLuminanceSource(rotatedImage);
-        BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
+        BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
         if (decode(bitmap, rotation, expectedText, false)) {
           passedCounts[x]++;
         }
@@ -294,4 +294,4 @@ protected static BufferedImage rotateImage(BufferedImage original, float degrees
     }
   }
 
-}
\ No newline at end of file
+}

File: core/test/src/com/google/zxing/common/AbstractNegativeBlackBoxTestCase.java
Patch:
@@ -109,7 +109,7 @@ public void testBlackBox() throws IOException {
   private boolean checkForFalsePositives(BufferedImage image, float rotationInDegrees) {
     BufferedImage rotatedImage = rotateImage(image, rotationInDegrees);
     LuminanceSource source = new BufferedImageLuminanceSource(rotatedImage);
-    BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
+    BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
     Result result;
     try {
       result = getReader().decode(bitmap);

File: core/test/src/com/google/zxing/datamatrix/DataMatrixBlackBox2TestCase.java
Patch:
@@ -27,10 +27,10 @@ public final class DataMatrixBlackBox2TestCase extends AbstractBlackBoxTestCase
   public DataMatrixBlackBox2TestCase() {
     // TODO use MultiFormatReader here once Data Matrix decoder is done
     super("test/data/blackbox/datamatrix-2", new DataMatrixReader(), BarcodeFormat.DATAMATRIX);
-    addTest(2, 2, 0.0f);
+    addTest(4, 4, 0.0f);
     addTest(1, 1, 90.0f);
-    addTest(4, 4, 180.0f);
-    addTest(3, 3, 270.0f);
+    addTest(3, 3, 180.0f);
+    addTest(1, 1, 270.0f);
   }
 
 }

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox2TestCase.java
Patch:
@@ -34,7 +34,7 @@ public final class PDF417BlackBox2TestCase extends AbstractBlackBoxTestCase {
   public PDF417BlackBox2TestCase() {
     super("test/data/blackbox/pdf417-2", new MultiFormatReader(), BarcodeFormat.PDF417);
     addTest(11, 11, 0.0f);
-    addTest(12, 12, 180.0f);
+    addTest(11, 11, 180.0f);
   }
 
   @Override
@@ -46,4 +46,4 @@ protected Hashtable<DecodeHintType, Object> getHints() {
      return table;
    }
 
-}
\ No newline at end of file
+}

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -27,10 +27,10 @@ public final class QRCodeBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox2TestCase() {
     super("test/data/blackbox/qrcode-2", new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(23, 23, 0.0f);
-    addTest(21, 21, 90.0f);
+    addTest(21, 21, 0.0f);
+    addTest(18, 18, 90.0f);
     addTest(20, 20, 180.0f);
     addTest(18, 18, 270.0f);
   }
 
-}
\ No newline at end of file
+}

File: javase/src/com/google/zxing/client/j2se/CommandLineRunner.java
Patch:
@@ -16,18 +16,18 @@
 
 package com.google.zxing.client.j2se;
 
+import com.google.zxing.BarcodeFormat;
 import com.google.zxing.BinaryBitmap;
 import com.google.zxing.DecodeHintType;
 import com.google.zxing.LuminanceSource;
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
-import com.google.zxing.BarcodeFormat;
 import com.google.zxing.client.result.ParsedResult;
 import com.google.zxing.client.result.ResultParser;
 import com.google.zxing.common.BitArray;
 import com.google.zxing.common.BitMatrix;
-import com.google.zxing.common.GlobalHistogramBinarizer;
+import com.google.zxing.common.HybridBinarizer;
 
 import java.awt.image.BufferedImage;
 import java.io.File;
@@ -200,7 +200,7 @@ private static Result decode(URI uri, Hashtable<DecodeHintType, Object> hints,
     }
     try {
       LuminanceSource source = new BufferedImageLuminanceSource(image);
-      BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
+      BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
       if (dumpBlackPoint) {
         dumpBlackPoint(uri, image, bitmap);
       }

File: javase/src/com/google/zxing/client/j2se/GUIRunner.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
-import com.google.zxing.common.GlobalHistogramBinarizer;
+import com.google.zxing.common.HybridBinarizer;
 
 import java.awt.Container;
 import java.awt.Dimension;
@@ -95,7 +95,7 @@ private static String getDecodeText(File file) {
       return "Could not decode image";
     }
     LuminanceSource source = new BufferedImageLuminanceSource(image);
-    BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
+    BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
     Result result;
     try {
       result = new MultiFormatReader().decode(bitmap);

File: javase/src/com/google/zxing/client/j2se/ImageConverter.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.zxing.ReaderException;
 import com.google.zxing.common.BitArray;
 import com.google.zxing.common.BitMatrix;
-import com.google.zxing.common.GlobalHistogramBinarizer;
+import com.google.zxing.common.HybridBinarizer;
 
 import java.awt.image.BufferedImage;
 import java.io.File;
@@ -96,7 +96,7 @@ public static void main(String[] args) throws Exception {
   private static void convertImage(URI uri) throws IOException {
     BufferedImage image = ImageIO.read(uri.toURL());
     LuminanceSource source = new BufferedImageLuminanceSource(image);
-    BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
+    BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
     int width = bitmap.getWidth();
     int height = bitmap.getHeight();
 

File: zxingorg/src/com/google/zxing/web/DecodeEmailTask.java
Patch:
@@ -23,7 +23,7 @@
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
 import com.google.zxing.client.j2se.BufferedImageLuminanceSource;
-import com.google.zxing.common.GlobalHistogramBinarizer;
+import com.google.zxing.common.HybridBinarizer;
 
 import java.awt.image.BufferedImage;
 import java.io.IOException;
@@ -147,7 +147,7 @@ private void processMessagePart(Session session, Message message, MimeBodyPart p
         Result result = null;
         try {
           LuminanceSource source = new BufferedImageLuminanceSource(image);
-          BinaryBitmap bitmap = new BinaryBitmap(new GlobalHistogramBinarizer(source));
+          BinaryBitmap bitmap = new BinaryBitmap(new HybridBinarizer(source));
           result = reader.decode(bitmap, DecodeServlet.HINTS);
         } catch (ReaderException re) {
           log.info("Decoding FAILED");
@@ -191,4 +191,4 @@ public static void main(String[] args) {
     new DecodeEmailTask(emailAddress, emailAuthenticator).run();
   }
 
-}
\ No newline at end of file
+}

File: android/src/com/google/zxing/client/android/encode/QRCodeEncoder.java
Patch:
@@ -159,6 +159,9 @@ private boolean encodeContentsFromShareIntent(Intent intent) {
       return false;
     } catch (IOException e) {
       return false;
+    } catch (NullPointerException e) {
+      // In case the uri was not found in the Intent.
+      return false;
     }
     return contents != null && contents.length() > 0;
   }

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/ContactInfoGenerator.java
Patch:
@@ -76,7 +76,6 @@ private String getMeCard(String name, String tel, String url,
     maybeAppend(output, "TEL:", tel);
     maybeAppend(output, "URL:", url);
     maybeAppend(output, "EMAIL:", email);
-    maybeAppend(output, "ADR:", address);
     if (address.length() > 0 || address2.length() > 0) {
       output.append("ADR:");
       if (address.length() > 0) {

File: android/src/com/google/zxing/client/android/result/AddressBookResultHandler.java
Patch:
@@ -62,8 +62,8 @@ private int mapIndexToAction(int index) {
   public AddressBookResultHandler(Activity activity, ParsedResult result) {
     super(activity, result);
     AddressBookParsedResult addressResult = (AddressBookParsedResult) result;
-    String address = addressResult.getAddress();
-    boolean hasAddress = address != null && address.length() > 0;
+    String[] addresses = addressResult.getAddresses();
+    boolean hasAddress = addresses != null && addresses.length > 0 && addresses[0].length() > 0;
     String[] phoneNumbers = addressResult.getPhoneNumbers();
     boolean hasPhoneNumber = phoneNumbers != null && phoneNumbers.length > 0;
     String[] emails = addressResult.getEmails();

File: core/src/com/google/zxing/client/result/AddressBookAUResultParser.java
Patch:
@@ -46,8 +46,9 @@ public static AddressBookParsedResult parse(Result result) {
     String[] emails = matchMultipleValuePrefix("MAIL", 3, rawText, true);
     String note = matchSinglePrefixedField("MEMORY:", rawText, '\r', false);
     String address = matchSinglePrefixedField("ADD:", rawText, '\r', true);
+    String[] addresses = address == null ? null : new String[] {address};
     return new AddressBookParsedResult(maybeWrap(name), pronunciation, phoneNumbers, emails, note,
-        address, null, null, null, null);
+        addresses, null, null, null, null);
   }
 
   private static String[] matchMultipleValuePrefix(String prefix, int max, String rawText,

File: core/src/com/google/zxing/client/result/AddressBookDoCoMoResultParser.java
Patch:
@@ -49,7 +49,7 @@ public static AddressBookParsedResult parse(Result result) {
     String[] phoneNumbers = matchDoCoMoPrefixedField("TEL:", rawText, true);
     String[] emails = matchDoCoMoPrefixedField("EMAIL:", rawText, true);
     String note = matchSingleDoCoMoPrefixedField("NOTE:", rawText, false);
-    String address = matchSingleDoCoMoPrefixedField("ADR:", rawText, true);
+    String[] addresses = matchDoCoMoPrefixedField("ADR:", rawText, true);
     String birthday = matchSingleDoCoMoPrefixedField("BDAY:", rawText, true);
     if (birthday != null && !isStringOfDigits(birthday, 8)) {
       // No reason to throw out the whole card because the birthday is formatted wrong.
@@ -66,7 +66,7 @@ public static AddressBookParsedResult parse(Result result) {
                                        phoneNumbers,
                                        emails,
                                        note,
-                                       address,
+                                       addresses,
                                        org,
                                        birthday,
                                        null,

File: core/src/com/google/zxing/client/result/BizcardResultParser.java
Patch:
@@ -43,7 +43,7 @@ public static AddressBookParsedResult parse(Result result) {
     String fullName = buildName(firstName, lastName);
     String title = matchSingleDoCoMoPrefixedField("T:", rawText, true);
     String org = matchSingleDoCoMoPrefixedField("C:", rawText, true);
-    String address = matchSingleDoCoMoPrefixedField("A:", rawText, true);
+    String[] addresses = matchDoCoMoPrefixedField("A:", rawText, true);
     String phoneNumber1 = matchSingleDoCoMoPrefixedField("B:", rawText, true);
     String phoneNumber2 = matchSingleDoCoMoPrefixedField("M:", rawText, true);
     String phoneNumber3 = matchSingleDoCoMoPrefixedField("F:", rawText, true);
@@ -54,7 +54,7 @@ public static AddressBookParsedResult parse(Result result) {
                                        buildPhoneNumbers(phoneNumber1, phoneNumber2, phoneNumber3),
                                        maybeWrap(email),
                                        null,
-                                       address,
+                                       addresses,
                                        org,
                                        null,
                                        title,

File: core/src/com/google/zxing/qrcode/detector/Detector.java
Patch:
@@ -223,10 +223,10 @@ private float calculateModuleSizeOneWay(ResultPoint pattern, ResultPoint otherPa
         (int) pattern.getX(),
         (int) pattern.getY());
     if (Float.isNaN(moduleSizeEst1)) {
-      return moduleSizeEst2;
+      return moduleSizeEst2 / 7.0f;
     }
     if (Float.isNaN(moduleSizeEst2)) {
-      return moduleSizeEst1;
+      return moduleSizeEst1 / 7.0f;
     }
     // Average them, and divide by 7 since we've counted the width of 3 black modules,
     // and 1 white and 1 black module on either side. Ergo, divide sum by 14.

File: core/src/com/google/zxing/oned/UPCEReader.java
Patch:
@@ -52,7 +52,8 @@ public UPCEReader() {
     decodeMiddleCounters = new int[4];
   }
 
-  protected int decodeMiddle(BitArray row, int[] startRange, StringBuffer result) throws ReaderException {
+  protected int decodeMiddle(BitArray row, int[] startRange, StringBuffer result)
+      throws ReaderException {
     int[] counters = decodeMiddleCounters;
     counters[0] = 0;
     counters[1] = 0;
@@ -103,7 +104,7 @@ private static void determineNumSysAndCheckDigit(StringBuffer resultString, int
   }
 
   BarcodeFormat getBarcodeFormat() {
-    return BarcodeFormat.UPC_E;  
+    return BarcodeFormat.UPC_E;
   }
 
   /**

File: core/src/com/google/zxing/oned/ITFReader.java
Patch:
@@ -45,7 +45,7 @@ public final class ITFReader extends AbstractOneDReader {
   private static final int W = 3; // Pixel width of a wide line
   private static final int N = 1; // Pixed width of a narrow line
 
-  private static final int[] DEFAULT_ALLOWED_LENGTHS = { 6, 10, 14 };
+  private static final int[] DEFAULT_ALLOWED_LENGTHS = { 6, 10, 14, 44 };
 
   // Stores the actual narrow line width of the image being decoded.
   private int narrowLineWidth = -1;

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -40,6 +40,7 @@ public final class PreferencesActivity extends PreferenceActivity
   static final String KEY_COPY_TO_CLIPBOARD = "preferences_copy_to_clipboard";
 
   static final String KEY_HELP_VERSION_SHOWN = "preferences_help_version_shown";
+  public static final String KEY_NOT_OUR_RESULTS_SHOWN = "preferences_not_out_results_shown";
 
   private CheckBoxPreference decode1D;
   private CheckBoxPreference decodeQR;

File: android/src/com/google/zxing/client/android/CameraManager.java
Patch:
@@ -335,6 +335,9 @@ private void setCameraParameters() {
     // This is the standard setting to turn the flash off that all devices should honor.
     parameters.set("flash-mode", "off");
 
+    parameters.set("zoom", "2.0");
+    parameters.set("taking-picture-zoom", "20");
+
     camera.setParameters(parameters);
   }
 

File: core/src/com/google/zxing/client/result/VCardResultParser.java
Patch:
@@ -115,6 +115,9 @@ static String matchSingleVCardPrefixedField(String prefix, String rawText, boole
   }
 
   private static boolean isLikeVCardDate(String value) {
+    if (value == null) {
+      return true;
+    }
     // Not really sure this is true but matches practice
     // Mach YYYYMMDD
     if (isStringOfDigits(value, 8)) {

File: core/test/src/com/google/zxing/client/result/ParsedReaderResultTestCase.java
Patch:
@@ -181,8 +181,7 @@ public void testVCard() {
         ParsedResultType.ADDRESSBOOK);
     doTestResult("BEGIN:VCARD\r\nADR;HOME:123 Main St\r\nVERSION:2.1\r\nN:Owen;Sean\r\nEND:VCARD",
         "Sean Owen\n123 Main St", ParsedResultType.ADDRESSBOOK);
-    doTestResult("BEGIN:VCARD", "begin:VCARD",
-        ParsedResultType.URI); // yeah we end up guessing "URI" here
+    doTestResult("BEGIN:VCARD", "", ParsedResultType.ADDRESSBOOK);
   }
 
   public void testVEvent() {

File: android/src/com/google/zxing/client/android/PlanarYUV420LuminanceSource.java
Patch:
@@ -38,8 +38,9 @@ public Bitmap renderFullColorBitmap(boolean halfSize) {
     int width = getWidth();
     int height = getHeight();
     int dataWidth = getDataWidth();
+    int dataHeight = getDataHeight();
     byte[] yuv = getYUVData();
-    int expectedYBytes = width * height;
+    int expectedYBytes = dataWidth * dataHeight;
     int expectedUBytes = expectedYBytes >> 2;
     int expectedVBytes = expectedYBytes >> 2;
     int expectedBytes = expectedYBytes + expectedUBytes + expectedVBytes;

File: android/src/com/google/zxing/client/android/PlanarYUVLuminanceSource.java
Patch:
@@ -142,6 +142,6 @@ public Bitmap renderCroppedGreyscaleBitmap() {
   // Can't be implemented here, as the color representations vary.
   @Override
   public Bitmap renderFullColorBitmap(boolean halfSize) {
-    return null;
+    throw new UnsupportedOperationException();
   }
 }

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/EmailGenerator.java
Patch:
@@ -16,6 +16,7 @@
 
 package com.google.zxing.web.generator.client;
 
+import com.google.gwt.event.dom.client.KeyPressHandler;
 import com.google.gwt.user.client.ui.ChangeListener;
 import com.google.gwt.user.client.ui.Grid;
 import com.google.gwt.user.client.ui.TextBox;
@@ -30,9 +31,10 @@ public class EmailGenerator implements GeneratorSource {
   Grid table = null;
   TextBox email = new TextBox();
   
-  public EmailGenerator(ChangeListener listener) {
+  public EmailGenerator(ChangeListener listener, KeyPressHandler keyListener) {
     email.addStyleName(StylesDefs.INPUT_FIELD_REQUIRED);
     email.addChangeListener(listener);
+    email.addKeyPressHandler(keyListener);
   }
   
   public String getName() {

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/UrlGenerator.java
Patch:
@@ -16,6 +16,7 @@
 
 package com.google.zxing.web.generator.client;
 
+import com.google.gwt.event.dom.client.KeyPressHandler;
 import com.google.gwt.user.client.ui.ChangeListener;
 import com.google.gwt.user.client.ui.Grid;
 import com.google.gwt.user.client.ui.TextBox;
@@ -30,9 +31,10 @@ public class UrlGenerator implements GeneratorSource {
   Grid table = null;
   TextBox url = new TextBox();
   
-  public UrlGenerator(ChangeListener listener) {
+  public UrlGenerator(ChangeListener listener, KeyPressHandler keyListener) {
     url.addStyleName(StylesDefs.INPUT_FIELD_REQUIRED);
     url.addChangeListener(listener);
+    url.addKeyPressHandler(keyListener);
   }
   
   public Grid getWidget() {

File: javase/src/com/google/zxing/client/j2se/BufferedImageLuminanceSource.java
Patch:
@@ -110,7 +110,7 @@ public boolean isCropSupported() {
 
   @Override
   public LuminanceSource crop(int left, int top, int width, int height) {
-    return new BufferedImageLuminanceSource(image, left, top, width, height);
+    return new BufferedImageLuminanceSource(image, this.left + left, this.top + top, width, height);
   }
 
   // Can't run AffineTransforms on images of unknown format.

File: core/src/com/google/zxing/multi/GenericMultipleBarcodeReader.java
Patch:
@@ -129,12 +129,12 @@ private void doDecodeMultiple(BinaryBitmap image,
     }
     // Decode right of barcode
     if (maxX < width - MIN_DIMENSION_TO_RECUR) {
-      doDecodeMultiple(image.crop((int) maxX, 0, MIN_DIMENSION_TO_RECUR - (int) maxX, height),
+      doDecodeMultiple(image.crop((int) maxX, 0, width - (int) maxX, height),
                        hints, results, (int) maxX, 0);
     }
     // Decode below barcode
     if (maxY < height - MIN_DIMENSION_TO_RECUR) {
-      doDecodeMultiple(image.crop(0, (int) maxY, width, MIN_DIMENSION_TO_RECUR - (int) maxY),
+      doDecodeMultiple(image.crop(0, (int) maxY, width, height - (int) maxY),
                        hints, results, 0, (int) maxY);
     }
   }

File: androidtest/src/com/google/zxing/client/androidtest/CameraTestActivity.java
Patch:
@@ -69,7 +69,7 @@ public void onCreate(Bundle icicle) {
   protected void onResume() {
     super.onResume();
     if (mSaveThread == null && !mGetCameraParameters) {
-      mSaveThread = new SaveThread(this, CameraManager.get().getFramingRect());
+      mSaveThread = new SaveThread(this);
       mSaveThread.start();
     }
   }

File: androidtest/src/com/google/zxing/client/androidtest/CameraTestActivity.java
Patch:
@@ -30,14 +30,14 @@
 import android.widget.Toast;
 
 import java.io.File;
+import java.io.FileNotFoundException;
 import java.io.FileOutputStream;
 import java.io.IOException;
-import java.io.FileNotFoundException;
 
 public final class CameraTestActivity extends Activity implements SurfaceHolder.Callback {
 
   public static final String GET_CAMERA_PARAMETERS = "GET_CAMERA_PARAMETERS";
-  private static final String[] EMAIL_ADDRESS = {"zxing@googlegroups.com"};
+  private static final String[] EMAIL_ADDRESS = {"zxing-external@google.com"};
 
   private SaveThread mSaveThread = null;
   private boolean mGetCameraParameters;

File: android/src/com/google/zxing/client/android/CameraManager.java
Patch:
@@ -208,6 +208,9 @@ public void requestAutoFocus(Handler handler, int message) {
    */
   public Rect getFramingRect() {
     if (framingRect == null) {
+      if (camera == null) {
+        return null;
+      }
       int width = cameraResolution.x * 3 / 4;
       if (width < MIN_FRAME_WIDTH) {
         width = MIN_FRAME_WIDTH;

File: android/src/com/google/zxing/client/android/ViewfinderView.java
Patch:
@@ -62,6 +62,9 @@ public ViewfinderView(Context context, AttributeSet attrs) {
   @Override
   public void onDraw(Canvas canvas) {
     Rect frame = CameraManager.get().getFramingRect();
+    if (frame == null) {
+      return;
+    }
     int width = canvas.getWidth();
     int height = canvas.getHeight();
 

File: javase/src/com/google/zxing/client/j2se/BufferedImageLuminanceSource.java
Patch:
@@ -70,7 +70,7 @@ public byte[] getRow(int y, byte[] row) {
     if (rgbData == null || rgbData.length < width) {
       rgbData = new int[width];
     }
-    image.getRGB(left, top + y, width, 1, rgbData, 0, image.getWidth());
+    image.getRGB(left, top + y, width, 1, rgbData, 0, width);
     for (int x = 0; x < width; x++) {
       int pixel = rgbData[x];
       int luminance = (306 * ((pixel >> 16) & 0xFF) +
@@ -89,7 +89,7 @@ public byte[] getMatrix() {
     byte[] matrix = new byte[area];
 
     int[] rgb = new int[area];
-    image.getRGB(left, top, width, height, rgb, 0, image.getWidth());
+    image.getRGB(left, top, width, height, rgb, 0, width);
     for (int y = 0; y < height; y++) {
       int offset = y * width;
       for (int x = 0; x < width; x++) {

File: android/src/com/google/zxing/client/android/history/DBHelper.java
Patch:
@@ -25,7 +25,7 @@
  */
 final class DBHelper extends SQLiteOpenHelper {
 
-  private static final int DB_VERSION = 1;
+  private static final int DB_VERSION = 2;
   private static final String DB_NAME = "barcode_scanner_history.db";
   static final String TABLE_NAME = "history";
   static final String ID_COL = "id";

File: core/src/com/google/zxing/common/CharacterSetECI.java
Patch:
@@ -67,13 +67,13 @@ public String getEncodingName() {
 
   private static void addCharacterSet(int value, String encodingName) {
     CharacterSetECI eci = new CharacterSetECI(value, encodingName);
-    VALUE_TO_ECI.put(Integer.valueOf(value), eci);
+    VALUE_TO_ECI.put(new Integer(value), eci); // can't use valueOf
     NAME_TO_ECI.put(encodingName, eci);
   }
 
   private static void addCharacterSet(int value, String[] encodingNames) {
     CharacterSetECI eci = new CharacterSetECI(value, encodingNames[0]);
-    VALUE_TO_ECI.put(Integer.valueOf(value), eci);
+    VALUE_TO_ECI.put(new Integer(value), eci); // can't use valueOf
     for (int i = 0; i < encodingNames.length; i++) {
       NAME_TO_ECI.put(encodingNames[i], eci);
     }
@@ -92,7 +92,7 @@ public static CharacterSetECI getCharacterSetECIByValue(int value) {
     if (value < 0 || value >= 900) {
       throw new IllegalArgumentException("Bad ECI value: " + value);
     }
-    return (CharacterSetECI) VALUE_TO_ECI.get(Integer.valueOf(value));
+    return (CharacterSetECI) VALUE_TO_ECI.get(new Integer(value));
   }
 
   /**

File: core/src/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -42,7 +42,8 @@ public final class Detector {
   // Trick to avoid creating new Integer objects below -- a sort of crude copy of
   // the Integer.valueOf(int) optimization added in Java 5, not in J2ME
   private static final Integer[] INTEGERS =
-      { Integer.valueOf(0), Integer.valueOf(1), Integer.valueOf(2), Integer.valueOf(3), Integer.valueOf(4) };
+      { new Integer(0), new Integer(1), new Integer(2), new Integer(3), new Integer(4) };
+  // No, can't use valueOf()
 
   private final BitMatrix image;
   private final MonochromeRectangleDetector rectangleDetector;

File: core/src/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -492,13 +492,13 @@ private FinderPattern[] selectBestPatterns() throws ReaderException {
       // But we can only afford to do so if we have at least 4 possibilities to choose from
       float totalModuleSize = 0.0f;
       for (int i = 0; i < startSize; i++) {
-        totalModuleSize += ((FinderPattern) possibleCenters.get(i)).getEstimatedModuleSize();
+        totalModuleSize += ((FinderPattern) possibleCenters.elementAt(i)).getEstimatedModuleSize();
       }
       float average = totalModuleSize / (float) startSize;
       for (int i = 0; i < possibleCenters.size() && possibleCenters.size() > 3; i++) {
-        FinderPattern pattern = (FinderPattern) possibleCenters.get(i);
+        FinderPattern pattern = (FinderPattern) possibleCenters.elementAt(i);
         if (Math.abs(pattern.getEstimatedModuleSize() - average) > 0.2f * average) {
-          possibleCenters.remove(i);
+          possibleCenters.removeElementAt(i);
           i--;
         }
       }

File: android/src/com/google/zxing/client/android/share/BookmarkPickerActivity.java
Patch:
@@ -16,6 +16,8 @@
 
 package com.google.zxing.client.android.share;
 
+import com.google.zxing.client.android.R;
+
 import android.app.ListActivity;
 import android.content.Intent;
 import android.database.Cursor;
@@ -25,15 +27,14 @@
 import android.widget.ListAdapter;
 import android.widget.ListView;
 import android.widget.SimpleCursorAdapter;
-import com.google.zxing.client.android.R;
 
 /**
  * This class is only needed because I can't successfully send an ACTION_PICK intent to
  * com.android.browser.BrowserBookmarksPage. It can go away if that starts working in the future.
  *
  * @author dswitkin@google.com (Daniel Switkin)
  */
-final class BookmarkPickerActivity extends ListActivity {
+public final class BookmarkPickerActivity extends ListActivity {
   private static final String[] BOOKMARK_PROJECTION = {
       Browser.BookmarkColumns.TITLE,
       Browser.BookmarkColumns.URL

File: core/src/com/google/zxing/oned/EAN13Reader.java
Patch:
@@ -58,7 +58,7 @@ public final class EAN13Reader extends AbstractUPCEANReader {
   // in binary:
   //                0    1    1   0   0    1   == 0x19
   //
-  public static final int[] FIRST_DIGIT_ENCODINGS = {
+  static final int[] FIRST_DIGIT_ENCODINGS = {
       0x00, 0x0B, 0x0D, 0xE, 0x13, 0x19, 0x1C, 0x15, 0x16, 0x1A
   };
 

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -41,8 +41,8 @@ public final class PreferencesActivity extends PreferenceActivity
 
   static final String KEY_HELP_VERSION_SHOWN = "preferences_help_version_shown";
 
-  CheckBoxPreference decode1D;
-  CheckBoxPreference decodeQR;
+  private CheckBoxPreference decode1D;
+  private CheckBoxPreference decodeQR;
 
   @Override
   protected void onCreate(Bundle icicle) {

File: core/src/com/google/zxing/LuminanceSource.java
Patch:
@@ -38,7 +38,7 @@ protected LuminanceSource(int width, int height) {
   /**
    * Fetches one row of luminance data from the underlying platform's bitmap. Values range from
    * 0 (black) to 255 (white). Because Java does not have an unsigned byte type, callers will have
-   * to bitwise and with 0xff for each value. It is preferrable for implementations of this method
+   * to bitwise and with 0xff for each value. It is preferable for implementations of this method
    * to only fetch this row rather than the whole image, since no 2D Readers may be installed and
    * getMatrix() may never be called.
    *

File: core/src/com/google/zxing/Reader.java
Patch:
@@ -46,7 +46,8 @@ public interface Reader {
    * hints, each possibly associated to some data, which may help the implementation decode.
    *
    * @param image image of barcode to decode
-   * @param hints passed as a {@link java.util.Hashtable} from {@link com.google.zxing.DecodeHintType} to aribtrary data. The
+   * @param hints passed as a {@link java.util.Hashtable} from {@link com.google.zxing.DecodeHintType}
+   * to arbitrary data. The
    * meaning of the data depends upon the hint type. The implementation may or may not do
    * anything with these hints.
    * @return String which the barcode encodes

File: core/src/com/google/zxing/ResultPoint.java
Patch:
@@ -117,7 +117,7 @@ public static float distance(ResultPoint pattern1, ResultPoint pattern2) {
   /**
    * Returns the z component of the cross product between vectors BC and BA.
    */
-  public static float crossProductZ(ResultPoint pointA, ResultPoint pointB, ResultPoint pointC) {
+  private static float crossProductZ(ResultPoint pointA, ResultPoint pointB, ResultPoint pointC) {
     float bX = pointB.x;
     float bY = pointB.y;
     return ((pointC.x - bX) * (pointA.y - bY)) - ((pointC.y - bY) * (pointA.x - bX));

File: core/src/com/google/zxing/client/result/GeoResultParser.java
Patch:
@@ -19,7 +19,7 @@
 import com.google.zxing.Result;
 
 /**
- * Parses a "geo:" URI result, which specifices a location on the surface of
+ * Parses a "geo:" URI result, which specifies a location on the surface of
  * the Earth as well as an optional altitude above the surface. See
  * <a href="http://tools.ietf.org/html/draft-mayrhofer-geo-uri-00">
  * http://tools.ietf.org/html/draft-mayrhofer-geo-uri-00</a>.

File: core/src/com/google/zxing/client/result/ProductResultParser.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.zxing.oned.UPCEReader;
 
 /**
- * Parses strings of digits that repesent a UPC code.
+ * Parses strings of digits that represent a UPC code.
  * 
  * @author dswitkin@google.com (Daniel Switkin)
  */

File: core/src/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -117,7 +117,7 @@ protected static String unescapeBackslash(String escaped) {
     return escaped;
   }
 
-  static String urlDecode(String escaped) {
+  private static String urlDecode(String escaped) {
 
     // No we can't use java.net.URLDecoder here. JavaME doesn't have it.
     if (escaped == null) {

File: core/src/com/google/zxing/common/GridSampler.java
Patch:
@@ -75,7 +75,7 @@ public static GridSampler getInstance() {
    * <p>These 16 parameters define the transformation needed to sample the image.</p>
    *
    * @param image image to sample
-   * @param dimension width/height of {@link BitMatrix} to sample from iamge
+   * @param dimension width/height of {@link BitMatrix} to sample from image
    * @return {@link BitMatrix} representing a grid of points sampled from the image within a region
    *   defined by the "from" parameters
    * @throws ReaderException if image can't be sampled, for example, if the transformation defined

File: core/src/com/google/zxing/common/LocalBlockBinarizer.java
Patch:
@@ -77,7 +77,7 @@ private void binarizeEntireImage() {
 
   // For each 8x8 block in the image, calculate the average black point using a 5x5 grid
   // of the blocks around it. Also handles the corner cases, but will ignore up to 7 pixels
-  // on the right edge and 7 pixels at the bottom of the image if the overall dimsions are not
+  // on the right edge and 7 pixels at the bottom of the image if the overall dimensions are not
   // multiples of eight. In practice, leaving those pixels white does not seem to be a problem.
   private static void calculateThresholdForBlock(byte[] luminances, int subWidth, int subHeight,
       int stride, int[][] blackPoints, BitMatrix matrix) {

File: core/src/com/google/zxing/common/detector/MonochromeRectangleDetector.java
Patch:
@@ -149,7 +149,7 @@ private ResultPoint findCornerFromCenter(int centerX, int deltaX, int left, int
    * be part of a Data Matrix barcode.
    *
    * @param fixedDimension if scanning horizontally, this is the row (the fixed vertical location)
-   *  where we are scanning. If scanning vertically it's the colummn, the fixed horizontal location
+   *  where we are scanning. If scanning vertically it's the column, the fixed horizontal location
    * @param maxWhiteRun largest run of white pixels that can still be considered part of the
    *  barcode region
    * @param minDim minimum pixel location, horizontally or vertically, to consider

File: core/src/com/google/zxing/datamatrix/decoder/BitMatrixParser.java
Patch:
@@ -170,7 +170,7 @@ boolean readModule(int row, int column, int numRows, int numColumns) {
   }
   
   /**
-   * <p>Reads the 8 bits of the standard utah shaped pattern.</p>
+   * <p>Reads the 8 bits of the standard Utah-shaped pattern.</p>
    * 
    * <p>See ISO 16022:2006, 5.8.1 Figure 6</p>
    * 

File: core/src/com/google/zxing/oned/AbstractUPCEANReader.java
Patch:
@@ -160,7 +160,7 @@ boolean checkChecksum(String s) throws ReaderException {
    * @return true iff string of digits passes the UPC/EAN checksum algorithm
    * @throws ReaderException if the string does not contain only digits
    */
-  public static boolean checkStandardUPCEANChecksum(String s) throws ReaderException {
+  private static boolean checkStandardUPCEANChecksum(String s) throws ReaderException {
     int length = s.length();
     if (length == 0) {
       return false;

File: core/src/com/google/zxing/oned/AbstractUPCEANWriter.java
Patch:
@@ -51,7 +51,7 @@ public ByteMatrix encode(String contents, BarcodeFormat format, int width, int h
   }
 
   /** @return a byte array of horizontal pixels (0 = white, 1 = black) */
-  protected static ByteMatrix renderResult(byte[] code, int width, int height) {
+  private static ByteMatrix renderResult(byte[] code, int width, int height) {
     int inputWidth = code.length;
     // Add quiet zone on both sides
     int fullWidth = inputWidth + (AbstractUPCEANReader.START_END_PATTERN.length << 1);

File: core/src/com/google/zxing/pdf417/decoder/Decoder.java
Patch:
@@ -93,7 +93,7 @@ public DecoderResult decode(BitMatrix bits) throws ReaderException {
    * @return an index to the first data codeword.
    * @throws ReaderException
    */
-  private static int verifyCodewordCount(int[] codewords, int numECCodewords) throws ReaderException {
+  private static void verifyCodewordCount(int[] codewords, int numECCodewords) throws ReaderException {
     if (codewords.length < 4) {
       // Codeword array size should be at least 4 allowing for
       // Count CW, At least one Data CW, Error Correction CW, Error Correction CW
@@ -114,7 +114,6 @@ private static int verifyCodewordCount(int[] codewords, int numECCodewords) thro
         throw ReaderException.getInstance();
       }
     }
-    return 1; // Index to first data codeword
   }
 
   /**

File: core/src/com/google/zxing/qrcode/QRCodeWriter.java
Patch:
@@ -83,7 +83,7 @@ private static ByteMatrix renderResult(QRCode code, int width, int height) {
     int outputHeight = Math.max(height, qrHeight);
 
     int multiple = Math.min(outputWidth / qrWidth, outputHeight / qrHeight);
-    // Padding includes both the quiet zone and the extra white pixels to accomodate the requested
+    // Padding includes both the quiet zone and the extra white pixels to accommodate the requested
     // dimensions. For example, if input is 25x25 the QR will be 33x33 including the quiet zone.
     // If the requested size is 200x160, the multiple will be 4, for a QR of 132x132. These will
     // handle all the padding from 100x100 (the actual QR) up to 200x160.

File: core/src/com/google/zxing/qrcode/detector/Detector.java
Patch:
@@ -319,7 +319,7 @@ private float sizeOfBlackWhiteBlackRun(int fromX, int fromY, int toX, int toY) {
    * @param overallEstModuleSize estimated module size so far
    * @param estAlignmentX x coordinate of center of area probably containing alignment pattern
    * @param estAlignmentY y coordinate of above
-   * @param allowanceFactor number of pixels in all directons to search from the center
+   * @param allowanceFactor number of pixels in all directions to search from the center
    * @return {@link AlignmentPattern} if found, or null otherwise
    * @throws ReaderException if an unexpected error occurs during detection
    */

File: core/src/com/google/zxing/qrcode/encoder/Encoder.java
Patch:
@@ -558,7 +558,7 @@ static void appendKanjiBytes(String content, BitVector bits) throws WriterExcept
     }
   }
 
-  static void appendECI(CharacterSetECI eci, BitVector bits) {
+  private static void appendECI(CharacterSetECI eci, BitVector bits) {
     bits.appendBits(Mode.ECI.getBits(), 4);
     // This is correct for values up to 127, which is all we need now.
     bits.appendBits(eci.getValue(), 8);

File: core/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -264,7 +264,7 @@ private static String guessEncoding(byte[] bytes) {
     boolean lastWasPossibleDoubleByteStart = false;
     for (int i = 0; i < length && (canBeISO88591 || canBeShiftJIS); i++) {
       int value = bytes[i] & 0xFF;
-      if (value == 0xC2 || value == 0xC3 && i < length - 1) {
+      if ((value == 0xC2 || value == 0xC3) && i < length - 1) {
         // This is really a poor hack. The slightly more exotic characters people might want to put in
         // a QR Code, by which I mean the Latin-1 supplement characters (e.g. u-umlaut) have encodings
         // that start with 0xC2 followed by [0xA0,0xBF], or start with 0xC3 followed by [0x80,0xBF].

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -28,9 +28,9 @@ public final class QRCodeBlackBox2TestCase extends AbstractBlackBoxTestCase {
   public QRCodeBlackBox2TestCase() {
     super("test/data/blackbox/qrcode-2", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(23, 23, 0.0f);
-    addTest(20, 20, 90.0f);
-    addTest(21, 21, 180.0f);
-    addTest(19, 19, 270.0f);
+    addTest(21, 21, 90.0f);
+    addTest(20, 20, 180.0f);
+    addTest(18, 18, 270.0f);
   }
 
 }
\ No newline at end of file

File: core/src/com/google/zxing/common/CharacterSetECI.java
Patch:
@@ -67,13 +67,13 @@ public String getEncodingName() {
 
   private static void addCharacterSet(int value, String encodingName) {
     CharacterSetECI eci = new CharacterSetECI(value, encodingName);
-    VALUE_TO_ECI.put(new Integer(value), eci);
+    VALUE_TO_ECI.put(Integer.valueOf(value), eci);
     NAME_TO_ECI.put(encodingName, eci);
   }
 
   private static void addCharacterSet(int value, String[] encodingNames) {
     CharacterSetECI eci = new CharacterSetECI(value, encodingNames[0]);
-    VALUE_TO_ECI.put(new Integer(value), eci);
+    VALUE_TO_ECI.put(Integer.valueOf(value), eci);
     for (int i = 0; i < encodingNames.length; i++) {
       NAME_TO_ECI.put(encodingNames[i], eci);
     }
@@ -92,7 +92,7 @@ public static CharacterSetECI getCharacterSetECIByValue(int value) {
     if (value < 0 || value >= 900) {
       throw new IllegalArgumentException("Bad ECI value: " + value);
     }
-    return (CharacterSetECI) VALUE_TO_ECI.get(new Integer(value));
+    return (CharacterSetECI) VALUE_TO_ECI.get(Integer.valueOf(value));
   }
 
   /**

File: core/src/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -42,7 +42,7 @@ public final class Detector {
   // Trick to avoid creating new Integer objects below -- a sort of crude copy of
   // the Integer.valueOf(int) optimization added in Java 5, not in J2ME
   private static final Integer[] INTEGERS =
-      { new Integer(0), new Integer(1), new Integer(2), new Integer(3), new Integer(4) };
+      { Integer.valueOf(0), Integer.valueOf(1), Integer.valueOf(2), Integer.valueOf(3), Integer.valueOf(4) };
 
   private final BitMatrix image;
   private final MonochromeRectangleDetector rectangleDetector;

File: android/src/com/google/zxing/client/android/CameraManager.java
Patch:
@@ -205,8 +205,9 @@ private void setCameraParameters() {
     Camera.Parameters parameters = mCamera.getParameters();
     parameters.setPreviewSize(mScreenResolution.x, mScreenResolution.y);
 
-    // Disables the built-in flash if present. Hopefully devices will honor this setting.
-    parameters.set("flash-mode", "off");
+    // FIXME: This is a hack to turn the flash off on the Samsung Galaxy. In the future there
+    // will hopefully be a standard setting like "off" that all devices will honor.
+    parameters.set("flash-mode", "2");
     mCamera.setParameters(parameters);
     Log.v(TAG, "Setting params for preview: width " + mScreenResolution.x + " height " +
         mScreenResolution.y);

File: javase/src/com/google/zxing/client/j2se/MatrixToImageWriter.java
Patch:
@@ -33,8 +33,8 @@
  */
 public final class MatrixToImageWriter {
 
-  private static final int BLACK = 0x00000000;
-  private static final int WHITE = 0x00FFFFFF;
+  private static final int BLACK = 0xFF000000;
+  private static final int WHITE = 0xFFFFFFFF;
 
   private MatrixToImageWriter() {}
 

File: core/src/com/google/zxing/oned/EAN8Reader.java
Patch:
@@ -33,7 +33,8 @@ public EAN8Reader() {
     decodeMiddleCounters = new int[4];
   }
 
-  protected int decodeMiddle(BitArray row, int[] startRange, StringBuffer result) throws ReaderException {
+  protected int decodeMiddle(BitArray row, int[] startRange, StringBuffer result)
+      throws ReaderException {
     int[] counters = decodeMiddleCounters;
     counters[0] = 0;
     counters[1] = 0;

File: core/src/com/google/zxing/datamatrix/DataMatrixReader.java
Patch:
@@ -70,6 +70,9 @@ public Result decode(BinaryBitmap image, Hashtable hints)
     if (decoderResult.getByteSegments() != null) {
       result.putMetadata(ResultMetadataType.BYTE_SEGMENTS, decoderResult.getByteSegments());
     }
+    if (decoderResult.getECLevel() != null) {
+      result.putMetadata(ResultMetadataType.ERROR_CORRECTION_LEVEL, decoderResult.getECLevel().toString());
+    }
     return result;
   }
 

File: core/src/com/google/zxing/datamatrix/decoder/DecodedBitStreamParser.java
Patch:
@@ -110,7 +110,7 @@ static DecoderResult decode(byte[] bytes) throws ReaderException {
     if (resultTrailer.length() > 0) {
       result.append(resultTrailer.toString());
     }
-    return new DecoderResult(bytes, result.toString(), byteSegments.isEmpty() ? null : byteSegments);
+    return new DecoderResult(bytes, result.toString(), byteSegments.isEmpty() ? null : byteSegments, null);
   }
   
   /**

File: core/src/com/google/zxing/multi/qrcode/QRCodeMultiReader.java
Patch:
@@ -57,6 +57,9 @@ public Result[] decodeMultiple(BinaryBitmap image, Hashtable hints) throws Reade
         if (decoderResult.getByteSegments() != null) {
           result.putMetadata(ResultMetadataType.BYTE_SEGMENTS, decoderResult.getByteSegments());
         }
+        if (decoderResult.getECLevel() != null) {
+          result.putMetadata(ResultMetadataType.ERROR_CORRECTION_LEVEL, decoderResult.getECLevel().toString());
+        }
         results.addElement(result);
       } catch (ReaderException re) {
         // ignore and continue 

File: core/src/com/google/zxing/pdf417/decoder/DecodedBitStreamParser.java
Patch:
@@ -123,7 +123,7 @@ static DecoderResult decode(int[] codewords) throws ReaderException {
         throw ReaderException.getInstance();
       }
     }
-    return new DecoderResult(null, result.toString(), null);
+    return new DecoderResult(null, result.toString(), null, null);
   }
 
   /**

File: core/src/com/google/zxing/qrcode/QRCodeReader.java
Patch:
@@ -75,6 +75,9 @@ public Result decode(BinaryBitmap image, Hashtable hints)
     if (decoderResult.getByteSegments() != null) {
       result.putMetadata(ResultMetadataType.BYTE_SEGMENTS, decoderResult.getByteSegments());
     }
+    if (decoderResult.getECLevel() != null) {
+      result.putMetadata(ResultMetadataType.ERROR_CORRECTION_LEVEL, decoderResult.getECLevel().toString());
+    }
     return result;
   }
 

File: core/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -57,7 +57,7 @@ final class DecodedBitStreamParser {
   private DecodedBitStreamParser() {
   }
 
-  static DecoderResult decode(byte[] bytes, Version version) throws ReaderException {
+  static DecoderResult decode(byte[] bytes, Version version, ErrorCorrectionLevel ecLevel) throws ReaderException {
     BitSource bits = new BitSource(bytes);
     StringBuffer result = new StringBuffer();
     CharacterSetECI currentCharacterSetECI = null;
@@ -109,7 +109,7 @@ static DecoderResult decode(byte[] bytes, Version version) throws ReaderExceptio
       }
     } while (!mode.equals(Mode.TERMINATOR));
 
-    return new DecoderResult(bytes, result.toString(), byteSegments.isEmpty() ? null : byteSegments);
+    return new DecoderResult(bytes, result.toString(), byteSegments.isEmpty() ? null : byteSegments, ecLevel);
   }
 
   private static void decodeKanjiSegment(BitSource bits,

File: core/src/com/google/zxing/qrcode/decoder/Decoder.java
Patch:
@@ -97,7 +97,7 @@ public DecoderResult decode(BitMatrix bits) throws ReaderException {
     }
 
     // Decode the contents of that stream of bytes
-    return DecodedBitStreamParser.decode(resultBytes, version);
+    return DecodedBitStreamParser.decode(resultBytes, version, ecLevel);
   }
 
   /**

File: core/test/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParserTestCase.java
Patch:
@@ -35,7 +35,7 @@ public void testSimpleByteMode() throws ReaderException {
     builder.write(0xF2, 8);
     builder.write(0xF3, 8);
     String result = DecodedBitStreamParser.decode(builder.toByteArray(),
-        Version.getVersionForNumber(1)).getText();
+        Version.getVersionForNumber(1), null).getText();
     assertEquals("\u00f1\u00f2\u00f3", result);
   }
 
@@ -47,7 +47,7 @@ public void testSimpleSJIS() throws ReaderException {
     builder.write(0xA2, 8);
     builder.write(0xA3, 8);
     String result = DecodedBitStreamParser.decode(builder.toByteArray(),
-        Version.getVersionForNumber(1)).getText();
+        Version.getVersionForNumber(1), null).getText();
     assertEquals("\uff61\uff62\uff63", result);
   }
 
@@ -61,7 +61,7 @@ public void testECI() throws ReaderException {
     builder.write(0xA2, 8);
     builder.write(0xA3, 8);
     String result = DecodedBitStreamParser.decode(builder.toByteArray(),
-        Version.getVersionForNumber(1)).getText();
+        Version.getVersionForNumber(1), null).getText();
     assertEquals("\u00ed\u00f3\u00fa", result);
   }
 

File: core/src/com/google/zxing/qrcode/decoder/Version.java
Patch:
@@ -189,12 +189,12 @@ public static final class ECBlocks {
     private final int ecCodewordsPerBlock;
     private final ECB[] ecBlocks;
 
-    private ECBlocks(int ecCodewordsPerBlock, ECB ecBlocks) {
+    ECBlocks(int ecCodewordsPerBlock, ECB ecBlocks) {
       this.ecCodewordsPerBlock = ecCodewordsPerBlock;
       this.ecBlocks = new ECB[]{ecBlocks};
     }
 
-    private ECBlocks(int ecCodewordsPerBlock, ECB ecBlocks1, ECB ecBlocks2) {
+    ECBlocks(int ecCodewordsPerBlock, ECB ecBlocks1, ECB ecBlocks2) {
       this.ecCodewordsPerBlock = ecCodewordsPerBlock;
       this.ecBlocks = new ECB[]{ecBlocks1, ecBlocks2};
     }

File: android/src/com/google/zxing/client/android/CameraManager.java
Patch:
@@ -204,6 +204,9 @@ public void onAutoFocus(boolean success, Camera camera) {
   private void setCameraParameters() {
     Camera.Parameters parameters = mCamera.getParameters();
     parameters.setPreviewSize(mScreenResolution.x, mScreenResolution.y);
+
+    // Disables the built-in flash if present. Hopefully devices will honor this setting.
+    parameters.set("flash-mode", "off");
     mCamera.setParameters(parameters);
     Log.v(TAG, "Setting params for preview: width " + mScreenResolution.x + " height " +
         mScreenResolution.y);

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox1TestCase.java
Patch:
@@ -29,8 +29,8 @@ public QRCodeBlackBox1TestCase() {
     super("test/data/blackbox/qrcode-1", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(19, 19, 0.0f);
     addTest(15, 15, 90.0f);
-    addTest(16, 16, 180.0f);
-    addTest(13, 14, 270.0f);
+    addTest(17, 17, 180.0f);
+    addTest(14, 14, 270.0f);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox3TestCase.java
Patch:
@@ -29,8 +29,8 @@ public QRCodeBlackBox3TestCase() {
     super("test/data/blackbox/qrcode-3", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(33, 33, 0.0f);
     addTest(33, 33, 90.0f);
-    addTest(32, 32, 180.0f);
-    addTest(34, 34, 270.0f);
+    addTest(33, 33, 180.0f);
+    addTest(35, 35, 270.0f);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox1TestCase.java
Patch:
@@ -33,7 +33,7 @@ public final class PDF417BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox1TestCase() {
     super("test/data/blackbox/pdf417", new MultiFormatReader(), BarcodeFormat.PDF417);
-    addTest(2, 2, 0.0f);
+    addTest(3, 3, 0.0f);
     //addTest(1, 1, 90.0f);
     //addTest(1, 1, 180.0f);
     //addTest(1, 1, 270.0f);

File: core/test/src/com/google/zxing/pdf417/PDF417BlackBox2TestCase.java
Patch:
@@ -33,7 +33,7 @@ public final class PDF417BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public PDF417BlackBox2TestCase() {
     super("test/data/blackbox/pdf417-2", new MultiFormatReader(), BarcodeFormat.PDF417);
-    addTest(0, 0, 0.0f);
+    addTest(8, 8, 0.0f);
     //addTest(1, 1, 90.0f);
     //addTest(1, 1, 180.0f);
     //addTest(1, 1, 270.0f);

File: core/test/src/com/google/zxing/AllPositiveBlackBoxTester.java
Patch:
@@ -39,6 +39,7 @@
 import com.google.zxing.oned.UPCEBlackBox1TestCase;
 import com.google.zxing.oned.UPCEBlackBox2TestCase;
 import com.google.zxing.oned.UPCEBlackBox3ReflectiveTestCase;
+import com.google.zxing.pdf417.PDF417BlackBox1TestCase;
 import com.google.zxing.qrcode.QRCodeBlackBox1TestCase;
 import com.google.zxing.qrcode.QRCodeBlackBox2TestCase;
 import com.google.zxing.qrcode.QRCodeBlackBox3TestCase;
@@ -81,6 +82,7 @@ public final class AllPositiveBlackBoxTester {
     new UPCEBlackBox1TestCase(),
     new UPCEBlackBox2TestCase(),
     new UPCEBlackBox3ReflectiveTestCase(),
+    new PDF417BlackBox1TestCase(),
     new QRCodeBlackBox1TestCase(),
     new QRCodeBlackBox2TestCase(),
     new QRCodeBlackBox3TestCase(),
@@ -156,7 +158,7 @@ public static void main(String[] args) throws Exception {
     AbstractBlackBoxTestCase.SummaryResults results = new AbstractBlackBoxTestCase.SummaryResults();
 
     for (int x = 0; x < TESTS.length; x++) {
-      results.add(TESTS[x].testBlackBoxCountingResults());
+      results.add(TESTS[x].testBlackBoxCountingResults(false));
     }
 
     // This threaded version can't be used yet because BlackPointEstimator (and possibly other code)

File: androidtest/src/com/google/zxing/client/androidtest/RGBLuminanceSource.java
Patch:
@@ -49,7 +49,7 @@ public RGBLuminanceSource(Bitmap bitmap) {
     // up front, which is the same as the Y channel of the YUVLuminanceSource in the real app.
     luminances = new byte[width * height];
     for (int y = 0; y < height; y++) {
-      int offset = y * height;
+      int offset = y * width;
       for (int x = 0; x < width; x++) {
         int pixel = pixels[offset + x];
         int r = (pixel >> 16) & 0xff;

File: javame/src/com/google/zxing/client/j2me/LCDUIImageLuminanceSource.java
Patch:
@@ -18,6 +18,8 @@
 
 import com.google.zxing.LuminanceSource;
 
+import javax.microedition.lcdui.Image;
+
 /**
  * A LuminanceSource based on Java ME's Image class. It does not support cropping or rotation.
  *

File: core/src/com/google/zxing/DecodeHintType.java
Patch:
@@ -23,7 +23,7 @@
  *
  * @author Sean Owen
  * @author dswitkin@google.com (Daniel Switkin)
- * @see Reader#decode(MonochromeBitmapSource, java.util.Hashtable)
+ * @see Reader#decode(BinaryBitmap,java.util.Hashtable)
  */
 public final class DecodeHintType {
 

File: core/src/com/google/zxing/Reader.java
Patch:
@@ -39,19 +39,19 @@ public interface Reader {
    * @return String which the barcode encodes
    * @throws ReaderException if the barcode cannot be located or decoded for any reason
    */
-  Result decode(MonochromeBitmapSource image) throws ReaderException;
+  Result decode(BinaryBitmap image) throws ReaderException;
 
   /**
    * Locates and decodes a barcode in some format within an image. This method also accepts
    * hints, each possibly associated to some data, which may help the implementation decode.
    *
    * @param image image of barcode to decode
-   * @param hints passed as a {@link Hashtable} from {@link DecodeHintType} to aribtrary data. The
+   * @param hints passed as a {@link java.util.Hashtable} from {@link com.google.zxing.DecodeHintType} to aribtrary data. The
    * meaning of the data depends upon the hint type. The implementation may or may not do
    * anything with these hints.
    * @return String which the barcode encodes
    * @throws ReaderException if the barcode cannot be located or decoded for any reason
    */
-  Result decode(MonochromeBitmapSource image, Hashtable hints) throws ReaderException;
+  Result decode(BinaryBitmap image, Hashtable hints) throws ReaderException;
 
 }
\ No newline at end of file

File: core/src/com/google/zxing/common/DefaultGridSampler.java
Patch:
@@ -16,15 +16,15 @@
 
 package com.google.zxing.common;
 
-import com.google.zxing.MonochromeBitmapSource;
 import com.google.zxing.ReaderException;
+import com.google.zxing.BinaryBitmap;
 
 /**
  * @author Sean Owen
  */
 public final class DefaultGridSampler extends GridSampler {
 
-  public BitMatrix sampleGrid(MonochromeBitmapSource image,
+  public BitMatrix sampleGrid(BinaryBitmap image,
                               int dimension,
                               float p1ToX, float p1ToY,
                               float p2ToX, float p2ToY,

File: core/src/com/google/zxing/common/GridSampler.java
Patch:
@@ -16,7 +16,7 @@
 
 package com.google.zxing.common;
 
-import com.google.zxing.MonochromeBitmapSource;
+import com.google.zxing.BinaryBitmap;
 import com.google.zxing.ReaderException;
 
 /**
@@ -82,7 +82,7 @@ public static GridSampler getInstance() {
    * @throws ReaderException if image can't be sampled, for example, if the transformation defined
    *   by the given points is invalid or results in sampling outside the image boundaries
    */
-  public abstract BitMatrix sampleGrid(MonochromeBitmapSource image,
+  public abstract BitMatrix sampleGrid(BinaryBitmap image,
                                        int dimension,
                                        float p1ToX, float p1ToY,
                                        float p2ToX, float p2ToY,
@@ -108,7 +108,7 @@ public abstract BitMatrix sampleGrid(MonochromeBitmapSource image,
    * @param points actual points in x1,y1,...,xn,yn form
    * @throws ReaderException if an endpoint is lies outside the image boundaries
    */
-  protected static void checkAndNudgePoints(MonochromeBitmapSource image, float[] points)
+  protected static void checkAndNudgePoints(BinaryBitmap image, float[] points)
       throws ReaderException {
     int width = image.getWidth();
     int height = image.getHeight();

File: core/src/com/google/zxing/multi/MultipleBarcodeReader.java
Patch:
@@ -17,7 +17,7 @@
 package com.google.zxing.multi;
 
 import com.google.zxing.Result;
-import com.google.zxing.MonochromeBitmapSource;
+import com.google.zxing.BinaryBitmap;
 import com.google.zxing.ReaderException;
 
 import java.util.Hashtable;
@@ -30,8 +30,8 @@
  */
 public interface MultipleBarcodeReader {
 
-  Result[] decodeMultiple(MonochromeBitmapSource image) throws ReaderException;
+  Result[] decodeMultiple(BinaryBitmap image) throws ReaderException;
 
-  Result[] decodeMultiple(MonochromeBitmapSource image, Hashtable hints) throws ReaderException;
+  Result[] decodeMultiple(BinaryBitmap image, Hashtable hints) throws ReaderException;
 
 }

File: core/src/com/google/zxing/oned/UPCAReader.java
Patch:
@@ -17,9 +17,9 @@
 package com.google.zxing.oned;
 
 import com.google.zxing.BarcodeFormat;
-import com.google.zxing.MonochromeBitmapSource;
 import com.google.zxing.ReaderException;
 import com.google.zxing.Result;
+import com.google.zxing.BinaryBitmap;
 import com.google.zxing.common.BitArray;
 
 import java.util.Hashtable;
@@ -42,11 +42,11 @@ public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws Rea
     return maybeReturnResult(ean13Reader.decodeRow(rowNumber, row, hints));
   }
 
-  public Result decode(MonochromeBitmapSource image) throws ReaderException {
+  public Result decode(BinaryBitmap image) throws ReaderException {
     return maybeReturnResult(ean13Reader.decode(image));
   }
 
-  public Result decode(MonochromeBitmapSource image, Hashtable hints) throws ReaderException {
+  public Result decode(BinaryBitmap image, Hashtable hints) throws ReaderException {
     return maybeReturnResult(ean13Reader.decode(image, hints));
   }
 

File: core/src/com/google/zxing/pdf417/decoder/BitMatrixParser.java
Patch:
@@ -89,14 +89,14 @@ int[] readCodewords() throws ReaderException {
       for (int j = 0; j < width; j++) {
         // Accumulate differences between this line and the
         // previous line.
-        if (bitMatrix.get(i, j) != bitMatrix.get(i - 1, j)) {
+        if (bitMatrix.get(j, i) != bitMatrix.get(j, i - 1)) {
           rowDifference++;
         }
       }
       if (rowDifference <= moduleWidth * MAX_ROW_DIFFERENCE) {
         for (int j = 0; j < width; j++) {
           // Accumulate the black pixels on this line
-          if (bitMatrix.get(i, j)) {
+          if (bitMatrix.get(j, i)) {
             rowCounters[j]++;
           }
         }

File: core/src/com/google/zxing/pdf417/decoder/Decoder.java
Patch:
@@ -51,8 +51,8 @@ public DecoderResult decode(boolean[][] image) throws ReaderException {
     BitMatrix bits = new BitMatrix(dimension);
     for (int i = 0; i < dimension; i++) {
       for (int j = 0; j < dimension; j++) {
-        if (image[i][j]) {
-          bits.set(i, j);
+        if (image[j][i]) {
+          bits.set(j, i);
         }
       }
     }

File: core/src/com/google/zxing/oned/AbstractOneDReader.java
Patch:
@@ -112,7 +112,7 @@ private Result doDecode(MonochromeBitmapSource image, Hashtable hints) throws Re
       } catch (ReaderException re) {
         continue;
       }
-      image.getBlackRow(rowNumber, row, 0, width);
+      row = image.getBlackRow(rowNumber, row, 0, width);
 
       // While we have the image data in a BitArray, it's fairly cheap to reverse it in place to
       // handle decoding upside down barcodes.

File: core/src/com/google/zxing/qrcode/detector/AlignmentPatternFinder.java
Patch:
@@ -92,7 +92,7 @@ AlignmentPattern find() throws ReaderException {
     for (int iGen = 0; iGen < height; iGen++) {
       // Search from middle outwards
       int i = middleI + ((iGen & 0x01) == 0 ? ((iGen + 1) >> 1) : -((iGen + 1) >> 1));
-      image.getBlackRow(i, luminanceRow, startX, width);
+      luminanceRow = image.getBlackRow(i, luminanceRow, startX, width);
       stateCount[0] = 0;
       stateCount[1] = 0;
       stateCount[2] = 0;

File: core/src/com/google/zxing/BarcodeFormat.java
Patch:
@@ -52,6 +52,9 @@ public final class BarcodeFormat {
   /** ITF (Interleaved Two of Five) 1D format. */
   public static final BarcodeFormat ITF = new BarcodeFormat("ITF");
 
+  /** PDF417 format. */
+  public static final BarcodeFormat PDF417 = new BarcodeFormat("PDF417");
+  
   private final String name;
 
   private BarcodeFormat(String name) {

File: core/src/com/google/zxing/common/BitSource.java
Patch:
@@ -20,7 +20,8 @@
  * <p>This provides an easy abstraction to read bits at a time from a sequence of bytes, where the
  * number of bits read is not often a multiple of 8.</p>
  *
- * <p>This class is not thread-safe.</p>
+ * <p>This class is thread-safe but not reentrant. Unless the caller modifies the bytes array
+ * it passed in, in which case all bets are off.</p>
  *
  * @author Sean Owen
  */

File: core/src/com/google/zxing/common/BlackPointEstimator.java
Patch:
@@ -27,7 +27,7 @@
  * <p>For an interesting discussion of this issue, see
  * <a href="http://webdiis.unizar.es/~neira/12082/thresholding.pdf">this paper</a>.</p>
  *
- * NOTE: This class is not threadsafe.
+ * NOTE: This class is not thread-safe.
  *
  * @author Sean Owen
  * @author dswitkin@google.com (Daniel Switkin)

File: core/src/com/google/zxing/multi/qrcode/detector/MultiFinderPatternFinder.java
Patch:
@@ -35,6 +35,7 @@
  * markers at three corners of a QR Code.</p>
  *
  * <p>This class is not thread-safe and should not be reused.</p>
+ * TODO(dswitkin): Is this comment still true? I don't see any global variables for example.
  *
  * <p>In contrast to {@link FinderPatternFinder}, this class will return an array of all possible
  * QR code locations in the image.</p>

File: core/src/com/google/zxing/qrcode/detector/AlignmentPatternFinder.java
Patch:
@@ -33,6 +33,7 @@
  * some code.</p>
  *
  * <p>This class is not thread-safe.</p>
+ * TODO(dswitkin): Is this still true?
  *
  * @author Sean Owen
  */

File: core/src/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -32,6 +32,7 @@
  * markers at three corners of a QR Code.</p>
  *
  * <p>This class is not thread-safe and should not be reused.</p>
+ * TODO(dswitkin): Is this still true?
  *
  * @author Sean Owen
  */

File: core/src/com/google/zxing/oned/AbstractUPCEANReader.java
Patch:
@@ -40,7 +40,7 @@ public abstract class AbstractUPCEANReader extends AbstractOneDReader implements
   /**
    * Start/end guard pattern.
    */
-  private static final int[] START_END_PATTERN = {1, 1, 1,};
+  static final int[] START_END_PATTERN = {1, 1, 1,};
 
   /**
    * Pattern marking the middle of a UPC/EAN pattern, separating the two halves.

File: core/src/com/google/zxing/oned/Code128Reader.java
Patch:
@@ -417,7 +417,7 @@ public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws Rea
 
     }
 
-    // Check for ample whitespice following pattern, but, to do this we first need to remember that
+    // Check for ample whitespace following pattern, but, to do this we first need to remember that
     // we fudged decoding CODE_STOP since it actually has 7 bars, not 6. There is a black bar left
     // to read off. Would be slightly better to properly read. Here we just skip it:
     while (row.get(nextStart)) {

File: core/src/com/google/zxing/oned/EAN13Reader.java
Patch:
@@ -51,14 +51,14 @@ public final class EAN13Reader extends AbstractUPCEANReader {
   // Note that the encoding for '0' uses the same parity as a UPC barcode. Hence
   // a UPC barcode can be converted to an EAN-13 barcode by prepending a 0.
   //
-  // The encodong is represented by the following array, which is a bit pattern
+  // The encoding is represented by the following array, which is a bit pattern
   // using Odd = 0 and Even = 1. For example, 5 is represented by:
   //
   //              Odd Even Even Odd Odd Even
   // in binary:
   //                0    1    1   0   0    1   == 0x19
   //
-  private static final int[] FIRST_DIGIT_ENCODINGS = {
+  public static final int[] FIRST_DIGIT_ENCODINGS = {
       0x00, 0x0B, 0x0D, 0xE, 0x13, 0x19, 0x1C, 0x15, 0x16, 0x1A
   };
 

File: core/src/com/google/zxing/oned/MultiFormatUPCEANReader.java
Patch:
@@ -27,7 +27,7 @@
 
 /**
  * <p>A reader that can read all available UPC/EAN formats. If a caller wants to try to
- * read all such formats, it is most efficent to use this implementation rather than invoke
+ * read all such formats, it is most efficient to use this implementation rather than invoke
  * individual readers.</p>
  *
  * @author Sean Owen

File: core/src/com/google/zxing/oned/UPCEANReader.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.zxing.common.BitArray;
 
 /**
- * <p>This interfaces captures addtional functionality that readers of
+ * <p>This interfaces captures additional functionality that readers of
  * UPC/EAN family of barcodes should expose.</p>
  *
  * @author Sean Owen

File: android/src/com/google/zxing/client/android/EncodeActivity.java
Patch:
@@ -74,7 +74,7 @@ public void onGlobalLayout() {
         View layout = findViewById(R.id.encode_view);
         int width = layout.getWidth();
         int height = layout.getHeight();
-        int smallerDimension = (width < height) ? width : height;
+        int smallerDimension = width < height ? width : height;
         smallerDimension = smallerDimension * 7 / 8;
 
         Intent intent = getIntent();

File: android/src/com/google/zxing/client/android/PreferencesActivity.java
Patch:
@@ -20,13 +20,15 @@
 import android.content.SharedPreferences.OnSharedPreferenceChangeListener;
 import android.os.Bundle;
 import android.preference.CheckBoxPreference;
+import android.preference.PreferenceActivity;
 import android.preference.PreferenceScreen;
 
-public final class PreferencesActivity extends android.preference.PreferenceActivity
+public final class PreferencesActivity extends PreferenceActivity
     implements OnSharedPreferenceChangeListener {
 
   static final String KEY_DECODE_1D = "preferences_decode_1D";
   static final String KEY_DECODE_QR = "preferences_decode_QR";
+  public static final String KEY_CUSTOM_PRODUCT_SEARCH = "preferences_custom_product_search";
 
   static final String KEY_PLAY_BEEP = "preferences_play_beep";
   static final String KEY_VIBRATE = "preferences_vibrate";

File: android/src/com/google/zxing/client/android/SearchBookContentsListItem.java
Patch:
@@ -17,6 +17,7 @@
 package com.google.zxing.client.android;
 
 import android.content.Context;
+import android.graphics.Typeface;
 import android.text.SpannableString;
 import android.text.Spannable;
 import android.text.style.StyleSpan;
@@ -52,7 +53,7 @@ public void set(SearchBookContentsResult result) {
         String lowerQuery = SearchBookContentsResult.getQuery().toLowerCase();
         String lowerSnippet = snippet.toLowerCase();
         Spannable styledSnippet = new SpannableString(snippet);
-        StyleSpan boldSpan = new StyleSpan(android.graphics.Typeface.BOLD);
+        StyleSpan boldSpan = new StyleSpan(Typeface.BOLD);
         int queryLength = lowerQuery.length();
         int offset = 0;
         while (true) {

File: android/src/com/google/zxing/client/android/ViewfinderView.java
Patch:
@@ -32,7 +32,7 @@
 public final class ViewfinderView extends View {
 
   private static final int[] SCANNER_ALPHA = {0, 64, 128, 192, 255, 192, 128, 64};
-  private static final int ANIMATION_DELAY = 100;
+  private static final long ANIMATION_DELAY = 100L;
 
   private final Paint mPaint;
   private final Rect mBox;

File: zxingorg/src/com/google/zxing/web/DecodeEmailListener.java
Patch:
@@ -27,7 +27,7 @@
  */
 public final class DecodeEmailListener implements ServletContextListener {
 
-  private static final long EMAIL_CHECK_INTERVAL = 3L * 60 * 1000;
+  private static final long EMAIL_CHECK_INTERVAL = 5L * 60 * 1000;
 
   private Timer emailTimer;
 

File: zxingorg/src/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -85,7 +85,7 @@ public final class DecodeServlet extends HttpServlet {
   static {
     HINTS = new Hashtable<DecodeHintType, Object>(5);
     HINTS.put(DecodeHintType.TRY_HARDER, Boolean.TRUE);
-    Vector possibleFormats = new Vector();
+    Vector<BarcodeFormat> possibleFormats = new Vector<BarcodeFormat>();
     possibleFormats.add(BarcodeFormat.UPC_A);
     possibleFormats.add(BarcodeFormat.UPC_E);
     possibleFormats.add(BarcodeFormat.EAN_8);

File: core/src/com/google/zxing/common/CroppedMonochromeBitmapSource.java
Patch:
@@ -87,8 +87,8 @@ public MonochromeBitmapSource rotateCounterClockwise() {
     return new CroppedMonochromeBitmapSource(rotated,
                                              top,
                                              delegate.getWidth() - right,
-                                             delegate.getHeight() - bottom,
-                                             left);
+                                             bottom,
+                                             delegate.getWidth() - left);
   }
 
   public boolean isRotateSupported() {

File: core/src/com/google/zxing/multi/GenericMultipleBarcodeReader.java
Patch:
@@ -108,11 +108,11 @@ private void doDecodeMultiple(MonochromeBitmapSource image,
     }
 
     if (minX > 0) {
-      doDecodeMultiple(new CroppedMonochromeBitmapSource(image, 0, 0, (int) minX - 1, height),
+      doDecodeMultiple(new CroppedMonochromeBitmapSource(image, 0, 0, (int) minX, height),
                        hints, results, 0, 0);
     }
     if (minY > 0) {
-      doDecodeMultiple(new CroppedMonochromeBitmapSource(image, 0, 0, width, (int) minY - 1),
+      doDecodeMultiple(new CroppedMonochromeBitmapSource(image, 0, 0, width, (int) minY),
                        hints, results, 0, 0);
     }
     if (maxX < width - 1) {

File: core/src/com/google/zxing/qrcode/decoder/BitMatrixParser.java
Patch:
@@ -120,7 +120,7 @@ Version readVersion() throws ReaderException {
     }
 
     parsedVersion = Version.decodeVersionInformation(versionBits);
-    if (parsedVersion != null) {
+    if (parsedVersion != null && parsedVersion.getDimensionForVersion() == dimension) {
       return parsedVersion;
     }
 
@@ -134,7 +134,7 @@ Version readVersion() throws ReaderException {
     }
 
     parsedVersion = Version.decodeVersionInformation(versionBits);
-    if (parsedVersion != null) {
+    if (parsedVersion != null && parsedVersion.getDimensionForVersion() == dimension) {
       return parsedVersion;
     }
     throw ReaderException.getInstance();

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/ContactInfoGenerator.java
Patch:
@@ -21,8 +21,6 @@
 import com.google.gwt.user.client.ui.TextBox;
 import com.google.gwt.user.client.ui.Widget;
 
-import java.net.URI;
-
 /**
  * A Generator for contact informations, output is in MeCard format.
  * 

File: core/src/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -23,7 +23,6 @@
 import com.google.zxing.common.Collections;
 import com.google.zxing.common.Comparator;
 import com.google.zxing.common.DetectorResult;
-import com.google.zxing.common.GenericResultPoint;
 import com.google.zxing.common.GridSampler;
 import com.google.zxing.common.detector.MonochromeRectangleDetector;
 
@@ -39,7 +38,7 @@
  */
 public final class Detector {
 
-  private static final int MAX_MODULES = 32;
+  //private static final int MAX_MODULES = 32;
 
   // Trick to avoid creating new Integer objects below -- a sort of crude copy of
   // the Integer.valueOf(int) optimization added in Java 5, not in J2ME
@@ -117,7 +116,7 @@ public DetectorResult detect() throws ReaderException {
     // Bottom left is correct but top left and bottom right might be switched
     ResultPoint[] corners = { maybeTopLeft, bottomLeft, maybeBottomRight };
     // Use the dot product trick to sort them out
-    GenericResultPoint.orderBestPatterns(corners);
+    ResultPoint.orderBestPatterns(corners);
 
     // Now we know which is which:
     ResultPoint bottomRight = corners[0];

File: core/src/com/google/zxing/oned/AbstractOneDReader.java
Patch:
@@ -24,7 +24,6 @@
 import com.google.zxing.ResultMetadataType;
 import com.google.zxing.ResultPoint;
 import com.google.zxing.common.BitArray;
-import com.google.zxing.common.GenericResultPoint;
 
 import java.util.Hashtable;
 
@@ -130,8 +129,8 @@ private Result doDecode(MonochromeBitmapSource image, Hashtable hints) throws Re
             result.putMetadata(ResultMetadataType.ORIENTATION, new Integer(180));
             // And remember to flip the result points horizontally.
             ResultPoint[] points = result.getResultPoints();
-            points[0] = new GenericResultPoint(width - points[0].getX() - 1, points[0].getY());
-            points[1] = new GenericResultPoint(width - points[1].getX() - 1, points[1].getY());
+            points[0] = new ResultPoint(width - points[0].getX() - 1, points[0].getY());
+            points[1] = new ResultPoint(width - points[1].getX() - 1, points[1].getY());
           }
           return result;
         } catch (ReaderException re) {

File: core/src/com/google/zxing/oned/AbstractUPCEANReader.java
Patch:
@@ -21,7 +21,6 @@
 import com.google.zxing.Result;
 import com.google.zxing.ResultPoint;
 import com.google.zxing.common.BitArray;
-import com.google.zxing.common.GenericResultPoint;
 
 import java.util.Hashtable;
 
@@ -137,8 +136,8 @@ public final Result decodeRow(int rowNumber, BitArray row, int[] startGuardRange
     return new Result(resultString,
         null, // no natural byte representation for these barcodes
         new ResultPoint[]{
-            new GenericResultPoint(left, (float) rowNumber),
-            new GenericResultPoint(right, (float) rowNumber)},
+            new ResultPoint(left, (float) rowNumber),
+            new ResultPoint(right, (float) rowNumber)},
         getBarcodeFormat());
   }
 

File: core/src/com/google/zxing/oned/Code128Reader.java
Patch:
@@ -21,7 +21,6 @@
 import com.google.zxing.Result;
 import com.google.zxing.ResultPoint;
 import com.google.zxing.common.BitArray;
-import com.google.zxing.common.GenericResultPoint;
 
 import java.util.Hashtable;
 
@@ -461,8 +460,8 @@ public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws Rea
         resultString,
         null,
         new ResultPoint[]{
-            new GenericResultPoint(left, (float) rowNumber),
-            new GenericResultPoint(right, (float) rowNumber)},
+            new ResultPoint(left, (float) rowNumber),
+            new ResultPoint(right, (float) rowNumber)},
         BarcodeFormat.CODE_128);
 
   }

File: core/src/com/google/zxing/oned/Code39Reader.java
Patch:
@@ -21,7 +21,6 @@
 import com.google.zxing.Result;
 import com.google.zxing.ResultPoint;
 import com.google.zxing.common.BitArray;
-import com.google.zxing.common.GenericResultPoint;
 
 import java.util.Hashtable;
 
@@ -160,8 +159,8 @@ public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws Rea
         resultString,
         null,
         new ResultPoint[]{
-            new GenericResultPoint(left, (float) rowNumber),
-            new GenericResultPoint(right, (float) rowNumber)},
+            new ResultPoint(left, (float) rowNumber),
+            new ResultPoint(right, (float) rowNumber)},
         BarcodeFormat.CODE_39);
 
   }

File: core/src/com/google/zxing/oned/ITFReader.java
Patch:
@@ -22,7 +22,6 @@
 import com.google.zxing.ResultPoint;
 import com.google.zxing.DecodeHintType;
 import com.google.zxing.common.BitArray;
-import com.google.zxing.common.GenericResultPoint;
 
 import java.util.Hashtable;
 
@@ -115,8 +114,8 @@ public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws Rea
     return new Result(
         resultString,
         null, // no natural byte representation for these barcodes
-        new ResultPoint[] { new GenericResultPoint(startRange[1], (float) rowNumber),
-                            new GenericResultPoint(endRange[0], (float) rowNumber)},
+        new ResultPoint[] { new ResultPoint(startRange[1], (float) rowNumber),
+                            new ResultPoint(endRange[0], (float) rowNumber)},
         BarcodeFormat.ITF);
   }
 

File: core/src/com/google/zxing/qrcode/detector/Detector.java
Patch:
@@ -22,7 +22,6 @@
 import com.google.zxing.ResultPoint;
 import com.google.zxing.common.BitMatrix;
 import com.google.zxing.common.DetectorResult;
-import com.google.zxing.common.GenericResultPoint;
 import com.google.zxing.common.GridSampler;
 import com.google.zxing.qrcode.decoder.Version;
 
@@ -176,8 +175,8 @@ private static int computeDimension(ResultPoint topLeft,
                                       ResultPoint topRight,
                                       ResultPoint bottomLeft,
                                       float moduleSize) throws ReaderException {
-    int tltrCentersDimension = round(GenericResultPoint.distance(topLeft, topRight) / moduleSize);
-    int tlblCentersDimension = round(GenericResultPoint.distance(topLeft, bottomLeft) / moduleSize);
+    int tltrCentersDimension = round(ResultPoint.distance(topLeft, topRight) / moduleSize);
+    int tlblCentersDimension = round(ResultPoint.distance(topLeft, bottomLeft) / moduleSize);
     int dimension = ((tltrCentersDimension + tlblCentersDimension) >> 1) + 7;
     switch (dimension & 0x03) { // mod 4
       case 0:

File: core/src/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -19,10 +19,10 @@
 import com.google.zxing.DecodeHintType;
 import com.google.zxing.MonochromeBitmapSource;
 import com.google.zxing.ReaderException;
+import com.google.zxing.ResultPoint;
 import com.google.zxing.common.BitArray;
 import com.google.zxing.common.Collections;
 import com.google.zxing.common.Comparator;
-import com.google.zxing.common.GenericResultPoint;
 
 import java.util.Hashtable;
 import java.util.Vector;
@@ -162,7 +162,7 @@ FinderPatternInfo find(Hashtable hints) throws ReaderException {
     }
 
     FinderPattern[] patternInfo = selectBestPatterns();
-    GenericResultPoint.orderBestPatterns(patternInfo);
+    ResultPoint.orderBestPatterns(patternInfo);
 
     return new FinderPatternInfo(patternInfo);
   }

File: javase/src/com/google/zxing/client/j2se/BufferedImageMonochromeBitmapSource.java
Patch:
@@ -60,7 +60,10 @@ public BufferedImageMonochromeBitmapSource(BufferedImage image) {
    * @param right one more than the x coordinate of rightmost pixels to decode, i.e. we will decode
    *  pixels whose x coordinate is in [left,right)
    * @param bottom likewise, one more than the y coordinate of the bottommost pixels to decode
+   * @deprecated use
+   *  {@link com.google.zxing.CroppedMonochromeBitmapSource#CroppedMonochromeBitmapSource(MonochromeBitmapSource, int, int, int, int)}
    */
+  @Deprecated
   public BufferedImageMonochromeBitmapSource(BufferedImage image, int left, int top, int right,
       int bottom) {
     super(right - left, bottom - top);

File: zxingorg/src/com/google/zxing/web/DecodeServlet.java
Patch:
@@ -36,6 +36,7 @@
 import org.apache.http.HttpResponse;
 import org.apache.http.HttpVersion;
 import org.apache.http.client.HttpClient;
+import org.apache.http.client.params.HttpClientParams;
 import org.apache.http.client.methods.HttpGet;
 import org.apache.http.conn.scheme.PlainSocketFactory;
 import org.apache.http.conn.scheme.Scheme;
@@ -142,6 +143,7 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response) t
     }
 
     HttpGet getRequest = new HttpGet(imageURI);
+    getRequest.addHeader("Connection", "close"); // Avoids CLOSE_WAIT socket issue?
 
     try {
       HttpResponse getResponse = client.execute(getRequest);

File: android/src/com/google/zxing/client/android/DecodeThread.java
Patch:
@@ -101,8 +101,9 @@ private void setDecodeProductMode() {
     mMultiFormatReader.setHints(hints);
   }
 
-  // TODO: This is fragile in case we add new formats. It would be better to have a new enum
-  // value which represented all 1D formats.
+  /**
+   * Select the 1D formats we want this client to decode by hand.
+   */
   private void setDecode1DMode() {
     Hashtable<DecodeHintType, Object> hints = new Hashtable<DecodeHintType, Object>(3);
     Vector<BarcodeFormat> vector = new Vector<BarcodeFormat>();

File: core/src/com/google/zxing/qrcode/QRCodeWriter.java
Patch:
@@ -67,7 +67,7 @@ public ByteMatrix encode(String contents, BarcodeFormat format, int width, int h
     }
 
     QRCode code = new QRCode();
-    Encoder.encode(contents, errorCorrectionLevel, code);
+    Encoder.encode(contents, errorCorrectionLevel, hints, code);
     return renderResult(code, width, height);
   }
 

File: core/src/com/google/zxing/qrcode/decoder/Version.java
Patch:
@@ -121,6 +121,7 @@ static Version decodeVersionInformation(int versionBits) {
       int bitsDifference = FormatInformation.numBitsDiffering(versionBits, targetVersion);
       if (bitsDifference < bestDifference) {
         bestVersion = i + 7;
+        bestDifference = bitsDifference;
       }
     }
     // We can tolerate up to 3 bits of error since no two version info codewords will

File: core/src/com/google/zxing/qrcode/decoder/BitMatrixParser.java
Patch:
@@ -128,7 +128,7 @@ Version readVersion() throws ReaderException {
     versionBits = 0;
     for (int j = 5; j >= 0; j--) {
       int iMin = dimension - 11;
-      for (int i = dimension - 11; i >= iMin; i--) {
+      for (int i = dimension - 9; i >= iMin; i--) {
         versionBits = copyBit(i, j, versionBits);
       }
     }

File: core/test/src/com/google/zxing/datamatrix/DataMatrixBlackBox2TestCase.java
Patch:
@@ -29,8 +29,8 @@ public DataMatrixBlackBox2TestCase() {
     super("test/data/blackbox/datamatrix-2", new DataMatrixReader(), BarcodeFormat.DATAMATRIX);
     addTest(3, 3, 0.0f);
     addTest(1, 1, 90.0f);
-    addTest(3, 3, 180.0f);
-    addTest(4, 4, 270.0f);
+    addTest(4, 4, 180.0f);
+    addTest(3, 3, 270.0f);
   }
 
 }

File: core/src/com/google/zxing/DecodeHintType.java
Patch:
@@ -53,7 +53,7 @@ public final class DecodeHintType {
   public static final DecodeHintType TRY_HARDER = new DecodeHintType();
 
   /**
-   * Allowed lengths of encoded data -- reject anything else. Maps to an {@link int[]}.
+   * Allowed lengths of encoded data -- reject anything else. Maps to an int[].
    */
   public static final DecodeHintType ALLOWED_LENGTHS = new DecodeHintType();
 

File: core/src/com/google/zxing/common/detector/MonochromeRectangleDetector.java
Patch:
@@ -44,7 +44,7 @@ public MonochromeRectangleDetector(MonochromeBitmapSource image) {
    * <p>Detects a rectangular region of black and white -- mostly black -- with a region of mostly
    * white, in an image.</p>
    *
-   * @return {@link ResultPoint[]} describing the corners of the rectangular region. The first and last points
+   * @return {@link ResultPoint}[] describing the corners of the rectangular region. The first and last points
    *  are opposed on the diagonal, as are the second and third. The first point will be the topmost point and
    *  the last, the bottommost. The second point will be leftmost and the third, the rightmost
    * @throws ReaderException if no Data Matrix Code can be found

File: android/src/com/google/zxing/client/android/DecodeThread.java
Patch:
@@ -112,6 +112,7 @@ private void setDecode1DMode() {
     vector.addElement(BarcodeFormat.EAN_8);
     vector.addElement(BarcodeFormat.CODE_39);
     vector.addElement(BarcodeFormat.CODE_128);
+    vector.addElement(BarcodeFormat.ITF);
     hints.put(DecodeHintType.POSSIBLE_FORMATS, vector);
     mMultiFormatReader.setHints(hints);
   }
@@ -125,7 +126,7 @@ private void setDecodeQRMode() {
   }
 
   /**
-   * Instead of calling setHints(null), which would allow new formats like ITF to sneak in, we
+   * Instead of calling setHints(null), which would allow new formats to sneak in, we
    * explicitly set which formats are available.
    */
   private void setDecodeAllMode() {
@@ -137,6 +138,7 @@ private void setDecodeAllMode() {
     vector.addElement(BarcodeFormat.EAN_8);
     vector.addElement(BarcodeFormat.CODE_39);
     vector.addElement(BarcodeFormat.CODE_128);
+    vector.addElement(BarcodeFormat.ITF);
     vector.addElement(BarcodeFormat.QR_CODE);
     hints.put(DecodeHintType.POSSIBLE_FORMATS, vector);
     mMultiFormatReader.setHints(hints);

File: core/src/com/google/zxing/oned/ITFReader.java
Patch:
@@ -116,7 +116,7 @@ public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws Rea
         resultString,
         null, // no natural byte representation for these barcodes
         new ResultPoint[] { new GenericResultPoint(startRange[1], (float) rowNumber),
-                            new GenericResultPoint(startRange[0], (float) rowNumber)},
+                            new GenericResultPoint(endRange[0], (float) rowNumber)},
         BarcodeFormat.ITF);
   }
 

File: core/src/com/google/zxing/MultiFormatReader.java
Patch:
@@ -98,7 +98,8 @@ public void setHints(Hashtable hints) {
               possibleFormats.contains(BarcodeFormat.EAN_13) ||
               possibleFormats.contains(BarcodeFormat.EAN_8) ||
               possibleFormats.contains(BarcodeFormat.CODE_39) ||
-              possibleFormats.contains(BarcodeFormat.CODE_128);
+              possibleFormats.contains(BarcodeFormat.CODE_128) ||
+              possibleFormats.contains(BarcodeFormat.ITF);
       // Put 1D readers upfront in "normal" mode
       if (addOneDReader && !tryHarder) {
         readers.addElement(new MultiFormatOneDReader(hints));

File: core/src/com/google/zxing/oned/MultiFormatOneDReader.java
Patch:
@@ -57,8 +57,7 @@ public MultiFormatOneDReader(Hashtable hints) {
       readers.addElement(new MultiFormatUPCEANReader(hints));
       readers.addElement(new Code39Reader());
       readers.addElement(new Code128Reader());
-      // TODO: Add ITFReader once it is validated as production ready, and tested for performance.
-      //readers.addElement(new ITFReader());
+      readers.addElement(new ITFReader());
     }
   }
 

File: core/test/src/com/google/zxing/client/result/ParsedReaderResultTestCase.java
Patch:
@@ -73,7 +73,7 @@ public void testEmailAddressType() {
     doTestResult("srowen@example.org", "srowen@example.org", ParsedResultType.EMAIL_ADDRESS);
     doTestResult("mailto:srowen@example.org", "srowen@example.org", ParsedResultType.EMAIL_ADDRESS);
     doTestResult("MAILTO:srowen@example.org", "srowen@example.org", ParsedResultType.EMAIL_ADDRESS);
-    doTestResult("srowen@example", "srowen@example", ParsedResultType.TEXT);
+    doTestResult("srowen@example", "srowen@example", ParsedResultType.EMAIL_ADDRESS);
     doTestResult("srowen", "srowen", ParsedResultType.TEXT);
     doTestResult("Let's meet @ 2", "Let's meet @ 2", ParsedResultType.TEXT);
   }

File: core/src/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -53,6 +53,8 @@ public static ParsedResult parseResult(Result theResult) {
       return result;
     } else if ((result = VEventResultParser.parse(theResult)) != null) {
       return result;
+    } else if ((result = EmailAddressResultParser.parse(theResult)) != null) {
+      return result;
     } else if ((result = TelResultParser.parse(theResult)) != null) {
       return result;
     } else if ((result = SMSMMSResultParser.parse(theResult)) != null) {
@@ -63,8 +65,6 @@ public static ParsedResult parseResult(Result theResult) {
       return result;
     } else if ((result = URIResultParser.parse(theResult)) != null) {
       return result;
-    } else if ((result = EmailAddressResultParser.parse(theResult)) != null) {
-      return result;
     } else if ((result = ISBNResultParser.parse(theResult)) != null) {
       // We depend on ISBN parsing coming before UPC, as it is a subset.
       return result;

File: core/src/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -53,8 +53,6 @@ public static ParsedResult parseResult(Result theResult) {
       return result;
     } else if ((result = VEventResultParser.parse(theResult)) != null) {
       return result;
-    } else if ((result = EmailAddressResultParser.parse(theResult)) != null) {
-      return result;
     } else if ((result = TelResultParser.parse(theResult)) != null) {
       return result;
     } else if ((result = SMSMMSResultParser.parse(theResult)) != null) {
@@ -65,6 +63,8 @@ public static ParsedResult parseResult(Result theResult) {
       return result;
     } else if ((result = URIResultParser.parse(theResult)) != null) {
       return result;
+    } else if ((result = EmailAddressResultParser.parse(theResult)) != null) {
+      return result;
     } else if ((result = ISBNResultParser.parse(theResult)) != null) {
       // We depend on ISBN parsing coming before UPC, as it is a subset.
       return result;

File: core/test/src/com/google/zxing/client/result/URIParsedResultTestCase.java
Patch:
@@ -38,6 +38,9 @@ public void testURI() {
     doTest("http://google.com", "http://google.com", null);
     doTest("https://google.com", "https://google.com", null);
     doTest("google.com:443", "http://google.com:443", null);
+    doTest("https://www.google.com/calendar/hosted/google.com/embed?mode=AGENDA&force_login=true&src=google.com_726f6f6d5f6265707075@resource.calendar.google.com",
+           "https://www.google.com/calendar/hosted/google.com/embed?mode=AGENDA&force_login=true&src=google.com_726f6f6d5f6265707075@resource.calendar.google.com",
+           null);
   }
 
   public void testURLTO() {

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/EmailGenerator.java
Patch:
@@ -66,7 +66,9 @@ public Grid getWidget() {
   }
 
   public void validate(Widget widget) throws GeneratorException {
-    if (widget == email) getEmailField();
+    if (widget == email) {
+      getEmailField();
+    }
   }
 
   public void setFocus() {

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/PhoneNumberGenerator.java
Patch:
@@ -67,7 +67,9 @@ public Grid getWidget() {
   }
 
   public void validate(Widget widget) throws GeneratorException {
-    if (widget == number) getTelField();
+    if (widget == number) {
+      getTelField();
+    }
   }
   
   public void setFocus() {

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/TimeZoneList.java
Patch:
@@ -37,8 +37,8 @@ public TimeZoneInfo(String abreviation, String longName, String relative, long g
     }
   }
   
-  private final static long ONE_HOUR = 60*60*1000;
-  private final static long THIRTY_MIN = 30*60*1000;
+  private static final long ONE_HOUR = 60L*60*1000;
+  private static final long THIRTY_MIN = 30L*60*1000;
   
   public static final TimeZoneInfo[] TIMEZONES = {
     new TimeZoneInfo("GMT", "Greenwich Mean Time", "GMT",               0 * ONE_HOUR + 0 * THIRTY_MIN), // 0

File: android/src/com/google/zxing/client/android/EncodeActivity.java
Patch:
@@ -27,10 +27,9 @@
 import android.os.Bundle;
 import android.os.Handler;
 import android.os.Message;
-import android.view.ViewTreeObserver.OnGlobalLayoutListener;
 import android.view.View;
+import android.view.ViewTreeObserver.OnGlobalLayoutListener;
 import android.widget.ImageView;
-import android.widget.LinearLayout;
 import android.widget.TextView;
 
 /**
@@ -72,7 +71,7 @@ protected void onResume() {
   public final OnGlobalLayoutListener mLayoutListener = new OnGlobalLayoutListener() {
     public void onGlobalLayout() {
       if (mFirstLayout) {
-        LinearLayout layout = (LinearLayout) findViewById(R.id.encode_view);
+        View layout = findViewById(R.id.encode_view);
         int width = layout.getWidth();
         int height = layout.getHeight();
         int smallerDimension = (width < height) ? width : height;

File: core/src/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -45,8 +45,6 @@ public static ParsedResult parseResult(Result theResult) {
       return result;
     } else if ((result = EmailDoCoMoResultParser.parse(theResult)) != null) {
       return result;
-    } else if ((result = EmailAddressResultParser.parse(theResult)) != null) {
-      return result;
     } else if ((result = AddressBookAUResultParser.parse(theResult)) != null) {
       return result;
     } else if ((result = VCardResultParser.parse(theResult)) != null) {
@@ -55,6 +53,8 @@ public static ParsedResult parseResult(Result theResult) {
       return result;
     } else if ((result = VEventResultParser.parse(theResult)) != null) {
       return result;
+    } else if ((result = EmailAddressResultParser.parse(theResult)) != null) {
+      return result;
     } else if ((result = TelResultParser.parse(theResult)) != null) {
       return result;
     } else if ((result = SMSMMSResultParser.parse(theResult)) != null) {

File: android/src/com/google/zxing/client/android/YUVMonochromeBitmapSource.java
Patch:
@@ -40,11 +40,12 @@ final class YUVMonochromeBitmapSource extends BaseMonochromeBitmapSource {
    * @param crop       The rectangle within the yuvData to expose to MonochromeBitmapSource users
    */
   YUVMonochromeBitmapSource(byte[] yuvData, int dataWidth, int dataHeight, Rect crop) {
+    if (crop.width() > dataWidth || crop.height() > dataHeight) {
+      throw new IllegalArgumentException();
+    }
     mYUVData = yuvData;
     mDataWidth = dataWidth;
     mCrop = crop;
-    assert (crop.width() <= dataWidth);
-    assert (crop.height() <= dataHeight);
   }
 
   @Override

File: androidtest/src/com/google/zxing/client/androidtest/BenchmarkItem.java
Patch:
@@ -27,8 +27,10 @@ public final class BenchmarkItem {
   private BarcodeFormat mFormat;
 
   public BenchmarkItem(String path, int runs) {
+    if (runs <= 0) {
+      throw new IllegalArgumentException();
+    }
     mPath = path;
-    assert(runs > 0);
     mTimes = new int[runs];
     mPosition = 0;
     mDecoded = false;

File: androidtest/src/com/google/zxing/client/androidtest/SaveThread.java
Patch:
@@ -67,8 +67,9 @@ public void handleMessage(Message message) {
   private void save(byte[] data, int width, int height) {
     int framingWidth = mFramingRect.width();
     int framingHeight = mFramingRect.height();
-    assert (framingWidth <= width);
-    assert (framingHeight <= height);
+    if (framingWidth > width || framingHeight > height) {
+      throw new IllegalArgumentException();
+    }
 
     int leftOffset = mFramingRect.left;
     int topOffset = mFramingRect.top;

File: javame/src/com/google/zxing/client/j2me/DefaultMultimediaManager.java
Patch:
@@ -34,4 +34,7 @@ public void setZoom(Controllable player) {
   public void setExposure(Controllable player) {
   }
 
+  public void setFlash(Controllable player) {
+  }
+
 }
\ No newline at end of file

File: javame/src/com/google/zxing/client/j2me/MultimediaManager.java
Patch:
@@ -34,4 +34,6 @@ interface MultimediaManager {
 
   void setExposure(Controllable player);
 
+  void setFlash(Controllable player);
+
 }
\ No newline at end of file

File: javame/src/com/google/zxing/client/j2me/ZXingMIDlet.java
Patch:
@@ -94,6 +94,7 @@ protected void startApp() throws MIDletStateChangeException {
       MultimediaManager multimediaManager = buildMultimediaManager();
       multimediaManager.setZoom(player);
       multimediaManager.setExposure(player);
+      multimediaManager.setFlash(player);
       videoControl = (VideoControl) player.getControl("VideoControl");
       canvas = new VideoCanvas(this);
       canvas.setFullScreenMode(true);

File: core/test/src/com/google/zxing/common/AbstractNegativeBlackBoxTestCase.java
Patch:
@@ -58,8 +58,8 @@ public float getRotation() {
   private final List<TestResult> testResults;
 
   // Use the multiformat reader to evaluate all decoders in the system.
-  protected AbstractNegativeBlackBoxTestCase(File testBase) {
-    super(testBase, new MultiFormatReader(), null);
+  protected AbstractNegativeBlackBoxTestCase(String testBasePathSuffix) {
+    super(testBasePathSuffix, new MultiFormatReader(), null);
     testResults = new ArrayList<TestResult>();
   }
 

File: core/test/src/com/google/zxing/negative/FalsePositivesBlackBoxTestCase.java
Patch:
@@ -18,8 +18,6 @@
 
 import com.google.zxing.common.AbstractNegativeBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * This test ensures that random images with high contrast patterns do not decode as barcodes.
  *
@@ -28,7 +26,7 @@
 public final class FalsePositivesBlackBoxTestCase extends AbstractNegativeBlackBoxTestCase {
 
   public FalsePositivesBlackBoxTestCase() {
-    super(new File("test/data/blackbox/falsepositives"));
+    super("test/data/blackbox/falsepositives");
     addTest(2, 0.0f);
     addTest(0, 90.0f);
     addTest(0, 180.0f);

File: core/test/src/com/google/zxing/negative/PartialBlackBoxTestCase.java
Patch:
@@ -18,8 +18,6 @@
 
 import com.google.zxing.common.AbstractNegativeBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * This test ensures that partial barcodes do not decode.
  *
@@ -28,7 +26,7 @@
 public final class PartialBlackBoxTestCase extends AbstractNegativeBlackBoxTestCase {
 
   public PartialBlackBoxTestCase() {
-    super(new File("test/data/blackbox/partial"));
+    super("test/data/blackbox/partial");
     addTest(0, 0.0f);
     addTest(1, 90.0f);
     addTest(1, 180.0f);

File: core/test/src/com/google/zxing/negative/UnsupportedBlackBoxTestCase.java
Patch:
@@ -18,8 +18,6 @@
 
 import com.google.zxing.common.AbstractNegativeBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * This test ensures that unsupported barcodes do not decode.
  *
@@ -28,7 +26,7 @@
 public final class UnsupportedBlackBoxTestCase extends AbstractNegativeBlackBoxTestCase {
 
   public UnsupportedBlackBoxTestCase() {
-    super(new File("test/data/blackbox/unsupported"));
+    super("test/data/blackbox/unsupported");
     addTest(0, 0.0f);
     addTest(0, 90.0f);
     addTest(1, 180.0f);

File: core/test/src/com/google/zxing/oned/Code128BlackBox1TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class Code128BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public Code128BlackBox1TestCase() {
-    super(new File("test/data/blackbox/code128-1"), new MultiFormatReader(), BarcodeFormat.CODE_128);
+    super("test/data/blackbox/code128-1", new MultiFormatReader(), BarcodeFormat.CODE_128);
     addTest(5, 5, 0.0f);
     addTest(5, 5, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/Code128BlackBox2TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class Code128BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public Code128BlackBox2TestCase() {
-    super(new File("test/data/blackbox/code128-2"), new MultiFormatReader(), BarcodeFormat.CODE_128);
+    super("test/data/blackbox/code128-2", new MultiFormatReader(), BarcodeFormat.CODE_128);
     addTest(33, 39, 0.0f);
     addTest(34, 37, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/Code128BlackBox3TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class Code128BlackBox3TestCase extends AbstractBlackBoxTestCase {
 
   public Code128BlackBox3TestCase() {
-    super(new File("test/data/blackbox/code128-3"), new MultiFormatReader(), BarcodeFormat.CODE_128);
+    super("test/data/blackbox/code128-3", new MultiFormatReader(), BarcodeFormat.CODE_128);
     addTest(2, 2, 0.0f);
     addTest(2, 2, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/Code39BlackBox1TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class Code39BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public Code39BlackBox1TestCase() {
-    super(new File("test/data/blackbox/code39-1"), new MultiFormatReader(), BarcodeFormat.CODE_39);
+    super("test/data/blackbox/code39-1", new MultiFormatReader(), BarcodeFormat.CODE_39);
     addTest(4, 4, 0.0f);
     addTest(4, 4, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/Code39BlackBox3TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class Code39BlackBox3TestCase extends AbstractBlackBoxTestCase {
 
   public Code39BlackBox3TestCase() {
-    super(new File("test/data/blackbox/code39-3"), new MultiFormatReader(), BarcodeFormat.CODE_39);
+    super("test/data/blackbox/code39-3", new MultiFormatReader(), BarcodeFormat.CODE_39);
     addTest(17, 17, 0.0f);
     addTest(17, 17, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/Code39ExtendedBlackBox2TestCase.java
Patch:
@@ -19,15 +19,13 @@
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 import com.google.zxing.BarcodeFormat;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class Code39ExtendedBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public Code39ExtendedBlackBox2TestCase() {
-    super(new File("test/data/blackbox/code39-2"), new Code39Reader(false, true), BarcodeFormat.CODE_39);
+    super("test/data/blackbox/code39-2", new Code39Reader(false, true), BarcodeFormat.CODE_39);
     addTest(2, 2, 0.0f);
     addTest(2, 2, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/EAN13BlackBox1TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class EAN13BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox1TestCase() {
-    super(new File("test/data/blackbox/ean13-1"), new MultiFormatReader(), BarcodeFormat.EAN_13);
+    super("test/data/blackbox/ean13-1", new MultiFormatReader(), BarcodeFormat.EAN_13);
     addTest(28, 31, 0.0f);
     addTest(27, 31, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/EAN13BlackBox2TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class EAN13BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox2TestCase() {
-    super(new File("test/data/blackbox/ean13-2"), new MultiFormatReader(), BarcodeFormat.EAN_13);
+    super("test/data/blackbox/ean13-2", new MultiFormatReader(), BarcodeFormat.EAN_13);
     addTest(1, 1, 0.0f);
     addTest(1, 1, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/EAN13BlackBox3TestCase.java
Patch:
@@ -28,7 +28,7 @@
 public final class EAN13BlackBox3TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox3TestCase() {
-    super(new File("test/data/blackbox/ean13-3"), new MultiFormatReader(), BarcodeFormat.EAN_13);
+    super("test/data/blackbox/ean13-3", new MultiFormatReader(), BarcodeFormat.EAN_13);
     addTest(49, 55, 0.0f);
     addTest(52, 55, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/EAN8BlackBox1TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class EAN8BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public EAN8BlackBox1TestCase() {
-    super(new File("test/data/blackbox/ean8-1"), new MultiFormatReader(), BarcodeFormat.EAN_8);
+    super("test/data/blackbox/ean8-1", new MultiFormatReader(), BarcodeFormat.EAN_8);
     addTest(8, 8, 0.0f);
     addTest(8, 8, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/ITFBlackBox1TestCase.java
Patch:
@@ -21,7 +21,6 @@
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
 import java.util.Hashtable;
 import java.util.Vector;
 
@@ -31,7 +30,7 @@
 public final class ITFBlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public ITFBlackBox1TestCase() {
-    super(new File("test/data/blackbox/itf-1"), new MultiFormatReader(), BarcodeFormat.ITF);
+    super("test/data/blackbox/itf-1", new MultiFormatReader(), BarcodeFormat.ITF);
     addTest(9, 12, 0.0f);
   }
 

File: core/test/src/com/google/zxing/oned/UPCABlackBox1TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class UPCABlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public UPCABlackBox1TestCase() {
-    super(new File("test/data/blackbox/upca-1"), new MultiFormatReader(), BarcodeFormat.UPC_A);
+    super("test/data/blackbox/upca-1", new MultiFormatReader(), BarcodeFormat.UPC_A);
     addTest(15, 16, 0.0f);
     addTest(15, 19, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/UPCABlackBox2TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class UPCABlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public UPCABlackBox2TestCase() {
-    super(new File("test/data/blackbox/upca-2"), new MultiFormatReader(), BarcodeFormat.UPC_A);
+    super("test/data/blackbox/upca-2", new MultiFormatReader(), BarcodeFormat.UPC_A);
     addTest(25, 35, 0.0f);
     addTest(25, 35, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/UPCABlackBox3ReflectiveTestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class UPCABlackBox3ReflectiveTestCase extends AbstractBlackBoxTestCase {
 
   public UPCABlackBox3ReflectiveTestCase() {
-    super(new File("test/data/blackbox/upca-3"), new MultiFormatReader(), BarcodeFormat.UPC_A);
+    super("test/data/blackbox/upca-3", new MultiFormatReader(), BarcodeFormat.UPC_A);
     addTest(8, 8, 0.0f);
     addTest(6, 9, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/UPCABlackBox4TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class UPCABlackBox4TestCase extends AbstractBlackBoxTestCase {
 
   public UPCABlackBox4TestCase() {
-    super(new File("test/data/blackbox/upca-4"), new MultiFormatReader(), BarcodeFormat.UPC_A);
+    super("test/data/blackbox/upca-4", new MultiFormatReader(), BarcodeFormat.UPC_A);
     addTest(8, 13, 0.0f);
     addTest(8, 12, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/UPCEBlackBox1TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class UPCEBlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public UPCEBlackBox1TestCase() {
-    super(new File("test/data/blackbox/upce-1"), new MultiFormatReader(), BarcodeFormat.UPC_E);
+    super("test/data/blackbox/upce-1", new MultiFormatReader(), BarcodeFormat.UPC_E);
     addTest(3, 3, 0.0f);
     addTest(3, 3, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/UPCEBlackBox2TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class UPCEBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public UPCEBlackBox2TestCase() {
-    super(new File("test/data/blackbox/upce-2"), new MultiFormatReader(), BarcodeFormat.UPC_E);
+    super("test/data/blackbox/upce-2", new MultiFormatReader(), BarcodeFormat.UPC_E);
     addTest(30, 35, 0.0f);
     addTest(29, 35, 180.0f);
   }

File: core/test/src/com/google/zxing/oned/UPCEBlackBox3ReflectiveTestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class UPCEBlackBox3ReflectiveTestCase extends AbstractBlackBoxTestCase {
 
   public UPCEBlackBox3ReflectiveTestCase() {
-    super(new File("test/data/blackbox/upce-3"), new MultiFormatReader(), BarcodeFormat.UPC_E);
+    super("test/data/blackbox/upce-3", new MultiFormatReader(), BarcodeFormat.UPC_E);
     addTest(4, 8, 0.0f);
     addTest(4, 8, 180.0f);
   }

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox1TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class QRCodeBlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox1TestCase() {
-    super(new File("test/data/blackbox/qrcode-1"), new MultiFormatReader(), BarcodeFormat.QR_CODE);
+    super("test/data/blackbox/qrcode-1", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(18, 18, 0.0f);
     addTest(14, 14, 90.0f);
     addTest(18, 18, 180.0f);

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author Sean Owen
  */
 public final class QRCodeBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox2TestCase() {
-    super(new File("test/data/blackbox/qrcode-2"), new MultiFormatReader(), BarcodeFormat.QR_CODE);
+    super("test/data/blackbox/qrcode-2", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(22, 22, 0.0f);
     addTest(18, 18, 90.0f);
     addTest(22, 22, 180.0f);

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox3TestCase.java
Patch:
@@ -20,15 +20,13 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * @author dswitkin@google.com (Daniel Switkin)
  */
 public final class QRCodeBlackBox3TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox3TestCase() {
-    super(new File("test/data/blackbox/qrcode-3"), new MultiFormatReader(), BarcodeFormat.QR_CODE);
+    super("test/data/blackbox/qrcode-3", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(29, 29, 0.0f);
     addTest(26, 26, 90.0f);
     addTest(30, 30, 180.0f);

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox4TestCase.java
Patch:
@@ -20,8 +20,6 @@
 import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
-import java.io.File;
-
 /**
  * Tests of various QR Codes from t-shirts, which are notoriously not flat.
  *
@@ -30,7 +28,7 @@
 public final class QRCodeBlackBox4TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox4TestCase() {
-    super(new File("test/data/blackbox/qrcode-4"), new MultiFormatReader(), BarcodeFormat.QR_CODE);
+    super("test/data/blackbox/qrcode-4", new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(32, 32, 0.0f);
     addTest(33, 33, 90.0f);
     addTest(32, 32, 180.0f);

File: core/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -80,6 +80,9 @@ static DecoderResult decode(byte[] bytes, Version version) throws ReaderExceptio
         if (mode.equals(Mode.FNC1_FIRST_POSITION) || mode.equals(Mode.FNC1_SECOND_POSITION)) {
           // We do little with FNC1 except alter the parsed result a bit according to the spec
           fc1InEffect = true;
+        } else if (mode.equals(Mode.STRUCTURED_APPEND)) {
+          // not supported
+          throw ReaderException.getInstance();
         } else if (mode.equals(Mode.ECI)) {
           // Count doesn't apply to ECI
           try {

File: core/src/com/google/zxing/qrcode/decoder/Mode.java
Patch:
@@ -29,6 +29,7 @@ public final class Mode {
   public static final Mode TERMINATOR = new Mode(new int[]{0, 0, 0}, 0x00, "TERMINATOR"); // Not really a mode...
   public static final Mode NUMERIC = new Mode(new int[]{10, 12, 14}, 0x01, "NUMERIC");
   public static final Mode ALPHANUMERIC = new Mode(new int[]{9, 11, 13}, 0x02, "ALPHANUMERIC");
+  public static final Mode STRUCTURED_APPEND = new Mode(new int[]{0, 0, 0}, 0x03, "STRUCTURED_APPEND"); // Not supported
   public static final Mode BYTE = new Mode(new int[]{8, 16, 16}, 0x04, "BYTE");
   public static final Mode ECI = new Mode(null, 0x07, "ECI"); // character counts don't apply
   public static final Mode KANJI = new Mode(new int[]{8, 10, 12}, 0x08, "KANJI");
@@ -58,6 +59,8 @@ public static Mode forBits(int bits) {
         return NUMERIC;
       case 0x2:
         return ALPHANUMERIC;
+      case 0x3:
+        return STRUCTURED_APPEND;
       case 0x4:
         return BYTE;
       case 0x5:

File: core/src/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -423,10 +423,10 @@ private int findRowSkip() {
           // How far down can we skip before resuming looking for the next
           // pattern? In the worst case, only the difference between the
           // difference in the x / y coordinates of the two centers.
-          // This is the case where you find top left first. Draw it out.
+          // This is the case where you find top left last.
           hasSkipped = true;
           return (int) (Math.abs(firstConfirmedCenter.getX() - center.getX()) -
-              Math.abs(firstConfirmedCenter.getY() - center.getY()));
+              Math.abs(firstConfirmedCenter.getY() - center.getY())) / 2;
         }
       }
     }

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox1TestCase.java
Patch:
@@ -29,7 +29,7 @@ public final class QRCodeBlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox1TestCase() {
     super(new File("test/data/blackbox/qrcode-1"), new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(17, 18, 0.0f);
+    addTest(18, 18, 0.0f);
     addTest(14, 14, 90.0f);
     addTest(18, 18, 180.0f);
     addTest(13, 14, 270.0f);

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -29,7 +29,7 @@ public final class QRCodeBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox2TestCase() {
     super(new File("test/data/blackbox/qrcode-2"), new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(23, 23, 0.0f);
+    addTest(22, 22, 0.0f);
     addTest(18, 18, 90.0f);
     addTest(22, 22, 180.0f);
     addTest(17, 17, 270.0f);

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox3TestCase.java
Patch:
@@ -29,10 +29,10 @@ public final class QRCodeBlackBox3TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox3TestCase() {
     super(new File("test/data/blackbox/qrcode-3"), new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(28, 28, 0.0f);
+    addTest(29, 29, 0.0f);
     addTest(26, 26, 90.0f);
     addTest(30, 30, 180.0f);
-    addTest(26, 26, 270.0f);
+    addTest(29, 29, 270.0f);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox4TestCase.java
Patch:
@@ -31,7 +31,7 @@ public final class QRCodeBlackBox4TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox4TestCase() {
     super(new File("test/data/blackbox/qrcode-4"), new MultiFormatReader(), BarcodeFormat.QR_CODE);
-    addTest(33, 33, 0.0f);
+    addTest(32, 32, 0.0f);
     addTest(33, 33, 90.0f);
     addTest(32, 32, 180.0f);
     addTest(32, 32, 270.0f);

File: core/test/src/com/google/zxing/oned/ITFBlackBox1TestCase.java
Patch:
@@ -29,7 +29,7 @@ public final class ITFBlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public ITFBlackBox1TestCase() {
     super(new File("test/data/blackbox/itf-1"), new MultiFormatReader(), BarcodeFormat.ITF);
-    addTest(0, 0, 0.0f);
+    addTest(9, 12, 0.0f);
   }
 
 }
\ No newline at end of file

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/Generator.java
Patch:
@@ -181,7 +181,7 @@ protected String getUrl(int sizeX, int sizeY, String content) {
     result += "x";
     result += sizeY;
     result += "&chl=";
-    result += URL.encode(content);
+    result += URL.encodeComponent(content);
     return result;
   }
   

File: zxing.appspot.com/generator/src/com/google/zxing/web/generator/client/Validators.java
Patch:
@@ -24,11 +24,11 @@
  */
 public final class Validators {
   public static String filterNumber(String number) {
-    return number.replaceAll("[ +\\.,\\-\\(\\)]", "");
+    return number.replaceAll("[ \\.,\\-\\(\\)]", "");
   }
   
   public static void validateNumber(String number) throws GeneratorException {    
-    if (!number.matches("[0-9]+")) {
+    if (!number.matches("\\+?[0-9]+")) {
       throw new GeneratorException("Phone number must be digits only.");
     }
   }

File: core/src/com/google/zxing/client/result/EmailAddressResultParser.java
Patch:
@@ -34,7 +34,7 @@ public static EmailAddressParsedResult parse(Result result) {
       return null;
     }
     String emailAddress;
-    if (rawText.startsWith("mailto:")) {
+    if (rawText.startsWith("mailto:") || rawText.startsWith("MAILTO:")) {
       // If it starts with mailto:, assume it is definitely trying to be an email address
       emailAddress = rawText.substring(7);
       int queryStart = emailAddress.indexOf('?');

File: core/src/com/google/zxing/client/result/GeoResultParser.java
Patch:
@@ -33,7 +33,7 @@ private GeoResultParser() {
 
   public static GeoParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null || !rawText.startsWith("geo:")) {
+    if (rawText == null || (!rawText.startsWith("geo:") && !rawText.startsWith("GEO:"))) {
       return null;
     }
     // Drop geo, query portion

File: core/src/com/google/zxing/client/result/SMSMMSResultParser.java
Patch:
@@ -42,7 +42,8 @@ public static SMSParsedResult parse(Result result) {
       return null;
     }
     int prefixLength;
-    if (rawText.startsWith("sms:") || rawText.startsWith("mms:")) {
+    if (rawText.startsWith("sms:") || rawText.startsWith("SMS:") ||
+        rawText.startsWith("mms:") || rawText.startsWith("MMS:")) {
       prefixLength = 4;
     } else if (rawText.startsWith("smsto:") || rawText.startsWith("SMSTO:") ||
                rawText.startsWith("mmsto:") || rawText.startsWith("MMSTO:")) {

File: core/src/com/google/zxing/client/result/TelResultParser.java
Patch:
@@ -30,7 +30,7 @@ private TelResultParser() {
 
   public static TelParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null || !rawText.startsWith("tel:")) {
+    if (rawText == null || (!rawText.startsWith("tel:") && !rawText.startsWith("TEL:"))) {
       return null;
     }
     String telURI = rawText;

File: core/src/com/google/zxing/client/result/URLTOResultParser.java
Patch:
@@ -32,7 +32,7 @@ private URLTOResultParser() {
 
   public static URIParsedResult parse(Result result) {
     String rawText = result.getText();
-    if (rawText == null || !rawText.startsWith("URLTO:")) {
+    if (rawText == null || (!rawText.startsWith("urlto:") && !rawText.startsWith("URLTO:"))) {
       return null;
     }
     int titleEnd = rawText.indexOf(':', 6);

File: core/test/src/com/google/zxing/common/reedsolomon/ReedSolomonDecoderQRCodeTestCase.java
Patch:
@@ -26,7 +26,7 @@ public final class ReedSolomonDecoderQRCodeTestCase extends AbstractReedSolomonT
   /** See ISO 18004, Appendix I, from which this example is taken. */
   private static final int[] QR_CODE_TEST =
       { 0x10, 0x20, 0x0C, 0x56, 0x61, 0x80, 0xEC, 0x11, 0xEC,
-        0x11, 0xEC, 0x11, 0xEC, 0x11, 0xEC, 0x11, 0xA5 };
+        0x11, 0xEC, 0x11, 0xEC, 0x11, 0xEC, 0x11 };
   private static final int[] QR_CODE_TEST_WITH_EC =
       { 0x10, 0x20, 0x0C, 0x56, 0x61, 0x80, 0xEC, 0x11, 0xEC,
         0x11, 0xEC, 0x11, 0xEC, 0x11, 0xEC, 0x11, 0xA5, 0x24,

File: core/src/com/google/zxing/client/result/GeoParsedResult.java
Patch:
@@ -62,9 +62,8 @@ public float getAltitude() {
   public String getDisplayResult() {
     StringBuffer result = new StringBuffer(50);
     result.append(latitude);
-    result.append(" deg N, ");
+    result.append(", ");
     result.append(longitude);
-    result.append(" deg E");
     if (altitude > 0.0f) {
       result.append(", ");
       result.append(altitude);

File: core/test/src/com/google/zxing/oned/ITFBlackBox1TestCase.java
Patch:
@@ -29,7 +29,7 @@ public final class ITFBlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public ITFBlackBox1TestCase() {
     super(new File("test/data/blackbox/itf-1"), new MultiFormatReader(), BarcodeFormat.ITF);
-    addTest(6, 6, 0.0f);
+    addTest(0, 0, 0.0f);
   }
 
 }
\ No newline at end of file

File: core/src/com/google/zxing/qrcode/encoder/Encoder.java
Patch:
@@ -224,7 +224,6 @@ private static int ChooseMaskPattern(final BitVector bits, int ec_level, int ver
       final int mask_pattern = i;
       MatrixUtil.BuildMatrix(bits, ec_level, version, mask_pattern, matrix);
       final int penalty = MaskUtil.CalculateMaskPenalty(matrix);
-      System.out.println("mask_pattern: " + mask_pattern + ", " + "penalty: " + penalty);
       if (penalty < min_penalty) {
         min_penalty = penalty;
         best_mask_pattern = mask_pattern;

File: core/src/com/google/zxing/BarcodeFormat.java
Patch:
@@ -49,8 +49,8 @@ public final class BarcodeFormat {
   /** Code 39 1D format. */
   public static final BarcodeFormat CODE_39 = new BarcodeFormat("CODE_39");
 
-  /** ITF-14 1D format. */
-  public static final BarcodeFormat ITF_14 = new BarcodeFormat("ITF_14");
+  /** ITF (Interleaved Two of Five) 1D format. */
+  public static final BarcodeFormat ITF = new BarcodeFormat("ITF");
 
   private final String name;
 

File: core/src/com/google/zxing/qrcode/encoder/BitVector.java
Patch:
@@ -52,10 +52,8 @@ public int size() {
   }
 
   // Return the number of bytes in the bit vector.
-  // JAVAPORT: I would have made this ((sizeInBits + 7) >> 3), but apparently users of this class
-  // depend on the number of bytes being rounded down. I don't see how that works though.
   public int num_bytes() {
-    return sizeInBits >> 3;
+    return (sizeInBits + 7) >> 3;
   }
 
   // Append one bit to the bit vector.

File: core/src/com/google/zxing/qrcode/encoder/QRCode.java
Patch:
@@ -185,7 +185,7 @@ public String toString() {
     result.append("\n num_rs_blocks: ");
     result.append(num_rs_blocks_);
     if (matrix_ == null) {
-      result.append("\n matrix: null");
+      result.append("\n matrix: null\n");
     } else {
       result.append("\n matrix:\n");
       result.append(matrix_.toString());

File: core/src/com/google/zxing/qrcode/encoder/Encoder.java
Patch:
@@ -650,9 +650,9 @@ static boolean AppendLengthInfo(int num_bytes, int version, int mode, BitVector
     int num_letters = num_bytes;
     // In Kanji mode, a letter is represented in two bytes.
     if (mode == QRCode.MODE_KANJI) {
-    Debug.DCHECK_EQ(0, num_letters % 2);
-    num_letters /= 2;
-  }
+      Debug.DCHECK_EQ(0, num_letters % 2);
+      num_letters /= 2;
+    }
 
     final int num_bits = QRCode.GetNumBitsForLength(version, mode);
     if (num_bits == -1) {

File: core/src/com/google/zxing/qrcode/encoder/QRCode.java
Patch:
@@ -165,7 +165,7 @@ public boolean IsValid() {
   // Return debug String.
   public String toString() {
     StringBuffer result = new StringBuffer();
-    result.append("<<QRCode\n");
+    result.append("<<\n");
     result.append(" mode: ");
     result.append(ModeToString(mode_));
     result.append("\n ec_level: ");
@@ -187,10 +187,10 @@ public String toString() {
     if (matrix_ == null) {
       result.append("\n matrix: null");
     } else {
-      result.append("\n matrix:");
+      result.append("\n matrix:\n");
       result.append(matrix_.toString());
     }
-    result.append("\n>>\n");
+    result.append(">>\n");
     return result.toString();
   }
 

File: core/src/com/google/zxing/qrcode/encoder/MatrixUtil.java
Patch:
@@ -291,7 +291,7 @@ public static boolean EmbedDataBits(final BitVector data_bits, int mask_pattern,
   public static int FindMSBSet(int value) {
     int num_digits = 0;
     while (value != 0) {
-      value >>= 1;
+      value >>>= 1;
       ++num_digits;
     }
     return num_digits;

File: core/src/com/google/zxing/qrcode/encoder/Encoder.java
Patch:
@@ -757,7 +757,8 @@ static boolean Append8BitBytes(final ByteArray bytes, BitVector bits) {
   // Kanji bytes.
   static boolean AppendKanjiBytes(final ByteArray bytes, BitVector bits) {
     if (bytes.size() % 2 != 0) {
-      Debug.LOG_ERROR("Invalid byte sequence: " + bytes);
+      // JAVAPORT: Our log implementation throws, which causes the unit test to fail.
+      //Debug.LOG_ERROR("Invalid byte sequence: " + bytes);
       return false;
     }
     for (int i = 0; i < bytes.size(); i += 2) {

File: core/src/com/google/zxing/qrcode/encoder/Debug.java
Patch:
@@ -25,11 +25,11 @@
 public class Debug {
 
   public static void LOG_ERROR(String message) {
-    // TODO: Implement
+    throw new IllegalStateException(message);
   }
 
   public static void LOG_INFO(String message) {
-    // TODO: Implement
+    throw new IllegalStateException(message);
   }
 
   public static void DCHECK(boolean condition) {

File: core/src/com/google/zxing/qrcode/encoder/Encoder.java
Patch:
@@ -613,7 +613,7 @@ static boolean InterleaveWithECBytes(final BitVector bits, int num_total_bytes,
       return true;
     }
     Debug.LOG_ERROR("Interleaving error: " + num_total_bytes + " and " + result.num_bytes() +
-        "differ.");
+        " differ.");
     return false;
   }
 

File: core/src/com/google/zxing/MultiFormatReader.java
Patch:
@@ -138,7 +138,7 @@ private Result decodeInternal(MonochromeBitmapSource image) throws ReaderExcepti
       }
     }
 
-    throw new ReaderException("No barcode was detected in this image.");
+    throw ReaderException.getInstance();
   }
 
 }

File: androidtest/src/com/google/zxing/client/androidtest/BenchmarkActivity.java
Patch:
@@ -25,7 +25,7 @@
 import android.widget.Button;
 import android.widget.TextView;
 
-import java.util.Vector;
+import java.util.List;
 
 public final class BenchmarkActivity extends Activity {
 
@@ -76,7 +76,7 @@ public void handleMessage(Message message) {
   };
 
   private void handleBenchmarkDone(Message message) {
-    Vector<BenchmarkItem> items = (Vector<BenchmarkItem>) message.obj;
+    List<BenchmarkItem> items = (List<BenchmarkItem>) message.obj;
     int count = 0;
     for (int x = 0; x < items.size(); x++) {
       BenchmarkItem item = items.get(x);

File: core/src/com/google/zxing/qrcode/encoder/QRCode.java
Patch:
@@ -161,7 +161,7 @@ public boolean IsValid() {
   }
 
   // Return debug String.
-  public String DebugString() {
+  public String toString() {
     StringBuffer result = new StringBuffer();
     result.append("<<QRCode\n");
     result.append(" mode: ");

File: core/src/com/google/zxing/qrcode/encoder/Renderer.java
Patch:
@@ -16,7 +16,6 @@
 
 package com.google.zxing.qrcode.encoder;
 
-//class StringPiece;
 // #include "third_party/png/png.h"
 
 /**
@@ -119,7 +118,7 @@ public static boolean RenderAsPNG(final QRCode &qr_code, int cell_size,
   // Similar to RenderAsPNG but it renders QR code from data in
   // "bytes" with error correction level "ec_level". This is the
   // friendliest function in the QR code library.
-  public static boolean RenderAsPNGFromData(final StringPiece& bytes, int ec_level, int cell_size,
+  public static boolean RenderAsPNGFromData(final ByteArray& bytes, int ec_level, int cell_size,
       String *result) {
     QRCode qr_code;
     if (!Encoder.Encode(bytes, ec_level, &qr_code)) {

File: core/src/com/google/zxing/qrcode/encoder/Matrix.java
Patch:
@@ -21,8 +21,8 @@
  *
  * JAVAPORT: I'm not happy about the argument ordering throughout the file, as I always like to have
  * the horizontal component first, but this is for compatibility with the C++ code. The original
- * code was a 2D array of ints, but since it only ever gets assigned zeros and ones, I'm going to
- * use less memory and go with bytes.
+ * code was a 2D array of ints, but since it only ever gets assigned -1, 0, and 1, I'm going to use
+ * less memory and go with bytes.
  *
  * @author dswitkin@google.com (Daniel Switkin)
  */

File: android/src/com/google/zxing/client/android/BookmarkPickerActivity.java
Patch:
@@ -30,7 +30,7 @@
  * This class is only needed because I can't successfully send an ACTION_PICK intent to
  * com.android.browser.BrowserBookmarksPage. It can go away if that starts working in the future.
  */
-public class BookmarkPickerActivity extends ListActivity {
+public final class BookmarkPickerActivity extends ListActivity {
 
   private static final String[] BOOKMARK_PROJECTION = {
       Browser.BookmarkColumns.TITLE,
@@ -51,7 +51,7 @@ public class BookmarkPickerActivity extends ListActivity {
   private Cursor mCursor;
 
   @Override
-  protected void onCreate(Bundle icicle) {
+  protected final void onCreate(Bundle icicle) {
     super.onCreate(icicle);
 
     mCursor = getContentResolver().query(Browser.BOOKMARKS_URI, BOOKMARK_PROJECTION,
@@ -64,7 +64,7 @@ protected void onCreate(Bundle icicle) {
   }
 
   @Override
-  protected void onListItemClick(ListView l, View view, int position, long id) {
+  protected final void onListItemClick(ListView l, View view, int position, long id) {
     if (mCursor.moveToPosition(position)) {
       Intent intent = new Intent();
       intent.putExtra(Browser.BookmarkColumns.TITLE, mCursor.getString(TITLE_COLUMN));

File: android/src/com/google/zxing/client/android/SearchBookContentsListItem.java
Patch:
@@ -18,6 +18,7 @@
 
 import android.content.Context;
 import android.text.SpannableString;
+import android.text.Spannable;
 import android.text.style.StyleSpan;
 import android.util.AttributeSet;
 import android.widget.LinearLayout;
@@ -50,7 +51,7 @@ public void set(SearchBookContentsResult result) {
       if (result.getValidSnippet()) {
         String lowerQuery = SearchBookContentsResult.getQuery().toLowerCase();
         String lowerSnippet = snippet.toLowerCase();
-        SpannableString styledSnippet = new SpannableString(snippet);
+        Spannable styledSnippet = new SpannableString(snippet);
         StyleSpan boldSpan = new StyleSpan(android.graphics.Typeface.BOLD);
         int queryLength = lowerQuery.length();
         int offset = 0;

File: android/src/com/google/zxing/client/android/result/EmailAddressResultHandler.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.zxing.client.result.EmailAddressParsedResult;
 import com.google.zxing.client.result.ParsedResult;
 
-public class EmailAddressResultHandler extends ResultHandler {
+public final class EmailAddressResultHandler extends ResultHandler {
 
   private static final int[] mButtons = {
       R.string.button_email,

File: android/src/com/google/zxing/client/android/result/GeoResultHandler.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.zxing.client.result.GeoParsedResult;
 import com.google.zxing.client.result.ParsedResult;
 
-public class GeoResultHandler extends ResultHandler {
+public final class GeoResultHandler extends ResultHandler {
 
   private static final int[] mButtons = {
       R.string.button_show_map,

File: android/src/com/google/zxing/client/android/result/ISBNResultHandler.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.zxing.client.result.ISBNParsedResult;
 import com.google.zxing.client.result.ParsedResult;
 
-public class ISBNResultHandler extends ResultHandler {
+public final class ISBNResultHandler extends ResultHandler {
 
   private static final int[] mButtons = {
       R.string.button_product_search,

File: android/src/com/google/zxing/client/android/result/ProductResultHandler.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.zxing.client.result.ParsedResult;
 import com.google.zxing.client.result.ProductParsedResult;
 
-public class ProductResultHandler extends ResultHandler {
+public final class ProductResultHandler extends ResultHandler {
 
   private static final int[] mButtons = {
       R.string.button_product_search,

File: android/src/com/google/zxing/client/android/result/ResultHandlerFactory.java
Patch:
@@ -22,7 +22,7 @@
 import com.google.zxing.client.result.ParsedResultType;
 import com.google.zxing.client.result.ResultParser;
 
-public class ResultHandlerFactory {
+public final class ResultHandlerFactory {
 
   public static ResultHandler makeResultHandler(Activity activity, Result rawResult) {
     ParsedResult result = parseResult(rawResult);

File: android/src/com/google/zxing/client/android/result/SMSResultHandler.java
Patch:
@@ -22,7 +22,7 @@
 import com.google.zxing.client.result.ParsedResult;
 import com.google.zxing.client.result.SMSParsedResult;
 
-public class SMSResultHandler extends ResultHandler {
+public final class SMSResultHandler extends ResultHandler {
 
   private static final int[] mButtons = {
       R.string.button_sms,

File: android/src/com/google/zxing/client/android/result/TelResultHandler.java
Patch:
@@ -22,7 +22,7 @@
 import com.google.zxing.client.result.ParsedResult;
 import com.google.zxing.client.result.TelParsedResult;
 
-public class TelResultHandler extends ResultHandler {
+public final class TelResultHandler extends ResultHandler {
 
   private static final int[] mButtons = {
       R.string.button_dial,

File: android/src/com/google/zxing/client/android/result/TextResultHandler.java
Patch:
@@ -23,7 +23,7 @@
 /**
  * This class handles TextParsedResult as well as unknown formats.
  */
-public class TextResultHandler extends ResultHandler {
+public final class TextResultHandler extends ResultHandler {
 
   private static final int[] mButtons = {
       R.string.button_web_search,

File: android/src/com/google/zxing/client/android/result/URIResultHandler.java
Patch:
@@ -21,7 +21,7 @@
 import com.google.zxing.client.result.ParsedResult;
 import com.google.zxing.client.result.URIParsedResult;
 
-public class URIResultHandler extends ResultHandler {
+public final class URIResultHandler extends ResultHandler {
 
   private static final int[] mButtons = {
       R.string.button_open_browser,

File: androidtest/src/com/google/zxing/client/androidtest/CameraTestActivity.java
Patch:
@@ -75,7 +75,7 @@ protected void onPause() {
     CameraManager.get().closeDriver();
   }
 
-  public Handler mHandler = new Handler() {
+  public final Handler mHandler = new Handler() {
     public void handleMessage(Message message) {
       switch (message.what) {
         case R.id.auto_focus:

File: androidtest/src/com/google/zxing/client/androidtest/SaveThread.java
Patch:
@@ -36,8 +36,8 @@ final class SaveThread extends Thread {
 
   public Handler mHandler;
 
-  private CameraTestActivity mActivity;
-  private Rect mFramingRect;
+  private final CameraTestActivity mActivity;
+  private final Rect mFramingRect;
 
   SaveThread(CameraTestActivity activity, Rect framingRect) {
     mActivity = activity;

File: android/src/com/google/zxing/client/android/QRCodeEncoder.java
Patch:
@@ -30,7 +30,6 @@
 import org.apache.http.client.methods.HttpGet;
 
 import java.net.URI;
-import java.net.URLEncoder;
 
 public final class QRCodeEncoder {
 
@@ -163,7 +162,7 @@ public void run() {
       AndroidHttpClient client = null;
       try {
         String url = CHART_SERVER_URL + mPixelResolution + "x" + mPixelResolution + "&chl=" +
-          URLEncoder.encode(mContents, "UTF8");
+          mContents;
         URI uri = new URI("http", url, null);
         HttpGet get = new HttpGet(uri);
         client = AndroidHttpClient.newInstance(mUserAgent);

File: core/test/src/com/google/zxing/common/reedsolomon/ReedSolomonDecoderDataMatrixTestCase.java
Patch:
@@ -26,7 +26,8 @@ public final class ReedSolomonDecoderDataMatrixTestCase extends AbstractReedSolo
 
   private static final int[] DM_CODE_TEST = { 142, 164, 186 };
   private static final int[] DM_CODE_TEST_WITH_EC = { 142, 164, 186, 114, 25, 5, 88, 102 };
-  private static final int DM_CODE_CORRECTABLE = (DM_CODE_TEST_WITH_EC.length - DM_CODE_TEST.length) / 2;
+  private static final int DM_CODE_ECC_BYTES = DM_CODE_TEST_WITH_EC.length - DM_CODE_TEST.length;
+  private static final int DM_CODE_CORRECTABLE = DM_CODE_ECC_BYTES / 2;
 
   private final ReedSolomonDecoder dmRSDecoder = new ReedSolomonDecoder(GF256.DATA_MATRIX_FIELD);
 
@@ -71,7 +72,7 @@ public void testTooManyErrors() {
   }
 
   private void checkQRRSDecode(int[] received) throws ReedSolomonException {
-    dmRSDecoder.decode(received, 2 * DM_CODE_CORRECTABLE);
+    dmRSDecoder.decode(received, DM_CODE_ECC_BYTES);
     for (int i = 0; i < DM_CODE_TEST.length; i++) {
       assertEquals(received[i], DM_CODE_TEST[i]);
     }

File: core/test/src/com/google/zxing/common/reedsolomon/ReedSolomonDecoderQRCodeTestCase.java
Patch:
@@ -31,7 +31,8 @@ public final class ReedSolomonDecoderQRCodeTestCase extends AbstractReedSolomonT
       { 0x10, 0x20, 0x0C, 0x56, 0x61, 0x80, 0xEC, 0x11, 0xEC,
         0x11, 0xEC, 0x11, 0xEC, 0x11, 0xEC, 0x11, 0xA5, 0x24,
         0xD4, 0xC1, 0xED, 0x36, 0xC7, 0x87, 0x2C, 0x55 };
-  private static final int QR_CODE_CORRECTABLE = (QR_CODE_TEST_WITH_EC.length - QR_CODE_TEST.length) / 2;
+  private static final int QR_CODE_ECC_BYTES = QR_CODE_TEST_WITH_EC.length - QR_CODE_TEST.length;
+  private static final int QR_CODE_CORRECTABLE = QR_CODE_ECC_BYTES / 2;
 
   private final ReedSolomonDecoder qrRSDecoder = new ReedSolomonDecoder(GF256.QR_CODE_FIELD);
 
@@ -76,7 +77,7 @@ public void testTooManyErrors() {
   }
 
   private void checkQRRSDecode(int[] received) throws ReedSolomonException {
-    qrRSDecoder.decode(received, 2*QR_CODE_CORRECTABLE);
+    qrRSDecoder.decode(received, QR_CODE_ECC_BYTES);
     for (int i = 0; i < QR_CODE_TEST.length; i++) {
       assertEquals(received[i], QR_CODE_TEST[i]);
     }

File: core/src/com/google/zxing/datamatrix/decoder/Decoder.java
Patch:
@@ -118,7 +118,7 @@ private void correctErrors(byte[] codewordBytes, int numDataCodewords) throws Re
     }
     int numECCodewords = codewordBytes.length - numDataCodewords;
     try {
-      rsDecoder.decode(codewordsInts, numECCodewords, true);
+      rsDecoder.decode(codewordsInts, numECCodewords);
     } catch (ReedSolomonException rse) {
       throw new ReaderException(rse.toString());
     }

File: core/src/com/google/zxing/qrcode/decoder/Decoder.java
Patch:
@@ -118,7 +118,7 @@ private void correctErrors(byte[] codewordBytes, int numDataCodewords) throws Re
     }
     int numECCodewords = codewordBytes.length - numDataCodewords;
     try {
-      rsDecoder.decode(codewordsInts, numECCodewords, false);
+      rsDecoder.decode(codewordsInts, numECCodewords);
     } catch (ReedSolomonException rse) {
       throw new ReaderException(rse.toString());
     }

File: core/src/com/google/zxing/datamatrix/decoder/Decoder.java
Patch:
@@ -118,7 +118,7 @@ private void correctErrors(byte[] codewordBytes, int numDataCodewords) throws Re
     }
     int numECCodewords = codewordBytes.length - numDataCodewords;
     try {
-      rsDecoder.decode(codewordsInts, numECCodewords);
+      rsDecoder.decode(codewordsInts, numECCodewords, true);
     } catch (ReedSolomonException rse) {
       throw new ReaderException(rse.toString());
     }

File: core/src/com/google/zxing/qrcode/decoder/Decoder.java
Patch:
@@ -118,7 +118,7 @@ private void correctErrors(byte[] codewordBytes, int numDataCodewords) throws Re
     }
     int numECCodewords = codewordBytes.length - numDataCodewords;
     try {
-      rsDecoder.decode(codewordsInts, numECCodewords);
+      rsDecoder.decode(codewordsInts, numECCodewords, false);
     } catch (ReedSolomonException rse) {
       throw new ReaderException(rse.toString());
     }

File: core/test/src/com/google/zxing/common/reedsolomon/ReedSolomonDecoderQRCodeTestCase.java
Patch:
@@ -24,7 +24,7 @@
 /**
  * @author srowen@google.com (Sean Owen)
  */
-public final class ReedSolomonDecoderTestCase extends TestCase {
+public final class ReedSolomonDecoderQRCodeTestCase extends TestCase {
 
   /** See ISO 18004, Appendix I, from which this example is taken. */
   private static final int[] QR_CODE_TEST =
@@ -79,7 +79,7 @@ public void testTooManyErrors() {
   }
 
   private void checkQRRSDecode(int[] received) throws ReedSolomonException {
-    qrRSDecoder.decode(received, 2*QR_CODE_CORRECTABLE);
+    qrRSDecoder.decode(received, 2*QR_CODE_CORRECTABLE, false);
     for (int i = 0; i < QR_CODE_TEST.length; i++) {
       assertEquals(received[i], QR_CODE_TEST[i]);
     }

File: core/src/com/google/zxing/datamatrix/detector/Detector.java
Patch:
@@ -287,6 +287,7 @@ private int[] blackWhiteRange(int fixedDimension, int maxWhiteRun, int minDim, i
         }
       }
     }
+    start++;
 
     // Then try right/down
     int end = center;
@@ -305,6 +306,7 @@ private int[] blackWhiteRange(int fixedDimension, int maxWhiteRun, int minDim, i
         }
       }
     }
+    end--;
 
     if (end > start) {
       return new int[] { start, end };

File: android/src/com/google/zxing/client/android/SearchBookContentsActivity.java
Patch:
@@ -294,6 +294,7 @@ private String getCookie(String url) {
         } catch (IOException e) {
           Log.e(TAG, e.toString());
         }
+        client.close();
       }
       return cookie;
     }

File: android/src/com/google/zxing/client/android/result/ResultHandlerFactory.java
Patch:
@@ -31,7 +31,7 @@ public static ResultHandler makeResultHandler(Activity activity, Result rawResul
       return new AddressBookResultHandler(activity, result);
     } else if (type.equals(ParsedResultType.EMAIL_ADDRESS)) {
       return new EmailAddressResultHandler(activity, result);
-    } else if (type.equals(ParsedResultType.UPC)) {
+    } else if (type.equals(ParsedResultType.PRODUCT)) {
       return new UPCResultHandler(activity, result);
     } else if (type.equals(ParsedResultType.URI)) {
       return new URIResultHandler(activity, result);

File: core/src/com/google/zxing/client/result/ParsedResultType.java
Patch:
@@ -26,7 +26,7 @@ public final class ParsedResultType {
 
   public static final ParsedResultType ADDRESSBOOK = new ParsedResultType("ADDRESSBOOK");
   public static final ParsedResultType EMAIL_ADDRESS = new ParsedResultType("EMAIL_ADDRESS");
-  public static final ParsedResultType UPC = new ParsedResultType("UPC");
+  public static final ParsedResultType PRODUCT = new ParsedResultType("PRODUCT");
   public static final ParsedResultType URI = new ParsedResultType("URI");
   public static final ParsedResultType TEXT = new ParsedResultType("TEXT");
   public static final ParsedResultType ANDROID_INTENT = new ParsedResultType("ANDROID_INTENT");

File: core/src/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -68,7 +68,7 @@ public static ParsedResult parseResult(Result theResult) {
     } else if ((result = ISBNResultParser.parse(theResult)) != null) {
       // We depend on ISBN parsing coming before UPC, as it is a subset.
       return result;
-    } else if ((result = UPCResultParser.parse(theResult)) != null) {
+    } else if ((result = ProductResultParser.parse(theResult)) != null) {
       return result;
     }
     return new TextParsedResult(theResult.getText(), null);

File: core/src/com/google/zxing/oned/UPCEReader.java
Patch:
@@ -112,7 +112,7 @@ BarcodeFormat getBarcodeFormat() {
    * @param upce UPC-E code as string of digits
    * @return equivalent UPC-A code as string of digits
    */
-  private static String convertUPCEtoUPCA(String upce) {
+  public static String convertUPCEtoUPCA(String upce) {
     char[] upceChars = new char[6];
     upce.getChars(1, 7, upceChars, 0);
     StringBuffer result = new StringBuffer(12);

File: core/test/src/com/google/zxing/client/result/ParsedReaderResultTestCase.java
Patch:
@@ -142,6 +142,9 @@ public void testVEvent() {
     doTestResult("BEGIN:VEVENT\r\nSUMMARY:foo\r\nDTSTART:20080504\r\nEND:VEVENT",
         ParsedResultType.CALENDAR);
     doTestResult("BEGIN:VEVENT\r\nDTEND:20080505T\r\nEND:VEVENT", ParsedResultType.TEXT);
+    // Make sure illegal entries without newlines don't crash
+    doTestResult("BEGIN:VEVENTSUMMARY:EventDTSTART:20081030T122030ZDTEND:20081030T132030ZEND:VEVENT",
+        ParsedResultType.URI);
     doTestResult("BEGIN:VEVENT", ParsedResultType.URI); // See above note on why this is URI
   }
 

File: core/test/src/com/google/zxing/oned/EAN13BlackBox1TestCase.java
Patch:
@@ -30,7 +30,7 @@ public final class EAN13BlackBox1TestCase extends AbstractBlackBoxTestCase {
   public EAN13BlackBox1TestCase() {
     super(new File("test/data/blackbox/ean13-1"), new MultiFormatReader(), BarcodeFormat.EAN_13);
     addTest(28, 31, 0.0f);
-    addTest(26, 31, 180.0f);
+    addTest(25, 31, 180.0f);
   }
 
 }
\ No newline at end of file

File: android/src/com/android/barcodes/QRCodeEncoder.java
Patch:
@@ -20,7 +20,6 @@
 import android.content.Intent;
 import android.graphics.Bitmap;
 import android.graphics.BitmapFactory;
-import android.net.http.AndroidHttpClient;
 import android.os.Bundle;
 import android.os.Handler;
 import android.os.Message;

File: core/src/com/google/zxing/common/reedsolomon/GF256.java
Patch:
@@ -57,7 +57,7 @@ private GF256(int primitive) {
     for (int i = 0; i < 255; i++) {
       log_table[exp_table[i]] = i;
     }
-    // log[0] == 0 but this should never be used
+    // log_table[0] == 0 but this should never be used
     zero = new GF256Poly(this, new int[]{0});
     one = new GF256Poly(this, new int[]{1});
   }

File: core/src/com/google/zxing/client/result/BookmarkDoCoMoResultParser.java
Patch:
@@ -31,8 +31,8 @@ public static URIParsedResult parse(Result result) {
     if (rawText == null || !rawText.startsWith("MEBKM:")) {
       return null;
     }
-    String title = matchSingleDoCoMoPrefixedField("TITLE:", rawText);
-    String[] rawUri = matchDoCoMoPrefixedField("URL:", rawText);
+    String title = matchSingleDoCoMoPrefixedField("TITLE:", rawText, true);
+    String[] rawUri = matchDoCoMoPrefixedField("URL:", rawText, true);
     if (rawUri == null) {
       return null;
     }

File: core/src/com/google/zxing/client/result/EmailDoCoMoResultParser.java
Patch:
@@ -32,16 +32,16 @@ public static EmailAddressParsedResult parse(Result result) {
     if (rawText == null || !rawText.startsWith("MATMSG:")) {
       return null;
     }
-    String[] rawTo = matchDoCoMoPrefixedField("TO:", rawText);
+    String[] rawTo = matchDoCoMoPrefixedField("TO:", rawText, true);
     if (rawTo == null) {
       return null;
     }
     String to = rawTo[0];
     if (!isBasicallyValidEmailAddress(to)) {
       return null;
     }
-    String subject = matchSingleDoCoMoPrefixedField("SUB:", rawText);
-    String body = matchSingleDoCoMoPrefixedField("BODY:", rawText);
+    String subject = matchSingleDoCoMoPrefixedField("SUB:", rawText, false);
+    String body = matchSingleDoCoMoPrefixedField("BODY:", rawText, false);
     return new EmailAddressParsedResult(to, subject, body, "mailto:" + to);
   }
 

File: core/src/com/google/zxing/client/result/VEventResultParser.java
Patch:
@@ -41,9 +41,9 @@ public static CalendarParsedResult parse(Result result) {
     }
     rawText = rawText.substring(vEventStart + 14, vEventEnd); // skip over BEGIN:VEVENT\r\n at start
 
-    String summary = VCardResultParser.matchSingleVCardPrefixedField("SUMMARY", rawText);
-    String start = VCardResultParser.matchSingleVCardPrefixedField("DTSTART", rawText);
-    String end = VCardResultParser.matchSingleVCardPrefixedField("DTEND", rawText);
+    String summary = VCardResultParser.matchSingleVCardPrefixedField("SUMMARY", rawText, true);
+    String start = VCardResultParser.matchSingleVCardPrefixedField("DTSTART", rawText, true);
+    String end = VCardResultParser.matchSingleVCardPrefixedField("DTEND", rawText, true);
     try {
       return new CalendarParsedResult(summary, start, end, null, null, null);
     } catch (IllegalArgumentException iae) {

File: javase/src/com/google/zxing/client/j2se/CommandLineRunner.java
Patch:
@@ -97,8 +97,8 @@ private static boolean decode(URI uri, Hashtable<DecodeHintType, Object> hints)
     try {
       MonochromeBitmapSource source = new BufferedImageMonochromeBitmapSource(image);
       Result result = new MultiFormatReader().decode(source, hints);
-      System.out.println(uri.toString() + ": " + result.getText() + " format: " +
-          result.getBarcodeFormat());
+      System.out.println(uri.toString() + " (format: " + result.getBarcodeFormat() + "):\n" +
+          result.getText());
       return true;
     } catch (ReaderException e) {
       System.out.println(uri.toString() + ": No barcode found");

File: android/src/com/android/barcodes/ResultHandler.java
Patch:
@@ -85,6 +85,8 @@ public static int getActionButtonText(ParsedResultType type) {
             buttonText = R.string.button_open_browser;
         } else if (type.equals(ParsedResultType.EMAIL_ADDRESS)) {
             buttonText = R.string.button_email;
+        } else if (type.equals(ParsedResultType.SMS)) {
+          buttonText = R.string.button_sms;
         } else if (type.equals(ParsedResultType.UPC)) {
             buttonText = R.string.button_lookup_product;
         } else if (type.equals(ParsedResultType.TEL)) {

File: core/src/com/google/zxing/client/result/ParsedResultType.java
Patch:
@@ -37,6 +37,7 @@ public final class ParsedResultType {
   // "optional" types
   public static final ParsedResultType NDEF_SMART_POSTER = new ParsedResultType("NDEF_SMART_POSTER");
   public static final ParsedResultType MOBILETAG_RICH_WEB = new ParsedResultType("MOBILETAG_RICH_WEB");
+  public static final ParsedResultType ISBN = new ParsedResultType("ISBN");
 
   private final String name;
 

File: core/src/com/google/zxing/client/result/ResultParser.java
Patch:
@@ -65,6 +65,8 @@ public static ParsedResult parseResult(Result theResult) {
       return result;
     } else if ((result = URIResultParser.parse(theResult)) != null) {
       return result;
+    } else if ((result = ISBNResultParser.parse(theResult)) != null) {
+      return result;
     } else if ((result = UPCResultParser.parse(theResult)) != null) {
       return result;
     }

File: rim/src/com/google/zxing/client/rim/HistoryScreen.java
Patch:
@@ -25,7 +25,6 @@
 import net.rim.device.api.ui.Field;
 import net.rim.device.api.ui.FieldChangeListener;
 import net.rim.device.api.ui.Manager;
-import net.rim.device.api.ui.FieldLabelProvider;
 import net.rim.device.api.ui.component.ButtonField;
 import net.rim.device.api.ui.component.LabelField;
 import net.rim.device.api.ui.container.MainScreen;
@@ -65,7 +64,8 @@ private static class ButtonListener implements FieldChangeListener {
     public void fieldChanged(Field field, int context) {
       if (field instanceof ButtonField) {
         BrowserSession browserSession = Browser.getDefaultSession();
-        browserSession.displayPage(((FieldLabelProvider) field).getLabel());
+        // This cannot be weakened to FieldLabelProvider -- not a public API
+        browserSession.displayPage(((ButtonField) field).getLabel());
       }
     }
   }

File: core/test/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParserTestCase.java
Patch:
@@ -35,7 +35,7 @@ public void testSimpleByteMode() throws ReaderException {
     builder.write(0xA2, 8);
     builder.write(0xA3, 8);
     String result = DecodedBitStreamParser.decode(builder.toByteArray(), Version.getVersionForNumber(1));
-    assertEquals("���", result);
+    assertEquals("\u00a1\u00a2\u00a3", result); // this should be "���" if your editor character encoding matches mine!
   }
 
   public void testECI() throws ReaderException {
@@ -48,7 +48,7 @@ public void testECI() throws ReaderException {
     builder.write(0xA2, 8);
     builder.write(0xA3, 8);
     String result = DecodedBitStreamParser.decode(builder.toByteArray(), Version.getVersionForNumber(1));
-    assertEquals("���", result);
+    assertEquals("\u00ed\u00f3\u00fa", result); // should be like "���"
   }
 
   // TODO definitely need more tests here

File: javame/src/com/google/zxing/client/j2me/DefaultMultimediaManager.java
Patch:
@@ -45,6 +45,8 @@ class DefaultMultimediaManager implements MultimediaManager {
       // continue
     } catch (InstantiationException ie) {
       // continue
+    } catch (NoClassDefFoundError ncdfe) {
+      // continue
     }
   }
 

File: core/src/com/google/zxing/qrcode/detector/Detector.java
Patch:
@@ -74,6 +74,9 @@ public DetectorResult detect(Hashtable hints) throws ReaderException {
     FinderPattern bottomLeft = info.getBottomLeft();
 
     float moduleSize = calculateModuleSize(topLeft, topRight, bottomLeft);
+    if (moduleSize < 1.0f) {
+      throw new ReaderException("Module size too small");
+    }
     int dimension = computeDimension(topLeft, topRight, bottomLeft, moduleSize);
     Version provisionalVersion = Version.getProvisionalVersionForDimension(dimension);
     int modulesBetweenFPCenters = provisionalVersion.getDimensionForVersion() - 7;

File: javame/src/com/google/zxing/client/j2me/SnapshotThread.java
Patch:
@@ -36,7 +36,7 @@ final class SnapshotThread implements Runnable {
 
   private final ZXingMIDlet zXingMIDlet;
   private final Object waitLock;
-  private boolean done;
+  private volatile boolean done;
   private final MultimediaManager multimediaManager;
 
   SnapshotThread(ZXingMIDlet zXingMIDlet) {

File: core/src/com/google/zxing/common/GridSampler.java
Patch:
@@ -113,7 +113,7 @@ public abstract BitMatrix sampleGrid(MonochromeBitmapSource image,
    * @param points actual points in x1,y1,...,xn,yn form
    * @throws ReaderException if an endpoint is lies outside the image boundaries
    */
-  static void checkAndNudgePoints(MonochromeBitmapSource image, float[] points) throws ReaderException {
+  protected static void checkAndNudgePoints(MonochromeBitmapSource image, float[] points) throws ReaderException {
     int width = image.getWidth();
     int height = image.getHeight();
     // Check and nudge points from start until we see some that are OK:

File: core/src/com/google/zxing/client/result/CalendarParsedResult.java
Patch:
@@ -78,7 +78,8 @@ public String getTitle() {
   }
 
   public String getDisplayResult() {
-    StringBuffer result = new StringBuffer(summary);
+    StringBuffer result = new StringBuffer();
+    maybeAppend(summary, result);
     maybeAppend(start, result);
     maybeAppend(end, result);
     maybeAppend(location, result);

File: core/src/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -411,7 +411,7 @@ private int findRowSkip() {
           // difference in the x / y coordinates of the two centers.
           // This is the case where you find top left first. Draw it out.
           hasSkipped = true;
-          return (int) Math.abs(Math.abs(firstConfirmedCenter.getX() - center.getX()) -
+          return (int) (Math.abs(firstConfirmedCenter.getX() - center.getX()) -
               Math.abs(firstConfirmedCenter.getY() - center.getY()));
         }
       }

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -31,8 +31,8 @@ public QRCodeBlackBox2TestCase() {
     super(new File("test/data/blackbox/qrcode-2"), new MultiFormatReader(), BarcodeFormat.QR_CODE);
     addTest(10, 0.0f);
     addTest(6, 90.0f);
-    addTest(8, 180.0f);
-    addTest(2, 270.0f);
+    addTest(9, 180.0f);
+    addTest(7, 270.0f);
   }
 
 }
\ No newline at end of file

File: core/src/com/google/zxing/client/result/optional/NDEFRecord.java
Patch:
@@ -56,7 +56,7 @@ static NDEFRecord readRecord(byte[] bytes, int offset) {
 
     int payloadLength = bytes[offset + 2] & 0xFF;
 
-    String type = AbstractNDEFParsedResult.bytesToString(bytes, offset + 3, typeLength, "US-ASCII");
+    String type = AbstractNDEFResultParser.bytesToString(bytes, offset + 3, typeLength, "US-ASCII");
 
     byte[] payload = new byte[payloadLength];
     System.arraycopy(bytes, offset + 3 + typeLength, payload, 0, payloadLength);

File: core/src/com/google/zxing/oned/Code128Reader.java
Patch:
@@ -143,7 +143,7 @@ public final class Code128Reader extends AbstractOneDReader {
   };
 
   private static final int MAX_AVG_VARIANCE = (int) (PATTERN_MATCH_RESULT_SCALE_FACTOR * 0.1875f);
-  private static final int MAX_INDIVIDUAL_VARIANCE = (int) (PATTERN_MATCH_RESULT_SCALE_FACTOR * 0.25f);
+  private static final int MAX_INDIVIDUAL_VARIANCE = (int) (PATTERN_MATCH_RESULT_SCALE_FACTOR * 0.35f);
 
   private static final int CODE_SHIFT = 98;
 

File: core/test/src/com/google/zxing/common/FalsePositivesBlackBoxTestCase.java
Patch:
@@ -35,7 +35,7 @@
 public final class FalsePositivesBlackBoxTestCase extends AbstractBlackBoxTestCase {
 
   // This number should be reduced as we get better at rejecting false positives.
-  private static final int FALSE_POSITIVES_ALLOWED = 15;
+  private static final int FALSE_POSITIVES_ALLOWED = 4;
 
   // Use the multiformat reader to evaluate all decoders in the system.
   public FalsePositivesBlackBoxTestCase() {

File: core/test/src/com/google/zxing/oned/EAN8BlackBox1TestCase.java
Patch:
@@ -30,7 +30,7 @@ public final class EAN8BlackBox1TestCase extends AbstractBlackBoxTestCase {
   public EAN8BlackBox1TestCase() {
     super(new File("test/data/blackbox/ean8-1"), new MultiFormatReader(), BarcodeFormat.EAN_8);
     addTest(8, 0.0f);
-    addTest(7, 180.0f);
+    addTest(8, 180.0f);
   }
 
 }
\ No newline at end of file

File: android/src/com/google/zxing/client/android/RGBMonochromeBitmapSource.java
Patch:
@@ -63,7 +63,7 @@ public BitArray getBlackRow(int y, BitArray row, int startX, int getWidth) {
     // If the current decoder calculated the blackPoint based on one row, assume we're trying to
     // decode a 1D barcode, and apply some sharpening.
     // TODO: We may want to add a fifth parameter to request the amount of shapening to be done.
-    if (lastMethod == BlackPointEstimationMethod.ROW_SAMPLING) {
+    if (lastMethod.equals(BlackPointEstimationMethod.ROW_SAMPLING)) {
       int left = computeRGBLuminance(pixelRow[0]);
       int center = computeRGBLuminance(pixelRow[1]);
       for (int i = 1; i < getWidth - 1; i++) {

File: core/test/src/com/google/zxing/oned/EAN13BlackBox1TestCase.java
Patch:
@@ -29,8 +29,8 @@ public final class EAN13BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox1TestCase() {
     super(new File("test/data/blackbox/ean13-1"), new MultiFormatReader(), BarcodeFormat.EAN_13);
-    addTest(25, 0.0f);
-    addTest(18, 180.0f);
+    addTest(26, 0.0f);
+    addTest(24, 180.0f);
   }
 
 }
\ No newline at end of file

File: javase/src/com/google/zxing/client/j2se/BufferedImageMonochromeBitmapSource.java
Patch:
@@ -120,7 +120,7 @@ public BitArray getBlackRow(int y, BitArray row, int startX, int getWidth) {
     // If the current decoder calculated the blackPoint based on one row, assume we're trying to
     // decode a 1D barcode, and apply some sharpening.
     // TODO: We may want to add a fifth parameter to request the amount of shapening to be done.
-    if (lastMethod == BlackPointEstimationMethod.ROW_SAMPLING) {
+    if (lastMethod.equals(BlackPointEstimationMethod.ROW_SAMPLING)) {
       int left = computeRGBLuminance(pixelRow[0]);
       int center = computeRGBLuminance(pixelRow[1]);
       for (int i = 1; i < getWidth - 1; i++) {

File: javase/src/com/google/zxing/client/j2se/GUIRunner.java
Patch:
@@ -75,7 +75,7 @@ private void chooseImage() {
     File file = fileChooser.getSelectedFile();
     ImageIcon imageIcon;
     try {
-      imageIcon = new ImageIcon(file.toURL());
+      imageIcon = new ImageIcon(file.toURI().toURL());
     } catch (MalformedURLException mue) {
       throw new RuntimeException(mue);
     }

File: core/src/com/google/zxing/datamatrix/decoder/Version.java
Patch:
@@ -92,7 +92,7 @@ ECBlocks getECBlocks() {
    * <p>Deduces version information from Data Matrix dimensions.</p>
    *
    * @param numRows Number of rows in modules
-   * @param numRows Number of columns in modules
+   * @param numColumns Number of columns in modules
    * @return {@link Version} for a Data Matrix Code of those dimensions
    * @throws ReaderException if dimensions do correspond to a valid Data Matrix size
    */

File: core/src/com/google/zxing/qrcode/detector/FinderPattern.java
Patch:
@@ -21,7 +21,7 @@
 /**
  * <p>Encapsulates a finder pattern, which are the three square patterns found in
  * the corners of QR Codes. It also encapsulates a count of similar finder patterns,
- * as a convenience to {@link FinderPatternFinder}'s bookkeeping.</p>
+ * as a convenience to the finder's bookkeeping.</p>
  *
  * @author srowen@google.com (Sean Owen)
  */

File: android/src/com/google/zxing/client/android/CameraManager.java
Patch:
@@ -272,7 +272,7 @@ private void calculateStillResolution() {
    */
   private void calculatePreviewResolution() {
     if (previewResolution == null) {
-      int previewHeight = (int) (stillResolution.x * stillMultiplier * 1.8f);
+      int previewHeight = (int) (stillResolution.x * stillMultiplier * 1.5f);
       int previewWidth = previewHeight * screenResolution.x / screenResolution.y;
       previewWidth = ((previewWidth + 7) >> 3) << 3;
       if (previewWidth > cameraResolution.x) previewWidth = cameraResolution.x;

File: android/src/com/google/zxing/client/android/ResultHandler.java
Patch:
@@ -87,6 +87,9 @@ private static Intent resultToIntent(ParsedReaderResult result) {
     } else if (type.equals(ParsedReaderResultType.SMS)) {
       SMSParsedResult smsResult = (SMSParsedResult) result;
       intent = new Intent(Intent.SENDTO_ACTION, Uri.parse(smsResult.getSMSURI()));
+    } else if (type.equals(ParsedReaderResultType.SMS)) {
+      SMSParsedResult smsResult = (SMSParsedResult) result;
+      intent = new Intent(Intent.SENDTO_ACTION, Uri.parse(smsResult.getSMSURI()));
     } else if (type.equals(ParsedReaderResultType.TEL)) {
       TelParsedResult telResult = (TelParsedResult) result;
       intent = new Intent(Intent.DIAL_ACTION, Uri.parse("tel:" + telResult.getNumber()));

File: android/src/com/google/zxing/client/android/ResultHandler.java
Patch:
@@ -42,7 +42,7 @@
  * @author srowen@google.com (Sean Owen)
  * @author dswitkin@google.com (Daniel Switkin)
  */
-final class ResultHandler implements Button.OnClickListenear {
+final class ResultHandler implements Button.OnClickListener {
 
   private static final String TAG = "ResultHandler";
 

File: android-m3/src/com/google/zxing/client/android/CameraManager.java
Patch:
@@ -247,7 +247,7 @@ private void calculateStillResolution() {
    */
   private void calculatePreviewResolution() {
     if (previewResolution == null) {
-      int previewHeight = (int) (stillResolution.x * stillMultiplier * 1.8f);
+      int previewHeight = (int) (stillResolution.x * stillMultiplier * 1.5f);
       int previewWidth = previewHeight * screenResolution.x / screenResolution.y;
       previewWidth = ((previewWidth + 7) >> 3) << 3;
       if (previewWidth > cameraResolution.x) previewWidth = cameraResolution.x;

File: core/test/src/com/google/zxing/oned/EAN13BlackBox2TestCase.java
Patch:
@@ -28,7 +28,7 @@
 public final class EAN13BlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox2TestCase() {
-    super(new File("test/data/blackbox/ean13-2"), new MultiFormatReader(), 0, BarcodeFormat.EAN_13);
+    super(new File("test/data/blackbox/ean13-2"), new MultiFormatReader(), 1, BarcodeFormat.EAN_13);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/oned/UPCABlackBox1TestCase.java
Patch:
@@ -28,7 +28,7 @@
 public final class UPCABlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public UPCABlackBox1TestCase() {
-    super(new File("test/data/blackbox/upca-1"), new MultiFormatReader(), 14, BarcodeFormat.UPC_A);
+    super(new File("test/data/blackbox/upca-1"), new MultiFormatReader(), 15, BarcodeFormat.UPC_A);
   }
 
 }
\ No newline at end of file

File: android-m3/src/com/google/zxing/client/android/BarcodeReaderCaptureActivity.java
Patch:
@@ -110,6 +110,8 @@ public boolean onKeyDown(int keyCode, KeyEvent event) {
       cameraThread.setDecodeQRMode();
     } else if (keyCode == KeyEvent.KEYCODE_S) {
       cameraManager.setUsePreviewForDecode(false);
+    } else if (keyCode == KeyEvent.KEYCODE_T) {
+      cameraThread.toggleTracing();
     } else if (keyCode == KeyEvent.KEYCODE_U) {
       cameraThread.setDecode1DMode();
     } else {

File: android-m3/src/com/google/zxing/client/android/BarcodeReaderCaptureActivity.java
Patch:
@@ -91,8 +91,7 @@ protected void onResume() {
   protected void onPause() {
     super.onPause();
     if (cameraThread != null) {
-      Message quit = Message.obtain(cameraThread.handler, R.id.quit);
-      quit.sendToTarget();
+      cameraThread.quitSynchronously();
       cameraThread = null;
     }
     cameraManager.closeDriver();

File: core/src/com/google/zxing/client/result/NDEFURIParsedResult.java
Patch:
@@ -26,7 +26,7 @@
  */
 public final class NDEFURIParsedResult extends AbstractNDEFParsedResult {
 
-  private static final String[] URI_PREFIXES = new String[] {
+  private static final String[] URI_PREFIXES = {
       null,
       "http://www.",
       "https://www.",

File: core/src/com/google/zxing/qrcode/decoder/DataMask.java
Patch:
@@ -32,7 +32,7 @@ abstract class DataMask {
   /**
    * See ISO 18004:2006 6.8.1
    */
-  private static final DataMask[] DATA_MASKS = new DataMask[]{
+  private static final DataMask[] DATA_MASKS = {
       new DataMask000(),
       new DataMask001(),
       new DataMask010(),

File: core/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -34,7 +34,7 @@ final class DecodedBitStreamParser {
   /**
    * See ISO 18004:2006, 6.4.4 Table 5
    */
-  private static final char[] ALPHANUMERIC_CHARS = new char[]{
+  private static final char[] ALPHANUMERIC_CHARS = {
       '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B',
       'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N',
       'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',

File: core/src/com/google/zxing/qrcode/decoder/ErrorCorrectionLevel.java
Patch:
@@ -45,7 +45,7 @@ final class ErrorCorrectionLevel {
    */
   static final ErrorCorrectionLevel H = new ErrorCorrectionLevel(3);
 
-  private static final ErrorCorrectionLevel[] FOR_BITS = new ErrorCorrectionLevel[]{M, L, H, Q};
+  private static final ErrorCorrectionLevel[] FOR_BITS = {M, L, H, Q};
 
   private final int ordinal;
 

File: core/src/com/google/zxing/qrcode/decoder/FormatInformation.java
Patch:
@@ -33,7 +33,7 @@ final class FormatInformation {
   /**
    * See ISO 18004:2006, Annex C, Table C.1
    */
-  private static final int[][] FORMAT_INFO_DECODE_LOOKUP = new int[][]{
+  private static final int[][] FORMAT_INFO_DECODE_LOOKUP = {
       {0x5412, 0x00},
       {0x5125, 0x01},
       {0x5E7C, 0x02},

File: core/src/com/google/zxing/qrcode/decoder/Version.java
Patch:
@@ -30,7 +30,7 @@ public final class Version {
    * See ISO 18004:2006 Annex D.
    * Element i represents the raw version bits that specify version i + 7
    */
-  private static final int[] VERSION_DECODE_INFO = new int[]{
+  private static final int[] VERSION_DECODE_INFO = {
       0x07C94, 0x085BC, 0x09A99, 0x0A4D3, 0x0BBF6,
       0x0C762, 0x0D847, 0x0E60D, 0x0F928, 0x10B78,
       0x1145D, 0x12A17, 0x13532, 0x149A6, 0x15683,

File: core/test/src/com/google/zxing/common/BitSourceTestCase.java
Patch:
@@ -24,7 +24,7 @@
 public final class BitSourceTestCase extends TestCase {
 
   public void testSource() {
-    byte[] bytes = new byte[]{(byte) 1, (byte) 2, (byte) 3, (byte) 4, (byte) 5};
+    byte[] bytes = {(byte) 1, (byte) 2, (byte) 3, (byte) 4, (byte) 5};
     BitSource source = new BitSource(bytes);
     assertEquals(40, source.available());
     assertEquals(0, source.readBits(1));

File: core/test/src/com/google/zxing/common/PerspectiveTransformTestCase.java
Patch:
@@ -49,7 +49,7 @@ public void testQuadrilateralToQuadrilateral() {
   }
 
   private static void assertPointEquals(float expectedX, float expectedY, float sourceX, float sourceY, PerspectiveTransform pt) {
-    float[] points = new float[]{sourceX, sourceY};
+    float[] points = {sourceX, sourceY};
     pt.transformPoints(points);
     assertEquals(expectedX, points[0], EPSILON);
     assertEquals(expectedY, points[1], EPSILON);

File: android/src/com/google/zxing/client/android/ResultHandler.java
Patch:
@@ -81,7 +81,7 @@ private static Intent resultToIntent(ParsedReaderResult result) {
       putExtra(intent, "body", emailResult.getBody());
     } else if (type.equals(ParsedReaderResultType.EMAIL_ADDRESS)) {
       EmailAddressParsedResult emailResult = (EmailAddressParsedResult) result;
-      intent = new Intent(Intent.SENDTO_ACTION, Uri.parse(emailResult.getEmailAddress()));
+      intent = new Intent(Intent.SENDTO_ACTION, Uri.parse("mailto:" + emailResult.getEmailAddress()));
     } else if (type.equals(ParsedReaderResultType.TEL)) {
       TelParsedResult telResult = (TelParsedResult) result;
       intent = new Intent(Intent.DIAL_ACTION, Uri.parse("tel:" + telResult.getNumber()));

File: android-m3/src/com/google/zxing/client/android/ResultHandler.java
Patch:
@@ -109,7 +109,7 @@ private static Intent resultToIntent(ParsedReaderResult result) {
     } else if (type.equals(ParsedReaderResultType.GEO)) {
       GeoParsedResult geoResult = (GeoParsedResult) result;
       try {
-        ContentURI geoURI = new ContentURI("geo:" + geoResult.getGeoURI());
+        ContentURI geoURI = new ContentURI(geoResult.getGeoURI());
         Log.v(TAG, "Created geo URI: " + geoURI.toString());
         intent = new Intent(Intent.VIEW_ACTION, geoURI);
       } catch (URISyntaxException e) {

File: core/src/com/google/zxing/client/result/GeoParsedResult.java
Patch:
@@ -68,7 +68,7 @@ public static GeoParsedResult parse(Result result) {
       longitude = Float.parseFloat(rawText.substring(latitudeEnd + 1, longitudeEnd));
       altitude = Float.parseFloat(rawText.substring(longitudeEnd + 1));
     }
-    return new GeoParsedResult(rawText, latitude, longitude, altitude);
+    return new GeoParsedResult("geo:" + rawText, latitude, longitude, altitude);
   }
 
   public String getGeoURI() {

File: core/src/com/google/zxing/client/result/AddressBookAUParsedResult.java
Patch:
@@ -54,15 +54,15 @@ public static AddressBookAUParsedResult parse(Result result) {
     String[] names = matchMultipleValuePrefix("NAME", 2, rawText);
     String[] phoneNumbers = matchMultipleValuePrefix("TEL", 3, rawText);
     String[] emails = matchMultipleValuePrefix("MAIL", 3, rawText);
-    String note = AbstractDoCoMoParsedResult.matchSinglePrefixedField("MEMORY", rawText, '\r');
-    String address = AbstractDoCoMoParsedResult.matchSinglePrefixedField("ADD", rawText, '\r');
+    String note = AbstractDoCoMoParsedResult.matchSinglePrefixedField("MEMORY:", rawText, '\r');
+    String address = AbstractDoCoMoParsedResult.matchSinglePrefixedField("ADD:", rawText, '\r');
     return new AddressBookAUParsedResult(names, phoneNumbers, emails, note, address);
   }
 
   private static String[] matchMultipleValuePrefix(String prefix, int max, String rawText) {
     Vector values = null;
     for (int i = 1; i <= max; i++) {
-      String value = AbstractDoCoMoParsedResult.matchSinglePrefixedField(prefix + i, rawText, '\r');
+      String value = AbstractDoCoMoParsedResult.matchSinglePrefixedField(prefix + i + ':', rawText, '\r');
       if (value == null) {
         break;
       }

File: core/test/src/com/google/zxing/common/AbstractBlackBoxTestCase.java
Patch:
@@ -108,7 +108,7 @@ public void testBlackBox() throws IOException {
       if (passed) {
         passedCount++;
       } else {
-        System.out.println("Mismatch: expected '" + expectedText + "' but got '" + resultText + '\'');
+        fail("Mismatch: expected '" + expectedText + "' but got '" + resultText + '\'');
       }
 
       // Try "try harder" mode

File: core/src/com/google/zxing/DecodeHintType.java
Patch:
@@ -56,7 +56,6 @@ public final class DecodeHintType {
    * Skip the first n barcodes found. Currently applies only to 1D formats. This
    * enables a caller to repeatedly decode and find multiple barcodes. Maps
    * to an {@link Integer}.
-   * @deprecated
    */
   public static final DecodeHintType SKIP_N_BARCODES = new DecodeHintType();
 

File: android/src/com/google/zxing/client/android/RGBMonochromeBitmapSource.java
Patch:
@@ -19,6 +19,7 @@
 import android.graphics.Bitmap;
 import com.google.zxing.BlackPointEstimationMethod;
 import com.google.zxing.MonochromeBitmapSource;
+import com.google.zxing.ReaderException;
 import com.google.zxing.common.BitArray;
 import com.google.zxing.common.BlackPointEstimator;
 
@@ -77,7 +78,7 @@ public int getWidth() {
     return image.width();
   }
 
-  public void estimateBlackPoint(BlackPointEstimationMethod method, int argument) {
+  public void estimateBlackPoint(BlackPointEstimationMethod method, int argument) throws ReaderException {
     if (!method.equals(lastMethod) || argument != lastArgument) {
       int width = image.width();
       int height = image.height();

File: android/src/com/google/zxing/client/android/YUVMonochromeBitmapSource.java
Patch:
@@ -19,6 +19,7 @@
 import android.graphics.Bitmap;
 import com.google.zxing.BlackPointEstimationMethod;
 import com.google.zxing.MonochromeBitmapSource;
+import com.google.zxing.ReaderException;
 import com.google.zxing.common.BitArray;
 import com.google.zxing.common.BlackPointEstimator;
 
@@ -79,7 +80,7 @@ public int getWidth() {
     return image.width();
   }
 
-  public void estimateBlackPoint(BlackPointEstimationMethod method, int argument) {
+  public void estimateBlackPoint(BlackPointEstimationMethod method, int argument) throws ReaderException {
     if (!method.equals(lastMethod) || argument != lastArgument) {
       int width = image.width();
       int height = image.height();

File: javame/src/com/google/zxing/client/j2me/LCDUIImageMonochromeBitmapSource.java
Patch:
@@ -18,6 +18,7 @@
 
 import com.google.zxing.BlackPointEstimationMethod;
 import com.google.zxing.MonochromeBitmapSource;
+import com.google.zxing.ReaderException;
 import com.google.zxing.common.BitArray;
 import com.google.zxing.common.BlackPointEstimator;
 
@@ -77,7 +78,7 @@ public int getWidth() {
     return width;
   }
 
-  public void estimateBlackPoint(BlackPointEstimationMethod method, int argument) {
+  public void estimateBlackPoint(BlackPointEstimationMethod method, int argument) throws ReaderException {
     if (!method.equals(lastMethod) || argument != lastArgument) {
       int[] histogram = new int[LUMINANCE_BUCKETS];
       float biasTowardsWhite = 1.0f;

File: core/src/com/google/zxing/client/result/ParsedReaderResultType.java
Patch:
@@ -35,6 +35,9 @@ public final class ParsedReaderResultType {
   public static final ParsedReaderResultType TEXT = new ParsedReaderResultType("TEXT");
   public static final ParsedReaderResultType ANDROID_INTENT = new ParsedReaderResultType("ANDROID_INTENT"); 
   public static final ParsedReaderResultType GEO = new ParsedReaderResultType("GEO");
+  // TODO later, add the NDEF types to those actually processed by the clients
+  public static final ParsedReaderResultType NDEF_TEXT = new ParsedReaderResultType("NDEF_TEXT");
+  public static final ParsedReaderResultType NDEF_URI = new ParsedReaderResultType("NDEF_URI");
 
   private final String name;
 

File: core/src/com/google/zxing/client/result/ParsedReaderResult.java
Patch:
@@ -21,7 +21,7 @@
 /**
  * <p>Abstract class representing the result of decoding a barcode, as more than
  * a String -- as some type of structured data. This might be a subclass which represents
- * a URL, or an e-mail address. {@link #parseReaderResult(String)} will turn a raw
+ * a URL, or an e-mail address. {@link #parseReaderResult(Result)} will turn a raw
  * decoded string into the most appropriate type of structured representation.</p>
  *
  * <p>Thanks to Jeff Griffin for proposing rewrite of these classes that relies less

File: core/test/src/com/google/zxing/oned/EAN8BlackBox1TestCase.java
Patch:
@@ -28,7 +28,7 @@
 public final class EAN8BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public EAN8BlackBox1TestCase() {
-    super(new File("test/data/blackbox/ean8-1"), new MultiFormatReader(), 0.66, BarcodeFormat.EAN_8);
+    super(new File("test/data/blackbox/ean8-1"), new MultiFormatReader(), 1.0, BarcodeFormat.EAN_8);
   }
 
 }
\ No newline at end of file

File: android/src/com/google/zxing/client/android/AndroidIntentParsedResult.java
Patch:
@@ -42,6 +42,8 @@ public static AndroidIntentParsedResult parse(String rawText) {
       return new AndroidIntentParsedResult(Intent.getIntent(rawText));
     } catch (URISyntaxException urise) {
       return null;
+    } catch (IllegalArgumentException iae) {
+      return null;
     }
   }
 

File: android/src/com/google/zxing/client/android/ResultHandler.java
Patch:
@@ -119,6 +119,8 @@ public void handleMessage(Message message) {
         } catch (URISyntaxException e) {
           return;
         }
+      } else if (type.equals(ParsedReaderResultType.ANDROID_INTENT)) {
+        intent = ((AndroidIntentParsedResult) result).getIntent();
       }
       if (intent != null) {
         captureActivity.startActivity(intent);

File: android/src/com/google/zxing/client/android/YUVMonochromeBitmapSource.java
Patch:
@@ -118,7 +118,7 @@ public MonochromeBitmapSource rotateCounterClockwise() {
     throw new IllegalStateException("Rotate not supported");
   }
 
-  public boolean isRotatedSupported() {
+  public boolean isRotateSupported() {
     return false;
   }
 

File: core/src/com/google/zxing/MonochromeBitmapSource.java
Patch:
@@ -93,6 +93,6 @@ public interface MonochromeBitmapSource {
    * @return true iff rotation is supported
    * @see #rotateCounterClockwise()
    */
-  boolean isRotatedSupported();
+  boolean isRotateSupported();
 
 }

File: core/src/com/google/zxing/oned/AbstractOneDReader.java
Patch:
@@ -43,7 +43,7 @@ public final Result decode(MonochromeBitmapSource image, Hashtable hints) throws
     try {
       return doDecode(image, hints, tryHarder);
     } catch (ReaderException re) {
-      if (tryHarder && image.isRotatedSupported()) {
+      if (tryHarder && image.isRotateSupported()) {
         MonochromeBitmapSource rotatedImage = image.rotateCounterClockwise();
         return doDecode(rotatedImage, hints, tryHarder);        
       } else {

File: javame/src/com/google/zxing/client/j2me/LCDUIImageMonochromeBitmapSource.java
Patch:
@@ -112,7 +112,7 @@ public MonochromeBitmapSource rotateCounterClockwise() {
     throw new IllegalStateException("Rotate not supported");
   }
 
-  public boolean isRotatedSupported() {
+  public boolean isRotateSupported() {
     return false;
   }
 

File: core/src/com/google/zxing/MultiFormatReader.java
Patch:
@@ -37,7 +37,7 @@ public Result decode(MonochromeBitmapSource image) throws ReaderException {
 
   public Result decode(MonochromeBitmapSource image, Hashtable hints) throws ReaderException {
 
-    Hashtable possibleFormats = hints == null ? null : (Hashtable) hints.get(DecodeHintType.POSSIBLE_FORMATS);
+    Vector possibleFormats = hints == null ? null : (Vector) hints.get(DecodeHintType.POSSIBLE_FORMATS);
     Vector readers = new Vector();
     if (possibleFormats != null) {
       if (possibleFormats.contains(BarcodeFormat.UPC_A) ||

File: core/src/com/google/zxing/oned/MultiFormatOneDReader.java
Patch:
@@ -33,7 +33,7 @@ public final class MultiFormatOneDReader extends AbstractOneDReader {
 
   public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws ReaderException {
 
-    Hashtable possibleFormats = hints == null ? null : (Hashtable) hints.get(DecodeHintType.POSSIBLE_FORMATS);
+    Vector possibleFormats = hints == null ? null : (Vector) hints.get(DecodeHintType.POSSIBLE_FORMATS);
     Vector readers = new Vector();
     if (possibleFormats != null) {
       if (possibleFormats.contains(BarcodeFormat.EAN_13) ||

File: core/src/com/google/zxing/oned/MultiFormatUPCEANReader.java
Patch:
@@ -35,7 +35,7 @@
 public final class MultiFormatUPCEANReader extends AbstractOneDReader {
 
   public Result decodeRow(int rowNumber, BitArray row, Hashtable hints) throws ReaderException {
-    Hashtable possibleFormats = hints == null ? null : (Hashtable) hints.get(DecodeHintType.POSSIBLE_FORMATS);
+    Vector possibleFormats = hints == null ? null : (Vector) hints.get(DecodeHintType.POSSIBLE_FORMATS);
     Vector readers = new Vector();
     if (possibleFormats != null) {
       if (possibleFormats.contains(BarcodeFormat.EAN_13)) {

File: core/src/com/google/zxing/qrcode/QRCodeReader.java
Patch:
@@ -16,6 +16,7 @@
 
 package com.google.zxing.qrcode;
 
+import com.google.zxing.BarcodeFormat;
 import com.google.zxing.DecodeHintType;
 import com.google.zxing.MonochromeBitmapSource;
 import com.google.zxing.Reader;
@@ -63,7 +64,7 @@ public Result decode(MonochromeBitmapSource image, Hashtable hints)
       text = decoder.decode(result.getBits());
       points = result.getPoints();
     }
-    return new Result(text, points);
+    return new Result(text, points, BarcodeFormat.QR_CODE);
   }
 
   /**

File: core/test/src/com/google/zxing/oned/Code128BlackBox1TestCase.java
Patch:
@@ -16,6 +16,7 @@
 
 package com.google.zxing.oned;
 
+import com.google.zxing.BarcodeFormat;
 import com.google.zxing.MultiFormatReader;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
@@ -27,7 +28,7 @@
 public final class Code128BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public Code128BlackBox1TestCase() {
-    super(new File("test/data/blackbox/code128-1"), new MultiFormatReader(), 1.0);
+    super(new File("test/data/blackbox/code128-1"), new MultiFormatReader(), 1.0, BarcodeFormat.CODE_128);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/oned/Code39BlackBox1TestCase.java
Patch:
@@ -17,6 +17,7 @@
 package com.google.zxing.oned;
 
 import com.google.zxing.MultiFormatReader;
+import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 import java.io.File;
@@ -27,7 +28,7 @@
 public final class Code39BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public Code39BlackBox1TestCase() {
-    super(new File("test/data/blackbox/code39-1"), new MultiFormatReader(), 1.0);
+    super(new File("test/data/blackbox/code39-1"), new MultiFormatReader(), 1.0, BarcodeFormat.CODE_39);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/oned/Code39ExtendedBlackBox2TestCase.java
Patch:
@@ -17,6 +17,7 @@
 package com.google.zxing.oned;
 
 import com.google.zxing.common.AbstractBlackBoxTestCase;
+import com.google.zxing.BarcodeFormat;
 
 import java.io.File;
 
@@ -26,7 +27,7 @@
 public final class Code39ExtendedBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public Code39ExtendedBlackBox2TestCase() {
-    super(new File("test/data/blackbox/code39-2"), new Code39Reader(false, true), 1.0);
+    super(new File("test/data/blackbox/code39-2"), new Code39Reader(false, true), 1.0, BarcodeFormat.CODE_39);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/oned/EAN13BlackBox1TestCase.java
Patch:
@@ -17,6 +17,7 @@
 package com.google.zxing.oned;
 
 import com.google.zxing.MultiFormatReader;
+import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 import java.io.File;
@@ -27,7 +28,7 @@
 public final class EAN13BlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public EAN13BlackBox1TestCase() {
-    super(new File("test/data/blackbox/ean13-1"), new MultiFormatReader(), 0.66);
+    super(new File("test/data/blackbox/ean13-1"), new MultiFormatReader(), 0.66, BarcodeFormat.EAN_13);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/oned/UPCABlackBox1TestCase.java
Patch:
@@ -17,6 +17,7 @@
 package com.google.zxing.oned;
 
 import com.google.zxing.MultiFormatReader;
+import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 import java.io.File;
@@ -27,7 +28,7 @@
 public final class UPCABlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public UPCABlackBox1TestCase() {
-    super(new File("test/data/blackbox/upca-1"), new MultiFormatReader(), 0.5);
+    super(new File("test/data/blackbox/upca-1"), new MultiFormatReader(), 0.5, BarcodeFormat.UPC_A);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox1TestCase.java
Patch:
@@ -17,6 +17,7 @@
 package com.google.zxing.qrcode;
 
 import com.google.zxing.MultiFormatReader;
+import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 import java.io.File;
@@ -27,7 +28,7 @@
 public final class QRCodeBlackBox1TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox1TestCase() {
-    super(new File("test/data/blackbox/qrcode-1"), new MultiFormatReader(), 0.5);
+    super(new File("test/data/blackbox/qrcode-1"), new MultiFormatReader(), 0.5, BarcodeFormat.QR_CODE);
   }
 
 }
\ No newline at end of file

File: core/test/src/com/google/zxing/qrcode/QRCodeBlackBox2TestCase.java
Patch:
@@ -17,6 +17,7 @@
 package com.google.zxing.qrcode;
 
 import com.google.zxing.MultiFormatReader;
+import com.google.zxing.BarcodeFormat;
 import com.google.zxing.common.AbstractBlackBoxTestCase;
 
 import java.io.File;
@@ -27,7 +28,7 @@
 public final class QRCodeBlackBox2TestCase extends AbstractBlackBoxTestCase {
 
   public QRCodeBlackBox2TestCase() {
-    super(new File("test/data/blackbox/qrcode-2"), new MultiFormatReader(), 1.0);
+    super(new File("test/data/blackbox/qrcode-2"), new MultiFormatReader(), 1.0, BarcodeFormat.QR_CODE);
   }
 
 }
\ No newline at end of file

File: core/src/com/google/zxing/oned/AbstractUPCEANReader.java
Patch:
@@ -207,6 +207,8 @@ protected static int[] findGuardPattern(BitArray row, int rowOffset, boolean whi
           for (int y = 2; y < patternLength; y++) {
             counters[y - 2] = counters[y];
           }
+          counters[patternLength - 2] = 0;
+          counters[patternLength - 1] = 0;
           counterPosition--;
         } else {
           counterPosition++;

File: core/src/com/google/zxing/oned/Code128Reader.java
Patch:
@@ -196,6 +196,8 @@ private static int[] findStartPattern(BitArray row) throws ReaderException {
           for (int y = 2; y < patternLength; y++) {
             counters[y - 2] = counters[y];
           }
+          counters[patternLength - 2] = 0;
+          counters[patternLength - 1] = 0;
           counterPosition--;
         } else {
           counterPosition++;

File: core/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -217,7 +217,7 @@ private static String guessEncoding(byte[] bytes) {
         int nextValue = bytes[i + 1] & 0xFF;
         if ((value & 0x1) == 0) {
           // if even,
-          if (nextValue >= 0x9F && nextValue <= 0x7C) {
+          if (nextValue >= 0x9F && nextValue <= 0xFC) {
             return SHIFT_JIS;
           }
         } else {

File: core/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -217,11 +217,11 @@ private static String guessEncoding(byte[] bytes) {
         int nextValue = bytes[i + 1] & 0xFF;
         if ((value & 0x1) == 0) {
           // if even,
-          if (nextValue >= 0x40 && nextValue <= 0x9E) {
+          if (nextValue >= 0x9F && nextValue <= 0x7C) {
             return SHIFT_JIS;
           }
         } else {
-          if (nextValue >= 0x9F && nextValue <= 0x7C) {
+          if (nextValue >= 0x40 && nextValue <= 0x9E) {
             return SHIFT_JIS;
           }
         }

File: core/src/com/google/zxing/qrcode/decoder/DecodedBitStreamParser.java
Patch:
@@ -114,7 +114,7 @@ private static void decodeKanjiSegment(BitSource bits,
     try {
       result.append(new String(buffer, "Shift_JIS"));
     } catch (UnsupportedEncodingException uee) {
-      throw new ReaderException("Can't decode SHIFT_JIS string: " + uee);
+      throw new ReaderException("SHIFT_JIS encoding is not supported on this device");
     }
   }
 

File: javame/src/com/google/zxing/client/j2me/AdvancedMultimediaManager.java
Patch:
@@ -36,7 +36,7 @@
 final class AdvancedMultimediaManager {
 
   private static final int NO_ZOOM = 100;
-  private static final int MAX_ZOOM = 250;
+  private static final int MAX_ZOOM = 200;
 
   private AdvancedMultimediaManager() {
     // do nothing

File: core/src/com/google/zxing/qrcode/detector/FinderPatternFinder.java
Patch:
@@ -226,7 +226,7 @@ private float crossCheckVertical(int startI, int centerJ, int maxCount) {
       stateCount[0]++;
       i--;
     }
-    if (i < 0 || stateCount[0] > maxCount) {
+    if (stateCount[0] > maxCount) {
       return Float.NaN;
     }
 
@@ -287,7 +287,7 @@ private float crossCheckHorizontal(int startJ, int centerI, int maxCount) {
       stateCount[0]++;
       j--;
     }
-    if (j < 0 || stateCount[0] > maxCount) {
+    if (stateCount[0] > maxCount) {
       return Float.NaN;
     }
 

File: core/src/com/google/zxing/qrcode/detector/AlignmentPatternFinder.java
Patch:
@@ -99,7 +99,7 @@ AlignmentPattern find() throws ReaderException {
       // Burn off leading white pixels before anything else; if we start in the middle of
       // a white run, it doesn't make sense to count its length, since we don't know if the
       // white run continued to the left of the start point
-      while (!luminanceRow.get(j - startX) && j < maxJ) {
+      while (j < maxJ && !luminanceRow.get(j - startX)) {
         j++;
       }
       while (j < maxJ) {

File: core-ext/src/com/google/zxing/client/result/ParsedReaderResultType.java
Patch:
@@ -26,6 +26,7 @@ public enum ParsedReaderResultType {
   BOOKMARK(BookmarkDoCoMoResult.class),
   ADDRESSBOOK(AddressBookDoCoMoResult.class),
   EMAIL(EmailDoCoMoResult.class),
+  UPC(UPCParsedResult.class),
   URI(URIParsedResult.class),
   TEXT(TextParsedResult.class);
 

File: core/src/com/google/zxing/qrcode/detector/DefaultGridSampler.java
Patch:
@@ -77,7 +77,7 @@ protected BitMatrix sampleGrid(MonochromeBitmapSource image,
       for (int j = 0; j < max; j += 2) {
         if (image.isBlack((int) points[j], (int) points[j + 1])) {
           // Black(-ish) pixel
-          bits.set(i, j);
+          bits.set(i, j >> 1);
         }
       }
     }

File: core/src/com/google/zxing/qrcode/detector/DefaultGridSampler.java
Patch:
@@ -74,9 +74,8 @@ protected BitMatrix sampleGrid(MonochromeBitmapSource image,
       // Quick check to see if points transformed to something inside the image;
       // sufficent to check the endpoints
       checkEndpoint(image, points);
-      for (int j = 0; j < dimension; j++) {
-        int offset = j << 1;
-        if (image.isBlack((int) points[offset], (int) points[offset + 1])) {
+      for (int j = 0; j < max; j += 2) {
+        if (image.isBlack((int) points[j], (int) points[j + 1])) {
           // Black(-ish) pixel
           bits.set(i, j);
         }

File: core/src/com/google/zxing/qrcode/decoder/DataMask.java
Patch:
@@ -84,7 +84,7 @@ void unmaskBitMatrix(int[] bits, int dimension) {
   }
 
   /**
-   * 001: mask bits for which j mod 2 == 0
+   * 001: mask bits for which i mod 2 == 0
    */
   private static class DataMask001 extends DataMask {
     void unmaskBitMatrix(int[] bits, int dimension) {
@@ -165,9 +165,9 @@ void unmaskBitMatrix(int[] bits, int dimension) {
       int count = 0;
       int offset = 0;
       for (int j = 0; j < dimension; j++) {
-        int jComponent = j / 3;
+        int jComponentParity = (j / 3) & 0x01;
         for (int i = 0; i < dimension; i++) {
-          if (((i >> 1 + jComponent) & 0x01) == 0) {
+          if (((i >> 1) & 0x01) == jComponentParity) {
             bitMask |= 1 << count;
           }
           if (++count == 32) {

File: core/test/src/com/google/zxing/common/CollectionsTestCase.java
Patch:
@@ -34,11 +34,12 @@ public void testSort() {
     }
     Collections.insertionSort(v, new Comparator() {
       public int compare(Object o1, Object o2) {
-        return (Integer) o1 - (Integer) o2;
+        return ((Integer) o1).intValue() - ((Integer) o2).intValue();
       }
     });
     for (int i = 1; i < 100; i++) {
-      assertTrue("Element " + i, (Integer) v.elementAt(i-1) <= (Integer) v.elementAt(i));
+      assertTrue("Element " + i, ((Integer) v.elementAt(i-1)).intValue() <=
+                                 ((Integer) v.elementAt(i)).intValue());
     }
   }
 

File: core/src/com/google/zxing/qrcode/detector/DefaultGridSampler.java
Patch:
@@ -67,7 +67,7 @@ protected BitMatrix sampleGrid(MonochromeBitmapSource image,
       int max = points.length;
       float iValue = (float) i + 0.5f;
       for (int j = 0; j < max; j += 2) {
-        points[j] = (float) j + 0.5f;
+        points[j] = (float) (j >> 1) + 0.5f;
         points[j + 1] = iValue;
       }
       transform.transform(points);

